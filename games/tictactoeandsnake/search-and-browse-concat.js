/* Code Start of Tictac Toe block*/

var sq1 = null;
var sq2 = null;
var sq3 = null;
var sq4 = null;
var sq5 = null;
var sq6 = null;
var sq7 = null;
var sq8 = null;
var sq9 = null;

var playValid = false;
var win = false;

var gameIDSelec = null;
var promoID = null;

function initaliseBindEvents(){


  if($('#stage').length) {
    var snake = new Game.Snake('stage', {fps: 100, size: 4});
  }
  

   sq1 = $('#square1');
 sq2 = $('#square2');
 sq3 = $('#square3');
 sq4 = $('#square4');
 sq5 = $('#square5');
 sq6 = $('#square6');
 sq7 = $('#square7');
 sq8 = $('#square8');
 sq9 = $('#square9');

  $('.tile').on('click', function Xplay() {

  validatePlay(this);

  if (playValid) {
    $(this).removeClass('free');
    $(this).addClass('played');
    $(this).addClass('X-play');
    $(this).html("X");

    checkDraw();
    checkWin();
    Oplay();

  } else {
    alert("That square has already been played. Please choose another square");
  }
  
});

$('#reset-button').on('click', function() {
  clearBoard();
});

}

function validatePlay(squareplayed) {
  if ( $(squareplayed).hasClass('free') ) {
    playValid = true;
  } else {
    playValid = false;
    return false;
  }
}

function clearBoard() {
  $('.tile').removeClass('played');
  $('.tile').removeClass('O-play');
  $('.tile').removeClass('X-play');
  $('.tile').html('');
  $('.tile').addClass('free');
}

function winAlert(player) {
  win = true;

  if (player == "X") {
    $('#overlaywrapper').removeClass('active');
    postClubCardPoints(30);
    $('#gameContainer').css('display','none');
    gameIDSelec = null;
    promoID = null;
   // $('.tic-tac-toe').css('display','none');
    $('#gameLink').css('display','none');

  } else {
    alert("You lost!");
    $('#gameContainer').css('display','none');
    gameIDSelec = null;
    promoID = null;
    $('#overlaywrapper').removeClass('active');
    //$('.tic-tac-toe').css('display','none');
    $('#gameLink').css('display','none');
  }
  clearBoard();
}
    
function checkWin() {

  if ( sq1.hasClass('X-play') && sq2.hasClass('X-play') && sq3.hasClass('X-play') ) {
    winAlert("X");
  } else if ( sq1.hasClass('O-play') && sq2.hasClass('O-play') && sq3.hasClass('O-play') ) {
    winAlert("O");
  }

  else if ( sq4.hasClass('X-play') && sq5.hasClass('X-play') && sq6.hasClass('X-play') ) {
    winAlert("X");
  } else if ( sq4.hasClass('O-play') && sq5.hasClass('O-play') && sq6.hasClass('O-play') ) {
    winAlert("O");
  }

  else if ( sq7.hasClass('X-play') && sq8.hasClass('X-play') && sq9.hasClass('X-play') ) {
    winAlert("X");
  } else if ( sq7.hasClass('O-play') && sq8.hasClass('O-play') && sq9.hasClass('O-play') ) {
    winAlert("O");
  }

  else if ( sq1.hasClass('X-play') && sq4.hasClass('X-play') && sq7.hasClass('X-play') ) {
    winAlert("X");
  } else if ( sq1.hasClass('O-play') && sq4.hasClass('O-play') && sq7.hasClass('O-play') ) {
    winAlert("O");
  }

  else if ( sq5.hasClass('X-play') && sq2.hasClass('X-play') && sq8.hasClass('X-play') ) {
    winAlert("X");
  } else if ( sq5.hasClass('O-play') && sq2.hasClass('O-play') && sq8.hasClass('O-play') ) {
    winAlert("O");
  }

  else if ( sq6.hasClass('X-play') && sq9.hasClass('X-play') && sq3.hasClass('X-play') ) {
    winAlert("X");
  } else if ( sq6.hasClass('O-play') && sq9.hasClass('O-play') && sq3.hasClass('O-play') ) {
    winAlert("O");
  }

  else if ( sq1.hasClass('X-play') && sq5.hasClass('X-play') && sq9.hasClass('X-play') ) {
    winAlert("X");
  } else if ( sq1.hasClass('O-play') && sq5.hasClass('O-play') && sq9.hasClass('O-play') ) {
    winAlert("O");
  }

  else if ( sq5.hasClass('X-play') && sq7.hasClass('X-play') && sq3.hasClass('X-play') ) {
    winAlert("X");
  } else if ( sq5.hasClass('O-play') && sq7.hasClass('O-play') && sq3.hasClass('O-play') ) {
    winAlert("O");
  }
}

function checkDraw() {

  if ( !($('.tile').hasClass('free')) ) {
    alert("Draw! Try playing again!");
    clearBoard();
    $('#gameContainer').css('display','none');
    gameIDSelec = null;
    promoID = null;
    $('#overlaywrapper').removeClass('active');
    $('#gameLink').css('display','none');
   // $('.tic-tac-toe').css('display','none');
  }
}




function Oplay() {

  // Function for when O plays tactically
  function Oplaying(square) {

    validatePlay(square)

    if (playValid) {
      square.removeClass('free');
      square.addClass('played');
      square.addClass('O-play');
      square.html("O");
    } else {
      Orandomplay()
    }

  }

  // Function for when O plays randomly
  function Orandomplay() {
    for (var i = 0; i < 10; i++) {
    // Loop to find a valid play
    
      var randomNumber = Math.floor((Math.random() * 9) + 1);
      var randomSquare = $('#square'+randomNumber);
      validatePlay(randomSquare);

      if (playValid) {

        randomSquare.removeClass('free');
        randomSquare.addClass('played');
        randomSquare.addClass('O-play');
        randomSquare.html("O");
        break;
      } 
    }
  }


  // Tactical Plays

  win123_sq3 = ( sq1.hasClass('X-play') && sq2.hasClass('X-play') || sq1.hasClass('O-play') && sq2.hasClass('O-play') ) && !(sq3.hasClass('played'))
  win123_sq2 = ( sq1.hasClass('X-play') && sq3.hasClass('X-play') || sq1.hasClass('O-play') && sq3.hasClass('O-play') ) && !(sq2.hasClass('played'))
  win123_sq1 = ( sq3.hasClass('X-play') && sq2.hasClass('X-play') || sq3.hasClass('O-play') && sq2.hasClass('O-play') ) && !(sq1.hasClass('played'))

  win456_sq6 = ( sq4.hasClass('X-play') && sq5.hasClass('X-play') || sq4.hasClass('O-play') && sq5.hasClass('O-play') ) && !(sq6.hasClass('played'))
  win456_sq5 = ( sq4.hasClass('X-play') && sq6.hasClass('X-play') || sq4.hasClass('O-play') && sq6.hasClass('O-play') ) && !(sq5.hasClass('played'))
  win456_sq4 = ( sq5.hasClass('X-play') && sq6.hasClass('X-play') || sq5.hasClass('O-play') && sq6.hasClass('O-play') ) && !(sq4.hasClass('played'))

  win789_sq9 = ( sq7.hasClass('X-play') && sq8.hasClass('X-play') || sq7.hasClass('O-play') && sq8.hasClass('O-play') ) && !(sq9.hasClass('played'))
  win789_sq8 = ( sq7.hasClass('X-play') && sq9.hasClass('X-play') || sq7.hasClass('O-play') && sq9.hasClass('O-play') ) && !(sq8.hasClass('played'))
  win789_sq7 = ( sq8.hasClass('X-play') && sq9.hasClass('X-play') || sq8.hasClass('O-play') && sq9.hasClass('O-play') ) && !(sq7.hasClass('played'))

  win147_sq7 = ( sq1.hasClass('X-play') && sq4.hasClass('X-play') || sq1.hasClass('O-play') && sq4.hasClass('O-play') ) && !(sq7.hasClass('played'))
  win147_sq4 = ( sq1.hasClass('X-play') && sq7.hasClass('X-play') || sq1.hasClass('O-play') && sq7.hasClass('O-play') ) && !(sq4.hasClass('played'))
  win147_sq1 = ( sq4.hasClass('X-play') && sq7.hasClass('X-play') || sq4.hasClass('O-play') && sq7.hasClass('O-play') ) && !(sq1.hasClass('played'))

  win528_sq8 = ( sq5.hasClass('X-play') && sq2.hasClass('X-play') || sq5.hasClass('O-play') && sq2.hasClass('O-play') ) && !(sq8.hasClass('played'))
  win528_sq2 = ( sq5.hasClass('X-play') && sq8.hasClass('X-play') || sq5.hasClass('O-play') && sq8.hasClass('O-play') ) && !(sq2.hasClass('played'))
  win528_sq5 = ( sq2.hasClass('X-play') && sq8.hasClass('X-play') || sq2.hasClass('O-play') && sq8.hasClass('O-play') ) && !(sq5.hasClass('played'))

  win693_sq3 = ( sq6.hasClass('X-play') && sq9.hasClass('X-play') || sq6.hasClass('O-play') && sq9.hasClass('O-play') ) && !(sq3.hasClass('played'))
  win693_sq9 = ( sq6.hasClass('X-play') && sq3.hasClass('X-play') || sq6.hasClass('O-play') && sq3.hasClass('O-play') ) && !(sq9.hasClass('played'))
  win693_sq6 = ( sq9.hasClass('X-play') && sq3.hasClass('X-play') || sq9.hasClass('O-play') && sq3.hasClass('O-play') ) && !(sq6.hasClass('played'))

  win159_sq9 = ( sq1.hasClass('X-play') && sq5.hasClass('X-play') || sq1.hasClass('O-play') && sq5.hasClass('O-play') ) && !(sq9.hasClass('played'))
  win159_sq5 = ( sq1.hasClass('X-play') && sq9.hasClass('X-play') || sq1.hasClass('O-play') && sq9.hasClass('O-play') ) && !(sq5.hasClass('played'))
  win159_sq1 = ( sq5.hasClass('X-play') && sq9.hasClass('X-play') || sq5.hasClass('O-play') && sq9.hasClass('O-play') ) && !(sq1.hasClass('played'))

  win573_sq3 = ( sq5.hasClass('X-play') && sq7.hasClass('X-play') || sq5.hasClass('O-play') && sq7.hasClass('O-play') ) && !(sq3.hasClass('played'))
  win573_sq5 = ( sq5.hasClass('X-play') && sq3.hasClass('X-play') || sq5.hasClass('O-play') && sq3.hasClass('O-play') ) && !(sq5.hasClass('played'))
  win573_sq7 = ( sq7.hasClass('X-play') && sq3.hasClass('X-play') || sq7.hasClass('O-play') && sq3.hasClass('O-play') ) && !(sq7.hasClass('played'))



  // Win 1 2 3
  if ( win123_sq3 ) {
    Oplaying(sq3)
  } else if ( win123_sq2 ) {
    Oplaying(sq2)
  } else if ( win123_sq1 )  {
    Oplaying(sq1)
  } 
  
  // Win 4 5 6
  else if ( win456_sq6 ) {
    Oplaying(sq6)
  } else if ( win456_sq5 ) {
    Oplaying(sq5)
  } else if ( win456_sq4 ) {
    Oplaying(sq4)
  } 

  // Win 7 8 9 
  else if ( win789_sq9 ) {
    Oplaying(sq9)
  } else if ( win789_sq8 ) {
    Oplaying(sq8)
  } else if ( win789_sq7 ) {
    Oplaying(sq7)
  }

  // Win 1 4 7
  else if ( win147_sq7 ) {
    Oplaying(sq7)
  } else if ( win147_sq4 ) {
    Oplaying(sq4)
  } else if ( win147_sq1 ) {
    Oplaying(sq1)
  }

  // Win 5 2 8
  else if ( win528_sq8 ) {
    Oplaying(sq8)
  } else if ( win528_sq2 ) {
    Oplaying(sq2)
  } else if ( win528_sq5 ) {
    Oplaying(sq5)
  } 

  // Win 6 9 3
  else if ( win693_sq3 ) {
    Oplaying(sq3)
  } else if ( win693_sq9 ) {
    Oplaying(sq9)
  } else if ( win693_sq6 ) {
    Oplaying(sq6)
  }

  // Win 1 5 9
  else if ( win159_sq9 ) {
    Oplaying(sq9)
  } else if ( win159_sq5 ) {
    Oplaying(sq5)
  } else if ( win159_sq1 ) {
    Oplaying(sq1)
  } 

  // Win 5 7 3
  else if ( win573_sq3 ) {
    Oplaying(sq3)
  } else if ( win573_sq7 ) {
    Oplaying(sq7)
  } else if ( win573_sq5 ) {
    Oplaying(sq5)
  } 


  else {
    Orandomplay();
  }
  checkDraw();
  checkWin();
}


function getGameId(){

    getService('http://vdi01t11hsc-733:9191/getGame',function getGame(data){

      promoID = data.promotionId;

      getService(data.url,function gameData(data){
        $('#gameContainer').html(data);
        initaliseBindEvents();
      });

    });

}
  
function getService(url,callback){

  $.get(url,function (data){

    if(data){
      callback(data);
    }
    
  });
}

function showGameBlock(gameID){
    $('.tic-tac-toe').css('display','block');

    $('#'+gameID).css('display','block');

    $('#overlaywrapper').addClass('active');
    $('img').css('background-color','#000');
}

function postClubCardPoints(points){

  var data = {
       customerId:"284110021",
        score: points,
        promoId:promoID
    };

    $.ajax({
    headers: { 
        'Accept': 'application/json',
        'Content-Type': 'application/json' 
    },    
    'type': 'POST',
    'url': 'http://vdi01t11hsc-733:9191/applyScore',
    'data': JSON.stringify(data),
    'dataType': 'json',
    'success': function (data){

      if(data) {
          var msg =null;
          if(data.voucherCode) {
            msg = 'Please use vouchercode : '+ data.voucherCode;
          }
          else {
            msg = 'Points earned : '+data.addedPoints + ', Total Points available : '+data.points;
          }
        
        alert(msg);
      }
      
    }
    });

}

$('#gameLink').on('click',function check(){

    getGameId();

    //$('.tic-tac-toe').css('display','block');
    $('#overlaywrapper').addClass('active');
    $('img').css('background-color','#000');

    $('#overlaywrapper.active').click(function (){
      $('#gameContainer').css('display','none');
      $('#overlaywrapper').removeClass('active');
    });

});

/* Code end of Tictac Toe Game*/

/* Code start of Snake Game*/

/**
 * Namespace
 */
var Game      = Game      || {};
var Keyboard  = Keyboard  || {}; 
var Component = Component || {};

/**
 * Keyboard Map
 */
Keyboard.Keymap = {
  37: 'left',
  38: 'up',
  39: 'right',
  40: 'down'
};

/**
 * Keyboard Events
 */
Keyboard.ControllerEvents = function() {
  
  // Setts
  var self      = this;
  this.pressKey = null;
  this.keymap   = Keyboard.Keymap;
  
  // Keydown Event
  document.onkeydown = function(event) {
    self.pressKey = event.which;
  };
  
  // Get Key
  this.getKey = function() {
    return this.keymap[this.pressKey];
  };
};

/**
 * Game Component Stage
 */
Component.Stage = function(canvas, conf) {  
  
  // Sets
  this.keyEvent  = new Keyboard.ControllerEvents();
  this.width     = canvas.width;
  this.height    = canvas.height;
  this.length    = [];
  this.food      = {};
  this.score     = 0;
  this.direction = 'right';
  this.conf      = {
    cw   : 10,
    size : 5,
    fps  : 1000
  };
  
  // Merge Conf
  if (typeof conf == 'object') {
    for (var key in conf) {
      if (conf.hasOwnProperty(key)) {
        this.conf[key] = conf[key];
      }
    }
  }
  
};

/**
 * Game Component Snake
 */
Component.Snake = function(canvas, conf) {
  
  // Game Stage
  this.stage = new Component.Stage(canvas, conf);
  
  // Init Snake
  this.initSnake = function() {
    
    // Itaration in Snake Conf Size
    for (var i = 0; i < this.stage.conf.size; i++) {
      
      // Add Snake Cells
      this.stage.length.push({x: i, y:0});
    }
  };
  
  // Call init Snake
  this.initSnake();
  
  // Init Food  
  this.initFood = function() {
    
    // Add food on stage
    this.stage.food = {
      x: Math.round(Math.random() * (this.stage.width - this.stage.conf.cw) / this.stage.conf.cw), 
      y: Math.round(Math.random() * (this.stage.height - this.stage.conf.cw) / this.stage.conf.cw), 
    };
  };
  
  // Init Food
  this.initFood();
  
  // Restart Stage
  this.restart = function() {
    this.stage.length            = [];
    this.stage.food              = {};
    this.stage.score             = 0;
    this.stage.direction         = 'right';
    this.stage.keyEvent.pressKey = null;
    this.initSnake();
    this.initFood();
  };
};

/**
 * Game Draw
 */
Game.Draw = function(context, snake) {
  
  // Draw Stage
  this.drawStage = function() {
    
    // Check Keypress And Set Stage direction
    var keyPress = snake.stage.keyEvent.getKey(); 
    if (typeof(keyPress) != 'undefined') {
      snake.stage.direction = keyPress;
    }
    
    // Draw White Stage
    context.fillStyle = "white";
    context.fillRect(0, 0, snake.stage.width, snake.stage.height);
    
    // Snake Position
    var nx = snake.stage.length[0].x;
    var ny = snake.stage.length[0].y;
    
    // Add position by stage direction
    switch (snake.stage.direction) {
      case 'right':
        nx++;
        break;
      case 'left':
        nx--;
        break;
      case 'up':
        ny--;
        break;
      case 'down':
        ny++;
        break;
    }
    
    // Check Collision
    if (this.collision(nx, ny) == true) {
      var score =snake.stage.score;

        postClubCardPoints(score);

      $('#overlaywrapper').removeClass('active');
      $('#gameContainer').css('display','none');
      gameIDSelec = null;
      promoID = null;
      $('#gameLink').css('display','none');
      return;
    }
    
    // Logic of Snake food
    if (nx == snake.stage.food.x && ny == snake.stage.food.y) {
      var tail = {x: nx, y: ny};
      snake.stage.score++;
      snake.initFood();
    } else {
      var tail = snake.stage.length.pop();
      tail.x   = nx;
      tail.y   = ny;  
    }
    snake.stage.length.unshift(tail);
    
    // Draw Snake
    for (var i = 0; i < snake.stage.length.length; i++) {
      var cell = snake.stage.length[i];
      this.drawCell(cell.x, cell.y);
    }
    
    // Draw Food
    this.drawCell(snake.stage.food.x, snake.stage.food.y);
    
    // Draw Score
    context.fillText('Score: ' + snake.stage.score, 5, (snake.stage.height - 5));
  };
  
  // Draw Cell
  this.drawCell = function(x, y) {
    context.fillStyle = 'rgb(170, 170, 170)';
    context.beginPath();
    context.arc((x * snake.stage.conf.cw + 6), (y * snake.stage.conf.cw + 6), 4, 0, 2*Math.PI, false);    
    context.fill();
  };
  
  // Check Collision with walls
  this.collision = function(nx, ny) {  
    if (nx == -1 || nx == (snake.stage.width / snake.stage.conf.cw) || ny == -1 || ny == (snake.stage.height / snake.stage.conf.cw)) {
      return true;
    }
    return false;    
  }
};


/**
 * Game Snake
 */
Game.Snake = function(elementId, conf) {
  
  // Sets
  var canvas   = document.getElementById(elementId);
  var context  = canvas.getContext("2d");
  var snake    = new Component.Snake(canvas, conf);
  var gameDraw = new Game.Draw(context, snake);
  
  // Game Interval
  setInterval(function() {gameDraw.drawStage();}, snake.stage.conf.fps);
};


/**
 * Window Load
 */
/*window.onload = function() {
  var snake = new Game.Snake('stage', {fps: 100, size: 4});
};*/

/* Code end of Snake Game*/

/*jshint loopfunc: trues */
define('modules/product-tile/common',['domlib', 'modules/breakpoint', 'modules/common', 'modules/tesco.utils'], function ($, breakpoint, common, utils) {

    // match the heights of the passed collection of items
    $.fn.equaliseHeights = function (delay) {
        var newHeight = 0,
            tempHeight = 0,
            len = this.length,
            i = 0,
            different = false;

        if (len > 0) newHeight = $(this).eq(i).height();

        for (i = 0; i < len; i++) {
            tempHeight = $(this).eq(i).height();
            if (different == false && tempHeight !== newHeight) different = true;
            if (tempHeight > newHeight) newHeight = tempHeight;

        }

        if (different) {
            // Update first item
            $(this).height(newHeight);
        }
    };

    // return if the passed collection of items are all empty
    $.fn.isEmpty = function () {
        return $(this).filter(function () {
            return $.trim($(this).html()).length;
        }).length === 0;
    };

    var productTile = {

        tilesElement: '#listing.product-grid, .product-carousel, .product-carousel-heroic',

        /**
         * @name TESCO.Products.Height.adjust
         * @description This method figures out the height of a set of product tiles
         */
        Height: {

            /*
				DEFAULTS:
				------------------------------------------------------------
				JS to set height for:
				* product title     - min-height set in CSS only
				* additional info   - optional (unavailable/special offer text)
				* former prices     - optional
				* savings           - optional

				Height set in CSS only (never changes):
				* colour swatches   - optional
				* ratings           - always visible
				* buy from/seller   - always visible
				* price             - always visible

				JS HIDE ONLY: Height set in CSS only, row visibilty check still performed
				* colour swatches
				* additional info


				KIOSK:
				------------------------------------------------------------
				JS to set height for:
				* product title     - min-height set in CSS only

				Height set in CSS only (never changes):
				* colour swatches   - optional
				* ratings           - always visible
				* buy from/seller   - always visible
				* former prices     - optional but inline with actual price wrapper - former and actual sit side-by-side
				* price             - always visible
				* additional info   - optional, unavailable/special offer always last to appear in product tile for kiosk

				Hidden in kiosk view:
				* savings
				* stock alert cta
				* add to compare cta


				NOTES (applys to both defaults and kiosk):
				------------------------------------------------------------
				* additional info   - unavailable/special offers use the same space - their optional and only one or the other will ever be visibile at any time
				* author/artist     - should not exceed 1 line - css ellipsis being used rather than JS ellipsis
				* format/release    - should not exceed 1 line - css ellipsis being used rather than JS ellipsis


				PERFORMANCE NOTES:
				Performance related changes are minimal and the gain is only minor, but over multiple itterations could add up
				------------------------------------------------------------
				* where possible, removed dependancy on jquery/zepto ( mainly for loop over .each(), elm.style[x] over $(x).height() )
				* passing already collected elements such as $wrapper, $list, $items, rowLength etc to functions that need them rather than traversing the dom again
				* array assignment using array index in place of push
				* split the optional element classes into 2 groups as kiosk only needs to call height equalising on a small subset of the default
				* where element heights don't change, heights or min-heights are being set in the CSS - this reduces the number of optional element classes to loop over
				* added checks for certain classes where only the visibilty check is performed - height adjust not required as heights for these elements set in CSS
				* added check to move onto the next optional elements if nothing found matching current optional element class
				* added check so if the optional elements are all empty, then hide them and immediately move onto the next set
				* added a classname to the elements that have been equalised - this is to benefit the plp load more functionality to ensure that only the newly added
		          tiles are equalised rather than running over the entire set again. This class is ignore if the height adjust is called on a viewport change
				* remove the call to normaliseHeights in the init for load-more/common.js - was causing the listing grid to run the height adjust twice
				* amended the ellipsis call to perform on the passed product tiles only instead of all - will only run on all if the includeEqualised flag is set
			*/
            optionalElementClasses: {
                defaults: [
                    '.colour-swatch-container', // VISIBILITY CHECK ONLY, JS WON'T SET HEIGHT - height in CSS as it never changes
                    '.title-author-format',
                    '.former-prices-container',
                    '.additional-info', // VISIBILITY CHECK ONLY, JS WON'T SET HEIGHT - height in CSS as it never changes
                    '.button-container',
                    '.unavailable-special-offer',
                    '.buy-block'
                ],
                kiosk: [
                    '.title-author-format'
                ]
            },

            equalisedClassName: 'js-equalised',
            reEqualiseClassName: 'js-re-equalise',

            adjust: function ($wrapper, fn, includeEqualised, oLoadMore, rowElems) {
              // DEBUG - performance monitor
              var self = productTile.Height,
                $context = window.isKiosk()
                  ? $wrapper
                  : $wrapper.not('.list-view'),
                $items = null,
                rowLength = null,
                delay = null,
                classNames = null,
                $list = $('.products', $context); // If there are 40+ items then increase delay between row height adjust

              window.$firstInRow; // This variable will help not to call getFirstInRow() everytime there is a swatch tap/click.

              if (rowElems !== undefined && rowElems.length) {
                $items = rowElems;
              } else {
                $items = self.getItems($list, includeEqualised)
              }
              rowLength = self.getRowLength($wrapper, $list, $items);
              delay = ($items.length < 40)
                ? 20
                : 50;
              // Before we initalise make sure there are no forced feature tile heights
              $items.find('.feature-content').css('height', '');

              // update item collection is height adjust called from plp load more functionality
              if (oLoadMore) {
                $items = self.getLoadMoreItems($list, $items, rowLength, oLoadMore);
              }

              if (!$items.length) {
                return;
              }
              // Call the function getFirstInRow() only on page load. Not on swatch swipes.
              if ((!rowElems && !window.$firstInRow)) {
                $firstInRow = self.getFirstInRow($wrapper, $items);
              } else if((!rowElems && oLoadMore)) {
                $.merge($firstInRow, self.getFirstInRow($wrapper,
                  $items,
                  oLoadMore,
                  $firstInRow));
              }

              classNames = (breakpoint.kiosk)
                ? self.optionalElementClasses.kiosk
                : self.optionalElementClasses.defaults;

              for (var i = 0, iLen = $firstInRow.length; i < iLen; i += 1) {
                (function(i, iLen, $wrapper, $firstInRow, rowLength, classNames, fn) {
                  setTimeout(function () {
                    var nextFirst = (i < iLen - 1)
                      ? $firstInRow.eq(i + 1).index()
                      : $wrapper.find('.product-tile:last').index() + 1,
                      equalClass = (i < iLen - 1)
                      ? self.equalisedClassName
                      : self.reEqualiseClassName,
                      thisRowLength = window.isKiosk()
                      ? 10
                      : nextFirst - $firstInRow.eq(i).index();
                    if (rowElems !== undefined && rowElems.length) {
                      if (rowElems.index($firstInRow[i]) > -1) {
                        productTile.Height.performRowItems(
                          $wrapper,
                          $firstInRow,
                          thisRowLength, i,
                          classNames,
                          equalClass);
                      }
                    } else {
                      productTile.Height.performRowItems(
                        $wrapper,
                        $firstInRow,
                        thisRowLength, i,
                        classNames,
                        equalClass,
                        fn);
                    }
                  }, delay * i); // End setTimeout
                })(i, iLen, $wrapper, $firstInRow, rowLength, classNames, fn);
              }

              if (oLoadMore) {
                setTimeout(function () {
                  $(window).trigger('productTilesAdjusted', [oLoadMore]);
                }, 500);
              }
            },

            // as we're using the dotdotdot plugin, we need to set the height of the heading in order for
            // this plugin to function correctly. Can't set a global height in the css as the heading height
            // is variable and can change across rows (an entire row can have a single line of text so pointless
            // having this hardcoded in the css as 60px when it's only 20px for the row.
            setHeadingHeights: function ($elms) {
                var self = productTile.Height,
                    headings = [],
                    rowLines = [],
                    len = $elms.length,
                    i = 0,
                    lineHeights = [],
                    $elemAuthor;

                // store headings and get the highest/max number of lines for the headings in the row
                for (i = 0; i < len; i++) {
                    headings[i] = $('h3', $elms[i]);
                    lineHeights[i] = self.getLineHeight(headings[i]);
                    rowLines[i] = Math.round(headings[i].height() / lineHeights[i]);

                    // if the product is a media type (dvd, book, cd), check to see if the format/release wrapper
                    // has content, if so, then apply height to the author/artist wrapper to ensure all format/release
                    // wrappers align across the row regarless of whether the author/artist wrapper has content or not
                    if (headings[i].hasClass('media')) {
                        var $formatRelease = $('.format-release', $elms[i]);

                        if (!$formatRelease.isEmpty()) {
                            $elemAuthor = $('.author', $elms[i]);
                            if ($elemAuthor.length) {
                                $('.author', $elms[i]).height(self.getLineHeight($formatRelease) + 'px');
                            }
                        }
                    }
                }

                // get the height lines value
                var maxLines = Math.max.apply(Math, rowLines);
                var m = 0;

                // apply/cap the heights of all product headings
                for (i = 0; i < len; i++) {

                    // copy the maxlines value - needs to be adjusted individually for each heading instance
                    m = maxLines;

                    // if the heading is a media type (book, dvd, cd etc), then the heading should not exceed 2 lines
                    if (m > 2 && headings[i].hasClass('media')) {
                        m = 2;
                    }

                    // else, all other headings should not exceed 3 lines
                    if (m > 3) {
                        m = 3;
                    }

                    //headings[i][0].style.height = (lineHeights[i] * m) + 'px';
                    headings[i].height((lineHeights[i] * m));
                }
            },

            // check if its the kiosk plp listing product grid - this displays as 2 rows instead of 1 in kiosk
            isKioskListing: function ($wrapper) {
                return window.isKiosk() && $wrapper[0].id === 'listing';
            },

            // check if it's the 'grid-3' layout listing product grid - this hides buttons e.g. add to basket button
            isListingWithHiddenButtons: function ($wrapper) {
                if ($wrapper.attr('id') === 'listing') {
                    if ($wrapper.hasClass('grid-33321')) {
                        return true;
                    }
                }

                return false;
            },

            // return the line height for an element
            getLineHeight: function ($elm) {
                return parseFloat($elm.css('line-height'));
            },

            // exclude list items that are hidden or if it's the load more action for the plp page
            getItems: function ($list, includeEqualised) {
                var self = productTile.Height;
                var $items = $('> li', $list).not('.hidden, .load-more-tile, .loadingBar');

                // if it's not a viewport change, exclude items that have already been equalised (used for plp load more functionality)
                if (!includeEqualised && !breakpoint.kiosk) {

                    $items = $items.filter(':not(.' + self.equalisedClassName + ')');
                    $items = $items.filter(':not(.' + self.reEqualiseClassName + ')');
                }

                return $items;
            },

            // as the load more items can be appended to the end of a row, make sure we add the previous row items to
            // the $items array, so that the entire row can be correctly equalised
            getLoadMoreItems: function ($list, $items, rowLength, oLoadMore) {
                var self = productTile.Height;

                if (!$items.length) {
                    return $items;
                }

                if (breakpoint.vTablet || breakpoint.hTablet) {
                    if (oLoadMore.isPrevious === false) {
                        var $first = $items.eq(0);
                        var $allItems = self.getItems($list, true);
                        var $prevItems = $();
                        var $prev;

                        var startIndex = $allItems.index($first);
                        var offsetTop = parseInt($first.offset().top, 10);

                        for (var i = rowLength - 1; i > 0; i--) {
                            $prev = $allItems.eq(startIndex - i);

                            // make sure the offset tops are the same - if not, assume the previous in a different row
                            if (parseInt($prev.offset().top, 10) === offsetTop) {
                                $prevItems = $prevItems.add($prev.removeClass(self.equalisedClassName));
                            }
                        }
                        $items = $prevItems.add($items);
                    }

                }

                return $items;
            },

            // return the number of items per row
            getRowLength: function ($wrapper, $list, $items) {
                var self = productTile.Height;
                var len = 0;

                //Remove feature tiles as they mess with calculation
                $items = $items.filter(':not(.feature-tile)');

                // product grid - stacked rows
                if ($wrapper.hasClass('product-grid')) {
                    // kiosk plp listing grid - divide total items length by 2 for the 2 rows
                    if (self.isKioskListing($wrapper)) {
                        len = Math.round($items.length / 2);
                    }

                    // standard grid, divide the lists width by the width of the first item to get the total number of items for the row
                    else {
                        //len = Math.round( $list[0].offsetWidth / $items[0].offsetWidth );
                        len = Math.round($list.eq(0).width() / $items.eq(0).width());
                    }
                }

                // product carousel - everything will be in a single row
                else if ($wrapper.hasClass('product-carousel')) {
                    len = $items.length;
                }

                return len;
            },

            // return a collection of first in row elements for each row
            getFirstInRow: function ($wrapper, $items, oLoadMore, $firstInRow) {
              var self = productTile.Height,
                $first = [],
                i = 0,
                prevOffsetTop = -1;

                // product grid - stacked rows
              if ($wrapper.hasClass('product-grid')) {
                // kiosk plp listing grid
                if (self.isKioskListing($wrapper)) {
                  if (common.isKioskListingWithOneRow($wrapper)) {
                    $first = $items.eq(0);
                  } else {
                    // get the 1st and 2 items only as kiosk plp listing grid stacks items as:
                    // 1, 3, 5, 7
                    // 2, 4, 6, 8
                    $first = $items.filter(':nth-child(1), :nth-child(2)');
                  }
                } else {
                // standard grid, get the first item and keep adding the rowLength to get
                // the first for each row
                  prevOffsetTop = oLoadMore ? $firstInRow.last().offset().top : -1;
                  // Finished with re-equalise class so remove it
                  $items.removeClass(self.reEqualiseClassName)

                  // Add row-start class
                  // Offset.top is used because the first item on the row could be floated right
                  for (i = 0; i < $items.length; i += 1) {
                    // Detect start of new row
                    // (new tile offset top is greater than old tile offset top)
                    if ($items.eq(i).offset().top > prevOffsetTop) {
                      $items.eq(i).addClass('row-start');
                      prevOffsetTop = $items.eq(i).offset().top;
                    } else if ($items.eq(i).offset().top < prevOffsetTop) {
                      // Detect if new tile fits in a gap left by feature tile
                      $items.eq(i).addClass('gap-filler-m');
                    }
                  }
                  $first = $items.filter('.row-start');
                }
              } else if ($wrapper.hasClass('product-carousel')) {
                // product carousel - should be just 1 row so grab the first element
                $first = $items.eq(0);
              }
              return $first;
            },

            // return all the elements in current row
            getRowItems: function ($wrapper, $first, length, i) {
                var self = productTile.Height;

                // kiosk plp listing grid - will need to alternate the item collection for row as kiosk plp listing grid stacks items as:
                // 1, 3, 5, 7
                // 2, 4, 6, 8
                if (self.isKioskListing($wrapper)  && !common.isKioskListingWithOneRow($wrapper)) {
                    return $first.add($first.nextAll(':nth-child(' + (i === 0 ? 'odd' : 'even') + ')').slice(0, length - 1));
                } else {
                    return $first.add($first.nextAll(':not(.hidden)').slice(0, length - 1));
                }
            },

            // as the heights of product tiles have been adjusted, the height of the load more tile will also need to be adjusted
            // hack to get around circular dependancy (otherwise product-tile JS will reference load-more JS which will reference product-tile JS etc...)
            updateLoadMoreTileHeight: function () {
                /*
				var $loadMore = $('#listing .load-more-tile');
				if ($loadMore.length) {
					$loadMore.height( $loadMore.prev().height() );
				}
				*/
            },

            init: function init(includeEqualised, rowElems) {
                productTile.tilesElement = $(productTile.tilesElement);

                var self = productTile.Height, oLoadMore;
                var $wrappers = productTile.tilesElement.filter(':visible').not('#recently-viewed');

                // note: ellipsis plugin slow!
                for (var i = 0, len = $wrappers.length; i < len; i++) {
                    if ($($wrappers[i]).is('#listing') && utils.isInfinityBrowseBookmark()) {

                    } else {
                        self.adjust($($wrappers[i]), productTile.Ellipsis.init, includeEqualised, oLoadMore, rowElems);
                    }
                }
                if ($('.button-container .add-to-basket[disabled]').length > 0) {
                    $('.button-container .add-to-basket').removeAttr('disabled');
                }
                if ($('.product-tile').length) {
                    $('#listing .products li.product-tile').eq(0).addClass('nth-child-1');
                    $('#listing .products li.product-tile').eq(1).addClass('nth-child-2');
                    $('#listing .products li.product-tile:even').addClass('nth-child-odd');
                    $('#listing .products li.product-tile:odd').addClass('nth-child-even');
                }

            },
            performRowItems: function ($wrapper, $firstInRow, rowLength, i, classNames, equalClass, fn) {
                //collect all of the product items for the current row
                var rows = $firstInRow.length,
                    self = productTile.Height,
                    $rowItems = self.getRowItems($wrapper, $firstInRow.eq(i), rowLength, i),
                    isListingWithHiddenButtons = self.isListingWithHiddenButtons($wrapper);

                // Get 3 items from next row to see if any gap fillers are present (MVP)
                var $gapFillers = self.getRowItems($wrapper, $firstInRow.eq(i + 1), 3, i + 1);
                $gapFillers = $gapFillers.filter('.gap-filler');

                $rowItems = $rowItems.filter(':not(.gap-filler)').add($gapFillers);

                $gapFillers.removeClass('gap-filler');

                $(classNames.join(','), $rowItems).attr('style', '');

                var $itemsToEqualise = $();
                var $itemsToHide = $();

                for (var j = 0, jLen = classNames.length; j < jLen; j++) {
                    // collect all the elements in the current row matching the current class name
                    var $optional = $(classNames[j], $rowItems);

                    // remove any previous height and display amends
                    // this process is re-run on viewport change as the row column count changes
                    //$optional.attr('style', '');

                    // move onto the next optional elements if nothing found matching current optional element class
                    if (!$optional.length) {
                        continue;
                    }

                    // if the optional elements are all empty, then hide them and move onto the next set
                    if (!breakpoint.kiosk && $optional.isEmpty()) {
                        //$optional.hide();
                        $itemsToHide = $itemsToHide.add($optional);
                        continue;
                    }

                    if (classNames[j] === '.button-container') {
                        if (!$optional.find('.primary-button, .secondary-button').length) {
                            //$optional.hide();
                            $itemsToHide = $itemsToHide.add($optional);
                        } else {
                            if (!isListingWithHiddenButtons || $wrapper.attr('id') === 'listing') {
                                $optional.show();
                            }
                        }
                    }

                    // the height for the elements with these classes are set in the css
                    // the visibilty check above only needs to be applied - no need to set height using JS
                    if (classNames[j] === '.colour-swatch-container' || classNames[j] === '.additional-info') {
                        continue;
                    }

                    // adjust the height for the product title headings
                    if (classNames[j] === '.title-author-format') {
                        self.setHeadingHeights($optional);
                    }

                    // finally, equalise the heights of the optional elements
                    $optional.equaliseHeights();

                }

                $itemsToHide.hide();

                // add height adjusted class to the list items that have been updated
                // this is to stop the height adjust from being re-run when load more is called on plp
                $rowItems.addClass(equalClass);

                //$itemsToEqualise = $itemsToEqualise.add($optional);


                // DEBUG - check speed EXCLUDING the ellipsis plugin call
                // console.log((new Date() - start) / 1000);

                // pass only the updated items to the function
                // excludes previously updated items from being processed for a second time
                if (fn !== undefined && fn) {
                    fn($rowItems);
                }

                // DEBUG - check speed INCLUDING the ellipsis plugin call (ellipsis plugin is slow!)
                // console.log((new Date() - start) / 1000);

                // Update feature tile on row
                var $featureTile = $rowItems.find('.feature-content');
                var $featureImage = $featureTile.find('img');
                var imageHeight = $featureImage.height();
                var featureHeight = $featureTile.height();
                var productHeight = $rowItems.find('.product').height() + 16;
                var newHeight = (productHeight < featureHeight) ? featureHeight : productHeight - 0.5;

                $featureTile.height(newHeight);
                $featureImage.css('margin-top', (newHeight - imageHeight) / 2);

                //$itemsToEqualise.equaliseHeights();

                /*
				(function($myOptional) {
					setTimeout(function() {
						$myOptional.equaliseHeights();
					}, 100);
				})($optional);
				*/

            }
        },

        /**
         * @name TESCO.Products.Ellipsis.init
         * @description This method forms the ellipses on the product tiles
         */
        Ellipsis: {
            init: function init($elems) {

                /*
				//	Added parameter to allow new elements to be passed, this is required for Infinity browse.
				if (!$elems) {
					$elems = productTile.tilesElement;
				}
				*/

                common.Ellipsis.init($elems.find('.product h3'));

                /*
				(function($elems) {
					setTimeout(function() {
						$elems.find('.product h3').dotdotdot({
							ellipsis  : '\u2026',
							wrap      : 'word',
							watch     : false,
							tolerance : 0
						});
					}, 10);
				})($elems);
				*/
            }
        },

        checkFrom: function (data) {
            var target = (data) ? data : $('#listing');

            $('.product', target).each(function () {
                if ($('.retailer', this).length > 1) {
                    $('.price', this).prepend('From ');
                }
            });
        },

        decorateClickEvent: function () {
            if (common.isInIframe()) {
                var message = {},
                    $products = jQuery('.product-carousel li .product, .product-carousel-heroic li .product');
                $products.each(function () {
                    $(this).on('click tap', function (e) {
                        e.stopPropagation();
                        e.preventDefault();
                        message.action = 'redirect';
                        message.href = $(this).find('a').attr('href');
                        common.sendCrossWindowMessage(message);
                    });
                });
            }
        },
        ie8TileFormat: function () {
            if ($('html').hasClass('ie8')) {
                $('.products li:nth-child(5n+1) .product').addClass('firstInRow');
            }
        }
    };

    // ensure that the includeEqualised flag is set so all items are collected
    // productTile.Height.init() is also called from the plp load more functionality

    breakpoint.mobileIn.push(function () {
        productTile.Height.init(true);
    });
    breakpoint.vTabletIn.push(function () {
        productTile.Height.init(true);
    });
    breakpoint.hTabletIn.push(function () {
        productTile.Height.init(true);
    });
    breakpoint.desktopIn.push(function () {
        productTile.Height.init(true);
    });
    breakpoint.largeDesktopIn.push(function () {
        productTile.Height.init(true);
        productTile.ie8TileFormat();
    });
    breakpoint.kioskIn.push(function () {
        productTile.Height.init(true);
    });

    return productTile;
});

/**********************************************************
* Module
* Analytics - Class/Namespace to contain Analytics & MVT
**********************************************************/

define('modules/tesco.analytics',['domlib', 'modules/tesco.utils'], function($, utils){

	/**********************************************************
	* Module
	* WebMetrics - Class to handle Web metrics
	* Object "s" contains the instance of the web analytics on a global level via inline JS
	**********************************************************/

	function WebMetrics() {
	    this.init.apply( this, arguments );
	}

	WebMetrics.prototype = {
	    init: function() {
	        if (typeof(s) !== "undefined") {
	            this.oAnalytics = jQuery.extend({}, s);
	        }
	    },
	    submit: function(oJSON) {
	        if (typeof(s) !== "undefined") {
	            if (oJSON !== '' || oJSON !== null) {
	            	if (typeof (oJSON[0]) === 'object') {
		            	if (!this.isEmpty(oJSON[0])) {
		            		this.populateProperties(oJSON);
				            this.removeExceptions();
				            /* Take copy of original "s" object as .t() method is not aware of "this"
				             * all functions within "s" are referencing "s" rather than the instance!
				             */
				            var orig_s = s;
				            s = this.oAnalytics;
				            // Execute default Web Metrics call
				            s.t();
				            s = orig_s;
		            	}
	            	}
		        }
	        }
	    },
	    populateProperties: function(oAnalyticsData) {
	    	if (typeof(oAnalyticsData) !== 'object') {
	        	oAnalyticsData = $.parseJSON(oAnalyticsData);
	        }
	    	if (typeof (oAnalyticsData[0]) === 'object') {
				for(var propName in oAnalyticsData[0]) {
		        	this.oAnalytics[propName] = oAnalyticsData[0][propName];
		        }
		    }
	    },
	    removeExceptions: function() {
	    	// Business rule to remove the "products" property when the "events" property contains "scCheckout"
	    	if (!window.isKiosk() && this.oAnalytics['events'] === 'scCheckout') {
	    		if (!this.oAnalytics['onLoad']) {
	    			delete this.oAnalytics['products'];
	    		}
	    	}
	    },
	    isEmpty: function(oAnalyticsData) {
	    	for (var prop in oAnalyticsData) {
	            if (oAnalyticsData.hasOwnProperty(prop)) {
	            	return false;
	            }
	        }
	        return true;
	    }
	}

	/**********************************************************
	* Module
	* MVT - Class to handle MVT (Test & Target).
	* This is a wrapper to proxy the call to the predefined function (fSinglePageCheckoutMVT) controlled by the Publishing team
	**********************************************************/
	function MVT() {
		this.init.apply(this, arguments);
	}

	MVT.prototype = {
		init: function() {
			// Dummy init function
		},
		testAndTarget: function() {
			/***
			 * MVTAfterAjax will be the unique function name which publishing control through test and target.
			 * If the function exists, it will execute, if not, the function will return.
			 */
			if (typeof(MVTAfterAjax) !== 'undefined') {
				if ($.isFunction(MVTAfterAjax)) {
					/***
					 * Wrapping in try/catch just in case the JS in the controlled function is invalid as we do not
					 * want to cause any knock on effect in the subsequent Ajax calls.
					 */
					try {
						MVTAfterAjax.apply(undefined, arguments);
					}
					catch (e) {	}
				}
			}
		}
	}


	var Analytics = {
		WebMetrics: WebMetrics,
		MVT: MVT
	};

	return Analytics;

});

/*global define: true */
define('modules/checkout/loader',['domlib'], function ($) {
    'use strict';

    var setMessage,
        createLoaderMessage,
        cycleThroughMessages;

    setMessage = function setMessage($loaderMsg, i, params) {
        var timeout = params.timeout || 1500;

        setTimeout(function () {
            if (i < params.messages.length) {
                $loaderMsg.text(params.messages[i]);
                i = i + 1;
                setMessage($loaderMsg, i, params);
            }
        }, timeout);
    };

    createLoaderMessage = function createLoaderMessage($loader) {
        var $newLoaderMsg;

        $newLoaderMsg = $(document.createElement("div"));
        $newLoaderMsg.addClass("loaderMsg");

        $loader.append($newLoaderMsg);
    };

    cycleThroughMessages = function cycleThroughMessages($loader, params) {
        var i,
            messagesLength,
            $loaderMsg;

        if (typeof params === 'object' && (typeof params.messages === 'object')) {
            messagesLength = params.messages.length;

            if (messagesLength > 0) {
                $loaderMsg = $loader.find('.loaderMsg');

                if (!$loaderMsg.length) {
                    $loaderMsg = createLoaderMessage($loader);
                }

                i = 0;
                setMessage($loaderMsg, i, params);
            }
        }
    };

    /*
    *  Generate loader
    */
    return function (element, message, small, params) {
        var loader;

        if ($(element).is('body')) {
            loader = $('<div class="loader"><div class="loaderMsg">' + message + '</div></div>');
        } else {
            loader = $('<div class="loader"></div>').text(message);
        }

        if (small) {
            loader.addClass('small');
        }
        if ($(element).is('body')) {
            loader.css({
                'height': $(window).height(),
                'opacity': '.7',
                'position': 'fixed'
            });
        }
        if ($(element).is('input')) {
            $(element).addClass('btnLoader');
        } else {
            if ($(element).css('position') !== 'absolute') {
                $(element).css('position', 'relative');
            }
            $(element).append(loader);
        }

        cycleThroughMessages(loader, params);
    };

});
/** ********************************************************
* DataLayer - Class to handle AJAX IO
*
**********************************************************/

define('modules/tesco.data',['domlib', 'modules/tesco.utils', 'modules/tesco.analytics', 'modules/checkout/loader'], function ($, utils, analytics, loader) {
  function DataLayer(settings) {
    if (settings) {
      $.extend(DataLayer.Properties, settings);
    }

    if (DataLayer.Properties.singleton) {
      if (arguments.callee._singletonInstance) {
        return arguments.callee._singletonInstance;
      }
      arguments.callee._singletonInstance = this;
    }
    this.init.apply(this, arguments);
  }

  DataLayer.Properties = {
    postUrl: '',
    lastPostUrl: '',
    lastRequest: '',
    lastResponseCode: '',
    method: 'POST',
    dataType: 'json',
    singleton: false,
    currentlyExecuting: false,
    maxQueueLength: 99,
    delayBetweenRequests: false,
    delayRequest: 1000,
    isDestroyed: false,
    timeout: 60000,
    errorHandler: {
      409: 'refresh',
      500: 'refresh'
    }
  },

	DataLayer.prototype = {
  init: function () {
    this._queue = [];
  },

  get: function (url, dataobj, oElem, handlerNS, sRequest, doneCallback, failCallback, completeCallback, overrideTransportType) {
			// if the timeout is the default check if the backend is returning a different value
    if (DataLayer.Properties.timeout === 60000) {
      DataLayer.Properties.timeout = Data.Global.getTimeout();
    }

    $.ajaxSetup({
      timeout: DataLayer.Properties.timeout
    });

			// If Safari 6, then add cache-control header to stop the infamous Ajax POST cache issue.
    try {
      var userAgent = navigator.userAgent;
      if (userAgent.indexOf('Safari') > 0) {
        userAgent = userAgent.substring(userAgent.indexOf('Version/') + 8);
        version = userAgent.substring(0, userAgent.indexOf('.'));
        if (version === '6') {
          $.ajaxSetup({
            headers: { 'cache-control': 'no-cache, must-revalidate, max-age=0, no-store' }
          });
        }
      }
    }
			catch (e) {

}

			// No handler object passed, so use our TESCO default handler
    if (handlerNS === null) {
      handlerNS = Data.Common;
    }

    if (DataLayer.Properties.singleton === true && DataLayer.Properties.currentlyExecuting) {
      if (this._queue.length <= DataLayer.Properties.maxQueueLength) {
        Data.Utils.addAjaxLoaderPerRequest(sRequest, oElem);
        this._queue.push(arguments);
      }
    }
    else {
      this.execute(url, dataobj, oElem, handlerNS, sRequest, doneCallback, failCallback, completeCallback, overrideTransportType);
    }
  },
  execute: function (url, dataobj, oElem, handlerNS, sRequest, doneCallback, failCallback, completeCallback, overrideTransportType) {
    DataLayer.Properties.currentlyExecuting = true;

    var _self = this;
    this.objXHTTP = $.ajax({
      url: url,
      type: overrideTransportType || DataLayer.Properties.method,
      dataType: DataLayer.Properties.dataType,
      data: dataobj,
      beforeSend: function () {
					// Add ajax loaders over relevant modules
        Data.Utils.addAjaxLoaderPerRequest(sRequest, oElem);
      },
      success: function (oResp, textStatus, jqXHR) {
        var _callbackRes;
        if ($.isFunction(doneCallback)) {
          _callbackRes = doneCallback(oResp, oElem);
        }

        if (_callbackRes === 'destroy') {
          DataLayer.Properties.isDestroyed = true;
          return;
        }

					// If request is inline, e.g. store details, surpress default complete method as this call the default data handler method.
        if (!Data.Utils.isInlineRequest(sRequest)) {
          _self.done(oResp, oElem, sRequest, handlerNS);
        }
      },
      error: function (xhr, status, errorThrown) {
        if ($.isFunction(failCallback)) {
          failCallback(xhr, status, errorThrown, oElem);
        }
        _self.fail(xhr, status, errorThrown, oElem);
      },
      complete: function (xhr, status) {
        DataLayer.Properties.currentlyExecuting = false;

        if ($.isFunction(completeCallback)) {
          DataLayer.Properties.currentlyExecuting = true;
          completeCallback(xhr, status, oElem, sRequest);
        }

        _self.complete(xhr, status, oElem, sRequest);
      }
    });
  },

  fail: function (xhr, status, errorThrown, oElem) {
			/* Below check is to re-direct the user to sign-in/register page if session expires
			 * href is hard-coded as per dev team. should find a generic way to handle this.
			 * */
    if (status == 'parsererror' && xhr.responseText.indexOf('Sign In') > 0) {
      location.href = '/' + utils.getSiteContext() + '/my/register.page?stimeout=true';
    }

			 /*
			  * This is for the epic 3185 to prevent XSS attack on the site.
			  * On the server side if any request contains any malicious HTML or JS scripts the server will send a 404 response.
			  * However for Ajax requests  page needs to get refreshed
			  * */
    if (status == 'parsererror' && xhr.responseText.indexOf('Sorry, we can') > 0) {
      location.reload(true);
    }

			// Default timeout behaviour is to reload the current page and also on error.
			// || status === 'error'
    if (status === 'timeout') {
      utils.refreshCurrentPage();
    }

			// Handler for HTTP error codes
    switch (DataLayer.Properties.errorHandler[xhr.status]) {
      case 'refresh': utils.refreshCurrentPage();
        break;
    }

    DataLayer.Properties.currentlyExecuting = false;
    DataLayer.Properties.isDestroyed = false;
  },

  done: function (oResp, oElem, sRequest, handlerNS) {
    handlerNS.handler(oResp, oElem);
    Data.Utils.removeAjaxLoadersPerRequest(oElem, sRequest);
  },

  complete: function (xhr, status, oElem, sRequest) {
    var $completeEvent;
			// If the request needs to be thrown out
    if (DataLayer.Properties.isDestroyed) {
      DataLayer.Properties.isDestroyed = false;
    }
    else {
      DataLayer.Properties.lastResponseCode = this.objXHTTP.status;
      DataLayer.Properties.lastPostUrl = this.objXHTTP.url;
      DataLayer.Properties.lastRequest = sRequest;
      DataLayer.Properties.currentlyExecuting = false;

				// Check if the dependency has been loaded
      if (analytics) {
        var _oMVT = new analytics.MVT();
        _oMVT.testAndTarget.apply(undefined, arguments);
      }
    }
    this.processQueue();
    $completeEvent = new $.Event('ajaxFrameworkCallComplete');
    $completeEvent.data = {};
    $completeEvent.data.request = sRequest;
    $completeEvent.data.status = status;
    $(window).trigger($completeEvent);
  },
  processQueue: function () {
    if (DataLayer.Properties.singleton === true) {
      if (this._queue.length > 0) {
        if (DataLayer.Properties.delayBetweenRequests) {
          setTimeout(function () {
            this.execute.apply(this, this._queue.shift());
          }, DataLayer.Properties.delayRequest);
        }
        else {
          this.execute.apply(this, this._queue.shift());
        }
      }
    }
  }
};

  var Global = function () {
    var myInlineRequests = [];
    var myRequests = [];
    var myModules = {};
    var myActions = {};
    var myDefaultActions = {};
    var myTimeout = 60000;

    return {
      init: function (oOptions) {
        $.merge(myInlineRequests, oOptions.inlineRequests);
        $.extend(true, myRequests, oOptions.requests);
        $.extend(true, myModules, oOptions.modules);
        $.extend(true, myActions, oOptions.actions);
        $.extend(true, myDefaultActions, oOptions.defaultActions);
        if (oOptions.timeout) {
          if (!isNaN(oOptions.timeout)) {
            myTimeout = parseInt(oOptions.timeout);
          }
        }
      },
      addInlineRequests: function (oRequests) {
        $.extend(true, myInlineRequests, oRequests);
      },
      getInlineRequests: function () {
        return myInlineRequests;
      },
      addRequests: function (oRequests) {
        $.extend(true, myRequests, oRequests);
      },
      getRequests: function () {
        return myRequests;
      },
      addModules: function (oModules) {
        $.extend(true, myModules, oModules);
      },
      getModules: function () {
        return myModules;
      },
      addActions: function (oActions) {
        $.extend(true, myActions, oActions);
      },
      getActions: function () {
        return myActions;
      },
      addDefaultActions: function (oDefaultActions) {
        $.extend(true, myDefaultActions, oDefaultActions);
      },
      getDefaultActions: function () {
        return myDefaultActions;
      },
      setTimeout: function (iVal) {
        myTimeout = parseInt(iVal);
      },
      getTimeout: function () {
        return myTimeout;
      }
    };
  }();


  var Data = {
    DataLayer: DataLayer,
    Utils: {
				/** * Return array of modules affected by user request/action **/
      getModulesForRequest: function (oRequest) {
        var _requests = Data.Global.getRequests();
        if (_requests) {
          return _requests[oRequest];
        }
      },
      getModuleInformation: function (sModule) {
        var _modules = Data.Global.getModules();
        if (_modules) {
          return _modules[sModule];
        }
      },
      isInlineRequest: function (sRequest) {
        var _inlineRequests = Data.Global.getInlineRequests();
        if ($.inArray(sRequest, _inlineRequests) >= 0) {
          return true;
        }
        else {
          return false;
        }
      },
      getAction: function (sRequest, oForm) {
        var _formAction = utils.getFormAction(oForm);
        var _actions = Data.Global.getActions();
        if (_formAction !== '') {
          return _formAction;
        }
        else {
          if (_actions) {
            try {
              if (_actions[sRequest][0] === '') {
                throw 'not found';
              }
              return _actions[sRequest][0];
            }
			                catch (e) {
                  var _defaultActions = Data.Global.getDefaultActions();
                  return _defaultActions[sRequest][0];
                }
          }
        }
      },
      removeAjaxLoadersPerRequest: function (oElem, sRequest) {
        var _affectedModules = Data.Utils.getModulesForRequest(sRequest);
        for (var i = 0; i < _affectedModules.length; i++) {
          var val = _affectedModules[i];
          var _moduleInfo = Data.Utils.getModuleInformation(val);
          if (_moduleInfo.length > 0) {
            if (_moduleInfo[2] === false) {
              var $selector = utils.getDeliveryGroup(oElem).find(_moduleInfo[0]);
            }
            else {
              var $selector = $(_moduleInfo[0]);
            }
            utils.removeAjaxLoader($selector);
          }
        }
      },


				/** *
				* We need to add an ajax loader to each specific module on what action the user has taken, this function maps the request to the modules
				*/
      addAjaxLoaderPerRequest: function (oRequest, oElem) {
        var _affectedModules = Data.Utils.getModulesForRequest(oRequest);
        for (var i = 0; i < _affectedModules.length; i++) {
          var val = _affectedModules[i];
          var _moduleInfo = Data.Utils.getModuleInformation(val);
          if (_moduleInfo.length > 0) {
            if (_moduleInfo[3] === false || _moduleInfo[3] === undefined) {
              if (typeof _moduleInfo[3] !== 'object') {
                if (_moduleInfo[2] === false) {
                  var $selector = utils.getDeliveryGroup(oElem).find(_moduleInfo[0]);
                }
                else if (_moduleInfo[2] === 'basket') {
                  var $selector = utils.getProductTile(oElem).find(_moduleInfo[0]);
                }
                else {
                  var $selector = $(_moduleInfo[0]);
                }
                loader($selector, _moduleInfo[1]);
									// utils.addAjaxLoader($selector, _moduleInfo[1]);
              }
            }
            else {
						 		// We have passed a custom object to be performed as the Ajax loader
              if (typeof _moduleInfo[3] === 'object') {
                _moduleInfo[3].ajaxLoader.apply(undefined, arguments);
              }
              if (typeof _moduleInfo[3] === 'function') {
                _moduleInfo[3]();
              }
            }
          }
        }
      }
    },
    Common: {
				/** *
			    *   From the oElem (DOM element which triggered data), we can determine which module has been triggered
			    **/
      handler: function (oJSON, oElem) {
			        // Based on JSON response, we need to look up each element in object, relate it to the module and then lookup the module for the DOM element
        $.each(oJSON, function (k, v) {
          if (k === 'analytics') {
            if (analytics) {
              var _oWebAnalytics = new analytics.WebMetrics();
              _oWebAnalytics.submit(v);
            }
          }
          else if (k === 'redirection') {
            var sLocation = v;
			            	// Added condition to check if "error" attribute exists
            if (oJSON.error != undefined) {
              sLocation += '&error=' + oJSON.error;
            }
            location.href = sLocation;
          }
          else {
            if (Data.Handlers.Checkout.isCustomModule(k)) {
              var _myModuleSelector = '#' + k;
            }
            else {
                                  // Get Module information, dom element, message and if it is a global element
              var _myModuleInfo = Data.Utils.getModuleInformation(k);
              var _myModuleSelector = _myModuleInfo[0];
            }

			                // Update DOM with markup returned
            var _markup = Data.Common.cleanMarkup(v);
            try {
			                    // Do not allow no html to be inserted
              if (_markup != '') {
                if (_myModuleInfo !== undefined && _myModuleInfo[4] === true) {
                  $(_myModuleSelector).replaceWith(_markup);
                }
                else {
                  $(_myModuleSelector).get(0).innerHTML = _markup;
                }
              }
            }
			                catch (e) {

                }
          }
        });
      },
      cleanMarkup: function (sHTML) {
        if (sHTML != null) {
          return sHTML.replace(/<(script|style|title)[^<]+<\/(script|style|title)>/gm, '').replace(/<(link|meta)[^>]+>/g, '');
        }
        else {
          return '';
        }
      }
    },
    Global: Global,
    Handlers: {
      Checkout: {
				    /** *
				    *   From the oElem (DOM element which triggered data), we can determine which module has been triggered and which, if applicable, delivery group.
				    **/
        handler: function (oJSON, oElem) {
				        // Based on JSON response, we need to look up each element in object, relate it to the module and then lookup the module for the DOM element
          $.each(oJSON, function (k, v) {
            if (k === 'analytics') {
              var _oWebAnalytics = new analytics.WebMetrics();
              _oWebAnalytics.submit(v);
            }
            else if (k === 'redirection') {
              location.href = v;
            }
            else {
				                // Get the module DOM element
              if (Data.Handlers.Checkout.isCustomModule(k)) {
                var _myModuleSelector = '#' + k;
              }
              else {
				                    // Get Module information, dom element, message and if it is a global element
                var _myModuleInfo = Data.Utils.getModuleInformation(k);
                var _myModuleSelector = _myModuleInfo[0];
                if (_myModuleInfo[2] == false) {
				                        // Get the module within the delivery group if we are not updating all the delivery groups
                  _myModuleSelector = utils.getDeliveryGroup(oElem).find(_myModuleSelector);
                }
              }
				                // Update DOM with markup returned
              var _markup = Data.Handlers.Checkout.cleanMarkup(v);
				                // $(_myModuleSelector).html(_markup);
              try {
				                    // Do not allow no html to be inserted
                if (_markup != '') {
                  $(_myModuleSelector).get(0).innerHTML = _markup;
                }
              }
				                catch (e) {

                }
            }
          });
        },
        cleanMarkup: function (sHTML) {
          if (sHTML != null) {
            return sHTML.replace(/<(script|style|title)[^<]+<\/(script|style|title)>/gm, '').replace(/<(link|meta)[^>]+>/g, '');
          }
          else {
            return '';
          }
        },
        isCustomModule: function (sModule) {
				        // If module contains "dg-", we know the backend is targeting a specific delivery group
          return sModule.match(/dg-/g) ? true : false;
        }
      }
    }

  };

  return Data;
});

/*jslint plusplus: true, nomen: true */
/*globals window,document,console,define,require,jQuery,$ */
define('modules/inline-scrollbar/common',['domlib', 'modules/common'], function ($, common) {
    'use strict';
    var containerId = 'pagination-nav',
        max,
        diff,
        cssTransitionsSupported,
        allow,
        totalPages,
        y,
        h,
        lastInitializedScrollbar,
        staticBasketHeader,
        hideIfDisabled = true,
        forceEnableScroll,
        autoScrollOnce = false,
        navButtonsClicked = false;

    function InlineScrollbar() {
        var self = this;
        self.html = '<div id="' + containerId + '" class="pagination-nav-container"><a href="#" class="pagination-up disabled" data-icon="1"></a><div class="pagination-bar"><span></span></div><a href="#" class="pagination-down" data-icon="2"></a></div>';
        self.$wrapper = null;
        self.$content = null;
        self.$pageNav = null;
        self.$pageNavContainer = null;
        self.$pageBar = null;
        self.$pageUp = null;
        self.$pageDown = null;
        self.$pageMark = null;
        self.eventTransitionEnd = 'transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd';
        self.closeBtnHTML = '<a href="#" class="close"><span class="icon" aria-hidden="true"></span><span class="label">Close overlay and continue shopping</span></a>';
        self.overlayScrollbar = null;
    }

    InlineScrollbar.prototype = {
        constructor: InlineScrollbar,

        init: function init($parentEl, opts) {
            var self = new InlineScrollbar();

            self.step = 0;
            self.steps = [0];
            self.modifier = 0;

            if (opts === null || opts === undefined) {
                self.overlayScrollbar = false;
                opts = {};
            } else if (opts && opts.containerId && opts.containerId !== '') {
                self.overlayScrollbar = false;
                self.html = self.html.replace(containerId, opts.containerId);
                containerId = opts.containerId;
            } else {
                self.overlayScrollbar = true;
            }

            if (self.overlayScrollbar) {
                $parentEl.addClass('scrolling-overlay');
                $parentEl.wrapInner('<div id="lightbox-content"><div class="overlay-wrapper"></div></div>');
                $parentEl.prepend('<div class="overlay-header">' + opts.paginationHeader + self.closeBtnHTML + '</div>');
            } else {
                $parentEl.addClass('inline-scrolling');
                $parentEl.wrapInner('<div class="content-mask"><div class="overlay-wrapper"></div></div>');
            }

            // bind the events for scrolling (checks to see if scrolling is required)
            forceEnableScroll = (opts !== undefined && opts.forceEnable !== undefined) ? opts.forceEnable : true;
            opts.enablePagination = self.setup($parentEl, {
                forceEnable: forceEnableScroll,
                customItems: opts.customItems
            });

            if (self.overlayScrollbar) {
                // if we don't need to scroll the content, set the content wrapper height back to auto
                // so the overlay height matches the content height
                if (!opts.enablePagination) {
                    $parentEl.find('#lightbox-content').css('height', 'auto');
                    return;
                }
            }

            if (opts.autoScrollTo) {
                self.move(false, opts.autoScrollTo);
            }

            if (opts.autoScrollOnce) {
                autoScrollOnce = true;
            }

            lastInitializedScrollbar = self;
        },

        setup: function setup($container, opts) {
            var x, self = this,
                forceEnable = opts.forceEnable,
                customItems = opts.customItems,
                initialStep = 0;

            if (customItems && customItems[0]) {
                for (x = 0; x < customItems.length; x++) {
                    initialStep += customItems[x];
                    self.steps.push(initialStep);
                }
            }

            // check if we actually require scrolling to be enabled
            allow = forceEnable ? true : $container.find('.overlay-wrapper').height() > $container.height();

            if (!allow) {
                $container.addClass('no-fixed-height');
                return false;
            }

            // kiosk basket inject new header
            if ($('.kiosk #wrapper.basket-details').length) {
                staticBasketHeader = '<section class="static-basket-header"><h3 class="section-heading item">Item</h3><h3 class="section-heading quantity">Quantity</h3><h3 class="section-heading price">Price</h3><h3 class="section-heading subtotal">Subtotal</h3><h3 class="section-heading remove">Remove</h3></section>';
                $('.basket-item h3.section-heading').hide();
                $('#basket-primary').prepend(staticBasketHeader);
                $('.overlay-wrapper').css('padding-top', '82px');
            }

            // plp filters amends (pagination on second overlay screen)
            if ($container.hasClass('filter-options')) {
                self.$wrapper = $container.addClass('pagination');

                self.$wrapper.find('ul:eq(0)');
                $container.prepend(self.html);
            } else {
                if (self.overlayScrollbar) {
                    self.$wrapper = $('#lightbox-content', $container);
                } else {
                    self.$wrapper = $('.content-mask', $container);
                }
                self.$content = $('.overlay-wrapper', self.$wrapper);
                $container.append(self.html);
            }

            // get the total number of pages
            totalPages = self.$content.outerHeight() / self.$wrapper.outerHeight();

            // store pagination nav elements
            self.$pageNavContainer = $container.find($('.pagination-nav-container'));
            self.$pageNav = self.$pageNavContainer || $('#' + containerId);
            self.$pageBar = self.$pageNav.find('>.pagination-bar');
            self.$pageUp = self.$pageNav.find('>a.pagination-up');
            self.$pageDown = self.$pageNav.find('>a.pagination-down');
            self.$pageMark = self.$pageBar.find('>span');

            // set the height of the pagination scroll bar
            if (totalPages >= 1) {
                self.$pageMark.css('height', self.$pageBar.outerHeight() / totalPages);
            } else {
                self.$pageMark.css('height', self.$pageBar.outerHeight() * totalPages);
            }

            if (self.$content.outerHeight() <= self.$wrapper.outerHeight()) {
                if (!hideIfDisabled) {
                    self.$pageNav.addClass('disabled');
                } else {
                    self.$pageNav.addClass('hidden');
                }
               // return false;
            }

            // bind click tap events to the up and down buttons
            self.$pageNav.on('click tap', '> a:not(".disabled, .hidden")', function (e) {
                e.preventDefault();
                e.stopPropagation();

                navButtonsClicked = true;
                self.move($(this).hasClass('pagination-up'));
                return false;
            });

            if (self.overlayScrollbar) {
                self.$wrapper.append('<div id="pagination-end" />');
            } else {
                self.$wrapper.append('<div class="pagination-end" />');
            }

            // send true back to confirm that pagination has now been enabled
            return true;
        },

        updateNav: function (y) {
            var self = this;
            max = self.$pageBar.outerHeight() - self.$pageMark.outerHeight();
            if (y <= 0) {
                self.$pageUp.addClass('disabled');
            } else {
                self.$pageUp.removeClass('disabled');
            }
            if (Math.ceil(y) >= max) {
                self.$pageDown.addClass('disabled');
            } else {
                self.$pageDown.removeClass('disabled');
            }
        },

        getMarkerPos: function (y) {
            var self = this;
            max = self.$pageBar.outerHeight() - self.$pageMark.outerHeight();
            diff = self.$content.outerHeight() / self.$pageBar.outerHeight();
            y = Math.abs(y) / diff;
            if (y <= 0) {
                y = 0;
            } else if (y >= max) {
                y = max;
            }
            return y;
        },

        animate: function (y) {
            var self = (!this.$content) ? lastInitializedScrollbar : this;

            cssTransitionsSupported = common.cssTransitionsSupported();
            max = -(self.$content.outerHeight() - self.$wrapper.outerHeight());

            if (y > 0) {
                y = 0;
            } else if (y < max) {
                y = max;
            }
            self.$content.stop();
            self.$pageMark.stop();

            if (autoScrollOnce && !navButtonsClicked) {
                self.$content.css({
                    top: y + 'px'
                });
            } else {
                if (cssTransitionsSupported) {
                    self.$content.css({
                        top: y + 'px',
                        transition: 'top 500ms ease-in-out'
                    });
                } else {
                    self.$content.animate({
                        top: y
                    }, '500');
                }
            }

            y = self.getMarkerPos(y);

            if (autoScrollOnce && !navButtonsClicked) {
                self.$pageMark.css({
                    top: y + 'px'
                });
                self.updateNav(y);
            } else {
                if (cssTransitionsSupported) {
                    self.$pageMark
                        .one(self.eventTransitionEnd, function () {
                            self.updateNav(y);
                        })
                        .css({
                            top: y + 'px',
                            transition: 'top 500ms ease-in-out'
                        });
                } else {
                    self.$pageMark.animate({
                        top: y
                    }, '500', function () {
                        self.updateNav(y);
                    });
                }
            }
            navButtonsClicked = false;
        },

        decorateWithCustomSteps: function decorateWithCustomSteps(position, isUp, scrollTo) {
            var self = this;
            if (self.steps && self.steps[1]) {

                if (isUp) {
                    self.step -= 1;
                    self.step = (self.step <= 0) ? 0 : self.step;
                    self.modifier = (self.step <= 0) ? 0 : self.modifier - 3;
                } else {
                    self.step += 1;
                    self.step = (self.step >= (self.steps.length - 2)) ? self.steps.length - 2 : self.step;
                    self.modifier = (self.step >= (self.steps.length - 2)) ? self.modifier : self.modifier + 3;
                }

                if (scrollTo) {
                    self.step = scrollTo;
                }

                position = self.steps[self.step] + self.modifier;
                position *= -1;
            }
            return position;
        },

        // used by both pagination nav up/down and kiosk swipe events
        move: function (isUp, scrollTo) {
            var self = this;
            if (self.$content.length > 0) {
                y = parseInt(self.$content.css('top').split('px')[0], 10);

                h = totalPages > 1 ? (self.$content.outerHeight() / totalPages) : self.$content.outerHeight();

                if (isNaN(y)) {
                    y = 0;
                }

                if (isUp) {
                    y += h;
                } else {
                    y -= h;
                }

                y = self.decorateWithCustomSteps(y, isUp, scrollTo);

                self.animate(y);
            }
        }
    };

    return InlineScrollbar.prototype;
});
/**
 * Common Module : Utility/common functions to be used across modules
 */
define('modules/overlay/common',['domlib', 'modules/breakpoint', 'modules/common', 'modules/inline-scrollbar/common'], function ($, breakpoint, common, inlineScrollbar) {

    var overlay = {

        defaultOptions: {
            content: '',
            callback: '',
            fixedWidth: '',
            customClass: '',
            isError: false,
            isSubsequentOverlay: false,
            defaultBreakPointBehavior: true,
            enablePagination: false,
            preserveContent: false,
            paginationHeader: '',
            hideOnOverlayClick: false,
            showCloseButton: true,
            additionalCloseButtonClassNames: '',
            lightboxPosition: null,
            hideOnEsc: false
        },

        eventTransitionEnd: 'transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd',
        closeBtnHTML: '<a href="#" class="close"><span class="icon" aria-hidden="true"></span><span class="label">Close overlay and continue shopping</span></a>',

        pageScroll: {
            wrapper: '#wrapper',
            isEnabled: true,
            scrollTop: 0,

            height: function (isOrientationChange) {
                var self = overlay;
                var boxHeight = $('#lightbox').height();
                var winHeight = window.innerHeight || document.documentElement.clientHeight;
                var wrapper = $(self.pageScroll.wrapper);
                boxHeight = (boxHeight > winHeight) ? boxHeight + 40 : winHeight;

                wrapper.height(boxHeight);

                // reset the scrollTop on orientation change as the original position has changed
                // TODO - look into extending the show options to include the overlay.show() trigger element so
                // the scrolltop can be reset to it's position
                if (isOrientationChange) {
                    self.pageScroll.scrollTop = 0;
                }
            },

            disable: function (gotoTop) {
                var self = overlay;
                var wrapper = $(self.pageScroll.wrapper);
                if (self.pageScroll.isEnabled) {
                    if (gotoTop) {
                        self.pageScroll.scrollTop = $(window).scrollTop();
                        window.scrollTo(0, 1);
                    }

                    self.pageScroll.height();
                    wrapper.addClass('no-scroll');

                    self.pageScroll.isEnabled = false;
                }
            },

            enable: function () {
                var self = overlay;
                var wrapper = $(self.pageScroll.wrapper);
                if (!self.pageScroll.isEnabled) {
                    wrapper
                        .height('auto')
                        .removeClass('no-scroll');
                    
                    if (breakpoint.kiosk && wrapper.hasClass('spi')) {
                        wrapper.removeAttr('style');
                    }
                    
                    $(window).scrollTop(self.pageScroll.scrollTop);

                    self.pageScroll.isEnabled = true;
                }
            },
        },
        pagination: {
            setup: function () {}
        },
        createOverlay: function (opts) {
            $('#overlay').remove();
            var self = overlay;
            var $overlay = $('#overlay');

            // prepare to catch and prevent attempts to scroll the background page on touch devices
            var touchEvents = common.isAndroid() ? 'touchmove touchstart' : 'touchmove';

            // create the overlay if one doesn't already exist
            if (!$overlay.length) {
                $overlay = $('<div id="overlay" class="hidden" />');
            }

            $overlay.css('height', '100%');
            $overlay.appendTo('body');

            return $overlay;
        },

        createLightbox: function (opts) {
            $('#lightbox').remove();
            var self = overlay;
            var $lightbox = $('<div id="lightbox" />').html(opts.content);

            var beforeOverlayHide = function (e) {
                e.preventDefault();
                e.stopPropagation();

                if (opts.preserveContent === true) {
                    var tempStoreContent = opts.content.detach();
                    // This creates a tempary hidden div so that if the user clicks/opens the preserved
                    // content the height can be calculated as it is not display none.
                    if (!$('.tmpPreserveContentContainer').length) {
                        $('body').append('<div class="tmpPreserveContentContainer"></div>');
                    };
                    $('body .tmpPreserveContentContainer').append(tempStoreContent);
                    $('.tmpPreserveContentContainer').hide();
                }

                self.hide();

                if (opts.onHideCallback) {

                    opts.onHideCallback();
                }
            };

            // if a previous lightbox was opened before creating this one, then add the 'subsequent'
            // don't add the 'subsequent' class if it's the kiosk - reason?
            if (opts.isSubsequentOverlay && !breakpoint.kiosk) {
                $lightbox.addClass('subsequent');
            }

            // add any custom classes to the main lightbox wrapper only
            if (opts.customClass) {
                $lightbox.addClass(opts.customClass);
            }

            // update the lightbox to display in an error state
            if (opts.isError) {
                $lightbox.addClass('error-overlay').wrapInner('<div class="generic" />');
            }

            // fixed width lightbox - widths will be set in pixels so if the fixedWidth is not a number then exit
            if (opts.fixedWidth) {
                opts.fixedWidth = parseInt(opts.fixedWidth, 10);

                if (isNaN(opts.fixedWidth)) {
                    return;
                }

                $lightbox.css({
                    width: opts.fixedWidth + 'px',
                    left: '50%',
                    marginLeft: '-' + (opts.fixedWidth / 2) + 'px',
                    marginRight: 0
                });
            }

            // lightbox needs to be added to the dom for the following as we need to obtain dimensions
            $lightbox.appendTo('body');

            // if it's not the kiosk, then don't add the hidden class as the
            // kiosk lightboxes slide in/out from the top of the screen
            if (!breakpoint.kiosk) {
                $lightbox.addClass('hidden');
            }

            // check if the overlay does actually require scrolling as it's content may not exceed the wrapper
            // height, if so, no point adding the pagination controls as they'll do nothing.
            if (opts.enablePagination) {
                inlineScrollbar.init($lightbox, opts);
            }

            // add a close button to the lightbox if one doesn't exist and bind click to close
            // on all '.close' elements (can be multiple close buttons - top right, cancel etc)
            if (opts.showCloseButton && !$lightbox.find('a.close').not('.tooltipPopup a.close').length) {
                $lightbox.prepend(self.closeBtnHTML);
            }

            var event = (common.isTouch()) ? 'tap click' : 'click';

            // click too slow on windows phone
            if (common.isWindowsPhone()) {
                event = 'MSPointerDown';
            }

            $lightbox.on(event, 'a.close', function (e) {
                if ($(this).not('.tooltipPopup a.close').length) {
                    beforeOverlayHide(e);
                }
            });
            if (opts.hideOnOverlayClick === true) {
                $("#overlay").click(beforeOverlayHide);
            }
            if (opts.hideOnEsc === true) {
                document.onkeydown = function(e) {
					if (e.which == 27){
                        beforeOverlayHide(e);
					}
				}
            }

            // enable the default breakpoint behaviours
            if (opts.defaultBreakPointBehavior) {
                if (breakpoint.mobile) {

                    // qc defect 52204 & 52205 fix - this is in place to support as yet undeveloped functionality
                    // (show more button). this is now causing scrolling issues and should be commented out until
                    // that functionality is added
                    /*$lightbox.on('touchmove', function(e) {
                        if ($lightbox.outerHeight() < window.innerHeight) {
                            e.preventDefault();
                        }
                    }, false);*/
                } else if (breakpoint.largeDesktop || breakpoint.desktop) {
                    $lightbox.css({
                        'float': 'none'
                    });
                }
            }

            return $lightbox;
        },

        // update the top position of the lightbox for touch devices as it can shift on orientation change,
        // or when the lightboxPosition option is specified
        position: function ($lightbox, lightboxPosition, isOrientationChange) {
            var self = overlay;
            var delay = isOrientationChange ? 300 : 1;

            // RETEST - timeout may not be needed
            window.setTimeout(function () {
                if (lightboxPosition) {
                    if (typeof lightboxPosition === 'function') {
                        lightboxPosition();
                    } else if (lightboxPosition === 'verticallyCentre') {
                        $lightbox.verticallyCentre();
                    } else if (lightboxPosition === 'verticallyBottom') {
                        $lightbox.addClass('verticallyBottom');
                    }
                } else {
                    $lightbox.css('top', 20);
                }

                // if the orientation has changed, the update the page scroll height as the lightbox dimensions
                // have now changed and reset the scrollTop on orientation change as the original position has changed
                if (isOrientationChange) {
                    self.pageScroll.height(true);
                }
            }, delay);
        },

        show: function (extendOptions) {
            var self = overlay;
            var $overlay = $('#overlay');
            var $lightbox = $('#lightbox');
            var defaults = self.defaultOptions;
            var opts = $.extend({}, defaults, extendOptions);
            var lightboxPosition = opts.lightboxPosition;
            var isMobileDevice = common.isTouch() && !breakpoint.kiosk;

            // if a lightbox is already opened, hide it - can only have one on screen at a time
            // assume that the new one to be opened in the second/sub view for the current lightbox
            opts.isSubsequentOverlay = $lightbox.length;

            // create and add to dom
            $overlay = self.createOverlay(opts);
            $lightbox = self.createLightbox(opts);

            // stop the page from scrolling and set the goToTop flag to true
            self.pageScroll.disable(true);

            var callback = function () {
                if (typeof (opts.callback) === 'function') {
                    opts.callback($lightbox);
                }
            };

            // update the top position of the lightbox for touch devices as it can
            // shift on orientation change, or when the lightboxPosition option is specified
            if (isMobileDevice || lightboxPosition) {
                if (typeof lightboxPosition === 'function') {
                    lightboxPosition = function () {
                        opts.lightboxPosition($lightbox);
                    };
                }
                self.position($lightbox, lightboxPosition);

                // windows phone, no orientationchange event
                if (typeof window.orientation !== 'undefined') {
                    $(window).bind('orientationchange.overlay', function () {
                        self.position($lightbox, lightboxPosition, isMobileDevice);
                    });
                } else {
                    $(window).bind('resize.overlay', function () {
                        self.position($lightbox, lightboxPosition, isMobileDevice);
                    });
                }
            }

            // kiosk slide lightbox in from the top of the screen
            if (breakpoint.kiosk) {
                // store the original height of the lightbox then set height to 0
                var height = $lightbox.outerHeight();

                $lightbox.css('height', 0);

                // remove the hidden class from the overlay to fade in
                $overlay.removeClass('hidden');

                // TO INVESTIGATE - timer used and the css animation doesn't trigger
                window.setTimeout(function () {
                    // add the 'slide-out' class so we can animate the slide in and restore the
                    // original height of the lightbox - 'slide-out' css animation is triggered
                    $lightbox
                        .addClass('slide-out')
                        .css('height', height)
                        .one(self.eventTransitionEnd, function () {
                            // animation done:
                            // * remove the transition end event to stop being retriggered if a css property changes (annoying!!!)
                            // * remove the 'slide-out' class to stop the css animation from being retriggered if the lightbox height changes
                            // * clear the inline style height also as some scripts will update the height of the
                            //   inner content container so the lightbox height will need to auto adjust accordingly
                            $lightbox
                                .off(self.eventTransitionEnd)
                                .removeClass('slide-out')
                                .css('height', '');
                        });
                    callback();
                }, 10);
            } else {

                // TO INVESTIGATE - timer used and the css animation doesn't trigger
                window.setTimeout(function () {

                    // remove the hidden class from elements to do initial fade in
                    $overlay.removeClass('hidden');
                    $lightbox.removeClass('hidden');

                    // apply the transitionend event to the lightbox element, no need to trigger the event on the overlay mask
                    if (common.cssTransitionsSupported()) {
                        $lightbox.one(self.eventTransitionEnd, function () {
                            callback();
                        });
                    }

                    // fallback
                    else {
                        callback();
                    }

                }, 10);
            }
        },

        hide: function ($lightbox, isSubsequentOverlay) {
            var self = overlay;
            var $overlay = $('#overlay');

            // if no lightbox passed, then grab the first one (reason for first?)
            $lightbox = $lightbox || $('#lightbox').first();

            // if it's the kiosk, force the isSubsequentOverlay to be false
            if (breakpoint.kiosk) {
                isSubsequentOverlay = false;
            }

            // only hide the overlay mask if we dont have a subsequent overlay
            var $hide = $lightbox;

            if (!isSubsequentOverlay) {
                $hide = $hide.add($overlay);
            }

            // only remove the defined hide elements and enable page scroll if we dont have a subsequent overlay
            var callback = function () {
                $hide.remove();
                if (!isSubsequentOverlay) {
                    overlay.pageScroll.enable();
                }
            };

            // remove the orientation/resize events to stop firing when the overlay is closed
            if (common.isTouch() && !breakpoint.kiosk) {
                if (typeof window.orientation !== 'undefined') {
                    $(window).unbind('orientationchange.overlay');
                } else {
                    $(window).unbind('resize.overlay');
                }
            }

            // kiosk slide lightbox out to the top of the screen
            if (breakpoint.kiosk) {

                // fade out the overlay
                $overlay.addClass('hidden');

                // set the current height of the overlay so we can slide out
                $lightbox.css('height', $lightbox.outerHeight());

                // TO INVESTIGATE - timer used and the css animation doesn't trigger
                window.setTimeout(function () {
                    // add the 'slide-out' css animation and set the height to 0 to trigger animation of the lightbox
                    $lightbox
                        .addClass('slide-out')
                        .css('height', 0)
                        .one(self.eventTransitionEnd, function () {
                            callback();
                        });
                }, 10);
            } else {
                // TO INVESTIGATE - timer used and the css animation doesn't trigger
                window.setTimeout(function () {
                    // fade out the overlay and lightbox
                    $hide.addClass('hidden');
                    callback();
                }, 300);
            }
            $(document).trigger('kioskModalHidden');
        }
    };

    return overlay;
});
define('modules/page-title/common',['domlib', 'modules/common', 'modules/overlay/common'], function ($, common, overlay) {
    'use strict';

    var pageTitle = {

        pageTitleElement: '.page-title',

        Ellipsis: {
            /**
             * @name TESCO.Products.Ellipsis.init
             * @description This method forms the ellipses on the product tiles
             */
            init: function init() {
                var ellipString = '<span class="ellipsis"><span class="icon" data-icon="&hellip;"></span></span>';
                $(pageTitle.pageTitleElement).dotdotdot({
                    ellipsis: '',
                    after: ellipString,
                    wrap: 'word',
                    watch: false,
                    tolerance: 0,
                    callback: function (isTruncated, orgContent) {
                        if (window.isKiosk()) {
                            // This code will make kiosk always show ellipsis to show terms&condtions
                            if (!isTruncated && $('#offersTerms', $(this)).length !== 0) {
                                $('.dotdotdot', $(this)).append(ellipString);
                            }
                            $('.ellipsis', $(this)).on('tap click', function (e) {
                                e.preventDefault();
                                var $template = $('<div id="lightbox-content" />');
                                $template.append($('<h2 />'));
                                $template.find('h2').html(orgContent);
                                overlay.show({
                                    content: $template
                                });
                            });
                        }
                    }
                });
            }
        }
    };

    common.init.push(function () {

        if (window.isKiosk()) {
            common.init.push(pageTitle.Ellipsis.init);
            var doc = $('body');
            doc.attr('data-useragent', navigator.userAgent);
        }
    });

    return pageTitle;

});
//     Underscore.js 1.6.0
//     http://underscorejs.org
//     (c) 2009-2014 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
//     Underscore may be freely distributed under the MIT license.
(function(){var n=this,t=n._,r={},e=Array.prototype,u=Object.prototype,i=Function.prototype,a=e.push,o=e.slice,c=e.concat,l=u.toString,f=u.hasOwnProperty,s=e.forEach,p=e.map,h=e.reduce,v=e.reduceRight,g=e.filter,d=e.every,m=e.some,y=e.indexOf,b=e.lastIndexOf,x=Array.isArray,w=Object.keys,_=i.bind,j=function(n){return n instanceof j?n:this instanceof j?void(this._wrapped=n):new j(n)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=j),exports._=j):n._=j,j.VERSION="1.6.0";var A=j.each=j.forEach=function(n,t,e){if(null==n)return n;if(s&&n.forEach===s)n.forEach(t,e);else if(n.length===+n.length){for(var u=0,i=n.length;i>u;u++)if(t.call(e,n[u],u,n)===r)return}else for(var a=j.keys(n),u=0,i=a.length;i>u;u++)if(t.call(e,n[a[u]],a[u],n)===r)return;return n};j.map=j.collect=function(n,t,r){var e=[];return null==n?e:p&&n.map===p?n.map(t,r):(A(n,function(n,u,i){e.push(t.call(r,n,u,i))}),e)};var O="Reduce of empty array with no initial value";j.reduce=j.foldl=j.inject=function(n,t,r,e){var u=arguments.length>2;if(null==n&&(n=[]),h&&n.reduce===h)return e&&(t=j.bind(t,e)),u?n.reduce(t,r):n.reduce(t);if(A(n,function(n,i,a){u?r=t.call(e,r,n,i,a):(r=n,u=!0)}),!u)throw new TypeError(O);return r},j.reduceRight=j.foldr=function(n,t,r,e){var u=arguments.length>2;if(null==n&&(n=[]),v&&n.reduceRight===v)return e&&(t=j.bind(t,e)),u?n.reduceRight(t,r):n.reduceRight(t);var i=n.length;if(i!==+i){var a=j.keys(n);i=a.length}if(A(n,function(o,c,l){c=a?a[--i]:--i,u?r=t.call(e,r,n[c],c,l):(r=n[c],u=!0)}),!u)throw new TypeError(O);return r},j.find=j.detect=function(n,t,r){var e;return k(n,function(n,u,i){return t.call(r,n,u,i)?(e=n,!0):void 0}),e},j.filter=j.select=function(n,t,r){var e=[];return null==n?e:g&&n.filter===g?n.filter(t,r):(A(n,function(n,u,i){t.call(r,n,u,i)&&e.push(n)}),e)},j.reject=function(n,t,r){return j.filter(n,function(n,e,u){return!t.call(r,n,e,u)},r)},j.every=j.all=function(n,t,e){t||(t=j.identity);var u=!0;return null==n?u:d&&n.every===d?n.every(t,e):(A(n,function(n,i,a){return(u=u&&t.call(e,n,i,a))?void 0:r}),!!u)};var k=j.some=j.any=function(n,t,e){t||(t=j.identity);var u=!1;return null==n?u:m&&n.some===m?n.some(t,e):(A(n,function(n,i,a){return u||(u=t.call(e,n,i,a))?r:void 0}),!!u)};j.contains=j.include=function(n,t){return null==n?!1:y&&n.indexOf===y?n.indexOf(t)!=-1:k(n,function(n){return n===t})},j.invoke=function(n,t){var r=o.call(arguments,2),e=j.isFunction(t);return j.map(n,function(n){return(e?t:n[t]).apply(n,r)})},j.pluck=function(n,t){return j.map(n,j.property(t))},j.where=function(n,t){return j.filter(n,j.matches(t))},j.findWhere=function(n,t){return j.find(n,j.matches(t))},j.max=function(n,t,r){if(!t&&j.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.max.apply(Math,n);var e=-1/0,u=-1/0;return A(n,function(n,i,a){var o=t?t.call(r,n,i,a):n;o>u&&(e=n,u=o)}),e},j.min=function(n,t,r){if(!t&&j.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.min.apply(Math,n);var e=1/0,u=1/0;return A(n,function(n,i,a){var o=t?t.call(r,n,i,a):n;u>o&&(e=n,u=o)}),e},j.shuffle=function(n){var t,r=0,e=[];return A(n,function(n){t=j.random(r++),e[r-1]=e[t],e[t]=n}),e},j.sample=function(n,t,r){return null==t||r?(n.length!==+n.length&&(n=j.values(n)),n[j.random(n.length-1)]):j.shuffle(n).slice(0,Math.max(0,t))};var E=function(n){return null==n?j.identity:j.isFunction(n)?n:j.property(n)};j.sortBy=function(n,t,r){return t=E(t),j.pluck(j.map(n,function(n,e,u){return{value:n,index:e,criteria:t.call(r,n,e,u)}}).sort(function(n,t){var r=n.criteria,e=t.criteria;if(r!==e){if(r>e||r===void 0)return 1;if(e>r||e===void 0)return-1}return n.index-t.index}),"value")};var F=function(n){return function(t,r,e){var u={};return r=E(r),A(t,function(i,a){var o=r.call(e,i,a,t);n(u,o,i)}),u}};j.groupBy=F(function(n,t,r){j.has(n,t)?n[t].push(r):n[t]=[r]}),j.indexBy=F(function(n,t,r){n[t]=r}),j.countBy=F(function(n,t){j.has(n,t)?n[t]++:n[t]=1}),j.sortedIndex=function(n,t,r,e){r=E(r);for(var u=r.call(e,t),i=0,a=n.length;a>i;){var o=i+a>>>1;r.call(e,n[o])<u?i=o+1:a=o}return i},j.toArray=function(n){return n?j.isArray(n)?o.call(n):n.length===+n.length?j.map(n,j.identity):j.values(n):[]},j.size=function(n){return null==n?0:n.length===+n.length?n.length:j.keys(n).length},j.first=j.head=j.take=function(n,t,r){return null==n?void 0:null==t||r?n[0]:0>t?[]:o.call(n,0,t)},j.initial=function(n,t,r){return o.call(n,0,n.length-(null==t||r?1:t))},j.last=function(n,t,r){return null==n?void 0:null==t||r?n[n.length-1]:o.call(n,Math.max(n.length-t,0))},j.rest=j.tail=j.drop=function(n,t,r){return o.call(n,null==t||r?1:t)},j.compact=function(n){return j.filter(n,j.identity)};var M=function(n,t,r){return t&&j.every(n,j.isArray)?c.apply(r,n):(A(n,function(n){j.isArray(n)||j.isArguments(n)?t?a.apply(r,n):M(n,t,r):r.push(n)}),r)};j.flatten=function(n,t){return M(n,t,[])},j.without=function(n){return j.difference(n,o.call(arguments,1))},j.partition=function(n,t){var r=[],e=[];return A(n,function(n){(t(n)?r:e).push(n)}),[r,e]},j.uniq=j.unique=function(n,t,r,e){j.isFunction(t)&&(e=r,r=t,t=!1);var u=r?j.map(n,r,e):n,i=[],a=[];return A(u,function(r,e){(t?e&&a[a.length-1]===r:j.contains(a,r))||(a.push(r),i.push(n[e]))}),i},j.union=function(){return j.uniq(j.flatten(arguments,!0))},j.intersection=function(n){var t=o.call(arguments,1);return j.filter(j.uniq(n),function(n){return j.every(t,function(t){return j.contains(t,n)})})},j.difference=function(n){var t=c.apply(e,o.call(arguments,1));return j.filter(n,function(n){return!j.contains(t,n)})},j.zip=function(){for(var n=j.max(j.pluck(arguments,"length").concat(0)),t=new Array(n),r=0;n>r;r++)t[r]=j.pluck(arguments,""+r);return t},j.object=function(n,t){if(null==n)return{};for(var r={},e=0,u=n.length;u>e;e++)t?r[n[e]]=t[e]:r[n[e][0]]=n[e][1];return r},j.indexOf=function(n,t,r){if(null==n)return-1;var e=0,u=n.length;if(r){if("number"!=typeof r)return e=j.sortedIndex(n,t),n[e]===t?e:-1;e=0>r?Math.max(0,u+r):r}if(y&&n.indexOf===y)return n.indexOf(t,r);for(;u>e;e++)if(n[e]===t)return e;return-1},j.lastIndexOf=function(n,t,r){if(null==n)return-1;var e=null!=r;if(b&&n.lastIndexOf===b)return e?n.lastIndexOf(t,r):n.lastIndexOf(t);for(var u=e?r:n.length;u--;)if(n[u]===t)return u;return-1},j.range=function(n,t,r){arguments.length<=1&&(t=n||0,n=0),r=arguments[2]||1;for(var e=Math.max(Math.ceil((t-n)/r),0),u=0,i=new Array(e);e>u;)i[u++]=n,n+=r;return i};var R=function(){};j.bind=function(n,t){var r,e;if(_&&n.bind===_)return _.apply(n,o.call(arguments,1));if(!j.isFunction(n))throw new TypeError;return r=o.call(arguments,2),e=function(){if(!(this instanceof e))return n.apply(t,r.concat(o.call(arguments)));R.prototype=n.prototype;var u=new R;R.prototype=null;var i=n.apply(u,r.concat(o.call(arguments)));return Object(i)===i?i:u}},j.partial=function(n){var t=o.call(arguments,1);return function(){for(var r=0,e=t.slice(),u=0,i=e.length;i>u;u++)e[u]===j&&(e[u]=arguments[r++]);for(;r<arguments.length;)e.push(arguments[r++]);return n.apply(this,e)}},j.bindAll=function(n){var t=o.call(arguments,1);if(0===t.length)throw new Error("bindAll must be passed function names");return A(t,function(t){n[t]=j.bind(n[t],n)}),n},j.memoize=function(n,t){var r={};return t||(t=j.identity),function(){var e=t.apply(this,arguments);return j.has(r,e)?r[e]:r[e]=n.apply(this,arguments)}},j.delay=function(n,t){var r=o.call(arguments,2);return setTimeout(function(){return n.apply(null,r)},t)},j.defer=function(n){return j.delay.apply(j,[n,1].concat(o.call(arguments,1)))},j.throttle=function(n,t,r){var e,u,i,a=null,o=0;r||(r={});var c=function(){o=r.leading===!1?0:j.now(),a=null,i=n.apply(e,u),e=u=null};return function(){var l=j.now();o||r.leading!==!1||(o=l);var f=t-(l-o);return e=this,u=arguments,0>=f?(clearTimeout(a),a=null,o=l,i=n.apply(e,u),e=u=null):a||r.trailing===!1||(a=setTimeout(c,f)),i}},j.debounce=function(n,t,r){var e,u,i,a,o,c=function(){var l=j.now()-a;t>l?e=setTimeout(c,t-l):(e=null,r||(o=n.apply(i,u),i=u=null))};return function(){i=this,u=arguments,a=j.now();var l=r&&!e;return e||(e=setTimeout(c,t)),l&&(o=n.apply(i,u),i=u=null),o}},j.once=function(n){var t,r=!1;return function(){return r?t:(r=!0,t=n.apply(this,arguments),n=null,t)}},j.wrap=function(n,t){return j.partial(t,n)},j.compose=function(){var n=arguments;return function(){for(var t=arguments,r=n.length-1;r>=0;r--)t=[n[r].apply(this,t)];return t[0]}},j.after=function(n,t){return function(){return--n<1?t.apply(this,arguments):void 0}},j.keys=function(n){if(!j.isObject(n))return[];if(w)return w(n);var t=[];for(var r in n)j.has(n,r)&&t.push(r);return t},j.values=function(n){for(var t=j.keys(n),r=t.length,e=new Array(r),u=0;r>u;u++)e[u]=n[t[u]];return e},j.pairs=function(n){for(var t=j.keys(n),r=t.length,e=new Array(r),u=0;r>u;u++)e[u]=[t[u],n[t[u]]];return e},j.invert=function(n){for(var t={},r=j.keys(n),e=0,u=r.length;u>e;e++)t[n[r[e]]]=r[e];return t},j.functions=j.methods=function(n){var t=[];for(var r in n)j.isFunction(n[r])&&t.push(r);return t.sort()},j.extend=function(n){return A(o.call(arguments,1),function(t){if(t)for(var r in t)n[r]=t[r]}),n},j.pick=function(n){var t={},r=c.apply(e,o.call(arguments,1));return A(r,function(r){r in n&&(t[r]=n[r])}),t},j.omit=function(n){var t={},r=c.apply(e,o.call(arguments,1));for(var u in n)j.contains(r,u)||(t[u]=n[u]);return t},j.defaults=function(n){return A(o.call(arguments,1),function(t){if(t)for(var r in t)n[r]===void 0&&(n[r]=t[r])}),n},j.clone=function(n){return j.isObject(n)?j.isArray(n)?n.slice():j.extend({},n):n},j.tap=function(n,t){return t(n),n};var S=function(n,t,r,e){if(n===t)return 0!==n||1/n==1/t;if(null==n||null==t)return n===t;n instanceof j&&(n=n._wrapped),t instanceof j&&(t=t._wrapped);var u=l.call(n);if(u!=l.call(t))return!1;switch(u){case"[object String]":return n==String(t);case"[object Number]":return n!=+n?t!=+t:0==n?1/n==1/t:n==+t;case"[object Date]":case"[object Boolean]":return+n==+t;case"[object RegExp]":return n.source==t.source&&n.global==t.global&&n.multiline==t.multiline&&n.ignoreCase==t.ignoreCase}if("object"!=typeof n||"object"!=typeof t)return!1;for(var i=r.length;i--;)if(r[i]==n)return e[i]==t;var a=n.constructor,o=t.constructor;if(a!==o&&!(j.isFunction(a)&&a instanceof a&&j.isFunction(o)&&o instanceof o)&&"constructor"in n&&"constructor"in t)return!1;r.push(n),e.push(t);var c=0,f=!0;if("[object Array]"==u){if(c=n.length,f=c==t.length)for(;c--&&(f=S(n[c],t[c],r,e)););}else{for(var s in n)if(j.has(n,s)&&(c++,!(f=j.has(t,s)&&S(n[s],t[s],r,e))))break;if(f){for(s in t)if(j.has(t,s)&&!c--)break;f=!c}}return r.pop(),e.pop(),f};j.isEqual=function(n,t){return S(n,t,[],[])},j.isEmpty=function(n){if(null==n)return!0;if(j.isArray(n)||j.isString(n))return 0===n.length;for(var t in n)if(j.has(n,t))return!1;return!0},j.isElement=function(n){return!(!n||1!==n.nodeType)},j.isArray=x||function(n){return"[object Array]"==l.call(n)},j.isObject=function(n){return n===Object(n)},A(["Arguments","Function","String","Number","Date","RegExp"],function(n){j["is"+n]=function(t){return l.call(t)=="[object "+n+"]"}}),j.isArguments(arguments)||(j.isArguments=function(n){return!(!n||!j.has(n,"callee"))}),"function"!=typeof/./&&(j.isFunction=function(n){return"function"==typeof n}),j.isFinite=function(n){return isFinite(n)&&!isNaN(parseFloat(n))},j.isNaN=function(n){return j.isNumber(n)&&n!=+n},j.isBoolean=function(n){return n===!0||n===!1||"[object Boolean]"==l.call(n)},j.isNull=function(n){return null===n},j.isUndefined=function(n){return n===void 0},j.has=function(n,t){return f.call(n,t)},j.noConflict=function(){return n._=t,this},j.identity=function(n){return n},j.constant=function(n){return function(){return n}},j.property=function(n){return function(t){return t[n]}},j.matches=function(n){return function(t){if(t===n)return!0;for(var r in n)if(n[r]!==t[r])return!1;return!0}},j.times=function(n,t,r){for(var e=Array(Math.max(0,n)),u=0;n>u;u++)e[u]=t.call(r,u);return e},j.random=function(n,t){return null==t&&(t=n,n=0),n+Math.floor(Math.random()*(t-n+1))},j.now=Date.now||function(){return(new Date).getTime()};var T={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};T.unescape=j.invert(T.escape);var I={escape:new RegExp("["+j.keys(T.escape).join("")+"]","g"),unescape:new RegExp("("+j.keys(T.unescape).join("|")+")","g")};j.each(["escape","unescape"],function(n){j[n]=function(t){return null==t?"":(""+t).replace(I[n],function(t){return T[n][t]})}}),j.result=function(n,t){if(null==n)return void 0;var r=n[t];return j.isFunction(r)?r.call(n):r},j.mixin=function(n){A(j.functions(n),function(t){var r=j[t]=n[t];j.prototype[t]=function(){var n=[this._wrapped];return a.apply(n,arguments),z.call(this,r.apply(j,n))}})};var N=0;j.uniqueId=function(n){var t=++N+"";return n?n+t:t},j.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var q=/(.)^/,B={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},D=/\\|'|\r|\n|\t|\u2028|\u2029/g;j.template=function(n,t,r){var e;r=j.defaults({},r,j.templateSettings);var u=new RegExp([(r.escape||q).source,(r.interpolate||q).source,(r.evaluate||q).source].join("|")+"|$","g"),i=0,a="__p+='";n.replace(u,function(t,r,e,u,o){return a+=n.slice(i,o).replace(D,function(n){return"\\"+B[n]}),r&&(a+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'"),e&&(a+="'+\n((__t=("+e+"))==null?'':__t)+\n'"),u&&(a+="';\n"+u+"\n__p+='"),i=o+t.length,t}),a+="';\n",r.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{e=new Function(r.variable||"obj","_",a)}catch(o){throw o.source=a,o}if(t)return e(t,j);var c=function(n){return e.call(this,n,j)};return c.source="function("+(r.variable||"obj")+"){\n"+a+"}",c},j.chain=function(n){return j(n).chain()};var z=function(n){return this._chain?j(n).chain():n};j.mixin(j),A(["pop","push","reverse","shift","sort","splice","unshift"],function(n){var t=e[n];j.prototype[n]=function(){var r=this._wrapped;return t.apply(r,arguments),"shift"!=n&&"splice"!=n||0!==r.length||delete r[0],z.call(this,r)}}),A(["concat","join","slice"],function(n){var t=e[n];j.prototype[n]=function(){return z.call(this,t.apply(this._wrapped,arguments))}}),j.extend(j.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof define&&define.amd&&define("underscore",[],function(){return j})}).call(this);
(function(t,e){if(typeof define==="function"&&define.amd){define('backbone',["underscore","domlib","exports"],function(i,r,s){t.Backbone=e(t,s,i,r)})}else if(typeof exports!=="undefined"){var i=require("underscore");e(t,exports,i)}else{t.Backbone=e(t,{},t._,t.jQuery||t.Zepto||t.ender||t.$)}})(this,function(t,e,i,r){var s=t.Backbone;var n=[];var a=n.push;var o=n.slice;var h=n.splice;e.VERSION="1.1.2";e.$=r;e.noConflict=function(){t.Backbone=s;return this};e.emulateHTTP=false;e.emulateJSON=false;var u=e.Events={on:function(t,e,i){if(!c(this,"on",t,[e,i])||!e)return this;this._events||(this._events={});var r=this._events[t]||(this._events[t]=[]);r.push({callback:e,context:i,ctx:i||this});return this},once:function(t,e,r){if(!c(this,"once",t,[e,r])||!e)return this;var s=this;var n=i.once(function(){s.off(t,n);e.apply(this,arguments)});n._callback=e;return this.on(t,n,r)},off:function(t,e,r){var s,n,a,o,h,u,l,f;if(!this._events||!c(this,"off",t,[e,r]))return this;if(!t&&!e&&!r){this._events=void 0;return this}o=t?[t]:i.keys(this._events);for(h=0,u=o.length;h<u;h++){t=o[h];if(a=this._events[t]){this._events[t]=s=[];if(e||r){for(l=0,f=a.length;l<f;l++){n=a[l];if(e&&e!==n.callback&&e!==n.callback._callback||r&&r!==n.context){s.push(n)}}}if(!s.length)delete this._events[t]}}return this},trigger:function(t){if(!this._events)return this;var e=o.call(arguments,1);if(!c(this,"trigger",t,e))return this;var i=this._events[t];var r=this._events.all;if(i)f(i,e);if(r)f(r,arguments);return this},stopListening:function(t,e,r){var s=this._listeningTo;if(!s)return this;var n=!e&&!r;if(!r&&typeof e==="object")r=this;if(t)(s={})[t._listenId]=t;for(var a in s){t=s[a];t.off(e,r,this);if(n||i.isEmpty(t._events))delete this._listeningTo[a]}return this}};var l=/\s+/;var c=function(t,e,i,r){if(!i)return true;if(typeof i==="object"){for(var s in i){t[e].apply(t,[s,i[s]].concat(r))}return false}if(l.test(i)){var n=i.split(l);for(var a=0,o=n.length;a<o;a++){t[e].apply(t,[n[a]].concat(r))}return false}return true};var f=function(t,e){var i,r=-1,s=t.length,n=e[0],a=e[1],o=e[2];switch(e.length){case 0:while(++r<s)(i=t[r]).callback.call(i.ctx);return;case 1:while(++r<s)(i=t[r]).callback.call(i.ctx,n);return;case 2:while(++r<s)(i=t[r]).callback.call(i.ctx,n,a);return;case 3:while(++r<s)(i=t[r]).callback.call(i.ctx,n,a,o);return;default:while(++r<s)(i=t[r]).callback.apply(i.ctx,e);return}};var d={listenTo:"on",listenToOnce:"once"};i.each(d,function(t,e){u[e]=function(e,r,s){var n=this._listeningTo||(this._listeningTo={});var a=e._listenId||(e._listenId=i.uniqueId("l"));n[a]=e;if(!s&&typeof r==="object")s=this;e[t](r,s,this);return this}});u.bind=u.on;u.unbind=u.off;i.extend(e,u);var p=e.Model=function(t,e){var r=t||{};e||(e={});this.cid=i.uniqueId("c");this.attributes={};if(e.collection)this.collection=e.collection;if(e.parse)r=this.parse(r,e)||{};r=i.defaults({},r,i.result(this,"defaults"));this.set(r,e);this.changed={};this.initialize.apply(this,arguments)};i.extend(p.prototype,u,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(t){return i.clone(this.attributes)},sync:function(){return e.sync.apply(this,arguments)},get:function(t){return this.attributes[t]},escape:function(t){return i.escape(this.get(t))},has:function(t){return this.get(t)!=null},set:function(t,e,r){var s,n,a,o,h,u,l,c;if(t==null)return this;if(typeof t==="object"){n=t;r=e}else{(n={})[t]=e}r||(r={});if(!this._validate(n,r))return false;a=r.unset;h=r.silent;o=[];u=this._changing;this._changing=true;if(!u){this._previousAttributes=i.clone(this.attributes);this.changed={}}c=this.attributes,l=this._previousAttributes;if(this.idAttribute in n)this.id=n[this.idAttribute];for(s in n){e=n[s];if(!i.isEqual(c[s],e))o.push(s);if(!i.isEqual(l[s],e)){this.changed[s]=e}else{delete this.changed[s]}a?delete c[s]:c[s]=e}if(!h){if(o.length)this._pending=r;for(var f=0,d=o.length;f<d;f++){this.trigger("change:"+o[f],this,c[o[f]],r)}}if(u)return this;if(!h){while(this._pending){r=this._pending;this._pending=false;this.trigger("change",this,r)}}this._pending=false;this._changing=false;return this},unset:function(t,e){return this.set(t,void 0,i.extend({},e,{unset:true}))},clear:function(t){var e={};for(var r in this.attributes)e[r]=void 0;return this.set(e,i.extend({},t,{unset:true}))},hasChanged:function(t){if(t==null)return!i.isEmpty(this.changed);return i.has(this.changed,t)},changedAttributes:function(t){if(!t)return this.hasChanged()?i.clone(this.changed):false;var e,r=false;var s=this._changing?this._previousAttributes:this.attributes;for(var n in t){if(i.isEqual(s[n],e=t[n]))continue;(r||(r={}))[n]=e}return r},previous:function(t){if(t==null||!this._previousAttributes)return null;return this._previousAttributes[t]},previousAttributes:function(){return i.clone(this._previousAttributes)},fetch:function(t){t=t?i.clone(t):{};if(t.parse===void 0)t.parse=true;var e=this;var r=t.success;t.success=function(i){if(!e.set(e.parse(i,t),t))return false;if(r)r(e,i,t);e.trigger("sync",e,i,t)};q(this,t);return this.sync("read",this,t)},save:function(t,e,r){var s,n,a,o=this.attributes;if(t==null||typeof t==="object"){s=t;r=e}else{(s={})[t]=e}r=i.extend({validate:true},r);if(s&&!r.wait){if(!this.set(s,r))return false}else{if(!this._validate(s,r))return false}if(s&&r.wait){this.attributes=i.extend({},o,s)}if(r.parse===void 0)r.parse=true;var h=this;var u=r.success;r.success=function(t){h.attributes=o;var e=h.parse(t,r);if(r.wait)e=i.extend(s||{},e);if(i.isObject(e)&&!h.set(e,r)){return false}if(u)u(h,t,r);h.trigger("sync",h,t,r)};q(this,r);n=this.isNew()?"create":r.patch?"patch":"update";if(n==="patch")r.attrs=s;a=this.sync(n,this,r);if(s&&r.wait)this.attributes=o;return a},destroy:function(t){t=t?i.clone(t):{};var e=this;var r=t.success;var s=function(){e.trigger("destroy",e,e.collection,t)};t.success=function(i){if(t.wait||e.isNew())s();if(r)r(e,i,t);if(!e.isNew())e.trigger("sync",e,i,t)};if(this.isNew()){t.success();return false}q(this,t);var n=this.sync("delete",this,t);if(!t.wait)s();return n},url:function(){var t=i.result(this,"urlRoot")||i.result(this.collection,"url")||M();if(this.isNew())return t;return t.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},parse:function(t,e){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(t){return this._validate({},i.extend(t||{},{validate:true}))},_validate:function(t,e){if(!e.validate||!this.validate)return true;t=i.extend({},this.attributes,t);var r=this.validationError=this.validate(t,e)||null;if(!r)return true;this.trigger("invalid",this,r,i.extend(e,{validationError:r}));return false}});var v=["keys","values","pairs","invert","pick","omit"];i.each(v,function(t){p.prototype[t]=function(){var e=o.call(arguments);e.unshift(this.attributes);return i[t].apply(i,e)}});var g=e.Collection=function(t,e){e||(e={});if(e.model)this.model=e.model;if(e.comparator!==void 0)this.comparator=e.comparator;this._reset();this.initialize.apply(this,arguments);if(t)this.reset(t,i.extend({silent:true},e))};var m={add:true,remove:true,merge:true};var y={add:true,remove:false};i.extend(g.prototype,u,{model:p,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return e.sync.apply(this,arguments)},add:function(t,e){return this.set(t,i.extend({merge:false},e,y))},remove:function(t,e){var r=!i.isArray(t);t=r?[t]:i.clone(t);e||(e={});var s,n,a,o;for(s=0,n=t.length;s<n;s++){o=t[s]=this.get(t[s]);if(!o)continue;delete this._byId[o.id];delete this._byId[o.cid];a=this.indexOf(o);this.models.splice(a,1);this.length--;if(!e.silent){e.index=a;o.trigger("remove",o,this,e)}this._removeReference(o,e)}return r?t[0]:t},set:function(t,e){e=i.defaults({},e,m);if(e.parse)t=this.parse(t,e);var r=!i.isArray(t);t=r?t?[t]:[]:i.clone(t);var s,n,a,o,h,u,l;var c=e.at;var f=this.model;var d=this.comparator&&c==null&&e.sort!==false;var v=i.isString(this.comparator)?this.comparator:null;var g=[],y=[],_={};var b=e.add,w=e.merge,x=e.remove;var E=!d&&b&&x?[]:false;for(s=0,n=t.length;s<n;s++){h=t[s]||{};if(h instanceof p){a=o=h}else{a=h[f.prototype.idAttribute||"id"]}if(u=this.get(a)){if(x)_[u.cid]=true;if(w){h=h===o?o.attributes:h;if(e.parse)h=u.parse(h,e);u.set(h,e);if(d&&!l&&u.hasChanged(v))l=true}t[s]=u}else if(b){o=t[s]=this._prepareModel(h,e);if(!o)continue;g.push(o);this._addReference(o,e)}o=u||o;if(E&&(o.isNew()||!_[o.id]))E.push(o);_[o.id]=true}if(x){for(s=0,n=this.length;s<n;++s){if(!_[(o=this.models[s]).cid])y.push(o)}if(y.length)this.remove(y,e)}if(g.length||E&&E.length){if(d)l=true;this.length+=g.length;if(c!=null){for(s=0,n=g.length;s<n;s++){this.models.splice(c+s,0,g[s])}}else{if(E)this.models.length=0;var k=E||g;for(s=0,n=k.length;s<n;s++){this.models.push(k[s])}}}if(l)this.sort({silent:true});if(!e.silent){for(s=0,n=g.length;s<n;s++){(o=g[s]).trigger("add",o,this,e)}if(l||E&&E.length)this.trigger("sort",this,e)}return r?t[0]:t},reset:function(t,e){e||(e={});for(var r=0,s=this.models.length;r<s;r++){this._removeReference(this.models[r],e)}e.previousModels=this.models;this._reset();t=this.add(t,i.extend({silent:true},e));if(!e.silent)this.trigger("reset",this,e);return t},push:function(t,e){return this.add(t,i.extend({at:this.length},e))},pop:function(t){var e=this.at(this.length-1);this.remove(e,t);return e},unshift:function(t,e){return this.add(t,i.extend({at:0},e))},shift:function(t){var e=this.at(0);this.remove(e,t);return e},slice:function(){return o.apply(this.models,arguments)},get:function(t){if(t==null)return void 0;return this._byId[t]||this._byId[t.id]||this._byId[t.cid]},at:function(t){return this.models[t]},where:function(t,e){if(i.isEmpty(t))return e?void 0:[];return this[e?"find":"filter"](function(e){for(var i in t){if(t[i]!==e.get(i))return false}return true})},findWhere:function(t){return this.where(t,true)},sort:function(t){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");t||(t={});if(i.isString(this.comparator)||this.comparator.length===1){this.models=this.sortBy(this.comparator,this)}else{this.models.sort(i.bind(this.comparator,this))}if(!t.silent)this.trigger("sort",this,t);return this},pluck:function(t){return i.invoke(this.models,"get",t)},fetch:function(t){t=t?i.clone(t):{};if(t.parse===void 0)t.parse=true;var e=t.success;var r=this;t.success=function(i){var s=t.reset?"reset":"set";r[s](i,t);if(e)e(r,i,t);r.trigger("sync",r,i,t)};q(this,t);return this.sync("read",this,t)},create:function(t,e){e=e?i.clone(e):{};if(!(t=this._prepareModel(t,e)))return false;if(!e.wait)this.add(t,e);var r=this;var s=e.success;e.success=function(t,i){if(e.wait)r.add(t,e);if(s)s(t,i,e)};t.save(null,e);return t},parse:function(t,e){return t},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0;this.models=[];this._byId={}},_prepareModel:function(t,e){if(t instanceof p)return t;e=e?i.clone(e):{};e.collection=this;var r=new this.model(t,e);if(!r.validationError)return r;this.trigger("invalid",this,r.validationError,e);return false},_addReference:function(t,e){this._byId[t.cid]=t;if(t.id!=null)this._byId[t.id]=t;if(!t.collection)t.collection=this;t.on("all",this._onModelEvent,this)},_removeReference:function(t,e){if(this===t.collection)delete t.collection;t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,i,r){if((t==="add"||t==="remove")&&i!==this)return;if(t==="destroy")this.remove(e,r);if(e&&t==="change:"+e.idAttribute){delete this._byId[e.previous(e.idAttribute)];if(e.id!=null)this._byId[e.id]=e}this.trigger.apply(this,arguments)}});var _=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain","sample"];i.each(_,function(t){g.prototype[t]=function(){var e=o.call(arguments);e.unshift(this.models);return i[t].apply(i,e)}});var b=["groupBy","countBy","sortBy","indexBy"];i.each(b,function(t){g.prototype[t]=function(e,r){var s=i.isFunction(e)?e:function(t){return t.get(e)};return i[t](this.models,s,r)}});var w=e.View=function(t){this.cid=i.uniqueId("view");t||(t={});i.extend(this,i.pick(t,E));this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()};var x=/^(\S+)\s*(.*)$/;var E=["model","collection","el","id","attributes","className","tagName","events"];i.extend(w.prototype,u,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){this.$el.remove();this.stopListening();return this},setElement:function(t,i){if(this.$el)this.undelegateEvents();this.$el=t instanceof e.$?t:e.$(t);this.el=this.$el[0];if(i!==false)this.delegateEvents();return this},delegateEvents:function(t){if(!(t||(t=i.result(this,"events"))))return this;this.undelegateEvents();for(var e in t){var r=t[e];if(!i.isFunction(r))r=this[t[e]];if(!r)continue;var s=e.match(x);var n=s[1],a=s[2];r=i.bind(r,this);n+=".delegateEvents"+this.cid;if(a===""){this.$el.on(n,r)}else{this.$el.on(n,a,r)}}return this},undelegateEvents:function(){this.$el.off(".delegateEvents"+this.cid);return this},_ensureElement:function(){if(!this.el){var t=i.extend({},i.result(this,"attributes"));if(this.id)t.id=i.result(this,"id");if(this.className)t["class"]=i.result(this,"className");var r=e.$("<"+i.result(this,"tagName")+">").attr(t);this.setElement(r,false)}else{this.setElement(i.result(this,"el"),false)}}});e.sync=function(t,r,s){var n=T[t];i.defaults(s||(s={}),{emulateHTTP:e.emulateHTTP,emulateJSON:e.emulateJSON});var a={type:n,dataType:"json"};if(!s.url){a.url=i.result(r,"url")||M()}if(s.data==null&&r&&(t==="create"||t==="update"||t==="patch")){a.contentType="application/json";a.data=JSON.stringify(s.attrs||r.toJSON(s))}if(s.emulateJSON){a.contentType="application/x-www-form-urlencoded";a.data=a.data?{model:a.data}:{}}if(s.emulateHTTP&&(n==="PUT"||n==="DELETE"||n==="PATCH")){a.type="POST";if(s.emulateJSON)a.data._method=n;var o=s.beforeSend;s.beforeSend=function(t){t.setRequestHeader("X-HTTP-Method-Override",n);if(o)return o.apply(this,arguments)}}if(a.type!=="GET"&&!s.emulateJSON){a.processData=false}if(a.type==="PATCH"&&k){a.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")}}var h=s.xhr=e.ajax(i.extend(a,s));r.trigger("request",r,h,s);return h};var k=typeof window!=="undefined"&&!!window.ActiveXObject&&!(window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent);var T={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};e.ajax=function(){return e.$.ajax.apply(e.$,arguments)};var $=e.Router=function(t){t||(t={});if(t.routes)this.routes=t.routes;this._bindRoutes();this.initialize.apply(this,arguments)};var S=/\((.*?)\)/g;var H=/(\(\?)?:\w+/g;var A=/\*\w+/g;var I=/[\-{}\[\]+?.,\\\^$|#\s]/g;i.extend($.prototype,u,{initialize:function(){},route:function(t,r,s){if(!i.isRegExp(t))t=this._routeToRegExp(t);if(i.isFunction(r)){s=r;r=""}if(!s)s=this[r];var n=this;e.history.route(t,function(i){var a=n._extractParameters(t,i);n.execute(s,a);n.trigger.apply(n,["route:"+r].concat(a));n.trigger("route",r,a);e.history.trigger("route",n,r,a)});return this},execute:function(t,e){if(t)t.apply(this,e)},navigate:function(t,i){e.history.navigate(t,i);return this},_bindRoutes:function(){if(!this.routes)return;this.routes=i.result(this,"routes");var t,e=i.keys(this.routes);while((t=e.pop())!=null){this.route(t,this.routes[t])}},_routeToRegExp:function(t){t=t.replace(I,"\\$&").replace(S,"(?:$1)?").replace(H,function(t,e){return e?t:"([^/?]+)"}).replace(A,"([^?]*?)");return new RegExp("^"+t+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(t,e){var r=t.exec(e).slice(1);return i.map(r,function(t,e){if(e===r.length-1)return t||null;return t?decodeURIComponent(t):null})}});var N=e.History=function(){this.handlers=[];i.bindAll(this,"checkUrl");if(typeof window!=="undefined"){this.location=window.location;this.history=window.history}};var R=/^[#\/]|\s+$/g;var O=/^\/+|\/+$/g;var P=/msie [\w.]+/;var C=/\/$/;var j=/#.*$/;N.started=false;i.extend(N.prototype,u,{interval:50,atRoot:function(){return this.location.pathname.replace(/[^\/]$/,"$&/")===this.root},getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getFragment:function(t,e){if(t==null){if(this._hasPushState||!this._wantsHashChange||e){t=decodeURI(this.location.pathname+this.location.search);var i=this.root.replace(C,"");if(!t.indexOf(i))t=t.slice(i.length)}else{t=this.getHash()}}return t.replace(R,"")},start:function(t){if(N.started)throw new Error("Backbone.history has already been started");N.started=true;this.options=i.extend({root:"/"},this.options,t);this.root=this.options.root;this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var r=this.getFragment();var s=document.documentMode;var n=P.exec(navigator.userAgent.toLowerCase())&&(!s||s<=7);this.root=("/"+this.root+"/").replace(O,"/");if(n&&this._wantsHashChange){var a=e.$('<iframe src="javascript:0" tabindex="-1">');this.iframe=a.hide().appendTo("body")[0].contentWindow;this.navigate(r)}if(this._hasPushState){e.$(window).on("popstate",this.checkUrl)}else if(this._wantsHashChange&&"onhashchange"in window&&!n){e.$(window).on("hashchange",this.checkUrl)}else if(this._wantsHashChange){this._checkUrlInterval=setInterval(this.checkUrl,this.interval)}this.fragment=r;var o=this.location;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot()){this.fragment=this.getFragment(null,true);this.location.replace(this.root+"#"+this.fragment);return true}else if(this._hasPushState&&this.atRoot()&&o.hash){this.fragment=this.getHash().replace(R,"");this.history.replaceState({},document.title,this.root+this.fragment)}}if(!this.options.silent)return this.loadUrl()},stop:function(){e.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl);if(this._checkUrlInterval)clearInterval(this._checkUrlInterval);N.started=false},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(t){var e=this.getFragment();if(e===this.fragment&&this.iframe){e=this.getFragment(this.getHash(this.iframe))}if(e===this.fragment)return false;if(this.iframe)this.navigate(e);this.loadUrl()},loadUrl:function(t){t=this.fragment=this.getFragment(t);return i.any(this.handlers,function(e){if(e.route.test(t)){e.callback(t);return true}})},navigate:function(t,e){if(!N.started)return false;if(!e||e===true)e={trigger:!!e};var i=this.root+(t=this.getFragment(t||""));t=t.replace(j,"");if(this.fragment===t)return;this.fragment=t;if(t===""&&i!=="/")i=i.slice(0,-1);if(this._hasPushState){this.history[e.replace?"replaceState":"pushState"]({},document.title,i)}else if(this._wantsHashChange){this._updateHash(this.location,t,e.replace);if(this.iframe&&t!==this.getFragment(this.getHash(this.iframe))){if(!e.replace)this.iframe.document.open().close();this._updateHash(this.iframe.location,t,e.replace)}}else{return this.location.assign(i)}if(e.trigger)return this.loadUrl(t)},_updateHash:function(t,e,i){if(i){var r=t.href.replace(/(javascript:|#).*$/,"");t.replace(r+"#"+e)}else{t.hash="#"+e}}});e.history=new N;var U=function(t,e){var r=this;var s;if(t&&i.has(t,"constructor")){s=t.constructor}else{s=function(){return r.apply(this,arguments)}}i.extend(s,r,e);var n=function(){this.constructor=s};n.prototype=r.prototype;s.prototype=new n;if(t)i.extend(s.prototype,t);s.__super__=r.prototype;return s};p.extend=g.extend=$.extend=w.extend=N.extend=U;var M=function(){throw new Error('A "url" property or function must be specified')};var q=function(t,e){var i=e.error;e.error=function(r){if(i)i(t,r,e);t.trigger("error",t,r,e)}};return e});
/*globals define, console */
define('modules/errors/common',['modules/breakpoint', 'modules/common', 'modules/overlay/common'], function (breakpoint, common, overlay) {
    'use strict';

    var self = {}, showVirtualPage, showModalDialog, displayMessage;

    showVirtualPage = function showVirtualPage(params) {
        common.virtualPage.show(params);
    };

    showModalDialog = function showModalDialog(params) {
        overlay.show(params);
    };

    displayMessage = function displayMessage(message) {
        var config = {
            content: message,
            showBack: true,
            customClass: 'custom-class'
        };

        if (breakpoint.mobile) {
            showVirtualPage(config);
        } else {
            showModalDialog(config);
        }
    };

    /* Public methods */
    self.handle = function handle(errorObject) {
        var errorDescription, errorStatus,
            errorMessage = errorObject.message || 'An unknown error occured.';

        if (errorObject.public) {
            displayMessage(errorMessage);
        } else if (errorObject.details) {
            errorDescription = errorObject.details.statusText || 'unknown';
            errorStatus = (errorObject.details.status) ? ' (' + errorObject.details.status + ')' : '';
            console.warn(errorMessage);
            console.info('[AJAX] Error details: ' + errorDescription + errorStatus);
        }

    };

    return self;

});
/*jslint regexp: true, nomen: true */
/*globals window,document,console,define,require,jQuery */
define('modules/ajax/common', ['domlib', 'modules/errors/common', 'modules/settings/common'], function ($, errorsModule, SETTINGS) {
    'use strict';
    /**
    * The mvAPI Framework
    * @version 1.1.02
    * @exports ajax
    * @namespace AJAX
    */
    var self = {},
        isExecuting = false,
        ajaxQueue = [],
        maxQueueLength = 100,
        isValidJsonString = function isValidJsonString(str) {
            var isValid = false;
            if (/^[\],:{}\s]*$/.test(str.replace(/\\["\\\/bfnrtu]/g, '@').replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, ']').replace(/(?:^|:|,)(?:\s*\[)+/g, ''))) {
                isValid = true;
            }
            return isValid;
        },
        handleAtg = function handleAtg(params) {
            var id = params.id || null,
                sourceObject = params.sourceObject || null,
                updateModel = (params.actions && params.actions.updateModel) ? params.actions.updateModel : null;

            return updateModel(id, sourceObject);
        },
        executeRequest = function executeRequest(params) {
            isExecuting = true;
            $.ajax({
                url: params.url,
                data: params.data || '',
                type: params.type || 'GET',
                async: params.async || 'true',
                dataType: params.dataType || 'html',
                contentType: params.contentType || 'application/x-www-form-urlencoded; charset=UTF-8',
                success: params.callbacks.success,
                error: params.callbacks.error,
                complete: params.callbacks.complete
            });
        },
        processAjaxQueue = function processAjaxQueue() {
            if (ajaxQueue.length) {
                executeRequest(ajaxQueue.shift());
            }
        },
        handleHeader = function handleHeader(data) {
            if (isValidJsonString(data) && self.handleAtgResponseHeader) {
                self.handleAtgResponseHeader(JSON.parse(data));
            }
        },
        extendSuccessCallback = function extendSuccessCallback(callback) {
            var callbackBeforeExtension = callback,
                callbackAfterExtension = function callbackAfterExtension(data) {
                    callbackBeforeExtension.apply(this, arguments);
                    handleHeader(data);
                };
            return callbackAfterExtension;
        },
        sendRequest = function sendRequest(params) {
            var errorDetails = {},
                callbacks = {
                    success: (params.callbacks && params.callbacks.success) ? extendSuccessCallback(params.callbacks.success) : function (data) {
                        console.log('[AJAX] Request successful.', data);
                    },
                    error: (params.callbacks && params.callbacks.error) ? params.callbacks.error : function (error) {
                        errorDetails.message = error.message || '[AJAX] Request failed.';
                        errorsModule.handle(errorDetails);
                    },
                    complete: function () {
                        isExecuting = false;
                        if (params.callbacks.userComplete) {
                            params.callbacks.userComplete();
                        }
                        processAjaxQueue();
                    },
                    userComplete: (params.callbacks && params.callbacks.complete) ? params.callbacks.complete : null
                };

            params.callbacks = callbacks;

            params.url = params.url || SETTINGS.CONSTANTS.URL.GENERIC.TEST_DATA_ENDPOINT;

            if (ajaxQueue.length <= maxQueueLength && isExecuting) {
                ajaxQueue.push(params);
            } else {
                executeRequest(params);
            }

        },
        AjaxDataLayer = function AjaxDataLayer() {
            if (AjaxDataLayer.prototype._singletonInstance) {
                return AjaxDataLayer.prototype._singletonInstance;
            }
            AjaxDataLayer.prototype._singletonInstance = self;
            return AjaxDataLayer.prototype._singletonInstance;
        };

    self = {
        /**
        * @method get
        * @memberof AJAX
        * @param {object} params - An AJAX request related parameters
        *    @param {string} [params.url] - Request URL to a service | If not provided, no AJAX request will be send
        *    @param {object} [params.data] - Request data to be send to a service | If not provided, an empty JSON object will be send
        *    @param {bool} [params.async] - States if request should be sent asynchronously | True by default
        *    @param {string} [params.dataType] - States what type of data to expect from service | If not provided, type of 'html' will be expected
        *    @param {string} [params.contentType] - States what type of data is being send to a service | If not provided, type of 'application/x-www-form-urlencoded; charset=UTF-8' will be set
        *    @param {object} [params.callbacks] - Response callbacks, possible values: success, error
        *        @param {callback} [params.callbacks.success] - A method to be invoked after receiving success response from a service
        *        @param {callback} [params.callbacks.error] - A method to be invoked after receiving error response from a service
        */
        get: function get(params) {
            params.type = "GET";
            sendRequest(params);
        },
        /**
        * @method post
        * @memberof AJAX
        * @param {object} params - An AJAX request related parameters
        *    @param {string} [params.url] - Request URL to a service | If not provided, no AJAX request will be send
        *    @param {object} [params.data] - Request data to be send to a service | If not provided, an empty JSON object will be send
        *    @param {bool} [params.async] - States if request should be sent asynchronously | True by default
        *    @param {string} [params.dataType] - States what type of data to expect from service | If not provided, type of 'html' will be expected
        *    @param {string} [params.contentType] - States what type of data is being send to a service | If not provided, type of 'application/x-www-form-urlencoded; charset=UTF-8' will be set
        *    @param {object} [params.callbacks] - Response callbacks, possible values: success, error
        *        @param {callback} [params.callbacks.success] - A method to be invoked after receiving success response from a service
        *        @param {callback} [params.callbacks.error] - A method to be invoked after receiving error response from a service
        */
        post: function post(params) {
            params.type = "POST";
            sendRequest(params);
        },
        /**
        * @method handleAtg
        * @memberof AJAX
        * @param {object} params
        */
        handleAtg: handleAtg
    };

    //Exposing public methods
    return new AjaxDataLayer();
});
/*jslint plusplus: true, nomen: true, indent: 4 */
/*globals window,document,console,define */
define('modules/chip-and-pin/atg-data', ['domlib'], function ($) {
    'use strict';
    var self = {},
        parseATGFieldValues = function parseATGFieldValues(data, $inputFields) {
            var i, $elem, elem_val,
                inputFieldsLength = $inputFields.length;

            for (i = 0; i < inputFieldsLength; i++) {
                $elem = $inputFields.eq(i);
                elem_val = $elem.val();

                if ($elem.data('field')) {
                    if (!data.defaults) {
                        data.defaults = {};
                    }
                    data.defaults[$elem.data('field')] = elem_val;
                } else {
                    data.atgData[$elem.prop('name')] = elem_val;
                }
            }
            return data;
        },
        parse = function parse(param) {
            var data = {
                    atgData: {}
                },
                formString = param.atgData || param,
                $inputHiddenFields = $(formString).find('input[type="hidden"]'),
                $inputFields = $(formString).find('input[type="text"]');

            data = parseATGFieldValues(data, $inputHiddenFields);
            data = parseATGFieldValues(data, $inputFields);

            return data;
        };

    self.handleForms = function handleForms(object, callback) {
        var x, $forms, formsLength, formName, data;

        if (object && typeof object === 'string') {
            object = JSON.parse(object);
        }

        $forms = $(object.atgData);
        formsLength = $forms.length;

        if (formsLength) {
            for (x = 0; x < formsLength; x++) {
                formName = $forms[x].name;
                data = parse($forms[x]);
                if (callback && typeof callback === 'function') {
                    callback(formName, data);
                }
            }
        }

        return object;
    };

    self.parse = parse;

    return self;
});
/*globals window,document,console,define */
/*jslint regexp: true, plusplus: true */
define('modules/mvapi/models', ['domlib', 'modules/settings/common', 'backbone', 'modules/ajax/common', 'modules/errors/common', 'modules/chip-and-pin/atg-data'], function ($, SETTINGS, Backbone, ajax, errorsModule, atg) {
    'use strict';

    var getAll, saveAll, update, cacheInitials, reset, atgStringParsed,
        MODELS = {},
        INIT_MODELS = {},
        isArray = function isArray(element) {
            return Object.prototype.toString.call(element) === '[object Array]';
        },
        getData = function getData(params, render) {

            var dataRequestParams = {
                url: (params.request && params.request.url) ? params.request.url : SETTINGS.CONSTANTS.URL.KIOSK_DATA,
                data: (params.request && params.request.data) ? params.request.data : {},
                callbacks: {
                    success: function success(response) {
                        var item, key;

                        if (response) {
                            response = JSON.parse(response);
                            console.log('[mvAPI] Received data from service', response);

                            if (isArray(response)) {
                                params.collection = params.collection || {};
                                params.collection.items = response;
                                render(params);
                            } else {
                                for (item in response) {
                                    if (response.hasOwnProperty(item)) {
                                        if (item === "atgData") {
                                            atgStringParsed = atg.parse(response);
                                            if (atgStringParsed.defaults) {
                                                for (key in atgStringParsed.defaults) {
                                                    if (atgStringParsed.defaults.hasOwnProperty(key)) {
                                                        params.defaults[key] = atgStringParsed.defaults[key];
                                                    }
                                                }
                                            }
                                            if (atgStringParsed.atgData) {
                                                params.atgData = atgStringParsed.atgData;
                                            }

                                        } else {
                                            params.defaults[item] = response[item];
                                        }
                                    }
                                }
                                render(params);
                            }
                        }

                        if (params.request && params.request.callbacks && params.request.callbacks.success) {
                            params.request.callbacks.success(response);
                        }

                        if (params.callback) {
                            params.callback(response);
                        }

                    },
                    error: function error(errorData) {

                        var errorDetails = {
                            'message': '[mvAPI] AJAX Error while requesting data from service, rendering defaults',
                            'public': false,
                            'details': errorData
                        };

                        errorsModule.handle(errorDetails);

                        if (params.request && params.request.callbacks && params.request.callbacks.error) {
                            params.request.callbacks.error();
                        }

                        render(params);
                    }
                }
            };

            if (params.request) {
                ajax.post(dataRequestParams);
            } else {
                render(params);
                if (params.callback) {
                    params.callback();
                }
            }
        };

    getAll = function getAll() {
        return MODELS;
    };

    saveAll = function saveAll(models) {
        if (models && typeof models === 'object') {
            MODELS = models;
        }
    };

    cacheInitials = function cacheInitials(models) {
        var key;
        if (models && typeof models === 'object') {
            for (key in models) {
                if (models.hasOwnProperty(key) && !INIT_MODELS[key]) {
                    INIT_MODELS[key] = models[key];
                }
            }
        }
    };

    update = function update(id, sourceObject) {
        var key, model = (id && MODELS[id] && sourceObject && typeof sourceObject === 'object') ? MODELS[id] : null;
        if (model) {
            if (sourceObject.atgData && typeof sourceObject.atgData === 'string') {
                atgStringParsed = atg.parse(sourceObject);
                if (atgStringParsed && atgStringParsed.defaults) {
                    for (key in atgStringParsed.defaults) {
                        if (atgStringParsed.defaults.hasOwnProperty(key)) {
                            MODELS[id].defaults[key] = atgStringParsed.defaults[key];
                        }
                    }
                }
                if (atgStringParsed && atgStringParsed.atgData) {
                    MODELS[id].atgData = atgStringParsed.atgData;
                }
            } else {
                $.extend(true, MODELS[id], sourceObject);
            }
        }
        return MODELS[id];
    };

    reset = function reset(id) {
        var model = MODELS[id],
            init_model = INIT_MODELS[id];
        if (model && init_model) {
            MODELS[id] = {};
            $.extend(true, MODELS[id], init_model);
        } else {
            console.warn('[mvApi] No model or initial model found for reset operation, aborting...');
        }

        return MODELS[id];
    };

    return {
        getData: getData,
        getAll: getAll,
        saveAll: saveAll,
        cacheInitials: cacheInitials,
        update: update,
        reset: reset,
        create: function get(params) {
            var Model = Backbone.Model.extend({
                defaults: function () {
                    return params;
                }
            });
            return new Model();
        }
    };
});
/*jslint plusplus: true, regexp: true, nomen: true */
/*globals window,document,console,define,require,jQuery,Backbone,_ */
define('modules/mvapi/views', ['domlib', 'modules/mvapi/models'], function ($, models) {
    'use strict';
    var self, render, renderCollectionItem, renderItem, preparePlaceholder, addPlaceholder, nestedCollections = [], numberOfNestedCollections, renderNestedCollection;

    addPlaceholder = function addPlaceholder(placeholderClass, target) {
        var container = target ? '.' + target : '#wrapper';
        jQuery(container).append('<div class="' + placeholderClass + '"></div>');
    };

    preparePlaceholder = function preparePlaceholder(params) {
        var placeholderClass = params.placeholderClass || params.templateId;

        if (!jQuery('.' + placeholderClass).length && !params.preload) {
            addPlaceholder(placeholderClass, params.target);
        }
        return jQuery("." + placeholderClass);
    };

    renderNestedCollection = function renderNestedCollection(nestedCollection) {
        var templateHtml, NestedItemsCollectionConstructor, NestedItemsViewConstructor, NestedSingleItemViewConstructor, nestedAllItemsCollection, nestedAllItemsView,
            nestedModels = [],
            params = nestedCollection.model;

        params.collection.items = nestedCollection.items;
        params.placeholderClass = nestedCollection.placeholderClass;

        templateHtml = jQuery("#" + params.templateId).html();

        nestedModels.push(Backbone.Model.extend(params));

        NestedItemsCollectionConstructor = Backbone.Collection.extend({
            model: nestedModels[nestedModels.length - 1]
        });

        NestedItemsViewConstructor = Backbone.View.extend({
            el: $('.' + params.placeholderClass),
            render: function () {
                this.collection.each(function (itemModel) {
                    var nestedItemView = new NestedSingleItemViewConstructor({ model: itemModel });
                    this.$el.append(nestedItemView.render().el);
                }, this);
            }
        });

        NestedSingleItemViewConstructor = Backbone.View.extend({
            tagName: params.collection.tagName || 'div',
            render: function () {
                this.$el.html(_.template(templateHtml, this.model.toJSON()));
                return this;
            }
        });

        nestedAllItemsCollection = new NestedItemsCollectionConstructor(params.collection.items);
        nestedAllItemsView = new NestedItemsViewConstructor({ collection: nestedAllItemsCollection });

        nestedCollections.push(nestedAllItemsView);
        numberOfNestedCollections = nestedCollections.length;

        return nestedAllItemsView;
    };

    /**
    * Required and optional params the same as for mvapi.render
    */
    renderCollectionItem = function renderCollectionItem(params) {
        var Model, ItemsCollectionConstructor, ItemsViewConstructor, SingleItemViewConstructor,
            allItemsCollection, allItemsView,
            $placeholder = preparePlaceholder(params),
            templateHtml = jQuery("#" + params.templateId).html();

        Model = Backbone.Model.extend(params);

        if (params.collection.emptyParent) {
            $placeholder.empty();
        }

        ItemsCollectionConstructor = Backbone.Collection.extend({
            model: Model
        });

        SingleItemViewConstructor = Backbone.View.extend({
            tagName: params.collection.tagName || 'div',
            render: function () {
                var model = this.model.toJSON();
                this.$el.html(_.template(templateHtml, model));
                return this;
            }
        });

        ItemsViewConstructor = Backbone.View.extend({
            el: $placeholder,
            initialize: function () {
                var x;

                this.collection.each(function (itemModel) {
                    var itemView = new SingleItemViewConstructor({ model: itemModel });
                    this.$el.append(itemView.render().el);

                    if (itemModel.attributes.nestedCollection) {
                        renderNestedCollection(itemModel.attributes.nestedCollection);
                    }
                }, this);

                if (numberOfNestedCollections) {
                    for (x = 0; x < numberOfNestedCollections; x++) {
                        nestedCollections[x].render();
                    }
                }
                nestedCollections = [];
                numberOfNestedCollections = nestedCollections.length;
            }
        });

        if (params.collection.items) {
            allItemsCollection = new ItemsCollectionConstructor(params.collection.items);
        } else {
            allItemsCollection = new ItemsCollectionConstructor(params.defaults);
        }

        allItemsView = new ItemsViewConstructor({ collection: allItemsCollection });

        return allItemsView;
    };

    /**
    * Required and optional params the same as for mvapi.render
    */
    renderItem = function (params) {
        var $itemPlaceholder = preparePlaceholder(params),
            templateHtml = jQuery("#" + params.templateId).html(),
            ItemView = Backbone.View.extend({
                el: $itemPlaceholder,
                initialize: function () {
                    this.render(params);
                },
                render: function (params) {
                    if (params.injectType === 'append') {
                        this.$el.append(_.template(templateHtml, this.model.toJSON()));
                    } else if (params.injectType === 'prepend') {
                        this.$el.prepend(_.template(templateHtml, this.model.toJSON()));
                    } else {
                        this.$el.html(_.template(templateHtml, this.model.toJSON()));
                    }
                    $itemPlaceholder.show();
                    return this;
                }
            });

        return new ItemView({ model: models.create(params.defaults) });
    };

    /**
    * Required and optional params the same as for mvapi.render
    */
    render = function render(params) {
        if (params.collection) {
            renderCollectionItem(params);
        } else {
            renderItem(params);
        }
    };

    //Exposing public API
    self = {
        render: render
    };

    return self;
});
/*jslint plusplus: true, regexp: true, nomen: true */
/*globals window,document,console,define */
define('modules/mvapi/router', ['backbone'], function (Backbone) {
    'use strict';

    var init, router, Router, lockId, getCurrentSection, setCurrentSection, currentSection;

    init = function init(routerData) {

        Router = Backbone.Router.extend(routerData);
        router = new Router();

        lockId = routerData.actions.lockOnRoute || null;

        router.on('route:defaultRoute', function (id) {

            if (id && routerData.actions[id]) {
                routerData.actions[id]();
            }

            if (lockId && id === lockId) {
                //Backbone.history.stop();
                /*
                if (window.external && window.external.navigationPanel) {
                    window.external.navigationPanel.backEnabled = false;
                }*/
            }

        });

        Backbone.history.start();
        console.log('[mvApi] Router initialized.');

        return router;
    };

    getCurrentSection = function getCurrentSection() {
        return currentSection;
    };

    setCurrentSection = function setCurrentSection(id) {
        currentSection = id;
    };

    return {
        init: init,
        getCurrentSection: getCurrentSection,
        setCurrentSection: setCurrentSection
    };

});
/*globals window,document,console,define,require */
/*jslint plusplus: true, regexp: true */

define('modules/mvapi/common', ['domlib', 'modules/settings/common', 'modules/mvapi/views', 'modules/mvapi/models', 'modules/mvapi/router', 'modules/ajax/common', 'modules/tesco.analytics'], function ($, SETTINGS, views, models, router, ajax, analytics) {
    'use strict';
    /**
    * The mvApi Framework
    * @version 1.0.11
    * @exports mvapi
    * @namespace mvApi
    */
    var render, navigateTo, getModel, updateModel, checkTemplateExists, loadTemplate, addTemplateToDOM, prepareView, prepareModel, cacheInitialModels, cacheSessionData, mergeModels, checkType, preloadMasterTemplate, registerRoutes, resetModel, getCurrentSection, returnedRouter, subscribe, unsubscribe, publish, o = $({}),
        SESSION = {},
        ROUTER_DATA = {
            routes: {
                "*actions": "defaultRoute"
            },
            actions: {}
        };

    //** Temporary solution due to current Kiosk back button technical limitations - START **/

    /*jslint unparam: true*/ //Due to temporary solution
    navigateTo = function navigateTo(route, replaceHistoryEntry, triggerAction) {
        var trigger = (triggerAction === false) ? false : true;
        if (route === 'login' || route === 'delivery' || route === 'review' || route === 'payment') {
            returnedRouter.navigate(route, { trigger: trigger });
            if (trigger) {
                router.setCurrentSection(route);
            }
        } else {
            if (ROUTER_DATA.actions[route]) {
                ROUTER_DATA.actions[route]();
            }
        }
    };
    /*jslint unparam: false*/

    //navigateTo = function navigateTo(route, replaceHistoryEntry, triggerAction) {
    //    var trigger = (triggerAction === false) ? false : true,
    //        replace = replaceHistoryEntry || false;
    //    returnedRouter.navigate(route, { trigger: trigger, replace: replace });
    //    if (trigger) {
    //        router.setCurrentSection(route);
    //    }
    //};

    //** Temporary solution due to current Kiosk back button technical limitations - END **/

    registerRoutes = function registerRoutes(routes) {
        var id;
        for (id in routes) {
            if (routes.hasOwnProperty(id)) {
                ROUTER_DATA.actions[id] = routes[id];
            }
        }
        returnedRouter = router.init(ROUTER_DATA);
    };

    getCurrentSection = function getCurrentSection() {
        return router.getCurrentSection();
    };

    checkType = function checkType(functionToCheck) {
        var getType = {}, type;

        if (functionToCheck && getType.toString.call(functionToCheck) === '[object Function]') {
            type = 'callback';
        } else if (functionToCheck && getType.toString.call(functionToCheck) === '[object Object]') {
            type = 'model';
        } else {
            type = null;
        }

        return type;
    };

    prepareModel = function prepareModel(modelId, paramOne, paramTwo) {
        var modelChange, callback, MODELS = models.getAll();

        if (checkType(paramOne) === 'model') {
            modelChange = paramOne;
        } else if (checkType(paramTwo) === 'model') {
            modelChange = paramTwo;
        }

        if (checkType(paramOne) === 'callback') {
            callback = paramOne;
        } else if (checkType(paramTwo) === 'callback') {
            callback = paramTwo;
        }

        if (modelChange) {
            if (MODELS[modelId].request) {
                delete MODELS[modelId].request.data;
            }

            $.extend(true, MODELS[modelId], modelChange);

            if (!modelChange.request && MODELS[modelId] && MODELS[modelId].request) {
                delete MODELS[modelId].request;
            }

            if (modelChange.request && !modelChange.request.callbacks && MODELS[modelId] && MODELS[modelId].request && MODELS[modelId].request.callbacks) {
                delete MODELS[modelId].request.callbacks;
            }
        }

        if (MODELS[modelId] && callback) {
            MODELS[modelId].callback = callback;
        } else if (MODELS[modelId] && MODELS[modelId].callback) {
            delete MODELS[modelId].callback;
        }

        models.saveAll(MODELS);

        return MODELS[modelId];
    };

    addTemplateToDOM = function addTemplateToDOM(id, html) {
        var script = document.createElement('script');
        script.type = 'text/template';
        script.id = id;
        $('body').append(script);
        $('#' + id).empty().html(html);
    };

    checkTemplateExists = function checkTemplateExists(templateId) {
        return document.getElementById(templateId);
    };

    prepareView = function renderView(params) {
        if (params.request && params.request.data && params.request.data.session) {
            $.extend(true, params.request.data, SESSION);
            delete params.request.data.session;
        }
        models.getData(params, views.render);
    };

    loadTemplate = function loadTemplate(params) {
        var id = params.templateId,
            section = params.section,
            ajaxParams = {
                url: SETTINGS.CONSTANTS.URL.GENERIC.MVAPI_TEMPLATES_PATH + section + '/' + id + '.html',
                dataType: 'html',
                callbacks: {
                    success: function (html) {
                        console.log('[mvApi] Template "' + id + '" loaded.');
                        addTemplateToDOM(id, html);
                        prepareView(params);
                        return true;
                    },
                    error: function (error) {
                        console.warn('[mvApi] Error during loading template "' + id + '". Aborting...');
                        console.log('[mvApi] Error details: "' + error);
                        return false;
                    }
                }
            };
        console.log('[mvApi] Template "' + id + '" doesn\'t exist, loading...');

        ajax.get(ajaxParams);

    };

    preloadMasterTemplate = function preloadMasterTemplate(params) {
        var filename = params.filename,
            section = params.section,
            proceed = function () {
                if (params.callback) {
                    params.callback();
                }
            },
            ajaxParams = {
                url: SETTINGS.CONSTANTS.URL.GENERIC.MVAPI_TEMPLATES_PATH + section + '/master/' + filename + '.html',
                dataType: 'html',
                callbacks: {
                    success: function (html) {
                        console.log('[mvApi] Master template "' + filename + '" loaded.');
                        if (!$('#' + filename + '_master').length) {
                            $('body').append('<div id="' + filename + '_master"></div>');
                        }
                        $('#' + filename + "_master").html(html);
                        proceed();
                        return true;
                    },
                    error: function () {
                        console.warn('[mvApi] Loading master template "' + filename + '" failed. Proceeding with single templates.');
                        proceed();
                        return false;
                    }
                }
            };

        ajax.get(ajaxParams);
    };

    render = function (modelId, modelChange, callback) {

        var masterDetails,
            params = prepareModel(modelId, modelChange, callback),
            renderTemplate = function renderTemplate() {
                if (params && params.templateId) {
                    if (checkTemplateExists(params.templateId)) {
                        prepareView(params);
                    } else {
                        loadTemplate(params);
                    }
                } else {
                    console.warn('[mvApi] Missing required templateId parameter. Aborting...');
                }
                
                if (modelChange && modelChange.defaults && modelChange.defaults.analytics) {
					var _oWebAnalytics = new analytics.WebMetrics(),
						_webAnalyticsVar = modelChange.defaults.analytics;

					_oWebAnalytics.submit(_webAnalyticsVar);
                }
            };

        if (params && params.master && !$('#' + params.master + '_master').length) {
            masterDetails = {
                'filename': params.master,
                'section': params.section,
                'callback': renderTemplate
            };
            preloadMasterTemplate(masterDetails);
        } else {
            renderTemplate();
        }

    };

    cacheSessionData = function cacheSessionData(sessionData) {
        if (sessionData) {
            $.extend(true, SESSION, sessionData);
        }
    };

    cacheInitialModels = function cacheInitialModels(initialModels) {
        var MODELS = models.getAll();
        if (initialModels) {
            $.extend(true, MODELS, initialModels);
        }
        models.saveAll(MODELS);
        models.cacheInitials(MODELS);
    };

    mergeModels = function mergeModels(sourceModelId, targetModelId) {
        var warningDetails,
            modelsMergedStatus = false,
            MODELS = models.getAll(),
            sourceModel = MODELS[sourceModelId],
            targetModel = MODELS[targetModelId];

        if (sourceModel && sourceModel.defaults && targetModel) {
            $.extend(true, MODELS[targetModelId].defaults, MODELS[sourceModelId].defaults);
            modelsMergedStatus = true;
        } else {
            console.warn('[mvApi] An attempt to merge models failed. Aborting...');
            warningDetails = (!sourceModel) ? 'No source model with id ' + sourceModelId + ' found or model has no defaults.' : 'No target model with id ' + targetModelId + ' found.';
            console.log('[mvApi]' + warningDetails);
        }
        models.saveAll(MODELS);
        return modelsMergedStatus;
    };

    getModel = function getModel(id) {
        var model, MODELS = models.getAll();
        if (id && MODELS[id]) {
            model = MODELS[id];
        } else {
            model = null;
        }
        return model;
    };

    updateModel = function updateModel(id, sourceObject) {
        return models.update(id, sourceObject);
    };

    resetModel = function resetModel(id) {
        return models.reset(id);
    };

    subscribe = function subscribe() {
        o.on.apply(o, arguments);
    };

    unsubscribe = function unsubscribe() {
        o.off.apply(o, arguments);
    };

    publish = function publish() {
        o.trigger.apply(o, arguments);
    };
   
    return {
        /**
        * @method render
        * @memberof mvApi
        * @param {string} modelId - A model id to be loaded from the cached MODELS object.
        * @param {object} [modelChange] - An object containing changes to the model. The cached MODELS object will be extended by this param.
        * @param {callback} [callback] - A callback to be invoked after rendering the model
        * @example
        * Please note the sequence of the optional params provided (model change or callback) is not mandatory.
        * The 'mvApi' recognizes the type of paramater provided and uses them accordingly.
        *
        * So you can do either one of the following:
        * 'mvApi.render(id)'
        * 'mvApi.render(id, modelChange)'
        * 'mvApi.render(id, modelChange, callback)'
        * 'mvApi.render(id, callback)'
        * 'mvApi.render(id, callback, modelChange)'
        */
        render: render,
        /**
        * @method cacheInitialModels
        * @memberof mvApi
        * @param {object} initialModels - a set of initial data for models provided by section using mvApi each of these models is a set of required and optional parameters:
        *    @param {string} initialModels.templateId - A template id that corresponds to a name of html file under 'mvapi/templates/section_name' path        
        *    @param {string} initialModels.section - A section name that corresponds to a name of subfolder in 'mvapi/templates/section_name' path
        *    @param {string} [initialModels.master] - A master template file name that corresponds to a name of html file under 'mvapi/templates/section_name/master' path
        *    @param {string} [initialModels.placeholderClass] - A class of a wrapper around template content | If not provided, will be generated from templateId by default
        *    @param {string} [initialModels.injectType] - Defines a way the single item template will be injected to its placeholder. Possible options: append, prepend | If not provided, the template content will replace existing content
        *    @param {string} [initialModels.target] - A class of parent element in DOM where template placeholder will be appended into | If not provided, template will be appended to #wrapper by default
        *    @param {object} [initialModels.collection] - An object containing addtional data for rendering collection of items based on the same model instead of single item
        *        @param {string} [initialModels.collection.tagName] - An HTML tag name specifying parent element that will be a wrapper around template content, before injecting it to DOM | If not provided, a 'div' tag will be used
        *        @param {array} [initialModels.collection.items] - An array containing objects (models) being used by each item in the collection (framework will display as many items in the collection, as many of them have been defined in 'items') | If not provided, just one item with 'defaults' will be displayed
        *        @param {bool} [initialModels.collection.emptyParent] - A boolean stating if placeholder should be empty before each collection view rendering
        *    @param {object} [initialModels.request] - States if template rendering needs external data request | If {object}, it can contain further params:
        *        @param {string} [initialModels.request.url] - A custom url to a service where data should be requested from | If not provided, an url provided in SETTINGS.CONSTANTS will be used by default
        *        @param {object} [initialModels.request.data] - An object containing data to be sent to the service, so it can respond accordingly | If not provided, an empty object will be send
        *        @param {array} [initialModels.request.session] - An array containing key(s) of session data to be sent to the service | These keys and appropriate session data should be previously stored in mvApi with cacheSessionData method
        *        @param {object} [initialModels.request.callbacks] - An object containing two callback methods:
        *            @param {callback} [initialModels.request.callbacks.success] - A method to be invoked after receiving a successful response from a service
        *            @param {callback} [initialModels.request.callbacks.error] - A method to be invoked after receiving an error response from a service
        *    @param {object} [initialModels.defaults] - An object containing default values for the template variables
        *    @param {callback} [initialModels.callback] - A method that should be called after template is successfully rendered
        */
        cacheInitialModels: cacheInitialModels,
        /**
        * @method cacheSessionData
        * @memberof mvApi
        * @param {object} params - a nested set of key + value pairs that can be send out with every AJAX request, they should contain the following parameters:
        *    @param {string} params.id - An id of the data storage in cache.
        *    @param {object} params.data - A data object that should be stored in cache under the id provided.
        */
        cacheSessionData: cacheSessionData,
        /**
        * @method mergeModels
        * @memberof mvApi
        * @param {string} sourceModelId - An id of the model the defaults will be taken from.
        * @param {string} targetModelId - An id of the model the defaults will be applied to.
        */
        mergeModels: mergeModels,
        /**
        * @method registerRoutes
        * @memberof mvApi
        * @param {object} routes - a set of key + value pairs containing the following parameters:
        *    @param {string} routes.id - An id of the section that the action provided should be registered at and routed from.
        *    @param {method} routes.action - An action that should be invoked for the '#id' route.
        */
        registerRoutes: registerRoutes,
        /**
        * @method navigateTo
        * @memberof mvApi
        * @param {string} route - A page id that the site should be routed to.
        * @param {bool} [replaceHistoryEntry] - States if current route should replace previous entry in browser's history.
        * @param {bool} [triggerAction] - Allows to explicitly turn off action triggering for route | It is set to true by default.
        */
        navigateTo: navigateTo,
        /**
        * @method getModel
        * @memberof mvApi
        * @param {string} id - An id of the model that should be returned.        
        */
        getModel: getModel,
        /**
        * @method updateModel
        * @memberof mvApi
        * @param {string} id - An id of the model that should be updated.        
        * @param {object} sourceObject - An object that model should be updated from.
        */
        updateModel: updateModel,
        /**
        * @method resetModel
        * @memberof mvApi
        * @param {string} id - An id of the model that should be reset to its initial state.
        */
        resetModel: resetModel,
        /**
         * @method getCurrentSection
         * @memberof mvApi
         * @returns {string}
         */
        getCurrentSection: getCurrentSection,
        subscribe: subscribe,
        unsubscribe: unsubscribe,
        publish: publish
    };
});
/*globals window,document,console,define,require */
/*jslint plusplus: true, regexp: true, indent: 4 */
define('modules/chip-and-pin/user-session', ['modules/mvapi/common'], function (mvapi) {
    'use strict';
    var bCanScanVoucher = false,
        bCanScanClubcard = false,
        bCanScanEcoupon = false,
        bCanScanGiftcard = false,
        bCanEditEmail = false,
        iAgeRestriction = null,
        bRegisteredUser = false,
        iUserType = 0,
        bCanScanBarcode = true,
        getCurrentSection = function getCurrentSection() {
            return mvapi.getCurrentSection();
        },
        isAgeRestricted = function isAgeRestricted() {
            return iAgeRestriction === null ? false : true;
        },
        setAgeRestriction = function setAgeRestriction(iAge) {
            if (typeof iAge === 'number') {
                iAge = (iAge === 0) ? null : iAge;
                iAgeRestriction = iAge;
            }
        },
        isRegisteredUser = function isRegisteredUser() {
            return bRegisteredUser;
        },
        setRegisteredUser = function setRegisteredUser(isRegistered) {
            bRegisteredUser = isRegistered;
        },
        getUserType = function getUserType() {
            return iUserType;
        },
        setUserType = function setUserType(type) {
            if (type === 0 || type === 1 || type === 2) {
                iUserType = type;
            }
        },
        isCheckout = function isCheckout() {
            var sCurrentSection = mvapi.getCurrentSection();
            return sCurrentSection === 'login' || sCurrentSection === 'delivery' || sCurrentSection === 'review' || sCurrentSection === 'payment';
        };



    return {
        /**
         * @method canScanVoucher
         * @memberof user-session
         * @returns {bool}
         */
        canScanVoucher: bCanScanVoucher,
        /**
         * @method canScanClubcard
         * @memberof user-session
         * @returns {bool}
         */
        canScanClubcard: bCanScanClubcard,
        /**
         * @method canScanEcoupon
         * @memberof user-session
         * @returns {bool}
         */
        canScanEcoupon: bCanScanEcoupon,
        /**
         * @method canScanGiftcard
         * @memberof user-session
         * @returns {bool}
         */
        canScanGiftcard: bCanScanGiftcard,
        /**
         * @method canEditEmail
         * @memberof user-session
         * @returns {bool}
         */
        canEditEmail: bCanEditEmail,
        /**
         * @method getCurrentSection
         * @memberof user-session
         * @returns {string}
         */
        getCurrentSection: getCurrentSection,
        /**
         * @method isAgeRestricted
         * @memberof user-session
         * @returns {bool}
         */
        isAgeRestricted: isAgeRestricted,
        /**
         * @method getAgeRestriction
         * @memberof user-session
         * @returns {number}
         */
        getAgeRestriction: iAgeRestriction,
        /**
         * @method getAgeRestriction
         * @memberof user-session
         * @param {number} iAge - The number value of the minimum age of customer, i.e 16, 18, 21
         * @returns {number}
         */
        setAgeRestriction: setAgeRestriction,
        /**
         * @method isRegisteredUser
         * @memberof user-session
         * @returns {bool}
         */
        isRegisteredUser: isRegisteredUser,
        /**
         * @method setRegisteredUser
         * @memberof user-session
         * @returns {void}
         */
        setRegisteredUser: setRegisteredUser,
        /**
         * @method getUserType
         * @memberof user-session
         * @returns {string}
         * @values  registered, anonymous, mixed , clubcard
         */
        getUserType: getUserType,
        /**
         * @method setUserType
         * @memberof user-session
         * @returns {string}
         * @values  registered, anonymous, mixed , clubcard
         */
        setUserType: setUserType,
        /**
         * @method canScanBarcode
         * @memberof user-session
         * @returns {bool}
         */
        canScanBarcode: bCanScanBarcode,
        /**
         * @method isCheckout
         * @memberof user-session
         * @returns {bool}
         */
        isCheckout: isCheckout
    };
});

define('modules/custom-dropdown/common',['domlib', 'modules/breakpoint', 'modules/common'], function($, breakpoint, common){

    var customDropdown = {

        // store the event type (updated in init for touch devices)
        eventType: 'click',

        // used by the mouse enter/leave events to set a timer to close any open menus if left inactive
        closeTimer: null,

        // store the currently opened custom dropdown wrapper (can only ever be one open at a time)
        $currentWrapper: [],

        // flag set once the custom drop down menu is shown
        isVisibleFlag: 'sortbyIsVisible',

        // ensure that the drop down is only setup once - could extend this so that other functions
        // can reset the value of this flag to destroy a current custom drop down and rebuild it
        isSetupFlag: 'customDropdownIsSetup',

        // can't use siblings as it can return multiples for groups (e.g. expiry date in the checkout)
        getSelect: function( $wrapper ) {
            var self = customDropdown;

            if (!$wrapper.hasClass('customDropdown')) {
                $wrapper = self.getWrapper( $wrapper );
            }

            var $select = $wrapper.next('select');

            if (!$select.length) {
                $select = $wrapper.prevAll('select:eq(0)');
            }

            return $select;
        },
        getWrapper: function( $child ) {
            if (common.isTouch() && !window.isKiosk())
                return $child.siblings('.customDropdown');
            else
                return $child.parents('.customDropdown');
        },

        // update the icon and display text for dropdown control
        updateControlIcon: function( $element ) {
            var $icon = $element.find('.icon');
            $icon.attr('data-icon', $icon.attr('data-icon') === '2' ? '1' : '2' );
        },
        updateControlText: function( $element, txt ) {
            $element.find('.control .innerText').text( txt );

            if (common.isTouch()) {
                customDropdown.updateSelectDimension( $element );
            }
        },

        // bind mouse enter/leave events to set a timer to close any open menus if left inactive
        bindMouseEvents: function( $wrapper ) {
            var self = customDropdown;
            $wrapper
                .on('mouseenter', self.closeTimerClear )
                .on('mouseleave', self.closeTimerStart );
        },
        closeTimerClear: function() {
            var self = customDropdown;
            window.clearTimeout( self.closeTimer );
        },
        closeTimerStart: function() {
            var self = customDropdown;
            self.closeTimer = setTimeout(function() {
                self.close();
            }, 10000);
        },

        // open drop down menu
        // NOT CALLED FOR TOUCH DEVICES!
        open: function( $control ) {
            var self     = customDropdown;
            var $wrapper = self.getWrapper( $control );

            // close any currently opened drop downs
            if (self.$currentWrapper.length) {
                self.close();
            }

            // if its not a touch device, update the icon and open the custom menu
            if (!common.isTouch() || window.isKiosk()) {
                self.updateControlIcon( $control );
                $wrapper
                    .addClass('open')
                    .data( self.isVisibleFlag, true );
            }

            // bind event to body to close any currently opened drop downs
            $('body').on( self.eventType, self.close );

            // store the newly opened drop down ready to be closed
            self.$currentWrapper = $wrapper;
        },
        // close any currently opened drop downs
        // NOT CALLED FOR TOUCH DEVICES!
        close: function() {
            var self = customDropdown;

            // exit early if no drop down is stored
            if (!self.$currentWrapper.length) {
                return;
            }

            var $select = self.getSelect( self.$currentWrapper );

            // ensure that the visible flag has been set before hiding hte custom menu
            if (self.$currentWrapper.data( self.isVisibleFlag )) {
                self.updateControlIcon( self.$currentWrapper );

                self.$currentWrapper
                    .removeClass('open')
                    .data( self.isVisibleFlag, false );

                $select.trigger('blur');
            }

            $select.css('width', self.$currentWrapper.width() );

            // if not a touch device, clear the timer used to close the menu if left inactive
            if (!common.isTouch()) {
                self.closeTimerClear();
            }

            // unbind event to body to close any currently opened drop downs
            $('body').off( self.eventType, self.close );

            self.$currentWrapper = [];
        },
        // update the custom drop down based on the selection from the drop down menu
        // NOT CALLED FOR TOUCH DEVICES!
        updateMenu: function( $anchor ) {
            var self     = customDropdown;
            var $wrapper = self.getWrapper( $anchor );
            var $select  = self.getSelect( $wrapper );

            if (!$select.length) {
                return false;
            }

            var $current = $wrapper.find('.current');
            var $options = $select.find('option');
            var value    = $anchor.attr('data-value');

            // make sure we've not re-selecting the current
            if ($current[0] !== $anchor[0]) {

                // update the display text for when dropdown is closed
                self.updateControlText( $wrapper, $anchor.text() );

                // remove existing current class and set the new
                $current.removeClass('current');
                $anchor.addClass('current');

                // remove existing selected attribute and set the new
                $options.removeAttr('selected');
                $options.filter('[value="' + value + '"]').attr('selected', 'selected');

                // update the selected index, value and trigger the change event on the original select element
                $select[0].selectedIndex = $options.index( $options.filter('[value="' + value + '"]') );
                $select
                    .val( value )
                    .trigger('change');
            }

            self.close();
        },
        // create the custom drop down menu
        // NOT CALLED FOR TOUCH DEVICES!
        createMenu: function( $wrapper ) {
            var self        = customDropdown;
            var $select     = self.getSelect( $wrapper );
            var $menu       = $('<ul />');

            var txtLabel    = $('label[for="' + $select[0].id + '"]' ).html().replace(/<.*>/, '');
            var txtSelected = $select.find(':selected').text();

            $menu.append('<li class="alt-heading">' + txtLabel + '</li>');

            $select.find('option').each(function() {
                var currentClass  = (txtSelected === this.innerHTML) ? ' current' : '';
                var dataAttribute = (this.getAttribute('data-other')) ? 'data-other="' + this.getAttribute('data-other') + '"' : '';

                $menu.append('<li><a class="sort' + currentClass + '" href="#non" data-value ="' + this.value + '"' + dataAttribute + '>' + this.innerHTML + '</a></li>');
            });

            $menu.find('a').on( self.eventType, function(e) {
                e.preventDefault();
                e.stopPropagation();

                self.updateMenu( $(this) );

                return false;
            });

            $wrapper
                .append( $menu )
                .data( self.isSetupFlag, true );
        },

        // set the dimensions of the select to match that of the select/label element for touch devices
        // NOTE: this function can be called from external scripts - if it's a touch device, we need to
        // update the dimensions of the select box to ensure that it's clickable over the .control
        // element - this is normally done in the setup of the custom drop down, but doesn't work in
        // scenarios where it's hidden by default so the dimensions cannot be retrieved
        // as external functions can call, allow a collection of .customDropdown wrappers to be passed
        updateSelectDimension: function( $select ) {
            var self = customDropdown;
            var $wrappers = customDropdown.getWrapper( $select );
            // exit if not a touch device
            if (!common.isTouch()) {
                return;
            }

            $wrappers.each(function(){
                var $select    = self.getSelect( $(this) );
                var $control   = $(this).find('.control');

                var totalWidth = $control.outerWidth(true)+20;
                var totalHeight = $control.outerHeight(true);
                $select
                    .addClass('native-select-trigger')
                    .css({'width':totalWidth, 'height':totalHeight, 'top':'auto'});

                if (breakpoint.mobile) {
                    var $label     = $('label[for="' + $select[0].id + '"]');
                    if ($label.is(':hidden')) {
                        $select.css('top', $(this).top);
                    }
                    else {
                        $select.css('top', $label.outerHeight(true));
                    }
                }
            });
        },

        // create the custom drop down wrapper and control
        setup: function( $select ) {
            var self        = customDropdown;
            var txtSelected = $select.find(':selected').text();
            var $wrapper    = $('<div class="customDropdown"><a class="control" href="#non"><span class="innerText">' + txtSelected + '</span><span data-icon="2" class="icon"></span></a></div>');
            var $control    = $wrapper.find('.control');

            $select.addClass('been-customised');

            // need to insert into the dom before updating dimensions for mobile
            $wrapper = $wrapper.insertAfter( $select );
            customDropdown.updateSelectDimension($select);
            // no custom drop down generated - just bind change event to update the control display text
            if (common.isTouch() && !breakpoint.kiosk) {
                $control.on('tap click', function(e) {
                    e.preventDefault();
                });

                $select.on('change', function() {
                    self.updateControlText( $wrapper, $(this).find(':selected').text() );
                });

                // add fix for earlier version of Android (2.x)
                // issue - tap on the $dropdown.find('.control') element is returning the select element
                // this fix is only required for Android (2.x) - applying the fix to Android 4.x will cause it to break (oh joy!)
                if (common.isAndroid()) {
                    var ua = navigator.userAgent.toLowerCase();
                    if (parseFloat( ua.slice( ua.indexOf('android') +8 ) ) < 4) {
                        $select.css('z-index', 0);
                    }
                }
            }

            // bind event to open the drop down
            else {

                $control.on( self.eventType, function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    if ($(this).hasClass('open')) {
                        self.close();
                    } else {
                        self.open( $(this) );
                    }

                    return false;
                });

                // if not a touch device, bind mouse enter/leave events to set a timer to close the menu if left inactive
                if (!breakpoint.kiosk) {
                    self.bindMouseEvents( $wrapper );
                }
            }

            // set the dimensions of the select to match that of the select/label element for touch devices
            if (common.isTouch() && !breakpoint.kiosk) {
                self.updateSelectDimension( $wrapper );
            } else {
                self.createMenu( $wrapper );
            }
        },

        updateHandler: function( $select ) {
            customDropdown.updateSelectDimension( $select );
        },

        initViewport: function( $select ) {
            breakpoint.mobileOut.push(function(){
                customDropdown.updateHandler($select);
            });
            breakpoint.vTabletOut.push(function(){
                customDropdown.updateHandler($select);
            });
            breakpoint.hTabletOut.push(function(){
                customDropdown.updateHandler($select);
            });
            breakpoint.desktopOut.push(function(){
                customDropdown.updateHandler($select);
            });
            breakpoint.largeDesktopOut.push(function(){
                customDropdown.updateHandler($select);
            });
        },

        init: function( $select ) {
            var self = customDropdown;

            // update the event type (default is click - click too slow on windows phone, tap not recognised)
            if (common.isTouch()) {
                self.eventType = (common.isWindowsPhone()) ? 'MSPointerDown' : 'tap click';
            }

            $select = $select.not('.been-customised');

            $select.each(function(){
                self.setup( $(this) );
            });

            // re initialise custom dropdown dimensions on breakpoint change
            self.initViewport( $select );

            //feature detection for ie8 - does not support addEventListener
            if(window.addEventListener) {
                window.addEventListener("orientationchange", function() {
                    customDropdown.updateHandler($select);
                }, false);
            }
        }
    };

    return customDropdown;
});

/*jslint plusplus: true, indent: 4 */
/*globals window,document,console,define */
define('modules/chip-and-pin/bundles', [],function () {
    'use strict';
    var data,
        bundles = {
            "spc.checkoutTitle": "Secure checkout",
            "spc.checkout.subTitle": "Select your delivery option, complete everything that's mandatory and press \"Pay now\"",
            "spc.chipAndPin.loginTitle": "Add your Clubcard details",
            "spc.chipAndPin.login.scanCardTitle": "Scan",
            "spc.chipAndPin.login.scanCard": "You can scan a Clubcard with a barcode",
            "spc.chipAndPin.login.typeTitle": "Type",
            "spc.chipAndPin.login.typeNumber": "Or you can type any Clubcard number",
            "spc.chipAndPin.login.enterClubcardButton": "Go",
            "spc.chipAndPin.login.skipLogin": "Continue without Clubcard",
            "spc.chipAndPin.login.postcode.heading": "Speed up your purchase by verifying your Clubcard",
            "spc.chipAndPin.login.postcode.intro": "Enter the postcode registered to the card.",
            "spc.chipAndPin.login.postcode.verifyPostcode": "Go",
            "spc.chipAndPin.login.postcode.skipPostcode": "Skip, I don't know the postcode",

            "spc.chipAndPin.login.validation.required": "Please enter a number.",
            "spc.chipAndPin.login.validation.inValid": "Please check the number you've entered is correct.",
            "spc.chipAndPin.login.validation.enterAPostCode": "Enter a postcode",

            "spc.chipAndPin.userDetails.heading": "Please enter your details",
            "spc.chipAndPin.userDetails.titleLabelText": "Title",
            "spc.chipAndPin.userDetails.firstNameLabelText": "First name",
            "spc.chipAndPin.userDetails.surnameLabelText": "Surname",
            "spc.chipAndPin.userDetails.emailLabelText": "Email",
            "spc.chipAndPin.userDetails.contactNumberLabelText": "Contact number",
            "spc.chipAndPin.userDetails.emailPlaceholderText": "Optional",
            "spc.chipAndPin.userDetails.contactNumberPlaceholderText": "Enter your mobile number and get text updates",
            "spc.chipAndPin.userDetails.footerMessage": "We will only use your contact details to update you on your order.",
            "spc.chipAndPin.userDetails.ageRestrictionDOBMessage": "We need you to enter your date of birth as your order contains an age restricted product",
            "spc.chipAndPin.userDetails.continueBtnText": "Continue",

            "spc.chipAndPin.delivery.storeFinderOverlayHeader": "Find a store",
            "spc.chipAndPin.delivery.storeFinderLabelText": "Enter a postcode or town to find a store",
            "spc.chipAndPin.delivery.matchingStoresOverlayHeader": "Select a store",
            "spc.chipAndPin.delivery.openingTimesHeader": "Opening hours",
            "spc.chipAndPin.delivery.storeAddressHeader": "Address",
            "spc.chipAndPin.delivery.selectStoreBtnText": "Select",
            "spc.chipAndPin.delivery.selectNotStoreBtnText": "Not available",
            "spc.chipAndPin.delivery.cncResErrorMSG": "Sorry,this item cannot be collected from store",
            "spc.chipAndPin.delivery.findAnotherStoreBtnText": "Find a different store",
            "spc.chipAndPin.delivery.sectionTitle": "Select a delivery option",
            "spc.chipAndPin.delivery.sectionTitle.multiple": "Select delivery options",
            "spc.chipAndPin.delivery.freeReturns": "FREE returns on most Tesco products (exceptions apply).",
            "spc.chipAndPin.delivery.reviewMessage": "You will be able to change your selection(s) when you review your order.",
            "spc.chipAndPin.delivery.delayWarning": "Sometimes it takes longer to deliver items to Northern Ireland, the Isle of Man, the Isles of Scilly, Orkney, Shetland and other Scottish islands. See Delivery Information for more details.",
            "spc.chipAndPin.delivery.warningModal.heading": "If you go back you'll need to re-enter all your previously selected options. Is this OK?",
            "spc.chipAndPin.delivery.warningModal.yesButton": "YES, GO BACK",
            "spc.chipAndPin.delivery.warningModal.noButton": "NO, I'LL LEAVE IT",
            "spc.chipAndPin.delivery.postcodeError": "Please enter a postcode or town",
            "spc.chipAndPin.delivery.homeDelivery.noResultsFound": "Sorry, we can't find a match for that postcode. Please try another postcode or select another delivery type.",
            "spc.chipAndPin.delivery.homeDelivery.blockedPostcode": "Sorry, we can't deliver to this postcode. Please enter a different postcode or select another delivery type.",
            "spc.chipAndPin.delivery.homeDelivery.findAddressHeading": "Find an address",
            "spc.chipAndPin.delivery.homeDelivery.savedAddress": "Please select an address for delivery",

            "spc.chipAndPin.review.heading": "Review your order before you pay",
            "spc.chipAndPin.review.addVouchersButton": "Add Clubcard Vouchers",
            "spc.chipAndPin.review.addECouponsButton": "Add eCoupons",
            "spc.chipAndPin.review.payGiftCardButton": "Add a Gift Card",
            "spc.chipAndPin.review.termsAndConditions.messageText": "By Paying Now you are agreeing to Tesco",
            "spc.chipAndPin.review.termsAndConditions.linkText": "terms and conditions",
            "spc.chipAndPin.review.termsAndConditions.headerText": "Terms and Conditions",
            "spc.chipAndPin.review.privacyPolicy.headerText": "Privacy and cookies policy",
            "spc.chipAndPin.review.privacyPolicy.btnText": "Privacy and cookies policy",
            "spc.chipAndPin.review.privacyPolicy.backBtnText": "Back",
            "spc.chipAndPin.review.proofOfDeliveryMessage": "This delivery will require an adult to sign for it.",

            "spc.delivery": "Delivery",
            "spc.checkoutPayment.defaultSelectYear": "YYYY",
            "spc.checkoutPayment.maxEndYear": "2049",
            "spc.checkoutPayment.addNewAddress": "new address",
            "spc.checkoutPayment.nickname": "Nickname",
            "spc.checkoutPayment.postcode": "Postcode",
            "spc.checkoutPayment.address": "Address",
            "spc.checkoutPayment.selectAddress": "Select Address",
            "spc.checkoutPayment.addressNotFound": "My address was not found",
            "spc.ageRestricted.product": "Your order contains an age restricted product.",
            "spc.enter.dob": "Please enter your date of birth",
            "spc.item.sold.by": "Sold by",
            "spc.catalogue.no": "Catalogue number",
            "spc.basket.details.header.quantity": "Qty",
            "spc.subTotal": "Subtotal",
            "spc.promotional.savings": "Promotion",
            "spc.staff.discount": "Staff Discount",
            "spc.fuelSaver": "Clubcard fuel savings",
            "spc.giftcard": "Gift Card",
            "spc.vouchers": "Vouchers",
            "spc.total.to.pay": "Total to pay",
            "spc.pay.now.buttonText": "Pay now",
            "spc.clubcard.points": "Total Clubcard points",
            "spc.extra.clubcard.points": "Extra Clubcard points",
            "ageMessage": "You must be {0} or over to buy this item.",
            "spc.delivery.deliveryOptions": "Delivery options",
            "spc.delivery.details": "Delivery details",
            "spc.delivery.address": "Delivery address",
            "spc.delivery.noStoreCollection": "These items can only be delivered.",
            "spc.delivery.noHomeDelivery": "These items can only be collected.",
            "spc.delivery.deliverToMoreThanOne": "Send to different addresses",
            "spc.delivery.noDeliveryMethods": "Sorry, we couldn't find delivery options.Please choose different address.",
            "spc.add.ecoupon.voucher": "Enter the code exactly as it appears on your voucher - including hyphens",
            "spc.add.ecoupon.voucher.clubcard": "Add eCoupons and Clubcard vouchers",
            "spc.view.saved.ecoupon.clubcard.link": "View my saved eCoupons and Clubcard vouchers",
            "spc.delivery.charge.free": "FREE",
            "spc.eCoupon": "eCoupon",
            "spc.no.saving": "no saving",
            "spc.place.your.order": "Pay now",
            "spc.delivery.weWillCallYou": "We will call you in 48 hours",
            "spc.delivery.split.title": "Send your items to different addresses",
            "spc.delivery.split.save": "Save",
            "spc.delivery.split.cancel": "Cancel",
            "spc.delivery.split.new.address": "New address",
            "spc.delivery.method": "Delivery type",
            "spc.delivery.instructions": "Courier instructions",
            "spc.delivery.noCourierInstructions": "No courier instructions",
            "spc.delivery.leavingWithNeighbour": "Instructions for leaving with neighbour",
            "spc.delivery.edit": "edit",
            "spc.nickname.tooltip": "Enter a nickname to describe the delivery address<br/> e.g. work, home",
            "clickAndCollect.collectionDetails": "Collection details",
            "clickAndCollect.collectionMessage": "You'll need to show proof of ID when you collect this order.",
            "clickAndCollect.collectionFromStore": "Collect from store",
            "delivery.hdrtext": "Delivery",
            "delivery.noDeliveryMethod": "Sorry, we couldn't find delivery options.Please choose different address.",
            "singlePageCheckout.couponsVouchers.applied": "eCoupon and Clubcard vouchers",
            "spc_couponsVouchers.delete": "Delete will remove the eCoupon from your account. Take a note of the code if you want to use it later",
            "spc_couponsVouchers.notapplied": "If your eCoupon has not applied, please check it in the list below",
            "spc.couponsVouchers.notApplied": "Stored eCoupons for future orders",
            "spc.couponsVouchers.Vouchers.applied": "eCoupons and Clubcard vouchers",
            "spc_vouchers.delete": "Delete will remove the eCoupon from your account. Take a note of the code if you want to use it later",
            "spc.vouchers.notApplied": "Stored voucher. Vouchers can only be used with items sold by Tesco",

            "spc.chipAndPin.vouchers.addVoucherHeading": "Add a Clubcard voucher code",
            "spc.chipAndPin.vouchers.addVoucherIntro": "Clubcard is our way of saying thank you. When you shop at Tesco you collect points, which we turn into Clubcard vouchers. Right now, there are no vouchers in your account. If you have a Clubcard, make sure the Clubcard number has been added to Your Account. If you don't, it's easy to join at Tesco.com/Clubcard.]",
            "spc.chipAndPin.vouchers.addVoucherLabel": "Enter the voucher code exactly as it appears - including any spaces",
            "spc.chipAndPin.vouchers.skipPostcode": "Close",
            "spc.chipAndPin.vouchers.buttonAdd": "Add",
            "spc.chipAndPin.vouchers.addClubcardVouchersTitleBeggining": "Add Clubcard vouchers",
            "spc.chipAndPin.vouchers.addClubcardVouchersTitleEnd": "available",
            "spc.chipAndPin.vouchers.addClubcardVouchersAmountSelected": "selected",
            "spc.chipAndPin.vouchers.voucherItemExpiryText": "expires",
            "spc.chipAndPin.vouchers.footerButtonIHaveAVoucherCode": "I have a voucher code",
            "spc.chipAndPin.vouchers.footerTextSelected": "selected",
            "spc.chipAndPin.vouchers.footerButtonAdd": "Update",
            "spc.chipAndPin.vouchers.footerButtonCancel": "Cancel",
            "spc.chipAndPin.vouchers.kmfIOselectedVouchersTitle": "Cancel Clubcard Voucher Items?",
            "spc.chipAndPin.vouchers.kmfIOselectedVouchers": "You have selected vouchers but not added them to your order. Are you happy to continue without adding them?",

            "spc.chipAndPin.eCoupon.addECouponHeading": "Add an eCoupon code (exactly as it appears, including any hyphens)",
            "spc.chipAndPin.eCoupon.eCouponListHeading": "Here are your eCoupons",

            "spc.chipAndPin.discounts.viewDiscountsListHeading": "Here's a breakdown of all your savings",
            "spc.chipAndPin.discounts.viewDiscountsEmptyMessage": "There are currently no discount savings applied to this order",

            "spc.chipAndPin.giftCards.addGiftCardsHeading": "Pay with a Giftcard",
            "spc.chipAndPin.giftCards.giftCardsListHeading": "Here are your Giftcards",

            "spc.add.giftcard.message": "Enter your Gift Card code and PIN",
            "spc.add.giftcard.code": "Gift Card code",
            "spc.add.giftcard.pin": "Gift Card Pin",
            "spc.add.giftcard.remove": "Remove Gift Card",
            "spc.eCoupon.added.checkout": "eCoupon added to checkout.",
            "spc.eCoupon.not.added": "eCoupon not added.",
            "spc.eCoupon.applicable.but.not.added": "eCoupon applicable, but not added.",
            "spc.voucher.added.checkout": "Clubcard voucher added to checkout",
            "spc.eCoupon.mutuallynotapplicable": "Applicable but not added. This eCoupon cannot be used with the applied eCoupon. Delete the applied eCoupon if you want to use this one.",
            "spc.eCoupon.Clubcard.voucher.code": "eCoupon or Clubcard voucher code",
            "spc.mobile.phone": "Mobile phone number",
            "spc.mobile.alternate.phone": "Alternative telephone number",
            "spc.mobile.phone.txt": "I don't have a mobile phone",
            "spc.mobile.alternate.phone.txt": "Your mobile number is safe with us - we only use it to contact you about your order.",
            "spc.mobile.alternate.phone.txt.line2": "If you don't have a mobile, please enter an alternative number here.",
            "spc.delivery.address.notfound.message": "Sorry, we can only deliver to addresses held on our systems.<br/> Please use an alternative delivery address or call 0845 600 44 11",
            "spc.splititems.togetfaster": "This delivery includes a delayed item. Split your delivery to get some items faster",
            "spc.combineitems.togetcheaper": "You can save money by combining this with another delivery",

            "spc.chipAndPin.payment.paymentDeclinedText": "Unfortunately your card payment has been declined. What would you like to do?",
            "spc.chipAndPin.payment.paymentDeclinedRetryButton": "PAY AGAIN",
            "spc.chipAndPin.payment.paymentDeclinedCancelButton": "CANCEL ORDER",
            "spc.chipAndPin.payment.instructionsMessage": "Insert your card in the<br/><strong>Chip and PIN</strong> reader to pay",
            "spc.chipAndPin.payment.cardsMessage": "Pay for your item(s) with"
        };

    if (window.TescoData && window.TescoData.ChipAndPin) {
        data = window.TescoData.ChipAndPin;
    }

    if (data && data.init && data.init.messages) {
        bundles = data.init.messages;
    }

    return bundles;
});

/*globals define, window*/
/*jslint plusplus:true, regexp: true*/
define('modules/validation',[
    'domlib',
    'modules/breakpoint',
    'modules/common',
    'modules/custom-dropdown/common',
    'modules/tesco.utils',
    'modules/chip-and-pin/bundles'
], function (
    $,
    breakpoint,
    common,
    customDropdown,
    utils,
    bundles
) {
    'use strict';
    var validationExtras = {
        msg: {
            signinpass: {
                required: "Please enter your email address.",
                signinpassword: "Password must contain a upper case, number and a special character"
            },
            email: {
                required: "Enter an email address",
                confirm: "Confirm your email address",
                inValid: "Enter a valid email address",
                equalTo: "Your email addresses don't match"
            },
            postcode: {
                required: bundles["spc.chipAndPin.login.validation.enterAPostCode"] || 'Enter a postcode',
                inValid: "Enter a valid postcode"
            },
            postcodeUK: {
                inValid: "Please check the postcode you've entered is correct."
            },
            clubcard: {
                required: "Enter a clubcard number",
                requiredKiosk: bundles['spc.chipAndPin.login.validation.required'] || 'Please enter a number.',
                requiredMyAccount: "Please enter a Clubcard number.",
                chooseOne: "Enter a clubcard number",
                inValidKiosk: bundles['spc.chipAndPin.login.validation.inValid'] || 'Please enter a number.',
                inValid: 'Enter a valid clubcard number'
            },
            title: {
                required: "Select title"
            },
            firstname: {
                required: "Enter a first name",
                inValid: "Enter a valid first name"
            },
            lastname: {
                required: "Enter a last name",
                inValid: "Enter a valid last name"
            },
            date: {
                dateDayCheck: "Enter your date of birth",
                dateMonthCheck: "Enter your date of birth",
                dateYearCheck: "Enter your date of birth",
                ageRestrictionYearCheck: $('#wrapper.spi').length > 0 ? "You must be over the age of " + $('#wrapper.spi').data().ageRestriction : "You must be over the age of 18"
            },
            screenname: {
                minlength: "Please choose a screen name that is at least six characters. This will be displayed if you write a product review."
            },
            address: {
                required: "You need to select your main address."
            },
            addressNickname: {
                required: "Enter a nickname for this address."
            },
            companyname: {
                inValid: "Sorry, we do not accept sets of single or double quote marks",
                inValidLastChar: "Sorry, we do not accept * as the last character",
                inValidSingleQuotes: "Sorry, we don't accept a pair of single quote marks",
                required: "Enter a company name"
            },
            editableAddress: {
                required: "Complete one of the following three fields",
                inValid: "Sorry, we only accept the following special characters ().&\',/"
            },
            newAddressNickname: {
                required: "Enter a nickname",
                inValid: "Please do not enter special characters {}<>[]"
            },
            propertyType: {
                required: "Please enter a property type"
            },
            daytimeTelephone: {
                required: "Please enter a daytime phone number.",
                inValid: "Your daytime phone number must begin with a 0 and contain 10 or 11 digits including the dialling code."
            },
            eveningTelephone: {
                required: "Please enter an evening phone number.",
                inValid: "Your evening phone number must begin with a 0 and contain 10 or 11 digits including the dialling code."
            },
            alternateTelephone: {
                required: "Enter your alternate phone number",
                inValid: "Enter a valid contact phone number."
            },
            mobile: {
                required: "Enter your mobile phone number",
                inValid: "Invalid mobile phone number"
            },
            phone: {
                required: "Enter a contact phone number",
                inValid: "Enter a valid contact phone number"
            },
            password: {
                required: "Enter a password",
                confirm: "Confirm password",
                rangelength: "Invalid password",
                equalTo: "Your passwords don't match",
                enhancedPassword: "Invalid password"
            },
            terms: {
                required: 'Please tick this box to agree to Tesco <a href="/direct/help/terms-conditions.page" target="_blank">Terms and Conditions</a>'
            },
            eGamingTerms: {
            	required: 'Please tick this box to agree that once you start downloading your digital content you will lose the right to cancel your order within 14 days.',
            	checked: 'I agree that once I start downloading my digital content I will lose the right to cancel my order within 14 days.'
            },
            nameOnCard: {
                required: "Enter the name on your card"
            },
            cardNumber: {
                required: "Enter a card number"
            },
            securityCode: {
                required: "Enter a code",
                number: "Invalid code",
                minLength: "Invalid code",
                maxLength: "Invalid code"
            },
            expiryDate: {
                required: "Select an expiry date"
            },
            billingAddress: {
                required: "Please select a billing address"
            },
            giftCard: {
                required: "Enter your Gift card code and PIN"
            },
            giftCardNumber: {
                required: "Enter a valid code"
            },
            giftCardPin: {
                required: "Enter a valid PIN"
            },
            couponCode: {
                required: "Enter a valid code"
            },
            voucherCode: {
                required: "Enter a valid code"
            },
            isUnique: {
                inValid: "You are already using this nickname"
            },
            ageverification: {
                dobRequired: "Please enter your date of birth",
                inValid: function () {
                    return "You must be over the age of " + $('#min-age').val();
                }
            },
            postcodeTownCombo: {
                inValid: "Enter a valid town or postcode"
            },
            flatnumber: {
                required: "Enter a flat / unit number"
            }
        },

        customMethods: {
        	 //function which check for special charcters in the nick name field and address line One field
            validateSpecialInvalidCharacters: function(){
             $.validator.addMethod('validateSpecialInvalidCharacters', function (value, element, params) {
                  var regexp,
                      isValid;
                  regexp = /[{}\[\]<>]/;
                  isValid = regexp.test(value);
                  
                  return !isValid;
                  
       	   
              }, validationExtras.msg.newAddressNickname.inValid);
            },
            // valid company name with everything except ,'"
            companyNameCheck: function () {
                $.validator.addMethod('companyNameCheck', function (value, element, params) {
                    var regexp,
                        isValid;
                    regexp = /^[^,"]*$/;
                    isValid = regexp.test(value);
                    return isValid;
                }, validationExtras.msg.companyname.inValid);
            },
            // valid company name with everything except ,'"
            companyNameLastCharacterCheck: function () {
                $.validator.addMethod('companyNameLastCharacterCheck', function (value, element, params) {
                    if (value.slice(-1) === '*') {
                        return false;
                    }
                    return true;

                }, validationExtras.msg.companyname.inValidLastChar);
            },
            // Currently not begin used...
            companyNameSingleQuotes: function () {
                $.validator.addMethod('companyNameSingleQuotes', function (value, element, params) {
                    if ((value.split("'").length - 1) > 1) {
                        return false;
                    }
                    return true;

                }, validationExtras.msg.companyname.inValidSingleQuotes);
            },
            // valid names with letters and hyphen only.
            nameCheck: function () {
                $.validator.addMethod('nameCheck', function (value, element, params) {
                    var isLastname = params.isLastname,
                        regexp,
                        isValid;
                    regexp = (isLastname) ? (/^[A-Za-z\s-']+([A-Za-z\s-']+)*$/) : (/^[A-Za-z\s-]+(-[A-Za-z\s-]+)*$/);

                    isValid = regexp.test(value);
                    return isValid;
                }, validationExtras.msg.firstname.inValid);
            },
            //validate
            ageRestrictionCheck: function () {

                var validate_month = function () {
                    var v_month = $('#register-date-month').val(),
                        month = parseInt(v_month, 10);

                    return /^[0-9]{1,2}$/.test(v_month) && month <= 12;
                },
                    validate_day = function () {
                        var v_day = $('#register-date-day').val(),
                            v_month = $('#register-date-month').val(),
                            v_year = $('#register-date-year').val(),
                            day = parseInt(v_day, 10),
                            month = parseInt(v_month, 10),
                            year = parseInt(v_year, 10),

                            currDate = new Date(),
                            d = new Date(year, month - 1, day),
                            isValid = isNaN(d) || !validate_month() || (!isNaN(d) && ((d.getMonth() + 1) === month && d.getDate() === day) && validate_month());

                        return /^[0-9]{1,2}$/.test(v_day) && day <= 31 && isValid;
                    },

                    validate_year = function () {
                        var v_year = $('#register-date-year').val(),
                            year = parseInt(v_year, 10);

                        return /^[0-9]{4}$/.test(v_year) && year >= 1900;
                    },

                    validate_all = function (value, element, params) {
                        var v_day = $('#register-date-day').val(),
                            v_month = $('#register-date-month').val(),
                            v_year = $('#register-date-year').val(),
                            day = parseInt(v_day, 10),
                            month = parseInt(v_month, 10),
                            year = parseInt(v_year, 10),
                            birthday = new Date(year, month - 1, day),
                            currDate = new Date(),
                            millisPerYear = 1000 * 60 * 60 * 24 * 365.25,
                            age = ((currDate.getTime()) - birthday.getTime()) / millisPerYear;

                        return (!validate_day() || !validate_month() || !validate_year()) || age >= params;
                    };

                $.validator.addMethod('dateDayCheck', validate_day, '');
                $.validator.addMethod('dateMonthCheck', validate_month, '');
                $.validator.addMethod('dateYearCheck', validate_year, '');

                $.validator.addMethod('ageRestrictionDayCheck', validate_all, '');
                $.validator.addMethod('ageRestrictionMonthCheck', validate_all, '');
                $.validator.addMethod('ageRestrictionYearCheck', validate_all, '');
            },
            // valid telephone number which begins with 0 and contain 11 digits.
            telephone: function () {
                $.validator.addMethod('telephone', function (value, element, params) {
                	var regexp = /^0\d{9,10}$/;
                	return common.verifyTelephone(regexp, value);
                }, validationExtras.msg.daytimeTelephone.inValid);
            },

            // valid telephone number which begins with 0 and contain 11 digits.
            eveningTelephone: function () {
                $.validator.addMethod('eveningTelephone', function (value, element, params) {
                	var regexp = /^0\d{9,10}$/;
                	return common.verifyTelephone(regexp, value);
                }, validationExtras.msg.eveningTelephone.inValid);
            },
            signinpassword: function () {
                $.validator.addMethod("signinpassword", function (value) {
                    return /^[A-Za-z0-9\d=!\-@._*]*$/.test(value) && /[a-z]/.test(value) && /\d/.test(value);
                }, validationExtras.msg.signinpass.signinpassord);
            },

            // valid mobile number which begin with 07 and contain 11 digits.
            mobile: function () {
                $.validator.addMethod('mobile', function (value, element, params) {
                    if (value === '') {
                        return true;
                    }
                    var regexp = /^07\d{9}$/,
                        isValid = regexp.test(value.replace(/\s/g, ''));
                    return isValid;
                }, validationExtras.msg.mobile.inValid);
            },

            // valid telephone number which begins with 0 and contain 11 digits.
            phone: function () {
                $.validator.addMethod('phone', function (value, element, params) {
                    var regexp = /^(07[\d]{9}|01[\d]{8,9}|02[\d]{8,9})$/;
                    return common.verifyTelephone(regexp, value);
                }, validationExtras.msg.phone.inValid);
            },

            postcodeTownCombo: function () {
                $.validator.addMethod('postcodeTownCombo', function (value, element) {
                    return this.optional(element) || /^[a-zA-Z0-9\s]+$/i.test(value);
                }, validationExtras.msg.postcodeTownCombo.inValid);
            },

            // check form field checking for editable addresses (used in checkout and account section)
            checkEditableAddresses: function () {
                $.validator.addMethod('checkEditableAddresses', function (value, element, params) {
                    var bResult = false,
                        self = this;
                    $.each(this.groups, function (key, value) {
                        var $elem = $(self.currentForm).find('input[name="' + key + '"]');
                        if ($elem.val() !== '') {
                            bResult = true;
                            return;
                        }
                    });

                    if (bResult) {
                        $.each(this.groups, function (key, value) {
                            var $elem = $(self.currentForm).find('input[name="' + key + '"]');
                            $elem.removeClass('error required').addClass('valid');
                        });
                        return true;

                    } else {
                        $.each(this.groups, function (key, value) {
                            var $elem = $(self.currentForm).find('input[name="' + key + '"]');
                            if ($elem.val() === '') {
                                $elem.removeClass('valid').addClass('required error');
                            }
                        });
                        return false;
                    }
                }, validationExtras.msg.editableAddress.required);
            },

            checkEditableAddressesInvalidCharacters: function () {
                $.validator.addMethod('checkEditableAddressesInvalidCharacters', function (value, element, params) {

                    var self = this,
                        regex = /^[\/,\w\d\s().&\''/-]+$/, // Allowed chars
                        $elem = $(element);


                    $elem.removeClass('failedInvalidChars');
                    if (value !== '') {
                        if (!value.match(regex)) {
                            $elem.addClass('failedInvalidChars');
                            return false;
                        } else {
                            return true;
                        }
                    } else {
                        return true;
                    }

                }, validationExtras.msg.editableAddress.inValid);

            },
            // UK clubcard number length
            postcodeUK: function () {
                $.validator.addMethod('postcodeUK', function (value, element) {
                    var regexp = /^[a-zA-Z].*$/,
                        check = utils.checkPostCodeIsValid(value);
                    if (check) {
                        check = regexp.test(value);
                    }
                    return check;
                }, validationExtras.msg.postcodeUK.inValid);
            },

            // check clubcard number length
            clubcardLength: function () {
                $.validator.addMethod('clubcardLength', function (value, element) {
                    return $.inArray($.trim(value).length, [16, 18]) !== -1;
                }, validationExtras.msg.clubcard.inValid);
            },

            // check clubcard number length
            clubcardFormat: function () {
                $.validator.addMethod('clubcardFormat', function (value, element) {
                    return /^63400(\d{11}|\d{13})$/.test($.trim(value));
                }, validationExtras.msg.clubcard.inValid);

            },

            // check that the entered value does not match an existing one
            isUnique: function () {
                $.validator.addMethod('isUnique', function (value, element, params) {
                    var isValid = true,
                        options,
                        i,
                        len;
                    if (value !== '' && params.fieldToCompare[0]) {
                        if (params.fieldToCompare[0].tagName.toLowerCase() === 'select') {
                            options = params.fieldToCompare.find('option');
                            for (i = 0, len = options.length; i < len; i++) {
                                if ($.trim(options[i].text.toLowerCase()) === $.trim(value.toLowerCase())) {
                                    isValid = false;
                                    break;
                                }
                            }
                        } else if (params.fieldToCompare[0].tagName.toLowerCase() === 'input') {
                            if ($.trim(params.fieldToCompare[0].value.toLowerCase()) === $.trim(value.toLowerCase())) {
                                isValid = false;
                            }
                        } else {
                            isValid = params.fieldToCompare[0].value === value;
                        }
                    }

                    return isValid;
                }, validationExtras.msg.isUnique.inValid);
            },

            // check that the entered value does not match an existing one
            isUniqueFromString: function () {
                $.validator.addMethod('isUniqueFromString', function (value, element, params) {

                    var isValid = true,
                        nicknames = params.fieldToCompare,
                        i;

                    if (typeof (nicknames) === undefined) {
                        return;
                    }

                    nicknames = nicknames.split(',');
                    for (i = 0; i < nicknames.length; i++) {
                        if (nicknames[i].toLowerCase() === value.toLowerCase()) {
                            isValid = false;
                            break;
                        }
                    }

                    return isValid;

                }, validationExtras.msg.isUnique.inValid);
            },

            // check ageverification
            ageverification: function () {
                var min_age;
                $.validator.addMethod('ageverification', function (value, element) {
                    var day = parseInt($('#spc-age-confirmation-module-dd').val(), 10),
                        month = parseInt($('#spc-age-confirmation-module-mm').val(), 10),
                        year = parseInt($('#spc-age-confirmation-module-yyyy').val(), 10),
                        birthday = new Date(year, month - 1, day),
                        currDate = new Date(),
                        millisPerYear = 1000 * 60 * 60 * 24 * 365,
                        age = ((currDate.getTime()) - birthday.getTime()) / millisPerYear;
                    min_age = $('#min-age').val();
                    if (age < min_age) {
                        return false;
                    } else {
                        return true;
                    }
                }, 'You must be over the age of ' + min_age + ' to purchase some items in your basket');
            },

            enhancedPassword: function (EnhancedPassword) {
                $.validator.addMethod('enhancedPassword', function (fieldValue) {
                    var $integratedReg = $('#integrated-registration'),
                        oEnhancedPassword = new EnhancedPassword(fieldValue),
                        iCheckLengthPass = oEnhancedPassword.checkLength(),
                        iCheckNumberPass = oEnhancedPassword.checkNumber(),
                        iCheckLowerCasePass = oEnhancedPassword.checkLowerCase(),
                        iCheckUpperCasePass = oEnhancedPassword.checkUpperCase(),
                        iSpecialCharactersPass = oEnhancedPassword.checkSpecialCharacters();

                    $integratedReg.toggleClass('fnCheckLengthPass', iCheckLengthPass);
                    $integratedReg.toggleClass('fnCheckNumberPass', iCheckNumberPass);
                    $integratedReg.toggleClass('fnCheckLowerCasePass', iCheckLowerCasePass);
                    $integratedReg.toggleClass('fnCheckUpperCasePass', iCheckUpperCasePass);
                    $integratedReg.toggleClass('fnSpecialCharactersPass', iSpecialCharactersPass);

                    if (iCheckLengthPass && iCheckNumberPass && iCheckLowerCasePass && iCheckUpperCasePass && iSpecialCharactersPass) {
                        return true;
                    }
                }, validationExtras.msg.password.enhancedPassword);
            },

            validPCAAddress: function () {
                $.validator.addMethod('validPCAAddress', function (value, element) {
                    if ($('.manually-add-address').is(':visible')) {
                        return true;
                    } else {
                        return false;
                    }
                }, validationExtras.msg.postcode.inValid);
            }
        },

        // update the error placement element - for custom drop downs, the error cannot appear after the select element
        // needs to be after the custom drop down wrapper
        errorPlacementElement: function (element) {
            var innerElement;
            if (element[0].tagName.toLowerCase() === 'select') {
                innerElement = customDropdown.getWrapper(element);
                if (!innerElement.length) {
                    innerElement = element.nextAll('.customDropdown');
                }
            } else {
                innerElement = element;
            }
            return innerElement;
        },

        // nasty fix - may need to look into amending the lib for better fix
        // focus out not begin triggered on old android devices (samsung ace) so force
        // validation of self on blur
        focusoutFix: function ($form) {
            if (common.isAndroid()) {
                $form.find('input[type=text], input[type=email], input[type=password]').blur(function () {
                    $(this).valid();
                });
            }
        },

        selectChangeFix: function ($form, $fields, $save) {
            if (common.isAndroid()) {
                $form.find('select').change(function () {
                    $(this).valid();
                    validationExtras.enableSave($fields, $save);
                });
            }
        },


        scrollToError: function ($elem, speed) {
            var self = utils,
                s = speed || 500;

            if ($elem.length) {
                self.scrollToElem($elem, speed);
            }
        },

        enableSave: function ($fields, $save) {

            var $valid,
                $changeFields;

            $valid = $fields.filter(function () {
                // although a field may have a prefilled value on load, it won't yet have the 'valid' class
                // so call the validate function on the element to set up
                if (!$(this).hasClass('valid')) {
                    if ($(this).validate().check(this)) {
                        $(this).addClass('valid');
                    } else {
                        $(this).removeClass('valid');
                    }
                }
                return $(this).hasClass('valid');
            });

            // check if the selects have the custom 'prefilledValue' set
            // this will get set on form initialisation
            $fields.filter('select').each(function () {
                if (typeof (this.prefilledValue) === undefined) {
                    this.prefilledValue = this.value;
                }
            });

            // collect any form fields who's values differ from their defaults
            $changeFields = $fields.filter(function () {
                var hasChanged = false,
                    tagName = this.tagName.toLowerCase(),
                    timeNow = new Date();
                if (tagName === 'select') {
                    hasChanged = this.value !== this.prefilledValue;
                } else {
                    if (this.type === 'radio' || this.type === 'checkbox') {
                        hasChanged = this.checked !== this.defaultChecked;
                    } else {
                        hasChanged = this.value !== this.defaultValue;
                    }
                }

                return hasChanged;
            });

            // only enable the save button if all the fields are valid and that they have changed
            // from their default values
            if ($fields.length === $valid.length && $changeFields.length !== 0) {
                $save.removeClass('disabled');
            } else {
                $save.addClass('disabled');
            }
        },

        // Suppress non-numeric input (without preventing paste). Prevent more than 11-digit input.
        // MERGE THIS WITH THE OTHER?
        limitCharactersPhone: function ($field, charLimit) {
            $field.on('keydown.limitCharacters', function (e) {
                var field = $(this),
                    codes = [8, 46, 9, 16, 37, 39, 9],
                    arrowKeys,
                    notDeleteOrTabKey,
                    newTrimmedValue;

                if (charLimit === '') {
                    charLimit = 11;
                }

                // Is a number
                if ((e.keyCode > 47 && e.keyCode < 58) || (e.keyCode > 95 && e.keyCode < 106) || ($.inArray(e.keyCode, codes) > -1)) {
                    // limitCharacters: function (e, field, charLimit) {
                    arrowKeys = e.keyCode > 36 && e.keyCode < 40;
                    notDeleteOrTabKey = e.keyCode !== 8 && e.keyCode !== 46 && e.keyCode !== 9;

                    if (field.val().length >= charLimit && field[0].selectionStart === field[0].selectionEnd && notDeleteOrTabKey && !arrowKeys) {
                        e.preventDefault();
                        newTrimmedValue = field.val().substring(0, charLimit);

                        field.val(newTrimmedValue);

                        return false;
                    }
                    // }
                } else { // Is not a number
                    e.preventDefault();
                }
            });
        },

        limitCharacters: function ($field, charLimit) {
            $field.each(function () {
                if (this.isLimitCharacters) {
                    return;
                }

                this.isLimitCharacters = true;
                this.charLimit = charLimit;

                $(this).on('keydown.limitCharacters', function (e) {
                    var arrowKeys = e.keyCode > 36 && e.keyCode < 40,
                        notDeleteOrTabKey = e.keyCode !== 8 && e.keyCode !== 46 && e.keyCode !== 9;

                    if (this.value.length >= this.charLimit && this.selectionStart === this.selectionEnd && notDeleteOrTabKey && !arrowKeys) {
                        e.preventDefault();

                        // udpated with trimmed value
                        this.value = this.value.substring(0, this.charLimit);

                        return false;
                    }
                });
            });
        },

        limitCharactersNumber: function ($field, charLimit) {
            $field.each(function () {
                if (this.isLimitCharacters) {
                    return;
                }

                this.isLimitCharacters = true;
                this.charLimit = charLimit;

                $(this).on('keydown.limitCharacters', function (e) {
                    var arrowKeys = e.keyCode > 36 && e.keyCode < 40,
                        notDeleteOrTabKey = e.keyCode !== 8 && e.keyCode !== 46 && e.keyCode !== 9;

                    if (this.value.length >= this.charLimit && notDeleteOrTabKey && !arrowKeys) {
                        e.preventDefault();

                        // udpated with trimmed value
                        this.value = this.value.substring(0, this.charLimit);

                        return false;
                    }
                });
            });
        },

        updatePlaceholders: function (context, forceShow, bottomPx) {
            $('[placeholder]', context).each(function () {
                if (!$(this).parents('.placeholder').length) {
                    $(this).placeholder({
                        inputWrapper: '<div class="placeholder" />',
                        placeholderCSS: {
                            'position': 'absolute',
                            'top': 'auto',
                            'right': 'auto',
                            'bottom': bottomPx || '0',
                            'left': '0'
                        }
                    });
                }
            });
        },

        customGroupValidation: function (element) {
            var bResult = true,
                myCustomGroup = ['companyname', 'flatnumber', 'buildingname'],
                self = this;
            $.each(myCustomGroup, function (ord, key) {
                var $elem = $(self.currentForm).find('input[name="' + key + '"]');
                bResult = $.validator.methods.checkEditableAddressesInvalidCharacters($elem.val(), $elem[0]);
                if (!bResult) {
                    return false;
                }
            });
            return bResult;
        },
        removeCustomGroupErrors: function (myCustomGroup) {
            var self = this;
            $.each(myCustomGroup, function (ord, key) {
                var $elem = $(self.currentForm).find('input[name="' + key + '"]');
                if (breakpoint.mobile) {
                    $elem.prev('.error').remove();
                } else {
                    $elem.closest('.field-wrapper').prev('.error').remove();
                }
            });
        },
        removeCustomGroupFieldErrorClass: function (myCustomGroup, $form) {
            var self = this;
            $.each(myCustomGroup, function (ord, key) {
                var $elem = $form ?
                    $form.find('input[name="' + key + '"]') :
                    $(self.currentForm).find('input[name="' + key + '"]');

                if (!$elem.hasClass('failedInvalidChars')) {
                    $elem.removeClass('error');
                }
            });
        },

        /*
         * checksum calculation for GTIN-8, GTIN-12, GTIN-13, GTIN-14, and SSCC
         * based on http://www.gs1.org/barcodes/support/check_digit_calculator
         */
        checkGTIN: function checkGTIN(gtin) {
            var iLastDigit = 0,
                iCheckSum = 0,
                aGTINchars = [],
                iOddTotal = 0,
                iEvenTotal = 0,
                i = 0;

            if (gtin.length < 8 || gtin.length > 18 || (gtin.length !== 8 && gtin.length !== 12 && gtin.length !== 13 && gtin.length !== 14 && gtin.length !== 18)) {
                return false;
            }

            iLastDigit = Number(gtin.substring(gtin.length - 1));

            if (isNaN(iLastDigit)) {
                return false;
            }

            aGTINchars = gtin.substring(0, gtin.length - 1).split('').reverse();

            for (i = 0; i < aGTINchars.length; i++) {
                if (isNaN(aGTINchars[i])) {
                    return false;
                }
                if (i % 2 === 0) {
                    iOddTotal += Number(aGTINchars[i]) * 3;
                } else {
                    iEvenTotal += Number(aGTINchars[i]);
                }
            }

            iCheckSum = (10 - ((iEvenTotal + iOddTotal) % 10)) % 10;

            return iCheckSum === iLastDigit;
        }

    };
    return validationExtras;
});

/*jslint plusplus: true, nomen: true, indent: 4 */
/*globals window,document,console,define,require */
define('modules/chip-and-pin/kmf-io', ['modules/chip-and-pin/user-session', 'modules/settings/common', 'modules/validation'], function (userSession, SETTINGS, validationExtras) {
    'use strict';

    var callbacks = {},
        kmfIO = {
            showDialog: function showDialog(sID, sTitle, sBodyText, sYesText, sNoText, callback) {
                if (sID === 'paymentFailed') {
                    window.dialogResult = function (sID, sButton) {
                        if (sButton === 'NO') {
                            window.external.navigateTo('ATTRACTLOOP', '');
                        }
                    };
                } else {
                    window.dialogResult = callback;
                }

                if (typeof window.external.showDialog === 'unknown') {
                    window.external.showDialog(sID, sTitle, sBodyText, sYesText, sNoText);
                }
            },
            registerCallback: function registerCallback(callbackId, callback) {
                if (typeof callback === 'function') {
                    callbacks[callbackId] = callback;
                }
            },
            showKeyboard: function showKeyboard() {
                if (typeof window.external.showKeyboard === 'unknown') {
                    window.external.showKeyboard(1);
                }
            },
            hideKeyboard: function hideKeyboard() {
                if (typeof window.external.showKeyboard === 'unknown') {
                    window.external.showKeyboard(0);
                }
            },
            triggerPaymentDevice: function triggerPaymentDevice(sRef, sAmount) {
                var oResult;
                if (typeof window.external.debitCard === 'unknown' || typeof window.external.print === "undefined" ) {
                    oResult = window.external.debitCardAsync(sAmount, sRef);
                }
            },
            printReceipt: function printReceipt(aPrinterCommands) {
                var aPrinterCommand;
                if (typeof window.external.print === "unknown") {
                    if (window.external.printerStatus === 'OK') {
                        while (aPrinterCommands.length) {
                            aPrinterCommand = aPrinterCommands.shift();
                            if (aPrinterCommand.command && aPrinterCommand.data) {
                                window.external.print(aPrinterCommand.command, aPrinterCommand.data);
                            }
                        }
                        window.external.print('Print', '');
                    }
                }
            },
            checkKMFExists: function checkKMFExists() {
            	return window.external && window.external.navigationPanel;
            },
            enableBackButton: function enableBackButton() {
            	var self = kmfIO;
            	if (self.checkKMFExists()) {
            		window.external.navigationPanel.backEnabled = true;
                }
            },
            disableBackButton: function enableBackButton() {
            	var self = kmfIO;
            	if (self.checkKMFExists()) {
            		window.external.navigationPanel.backEnabled = false;
                }
            },
            enableBasketButton: function enableBackButton(qty) {
              	var self = kmfIO;

                if (self.checkKMFExists()) {
                    var basketQty = qty ? parseInt(qty, 10) : self.getBasketQtyFromDom();

                    if (basketQty > 0) {
                        window.external.navigationPanel.basketEnabled = true;
                        window.external.navigationPanel.basketCountVisible = true;
                        window.external.navigationPanel.basketCount = basketQty;
                    } else {
                        window.external.navigationPanel.basketEnabled = false;
                        window.external.navigationPanel.basketCountVisible = false;
                    }
                }
            },
            disableBasketButton: function enableBackButton() {
            	var self = kmfIO;
            	if (self.checkKMFExists()) {
            		window.external.navigationPanel.basketEnabled = false;
                }
            },
            enableHomeButton: function enableBackButton() {
            	var self = kmfIO;
            	if (self.checkKMFExists()) {
            		window.external.navigationPanel.homeEnabled = true;
                }
            },
            disableHomeButton: function enableBackButton() {
            	var self = kmfIO;
            	if (self.checkKMFExists()) {
            		window.external.navigationPanel.homeEnabled = false;
                }
            },
            searchGTIN: function searchGTIN(barcode) {
                var bIsGTIN = false,
                    sValue = barcode;
                if (barcode.length < 14) {
                    do {
                        sValue = '0' + sValue;
                    } while (sValue.length < 14);
                }
                bIsGTIN = validationExtras.checkGTIN(sValue)
                if (bIsGTIN) {
                    document.getElementById('search-field').value = sValue;
                    document.getElementById('search-submit').click();
                }
            },
            getBasketQtyFromDom: function getBasketQtyFromDom () {
                var getBasketQty = $('#masthead .basket-items').text();
                if (getBasketQty === '') {
                    return false;
                }
                return parseInt(getBasketQty, 10);
            }
        };

    window.basketButtonPressed = function basketButtonPressed() {
    	window.location.href = SETTINGS.CONSTANTS.URL.BASKET;
	};

	window.backButtonPressed = function backButtonPressed() {
    	window.history.go(-1);
	};

	window.cancelButtonPressed = function cancelButtonPressed() {
		if(window.TescoData && window.TescoData.ChipAndPin && window.TescoData.ChipAndPin.checkoutData && window.TescoData.ChipAndPin.checkoutData.sessionLogoutForm){
			var logoutForm = window.TescoData.ChipAndPin.checkoutData.sessionLogoutForm;

			$.ajax({
			  type: "POST",
			  url: SETTINGS.CONSTANTS.URL.KIOSK_DATA,
			  data: $(logoutForm).serialize()
			});
		}
	};

    window.scannerCallback = function scannerCallback(oResult) {
        if (oResult.barcode) {
            if (userSession.canScanClubcard) {
                if (userSession.getCurrentSection() === 'login') {
                    if (callbacks.loginClubcardScan) {
                        callbacks.loginClubcardScan(oResult.barcode);
                        return;
                    }
                }
            }

            if (userSession.canScanGiftcard) {
                if (userSession.getCurrentSection() === 'review') {
                    if (callbacks.canScanGiftcard) {
                        callbacks.canScanGiftcard(oResult.barcode);
                        return;
                    }
                }
            }

            if (userSession.canScanBarcode && !userSession.isCheckout()) {
                kmfIO.searchGTIN(oResult.barcode);
            }
        }
    };

    window.debitCardAsyncResult = function debitCardAsyncResult(oResult) {
        if (typeof callbacks.paymentDeviceResponse === 'function') {
            callbacks.paymentDeviceResponse(oResult);
        }
    };

    return {
        /**
         * @method registerCallback
         * @memberof kmfIO
         * @param {string} callbackId - ID of callback
         * @param {function} callback - Function that should be executed when KMF device has finished processing
         */
        registerCallback: kmfIO.registerCallback,
        /**
         * @method showKeyboard
         * @memberof kmfIO
         *
         */
        showKeyboard: kmfIO.showKeyboard,
        /**
         * @method hideKeyboard
         * @memberof kmfIO
         *
         */
        hideKeyboard: kmfIO.hideKeyboard,
        /**
         * @method showDialog
         * @memberof kmfIO
         * @param {string} sID - ID for dialog box
         * @param {string} sTitle - Title of dialog box
         * @param {string} sBodyText - Body text of dialog box
         * @param {string} sYesText - label for "Yes" button
         * @param {string} sNoText - label for "No" button
         * @param {function} callback - Function that should be executed when either Yes or No button is pressed, callback returns sID and sButton (Yes or No)
         */
        showDialog: kmfIO.showDialog,
        /**
         * @method triggerPaymentDevice
         * @memberof kmfIO
         * @param {string} sAmount - Amount in pounds
         * @param {string} sRef - Unique reference of transaction
         */
        triggerPaymentDevice: kmfIO.triggerPaymentDevice,
        /**
         * @method printReceipt
         * @memberof kmfIO
         * @param {Array<PrinterCommand>} aPrinterCommands - Print
         */
        printReceipt: kmfIO.printReceipt,
        /**
         * @method enableBackButton
         * @memberof kmfIO
         */
        enableBackButton: kmfIO.enableBackButton,
        /**
         * @method enableBasketButton
         * @memberof kmfIO
         */
        enableBasketButton: kmfIO.enableBasketButton,
        /**
         * @method enableHomeButton
         * @memberof kmfIO
         */
        enableHomeButton: kmfIO.enableHomeButton,
        /**
         * @method disableBackButton
         * @memberof kmfIO
         */
        disableBackButton: kmfIO.disableBackButton,
        /**
         * @method disableBasketButton
         * @memberof kmfIO
         */
        disableBasketButton: kmfIO.disableBasketButton,
        /**
         * @method disableHomeButton
         * @memberof kmfIO
         */
        disableHomeButton: kmfIO.disableHomeButton,
        /**
         * @method checkKMFExists
         * @memberof kmfIO
         */
        checkKMFExists: kmfIO.checkKMFExists
    };
});

/*jslint plusplus: true, nomen: true */
/*globals window,document,console,define,require, $ */
define('modules/toggle-expand-collapse/common', [], function () {
    'use strict';

    /**
    * @constructor
    * @param {object} oSettings Required
    * @param {string} oSettings.sToggleContainer Required
    * @param {string} oSettings.sToggleTriggerElement Required
    * @param {string} oSettings.sToggleElementParent Required
    */
    function ToggleExpandCollapse(oSettings) {
        if (oSettings === null || oSettings === undefined ||
                oSettings.sToggleContainer === undefined ||
                oSettings.sToggleTriggerElement === undefined ||
                oSettings.sToggleElementParent === undefined) {
            return;
        }

        this.$toggleContainer = $(oSettings.sToggleContainer);
        this.$toggleTriggerElement = $(oSettings.sToggleTriggerElement);
        this.sToggleElementParent = oSettings.sToggleElementParent;
        this.sToggleTriggerElement = oSettings.sToggleTriggerElement;
        this.sToggleParentClassName =
            oSettings.sToggleParentClassName || 'toggle-parent';
        this.sToggleCustomEventName =
            oSettings.sToggleCustomEventName || 'ToggleStateUpdated';
        this.sSetExpandedCSSClassName =
            oSettings.sSetExpandedCSSClassName || 'toggle-expand';
        this.sSetCollapsedCSSClassName =
            oSettings.sSetCollapsedCSSClassName || 'toggle-collapse';
        this.sToggleContainer =
            oSettings.sToggleContainer;
        this.bToggleAnimationEnabled =
            oSettings.bToggleAnimationEnabled !== undefined ?
                    oSettings.bToggleAnimationEnabled : true;
        this.bAccordionEnabled =
            oSettings.bAccordionEnabled !== undefined ? oSettings.bAccordionEnabled : true;
        this.bEnableCustomEvent =
            oSettings.bEnableCustomEvent !== undefined ? oSettings.bEnableCustomEvent : false;
    }

    ToggleExpandCollapse.prototype = {
        constructor: ToggleExpandCollapse,

        isToggleEventBound: function isToggleEventBound() {
            var self = this, oEvents, aClickEvents, i;

            if (self.$toggleContainer.length) {
                oEvents = $._data($(self.$toggleContainer)[0], 'events');
                if (oEvents !== undefined) {
                    if (oEvents.click) {
                        aClickEvents = oEvents.click;
                        for (i = 0; i < aClickEvents.length; i++) {
                            if (aClickEvents[i].namespace === "toggleExpandCollapse") {
                                return true;
                            }
                        }
                    }
                }
            }
        },

        bindToggleEvents: function bindToggleEvents() {
            var self = this;

            self.$toggleContainer.on('click.toggleExpandCollapse',
                self.sToggleTriggerElement, function (e) {
                    self.toggleElement(e);
                    e.preventDefault();
                });
            self.$toggleContainer.addClass(self.sToggleParentClassName);
            self.enableAnimation();
        },

        enableAnimation: function enableAnimation() {
            var $toggleParentElementsCollection = this.$toggleContainer.
                find(this.sToggleElementParent);
            if (this.bToggleAnimationEnabled) {
                $toggleParentElementsCollection.addClass('animate');
            }
        },

        getTarget: function getTarget(e) {
            var $targetElement = $(e.target);
            return $targetElement;
        },

        getToggleState: function getToggleState($target) {
            var bSetExpandeded = $target.closest($(this.sToggleElementParent)).
                hasClass(this.sSetExpandedCSSClassName) ? true : false;
            return bSetExpandeded;
        },

        toggleElement: function toggleElement(e) {
            var $targetElement = this.getTarget(e);
            if (this.getToggleState($targetElement) === false) {
                if (this.bAccordionEnabled) {
                    this.setAllCollapsed();
                }
                this.setExpanded($targetElement);
            } else {
                this.setCollapsed($targetElement);
            }
        },

        setExpanded: function setExpanded($target) {
            $target.closest($(this.sToggleElementParent))
                .addClass(this.sSetExpandedCSSClassName)
                .attr('data-expanded', true);
            if (this.bEnableCustomEvent) {
                this.triggerCustomEvent('toggle-expand');
            }
        },

        setCollapsed: function setCollapsed($target) {
            $target.closest($(this.sToggleElementParent))
                .removeClass(this.sSetExpandedCSSClassName)
                .removeAttr('data-expanded');
            if (this.bEnableCustomEvent) {
                this.triggerCustomEvent('toggle-collapse');
            }
        },

        setAllCollapsed: function setAllCollapsed() {
            this.$toggleContainer.find($(this.sToggleElementParent)).
                removeClass(this.sSetExpandedCSSClassName);
        },

        triggerCustomEvent: function triggerCustomEvent(sEventType) {
            $(window).trigger(this.sToggleCustomEventName, {
                toggleContainer: this.$toggleContainer,
                toggleTriggerElement: this.$toggleTriggerElement,
                toggleElementParent: $(this.sToggleElementParent),
                toggleEventType: sEventType
            });
        },

        unbindToggleEvents: function unbindToggleEvents() {
            var self = this;

            self.$toggleContainer.off('click.toggleExpandCollapse',
                self.sToggleTriggerElement);
            self.$toggleContainer.removeClass(self.sToggleParentClassName);
        },

        init: function init() {
            if (this.isToggleEventBound() === true) {
                this.unbindToggleEvents();
            }
            this.bindToggleEvents();
        }
    };

    return ToggleExpandCollapse;
});

/*global define:true,window */
/*jslint plusplus: true */
define('modules/jargon-buster/common', ['domlib', 'modules/tesco.analytics', 'modules/toggle-expand-collapse/common', 'modules/common'], function ($, analytics, ToggleExpandCollapse, common) {
    'use strict';

    var sDataAttr = 'data-internal-attr-name',
        sCustomExpandCollapseEvent = 'jbExpandCollapseOpen',
        $productSpecContainer,
        fnInit,
        fnRetrieveData,
        fnProcessJargonData,
        fnAddToolTipMessage,
        fnActivateJargonPanel,
        fnSendTracking,
        fnBindEvents,
        fnToggleExpandCollapse,
        fnJargonBusterUI,
        fnReInit,
        oJsonData,
        oShowMore,
        bInitiated = false;

    fnRetrieveData = function retrieveData() {
        var sUrl = (window.globalStaticJSPath !== undefined ? window.globalStaticJSPath : '/assets/js/') + 'data/JargonDataJSON.xml';
        $.ajax({
            url: sUrl,
            method: 'GET',
            dataType: "json",
            beforeSend: function () {
                var args = arguments;
                args[1].url = sUrl;
            },
            success: function (oReturnedData) {
                oJsonData = oReturnedData;
                fnProcessJargonData(oReturnedData);
            },
            error: function () {
                //console.log('Unable to load Jargon Data.');
                return;
            }
        });
    };

    fnProcessJargonData = function processJargonData() {
        var oJardonData,
            oInternalAttributes = {},
            sAttrName,
            sBccL4Cat,
            $bccL4Cat,
            $self;

        oJardonData = Array.isArray(oJsonData) === true ? oJsonData[0] : null;
        $productSpecContainer = $('#product-spec-container');
        $bccL4Cat = $('#breadcrumb li:eq(3)');

        if (oJardonData === null || oJardonData.length === 0) {
            //console.log('Jargon Buster data empty');
            return;
        }

        if ($bccL4Cat.length > 0) {
            sBccL4Cat = $.trim($('a', $bccL4Cat).text());
        }

        if (oJardonData.jargonDisplayInfo !== undefined && oJardonData.jargonDisplayInfo.internalAttributes !== undefined) {
            oInternalAttributes = oJardonData.jargonDisplayInfo.internalAttributes;
        }

        if ($productSpecContainer.length > 0 && oInternalAttributes.length > 0) {
            $('[' + sDataAttr + ']', $productSpecContainer).each(function () {
                var i, j;
                $self = $(this);
                sAttrName = $self.attr(sDataAttr);
                for (i in oInternalAttributes) {
                    if (oInternalAttributes.hasOwnProperty(i)) {
                        if (oInternalAttributes[i].name === sAttrName) {
                            if (oInternalAttributes[i].bccl4cats) {
                                for (j in oInternalAttributes[i].bccl4cats) {
                                    if (oInternalAttributes[i].bccl4cats.hasOwnProperty(j)) {
                                        if (sBccL4Cat === oInternalAttributes[i].bccl4cats[j].name) {
                                            fnJargonBusterUI($self, oInternalAttributes[i].bccl4cats[j].jargonText);
                                        }
                                    }
                                }
                            } else {
                                fnJargonBusterUI($self, oInternalAttributes[i].jargonText);
                            }
                        }
                    }
                }
            });

            fnToggleExpandCollapse();

            if (!bInitiated) {
                fnBindEvents();
                oShowMore = $productSpecContainer.data('ShowMore') || {};
                bInitiated = true;
            }
        }
    };

    fnJargonBusterUI = function jargonBusterUI($specRow, sMessage) {
        fnActivateJargonPanel($specRow);
        fnAddToolTipMessage($specRow, sMessage);
    };

    fnToggleExpandCollapse = function toggleExpandCollapse() {
        var oTEC = new ToggleExpandCollapse({
            sToggleContainer: '.product-spec-row-container.jbActive',
            sToggleElementParent: '.product-spec-row-container.jbActive',
            sToggleTriggerElement: '.product-spec-row',
            bAccordionEnabled: true,
            bEnableCustomEvent: true,
            sToggleCustomEventName: sCustomExpandCollapseEvent
        });
        oTEC.init();
    };

    fnSendTracking = function sendTracking($specRow) {
        var sEvar59,
            oWebAnalytics,
            aAnalyticsData;
        if ($specRow.length > 0) {
            sEvar59 = 'Jargon buster:' + $specRow.attr(sDataAttr);
            oWebAnalytics = new analytics.WebMetrics();
            aAnalyticsData = [{
                'eVar59': sEvar59,
                'events': 'event32'
            }];
            oWebAnalytics.submit(aAnalyticsData);
        }
    };

    fnBindEvents = function bindEvents() {
        var $specRow = null;

        function updateSetWrapperHeights() {
            oShowMore.fnCalcSelectorHeight();
            oShowMore.fnSetWrapperHeight(oShowMore.iSelectorHeight);
        }

        $productSpecContainer.on('click', '.jbActive .product-spec-row', function () {
            if (oShowMore !== undefined && oShowMore.bShowMore !== undefined && oShowMore.bShowMore) {
                if (window.Modernizr && window.Modernizr.csstransitions) {
                    $('.product-spec-description').one('transitionend', function () {
                        updateSetWrapperHeights();
                    });
                } else {
                    updateSetWrapperHeights();
                }
            }
            $specRow = $(this).parents('.toggle-expand');
            if ($specRow.length > 0) {
                fnSendTracking($specRow);
            }
        });
    };

    fnActivateJargonPanel = function activateJargonPanel($specRow) {
        $specRow.addClass('jbActive');
    };

    fnAddToolTipMessage = function addToolTipMessage($specRow, sJargonText) {
        $('.product-spec-description', $specRow).text(sJargonText);
    };

    fnReInit = function reInit() {
        fnProcessJargonData();
    };

    fnInit = function init() {
        if (common.isPage('PDP')) {
            fnRetrieveData();
        }
    };

    return {
        init: fnInit,
        reInit: fnReInit
    };

});
/*globals define,require,window */
/*jslint plusplus: true, regexp: true, unparam: true */
define('modules/product-description/wishlist', ['domlib'], function ($) {
    'use strict';

    var wishlist = {
        init: function init() {
            $(".product-description").find(".add-to-wishlist").on("click tap", function (e) {
                if ($(".user-wishlists").length) {
                    e.preventDefault();
                    require(['modules/buy-from/common'], function (buyFrom) {
                        buyFrom.triggerTooltip($(".add-to-wishlist"));
                    });

                }
            });
        },
        asyncBlockCallbacks: function asyncBlockCallbacks() {
            var oCallbacks = {},
                self = this;
            oCallbacks.success = function (oResp) {
                if (typeof oResp === "string") {
                    oResp = $.parseJSON(oResp);
                }
                $('.wishlist-button').replaceWith(oResp[this.sBlockID]);
                self.init();
            };
            return oCallbacks;
        }
    };
    return wishlist;
});
/*globals define, window, document */
/*jslint nomen: true */
define('modules/show-more/ShowMore', [
    'domlib',
    'modules/tesco.analytics',
    'modules/breakpoint'
    ], function ($, analytics, breakpoint) {
    'use strict';

    var ShowMore,
        analyticsTrack;

    /**
     * Class that applies expand/collapse functionality with a fadeout to an
     * element
     *
     * @param {object} an object with the properties 'selector' and 'height'
     * 'selector' {string} the id or class of an DOM element to apply the Show
     * More functionality 'height' {int} the default height the Show More should
     * be set to when collapsed
     */
    ShowMore = function (oConfig) {
        this.sShowMoreSelector = oConfig.selector || null;
        this.$showMoreSelector = $(this.sShowMoreSelector);
        this.iDefaultWrapperHeight = oConfig.height || 250;
        this.$showMoreWrapper = null;
        this.$showMoreFooter = null;
        this.$showMoreButton = null;
        this.$showMoreBtnLabel = null;
        this.$fadeMask = null;
        this.isOpen = false;
        this.isInit = false;
        this.iSelectorHeight = null;
        this.iShowMoreWrapperOffsetTop = null;
        this.iWrapperHeight = null;
        this.sShowMoreWrapper = '<div class="show-more-wrapper"></div>';
        this.sShowMoreFooter = '<div class="show-more-footer"><button ' +
            'type="button" class="button secondary centered"><span></span></button></div>';
        this.sShowMoreText = 'Show more';
        this.sShowLessText = 'Show less';
        this.sFadeMask = '<div class="fade-mask"></div>';
        this.hasDOMSubTreeModifiedListener = oConfig.subtreeListener || false;

        if (this.$showMoreSelector && this.$showMoreSelector.length) {
            this.fnSetDataAttr();
            this.bindResizeEvent();

            if (this.hasDOMSubTreeModifiedListener) {
                this.bindDOMSubTreeModified();
            }
        }
    };

    ShowMore.prototype.fnBindEvents = function () {
        var self = this;

        this.$showMoreButton.on('click.showMore', function () {
            self.fnToggleShowMore();
        });

        this.$showMoreWrapper.on(
            'transitionend',
            this.removeOverflowHidden.bind(this)
        );
    };

    ShowMore.prototype.removeOverflowHidden = function ($event) {
        var sourceElement = $event.originalEvent.srcElement
                ? $event.originalEvent.srcElement
                : $event.originalEvent.target;

        if (sourceElement === this.$showMoreWrapper[0]
            && $event.originalEvent.propertyName === 'height'
            && this.isOpen) {
          this.$showMoreWrapper.css('overflow', 'visible');
        }
    };

    ShowMore.prototype.bindDOMSubTreeModified = function () {
        var self = this;

        self.$showMoreSelector
            .on('DOMSubtreeModified.showMore', function () {
              clearTimeout(timer);
              var timer = setTimeout(function() {self.toggleInit();}, 20);
            });
    };

    ShowMore.prototype.bindResizeEvent = function () {
        var self = this;

        $(window)
            .on('resize.showMore', function () {
                self.toggleInit();
            });
    };

    ShowMore.prototype.toggleInit = function () {
        var self = this,
            resizeTimer;

        window.clearTimeout(resizeTimer);
        resizeTimer = window.setTimeout(function () {
            self.fnCalcSelectorHeight();
            self.fnCalcWrapperHeight();

            if (self.isInit && !self.fnCheckShowMoreHeight()) {
                self.destroy();
                return;
            }

            if (!self.isInit) {
                self.fnInit();
                return;
            }

            if (!self.isOpen) {
                self.fnSetWrapperHeight(self.iWrapperHeight);
            } else {
                self.fnSetWrapperHeight(self.iSelectorHeight);
            }
        }, 200);
    };

    ShowMore.prototype.fnCalcShowMoreWrapperOffsetTop = function () {
        this.iShowMoreWrapperOffsetTop = this.$showMoreWrapper.offset()
            .top;
    };

    ShowMore.prototype.fnCompareShowMoreAndWindowOffsetTop = function () {
        var iWindowOffsetTop = $(window)
            .scrollTop();
        if (this.iShowMoreWrapperOffsetTop < iWindowOffsetTop) {
            return true;
        }
    };

    ShowMore.prototype.fnScrollToTopOfShowMoreWrapper = function () {
        var self = this,
            $masthead = $('#masthead-wrapper'),
            iMastheadHeight = $masthead.data('outerHeight') + 10;

        $('html, body').animate({
            scrollTop: self.iShowMoreWrapperOffsetTop - iMastheadHeight
        }, 200, function () {
            window.setTimeout(function () {
                self.fnSetShowLess();
            }, 100);
        });
    };

    ShowMore.prototype.fnCalcWrapperHeight = function () {
        this.iWrapperHeight = (breakpoint.newViewport === 'largedesktop' ||
            breakpoint.newViewport === 'desktop') ? this.iDefaultWrapperHeight : 350;
    };

    ShowMore.prototype.fnCalcSelectorHeight = function () {
        var i,
            iHeight = 0,
            contents = this.isInit ? this.$showMoreWrapper.children() : this.$showMoreSelector.children(),
            iCount = contents.length;

        for (i = 0; i < iCount; i += 1) {
            if (!$(contents[i]).hasClass('fade-mask') && $(contents[i]).css('display') !== 'none') {
                iHeight += $(contents[i]).outerHeight(true);
            }
        }

        this.iSelectorHeight = iHeight;
    };

    ShowMore.prototype.fnSetWrapperHeight = function (iHeight) {
        var value = iHeight === 'auto' ? 'auto' : iHeight + 'px';

        this.$showMoreWrapper.css({
            height: value
        });
    };

    ShowMore.prototype.fnSetShowMore = function () {
        if (!window.Modernizr.csstransitions) {
            this.$showMoreWrapper.css('overflow', 'visible');
        }
        this.fnSetWrapperHeight(this.iSelectorHeight + 30);
        this.$fadeMask.addClass('hide');
        this.$showMoreBtnLabel.text(this.sShowLessText);
        this.isOpen = true;
    };

    ShowMore.prototype.fnSetShowLess = function () {
        this.$showMoreWrapper.css('overflow', '');
        this.fnSetWrapperHeight(this.iWrapperHeight);
        this.$fadeMask.removeClass('hide');
        this.$showMoreBtnLabel.text(this.sShowMoreText);
        this.isOpen = false;
    };

    ShowMore.prototype.fnToggleShowMore = function () {
        var sSelectorString, sSelectorTrimmed, sShowMoreLabel;

        if (this.isOpen) {
            this.fnCalcShowMoreWrapperOffsetTop();
            if (this.fnCompareShowMoreAndWindowOffsetTop()) {
                this.fnScrollToTopOfShowMoreWrapper();
            } else {
                this.fnSetShowLess();
            }
        } else {
            this.fnSetShowMore();
            sSelectorString = this.$showMoreSelector.selector;
            sSelectorTrimmed = sSelectorString.substring(1).replace(/-/g, " ");
            sShowMoreLabel = this.sShowMoreText;
            analyticsTrack(sSelectorTrimmed, sShowMoreLabel);
        }
    };

    ShowMore.prototype.fnInjectHtmlElements = function () {
        this.$showMoreSelector.wrapInner(this.sShowMoreWrapper);
        this.$showMoreWrapper = this.$showMoreSelector.children();
        this.$showMoreWrapper.after(this.sShowMoreFooter);
        this.$showMoreWrapper.append(this.sFadeMask);
        this.$showMoreFooter = this.$showMoreWrapper.next('.show-more-footer');
        this.$showMoreButton = this.$showMoreFooter.find('button');
        this.$showMoreBtnLabel = this.$showMoreButton.find('span');
        this.$fadeMask = this.$showMoreWrapper.find('.fade-mask');
    };

    ShowMore.prototype.fnCheckShowMoreHeight = function () {
        if ((this.iSelectorHeight * 0.8) >= this.iWrapperHeight) {
            return true;
        }
    };

    ShowMore.prototype.fnSetDataAttr = function () {
        this.$showMoreSelector.data('ShowMore', this);
    };

    ShowMore.prototype.fnInit = function () {
        if (!this.$showMoreSelector || !this.$showMoreSelector.length) {
            return;
        }

        // don't allow nested show/hide
        if (this.$showMoreSelector.parents().hasClass('show-more-wrapper')) {
            return;
        }

        this.fnCalcWrapperHeight();
        this.fnCalcSelectorHeight();

        if (this.fnCheckShowMoreHeight()) {
            this.fnInjectHtmlElements();
            this.fnBindEvents();
            this.fnSetShowLess();
            this.isInit = true;
        }
    };

    ShowMore.prototype.destroy = function (opt_bool) {
        if (opt_bool) {
            this.unbindResizeEvent();
        }
        this.removeHtmlElements();
        this.isInit = false;
    };

    ShowMore.prototype.removeHtmlElements = function () {
        this.$fadeMask.remove();
        this.$showMoreWrapper.contents().unwrap();
        this.$showMoreFooter.remove();
    };

    ShowMore.prototype.unbindResizeEvent = function () {
        $(window).off('resize.showMore');
    };

    analyticsTrack = function analyticsTrack(container, label) {
        // send analytics data on click
        var _oWebAnalytics = new analytics.WebMetrics(),
            v = [{
                'prop19': label,
                'eVar45': label,
                'prop42': 'pdp - ' + container + ' - show more',
                'eVar59': 'pdp - ' + container + ' - show more',
                'events': 'event45'
            }];
        _oWebAnalytics.submit(v);
    };

    return ShowMore;
});

/*globals define, window, document */
define('modules/show-more/ShowMoreHandler', [
    'modules/show-more/ShowMore'
], function (ShowMore) {
    'use strict';

    //
    // ShowMoreHandler class
    // -------------------------------------
    var ShowMoreHandler = function (aShowMoreConfig) {
        this.aShowMoreConfig = aShowMoreConfig;
    };

    ShowMoreHandler.prototype.init = function () {
        var i,
            oShowMore,
            array = this.aShowMoreConfig,
            iCount = array.length;

        if (!Array.isArray(array)) {
            return;
        }

        for (i = 0; i < iCount; i += 1) {
            oShowMore = new ShowMore(array[i]);
            oShowMore.fnInit();
        }
    };

    return ShowMoreHandler;
});

/* globals define, window, document */
define('modules/show-more/ShowMoreConfig', [],function () {
  'use strict';
    //
    // ShowMoreConfig
    // -------------------------------------
  return [{
    selector: '.product-description-block',
    height: 400
  }, {
    selector: '.product-spec-block',
    height: 600,
    subtreeListener: true
  }, {
    selector: '.product-spec-block-2',
    height: 600
  }, {
    selector: '.biography-block',
    height: 400
  }, {
    selector: '.synopsis-block',
    height: 400
  }, {
    selector: '.sitewide-promo-block',
    height: 400
  }];
});

/*jslint plusplus:true */
define('modules/html-parser/HtmlParser', ['domlib'], function ($) {
    'use strict';

    var fnCreateJqueryObjFromString,
        fnParseMarkupString,
        oConfig,
        fnParseSelectors,
        fnParseMultipleSelectors,
        fnParseSingleSelector,
        fnCloneObj,
        fnTrim,
        fnReplaceBreaksWithPtags,
        fnRemoveEmptyTags,
        fnReplaceObjWithClone,
        fnParseJqueryObj;

    fnCreateJqueryObjFromString = function createJqueryObjFromString(sMarkup) {
        return $($.parseHTML(sMarkup));
    };

    fnParseMarkupString = function parseString(sMarkup) {
        if (typeof sMarkup === 'string' && $.trim(sMarkup).length > 0) {
            var $obj = fnRemoveEmptyTags(fnReplaceBreaksWithPtags(fnTrim(fnCreateJqueryObjFromString(sMarkup))));
            return $obj[0].outerHTML;
        }
    };

    fnParseSelectors = function parseSelectors(mConfig) {
        if (Array.isArray(mConfig)) {
            fnParseMultipleSelectors(mConfig);
        } else if (typeof mConfig === 'string') {
            fnParseSingleSelector(mConfig);
        } else {
            throw new Error("The parameter passed to the HtmlParser is not valid, it should be an array or a string.");
        }
    };

    fnParseMultipleSelectors = function parseMultipleSelectors(aConfig) {
        var i;
        for (i = 0; i < aConfig.length; i++) {
            fnParseSingleSelector(aConfig[i]);
        }
    };

    fnParseSingleSelector = function parseSingleSelector(sSelector) {
        if (!$(sSelector).length) {
            throw new Error("The given selector is not present in the DOM.");
        }
        $(sSelector).each(function () {
            if (!$.trim($(this)[0].innerHTML).length) {
                throw new Error("The element does not have any markup in it to parse.");
            }
            fnParseJqueryObj($(this));
        });
    };

    fnCloneObj = function cloneObj($obj) {
        var $clone = $obj.clone(true);
        oConfig = {
            obj: $obj,
            clone: $clone
        };
        return oConfig.clone;
    };

    fnTrim = function trimJqueryObjHtml($obj) {
        $obj[0].innerHTML = $.trim($obj[0].innerHTML);
        return $obj;
    };

    fnReplaceBreaksWithPtags = function replaceBreaksWithPtags($obj) {
        var sMarkup = '<p>' + $obj[0].innerHTML.replace(/<br><br>/gi, '</p><p>') + '</p>';
        $obj[0].innerHTML = sMarkup;
        return $obj;
    };

    fnRemoveEmptyTags = function removeEmptyTags($obj) {
        $obj.find('*').each(function () {
            if ($.trim($(this)[0].innerHTML).length === 0) {
                $(this).remove();
            }
        });
        return $obj;
    };

    fnReplaceObjWithClone = function replaceObjWithClone() {
        oConfig.obj[0].innerHTML = oConfig.clone[0].innerHTML;
        return oConfig.obj;
    };

    fnParseJqueryObj = function parseJqueryObj($obj) {
        fnRemoveEmptyTags(fnReplaceBreaksWithPtags(fnTrim(fnCloneObj($obj))));
        fnReplaceObjWithClone();
    };

    return {
        parseMarkupString: fnParseMarkupString,
        parseSelectors: fnParseSelectors
    };
});
/*globals define,require,window */
define('modules/product-variants/ProductVariant',[], function () {
    "use strict";

    function ProductVariant(oData) {
        this.skuID = oData.skuID || "";
        this.productID = oData.productID || "";
        this.variantValue = oData.variantValue || "";

        this.isSingleSeller = oData.isSingleSeller || false;
        this.isSinglePrice = oData.isSinglePrice || true;
        this.listingID = oData.listingID || "";
        this.price = oData.price || 0;
        this.sellerName = oData.sellerName || "";
        this.productTitle = oData.productTitle || "";
        this.CTAButton = oData.CTAButton || "buy";
    }

    return ProductVariant;
});
define('modules/expand-collapse/common',['domlib', 'modules/common'], function ($, common) {
    'use strict';

    var expandCollapse = {

        onToggle: function onToggle(e) {
            e.preventDefault();
            var $currentTarget =  $(e.currentTarget),
                $target = $currentTarget.hasClass("trigger") ? $currentTarget : $currentTarget.parents(".blinkbox-banner").find(".trigger");

            expandCollapse.toggleContent($target);
            $target.toggleClass('collapsed');
        },

        toggleContent: function toggleContent($currentTarget) {
            if ($currentTarget.hasClass('collapsed')) {
                $currentTarget.parent().find('.ellipsis').hide();
                $currentTarget.parent().find('.expanded').show();
            } else {
                $currentTarget.parent().find('.ellipsis').show();
                $currentTarget.parent().find('.expanded').hide();
            }
        },

        init: function init() {
            var $elements = $('.expand-collapse'),
                $this;

            $elements.find('.expanded').addClass('collapsed');
            $elements.each(function () {
                $this = $(this);
                if ($this.hasClass("blinkbox-banner")) {
                    $this.find(".trigger").bind("click tap", function (e) {
                        expandCollapse.onToggle(e);
                    });
                } else {
                    var event = (common.isTouch()) ? 'tap click' : 'click';
                    $this.on(event, '.trigger', expandCollapse.onToggle);
                }
            });
        }
    };

    common.init.push(expandCollapse.init);

    return expandCollapse;
});
/* eslint-disable */
/*jslint regexp: true, nomen: true, plusplus: true */
define('modules/media-matrix/common',[
    'modules/common'
], function (common) {
    'use strict';

    var MediaType,
        MediaProviders,
        MediaUpdated,
        mediaMatrix = {

            _mediaTypes: [],
            _mediaProviders: [],

            mediaDefinitions: function () {

                var updatedUrl;

                mediaMatrix._mediaTypes.push(new MediaType('mp4', /(\.mp4)/gi));
                mediaMatrix._mediaTypes.push(new MediaType('m4v', /(\.m4v)/gi));
                mediaMatrix._mediaTypes.push(new MediaType('3gp', /(\.3gp)/gi));
                mediaMatrix._mediaTypes.push(new MediaType('flv', /(\.flv)/gi));
                mediaMatrix._mediaTypes.push(new MediaType('webm', /(\.webm)/gi));

                mediaMatrix._mediaProviders.push(new MediaProviders('Flix Media Alternate #2', /(embed\.flixfacts\.com\/v2)/i, 'html5', null, function (url) {
                    if (common.isFireFox() || !common.isHTML5()) {
                        this.playerType = 'flash';
                    } else {
                        updatedUrl = url;
                    }
                    return updatedUrl;
                }));
                mediaMatrix._mediaProviders.push(new MediaProviders('Easy2', /(media\.easy2\.com)/i, 'flash', null, null));
                mediaMatrix._mediaProviders.push(new MediaProviders('Easy2 Alternate', /(webapps\.easy2\.com)/i, 'html5', null, function (url) {
                    // switchable - this provider offers mp4 and webm
                    if (common.isFireFox()) {
                        this.typeRewrite = 'webm';
                        updatedUrl = url.concat('&formats=.' + 'webm');
                    } else if (!common.isHTML5()) {
                        this.playerType = 'flash';
                        this.typeRewrite = 'mp4';
                        updatedUrl = url.concat('&formats=.' + 'mp4');
                    } else {
                        this.typeRewrite = 'mp4';
                        updatedUrl = url.concat('&formats=.' + 'mp4');
                    }
                    return updatedUrl;
                }));
                mediaMatrix._mediaProviders.push(new MediaProviders('Flix Media', /(embed\.flixfacts\.com\/[^v2])/i, 'flash', null, null));
                mediaMatrix._mediaProviders.push(new MediaProviders('Flix Media Alternate', /(c242173\.r73\.cf3\.rackcdn\.com)/i, 'html5', null, null));
                mediaMatrix._mediaProviders.push(new MediaProviders('iSiteTv', /(www\.isitetv\.com)/i, 'html5', null, function (url) {
                    // switchable - this provider offers m4v and flv
                    if (mediaMatrix.detectIOS) {
                        this.typeRewrite = 'm4v';
                        updatedUrl = url.replace(/...$/gi, 'm4v');
                    } else {
                        if (!common.isHTML5() || common.isFireFox()) {
                            this.playerType = 'flash';
                            this.typeRewrite = 'flv';
                            updatedUrl = url.replace(/...$/gi, 'flv');
                        } else {
                            this.typeRewrite = 'm4v';
                            updatedUrl = url.replace(/...$/gi, 'm4v');
                        }
                    }
                    return updatedUrl;
                }));
                mediaMatrix._mediaProviders.push(new MediaProviders('Video Detective', /(www\.videodetective\.net)/i, 'html5'));
                mediaMatrix._mediaProviders.push(new MediaProviders('Scene7', /(tesco\.scene7\.com)/i, 'html5'));
                mediaMatrix._mediaProviders.push(new MediaProviders('Flix 360', /(embed\.flix360\.com)/i, 'html5'));
                mediaMatrix._mediaProviders.push(new MediaProviders('adis', /(i1\.adis\.ws)/i, 'html5'));
            },

            /* File decoding logic
             * This function should take an array of objects (video URLs from the JSP) and use regex to discover
             * what each file type is. The function should also use a regex to discover what media provider is associated
             * with each video url. This should output an array of objects containing video file type and provider.
             */
            mediaDecoder: function (mediaTypeDefinitions, mediaProviderDefinitions, aMediaCollection) {

                var _mediaCollection = aMediaCollection || window.TescoData.pdp.scene7._s7VideoSet,
                    mediaTypes = mediaTypeDefinitions,
                    mediaProviders = mediaProviderDefinitions,
                    j,
                    aUpdatedMedia = [];

                function decodeUrl(mediaCollection) {
                    var mediaUrl = mediaCollection,
                        tmpType = 'Unknown',
                        tmpProvider = 'Unknown',
                        typePattern,
                        providerPattern,
                        playerType,
                        i;

                    // match media types
                    for (i = 0; i < mediaTypes.length; i++) {
                        typePattern = mediaTypes[i].pattern;

                        if (typePattern.test(mediaUrl)) {
                            tmpType = mediaTypes[i].type;
                        }
                    }

                    // match media providers
                    for (i = 0; i < mediaProviders.length; i++) {
                        providerPattern = mediaProviders[i].pattern;

                        if (providerPattern.test(mediaUrl)) {
                            tmpProvider = mediaProviders[i].provider;

                            // check url rewrite function
                            if (mediaProviders[i].urlRewrite !== null) {
                                mediaUrl = mediaProviders[i].urlRewrite(mediaUrl);
                                tmpType = mediaProviders[i].typeRewrite;
                            }

                            playerType = mediaProviders[i].playerType;
                        }
                    }

                    if (aMediaCollection) {
                        aUpdatedMedia.push(new MediaUpdated(tmpType, playerType, tmpProvider, mediaUrl));
                    } else {
                        window._mediaCollectionUpdated.push(new MediaUpdated(tmpType, playerType, tmpProvider, mediaUrl));
                    }
                }

                // push array of videos into decoder function
                for (j = 0; j < _mediaCollection.length; j++) {
                    if (_mediaCollection[j].mediaSrc !== undefined) {
                        decodeUrl(_mediaCollection[j].mediaSrc);
                    } else {
                        decodeUrl(_mediaCollection[j]);
                    }
                }

                return aUpdatedMedia;
            },

            processMediaCollection: function processMediaCollection(aMediaCollection) {
                if (aMediaCollection) {
                    return mediaMatrix.mediaDecoder(mediaMatrix._mediaTypes, mediaMatrix._mediaProviders, aMediaCollection);
                }
            },

            init: function () {
                mediaMatrix.mediaDefinitions();
            }
        };

    MediaType = function (type, pattern, viewerType) {
        this.type = type || null;
        this.pattern = pattern || null;
        this.viewerType = viewerType || null;
    };

    MediaProviders = function (provider, pattern, playerType, typeRewrite, urlRewrite) {
        this.provider = provider || null;
        this.pattern = pattern || null;
        this.playerType = playerType || null;
        this.typeRewrite = typeRewrite || null;
        this.urlRewrite = urlRewrite || null;
    };

    MediaUpdated = function (fileType, playerType, tmpProvider, url) {
        this.fileType = fileType || null;
        this.playerType = playerType || null;
        this.tmpProvider = tmpProvider || null;
        this.url = url || null;
    };

    return mediaMatrix;
});

/*global define: true */
define('modules/basic-carousel/common',['domlib', 'modules/common'], function ($, common) {

    function BasicCarousel(opts) {

        var defaults = {
                elementId : '', // ID of the carousel
                isHorizontal : true, // false - vertical
                content : null, // String of mark-up to be appended to carousel item container
                itemsPerTransition : 1, // Number of items to move at a time
                moveItem : 'li', // The element whose dimensions will be used to calculate slide movement,
                onItemClick : null // Function called when carousel item is clicked, item index is passed as parameter
            };

        this.settings = {};
        this.$carousel = null;
        this.$carouselSlider = null;
        this.$carouselItemsContainer = null;
        this.$carouselItems = null;
        this.$btnNext = null;
        this.$btnPrev = null;
        this.selectedItem = 0;
        this.itemSize = 0;
        this.currentTop = 0;
        this.visibleItems = 0;
        this.numItems = 0;
        this.panelItemCount = 1;
        this.numPanels = 1;
        this.panelWidth = 0;
        this.panelDistance = 0;
        this.activePanel = 1;

        $.extend(this.settings, defaults, opts);
        this.$carousel = $('#' + this.settings.elementId);

        if (this.$carousel.length) {
            this.$carouselSlider = this.$carousel.find('.carousel-slider');
            this.$carouselItemsContainer = this.$carousel.find('.carousel-items-container');
            this.$btnNext = this.$carousel.find('.carousel-next');
            this.$btnPrev = this.$carousel.find('.carousel-prev');

            if (this.settings.content !== null) {
                this.$carouselItemsContainer.html(this.settings.content);
            }

            this.$carouselItems = this.$carouselItemsContainer.children(this.settings.moveItem); 
            var selectFirstEl = this.$carouselItems.filter('[data-index="0"]');
            selectFirstEl.addClass('selected');
            
            this.numItems = this.$carouselItems.length;
            this.bindHandlers();
            this.calculateVisibleItems();
        }
    }

    BasicCarousel.prototype = {
        
    	/**
    	 *  A function to animate the carousels when a user has clicked on the next or previous buttons
    	 * 
    	 */	
    	animateSlide : function (slidePosition) {
            var x = 0,
                y = 0,
                translateStr = '';

            if (this.settings.isHorizontal) {
                x = slidePosition + 'px';
            } else {
                y = slidePosition + 'px';
            }
            
            if (common.cssTransitionsSupported()) {
                translateStr = 'translate3d(' + x + ', ' + y + ', 0)';
                this.$carouselItemsContainer.css({
                    '-webkit-transform': translateStr,
                    '-moz-transform' : translateStr,
                    '-ms-transform': translateStr,
                    '-o-transform': translateStr,
                    'transform': translateStr
                });
            } else {
            	this.$carouselItemsContainer.css('left', x);
            }
        },
        
        /**
         *  A function to maintain the logic for the carousel slides
         * 
         */
        animateSet : function (direction, jumpToPanel) {
            var slidePos = 0;
            
            if (direction !== null) {
	            if (direction === -1) {
	                this.$btnPrev.removeClass('disabled');
	                if (this.activePanel === 0) {
	                	this.activePanel += 1;
	                }
	                
	                if (this.activePanel === 1) {
	                	slidePos = this.panelWidth * -1;             
	                } else {
	                	this.panelDistance = ((this.activePanel) * this.panelWidth) * -1;
	                	slidePos = this.panelDistance;  
	                }
	                
	                this.panelDistance += this.panelWidth;
	            	this.activePanel += 1;
	                
	                if (this.activePanel === this.numPanels) {
	                	this.$btnNext.addClass('disabled');
	                }
	            } else {                
	                if (this.activePanel !== 2) {
						this.activePanel -= 1;
						this.panelDistance = ((this.activePanel -1) * this.panelWidth) * -1;				
						slidePos = this.panelDistance;						
						this.$btnNext.removeClass('disabled');
	                } else {
	                	if (this.numPanels === 2) {
	                		this.$btnNext.removeClass('disabled');
	                	}
	                	this.$btnPrev.addClass('disabled');
						this.activePanel = 1;
	                	this.panelDistance = 0;
						slidePos = this.panelDistance * -1;
	                }                
	            }
            } else {
            	var newPanel = jumpToPanel -1;
            	slidePos = (this.panelWidth * newPanel) * -1;
            	this.panelDistance = slidePos;
            	
            	if (jumpToPanel !== 1) {
            		this.$btnPrev.removeClass('disabled');
            	}            	
            	if (jumpToPanel === this.numPanels) {	
            		this.$btnNext.addClass('disabled');
            	}            	
            }
            
            this.animateSlide(slidePos);
        },

        /**
         *  A function to maintain the logic for the visible area of the carousels 
         * 
         */
        calculateVisibleItems : function () {
            var viewableSize = this.settings.isHorizontal ? this.$carouselSlider.width() : this.$carouselSlider.height();
            this.itemSize = this.settings.isHorizontal ? this.$carouselItems.first().outerWidth(true) : this.$carouselItems.first().outerHeight(true);
            this.visibleItems = Math.floor(viewableSize / this.itemSize);
            this.calculatePanels(this.visibleItems);
            this.handleHotItems('reset');
            this.handleHotItems('init');
            if (this.numItems < 2 && this.$carousel.is(':visible')) {
            	this.$carousel.hide();
            }
        },
        
        /**
         *  A function to set carousel panel logic
         * 
         */
        calculatePanels : function (visibleItems) {
        	var $productContainer = $('#product-carousel');
        	var selectedIndex;
        	this.panelItemCount = 0;
        	this.numPanels = 0;
        	this.panelWidth = 0;
        	this.animateSet(0);
        	this.panelItemCount = visibleItems;
        	this.numPanels = Math.ceil(this.numItems / this.panelItemCount);
        	this.panelWidth = this.itemSize * this.panelItemCount;
        	if (this.numPanels < 2) {
        		this.$btnNext.addClass('disabled');
        	}
        	
	    	if ($productContainer.hasClass('zoomVisible')) {
        		selectedIndex = $('#product-thumb-carousel ul.carousel-items-container li.selected').data('index');
        	} else if ($productContainer.hasClass('videoVisible')) {
        		selectedIndex = $('#product-thumb-carousel-videos ul.carousel-items-container li.selected').data('index');        	
        	}
        		        		
    		if ((selectedIndex + 1) > this.panelItemCount) {        				
    			var updatedPanel = Math.ceil(selectedIndex / this.panelItemCount);
    			this.activePanel = updatedPanel;
    			this.animateSet(null, this.activePanel);
			} else {
				this.activePanel = 1;        		
    		}
    		
    		if (selectedIndex < this.panelItemCount) {
                this.$btnPrev.addClass('disabled'); 
    		}
        },

        /**
         *  A function to check if the element has a 'hot area'
         * 
         */
        checkPosition : function ($el) {
        	if ($el !== undefined) {
        		if ($el.hasClass('hot')) { 		
	        		if (!$el.hasClass('panel-' + this.activePanel)) {
	        			this.animateSet(-1);
	        		}
	        	}
	        }
        },
        
        /**
         *  A function to control 'hot areas'. 'Hot areas' are the carousel elements that a partially hidden but still
         *  visible to the user, if the user clicks on one of the 'hot areas' the carousel should slide forward
         * 
         */
        handleHotItems : function (action) {
        	if (action === 'init') {
        		if (this.$carouselItems.length > 4) {
        			var $hotItems = this.$carouselItems.filter(':nth-child(' + this.panelItemCount + 'n+1)').not(':first');
	        		$hotItems.addClass('hot');
	        		$hotItems.each(function(index) {
	        			$(this).addClass('panel-' + parseInt((index)+2));
	        		});
        		}
        	} else
        	if (action === 'reset') {
        		var $oldSelectedEl = this.$carouselItemsContainer.find('li.selected'),
        			$carouselEl = this.$carouselItems;
        		if ($oldSelectedEl.length > 0) {
        			var updatedIndex = $oldSelectedEl.data('index');
        			$carouselEl.removeClass();
        			var newSelectedEl = this.$carouselItemsContainer.find('li[data-index="'+ updatedIndex +'"]');
        			newSelectedEl.addClass('selected');
        		} else {
        			$carouselEl.removeClass();
        		}
        	}
        },
  
        /**
         *  A function to maintain logic for the 'next' and 'previous' arrows on the carousels
         * 
         */
        checkArrows : function() {
        	var $next = $('#btn-s7-next'),
        		$prev = $('#btn-s7-prev');
        	
        	if (this.selectedItem === 0) {
        		if (this.numItems > 1) {
            		if ($next.hasClass('disabled')) {
            			$next.removeClass('disabled');
                	}
            	}
        		if (!$prev.hasClass('disabled')) {
            		$prev.addClass('disabled');
            	}
            }
            
            if (this.selectedItem > 0) {
        		if ($next.hasClass('disabled')) {
        			$next.removeClass('disabled');
        		}
            }
            
            if (this.selectedItem === (this.numItems - 1)) {
            	if (!$next.hasClass('disabled')) {
            		$next.addClass('disabled');
            	}
            }
            
            if (this.selectedItem === (this.numItems - 2)) {
        		if ($next.hasClass('disabled')) {
        			$next.removeClass('disabled');
        		}
            }
            
            if (this.selectedItem === 1 || this.numItems > 1 && this.selectedItem !== 0) {
        		if ($prev.hasClass('disabled')) {
        			$prev.removeClass('disabled');
        		}
            }
        },
        
        /**
         *  A function to select a specific Scene7 asset
         * 
         */
        setItem : function (index, $el) {
            if (index >= 0 && index < this.numItems) {
                this.selectedItem = index;
                this.$carouselItems.removeClass('selected');
                this.$carouselItems.each(function () {
                	if ($(this).data('index') === index) {
    					$(this).addClass('selected');
    					return false;
    				}
                });            
                this.checkPosition($el);
                this.checkArrows();

				if ((this.selectedItem + 1) > (this.panelItemCount * this.activePanel)) {
                	this.animateSet(-1);
    			}
                
                var targetPanel = Math.ceil((this.selectedItem + 1) / this.panelItemCount);
    			if (this.activePanel !== targetPanel) {
                	this.animateSet(1);
                }
                
                if (typeof this.settings.onItemClick === 'function') {
                    this.settings.onItemClick(index);
                }
            }
        },
        
        /**
         *  A function to select the next Scene7 asset
         * 
         */
        next : function () {
            if (this.selectedItem < (this.numItems - 1)) {
                if (this.selectedItem === 0) {
                	$('#btn-s7-prev').removeClass('disabled');
                }
            	this.selectedItem += 1;
            	if (this.selectedItem === (this.numItems - 1)) {
            		$('#btn-s7-next').addClass('disabled');
            	}
                this.setItem(this.selectedItem);
            }
        },

        /**
         *  A function to select the previous Scene7 asset
         * 
         */
        prev : function () {
            if (this.selectedItem > 0) {
            	if (this.selectedItem === 1) {
            		$('#btn-s7-prev').addClass('disabled');
            	} else
            	if (this.selectedItem === (this.numItems - 1)) {
            		$('#btn-s7-next').removeClass('disabled');            		
            	}
            	this.selectedItem -= 1;
                this.setItem(this.selectedItem);
            }
        },
        
        /**
         *  A function to bind events for the carousels
         * 
         */
        bindHandlers : function () {
            var self = this;

            this.$carousel.on('click', '.carousel-step', function (evt) {
                evt.stopImmediatePropagation();
            	var direction = $(evt.target).hasClass('carousel-prev') ? 1 : -1;
                var disabled = $(evt.target).hasClass('disabled');
                
                if (!disabled) {
                	self.animateSet(direction);
                }
            });

            this.$carousel.on('click', 'li', function () {
                var index = parseInt($(this).data('index'), 10);
                self.setItem(index, $(this));
            });
        }
    };

    return BasicCarousel;

});
(function(root,factory){if(typeof exports==="object"&&exports){module.exports=factory}else if(typeof define==="function"&&define.amd){define('mustache',factory)}else{root.Mustache=factory}})(this,function(){var exports={};exports.name="mustache.js";exports.version="0.7.2";exports.tags=["{{","}}"];exports.Scanner=Scanner;exports.Context=Context;exports.Writer=Writer;var whiteRe=/\s*/;var spaceRe=/\s+/;var nonSpaceRe=/\S/;var eqRe=/\s*=/;var curlyRe=/\s*\}/;var tagRe=/#|\^|\/|>|\{|&|=|!/;function testRe(re,string){return RegExp.prototype.test.call(re,string)}function isWhitespace(string){return!testRe(nonSpaceRe,string)}var isArray=Array.isArray||function(obj){return Object.prototype.toString.call(obj)==="[object Array]"};function escapeRe(string){return string.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var entityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function escapeHtml(string){return String(string).replace(/[&<>"'\/]/g,function(s){return entityMap[s]})}exports.escape=escapeHtml;function Scanner(string){this.string=string;this.tail=string;this.pos=0}Scanner.prototype.eos=function(){return this.tail===""};Scanner.prototype.scan=function(re){var match=this.tail.match(re);if(match&&match.index===0){this.tail=this.tail.substring(match[0].length);this.pos+=match[0].length;return match[0]}return""};Scanner.prototype.scanUntil=function(re){var match,pos=this.tail.search(re);switch(pos){case-1:match=this.tail;this.pos+=this.tail.length;this.tail="";break;case 0:match="";break;default:match=this.tail.substring(0,pos);this.tail=this.tail.substring(pos);this.pos+=pos}return match};function Context(view,parent){this.view=view;this.parent=parent;this.clearCache()}Context.make=function(view){return view instanceof Context?view:new Context(view)};Context.prototype.clearCache=function(){this._cache={}};Context.prototype.push=function(view){return new Context(view,this)};Context.prototype.lookup=function(name){var value=this._cache[name];if(!value){if(name==="."){value=this.view}else{var context=this;while(context){if(name.indexOf(".")>0){var names=name.split("."),i=0;value=context.view;while(value&&i<names.length){value=value[names[i++]]}}else{value=context.view[name]}if(value!=null){break}context=context.parent}}this._cache[name]=value}if(typeof value==="function"){value=value.call(this.view)}return value};function Writer(){this.clearCache()}Writer.prototype.clearCache=function(){this._cache={};this._partialCache={}};Writer.prototype.compile=function(template,tags){var fn=this._cache[template];if(!fn){var tokens=exports.parse(template,tags);fn=this._cache[template]=this.compileTokens(tokens,template)}return fn};Writer.prototype.compilePartial=function(name,template,tags){var fn=this.compile(template,tags);this._partialCache[name]=fn;return fn};Writer.prototype.compileTokens=function(tokens,template){var fn=compileTokens(tokens);var self=this;return function(view,partials){if(partials){if(typeof partials==="function"){self._loadPartial=partials}else{for(var name in partials){self.compilePartial(name,partials[name])}}}return fn(self,Context.make(view),template)}};Writer.prototype.render=function(template,view,partials){return this.compile(template)(view,partials)};Writer.prototype._section=function(name,context,text,callback){var value=context.lookup(name);switch(typeof value){case"object":if(isArray(value)){var buffer="";for(var i=0,len=value.length;i<len;++i){buffer+=callback(this,context.push(value[i]))}return buffer}return value?callback(this,context.push(value)):"";case"function":var self=this;var scopedRender=function(template){return self.render(template,context)};var result=value.call(context.view,text,scopedRender);return result!=null?result:"";default:if(value){return callback(this,context)}}return""};Writer.prototype._inverted=function(name,context,callback){var value=context.lookup(name);if(!value||isArray(value)&&value.length===0){return callback(this,context)}return""};Writer.prototype._partial=function(name,context){if(!(name in this._partialCache)&&this._loadPartial){this.compilePartial(name,this._loadPartial(name))}var fn=this._partialCache[name];return fn?fn(context):""};Writer.prototype._name=function(name,context){var value=context.lookup(name);if(typeof value==="function"){value=value.call(context.view)}return value==null?"":String(value)};Writer.prototype._escaped=function(name,context){return exports.escape(this._name(name,context))};function compileTokens(tokens){var subRenders={};function subRender(i,tokens,template){if(!subRenders[i]){var fn=compileTokens(tokens);subRenders[i]=function(writer,context){return fn(writer,context,template)}}return subRenders[i]}return function(writer,context,template){var buffer="";var token,sectionText;for(var i=0,len=tokens.length;i<len;++i){token=tokens[i];switch(token[0]){case"#":sectionText=template.slice(token[3],token[5]);buffer+=writer._section(token[1],context,sectionText,subRender(i,token[4],template));break;case"^":buffer+=writer._inverted(token[1],context,subRender(i,token[4],template));break;case">":buffer+=writer._partial(token[1],context);break;case"&":buffer+=writer._name(token[1],context);break;case"name":buffer+=writer._escaped(token[1],context);break;case"text":buffer+=token[1];break}}return buffer}}function nestTokens(tokens){var tree=[];var collector=tree;var sections=[];var token;for(var i=0,len=tokens.length;i<len;++i){token=tokens[i];switch(token[0]){case"#":case"^":sections.push(token);collector.push(token);collector=token[4]=[];break;case"/":var section=sections.pop();section[5]=token[2];collector=sections.length>0?sections[sections.length-1][4]:tree;break;default:collector.push(token)}}return tree}function squashTokens(tokens){var squashedTokens=[];var token,lastToken;for(var i=0,len=tokens.length;i<len;++i){token=tokens[i];if(token[0]==="text"&&lastToken&&lastToken[0]==="text"){lastToken[1]+=token[1];lastToken[3]=token[3]}else{lastToken=token;squashedTokens.push(token)}}return squashedTokens}function escapeTags(tags){return[new RegExp(escapeRe(tags[0])+"\\s*"),new RegExp("\\s*"+escapeRe(tags[1]))]}exports.parse=function(template,tags){template=template||"";tags=tags||exports.tags;if(typeof tags==="string")tags=tags.split(spaceRe);if(tags.length!==2){throw new Error("Invalid tags: "+tags.join(", "))}var tagRes=escapeTags(tags);var scanner=new Scanner(template);var sections=[];var tokens=[];var spaces=[];var hasTag=false;var nonSpace=false;function stripSpace(){if(hasTag&&!nonSpace){while(spaces.length){tokens.splice(spaces.pop(),1)}}else{spaces=[]}hasTag=false;nonSpace=false}var start,type,value,chr;while(!scanner.eos()){start=scanner.pos;value=scanner.scanUntil(tagRes[0]);if(value){for(var i=0,len=value.length;i<len;++i){chr=value.charAt(i);if(isWhitespace(chr)){spaces.push(tokens.length)}else{nonSpace=true}tokens.push(["text",chr,start,start+1]);start+=1;if(chr==="\n"){stripSpace()}}}start=scanner.pos;if(!scanner.scan(tagRes[0])){break}hasTag=true;type=scanner.scan(tagRe)||"name";scanner.scan(whiteRe);if(type==="="){value=scanner.scanUntil(eqRe);scanner.scan(eqRe);scanner.scanUntil(tagRes[1])}else if(type==="{"){var closeRe=new RegExp("\\s*"+escapeRe("}"+tags[1]));value=scanner.scanUntil(closeRe);scanner.scan(curlyRe);scanner.scanUntil(tagRes[1]);type="&"}else{value=scanner.scanUntil(tagRes[1])}if(!scanner.scan(tagRes[1])){throw new Error("Unclosed tag at "+scanner.pos)}if(type==="/"){if(sections.length===0){throw new Error('Unopened section "'+value+'" at '+start)}var section=sections.pop();if(section[1]!==value){throw new Error('Unclosed section "'+section[1]+'" at '+start)}}var token=[type,value,start,scanner.pos];tokens.push(token);if(type==="#"||type==="^"){sections.push(token)}else if(type==="name"||type==="{"||type==="&"){nonSpace=true}else if(type==="="){tags=value.split(spaceRe);if(tags.length!==2){throw new Error("Invalid tags at "+start+": "+tags.join(", "))}tagRes=escapeTags(tags)}}var section=sections.pop();if(section){throw new Error('Unclosed section "'+section[1]+'" at '+scanner.pos)}return nestTokens(squashTokens(tokens))};var _writer=new Writer;exports.clearCache=function(){return _writer.clearCache()};exports.compile=function(template,tags){return _writer.compile(template,tags)};exports.compilePartial=function(name,template,tags){return _writer.compilePartial(name,template,tags)};exports.compileTokens=function(tokens,template){return _writer.compileTokens(tokens,template)};exports.render=function(template,view,partials){return _writer.render(template,view,partials)};exports.to_html=function(template,view,partials,send){var result=exports.render(template,view,partials);if(typeof send==="function"){send(result)}else{return result}};return exports}());
/* global define: true */
define('modules/device-specifications/common',['domlib', 'modules/common'], function($, common) {

        var unknown = '-';
        var detectFlash = false;

        var deviceSpecifications = {

        	// Get screen size
            screen: function(window) {
                var screenSize = '';
                if (screen.width) {
                    width = (screen.width) ? screen.width : '';
                    height = (screen.height) ? screen.height : '';
                    screenSize += '' + width + " x " + height;
                }
                return screenSize;
            }, // not self executed.

            // Get Browser
            browser: function() {
                var nAgt = navigator.userAgent;
                var browser = navigator.appName;
                var version = '' + parseFloat(navigator.appVersion);
                var majorVersion = parseInt(navigator.appVersion, 10);
                var nameOffset, verOffset, ix;

                // Opera
                if ((verOffset = nAgt.indexOf('Opera')) != -1) {
                    browser = 'Opera';
                    version = nAgt.substring(verOffset + 6);
                    if ((verOffset = nAgt.indexOf('Version')) != -1) {
                        version = nAgt.substring(verOffset + 8);
                    }
                }

                // MSIE
                else if ((verOffset = nAgt.indexOf('MSIE')) != -1) {
                    browser = 'Microsoft Internet Explorer';
                    version = nAgt.substring(verOffset + 5);
                }

                // Chrome
                else if ((verOffset = nAgt.indexOf('Chrome')) != -1) {
                    browser = 'Chrome';
                    version = nAgt.substring(verOffset + 7);
                }

                // Safari
                else if ((verOffset = nAgt.indexOf('Safari')) != -1) {
                    browser = 'Safari';
                    version = nAgt.substring(verOffset + 7);
                    if ((verOffset = nAgt.indexOf('Version')) != -1) {
                        version = nAgt.substring(verOffset + 8);
                    }
                }

                // Firefox
                else if ((verOffset = nAgt.indexOf('Firefox')) != -1) {
                    browser = 'Firefox';
                    version = nAgt.substring(verOffset + 8);
                }

                // MSIE 11+
                else if (nAgt.indexOf('Trident/') != -1) {
                    browser = 'Microsoft Internet Explorer';
                    version = nAgt.substring(nAgt.indexOf('rv:') + 3);
                }

                // Other browsers
                else if ((nameOffset = nAgt.lastIndexOf(' ') + 1) < (verOffset = nAgt
                    .lastIndexOf('/'))) {
                    browser = nAgt.substring(nameOffset, verOffset);
                    version = nAgt.substring(verOffset + 1);
                    if (browser.toLowerCase() == browser.toUpperCase()) {
                        browser = navigator.appName;
                    }
                }

                // trim the version string
                if ((ix = version.indexOf(';')) != -1)
                    version = version.substring(0, ix);
                if ((ix = version.indexOf(' ')) != -1)
                    version = version.substring(0, ix);
                if ((ix = version.indexOf(')')) != -1)
                    version = version.substring(0, ix);

                majorVersion = parseInt('' + version, 10);
                if (isNaN(majorVersion)) {
                    version = '' + parseFloat(navigator.appVersion);
                    majorVersion = parseInt(navigator.appVersion, 10);
                }
                return browser + " " + version;
            }, // not self executed.

            // Is user on mobile.
            isMobile: function() {
                var nVer = navigator.appVersion;
                var mobile = /Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(nVer);
                return mobile;
            }, // not self executed.

            isCookieEnabled: function() {
                var cookieEnabled = (navigator.cookieEnabled) ? true : false;
                if (typeof navigator.cookieEnabled == 'undefined' && !cookieEnabled) {
                    document.cookie = 'testcookie';
                    cookieEnabled = (document.cookie.indexOf('testcookie') != -1) ? true : false;
                }
                return cookieEnabled;
            }, // not self executed.
            
            // Get OS and Version.
            os: function() {
				try {
				    
                    var os = unknown,
                        osVersion = "",
                        clientStrings = [
    						{
    							s : 'Windows 3.11',
    							r : /Win16/
    						},
    						{
    							s : 'Windows 95',
    							r : /(Windows 95|Win95|Windows_95)/
    						},
    						{
    							s : 'Windows ME',
    							r : /(Win 9x 4.90|Windows ME)/
    						},
    						{
    							s : 'Windows 98',
    							r : /(Windows 98|Win98)/
    						},
    						{
    							s : 'Windows CE',
    							r : /Windows CE/
    						},
    						{
    							s : 'Windows 2000',
    							r : /(Windows NT 5.0|Windows 2000)/
    						},
    						{
    							s : 'Windows XP',
    							r : /(Windows NT 5.1|Windows XP)/
    						},
    						{
    							s : 'Windows Server 2003',
    							r : /Windows NT 5.2/
    						},
    						{
    							s : 'Windows Vista',
    							r : /Windows NT 6.0/
    						},
    						{
    							s : 'Windows 7',
    							r : /(Windows 7|Windows NT 6.1)/
    						},
    						{
    							s : 'Windows 8.1',
    							r : /(Windows 8.1|Windows NT 6.3)/
    						},
    						{
    							s : 'Windows 8',
    							r : /(Windows 8|Windows NT 6.2)/
    						},
    						{
    							s : 'Windows NT 4.0',
    							r : /(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/
    						},
    						{
    							s : 'Windows ME',
    							r : /Windows ME/
    						},
    						{
    							s : 'Android',
    							r : /Android/
    						},
    						{
    							s : 'Open BSD',
    							r : /OpenBSD/
    						},
    						{
    							s : 'Sun OS',
    							r : /SunOS/
    						},
    						{
    							s : 'Linux',
    							r : /(Linux|X11)/
    						},
    						{
    							s : 'iOS',
    							r : /(iPhone|iPad|iPod)/
    						},
    						{
    							s : 'Mac OS X',
    							r : /Mac OS X/
    						},
    						{
    							s : 'Mac OS',
    							r : /(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/
    						},
    						{
    							s : 'QNX',
    							r : /QNX/
    						},
    						{
    							s : 'UNIX',
    							r : /UNIX/
    						},
    						{
    							s : 'BeOS',
    							r : /BeOS/
    						},
    						{
    							s : 'OS/2',
    							r : /OS\/2/
    						},
    						{
    							s : 'Search Bot',
    							r : /(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/
    						} ];
    
                    var nAgt = navigator.userAgent;
    
                    for (var id in clientStrings) {
                        var cs = clientStrings[id];
                        if (cs.r.test(nAgt)) {
                            os = cs.s;
                            break;
                        }
                    }
    
                    var osVersion = unknown;
    
                    if (/Windows/.test(os)) {
                        osVersion = /Windows (.*)/.exec(os)[1];
                        os = 'Windows';
                    }
    
                    switch (os) {
                        case 'Mac OS X':
                            osVersion = /Mac OS X (10[\.\_\d]+)/.exec(nAgt)[1];
                            break;
    
                        case 'Android':
                            osVersion = /Android ([\.\_\d]+)/.exec(nAgt)[1];
                            break;
    
                        case 'iOS':
                        	var nVer = navigator.appVersion;
                            osVersion = /OS (\d+)_(\d+)_?(\d+)?/.exec(nVer);
                            osVersion = osVersion[1] + '.' + osVersion[2] + '.' + (osVersion[3] | 0);
                            break;
                    }
                    return os + ' v' + osVersion;
				}
				catch (e) {
				    return "";
				}
            }(),

            flashVersion: function() {
                    if (detectFlash) { // default false.
                        var mBody = document.getElementsByTagName('body')[0];
                        var newScript = document.createElement('script');
                        newScript.setAttribute('src', '//ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js');
                        nBody.appendChild(newScript);

                        var flashVersion = '0.0';
                        if (typeof swfobject != 'undefined') {
                            var fv = swfobject.getFlashPlayerVersion();
                            if (fv.major > 0) {
                                flashVersion = fv.major + '.' + fv.minor + ' r' + fv.release;
                            } else {
                                flashVersion = unknown;
                            }
                        }
                        return flashVersion;
                    } else {
                        throw new Error('Flash detection disabled.');
                    }

                } // Do not selfExecute
        };

        return deviceSpecifications;
    });
/*global define: true, window: true */
define('modules/basic-slider/common',['domlib', 'modules/common'], function ($, common) {
    'use strict';
    /**
     *  BasicSlider
     *
     *  Creates a simple HTML based slider control
     */

    function BasicSlider($cont, options) {
        this.$cont = $cont;
        this.$handle = null;
        this.$trail = null;
        this.isMouseDown = false;
        this.handleWidth = 0;
        this.handleCenterOffset = 0;
        this.width = 0;
        this.value = 0; // This value should

        this.settings = {
            onSlideMove: null
        };

        $.extend(this.settings, options);

        this.init();
    }

    BasicSlider.prototype.init = function () {
        this.buildMarkUp();
        this.bindHandlers();
    };

    /**
     *  Recalculate the width when the container is resized
     *
     */
    BasicSlider.prototype.resize = function () {
        this.width = this.$cont.width();
    };

    /**
     *  Make sure the width of the slider is not zero
     *
     */
    BasicSlider.prototype.checkWidth = function () {
        if (this.width <= 0) {
            this.width = this.$cont.width();
        }
    };

    BasicSlider.prototype.buildMarkUp = function () {
        var markUp = '<div class="basic-slider"><div class="basic-slider-trail"></div><div class="basic-slider-handle"></div><div class="basic-slider-track"></div></div>';

        this.$cont.html(markUp);
        this.$slider = $('.basic-slider', this.$cont);
        this.$handle = $('.basic-slider-handle', this.$cont);
        this.$trail = $('.basic-slider-trail', this.$cont);
        this.width = this.$cont.width();
        this.handleWidth = this.$handle.outerWidth();
        this.handleCenterOffset = this.handleWidth / 2;
    };

    BasicSlider.prototype.setPosition = function (leftPercent) {
        this.$handle.css({
            'left': leftPercent + '%'
        });
        this.$trail.width(leftPercent + '%');
        this.value = leftPercent;
    };

    BasicSlider.prototype.calculatePercentageFromOffsetLeft = function (offsetLeft) {
        var percentageWidth = Math.ceil((offsetLeft / this.width) * 100);

        this.setPosition(percentageWidth);

        if (typeof this.settings.onSlideMove === 'function') {
            this.settings.onSlideMove(this.value);
        }
    };

    BasicSlider.prototype.doMouseDrag = function (evt) {
        var relativeLeft,
            handleLeft;

        this.checkWidth();

        if (this.isMouseDown) {
            relativeLeft = evt.pageX - this.$cont.offset().left;
            handleLeft = relativeLeft - this.handleCenterOffset;

            if (relativeLeft <= this.handleCenterOffset) {
                handleLeft = 0;
            }

            if (relativeLeft >= (this.width + this.handleCenterOffset)) {
                handleLeft = this.width;
            }

            this.calculatePercentageFromOffsetLeft(handleLeft);
        }
    };

    BasicSlider.prototype.doCLick = function (evt) {
        var relativeLeft;

        this.checkWidth();

        relativeLeft = evt.pageX - this.$cont.offset().left;

        if (relativeLeft >= 0 && relativeLeft <= this.width) {
            this.calculatePercentageFromOffsetLeft(relativeLeft - this.handleCenterOffset);
        }
    };

    BasicSlider.prototype.doMouseDown = function (evt) {
        evt.preventDefault();
        evt.stopPropagation();
        this.isMouseDown = true;
    };

    BasicSlider.prototype.doMouseUp = function () {
        this.isMouseDown = false;
    };

    BasicSlider.prototype.bindHandlers = function () {
        this.$cont.on('mousedown', $.proxy(this.doMouseDown, this));
        this.$cont.on('mouseup', $.proxy(this.doMouseUp, this));
        this.$cont.on('mouseenter', $.proxy(this.doMouseUp, this));
        this.$cont.on('mousemove', $.proxy(this.doMouseDrag, this));
        this.$cont.on('click', '.basic-slider', $.proxy(this.doCLick, this));
        var self = this;
        $(window).resize(function () {
            self.resize();
        });
    };

    common.BasicSlider = BasicSlider;

});
/*global refEvar22: true, refEvar24: true,console */
/*jslint plusplus: true */
define('modules/basic-video-player/common',[
    'domlib',
    'modules/breakpoint',
    'modules/tesco.analytics',
    'modules/device-specifications/common',
    'modules/common',
    'modules/basic-slider/common'
], function ($, breakpoint, analytics, deviceSpecifications, common) {
    'use strict';

    /**
     * Adds custom controls to video palyer - the mark-up is stored in a mustache template
     * param: $container {jquery object} : This should be a <div> containing the rendered mustache template
     */
    function BasicVideoPlayer($container, opts) {
        var oDefaultOptions = {
            createPauseIcon: '<span class="pause-icon">Pause video</span>',
            createPlayIcon: '<span class="play-icon">Play video</span>',
            pauseIcon: 'span.pause-icon',
            playIcon: 'span.play-icon',
            pauseClass: 'paused',
            videoControlsSelector: '.video-controls',
            fadeControls: false,
            bBackToStartOnEnd: false,
            bVideoPlayerV2: false
        };

        this.options = $.extend({}, oDefaultOptions, opts);
        this.$container = $container;
        this.$videoControls = $container.find(this.options.videoControlsSelector);
        this.$playBtn = $container.find('.play');
        this.$muteBtn = $container.find('.mute');
        this.$seekBar = $container.find('.seek-bar');
        this.$fullScreenBtn = $container.find('button.fullScreen');
        this.seekBarSlider = null;
        this.video = $container.find('video')[0];
        this.controlsTimer = null;
        this.prx = {
            togglePlay: $.proxy(this.togglePlay, this),
            startupSequence: $.proxy(this.startupSequence, this),
            toggleMute: $.proxy(this.toggleMute, this),
            seek: $.proxy(this.seek, this),
            updateSeekBar: $.proxy(this.updateSeekBar, this),
            play: $.proxy(this.play, this),
            pause: $.proxy(this.pause, this),
            videoEnded: $.proxy(this.videoEnded, this),
            handleFullscreen: $.proxy(this.handleFullscreen, this),
            setFullscreenData: $.proxy(this.setFullscreenData, this),
            controlsHandler: $.proxy(this.controlsHandler, this)
        };
        this.bVideoControlsEventsBound = false;
        this.bVideoControlTimer = null;
        this.bCursorOverVideo = false;
        this.iMouseMoveTimeout = 1500;
        this.init();
    }

    BasicVideoPlayer.prototype = {

        videoEnded: function () {
            this.$playBtn.removeClass(this.options.pauseClass);

            if (this.options.bBackToStartOnEnd) {
                this.video.currentTime = 0;
                this.pause();
            }

            if (this.options.fadeControls) {
                this.controlsHandler(true);
            }

            this.iconHandler('play', 'create');

            /*jslint nomen: true*/
            var _oWebAnalytics = new analytics.WebMetrics(),
                v = {},
                breadCrumbText = [],
                text;
            /*jslint nomen: false*/

            $('li a', $('#breadcrumb')).each(function () {
                text = $.trim($(this).text());
                breadCrumbText.push(text);
            });
            if (breadCrumbText[1]) {
                v.prop1 = breadCrumbText[1];
            }
            if (breadCrumbText[2]) {
                v.prop2 = breadCrumbText[2];
            }
            if (breadCrumbText[3]) {
                v.prop3 = breadCrumbText[3];
            }
            breadCrumbText.length = 0; // empty array.
            v.eVar56 = deviceSpecifications.os;
            v.prop23 = deviceSpecifications.os;
            if (window.refEvar22 !== 'undefined') {
                v.eVar22 = refEvar22;
            }
            if (window.refEvar24 !== 'undefined') {
                v.eVar24 = refEvar24;
            }
            v.prop19 = 'Video Tab';
            v.events = 'event61';
            /*jslint nomen: true*/
            _oWebAnalytics.submit([v]);
            /*jslint nomen: false*/
        },

        updatePlayBtn: function () {
            if (this.video.paused) {
                this.$playBtn.removeClass(this.options.pauseClass);
            } else {
                this.$playBtn.addClass(this.options.pauseClass);
            }
        },

        updateMuteBtn: function () {
            if (this.video.muted) {
                this.$muteBtn.addClass('muted').addClass('icon-mute');
            } else {
                this.$muteBtn.removeClass('muted').removeClass('icon-mute');
            }
        },

        startupSequence: function () {
            if (!this.options.fadeControls) {
                if (!breakpoint.mobile) {
                    this.iconHandler('play', 'create');
                }
            } else {
                if (common.isIphone()) {
                    this.$videoControls.remove();
                } else {
                    if (common.isIOS()) {
                        this.$muteBtn[0].disabled = true;
                    }
                    this.iconHandler('play', 'create');
                }
            }

            if (this.$fullScreenBtn.length > 0) {
                this.initFullScreenSupport();
            }
        },

        skip: function (seconds) {
            this.video.currentTime += seconds;
        },

        iconHandler: function (type, action) {
            var thisGlobal = this,
                pauseIcon = thisGlobal.options.pauseIcon,
                playIcon = thisGlobal.options.playIcon,
                createPauseIcon = thisGlobal.options.createPauseIcon,
                createPlayIcon = thisGlobal.options.createPlayIcon,
                $videoContainer = $('.videoPosition');

            if (type === 'pause') {
                if (action === 'create') {
                    if (!$(pauseIcon).length) {
                        $videoContainer.append(createPauseIcon);
                        window.setTimeout(function () {
                            $(pauseIcon).addClass('hide-video-icon');
                            window.setTimeout(function () {
                                $(pauseIcon).remove();
                                $videoContainer.append(createPlayIcon);
                            }, 600);
                        }, 200);
                    }
                } else if (action === 'destroy') {
                    if ($(pauseIcon).length > 0) {
                        $(pauseIcon).addClass('hide-video-icon');
                        window.setTimeout(function () {
                            $(pauseIcon).remove();
                            $videoContainer.append(createPlayIcon);
                        }, 600);
                    }
                }
            } else if (type === 'play') {
                if (action === 'create') {
                    if (!$(playIcon).length) {
                        $videoContainer.append(createPlayIcon);
                    }
                } else if (action === 'destroy') {
                    if ($(playIcon).length > 0) {
                        $(playIcon).addClass('hide-video-icon');
                        window.setTimeout(function () {
                            $(playIcon).remove();
                        }, 600);
                    }
                }
            }
        },

        togglePlay: function () {
            /*jslint nomen: true*/
            var _oWebAnalytics = new analytics.WebMetrics(),
                v = {},
                breadCrumbText = [],
                text;
            /*jslint nomen: false*/

            $('li a', $('#breadcrumb')).each(function () {
                text = $.trim($(this).text());
                breadCrumbText.push(text);
            });
            if (breadCrumbText[1]) {
                v.prop1 = breadCrumbText[1];
            }
            if (breadCrumbText[2]) {
                v.prop2 = breadCrumbText[2];
            }
            if (breadCrumbText[3]) {
                v.prop3 = breadCrumbText[3];
            }
            breadCrumbText.length = 0; // empty array.
            v.eVar56 = deviceSpecifications.os;
            v.prop23 = deviceSpecifications.os;
            if (window.refEvar22 !== 'undefined') {
                v.eVar22 = refEvar22;
            }
            if (window.refEvar24 !== 'undefined') {
                v.eVar24 = refEvar24;
            }
            v.prop19 = 'Video Tab';

            $('#pdp-product-video').toggleClass('triggerRepaint');
            if (this.video.paused) {
                this.iconHandler('play', 'destroy');
                this.video.play();
                this.updatePlayBtn();
                v.events = 'event59';
                if (this.options.fadeControls) {
                    this.controlsHandler(false);
                }
                this.$container.trigger('BasicVideoPlayer.play');
            } else {
                this.video.pause();
                this.iconHandler('pause', 'create');
                this.updatePlayBtn();
                v.events = 'event60';
                if (this.options.fadeControls) {
                    this.controlsHandler(true);
                }
                this.$container.trigger('BasicVideoPlayer.pause');
            }
            /*jslint nomen: true*/
            _oWebAnalytics.submit([v]);
            /*jslint nomen: false*/
        },

        pause: function () {
            this.video.pause();
            this.updatePlayBtn();
        },

        play: function () {
            this.togglePlay();
            this.updatePlayBtn();
        },

        toggleMute: function () {
            this.video.muted = this.video.muted ? false : true;
            this.updateMuteBtn();
        },

        /**
         *  Move to a specified point in the video by percentage
         *  @param {number} Value between 0-100
         */
        seek: function (pct) {
            var time = this.video.duration * (pct / 100);
            this.video.currentTime = time;
        },

        updateSeekBar: function () {
            var value = Math.ceil((100 / this.video.duration) * this.video.currentTime);
            this.seekBarSlider.setPosition(value);
        },

        bindEvents: function () {
            this.$container.on('click', '.play', this.prx.togglePlay);
            this.$container.on('click', this.options.playIcon, this.prx.play);
            this.$container.on('click', 'video', this.prx.togglePlay);
            this.$container.on('click', '.mute', this.prx.toggleMute);
            $(this.video).on('timeupdate', this.prx.updateSeekBar);
            $(this.video).on('ended', this.prx.videoEnded);
            this.$container.on('mediaViewer.play', this.prx.play);
        },

        setFullscreenData: function setFullscreenData(state) {
            this.$container[0].setAttribute('data-fullscreen', !!state);
        },

        isFullScreen: function isFullScreen() {
            return !!(document.fullScreen || document.webkitIsFullScreen || document.mozFullScreen || document.msFullscreenElement || document.fullscreenElement);
        },

        handleFullscreen: function handleFullscreen() {
            if (this.isFullScreen()) {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitCancelFullScreen) {
                    document.webkitCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                this.setFullscreenData(false);
                $(window).trigger('exitFullscreen');

            } else {
                if (this.$container[0].requestFullscreen) {
                    this.$container[0].requestFullscreen();
                } else if (this.$container[0].mozRequestFullScreen) {
                    this.$container[0].mozRequestFullScreen();
                } else if (this.$container[0].webkitRequestFullScreen) {
                    this.$container[0].webkitRequestFullScreen();
                } else if (this.$container[0].msRequestFullscreen) {
                    this.$container[0].msRequestFullscreen();
                }
                this.setFullscreenData(true);
                $(window).trigger('requestFullscreen');
            }
        },

        bindFullScreenEvents: function bindFullScreenEvents() {
            var self = this;

            this.$container.on('click', '.fullScreen', this.prx.handleFullscreen);

            $(document).on('fullscreenchange', function () {
                self.prx.setFullscreenData(!!(document.fullScreen || document.fullscreenElement));
            });
            $(document).on('webkitfullscreenchange', function () {
                self.prx.setFullscreenData(!!document.webkitIsFullScreen);

                if (document.webkitIsFullScreen) {
                    $(window).trigger('mastheadSlideUp');
                } else {
                    $(window).trigger('mastheadSlideDown');
                }
            });
            $(document).on('mozfullscreenchange', function () {
                self.prx.setFullscreenData(!!document.mozFullScreen);
            });
            $(document).on('msfullscreenchange', function () {
                self.prx.setFullscreenData(!!document.msFullscreenElement);
            });
        },

        initFullScreenSupport: function initFullScreenSupport() {
            var fullScreenEnabled = !!(document.fullscreenEnabled || document.mozFullScreenEnabled || document.msFullscreenEnabled || document.webkitSupportsFullscreen || document.webkitFullscreenEnabled || document.createElement('video').webkitRequestFullScreen);

            if (fullScreenEnabled) {
                this.bindFullScreenEvents();
            } else {
                this.$fullScreenBtn[0].disabled = true;
            }
        },

        controlsHandler: function controlsHandler(bShowControls) {
            this.$videoControls.toggleClass('video-controls-out', !bShowControls);
        },

        videoControlsHandler: function videoControlsHandler() {
            this.bindVideoControlsEvents();
        },

        bindVideoControlsEvents: function bindVideoControlsEvents() {
            var self = this;

            if (!self.bVideoControlsEventsBound) {
                self.$container
                    .on(
                        'mouseenter',
                        self.handleMouseEnterVideo.bind(self)
                    )
                    .on(
                        'mouseleave',
                        self.handleMouseLeaveVideo.bind(self)
                    )
                    .on(
                        'mousemove',
                        self.handleMouseMovementStarted.bind(self)
                    );
                $(window)
                    .on(
                        'cursorMovement.stopped',
                        self.handleMouseMovementStopped.bind(self)
                    );
                self.bVideoControlsEventsBound = true;
            }
        },

        setVideoControlsHidden: function setVideoControlsHidden() {
            var sVideoControlsSelector = this.options.videoControlsSelector;

            if (!$(sVideoControlsSelector).hasClass('video-controls-out')) {
                this.controlsHandler(false);
            }
        },

        setVideoControlsVisible: function setVideoControlsVisible() {
            var sVideoControlsSelector = this.options.videoControlsSelector;

            if ($(sVideoControlsSelector).hasClass('video-controls-out')) {
                this.controlsHandler(true);
            }
        },

        handleMouseEnterVideo: function handleMouseEnterVideo() {
            if (!this.video.paused) {
                window.CursorMovement.startPolling();
                this.bCursorOverVideo = true;
                this.setVideoControlsVisible();
            }
        },

        handleMouseLeaveVideo: function handleMouseLeaveVideo() {
            if (!this.video.paused) {
                this.bCursorOverVideo = false;
                this.bVideoControlTimer = null;
                this.setVideoControlsHidden();
                window.CursorMovement.stopPolling();
            }
        },

        handleMouseMovementStarted: function handleMouseMovementStarted() {
            var self = this;

            if (!this.video.paused && this.bCursorOverVideo) {
                if (this.bVideoControlTimer !== null) {
                    window.clearTimeout(self.bVideoControlTimer);
                    self.bVideoControlTimer = null;
                }
                this.setVideoControlsVisible();
            }
        },

        handleMouseMovementStopped: function handleMouseMovementStopped() {
            var self = this;

            if (!this.video.paused && this.bCursorOverVideo && this.bVideoControlTimer === null) {
                window.CursorMovement.stopPolling();
                this.bVideoControlTimer = window.setTimeout(function () {
                    if (!self.video.paused) {
                        self.setVideoControlsHidden();
                    }
                    self.bVideoControlTimer = null;
                }, self.iMouseMoveTimeout);
            }
        },

        init: function () {
            if (this.video !== undefined) {
                this.video.controls = false;
                this.video.removeAttribute('controls');
                this.$videoControls.show();
            }
            this.startupSequence();
            this.bindEvents();
            this.seekBarSlider = new common.BasicSlider(this.$seekBar, {
                onSlideMove: $.proxy(this.seek, this)
            });

            if (!common.isTouch() && $('body').hasClass('PDP-Version2')) {
                this.videoControlsHandler();
            }
        }
    };

    return BasicVideoPlayer;
});

/*jslint plusplus: true */
/*global define: true, TescoData: true */
define('modules/carousel-position-indicator/common',['domlib'], function ($) {
    'use strict';

    var carouselPositionIndicator = {
        videoIndicatorInDOM: false,
        galleryIndicatorInDOM: false,
        sSetIndicator: 'genericCarouselPositionIndicator',

        setIndicatorDOMCheck: function () {
            carouselPositionIndicator.galleryIndicatorInDOM = $('.' + carouselPositionIndicator.sSetIndicator + '.gallery').length ? true : false;
            carouselPositionIndicator.videoIndicatorInDOM = $('.' + carouselPositionIndicator.sSetIndicator + '.video').length ? true : false;
        },

        setIndicatorInit: function (indicatorType) {
            var source,
                type,
                count,
                $source;

            carouselPositionIndicator.setIndicatorDOMCheck();
            if (indicatorType === 'video') {
                /*jslint nomen: true*/
                source = window.TescoData.pdp.scene7._s7VideoSet;
                /*jslint nomen: false*/
                type = 'video';
                count = source.length;

                if (count > 1) {
                    if (!carouselPositionIndicator.videoIndicatorInDOM) {
                        carouselPositionIndicator.setIndicatorCreator(type, count);
                        carouselPositionIndicator.videoIndicatorInDOM = true;
                    }
                }
            } else if (indicatorType === 'gallery') {
                $source = $('#product-thumb-carousel ul.carousel-items-container li');
                type = 'gallery';
                count = $source.length;

                if (count > 1) {
                    if (!carouselPositionIndicator.galleryIndicatorInDOM) {
                        carouselPositionIndicator.setIndicatorCreator(type, count);
                        carouselPositionIndicator.galleryIndicatorInDOM = true;
                    }
                }
            }
        },

        setIndicatorCreator: function (type, count) {
            var positionIndicatorObj = '<ul class="' + carouselPositionIndicator.sSetIndicator + ' ' + type + ' dots' + count + '" style="display: none;">',
                i;

            for (i = 0; i < count; i++) {
                positionIndicatorObj += '<li data-index="' + i + '"/>';
            }
            positionIndicatorObj += '</ul>';
            if (type === 'gallery') {
                $('#product-thumb-carousel').prepend(positionIndicatorObj);
                $('.' + carouselPositionIndicator.sSetIndicator + '.gallery').fadeIn('slow');
            } else if (type === 'video') {
                $('#product-thumb-carousel-videos').prepend(positionIndicatorObj);
                $('.' + carouselPositionIndicator.sSetIndicator + '.video').fadeIn('slow');
            }
        },

        setIndicatorReset: function (type) {
            $('.' + carouselPositionIndicator.sSetIndicator + '.' + type + ' li').removeClass().filter('[data-index="0"]').addClass('selected');
        },

        setIndicatorUpdate: function (type, index, direction) {
            var updatedIndex;

            if (direction === 'forward') {
                updatedIndex = parseInt(index, 10) + 1;
            } else if (direction === 'back') {
                updatedIndex = parseInt(index, 10) - 1;
            } else if (direction === 'jump') {
                updatedIndex = index;
            }
            $('ul.' + carouselPositionIndicator.sSetIndicator + '.' + type + ' li').removeClass().filter('[data-index="' + updatedIndex + '"]').addClass('selected');
        },

        init: function () {
            if (TescoData !== 'undefined') {
                carouselPositionIndicator.setIndicatorInit();
            }
        }
    };

    return carouselPositionIndicator;
});
/*jslint nomen: true*/
define('modules/media-player/common',[
    'domlib',
    'mustache',
    'modules/common',
    'modules/basic-video-player/common',
    'modules/carousel-position-indicator/common',
    'modules/tesco.analytics',
    'modules/device-specifications/common'
], function ($, mustache, common, BasicVideoPlayer, carouselPositionIndicator, analytics, deviceSpecifications) {
    'use strict';

    var mediaPlayer = {

        videoViewContId: "prodVideoView",
        videoThumbnails: "",
        fadeInSpeed: 500,
        mediaIndex: 0,
        $componentContainer: '#s7container',
        $videoViewContainer: null,
        videoPlayers: [],
        currentIndex: 0,
        oBasicVideoPlayerOpts: {
            createPauseIcon: '<span class="icon icon-pause fnPauseBtn"></span>', // big button
            createPlayIcon: '<span class="icon icon-play fnPlayBtn"></span>', // big button
            pauseIcon: 'span.fnPauseBtn', // big button
            playIcon: 'span.fnPlayBtn', // big button
            pauseClass: 'icon-pause',
            fadeControls: true,
            bBackToStartOnEnd: true,
            bVideoPlayerV2: true
        },
        sErrorTemplate: '<div id="prodVideoView" class="videoView error"><div class="videoContainer"><div class="videoPosition" data-index="{{iIndex}}"><div class="errorVideo"><div class="errorWrap"><span>{{sDescription}}</span></div></div></div></div></div>',
        bMediaViewer: false,

        errorHandler: function (errorType, index) {
            var _oWebAnalytics = new analytics.WebMetrics(),
                v = {},
                breadCrumbText = [],
                oErrorData = {
                    sDescription: errorType,
                    iIndex: index
                },
                sRenderedErrorTemplate = '';

            if (mediaPlayer.bMediaViewer) {
                mediaPlayer.sErrorTemplate = $('#media-viewer-video-error-template')[0].innerHTML;
            }

            sRenderedErrorTemplate = mustache.render(mediaPlayer.sErrorTemplate, oErrorData);

            if (errorType !== '00DUP') {
                if ($('span.ajax-loader').length) {
                    $('span.ajax-loader').remove();
                }
                $('#s7container').append(sRenderedErrorTemplate);

                if (!mediaPlayer.bMediaViewer) {
                    $('.videoPosition').animate({
                        opacity: 1
                    }, mediaPlayer.fadeInSpeed);
                }
            }

            $('li a', $('#breadcrumb')).each(function () {
                var text = $.trim($(this).text());
                breadCrumbText.push(text);
            });
            if (breadCrumbText[1]) {
                v.prop1 = breadCrumbText[1];
            }
            if (breadCrumbText[2]) {
                v.prop2 = breadCrumbText[2];
            }
            if (breadCrumbText[3]) {
                v.prop3 = breadCrumbText[3];
            }
            breadCrumbText.length = 0; // empty array.
            v.eVar56 = deviceSpecifications.os;
            v.prop23 = deviceSpecifications.os;
            if (window.refEvar22 !== undefined) {
                v.eVar22 = window.refEvar22;
            }
            if (window.refEvar24 !== undefined) {
                v.eVar24 = window.refEvar24;
            }
            v.prop19 = 'Video Tab';
            v.events = 'event41';
            v.eVar48 = errorType;
            _oWebAnalytics.submit([v]);
        },

        videoRender: function (playerType, updatedMediaSrc, itemIndex) {

            var templateType = playerType,
                templateId,
                mediaIndex = itemIndex,
                loadingIcon = $('span.ajax-loader'),
                vidOb = {
                    url: updatedMediaSrc,
                    index: mediaIndex,
                    width: 100,
                    flashLocation: window.globalStaticAssetsPath
                },
                htmlTemplate,
                videoPlayerCont,
                fnAppendVideoPlayer = function fnAppendVideoPlayer() {
                    $('#s7container').append(mediaPlayer.$videoViewContainer);
                    if (templateType === 'html5') {
                        if (mediaPlayer.bMediaViewer) {
                            mediaPlayer.videoPlayers.push(new BasicVideoPlayer(mediaPlayer.$videoContainer, mediaPlayer.oBasicVideoPlayerOpts));
                        } else {
                            mediaPlayer.videoPlayers.push(new BasicVideoPlayer(mediaPlayer.$videoContainer));
                        }
                        $('.videoPosition').addClass('html5-player');
                    }

                    if (!mediaPlayer.bMediaViewer) {
                        $('.videoPosition').addClass('fade-in-video');
                    }
                };

            this.currentIndex = mediaIndex;

            if (mediaPlayer.bMediaViewer) {
                if (templateType === 'flash') {
                    templateId = '#flash-video-viewer-template';
                } else if (templateType === 'html5') {
                    templateId = '#html5-video-viewer-template';
                }
            } else {
                if (templateType === 'flash') {
                    templateId = '#flash-video-template';
                } else if (templateType === 'html5') {
                    templateId = '#html5-video-template';
                }
            }

            htmlTemplate = $(templateId).html();
            videoPlayerCont = mustache.render(htmlTemplate, vidOb);
            mediaPlayer.$videoContainer.html(videoPlayerCont);
            mediaPlayer.$videoViewContainer.append(mediaPlayer.$videoContainer);

            if (loadingIcon.length) {
                loadingIcon.fadeOut('normal', function () {
                    loadingIcon.remove();
                    fnAppendVideoPlayer();
                });
            } else {
                fnAppendVideoPlayer();
            }
        },

        videoUpdate: function (index, oVideos) {
            var mediaIndex = index,
                mediaSrc = $('#prodVideoView .videoPosition').attr('data-url'),
                updatedMediaSrc,
                fileType,
                playerType,
                loadingIcon = '<span class="ajax-loader" />';

            if (oVideos) {
                updatedMediaSrc = oVideos.mediaSrc;
                fileType = oVideos.fileType;
                playerType = oVideos.playerType;
            } else {
                updatedMediaSrc = window._mediaCollectionUpdated[mediaIndex].url;
                fileType = window._mediaCollectionUpdated[mediaIndex].fileType;
                playerType = window._mediaCollectionUpdated[mediaIndex].playerType;
            }

            try {
                if (updatedMediaSrc !== undefined) {
                    if (updatedMediaSrc !== mediaSrc) {
                        this.currentIndex = index;
                        $('#prodVideoView').remove();
                        $('#s7container').append(loadingIcon);
                        carouselPositionIndicator.setIndicatorUpdate('video', mediaIndex, 'jump');
                        mediaPlayer.$videoViewContainer = $('<div/>').attr('id', mediaPlayer.videoViewContId).addClass('videoView');
                        mediaPlayer.$videoContainer = $('<div/>').addClass('videoContainer').attr('data-fullscreen', 'false');

                        if (playerType === 'flash') {
                            if (common.isIOS()) {
                                mediaPlayer.errorHandler('Sorry this video format cannot be played on your device', mediaIndex); // video does not support iOS
                            } else {
                                mediaPlayer.videoRender('flash', updatedMediaSrc, mediaIndex);
                            }
                        } else if (playerType === 'html5') {
                            if (common.isLegacyIe() && !mediaPlayer.bMediaViewer) {
                                mediaPlayer.videoRender('flash', updatedMediaSrc, mediaIndex); // old pdpscene7 player pushes flash player in ie8 and ie9
                            } else if (common.isLegacyIe(8) && mediaPlayer.bMediaViewer) {
                                mediaPlayer.videoRender('flash', updatedMediaSrc, mediaIndex); // new pdpscene7 player pushes flash player in ie8
                            } else {
                                if (fileType === 'mp4' && common.isOpera()) {
                                    mediaPlayer.errorHandler('Sorry this video format cannot be played on your device', mediaIndex); // video does not support opera
                                } else {
                                    mediaPlayer.videoRender('html5', updatedMediaSrc, mediaIndex);
                                }
                            }
                        } else {
                            mediaPlayer.errorHandler('Sorry this video format cannot be played on your device', mediaIndex); // logic failed to decode player type
                        }
                    } else {
                        mediaPlayer.errorHandler("00DUP", mediaIndex); // duplicate video
                    }
                } else {
                    mediaPlayer.errorHandler("Sorry this video format cannot be played on your device", mediaIndex); // no video url
                }
            } catch (err) {
                mediaPlayer.errorHandler("Sorry this video cannot be played", mediaIndex); // general error
            }
        },

        init: function () {
            var fileType = window._mediaCollectionUpdated[mediaPlayer.mediaIndex].fileType,
                playerType = window._mediaCollectionUpdated[mediaPlayer.mediaIndex].playerType,
                url = window._mediaCollectionUpdated[mediaPlayer.mediaIndex].url,
                index = 0;

            this.$componentContainer = $(this.$componentContainer);

            if (mediaPlayer.$videoViewContainer === null) {
                carouselPositionIndicator.setIndicatorInit('video');
                carouselPositionIndicator.setIndicatorReset('video');
                mediaPlayer.$videoViewContainer = $('<div/>').attr('id', mediaPlayer.videoViewContId).addClass('videoView');
                mediaPlayer.$videoContainer = $('<div/>').addClass('videoContainer');

                if (playerType === 'flash') {
                    if (common.isIOS()) {
                        mediaPlayer.errorHandler('Sorry this video format cannot be played on your device', index);
                    } else {
                        mediaPlayer.videoRender('flash', url, 0);
                    }
                } else if (playerType === 'html5') {
                    if (common.isLegacyIe()) {
                        mediaPlayer.videoRender('flash', url, 0);
                    } else {
                        if (fileType === 'mp4' && common.isOpera()) {
                            mediaPlayer.errorHandler('Sorry this video format cannot be played on your device', index);
                        } else {
                            mediaPlayer.videoRender('html5', url, 0);
                        }
                    }
                } else {
                    mediaPlayer.errorHandler('Sorry this video format cannot be played on your device', index);
                }

                $(window).resize(function () {
                    $('.videoContainer').css('opacity', '0');
                });
            }
        },

        getCurrentVideo: function getCurrentVideo() {
            return this.videoPlayers[this.currentIndex];
        },
        playCurrentVideo: function playCurrentVideo() {
            mediaPlayer.$videoContainer.trigger('mediaViewer.play');
        },
        pauseCurrentVideo: function pauseCurrentVideo(bCreateIcon) {
            var $currentVideo = $('.videoContainer video');

            if ($currentVideo.length) {
                $('button.play').removeClass(mediaPlayer.oBasicVideoPlayerOpts.pauseClass);
                if (!$currentVideo[0].paused) {
                    $currentVideo[0].pause();
                    if (bCreateIcon) {
                        mediaPlayer.videoPlayers[0].iconHandler('pause', 'create');
                    }
                }
            }
        }
    };

    return mediaPlayer;
});

/*jslint plusplus: true */
/*globals define */
define('modules/pdp-s7viewer/tabHandler', ['domlib'], function ($) {
    'use strict';

    var tabHandler,
        sMediaControls = '.media-controls',
        numberOfTabsToShow = null,
        $currentTab,
        configureMediaTabs,
        setCurrentTabClass;

    configureMediaTabs = function configureMediaTabs(iMediaTypeCount) {
        switch (iMediaTypeCount) {
        case (0):
            break;
        case (1):
            numberOfTabsToShow = 'one-pdpproducts';
            break;
        case (2):
            numberOfTabsToShow = 'two-pdpproducts';
            break;
        case (3):
            numberOfTabsToShow = 'three-pdpproducts';
            break;
        }
        $(sMediaControls).css({ position: 'relative', left: '0px'}).children('div:visible').addClass(numberOfTabsToShow).not(':first').addClass('pdpproducts-notFirstButton');
    };

    setCurrentTabClass = function setCurrentTabClass(el) {
        $currentTab = $(el);
        $currentTab.parent().find('.current').removeClass('current');
        $currentTab.addClass('current');
    };

    tabHandler = {
        configureMediaTabs : configureMediaTabs,
        setCurrentTabClass : setCurrentTabClass
    };

    return tabHandler;
});
/*jslint plusplus: true */
/*globals define */
define('modules/pdp-s7viewer/arrowsHandler', ['domlib', 'modules/breakpoint'], function ($, breakpoint) {
    'use strict';

    var arrowsHandler,
        sScene7Container = '#pdpScene7Container',
        sCurrentVideo = '.videoPosition video',
        sNextPrevButtonSelector = '.btn-s7-step',
        ARROWSFADEINTIME = 50,
        ARROWSFADEOUTTIME = 400,
        sProductCarousel = '#product-carousel',
        mediaNavigationArrowsTimeout = null,
        currentTab,
        showMediaNavigationArrows,
        hideMediaNavigationArrows,
        mediaNavigationArrowsEventHandler,
        detectIfArrowsRequired,
        manuallyHideArrows,
        mediaNavigationArrowsTimeoutCheck,
        initMediaNavigationArrows;

    currentTab = function currentTab(request) {
        var bStatus = $(sProductCarousel).hasClass(request) ? true : false;
        return bStatus;
    };

    showMediaNavigationArrows = function showMediaNavigationArrows() {
        if (currentTab('videoVisible')) {
            $(sNextPrevButtonSelector + ', .video-controls').stop(true).fadeIn(ARROWSFADEINTIME);
        } else {
            $(sNextPrevButtonSelector).stop(true).fadeIn(ARROWSFADEINTIME);
        }
    };

    hideMediaNavigationArrows = function hideMediaNavigationArrows() {
        if (!$('#lightbox').is(':visible')) {
            if (currentTab('videoVisible')) {
                if (!breakpoint.mobile) {
                    $(sNextPrevButtonSelector + '.video-controls').stop(true).fadeOut(ARROWSFADEOUTTIME);
                }
            } else {
                $(sNextPrevButtonSelector).stop(true).fadeOut(ARROWSFADEOUTTIME);
            }
        }
    };

    mediaNavigationArrowsEventHandler = function mediaNavigationArrowsEventHandler(inputType) {
        if (inputType === 'mouse') {
            var mouseEventsTimerHandler = null;
            showMediaNavigationArrows();
            $(sScene7Container).mousemove(function () {
                clearTimeout(mouseEventsTimerHandler);
                mouseEventsTimerHandler = setTimeout(function () {
                    if (!$(sNextPrevButtonSelector).is(":visible")) {
                        showMediaNavigationArrows();
                    }
                    if (currentTab('videoVisible')) {
                        clearTimeout(mediaNavigationArrowsTimeout);
                        if ($(sCurrentVideo).length) {
                            if (!$(sCurrentVideo)[0].paused) {
                                mediaNavigationArrowsTimeoutCheck();
                            }
                        }
                    }
                }, 100);
            });
            $(sScene7Container).mouseleave(function () {
                if (currentTab('videoVisible')) {
                    if ($(sCurrentVideo).length) {
                        if (!$(sCurrentVideo)[0].paused) {
                            hideMediaNavigationArrows();
                        }
                    }
                } else if (currentTab('zoomVisible')) {
                    hideMediaNavigationArrows();
                }
            });
        } else if (inputType === 'touch') {
            showMediaNavigationArrows();
            $(sScene7Container).on('click', '.videoContainer', function () {
                if ($(sCurrentVideo).length) {
                    if ($(sCurrentVideo)[0].paused) {
                        showMediaNavigationArrows();
                    } else {
                        hideMediaNavigationArrows();
                    }
                }
            });
        }
    };

    detectIfArrowsRequired = function detectIfArrowsRequired() {
        var $arrows = $('.hot-area .btn-s7-step');
        return !($arrows.length === $arrows.filter('.disabled').length);
    };

    manuallyHideArrows = function manuallyHideArrows() {
        var $mediaContainer = $('.videoVisible');

        if (!detectIfArrowsRequired()) {
            $mediaContainer.addClass('hideArrows');
        }
    };

    mediaNavigationArrowsTimeoutCheck = function mediaNavigationArrowsTimeoutCheck() {
        mediaNavigationArrowsTimeout = setTimeout(function () {
            hideMediaNavigationArrows();
        }, 4000);
    };

    initMediaNavigationArrows = function initMediaNavigationArrows(iImageSetCount) {
        $(sScene7Container).append('<div class="hot-area prev"><div id="btn-s7-prev" class="btn-s7-step btn-s7-prev disabled"></div></div>').append('<div class="hot-area next"><div id="btn-s7-next" class="btn-s7-step btn-s7-next disabled"></div></div>');
        if (iImageSetCount > 1) {
            $('#btn-s7-next').removeClass('disabled');
        }
    };

    arrowsHandler = {
        mediaNavigationArrowsEventHandler : mediaNavigationArrowsEventHandler,
        mediaNavigationArrowsTimeoutCheck : mediaNavigationArrowsTimeoutCheck,
        hideMediaNavigationArrows : hideMediaNavigationArrows,
        showMediaNavigationArrows : showMediaNavigationArrows,
        manuallyHideArrows : manuallyHideArrows,
        initMediaNavigationArrows : initMediaNavigationArrows
    };

    return arrowsHandler;
});
/*jslint plusplus: true */
/*jslint nomen: true*/
/*global define: true, window: true, serverUrl: true, s7sdk: true, _mediaCollectionUpdated: true, spin_set: true, image_set: true, globalStaticAssetsPath: true, spinViewScrubber: true, swatchSelected: true, _s7VideoSet: true, refEvar22: true, refEvar24: true */
define('modules/pdp-s7viewer/common', ['domlib', 'modules/breakpoint', 'modules/common', 'modules/basic-carousel/common', 'modules/media-player/common', 'modules/tesco.analytics', 'modules/device-specifications/common', 'modules/overlay/common', 'modules/pdp-s7viewer/tabHandler', 'modules/pdp-s7viewer/arrowsHandler'], function ($, breakpoint, common, BasicCarousel, mediaPlayer, analytics, deviceSpecifications, overlay, tabHandler, arrowsHandler) {
    'use strict';

    var sProductCarousel = '#product-carousel',
        sScene7Container = '#pdpScene7Container',
        sOverlay = '#overlay',
        sVirtualPage = '#virtual-page',
        sComponentContainer = '#s7container',
        imageViewerContainerId = 'prodZoomView',
        sSpinViewerContainerId = 'prodSpinView',
        sSpinThumb = '<img class="s7-spin-thumb"/>',
        sPdpMainDetailsContainer = '.main-details',
        sMediaOverlayButton = '#btn-overlay',
        sVideoWrapper = '.videoPosition',
        sImageViewerThumbnailCarousel = '#product-thumb-carousel',
        sMobileImageViewerThumbnailCarousel = '#product-thumb-carousel-gallery',
        sFlashVideoObject = '#s7FlashVideoPlayer',
        sVideoTabButton = '#pdp-product-video',
        sImageTabButton = '#pdp-product-zoom',
        sSpinTabButton = '#pdp-product-spin',
        sZoomViewerCanvas = '#prodZoomView div canvas',
        sReducedFurnitureClass = 'pdp-reduced-furniture',
        $tmpMediaContent = null,
        zoomViewVisible = true,
        videoViewVisible = false,
        spinViewVisible = false,
        spinViewSku = null,
        s7container = null,
        s7params = null,
        spinViewScrubber,
        aImageSet = [],
        iImageSetCount,
        imageSetThumbMarkup,
        sMediaNavigationArrows = '#prodZoomView .btn-s7-step',
        sMobileS7SetIndicator = '.s7setindicator',
        sNextPrevButtonSelector = '.btn-s7-step',
        sZoomViewSelector = '.s7zoomview',
        sMobileS7SetIndicatorImageViewer = '#prodZoomView ' + sMobileS7SetIndicator,
        $imageViewerComponent,

        // classes
        ImageViewer = null,
        SpinViewer = null,
        SetIndicator = null,
        ThumbCarousel = null,
        VideoCarousel = null,
        MediaSet = null,

        // method declarations
        refreshScene7GlobalVars,
        resetMediaUIComponents,
        resizeMediaComponent,
        reinitialiseActiveVideoObjects,
        hideAndShowImageViewer,
        fadeInImageViewer,
        mediaOverlayHandler,
        renderOverlay,
        cleanMediaControls,
        detectCurrentMediaTab,
        hideAllMediaUIComponents,
        pauseCurrentVideo,
        setVideoBusyTimer,
        videoThumbCarousel,
        requestAnimFrame,
        initSpinViewerScrubber,
        spinViewerReady,
        spinViewerHandler,
        showSpinViewerVirtualPage,
        showVideoViewer,
        showSpinViewer,
        showImageViewer,
        productInfoView,
        mediaTabHandler,
        resetImageViewerZoomLevel,
        nextMediaItem,
        prevMediaItem,
        bindMediaComponentEventHandlers,
        doZoomReset,
        setZoomImage,
        delayResize,
        updateSetIndicator,
        initSetIndicator,
        createImageViewerThumbsMarkup,
        initImageViewerThumbs,
        blockZoomedImageViewerSwiping,
        initImageViewer,
        configureScene7Params,
        initScene7Container,
        initScene7MediaSet,
        showOverlayButton,
        isScene7Enabled,
        isImageViewerEnabled,
        isSpinViewerEnabled,
        isVideoEnabled,
        scene7DomReadyCheckTimer,
        scene7DomReadyCheck,
        initScene7Dependencies,
        setScene7ImageMode,
        fallbackToStaticImage,
        syncDesktopAndMobileImagePositions,
        mediaTypeCount,
        init = function init() {
            if (common.isPage('PDP') && isScene7Enabled() && $('#pdpScene7Container').length > 0) {
                try {
                    $(sPdpMainDetailsContainer).addClass('htmlViewer');
                    refreshScene7GlobalVars();
                    resetMediaUIComponents();
                    setScene7ImageMode();
                    initScene7Dependencies();
                    tabHandler.configureMediaTabs(mediaTypeCount());
                } catch (err) {
                    fallbackToStaticImage();
                }
            }
        },
        pdpScene7 = {
            scene7data: null,
            s7ServerUrl: null,
            s7ImageSet: null,
            s7SpinSet: null,
            s7VideoSet: null,
            mobileGalleryInDom: false,
            virtualPageInMotion: false,
            s7ZoomedIn: false,
            s7ZoomTimer: false,
            s7ZoomMouseEnter: null,
            s7ZoomMouseExit: null,
            s7EnterTimeoutDuration: 50,
            s7ExitTimeoutDuration: 200,
            videoVisible: false,
            videoThumbCarouselInDom: false,
            videoBusyTimer: null,
            videoBusyTimerDuration: 350,
            videoBusy: false,
            scene7DomReadyCheckInterval: null,
            scene7ImageMode: 'flyoutViewer',

            getVideoCarousel: function () {
                return VideoCarousel;
            },

            mobileIn: function () {
                if ($(sOverlay).length) {
                    mediaOverlayHandler(detectCurrentMediaTab(), 'hideOverlay');
                    overlay.hide();
                }
                resetImageViewerZoomLevel();
                doZoomReset();
            },

            mobileOut: function () {
                resetImageViewerZoomLevel();
                doZoomReset();
                $(sMobileS7SetIndicatorImageViewer + ', ' + sZoomViewerCanvas + ', ' + sMediaNavigationArrows).css({
                    opacity: '1',
                    display: 'block'
                });
            },

            overrideScene7WindowDetect: function () {
                s7sdk.Window.monitorSize = function () {
                    s7sdk.browser.screensize = s7sdk.browser.detectScreen();
                    if (Math.abs(s7sdk.Window.currentSize.h - s7sdk.browser.screensize.h) > 100) {
                        if (s7sdk.Window.currentSize.w !== s7sdk.browser.screensize.w || s7sdk.Window.currentSize.h !== s7sdk.browser.screensize.h) {
                            s7sdk.Window.currentSize = s7sdk.browser.screensize;
                            s7sdk.Window.sendNotifications();
                        }
                    }
                    if ((new Date()).getTime() > s7sdk.Window.monitorSizeTimeout) {
                        clearInterval(s7sdk.Window.monitorSizeTimer);
                        s7sdk.Window.monitorSizeTimer = null;
                    }
                };
            },
            init: init
        };

    mediaTypeCount = function mediaTypeCount() {
        var iMediaTypeCount = 0;

        if (pdpScene7.scene7data.s7ImageSet.length > 0) {
            iMediaTypeCount += 1;
        }
        if (pdpScene7.scene7data._s7VideoSet.length > 0) {
            iMediaTypeCount += 1;
        }
        if (pdpScene7.scene7data.s7SpinSet.length > 0) {
            iMediaTypeCount += 1;
        }

        return iMediaTypeCount;
    };

    syncDesktopAndMobileImagePositions = function syncDesktopAndMobileImagePositions(index) {
        $(sImageViewerThumbnailCarousel + ' ul li').eq(index).trigger('click');
    };

    refreshScene7GlobalVars = function refreshScene7GlobalVars() {
        pdpScene7.scene7data = window.TescoData.pdp.scene7;
        pdpScene7.s7ServerUrl = window.TescoData.pdp.scene7.s7ServerUrl;
        pdpScene7.s7ImageSet = window.TescoData.pdp.scene7.s7ImageSet;
        pdpScene7.s7SpinSet = window.TescoData.pdp.scene7.s7SpinSet;
        pdpScene7.s7VideoSet = window.TescoData.pdp.scene7._s7VideoSet;
    };

    resetMediaUIComponents = function resetMediaUIComponents() {
        mediaPlayer.$videoViewContainer = VideoCarousel = ThumbCarousel = null;
        if (pdpScene7.videoThumbCarouselInDom) {
            pdpScene7.videoThumbCarouselInDom = false;
        }
        if (_mediaCollectionUpdated.length === 0) {
            $(sVideoTabButton).hide();
        }
        if (pdpScene7.s7SpinSet.length === 0) {
            $(sSpinTabButton).hide();
        }
        $('#s7container, #prodZoomView, #prodZoomView div, #prodZoomView div div, #prodZoomView div div canvas, ' + sMobileImageViewerThumbnailCarousel + ' ul, ' + sMobileImageViewerThumbnailCarousel + ' ul li').removeAttr('style');
    };

    resizeMediaComponent = function resizeMediaComponent(callback) {
        var contWidth = $(sScene7Container).width(),
            deltaWidth = contWidth,
            height = $(sScene7Container).height();

        if (!window.isKiosk()) {
            if (breakpoint.mobile && common.isIOS()) { // Andy - this is a dodgy hack to fix iPhone bug which sets the height of the canvas on orientation change to 480.
                height = height > 400 ? deltaWidth : height;
            }
            s7container.resize(deltaWidth, height);
            if (ImageViewer) {
                $(sZoomViewSelector).css('margin-left', '0');
                ImageViewer.resize(deltaWidth, height);
            }
            if (SpinViewer) {
                SpinViewer.resize(deltaWidth, height);
            }
            if (zoomViewVisible && ThumbCarousel) {
                ThumbCarousel.calculateVisibleItems();
            }
            if (videoViewVisible) {
                if (VideoCarousel) {
                    if ($('span.play-icon').length < 1) {
                        pauseCurrentVideo('createIcon');
                    }
                    $('#prodVideoView .videoContainer').animate({
                        opacity: 1
                    }, 350, function () {
                        $(this).removeAttr('style');
                    });
                    VideoCarousel.calculateVisibleItems();
                }
            }
            $(window).trigger('scene7Resized');
        }
        if (callback !== undefined && callback !== null) {
            callback();
        }
    };

    reinitialiseActiveVideoObjects = function reinitialiseActiveVideoObjects() {
        var flashObj;

        if (VideoCarousel !== null && videoViewVisible) {
            try {
                mediaPlayer.getCurrentVideo().seekBarSlider.resize();
            } catch (e) {
                flashObj = $(sFlashVideoObject).clone(); // if flash video trigger reload to reinitialise ActiveX component
                $(sFlashVideoObject).remove();
                $(sVideoWrapper).append(flashObj);
            }
        }
    };

    hideAndShowImageViewer = function hideAndShowImageViewer() {
        if ($('canvas', $(sProductCarousel)).length) {
            $imageViewerComponent = $('canvas', $(sProductCarousel));
        }
        if ($('#prodZoomView div div img').length) {
            $imageViewerComponent = $('#prodZoomView div div img');
        }
        if ($('.s7flyoutzoomview > div > img').length) {
            $imageViewerComponent = $('.s7flyoutzoomview > div > img').first();
        }
        $imageViewerComponent.hide();
    };

    fadeInImageViewer = function fadeInImageViewer() {
        if (zoomViewVisible) {
            doZoomReset();
            $imageViewerComponent.fadeIn(100);
        }
    };

    mediaOverlayHandler = function mediaOverlayHandler(currentMedia, overlayState) {
        switch (currentMedia) {
        case 'imageViewer':
            hideAndShowImageViewer();
            break;
        case 'spinViewer':
            resizeMediaComponent();
            reinitialiseActiveVideoObjects();
            break;
        case 'videoViewer':
            if (VideoCarousel !== null) {
                if ($('span.play-icon').length < 1) {
                    pauseCurrentVideo('createIcon');
                }
            }
            resizeMediaComponent();
            reinitialiseActiveVideoObjects();
            break;
        }

        if (overlayState === 'showOverlay') {
            cleanMediaControls();
        }
        if (overlayState === 'hideOverlay') {
            $('.details-container:first').after($(sProductCarousel).detach());
            resizeMediaComponent(fadeInImageViewer);
        }
    };

    renderOverlay = function renderOverlay(e) {
        var overlayOptions;

        e.stopImmediatePropagation();
        mediaOverlayHandler(detectCurrentMediaTab(), 'showOverlay');
        $tmpMediaContent = $(sProductCarousel).detach();
        overlayOptions = {
            hideOnOverlayClick: true,
            hideOnEsc: true,
            content: $tmpMediaContent,
            customClass: 'pdpS7Overlay',
            fixedWidth: '',
            isError: false,
            onHideCallback: function () {
                mediaOverlayHandler(detectCurrentMediaTab(), 'hideOverlay');
            },
            defaultBreakPointBehavior: true
        };
        overlay.show(overlayOptions);
        resizeMediaComponent(fadeInImageViewer);
        $(sOverlay).css('height', '100%').addClass('dark');
    };

    cleanMediaControls = function cleanMediaControls() {
        $(sNextPrevButtonSelector + ', .video-controls').removeAttr('style');
    };

    detectCurrentMediaTab = function detectCurrentMediaTab() {
        var sCurrentMediaTab = null;

        if (zoomViewVisible) {
            sCurrentMediaTab = 'imageViewer';
        }
        if (spinViewVisible) {
            sCurrentMediaTab = 'spinViewer';
        }
        if (videoViewVisible) {
            sCurrentMediaTab = 'videoViewer';
        }
        return sCurrentMediaTab;
    };

    hideAllMediaUIComponents = function hideAllMediaUIComponents() {
        $(sProductCarousel).removeClass('zoomVisible');
        $(sProductCarousel).removeClass('videoVisible');
        $(sProductCarousel).removeClass('spinVisible');
        $(sProductCarousel).removeClass('prodInfoVisible');
    };

    pauseCurrentVideo = function pauseCurrentVideo(createIcon) {
        if (VideoCarousel) {
            var $currentVideo = $('.videoContainer video'),
                createPauseIcon;
            if ($currentVideo.length) {
                $('button.play').removeClass('paused');
                if (!$currentVideo[0].paused) {
                    $currentVideo[0].pause();
                    arrowsHandler.showMediaNavigationArrows();
                    if (createIcon) {
                        createPauseIcon = '<span class="pause-icon">Pause video</span>';
                        $(sVideoWrapper).append(createPauseIcon);
                        setTimeout(function () {
                            $('span.pause-icon').addClass('hide-video-icon');
                            setTimeout(function () {
                                $('span.pause-icon').remove();
                            }, 1000);
                        }, 250);
                    }
                }
            }
        }
    };

    setVideoBusyTimer = function setVideoBusyTimer() {
        clearTimeout(pdpScene7.videoBusyTimer);
        pdpScene7.videoBusyTimer = setTimeout(function () {
            pdpScene7.videoBusy = false;
            clearTimeout(pdpScene7.videoBusyTimer);
        }, pdpScene7.videoBusyTimerDuration);
    };

    videoThumbCarousel = function videoThumbCarousel() {
        var videoThumbnails = '',
            i,
            selectedThumb;

        if (videoThumbnails === '') {
            for (i = 0; i < _mediaCollectionUpdated.length; i++) {
                videoThumbnails += '<li class="video-thumb" data-index="' + i + '"><img src="' + globalStaticAssetsPath + 'video/thumb.png" width="40" height="40" alt="Tesco Video" /></li>';
            }
        }
        VideoCarousel = new BasicCarousel({
            elementId: 'product-thumb-carousel-videos',
            isHorizontal: true,
            content: videoThumbnails
        });
        $('#product-thumb-carousel-videos .carousel-slider .carousel-items-container li').on('click', function (event) {
            selectedThumb = $(event.target).closest('li').data('index');
            mediaPlayer.videoUpdate(selectedThumb);
        });
    };

    requestAnimFrame = (function () { // shim with setTimeout fallback
        return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame ||
            function (callback) {
                window.setTimeout(callback, 1000 / 60);
            };
    }());

    initSpinViewerScrubber = function initSpinViewerScrubber() {
        spinViewScrubber = new s7sdk.set.PageScrubber('s7container', s7params, 's7Scrubber');
        spinViewScrubber.setAsset(pdpScene7.s7SpinSet);
        spinViewScrubber.resize($('#pdpScene7Container').width() - 20, 55);
        spinViewScrubber.addEventListener(s7sdk.event.SliderEvent.NOTF_SLIDER_MOVE, function () {
            SpinViewer.setCurrentFrameIndex(spinViewScrubber.getCurrentFrameIndex());
        }, false);
        SpinViewer.addEventListener(s7sdk.event.AssetEvent.ASSET_CHANGED, function () {
            spinViewScrubber.setCurrentFrameIndex(SpinViewer.getCurrentFrameIndex());
        }, false);
    };

    spinViewerReady = function spinViewerReady() {
        var fLength = SpinViewer.getFramesLength(),
            i = 0;

        function spinProduct() {
            if (i < fLength) {
                setTimeout(function () {
                    SpinViewer.setCurrentFrameIndex(i++);
                    requestAnimFrame(spinProduct);
                }, 1000 / 8);
            } else {
                SpinViewer.setCurrentFrameIndex(0);
            }
        }
        requestAnimFrame(spinProduct);
    };

    spinViewerHandler = function spinViewerHandler() {
        showSpinViewer();
        resizeMediaComponent();
        if (breakpoint.mobile) {
            showSpinViewerVirtualPage();
        }
    };

    showSpinViewerVirtualPage = function showSpinViewerVirtualPage() {
        common.virtualPage.show({
            content: $('#' + sSpinViewerContainerId),
            showBack: true,
            showBanner: '<span class="icon" data-icon="g" aria-hidden="true"></span>Drag to rotate 360&deg;<span class="icon" data-icon="r" aria-hidden="true"></span>',
            title: $('h1.page-title').text(),
            beforeRemoval: function () {
                $(sComponentContainer).append($('#' + sSpinViewerContainerId));
                $(sSpinTabButton).removeClass('current');
                $(sImageTabButton).addClass('current').trigger('click');
            }
        });
        $(sVirtualPage).addClass(sReducedFurnitureClass); // add custom class to reduce screen 'furniture' on landscape devices
    };

    showVideoViewer = function showVideoViewer() { // video tab clicked
        pdpScene7.videoVisible = true;
        $(sProductCarousel).addClass('videoVisible');
        if (!pdpScene7.videoThumbCarouselInDom) {
            videoThumbCarousel();
            VideoCarousel.checkArrows();
            pdpScene7.videoThumbCarouselInDom = true;
        } else {
            VideoCarousel.checkArrows();
        }
        mediaPlayer.init();
    };

    showSpinViewer = function showSpinViewer() { // spin viewer tab clicked
        var spinViewContId = "prodSpinView",
            skuIdVal = $('#skuIdVal').val(),
            spinThumbSource;

        $(sProductCarousel).addClass('spinVisible');
        pdpScene7.videoVisible = false;
        if (SpinViewer === null || spinViewSku !== skuIdVal) {
            spinViewSku = skuIdVal;
            spinThumbSource = pdpScene7.s7ServerUrl + "/" + pdpScene7.s7SpinSet + "?wid=50&hei=50";
            SpinViewer = new s7sdk.set.SpinView("s7container", s7params, spinViewContId);
            setTimeout(spinViewerReady, 1350); // there is no event fired when all images are loaded so set timeout to initiate spin rotation
            $(sSpinThumb).attr("src", spinThumbSource).css('visiblity', 'hidden');
            $(sScene7Container).after($(sSpinThumb));
            $(sComponentContainer).append($(sSpinViewerContainerId));
            initSpinViewerScrubber();
        }
    };

    showImageViewer = function showImageViewer() { // image viewer tab clicked
        $(sProductCarousel).addClass('zoomVisible');
        pdpScene7.videoVisible = false;
        ThumbCarousel.checkArrows();
    };

    productInfoView = function productInfoView() {
        $(sProductCarousel).addClass('prodInfoVisible');
    };

    mediaTabHandler = function mediaTabHandler(event) {
        var target = event.currentTarget,
            tabIndex = parseInt($(target).attr('data-tab'), 10),
            $ping = $(sProductCarousel).find('.product-ping'),
            _oWebAnalytics = new analytics.WebMetrics(),
            v = {},
            breadCrumbText = [],
            text;

        tabHandler.setCurrentTabClass(event.currentTarget);
        hideAllMediaUIComponents();
        $('li a', $('#breadcrumb')).each(function () {
            text = $.trim($(this).text());
            breadCrumbText.push(text);
        });

        if (breadCrumbText[1]) {
            v.prop1 = breadCrumbText[1];
        }
        if (breadCrumbText[2]) {
            v.prop2 = breadCrumbText[2];
        }
        if (breadCrumbText[3]) {
            v.prop3 = breadCrumbText[3];
        }

        breadCrumbText.length = 0;

        v.eVar56 = deviceSpecifications.os;
        v.prop23 = deviceSpecifications.os;
        if (refEvar22 !== undefined) {
            v.eVar22 = refEvar22;
        }
        if (refEvar24 !== undefined) {
            v.eVar24 = refEvar24;
        }

        switch (tabIndex) {
        case 0:
            showImageViewer();
            v.prop19 = 'Image Tab';
            v.events = 'event19';
            zoomViewVisible = true;
            videoViewVisible = spinViewVisible = false;
            $(sVideoTabButton).removeClass('triggerRepaint');
            if (VideoCarousel !== null) {
                pauseCurrentVideo();
            }
            if (ThumbCarousel !== null) {
                ThumbCarousel.calculateVisibleItems();
            }
            $ping.show();
            break;
        case 1:
            showVideoViewer();
            v.prop19 = 'Video Tab';
            v.events = 'event19';
            videoViewVisible = true;
            zoomViewVisible = spinViewVisible = false;
            if (VideoCarousel !== null) {
                VideoCarousel.calculateVisibleItems();
                pauseCurrentVideo();
            }
            $ping.hide();
            arrowsHandler.manuallyHideArrows();
            break;
        case 2:
            showSpinViewer();
            v.events = 'prodView,event3,event67';
            spinViewVisible = true;
            zoomViewVisible = videoViewVisible = false;
            $(sVideoTabButton).removeClass('triggerRepaint');
            if (VideoCarousel !== null) {
                pauseCurrentVideo();
            }
            $ping.hide();
            break;
        case 3:
            productInfoView();
            spinViewVisible = zoomViewVisible = videoViewVisible = false;
            $(sVideoTabButton).removeClass('triggerRepaint');
            if (VideoCarousel !== null) {
                pauseCurrentVideo();
            }
            $ping.hide();
            break;
        }
        _oWebAnalytics.submit([v]);
    };

    resetImageViewerZoomLevel = function resetImageViewerZoomLevel() {
        pdpScene7.s7ZoomedIn = false;
    };

    nextMediaItem = function nextMediaItem(event) {
        var currentVideoIndex,
            newVideoIndex;
        event.stopImmediatePropagation();
        if (ThumbCarousel) {
            if (event.type === 'click') {
                if (pdpScene7.videoVisible) {
                    setVideoBusyTimer();
                    if (!pdpScene7.videoBusy) {
                        currentVideoIndex = $(sVideoWrapper).data('index');
                        newVideoIndex = currentVideoIndex + 1;
                        if (newVideoIndex >= 0 && newVideoIndex < pdpScene7.s7VideoSet.length) {
                            mediaPlayer.videoUpdate(newVideoIndex);
                            VideoCarousel.next();
                            pdpScene7.videoBusy = true;
                            setVideoBusyTimer();
                        }
                    }
                } else {
                    ThumbCarousel.next();
                    resetImageViewerZoomLevel();
                }
            } else if (event.type === 'swipeLeft') {
                if (!pdpScene7.s7ZoomedIn) {
                    ThumbCarousel.next();
                    resetImageViewerZoomLevel();
                }
            }
        }
    };

    prevMediaItem = function prevMediaItem(event) {
        var currentVideoIndex,
            newVideoIndex;
        event.stopImmediatePropagation();
        if (ThumbCarousel) {
            if (event.type === 'click') {
                if (pdpScene7.videoVisible) {
                    setVideoBusyTimer();
                    if (!pdpScene7.videoBusy) {
                        currentVideoIndex = $(sVideoWrapper).data('index');
                        newVideoIndex = currentVideoIndex - 1;
                        if (newVideoIndex >= 0 && newVideoIndex < pdpScene7.s7VideoSet.length) {
                            mediaPlayer.videoUpdate(newVideoIndex);
                            VideoCarousel.prev();
                            pdpScene7.videoBusy = true;
                            setVideoBusyTimer();
                        }
                    }
                } else {
                    ThumbCarousel.prev();
                    resetImageViewerZoomLevel();
                }
            } else if (event.type === 'swipeRight') {
                if (!pdpScene7.s7ZoomedIn) {
                    ThumbCarousel.prev();
                    resetImageViewerZoomLevel();
                }
            }
        }
    };

    bindMediaComponentEventHandlers = function bindMediaComponentEventHandlers() {
        $(sProductCarousel).on('click', '.button', $.proxy(mediaTabHandler, this));
        $(sProductCarousel).on('click', sMediaOverlayButton, renderOverlay);
        $(sProductCarousel).on('click', '#pdpScene7Container div.hot-area.next', nextMediaItem);
        $(sProductCarousel).on('click', '#pdpScene7Container div.hot-area.prev', prevMediaItem);
        $(sProductCarousel).on('click', sImageViewerThumbnailCarousel + ' ul li', resetImageViewerZoomLevel);
        if (common.isTouch()) {
            if (breakpoint.mobile) {
                arrowsHandler.showMediaNavigationArrows();
            } else {
                arrowsHandler.mediaNavigationArrowsEventHandler('touch');
            }
        } else {
            arrowsHandler.mediaNavigationArrowsEventHandler('mouse');
        }
    };

    doZoomReset = function doZoomReset(e) {
        try {
            if ($(e.toElement).is('img')) {
                e.preventDefault();
                return false;
            }
        } catch (ignore) {}

        if (ImageViewer && pdpScene7.scene7ImageMode === 'zoomViewer') {
            ImageViewer.zoomReset();
        }
    };

    setZoomImage = function setZoomImage(index) {
        if (ImageViewer) {
            ImageViewer.setItem(aImageSet[index]);
        }
        if (!common.isTouch() && SetIndicator) {
            SetIndicator.setSelectedPage(index);
        }
    };

    delayResize = function delayResize() {
        setTimeout(resizeMediaComponent, 500);
    };

    updateSetIndicator = function updateSetIndicator(event) {
        if (SetIndicator) {
            SetIndicator.setSelectedPage(event.s7event.frame);
        }
        if (common.isTouch()) {
            syncDesktopAndMobileImagePositions(event.s7event.frame);
        }
    };

    initSetIndicator = function initSetIndicator(iImageSetCount) {
        SetIndicator = new s7sdk.SetIndicator(ImageViewer.compId, s7params, 's7setindicator');
        SetIndicator.setNumberOfPages(iImageSetCount);
        SetIndicator.setSelectedPage(0);
    };

    createImageViewerThumbsMarkup = function createImageViewerThumbsMarkup(images) {
        var tmbWidth = 270,
            tmbHeight = 270,
            qStr = '?wid=' + tmbWidth + '&hei=' + tmbHeight,
            i,
            l,
            imgTag,
            src,
            imgArray = [];

        for (i = 0, l = images.length; i < l; i++) {
            src = pdpScene7.s7ServerUrl + '/' + images[i].name + qStr;
            imgTag = '<li data-index="' + i + '" ><img src="' + src + '" /></li>';
            imgArray.push(imgTag);
        }
        return imgArray.join('');
    };

    initImageViewerThumbs = function initImageViewerThumbs(event) {
        aImageSet = event.s7event.asset.items;
        iImageSetCount = aImageSet.length;
        imageSetThumbMarkup = createImageViewerThumbsMarkup(aImageSet);

        ThumbCarousel = new BasicCarousel({
            elementId: 'product-thumb-carousel',
            isHorizontal: true,
            content: imageSetThumbMarkup,
            onItemClick: setZoomImage
        });
        return iImageSetCount;
    };

    blockZoomedImageViewerSwiping = function blockZoomedImageViewerSwiping() {
        var currentZoomEvent;

        ImageViewer.addEventListener(s7sdk.event.UserEvent.NOTF_USER_EVENT, function (event) { // scene7 event listener to catch user zooms on image viewer - if zooming this will stop the user swiping to the next asset until the user has zoomed out
            currentZoomEvent = event.s7event.toString();
            if (currentZoomEvent === 'ZOOM,40' || currentZoomEvent === 'ZOOM,40.01' || currentZoomEvent === 'ZOOM,100.01' || currentZoomEvent === 'ZOOM,100' || currentZoomEvent === 'PAN,' || currentZoomEvent === 'ZOOM,35.01') {
                pdpScene7.s7ZoomedIn = true;
            } else {
                resetImageViewerZoomLevel();
            }
        }, false);
    };

    /**
     *  @param {s7sdk.AssetEvent.NOTF_SET_PARSED} Event dispatched by s7sdk.set.MediaSet when set has finished parsing
     */
    initImageViewer = function initImageViewer(event) {
        iImageSetCount = initImageViewerThumbs(event);

        if (pdpScene7.scene7ImageMode === 'zoomViewer') {
            ImageViewer = new s7sdk.ZoomView("s7container", s7params, imageViewerContainerId);
            blockZoomedImageViewerSwiping();
            if (breakpoint.largeDesktop) {
                $(sZoomViewSelector).css('margin-left', '42.5px'); // one time css override to overcome a margin bug hence no css class
            }
        } else {
            ImageViewer = new s7sdk.FlyoutZoomView("s7container", s7params, imageViewerContainerId);
        }
        ImageViewer.setItem(event.s7event.asset.items[0]);
        ImageViewer.addEventListener(s7sdk.event.AssetEvent.ASSET_CHANGED, updateSetIndicator);
        initSetIndicator(iImageSetCount);
        if (common.isTouch()) {
            arrowsHandler.initMediaNavigationArrows(iImageSetCount);
        }
        ImageViewer.addEventListener(s7sdk.event.AssetEvent.ASSET_CHANGED, function (event) {
            pdpScene7.iCurrentImageAsset = event.s7event.frame;
        }, false);
        if (breakpoint.vTablet || breakpoint.hTablet || breakpoint.mobile) {
            resizeMediaComponent();
        }
    };

    configureScene7Params = function configureScene7Params() {
        var sZoomStepVal;
        pdpScene7.overrideScene7WindowDetect();
        s7params.push('serverurl', pdpScene7.s7ServerUrl);

        if (isImageViewerEnabled()) {
            s7params.push('MediaSet.asset', pdpScene7.s7ImageSet);
            if (pdpScene7.scene7ImageMode === 'zoomViewer') {
                s7params.push('ZoomView.frametransition', 'slide, 0.175');
                sZoomStepVal = breakpoint.mobile === true ? '0.8' : '0.5';
                s7params.push('ZoomView.zoomstep', '0,' + sZoomStepVal);
                s7params.push('ZoomView.iconeffect', '1, 1, 0.3, 5');
                s7params.push('ZoomView.transition', '0.25, 3');
                s7params.push('ZoomView.singleclick', 'none');
                s7params.push('ZoomView.iscommand', 'op_sharpen=1');
                if (window.isKiosk() || !common.cssTransitionsSupported()) {
                    s7params.push('ZoomView.doubleclick', 'none');
                } else {
                    s7params.push('ZoomView.doubleclick', 'zoomReset');
                }
            } else {
                s7params.push('FlyoutZoomView.fill', '#ffffff,1');
                s7params.push('FlyoutZoomView.imagereload', '1,breakpoint,300;600;1200');
                s7params.push('FlyoutZoomView.zoomfactor', '2.3,-1,1');
                s7params.push('FlyoutZoomView.overlay', '0');
                s7params.push('FlyoutZoomView.flyouttransition', 'none,1,0,1,0');
                s7params.push('FlyoutZoomView.highlightmode', 'cursor,1,free');
                s7params.push('FlyoutZoomView.iscommand', 'op_sharpen=1');
            }
        } else {
            fallbackToStaticImage();
            return false;
        }

        if (isSpinViewerEnabled()) {
            $(sPdpMainDetailsContainer).on('click', sSpinTabButton, spinViewerHandler);
            s7params.push('SpinView.asset', pdpScene7.s7SpinSet);
            s7params.push('SpinView.zoomstep', '1,1');
            s7params.push('SpinView.transition', '0.1, 0');
            if (breakpoint.mobile) {
                s7params.push('SpinView.iconeffect', '0');
            }
        }

        if (isVideoEnabled) {
            s7params.push("autoplay", "false");
        }

        initScene7Container();
        initScene7MediaSet();
        bindMediaComponentEventHandlers();
        setTimeout(function () {
            showOverlayButton();
        }, 750);
    };

    initScene7Container = function initScene7Container() {
        s7container = new s7sdk.Container("pdpScene7Container", s7params, "s7container");
        s7container.addEventListener(s7sdk.ResizeEvent.WINDOW_RESIZE, delayResize, false);
    };

    initScene7MediaSet = function initScene7MediaSet() {
        MediaSet = new s7sdk.MediaSet(null, s7params, null);
        MediaSet.addEventListener(s7sdk.AssetEvent.NOTF_SET_PARSED, initImageViewer, false);
    };

    showOverlayButton = function showOverlayButton() {
        $(sMediaOverlayButton).removeAttr('style');
    };

    isScene7Enabled = function isScene7Enabled() {
        var $detectScene7 = $('div.static-product-image').hasClass('scene7-enabled') ? true : false;
        return $detectScene7;
    };

    isImageViewerEnabled = function isImageViewerEnabled() {
        var detectImageViewer = pdpScene7.s7ImageSet !== undefined ? true : false;
        return detectImageViewer;
    };

    isSpinViewerEnabled = function isSpinViewerEnabled() {
        var detectSpinViewer = pdpScene7.s7SpinSet !== undefined ? true : false;
        return detectSpinViewer;
    };

    isVideoEnabled = function isVideoEnabled() {
        var detectVideo = pdpScene7.s7VideoSet.length ? true : false;
        return detectVideo;
    };

    scene7DomReadyCheckTimer = function scene7DomReadyCheckTimer() {
        pdpScene7.scene7DomReadyCheckInterval = setInterval(
            function () {
                scene7DomReadyCheck();
            },
            50
        );
    };

    scene7DomReadyCheck = function scene7DomReadyCheck() {
        var iDOMReadyImageSetCount = pdpScene7.s7ImageSet.split(',').length;

        if ($(sImageViewerThumbnailCarousel + ' ul.carousel-items-container li img').length === iDOMReadyImageSetCount) {
            clearInterval(pdpScene7.scene7DomReadyCheckInterval);
            breakpoint.mobileIn.push(pdpScene7.mobileIn);
            breakpoint.mobileOut.push(pdpScene7.mobileOut);
            if (ThumbCarousel) {
                ThumbCarousel.calculateVisibleItems();
            }
        }
    };

    initScene7Dependencies = function initScene7Dependencies() {
        var scene7LibSelector = pdpScene7.scene7ImageMode === 'zoomViewer' ? 'ZoomView' : 'FlyoutZoomView';

        s7sdk.Util.lib.include('s7sdk.common.Container');
        s7sdk.Util.lib.include('s7sdk.set.PageScrubber');
        s7sdk.Util.lib.include('s7sdk.set.MediaSet');
        s7sdk.Util.lib.include('s7sdk.set.SetIndicator');
        s7sdk.Util.lib.include('s7sdk.set.SpinView');
        s7sdk.Util.lib.include('s7sdk.image.' + scene7LibSelector);
        s7params = new s7sdk.ParameterManager(null, null);
        s7params.addEventListener(s7sdk.Event.SDK_READY, configureScene7Params, false);
        s7params.init();
        scene7DomReadyCheckTimer();
    };

    setScene7ImageMode = function setScene7ImageMode() {
        pdpScene7.scene7ImageMode = common.isTouch() || window.isKiosk() ? 'zoomViewer' : 'flyoutViewer';
    };

    fallbackToStaticImage = function fallbackToStaticImage() {
        if ($(sProductCarousel).length) {
            $(sProductCarousel).remove();
        }
        $('.static-product-image').removeClass('scene7-enabled');
    };

    common.init.push(pdpScene7.init);
    return pdpScene7;
});
/*jslint nomen: false*/
;
/*jslint plusplus: true*/
/*globals define,require,window,document */
define('modules/product-variants/ProductVariantController',['domlib',
        './ProductVariant',
        'modules/tesco.data',
        'modules/tesco.utils',
        'modules/page-title/common',
        'modules/expand-collapse/common',
        'modules/tesco.analytics',
        'modules/html-parser/HtmlParser',
        'modules/media-matrix/common',
        'modules/pdp-s7viewer/common',
        'modules/jargon-buster/common'], function ($, ProductVariant, DataHandler, utils, pageTitle, expandCollapse, analytics, HtmlParser, mediaMatrix, s7viewer, jargonBuster) {

    "use strict";
    var ProductVariantController = function ProductVariantController() {
        var bindEvents,
            initAjaxFramework,
            variantClickHandler,
            invokeCallToATG,
            selectVariantCompleteHandler,
            setHiddenDataValues,
            getVariantValue,
            setDocumentTitle,
            DataMethods,
            handleBazaarVoice,
            self = this,
            generateVariantURL,
            setURL,
            init,
            sVariantCompleteEventName = "PDPVariantSelectComplete",
            aProductVariants = [],
            oCurrentProductVariant,
            popStateHandler,
            oHistoryStateData = {},
            invokeCallToATGForHTML5History,
            bindVariantDropDown,
            toggleVariantDropDown,
            updateAllVariantDropDowns,
            updateDefaultTextInVariantDropDown,
            getDefaultFormAction,
            getVariantChoices,
            clearExistingVariantSelected,
            closeAllVariantDropDowns,
            setInitialHTML5HistoryData;

        bindEvents = function bindEvents() {
            $(window).on('popstate', popStateHandler.bind(self));
            $(document).on('click', '#variants', variantClickHandler.bind(self));
            bindVariantDropDown();
            $('body').on('click', closeAllVariantDropDowns);
        };

        closeAllVariantDropDowns = function closeAllVariantDropDowns() {
            var $elem = $('.vContainer');

            if ($elem.find(".filter-options").length) {
                $elem.find(".filter-options").removeClass("show-overlay");
                $elem.find('.open').removeClass("open");
            }
        };

        bindVariantDropDown = function bindVariantDropDown() {
            $(document).on('click', '.toggleVariantDropDown', toggleVariantDropDown);
        };

        toggleVariantDropDown = function toggleVariantDropDown(e) {
            var $elem = $(e.target);
            if ($elem.is('span')) {
                $elem = $elem.parent();
            }
            $elem.siblings(".filter-options").toggleClass("show-overlay");
            $elem.addClass("open");
            $elem.parent("article").siblings("article").find(".toggleVariantDropDown");
        };

        updateAllVariantDropDowns = function updateAllVariantDropDowns() {
            $(".variantDropDown").each(function () {
                updateDefaultTextInVariantDropDown($(this));
            });
        };

        updateDefaultTextInVariantDropDown = function updateDefaultTextInVariantDropDown($elem) {
            var sDropDownText = "";
            if ($elem.length) {
                sDropDownText = $elem.find('.selected > .variantDisplayName_title').text();
                if (sDropDownText !== "") {
                    $elem.siblings('.toggleVariantDropDown').find('.variantDropDownLabel').text(sDropDownText);
                }
            }
        };

        popStateHandler = function popStateHandler(e) {
            if (e.originalEvent.state !== undefined && e.originalEvent.state !== null) {
                if (e.originalEvent.state.sURL === "") {
                    e.originalEvent.state.sURL = getDefaultFormAction();
                }
                invokeCallToATGForHTML5History(e.originalEvent.state);
            }
        };

        initAjaxFramework = function initAjaxFramework() {
            var aInlineRequests = [],
                oRequests = {
                    'selectVariant': ['scene7', 'buyBoxes', 'specification', 'description', 'variants', 'title', 'miniDesc', 'priceCheck', 'priceWidget', 'collectionBlock', 'collectionLookBlock', 'linkSaveBlock', 'softBundleBlock', 'promoBlock']
                },
                oModules = {
                    'scene7': ['#product-carousel.product-carousel-s7', 'Update product image', true, true, true],
                    'buyBoxes': ['.buy-from', '', true, false, true, true],
                    'specification': ['#product-spec-section-content', 'Update product specification', true, true, true],
                    'description': ['#product-details-section-content', '', true, true, true],
                    'variants': ['#variants', '', true, true, true, true],
                    'title': ['.page-title', 'Updating product title', true, true, true],
                    'miniDesc': ['.features', 'Updating mini description', true, true, true],
                    'catno': ['.cat-no', 'Updating catalogue number', true, true, true],
                    'priceCheck': ['#price-check', 'Updating Price Check', true, true, true],
                    'priceWidget': ['#pc-container', 'Updating Price Check', true, true, true],
                    'collectionBlock': ['.collectionContainer.range', 'Updating collection block', true, true, true],
                    'collectionLookBlock': ['.collectionContainer.look', 'Updating look block', true, true, true],
                    'linkSaveBlock': ['.collectionContainer.linksave', 'Updating linksave block', true, true, true],
                    'softBundleBlock': ['.collectionContainer.bundle', 'Updating softbundle block', true, true, true],
                    'promoBlock': ['#special-offers-container', 'Updating promotion block', true, true, true]
                },
                oActions = {
                    'selectVariant': ['/stubs/select-variant.php']
                },
                oDefaultActions = {
                    'selectVariant': ['/stubs/select-variant.php']
                };

            DataHandler.Global.init({
                'inlineRequests': aInlineRequests,
                'requests': oRequests,
                'modules': oModules,
                'actions': oActions,
                'defaultActions': oDefaultActions
            });
        };

        /* Event Handlers */
        variantClickHandler = function variantClickHandler(e) {
            var $elem = $(e.target);
            e.preventDefault();
            if (($elem.is('li') || $elem.is('a') || $elem.is('img') || $elem.is('span')) && !$elem.parents('.selected').length && !$elem.hasClass('trigger') && !$elem.hasClass('icon') && !$elem.hasClass('selected') && !$elem.hasClass('variantDropDownLabel')) {
                invokeCallToATG($elem);
            }
        };

        selectVariantCompleteHandler = function selectVariantCompleteHandler() {
            var eVariantComplete = $.Event(sVariantCompleteEventName);

            eVariantComplete.currentProductVariant = oCurrentProductVariant;
            handleBazaarVoice(oCurrentProductVariant);

            require(['modules/buy-from/common', 'modules/product-description/common'], function (buyFrom, pdp) {
                buyFrom.init($(".buy-from"));
                pdp.initAddTheRangeBlock();
                pdp.initCompleteTheLookBlock();
                pdp.initLinkSaveBlock();
                try {
                    pdp.initBundleBlock();
                } catch (ignore) {}

                setDocumentTitle($('h1.page-title').text());
                pageTitle.Ellipsis.init();

                window.picturefill();

                expandCollapse.init();
                pdp.changeColumnLayout();
                pdp.truncateText();
                pdp.equalizeBundleHeights();
                mediaMatrix.init();
                if (!window.TescoData.pdp.bPersonalisedProduct) {
                    s7viewer.init();
                }
                try {
                    jargonBuster.reInit();
                } catch (ignore) {}

                pdp.reCalcShowMoreHeight();
                pdp.selectableCollectionItem.init();

                if (!window.isKiosk()) {
                    pdp.equaliseSpecialOfferHeights();
                }

                if (window.isKiosk()) {
                    buyFrom.initPromotionsManager(eVariantComplete.currentProductVariant.skuID);
                }

                $(window).trigger(eVariantComplete);
            });
        };

        generateVariantURL = function generateVariantURL(oProductVariant) {
            var sSKU = oProductVariant.skuID || oCurrentProductVariant.skuID,
                oQSParams = utils.getURLParams(),
                sURL = utils.getBaseURL() + "?",
                k,
                sQSValue;

            if (/skuid=/gi.test(window.location.href)) {
                for (k in oQSParams) {
                    if (oQSParams.hasOwnProperty(k)) {
                        sQSValue = k.toLowerCase() === "skuid" ? sSKU : oQSParams[k];
                        sURL = sURL + k + "=" + sQSValue + "&";
                    }
                }
                if (sURL.charAt(sURL.length - 1) === "&") {
                    sURL = sURL.substr(0, (sURL.length - 1));
                }
            } else {
                sQSValue = window.location.href.indexOf('?') > 0 ? "&" : "?";
                sURL = window.location.href + sQSValue + "skuId=" + sSKU;
            }
            return sURL;
        };

        /* Data Methods */
        invokeCallToATG = function invokeCallToATG($elem) {
            var sRequest = 'selectVariant',
                $form = utils.getFormByElement($elem),
                sURL = DataHandler.Utils.getAction(sRequest, $form),
                oDataLayer = new DataHandler.DataLayer(),
                sData;

            setHiddenDataValues($form, $elem);
            sData = $form.serialize();
            oHistoryStateData.sURL = sURL;
            oHistoryStateData.sFormData = sData;
            oDataLayer.get(sURL, sData, $elem, DataMethods, sRequest, null, null, selectVariantCompleteHandler);
            $(window).one(sVariantCompleteEventName, setURL);
        };

        invokeCallToATGForHTML5History = function invokeCallToATGForHTML5History(oStateData) {
            var sRequest = 'selectVariant',
                $elem = $(''),
                sURL = oStateData.sURL,
                sData = oStateData.sFormData,
                oDataLayer = new DataHandler.DataLayer();

            oHistoryStateData.sURL = sURL;
            oHistoryStateData.sFormData = sData;
            oDataLayer.get(sURL, sData, $elem, DataMethods, sRequest, null, null, selectVariantCompleteHandler);
        };

        handleBazaarVoice = function handleBazaarVoice(oProductVariant) {
            if (window.$BV) {
                setTimeout(function () {
                    window.$BV.configure('global', {
                        productId: oProductVariant.skuID
                    });
                    try {
                        window.$BV.ui("rr", "show_reviews");
                    } catch (ignore) {}
                }, 500);
            }

        };

        DataMethods = {
            handler: function (oJSON) {
                oCurrentProductVariant = new ProductVariant(oJSON);

                oCurrentProductVariant.skuID = oJSON.skuID;
                oCurrentProductVariant.productID = oJSON.productID;
                oCurrentProductVariant.variantValue = oJSON.productID;

                if (oJSON.serverTime) {
                    window.currentTimeAsync = oJSON.serverTime;
                    delete oJSON.serverTime;
                }

                delete oJSON.skuID;
                delete oJSON.productID;

                aProductVariants.push(oCurrentProductVariant);

                $.each(oJSON, function variantsResponseIterator(k, v) {
                    var oScene7PDPData = window.TescoData.pdp.scene7,
                        oWebAnalytics,
                        oReturnedScene7Data,
                        sMarkup,
                        sModuleSelector,
                        aModuleInfo;

                    if (k === 'analytics') {
                        if (analytics) {
                            oWebAnalytics = new analytics.WebMetrics();
                            oWebAnalytics.submit(v);
                        }
                        return;
                    }

                    if (k === 'catno') {
                        $('#BVReturnURL').remove();
                    }

                    if (k === 'scene7Data') {
                        oReturnedScene7Data = $.parseJSON(v);
                        if (window.TescoData === undefined) {
                            window.TescoData = {};
                        }
                        if (window.TescoData.pdp === undefined) {
                            window.TescoData.pdp = {};
                        }
                        if (window.TescoData.pdp.scene7 === undefined) {
                            window.TescoData.pdp.scene7 = {};
                        }
                        oScene7PDPData.s7ServerUrl = oReturnedScene7Data.s7ServerUrl;
                        oScene7PDPData.s7ImageSet = oReturnedScene7Data.s7ImageSet;
                        oScene7PDPData.s7SpinSet = oReturnedScene7Data.s7SpinSet;
                        /*jslint nomen: true*/
                        oScene7PDPData._s7VideoSet = oReturnedScene7Data.s7Video;
                        window._mediaCollectionUpdated = [];
                        /*jslint nomen: false*/
                        return;
                    }

                    aModuleInfo = DataHandler.Utils.getModuleInformation(k);
                    sModuleSelector = aModuleInfo[0];

                    if (k === 'scene7') {
                        sMarkup = v;
                        $('#prodZoomView .s7setindicator, #prodZoomView div canvas, #prodZoomView .btn-s7-step').remove();
                        $('#prodZoomView').find('div:first-child').remove();

                        if (window.TescoData.pdp.bPersonalisedProduct === true) {
                            sMarkup = $($.parseHTML(sMarkup));
                            $(sMarkup).eq(3).css({ "visibility": "hidden", "display": "none"});
                        } else {
                            $('.static-product-image.scene7-enabled').remove();
                        }
                    } else if (k === 'description') {
                        sMarkup = v === '' ? '' : HtmlParser.parseMarkupString(v);
                    } else {
                        sMarkup = DataHandler.Common.cleanMarkup(v);
                    }

                    try {
                        if (sMarkup !== '') {
                            if (aModuleInfo[4] === true) {
                                $(sModuleSelector).replaceWith(sMarkup);
                            } else {
                                $(sModuleSelector).get(0).innerHTML = sMarkup;
                            }
                        }
                    } catch (ignore) {}

                });

                updateAllVariantDropDowns();
            }
        };

        setHiddenDataValues = function setHiddenDataValues($form, $elem) {
            var sVariantValue,
                $elemVariantData,
                $variantChoices,
                $excludeLI;

            if ($elem.not('.variantDataElement')) {
                $elemVariantData = $elem.find('.variantDataElement');
                if (!$elemVariantData.length) {
                    $elem = $elem.parents('.variantDataElement').eq(0);
                } else {
                    $elem = $elemVariantData;
                }
            }

            sVariantValue = getVariantValue($elem);
            $variantChoices = getVariantChoices();

            if ($variantChoices.length > 1) {
                if ($elem.prop('name') === $variantChoices.eq(0).val()) {
                    clearExistingVariantSelected();
                } else {
                    $excludeLI = $elem.parent('li');
                    $form.find('li.selected').not($excludeLI).each(function () {
                        var $self = $(this).find('a'),
                            $excludeLnk = $excludeLI.find('a');
                        if ($self.attr('name') !== $excludeLnk.attr('name')) {
                            $('input[name="' + $self.attr('name') + '"]', $form).val(getVariantValue($self));
                        }
                    });
                }
            }

            $('input[name="' + $elem.prop('name') + '"]').val(sVariantValue);
            $('input[name="lastSelected"]').val($elem.prop('name'));

            // Hidden field not being serialised, making visible and modifiying property to type="hidden"
            $form.find('input[name="update"]').height(0).show();
            $form.find('input[name="update"]').prop('type', 'hidden');
        };

        clearExistingVariantSelected = function clearExistingVariantSelected() {
            var $variantChoices = getVariantChoices(),
                i = 0;

            for (i = 0; i < $variantChoices.length; i++) {
                $('input[name="' + $($variantChoices[i]).val() + '"]').val("");
            }
        };

        getVariantValue =  function getVariantValue($elem) {
            var oValue = "";
            if ($elem.is("select")) {
                oValue = $elem.val();
            } else {
                oValue = $elem.data('variant-value') || $elem.prop('name');
            }
            return oValue;
        };

        /* Helper Functions */

        setDocumentTitle = function setDocumentTitle(sVal) {
            document.title = sVal;
        };

        setURL = function setURL() {
            if (window.history) {
                window.history.pushState(oHistoryStateData, "", generateVariantURL(oCurrentProductVariant));
            }
        };

        getDefaultFormAction = function getDefaultFormAction() {
            return $('.buy form:eq(0)').prop('action');
        };

        getVariantChoices = function getVariantChoices() {
            return $('.variantChoices');
        };

        setInitialHTML5HistoryData = function setInitialHTML5HistoryData() {
            var oInitialHistoryStateData = {},
	        sCurrentURL = window.location.href;

            if ($('#variant-form').length) {
                oInitialHistoryStateData.sFormData = $('#variant-form').serialize();
                if (window.history) {
                    window.history.pushState(oInitialHistoryStateData, "", sCurrentURL);
                }
            }
        };

        init = function init() {
            initAjaxFramework();
            bindEvents();
            updateAllVariantDropDowns();
            setInitialHTML5HistoryData();
        };


        /* Rendering */

        init();

        return {
            DataMethods: DataMethods,
            selectVariantCompleteHandler: selectVariantCompleteHandler,
            setURL: setURL
        };

    };

    return ProductVariantController;

});

/* eslint-disable */

define('modules/product-description/common',[
        'domlib',
        'modules/common',
        'modules/breakpoint',
        'modules/tesco.data',
        'modules/tesco.utils',
        'modules/tesco.analytics',
        'modules/chip-and-pin/kmf-io',
        'modules/ajax/common',
        'modules/jargon-buster/common',
        'modules/toggle-expand-collapse/common',
        './wishlist',
        'modules/show-more/ShowMore',
        'modules/show-more/ShowMoreHandler',
        'modules/show-more/ShowMoreConfig',
        'modules/overlay/common',
        'modules/html-parser/HtmlParser',
        'modules/product-variants/ProductVariantController',
        'modules/mvc/fn'
    ],
    function (
        $,
        common,
        breakpoint,
        data,
        utils,
        analytics,
        kmfIO,
        ajax,
        jargonBuster,
        ToggleExpandCollapse,
        wishlist,
        ShowMore,
        ShowMoreHandler,
        ShowMoreConfig,
        overlay,
        HtmlParser,
        ProductVariantController,
        fn
    ) {

        var pdp = {
            clickEvent: 'click',
            tooltipMessages: {
                'unavailable': 'Not available',
                'not-in-stock': 'Not in stock'
            },
            swatchesAndSizesRules: {
                maximumAmount: 0,
                dropdownLimit: 13,
                placeholders: {
                    "select-colour": "Select a colour",
                    "select-size": "Select a size"
                }
            },
            analyticsFlag: true,
            getBasketTotalCount: function () {
                if (window.isKiosk()) {
                    var url = '/direct/?ssb_block=basket-itemcount';
                    if ($('#wrapper.spi').length) {
                        url = '/direct/my/kiosk-checkout.page?ssb_block=basket-itemcount';
                    }
                    if (window.external.navigationPanel) {
                        ajax.post({
                            'url': url,
                            'callbacks': {
                                'success': function (data) {
                                    var finalCount = JSON.parse(data);
                                    var getBasketQty = finalCount.basketCount;
                                    if (getBasketQty === '') {
                                        return false;
                                    } else if (getBasketQty > 0 && !$('#wrapper.spi.orderConfirmation').length) {
                                        window.external.navigationPanel.basketEnabled = true;
                                        if (window.external.navigationPanel.basketCountVisible !== undefined && window.external.navigationPanel.basketCount !== undefined) {
                                            window.external.navigationPanel.basketCountVisible = true;
                                            window.external.navigationPanel.basketCount = getBasketQty;
                                        }
                                    } else {
                                        window.external.navigationPanel.basketEnabled = false;
                                        if (window.external.navigationPanel.basketCountVisible !== undefined) {
                                            window.external.navigationPanel.basketCountVisible = false;
                                        }
                                    }
                                }
                            }
                        });
                    }
                }
            },
            changeColumnLayout: function () {
                if (common.isPage('PDP')) {
                    var module = $(".secondary-content"),
                        isDesktop = breakpoint.desktop || breakpoint.largeDesktop || breakpoint.vTablet || breakpoint.hTablet,
                        mainContent = $("#main-content"),
                        moduleHeight = parseInt(module.height(), 10);

                    mainContent.attr("style", "");

                    if (moduleHeight > mainContent.height() && isDesktop) {
                        //mainContent.css("min-height", moduleHeight+140);
                        mainContent.css("min-height", moduleHeight);
                    }
                }
            },

            isValidBreakpoint: function () {
                return breakpoint.desktop || breakpoint.largeDesktop || breakpoint.kiosk;
            },

            addAdditionalClass: function ($elementToCheck, $lengthToCheck, $elementToAddTo, className) {
                if ($elementToCheck.length > $lengthToCheck) {
                    $elementToAddTo.addClass(className);
                }
            },

            print: function (e) {
                e.preventDefault();
                window.print();
                return false;
            },

            // bug fix for http://jira.lbi.co.uk/browse/TDCO-1967
            // issue with trying to restore the table cells back to display: table-cell from being display: block
            // the fix only needs to be applied when in landscape mode - basically clone the existing table and
            // remove and replace on orientation change to force the correct table structure again
            priceCheckTableFix: function () {
                var $wrapper = $('#price-check');

                if (!$wrapper.length) {
                    return;
                }

                var $table = $wrapper.find('table').clone();

                $(window).on('orientationchange.priceCheck', function () {
                    if (window.screen.width > window.screen.height) {
                        $wrapper.find('table').remove();
                        $wrapper.append($table);
                    }
                });
            },

            // detect which version of bazaar voice is in use and serve the correct
            // code for that version :: [work completed for epic #2033]
            loadBazaarVoice: function () {
                if ($('#BVRRContainer').length > 0) {
                    if (breakpoint.kiosk) {
                        if (pdp.isTabViewEnabled()) {
                            pdp.checkCustomerReviewsStatus();
                        } else {
                            pdp.bazaarVoiceOverlay();
                        }
                    }
                }
            },
            equalizeBundleHeights: function (reset) {
                var bundleItems = $('.bundle .collectionItems > li').not('.collectionShelf'),
                    linksaveItems = $('.linksave .collectionItems > li').not('.collectionShelf');

                bundleItems.css('height', 'auto');
                linksaveItems.css('height', 'auto');

                bundleItems.height();
                linksaveItems.height();

                if (!reset) {
                    bundleItems.equaliseHeights();
                    linksaveItems.equaliseHeights();
                }
            },
            showView: function (obj) {
                var ulContainer = obj.find('.collectionItems');
                ulContainer.find('li:gt(4)').addClass('visually-hidden-select');
                if (ulContainer.find('li').length <= 5) {
                    obj.find('.collectionItemNext').hide();
                }
            },

            addTheRangeBlock: function () {
                var urlVal = $('.collectionContainer.range').data('url');
                if (urlVal != '') {
                    $.ajax({
                        url: urlVal,
                        complete: function (data) {
                            $('.collectionContainer.range').html(data.responseText);

                            if ($('input[name="_dynSessConf"]').length) {
                                var sUserSessionConfID = $('input[name="_dynSessConf"]').eq(0).val();
                                $('.collectionContainer.range').find('input[name="_dynSessConf"]').val(sUserSessionConfID);
                            }

                            if ($(".range ul.collectionItems li").length) {
                                $('.range, .addTheRangeButton').show();

                                /*
                                var _oWebAnalytics = new analytics.WebMetrics();
                                var v = [{
                                    'eVar17': 'Add the Range'
                                }];
                                _oWebAnalytics.submit(v);
                                */

                                var listLen = 0;
                                var origLength = $(".range ul.collectionItems li").length;
                                $(".range ul.collectionItems li").each(function (index) {
                                    if ($(this).find('div').length == 0) {
                                        listLen++;
                                        $(this).remove();
                                    }
                                    if (origLength == listLen) {
                                        $('.range, .addTheRangeButton').hide();
                                        if (window.isKiosk() && pdp.isTabViewEnabled()) {
                                            pdp.removeTabFromArray('#tab-shop-the-range');
                                        }
                                    }
                                });

                            } else {
                                $('.range, .addTheRangeButton').hide();
                                if (window.isKiosk() && pdp.isTabViewEnabled()) {
                                    pdp.removeTabFromArray('#tab-shop-the-range');
                                }
                            }

                            if (window.isKiosk() && pdp.isTabViewEnabled()) {
                                pdp.oTabViewData.iKioskAsyncTabs--;
                                pdp.updateTabViewDOMElements();
                            }
                            if (!window.isKiosk()) {
                                pdp.pdpBlock($('#range'));
                            }
                            pdp.showView($('.collectionContainer.range'));
                            pdp.showMoreItems('.collectionContainer.range');
                            picturefill();
                            pdp.truncateText();
                            pdp.handleLookAddEvent();

                           /* $('.collectionContainer.range').find('input.add-to-basket').each(function(){
                            	$(this).on(pdp.clickEvent, function(e){
    								e.preventDefault();
    								require(['modules/add-to-basket/common'], function (addRangeBasket) {
    									addRangeBasket.initAjaxFramework();
    								});
    							});
                            }); */

                            if (window.isKiosk()) {
                                pdp.addQuantityButtons();
                            }

                            var oShowMore = new ShowMore({
                                selector: '.add-the-range-block',
                                height: 600,
                                label: 'products'
                            });
                            oShowMore.fnInit();
                        }
                    });
                }
            },
            addLookBlock: function () {
                var urlVal = $('.collectionContainer.look').data('url');
                if (urlVal != '' && !window.isKiosk()) {
                    $.ajax({
                        url: urlVal,
                        complete: function (data) {
                            $('.collectionContainer.look').html(data.responseText);
                            if ($(".look ul.collectionItems li").length) {
                                $('.look, .getTheLookButton').show();
                                //Set omniture on Look block load
                                /*
                                var _oWebAnalytics = new analytics.WebMetrics();
                                var v = [{
                                    'eVar17': 'Get the look'
                                }];
                                _oWebAnalytics.submit(v);
                                */
                                var listLen = 0;
                                var origLength = $(".look ul.collectionItems li").length;
                                $(".look ul.collectionItems li").each(function (index) {
                                    if ($(this).find('div').length == 0) {
                                        listLen++;
                                        $(this).remove();
                                    }
                                    if (origLength == listLen) {
                                        $('.look, .getTheLookButton').hide();
                                    }
                                });
                            } else {
                                $('.look, .getTheLookButton').hide();
                            }

                            pdp.pdpBlock($('#look'));
                            pdp.showView($('.collectionContainer.look'));
                            pdp.showMoreItems('.collectionContainer.look');
                            picturefill();
                            pdp.truncateText();
                            pdp.handleLookAddEvent();
                        }
                    });
                }
            },
            linkSaveBlock: function () {
                var urlVal = $('.collectionContainer.linksave').data('url');
                if (urlVal != '') {
                    $.ajax({
                        url: urlVal,
                        beforeSend: function (jqXHR, settings) {
                          var _settings = settings;

                          _settings.url = urlVal;
                        },
                        complete: function (data) {

                            $('.collectionContainer.linksave').html(data.responseText);

                            var sResponseText = $.trim(data.responseText);

                            if (sResponseText !== '') {
                                if (window.isKiosk()) {
                                    var sCollectionSummary = '.linksave ul.collectionItems li.collectionSummary';
                                    if ($(sCollectionSummary).length) {
                                        $('#seeTermsTooltip').appendTo(sCollectionSummary);
                                        $('#seeTermsTooltipPopup').appendTo(sCollectionSummary);
                                    }
                                }

                                if ($(".linksave ul.collectionItems li, .linksave #linksave-container li").length) {
                                    $('.linksave, .linkSaveButton').show();
                                } else {
                                    $('.linksave, .linkSaveButton').hide();
                                }
                                if (common.isTouch()) {
                                    if (breakpoint.desktop) {
                                        pdp.equalizeBundleHeights();
                                    } else if (breakpoint.vTablet || breakpoint.hTablet) {

                                    } else {
                                        pdp.equalizeBundleHeights(true);
                                    }
                                } else {
                                    if (breakpoint.currentViewport === 'largedesktop' || breakpoint.currentViewport === 'desktop' || breakpoint.currentViewport === 'kiosk') {
                                        pdp.equalizeBundleHeights();
                                    }
                                }
                                common.richTexttooltipPopup.init();
                                if ($('#bundleTnC').val() != "") {
                                    var $p = $('#seeTermsTooltipPopup .content').find('p');
                                    $p.text($('#bundleTnC').val());
                                } else {
                                    $('#seeTermsTooltip').hide();
                                }
                                if (!window.isKiosk()) {
                                    pdp.pdpBlock($('#linksave'));
                                }
                                picturefill();
                                if (window.isKiosk() && pdp.isTabViewEnabled()) {
                                    pdp.oTabViewData.iKioskAsyncTabs--;
                                    pdp.updateTabViewDOMElements();
                                }
                            } else {
                                if (window.isKiosk() && pdp.isTabViewEnabled()) {
                                    pdp.oTabViewData.iKioskAsyncTabs--;
                                    pdp.removeTabFromArray('#tab-linksave');
                                    pdp.updateTabViewDOMElements();
                                }
                            }
                            if(!breakpoint.mobile){
                            	if($('#linksave-container li.bundleCount:first-child .bundle-header .bundle-title').hasClass('show-more-cheveron'))
                            		$('#linksave-container li.bundleCount:first-child .bundle-header .bundle-title').removeClass('show-more-cheveron').addClass('show-less-cheveron');
                            }
                        }
                    });
                }
            },
            bundleBlock: function () {
                var urlVal = $('.collectionContainer.bundle').data('url');
                if (urlVal !== '' && $('#bundleTnC').val() !== "") {
                    $.ajax({
                        url: urlVal,
                        complete: function (data) {
                            $('.collectionContainer.bundle').html(data.responseText);
                            if ($(".bundle ul.collectionItems li").length) {
                                $('.bundle, .bundleButton').show();
                            } else {
                                $('.bundle, .bundleButton').hide();
                            }
                            if (common.isTouch()) {
                                if (breakpoint.desktop) {
                                    pdp.equalizeBundleHeights();
                                } else if (breakpoint.vTablet || breakpoint.hTablet) {

                                } else {
                                    pdp.equalizeBundleHeights(true);
                                }
                            } else {
                                if (breakpoint.currentViewport === 'largedesktop' || breakpoint.currentViewport === 'desktop' || breakpoint.currentViewport === 'kiosk') {
                                    pdp.equalizeBundleHeights();
                                }
                            }

                            pdp.pdpBlock($('#bundle'));
                            picturefill();

                            pdp.selectableCollectionItem.init();
                        }
                    });
                }
            },
            scrollingTo: function (e) {
                var scrollToId = $(this).attr('href'),
                    $masthead = $('#masthead-wrapper'),
                    iMastheadHeight = $masthead.data('outerHeight'),
                    iTopValue = $(scrollToId).offset().top;
                if ($masthead.length) {
                    iTopValue = iTopValue - (iMastheadHeight * 2);
                }
                $('body, html').animate({
                    scrollTop: iTopValue
                }, 1000);

                e.preventDefault();
                e.stopPropagation();
                return false;
            },
            checkLinkSaveBlock: function(e) {
                var $wrapper = $('#linksave'),
                  domElementInScope = null,
                  elementsToActionInViewPort = [],
                  skuIds = $('#bundleOffer').length ? $('#bundleOffer').val().trim().substr(1) : '';

                elementsToActionInViewPort.push({ element: $wrapper });

                if (typeof window.inVisibleViewport === 'function') {
                  fn.loopArray(elementsToActionInViewPort, function(i) {
                    if (fn.isObject(elementsToActionInViewPort[i], { notEmpty: true })) {
                      domElementInScope = elementsToActionInViewPort[i].element.get(0);
                      if (domElementInScope) {
                        if (window.inVisibleViewport(domElementInScope)) {
                          if (pdp.analyticsFlag) {
                            pdp.analyticsFlag = false;
                            pdp.analyticsTracking(skuIds);
                          }
                        }
                      }
                    }
                  });
                }
            },
            linkSaveClickAnalytics: function(skuId) {
              var relationship = 'Link Save',
              _s = fn.copyObject(window.s);

              _s.linkTrackEvents = 'event32,event45';
              _s.linkTrackVars = 'prop19,eVar45,prop42,eVar59,events,products';
              _s.products = ';' + skuId + ';;';
              _s.prop19 = 'product click';
              _s.eVar45 = _s.prop19;
              _s.prop42 = 'pdp - ' + relationship + ' - product click';
              _s.eVar59 = _s.prop42;
              _s.events = 'event32,event45';
              _s.tl(true, 'o', relationship + ' - product click');
            },
            analyticsTracking: function (resData) {
              var relationship = 'Link Save',
                _s = fn.copyObject(window.s),
                analyticsText = resData.split(',').join(';;,;'),
                productId = '';

              _s.linkTrackEvents = 'event3,event32,event45';
              _s.linkTrackVars = 'prop19,eVar45,prop42,eVar59,events,products';
              _s.products = ';' + analyticsText + ';;';
              _s.prop19 = 'product impressions';
              _s.eVar45 = _s.prop19;
              _s.prop42 = 'pdp - ' + relationship + ' - product impressions';
              _s.eVar59 = _s.prop42;
              _s.events = 'event3,event32,event45';
              _s.tl(true, 'o', relationship + ' - product impressions');
            },
            linkSaveToggle: function () {
              var element = $('.bundle-title'),
                linksaveList = element.parent().next();

              $(linksaveList).slideToggle(function () {
                if (element.next().is(':visible')) {
                  element.next().removeAttr('style').css('display', 'none');
                  element.removeClass('show-less-cheveron').addClass('show-more-cheveron');
                  element.removeAttr('style').css('padding-bottom', '20px');
                } else {
                  element.next().removeAttr('style').css('display', 'block');
                  pdp.truncateText();
                  element.removeClass('show-more-cheveron').addClass('show-less-cheveron');
                  element.removeAttr('style').css('padding-bottom', '0px');
                }
              });
            },
            linkSaveBindEvents: function () {
              $(document).on('scroll', function () {
                pdp.checkLinkSaveBlock();
              });
              $(document).on('click', '.collectionItemImage, .collectionItemDescription', function () {
                var skuId = $(this).closest('div[data-sku]').data('sku');

                pdp.linkSaveClickAnalytics(skuId);
              });
              $(document).on('tap click', '.bundle-title', function () {
                pdp.linkSaveToggle();
              });
            },
            pdpBlock: function (blockId) {
                if ($('.collapseByDefault')) {
                    $elemContainer = $('.collapseByDefault').children().find(blockId);
                    $elemContainer.find('.toggleDetailWrapper').toggleClass('PDPchangeIcon');
                    $elemContainer.find('.detailWrapper').hide();
                }
            },
            selectableCollectionItem: {
                loading: false,
                init: function () {
                    $('.checkboxContainer .checkbox').on(pdp.clickEvent, pdp.selectableCollectionItem.toggleCollectionItem);
                },
                toggleCollectionItem: function (e) {
                    if (pdp.selectableCollectionItem.loading == false) {
                        e.preventDefault();
                        pdp.selectableCollectionItem.loading = true;
                        $(this).parent().toggleClass('selected');
                        $(this).parent().siblings('.collectionItemImageContainer').toggleClass('disabled');
                        $(this).parent().siblings('.collectionItemDetail').toggleClass('disabled');
                        $(this).closest('li').children('.collectionItemChange').toggleClass('disabled');

                        var softItemPrice = $(this).parent().siblings('.collectionItemDetail').find('.softItemPrice').val();
                        var softBundlePrice = $('#bundle').find('.currentPrice .softBundlePrice').text();
                        var softItemPriceVal = parseFloat(softItemPrice);
                        var softBundlePriceVal = parseFloat(softBundlePrice);
                        var firstItemCheckBox = $(this).parent().closest('.collectionItemContainer ').siblings('#checkBox1');
                        var secItemCheckBox = $(this).parent().closest('.collectionItemContainer ').siblings('#checkBox2');

                        if ($(this).parent().hasClass('selected')) {
                            $(this).closest('li').removeAttr('disabled');
                            var totValue = softBundlePriceVal + softItemPriceVal;
                            var finalValue = totValue.toFixed(2);

                            $('#bundle').find('.currentPrice .softBundlePrice').text(finalValue);
                            if ((firstItemCheckBox.length) && !(secItemCheckBox.length)) {
                                firstItemCheckBox.val('true');
                            } else {
                                secItemCheckBox.val('true');
                            }

                        } else {
                            $(this).closest('li').prop('disabled', true);
                            var totValue = softBundlePriceVal - softItemPriceVal;
                            var finalValue = totValue.toFixed(2);
                            $('#bundle').find('.currentPrice .softBundlePrice').text(finalValue);
                            if ((firstItemCheckBox.length) && !(secItemCheckBox.length)) {
                                firstItemCheckBox.val('false');
                            } else {
                                secItemCheckBox.val('false');
                            }
                        }

                        // pdp.getCollectionSummaryTotal($(this).closest('form')); after this method make equal height and loading false
                        pdp.selectableCollectionItem.loading = false;

                    } else {
                        return false;
                    };
                }
            },
            trackRichRelevanceProducts: function trackRichRelevanceProducts(e) {
                $('#wrapper.product').on('click', '.feature-products .rr-product a', function () {
                    var pageType,
                        productId,
                        s_eVar2 = 'Recommender_',
                        oWebAnalytics;

                    if (s && s.prop4 !== undefined) {
                        pageType = s.prop4;
                        s_eVar2 += pageType + '_';
                    }

                    productId = $(this).closest('.product').find('a.thumbnail').data('productid');
                    if (productId !== '') {
                        s_eVar2 += productId;
                    }

                    oWebAnalytics = new analytics.WebMetrics();
                    oWebAnalytics.submit([{
                        'eVar2': s_eVar2
                    }]);

                });
            },
            sSpecialOffersContainer: '#special-offers-container',
            equaliseSpecialOfferHeights: function equaliseSpecialOfferHeights() {
                var sSpecialOffersElements = '#special-offers-container div.special-offer-container-top';
                if ($(pdp.sSpecialOffersContainer).length) {
                    $(sSpecialOffersElements).removeAttr('style').equaliseHeights();
                }
            },
            initInlineSpecialOffers: function () {
                var initToggleExpandCollapse,
                    sSpecialOffersParentContainer = $('.product-description').length ? '.product-description' : '.special-offers-block';

                if (!$('body').hasClass('PDP-Version2') && $(pdp.sSpecialOffersContainer).length) {
                    $(window).on('breakpointChange', pdp.equaliseSpecialOfferHeights);
                    pdp.equaliseSpecialOfferHeights();
                    initToggleExpandCollapse = new ToggleExpandCollapse({
                        sToggleContainer: sSpecialOffersParentContainer,
                        sToggleElementParent: '.fnToggleDescription',
                        sToggleTriggerElement: 'div.special-offer-container-top',
                        bAccordionEnabled: true
                    });
                    initToggleExpandCollapse.init();
                }
            },

            initShowMore: function () {
                if (!window.isKiosk()) {
                    var oShowMoreHandler = new ShowMoreHandler(ShowMoreConfig);
                    oShowMoreHandler.init();
                }
            },

            reCalcShowMoreHeight: function () {
                var oShowMore;
                if (!window.isKiosk()) {
                    $('.section-container').each(function () {
                        if ($(this).data('ShowMore') && typeof ($(this).data('ShowMore')) === 'object') {
                            oShowMore = $(this).data('ShowMore');
                            if (oShowMore.$showMoreWrapper !== null) {
                                oShowMore.fnCalcSelectorHeight();
                                if (oShowMore.bShowMore) {
                                    oShowMore.fnSetWrapperHeight(oShowMore.iSelectorHeight);
                                }
                            }
                        }
                    });
                }
            },

            init: function () {
                if (!common.isPage('PDP')) {
                    return;
                }

                jargonBuster.init();
                pdp.initShowMore();

                if (kmfIO.checkKMFExists()) {
                    setTimeout(function () {
                        pdp.getBasketTotalCount();
                    }, 700);
                }

                pdp.initLinkSaveBlock();
                pdp.scrollToPromotions();
            },

            initPersonaliseHandler: function initPersonaliseHandler() {
                var personaliseHandler,
                    $skuIdVal = $('#skuIdVal'),
                    sSkuIdValue,
                    sPDPSelector = $('.product-description').length ? '.product-description' : 'body.PDP-Version2';
                if ($skuIdVal.length > 0) {
                    sSkuIdValue = $skuIdVal.val();
                    require(['modules/personalise-product/common'], function (PersonaliseProduct) {
                        personaliseHandler = new PersonaliseProduct({
                            sPDPSelector: sPDPSelector,
                            sPersonaliseSelector: '#personalise-button',
                            sAddToBasketSelector: '.addPersonalisedToBasketForm',
                            sPersonaliseErrorSelector: '.personalise-error',
                            sProductName: sSkuIdValue //'276-2966'
                        });
                        personaliseHandler.clearEmaginationCookies();
                        if (window.AsyncBlockController.isCachedPage() && !window.AsyncBlockController.hasCompleted()) {
                             $(window).on('AsyncBlockControllerComplete', function () {
                        personaliseHandler.init();
                             });
                        } else {
                             personaliseHandler.init();
                        }
                    });
                }
            },
            thumbnailSetup: function () {
                var $thumbnails = $('.main-details .product-carousel .thumbnails'),
                    height = 'auto';
                if ($thumbnails.is(':visible')) {
                    $('.main-details .product-carousel').removeClass('more-thumbnails');
                    var thumbnailNum = $thumbnails.find('li').length;
                    var moreLength = 8; //initially set as 8 for legacy reasons.
                    switch (breakpoint.currentViewport) {
                    case 'largedesktop':
                        if (thumbnailNum > 6) {
                            height = ($thumbnails.find('li').outerHeight(true) * 5) - 15 + 'px';
                            moreLength = 6;
                        }
                        break;
                    case 'desktop':
                        if (thumbnailNum > 4) {
                            height = ($thumbnails.find('li').outerHeight(true) * 3) - 8 + 'px';
                            moreLength = 4;
                        }
                        break;
                    }
                    pdp.addAdditionalClass($thumbnails.find('li'), moreLength, $('.main-details .product-carousel'), 'more-thumbnails');
                    $thumbnails.height(height);
                }
            },

            bindVirtualPages: function (e) {
                //$(".product-description .product-specifications-link").on("click", function(e){
                if (breakpoint.mobile || breakpoint.vTablet || breakpoint.hTablet) {
                    var backLink = "<a href='#' class='back'><span class='icon' data-icon='g' aria-hidden='true'></span> Back to Product Overview</a>",
                        content = "<h1 class='page-title'>" + $(".page-title").clone().html() + "</h1><div class='product-description'><section class='product-specifications'>" + backLink + $(".product-specifications").html() + backLink + "</section></div>";
                    var opts = {
                        content: content,
                        closeSelector: '.back'
                    };
                    common.virtualPage.show(opts);
                    e.preventDefault();
                }
                if (window.isKiosk()) {
                    pdp.showVirtualPage(e);
                }

                //});
            },
            truncateText: function () {
                var truncationText = [$(".feature-products .product h3"), $(".collectionItems .collectionItemDescription"), $(".mainCollectionItem .collectionItemDescription"), $('.services .tableCellTextWrapper')];
                for (var i = 0; i < truncationText.length; i++) {
                    if (truncationText[i].length > 0) {
                        this.Ellipsis.init(truncationText[i]);
                    }
                }
            },
            Ellipsis: {
                init: function (element) {
                    element.dotdotdot({
                        ellipsis: '\u2026',
                        wrap: 'word',
                        tolerance: 0
                    });
                }
            },
            swatchesAndSizes: {
                bindTooltipEvents: function () {
                    var listItems = $("li.unavailable, li.not-in-stock");
                    this.bindHoverEvents(listItems);
                },
                showTooltip: function (trigger) {
                    var className = trigger.parent("li").attr("class");
                    var finalClass;
                    if (className.indexOf('unavailable') != -1) {
                        finalClass = 'unavailable';
                    }
                    if (className.indexOf('not-in-stock') != -1) {
                        finalClass = 'not-in-stock';
                    }
                    var html = "<p>" + pdp.tooltipMessages[finalClass] + "</p>";
                    var settings = {
                        trigger: trigger,
                        html: html,
                        isHover: true,
                        isInline: true,
                        fixedSize: false,
                        positionAboveTrigger: true
                    };
                    common.tooltip.show(settings);
                },
                bindHoverEvents: function (listItems) {
                    listItems.bind("mouseenter", function (e) {
                        if (listItems.parents().find('.dropdown-enabled').length <= 0) {
                            pdp.swatchesAndSizes.showTooltip($(this).find("a"));
                        }
                    });
                    listItems.bind("mouseleave", function (e) {
                        common.tooltip.hide();
                    });
                    listItems.find("a").bind("focus", function () {
                        if (listItems.parents().find('.dropdown-enabled').length <= 0)
                            pdp.swatchesAndSizes.showTooltip($(this));
                    });
                    listItems.find("a").bind("blur", function (e) {
                        if (pdp.isValidBreakpoint()) {
                            common.tooltip.hide();
                        }
                    });
                },
                isOverMaxiumAmount: function (module) {
                    var maximumAmountExceeded = false;
                    var list = $(module);
                    var liLength = list.find("li").length;
                    var sizeTextLen = 0;

                    if (liLength > pdp.swatchesAndSizesRules.maximumAmount) {
                        maximumAmountExceeded = true;
                        var lengthToCols = Math.ceil(liLength / pdp.swatchesAndSizesRules.dropdownLimit);
                        list.parent('div').addClass("cols-" + lengthToCols);
                    }

                    /* if text length of sizes module is >=4, change it to dropdown */
                    if (list.hasClass('sizes')) {
                        sizeTextLen = list.find('li:eq(0) > a').attr('value');
                        list.find('li > a').each(function () {
                            sizeTextLen = $(this).attr('value');
                            if (sizeTextLen.length >= 4) {
                                maximumAmountExceeded = true;
                            }
                        });
                    } else if (list.hasClass('swatch')) { /* if amy swatch does not have image, change it to dropdown */
                        if (list.find("li a img[src='']").length) {
                            maximumAmountExceeded = true;
                        }
                    }

                    return maximumAmountExceeded;
                },
                dropdown: {
                    init: function (module) {
                        var listContainer = $(module).parent("article");
                        pdp.swatchesAndSizes.dropdown.setup(module);
                        pdp.swatchesAndSizes.dropdown.bindEvents(listContainer);

                    },
                    isSelectedItem: function (list) {
                        return list.find("li.selected").length > 0;
                    },
                    getInitialValue: function (module) {
                        var isSelectedItem = pdp.swatchesAndSizes.dropdown.isSelectedItem(module),
                            className = module.parent("article").attr("class"),
                            dropdownValue = pdp.swatchesAndSizesRules.placeholders[className],
                            selectedItem = module.find("li.selected"),
                            selectedItemValue = (className === "select-colour") ? selectedItem.find(".variantDisplayName_title").text() : selectedItem.find('a > span').text();
                        if (isSelectedItem) {
                            dropdownValue = selectedItemValue;
                        }
                        module.parent("article").addClass("dropdown-enabled");

                        return dropdownValue;
                    },
                    insertTrigger: function (module) {
                        var initialDropDownValue = pdp.swatchesAndSizes.dropdown.getInitialValue(module);
                        module.parent("article").prepend("<a href='#' class='trigger'>" + initialDropDownValue + "<span class='icon'></span></a>");
                    },
                    insertCheckbox: function (module) {
                        var checkboxHtml = "<div class='checkbox'></div>";
                        module.find("li a").append(checkboxHtml);
                    },
                    insertText: function (module) {
                        module.find("li").each(function () {
                            try {
                                var className = $(this).attr("class");
                                var finalClass;
                                if (className.indexOf('unavailable') != -1) {
                                    finalClass = 'unavailable';
                                }
                                if (className.indexOf('not-in-stock') != -1) {
                                    finalClass = 'not-in-stock';
                                }
                                if (className.val == "") {
                                    finalClass = "";
                                }
                                var availabilityText = pdp.tooltipMessages[finalClass];
                                var imgTag = $(this).find("img");
                                if (imgTag.length > 0) {
                                    var textValue = $(imgTag).attr('alt');

                                    if (availabilityText) {
                                        textValue = textValue + ' - ' + availabilityText;
                                    }

                                    $(imgTag).after("<span>" + textValue + "</span>");
                                } else {
                                    if (availabilityText) {
                                        $(this).find("span").append(" - " + availabilityText);
                                    }
                                }
                                if (availabilityText == "Not in stock") {
                                    $(this).closest("li").removeClass("not-in-stock");
                                }

                            } catch (e) {}

                        });
                    },
                    addBodyOverlay: function (trigger) {
                        common.tooltip.insertOverlay();
                        $('body').on(pdp.clickEvent, function () {
                            $(".filter-options").removeClass("show-overlay");
                            $(trigger).removeClass("open");
                            $(trigger).parent("article").siblings("article").find(".trigger").removeClass("closed");

                        });
                    },
                    addColumns: function (list) {

                        var liLength = list.find("li").length;
                        if (liLength > pdp.swatchesAndSizesRules.maximumAmount) {
                            var lengthToCols = Math.ceil(liLength / pdp.swatchesAndSizesRules.dropdownLimit);
                            list.addClass("cols-" + lengthToCols);
                            var listEl = list.find("li");
                            listEl.each(function (i, val) {
                                if (i % pdp.swatchesAndSizesRules.dropdownLimit === 0 && i !== 0) {
                                    var toInsert = $(this);
                                    $('<ul>').insertAfter(toInsert.parent()).append(toInsert.nextAll().andSelf());
                                }
                            });
                        }

                    },
                    checkSizeDropdown: function (dropdown) {
                        var sizeDropDown = $(dropdown).hasClass("select-size");

                        if (sizeDropDown) {
                            if (!$(dropdown).siblings("article").hasClass("dropdown-enabled")) {
                                $(dropdown).addClass("lone-dropdown");
                            }
                        }
                    },
                    bindEvents: function (module) {
                        $(module).find(".trigger").bind("click", function (e) {
                            e.preventDefault();
                            $(this).siblings(".filter-options").toggleClass("show-overlay");
                            $(this).addClass("open");
                            $(this).parent("article").siblings("article").find(".trigger").addClass("closed");
                            pdp.swatchesAndSizes.dropdown.addBodyOverlay(this);
                        });

                    },
                    setup: function (list) {
                        var articleWrapper = list.parent("article");
                        articleWrapper.wrapInner("<div class='filter-options'/>");
                        pdp.swatchesAndSizes.dropdown.insertCheckbox(list.parent(".filter-options"));
                        pdp.swatchesAndSizes.dropdown.insertTrigger(list.parent(".filter-options"));
                        pdp.swatchesAndSizes.dropdown.insertText(list.parent(".filter-options"));
                        pdp.swatchesAndSizes.dropdown.checkSizeDropdown(articleWrapper);
                        if (window.isKiosk()) {
                            pdp.swatchesAndSizes.dropdown.addColumns(list.parent(".filter-options"));
                        }
                    }
                },

                convertListToSelect: {
                    init: function () {


                        $(".availability").each(function () {
                            pdp.swatchesAndSizes.convertListToSelect.buildSelect(this);
                        });
                    },
                    buildSelect: function (list) {

                        var selectedListVal = pdp.swatchesAndSizes.convertListToSelect.getInitialSelectedVal(list),
                            selectName = pdp.swatchesAndSizes.convertListToSelect.getVariantName(list),
                            $article = $(list).parent('article'),
                            parentClass = $article.attr('class'),
                            dropdownValue = pdp.swatchesAndSizesRules.placeholders[parentClass],
                            selectContainer = $("<select><select>").attr('name', selectName);

                        selectedListVal = (selectedListVal === "") ? dropdownValue : selectedListVal;
                        $(selectContainer).append("<option value='-1'>" + dropdownValue + "</option>");
                        $article.find('p').css('display', 'none');

                        var selectButton = $("<a class='select-trigger'>" + selectedListVal + "<span class='icon'></span></a>");

                        $(list).find('li').each(function () {
                            try {
                                var imgTag = $(this).find("img"),
                                    className = $(this).attr("class"),
                                    finalClass = "",
                                    disabled = "",
                                    selected = "",
                                    availabilityText = "",
                                    textValue = "";

                                if (className.indexOf('unavailable') != -1) {
                                    finalClass = 'unavailable';
                                    disabled = 'disabled';
                                }
                                if (className.indexOf('not-in-stock') != -1) {
                                    finalClass = 'not-in-stock';
                                    //disabled = 'disabled';
                                }
                                if (className.indexOf('selected') != -1) {
                                    selected = 'selected';
                                }

                                availabilityText = pdp.tooltipMessages[finalClass];

                                if (imgTag.length > 0) {
                                    value = $(imgTag).attr('alt');
                                } else {
                                    value = $(this).find('a span')[0].innerHTML;
                                }
                                text = value;
                                if (availabilityText) {
                                    text = value + ' - ' + availabilityText;
                                }
                                $(selectContainer).append("<option " + disabled + " " + selected + " value='" + value + "'>" + text + "</option>");
                            } catch (e) {}

                        });

                        $(list).before(selectButton).before(selectContainer).remove();
                        pdp.swatchesAndSizes.convertListToSelect.bindOnSelectEvent(selectContainer, selectButton);

                    },
                    bindOnSelectEvent: function (selectList, button) {

                        $(selectList).on("change", function () {
                            var selectedVal = $(selectList).find("option:selected").text();
                            $(selectList).siblings(".select-trigger").html(selectedVal + "<span class='icon'></span>");
                        });
                    },
                    getInitialSelectedVal: function (list) {
                        if ($(list).find("li.selected").length === 0) {
                            return "";
                        }
                        var selectedListItem = $(list).find("li.selected");
                        var hasImg = $(selectedListItem).find("img");
                        if (hasImg.length > 0) {
                            return hasImg[0].alt;
                        } else {
                            return $(selectedListItem).find("a > span").text();
                        }

                    },
                    getVariantName: function (list) {
                        return $(list).find("li:eq(0) a").attr('name');
                    }
                },

                init: function init() {

                    var isTouchDevice = common.isTouch();
                    if (isTouchDevice && !window.isKiosk()) {
                        //pdp.swatchesAndSizes.convertListToSelect.init();
                    } else {

                        $(".product-description").each(function () {

                            /*
                            $(this).find(".availability").each(function () {
                                var isOverMaxiumAmount = pdp.swatchesAndSizes.isOverMaxiumAmount($(this));
                                if (isOverMaxiumAmount || breakpoint.mobile || breakpoint.vTablet) {
                                    pdp.swatchesAndSizes.dropdown.init($(this));
                                } else {
                                    pdp.swatchesAndSizes.bindTooltipEvents();
                                }
                            });
                            */

                        });

                        $('.pre-order-price-promise').on(pdp.clickEvent, pdp.preOrderPriceOverlay);
                        $(document).on(pdp.clickEvent, '.customer-review-link,.BVRRRatingSummaryLinkRead a', function () {
                            if (!$(this).closest('ul.products').hasClass('compare')) {
                                pdp.customerReviewOverlay();
                            }
                        });

                        $('.blinkbox-banner').on(pdp.clickEvent, pdp.blinkboxOverlay);
                    }

                    wishlist.init();
                }
            },
            formatCustomisedBlocks: function () {

                var $elemContainer;

                $('.collapseByDefault').each(function (i, e) {
                    var $elem = $(this);

                    if ($elem.find('#PDP-inline-content').length) {
                        var $elemContainer = $elem.next('section');
                        $elemContainer.find('.toggleDetailWrapperIC').toggleClass('PDPchangeIcon');
                        $('#inline-content').hide();
                    } else {
                        // Product spec
                        if ($elem.children().eq(0).is('div')) {
                            if ($elem.children().eq(0).is('.openByDefault') || $elem.children().eq(0).is('.collapseByDefault')) {
                                return; // we have duplicate here, let's do in next loop.
                            }
                            if ($elem.children().eq(0).find('.product-promotions')) {
                                $elemContainer = $elem.children().eq(0).find('.product-promotions');
                            } else {
                                $elemContainer = $elem.children().eq(0).find('.product-specifications');
                            }
                        } else {
                            $elemContainer = $elem.children().eq(0);
                        }
                        $elemContainer.find('.toggleDetailWrapper').toggleClass('PDPchangeIcon');
                        $elemContainer.find('.detailWrapper').hide();
                    }
                });
            },

            formatCustomisedBV: function () {
                // Wrap link around BV heading to allow expand/collapse
                var $elemContainer = $('#BVRRContainer');
                var $moduleHeader = $elemContainer.find('.bv-action-bar-header');
                $moduleHeader.wrap('<a href="#" class="toggleDetailWrapperBV"></a>');

                if ($elemContainer.parent().parent('.collapseByDefault').length) {
                    $elemContainer.addClass('hideBVReviews');
                    $moduleHeader = $elemContainer.find('.bv-action-bar-header').parent().toggleClass('PDPchangeIcon');
                }
            },
            showMoreItems: function (objBut) {
                // Show more products when link is clicked
                var noPerBlock = 5;

                $('#main-content, .tab-content-body').on(pdp.clickEvent, '.collectionItemNext a', function (e) {
                    e.preventDefault();
                    var allItems = $(this).parents(objBut).find('.collectionItems li'),
                        $parent = $(this).closest('.collectionContainer'),
                        visibleItems = allItems.filter(':visible'),
                        currentPage = ($(this).data('currentPage') ? $(this).data('currentPage') : 1);
                    if (window.isKiosk() && $parent.hasClass('range')) {

                        /*
                         * show all 'add the range' elements
                         * as we use kiosk scrollbar instead
                         * of pagination
                         */
                        allItems.removeClass('visually-hidden-select');
                        picturefill();
                        $parent.find('.collectionItemNext').hide();
                    } else {
                        if ((currentPage * noPerBlock) < allItems.length) {
                            currentPage++;
                            $(this).data('currentPage', currentPage);
                            visibleItems.nextAll(':lt(' + ((currentPage * noPerBlock) - 1) + ')').removeClass('visually-hidden-select');
                            if (currentPage >= allItems.length / noPerBlock) {
                                $(objBut).find('.collectionItemNext').hide();
                            }
                        }
                    }
                });
            },
            handleRangeAddEvent: function (e) {
            	 $('.collectionContainer.range').off(pdp.clickEvent, 'input.addCollectionItem');
                 $('.collectionContainer.range').on(pdp.clickEvent, 'input.addCollectionItem', function (e) {
                     var $addToBasketBtn = $(this),
                         $form = utils.getFormByElement($addToBasketBtn),
                         $quantityBox = $form.find('.quantity-display'),
                         $inputVal = $quantityBox.val();

                     e.preventDefault();

                     if (!(/^\d{1,2}$/.test($inputVal))) {

                         var html = "<span class='error'><span class='icon' data-icon='8' aria-hidden='true'></span>" + $quantityBox.data("error-text") + "</span>";
                         require(['modules/buy-from/common'], function (buyFrom) {
                             buyFrom.errorTooltip($quantityBox, html);
                         });
                         $quantityBox.val(1);
                         return false;
                     } else {
                     	/* require(['modules/add-to-basket/common'], function (addToBasket) {
                     		 addToBasket.initAjaxFramework();
                     		 addToBasket.bindEvents(events);
                          });*/
                     }

                 });

             },
             handleLookAddEvent: function (e) {
                 $('.collectionContainer.look, .collectionContainer.range').off(pdp.clickEvent, 'input.addCollectionItem');
                 $('.collectionContainer.look, .collectionContainer.range').on(pdp.clickEvent, 'input.addCollectionItem', function (e) {
                     var $addToBasketBtn = $(this),
                         $form = utils.getFormByElement($addToBasketBtn),
                         $quantityBox = $form.find('.quantity-display'),
                         $inputVal = $quantityBox.val();

                     e.preventDefault();

                     if (!(/^\d{1,2}$/.test($inputVal))) {

                         var html = "<span class='error'><span class='icon' data-icon='8' aria-hidden='true'></span>" + $quantityBox.data("error-text") + "</span>";
                         require(['modules/buy-from/common'], function (buyFrom) {
                             buyFrom.errorTooltip($quantityBox, html);
                         });
                         $quantityBox.val(1);
                         return false;
                     } else {
                         pdp.rangeAddtoBasket($addToBasketBtn, $form, $quantityBox);
                     }

                 });

             },
            rangeAjaxResponseHandler: function (result, $addToBasketBtn) {

                var responseText = '',
                    currentMsg = $addToBasketBtn.closest('.collectionActions').find('.collectionResponse');

                if (result.hasOwnProperty('basketRangeAddSuccess') && result.basketRangeAddSuccess != '') {
                    responseText = result.basketRangeAddSuccess;

                    if (currentMsg.length) {
                        currentMsg.replaceWith(responseText);
                    } else {
                        $addToBasketBtn.after(responseText);
                    }

                } else if (result.hasOwnProperty('basketRangeAddFailure') && result.basketRangeAddFailure != '') {
                    responseText = result.basketRangeAddFailure;

                    var html = "<span class='error'><span class='icon' data-icon='8' aria-hidden='true'></span>" + responseText + "</span>";

                    require(['modules/buy-from/common'], function (buyFrom) {
                        buyFrom.errorTooltip($addToBasketBtn, html);
                    });
                }

            },
            rangeAddBtnStatus: function ($addToBasketBtn, inProgress) {

                var originalText = $addToBasketBtn.val();

                if (inProgress) {
                    $addToBasketBtn.prop('disabled', true).addClass('inProgress').val('Adding to basket');
                } else {
                    $addToBasketBtn.prop('disabled', false).removeClass('inProgress').val($addToBasketBtn.data('success-text'));
                }

                $addToBasketBtn.data('success-text', originalText);

            },

            rangeAddtoBasket: function ($addToBasketBtn, $form, $quantityBox) {

                var DL = new data.DataLayer(),
                    productData = $form.serialize(),
                    request = 'addTheRange',
                    _url = utils.getFormAction($form);
                params = {
                    'inlineRequests': [],
                    'requests': {
                        'addTheRange': ['basketContainer', 'basketRangeAddSuccess', 'basketRangeAddFailure']
                    },
                    'modules': {
                        'basketContainer': ['#masthead .basket-items', '', true, true],
                        'basketRangeAddSuccess': ['.collectionContainer .collectionItems .result', '', false],
                        'basketRangeAddFailure': ['.collectionContainer .collectionItems .collectionQuantity div', '', false]
                    }
                };

                data.Global.init(params);
                pdp.rangeAddBtnStatus($addToBasketBtn, true);

                DL.get(null, productData, $addToBasketBtn, null, request, function (result) {
                    pdp.rangeAjaxResponseHandler(result, $addToBasketBtn);
                    pdp.rangeAddBtnStatus($addToBasketBtn, false);
                    $quantityBox.val(1);
                    if($('#masthead #basket-link .basket-items').length > 0){
                        $('#masthead #basket-link .basket-items').html(result.basketContainer);
	                 } else{
	                        $('#masthead #basket-link').append($('<span class="badge"><span class="basket-items">' + result.basketContainer + '</span></span>'));
	                 }
                    if (window.isKiosk() && kmfIO.checkKMFExists()) {
                        setTimeout(function () {
                            kmfIO.enableBasketButton();
                        }, 2000);
		            }
                });
            },
            setSellerUrl: function () {
                var fileLocation = "/directuiassets/SiteAssets/NonSeasonal/en_GB/sellers/seller popup/",
                    sellerLogo = "#product-promotions a.sellerImageContainer",
                    target = ".content a";

                var sellerId = $(sellerLogo).attr('data-sellerid');

                if (sellerId === undefined) return;

                if (sellerId !== "1000001") {

                    var sellerFile = fileLocation + sellerId + ".html";

                    $.get(sellerFile, function (data) {
                        var link = $(data.trim()).find(target).attr('href');
                        if (link.length) {
                            $(sellerLogo).attr('href', link);
                        } else {
                            pdp.removeSellerLink();
                        }
                    }).fail(function () {
                        pdp.removeSellerLink();
                    });
                } else {
                    pdp.removeSellerLink();
                }

            },

            removeSellerLink: function () {
                var sellerLogoImg = "#product-promotions a.sellerImageContainer img";
                $(sellerLogoImg).unwrap();
            },
            initAddTheRangeBlock: function initAddTheRangeBlock() {
                if ($('.collectionContainer.range').length) {
                    pdp.addTheRangeBlock();
                    if (window.isKiosk()) {
                        pdp.oTabViewData.iKioskAsyncTabs++;
                    }
                }
            },
            initCompleteTheLookBlock: function initCompleteTheLookBlock() {
                if ($('.collectionContainer.look').length) {
                    pdp.addLookBlock();
                }
            },
            initLinkSaveBlock: function initLinkSaveBlock() {
                if ($('.collectionContainer.linksave').length) {
                    pdp.linkSaveBlock();
                    if (window.isKiosk()) {
                        pdp.oTabViewData.iKioskAsyncTabs++;
                    }
                }
                pdp.linkSaveBindEvents();
            },
            initBundleBlock: function initBundleBlock() {
                if ($('.collectionContainer.bundle').length) {
                    pdp.bundleBlock();
                }
            },
            displayInlineContent: function () {
                if ($("#inline-content").length !== 0) {
                    var a, b;
                    a = $("div#inlineContentURL").html() || null;
                    b = $("div#inlineContentURLType").html() || null;
                    if (a !== null && b !== null) {
                        a = a.replace(/&amp;/g,"&");
                        if (b === "CMS") {
                            $.get(a, function(data) {
                                $("div#inhouse-data").html(data);
                            });
                        } else {
                            $.getScript(a, function(c, e, d) {
                            	try {
	                            	if (window.Webcollage !== undefined) {
	                            		Webcollage.loadContent('tescodirect-uk', window.TescoData.skuID);
	                            	}
                            	} catch (ex) {}
                            });
                        }
                    }
                }
            },

            scrollToPromotions: function scrollToPromotions() {
                var el = document.querySelector('div.promotions-view');

                if ((window.location.href.indexOf('expand=true') > -1) && el) {
                    el.scrollIntoView();
               }
            }
        };
        breakpoint.mobileIn.push(function () {
            if (common.isPage('PDP')) {
                pdp.truncateText();
                pdp.equalizeBundleHeights(false);
            }
        });
        breakpoint.vTabletIn.push(function () {
            if (common.isPage('PDP')) {
                pdp.changeColumnLayout();
                pdp.truncateText();
                pdp.equalizeBundleHeights(true);
            }
        });
        breakpoint.hTabletIn.push(function () {
            if (common.isPage('PDP')) {
                pdp.changeColumnLayout();
                pdp.truncateText();
                pdp.equalizeBundleHeights(true);
            }
        });
        breakpoint.desktopIn.push(function () {
            if (common.isPage('PDP')) {
                pdp.changeColumnLayout();
                pdp.thumbnailSetup();
                pdp.truncateText();
                setTimeout(function () {
                    pdp.equalizeBundleHeights(false);
                }, 1000);
            }
        });
        breakpoint.largeDesktopIn.push(function () {
            if (common.isPage('PDP')) {
                pdp.changeColumnLayout();
                pdp.thumbnailSetup();
                pdp.truncateText();
                pdp.equalizeBundleHeights(false);
            }
        });
        breakpoint.desktopOut.push(pdp.changeColumnLayout);
        breakpoint.largeDesktopOut.push(pdp.changeColumnLayout);
        breakpoint.kioskIn.push(function () {
            pdp.changeColumnLayout();
            pdp.showMoreItems();
        });

        common.deferredInit.push(function () {
            if (common.isPage('PDP')) {
                pdp.changeColumnLayout();
            }
            // Need to invoke picturefill to replace images loaded through lazy loaded modules
            picturefill();
        });

        return pdp;

    });

// Generated by CoffeeScript 1.4.0

/*
countdown is a simple jquery plugin for countdowns

Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
and GPL-3.0 (http://opensource.org/licenses/GPL-3.0) licenses.

@source: http://github.com/rendro/countdown/
@autor: Robert Fleischmann
@version: 1.0.1
*/


(function() {

  (function($) {
    $.countdown = function(el, options) {
      var getDateData,
          currentServerTime,
          _this = this;
      this.el = el;
      this.$el = $(el);
      this.$el.data("countdown", this);
      currentServerTime = this.$el.data("currenttime");
      this.init = function() {
        _this.options = $.extend({}, $.countdown.defaultOptions, options);
        if (_this.options.refresh) {
          _this.interval = setInterval(function() {
            return _this.render();
          }, _this.options.refresh);
        }
        _this.render();
        return _this;
      };
      getDateData = function(endDate) {
        var dateData, currentTime, diff;

        // If available take supplied server time, else use local time
        currentTime = (currentServerTime ? new Date(currentServerTime*1000) : Date.parse(new Date));
        endDate = Date.parse($.isPlainObject(_this.options.date) ? _this.options.date : new Date(_this.options.date));
        diff = (endDate - currentTime) / 1000;
        ++currentServerTime;

        if (diff <= 0) {
          diff = 0;
          if (_this.interval) {
            _this.stop();
          }
          _this.options.onEnd.apply(_this);
        }
        dateData = {
          years: 0,
          days: 0,
          hours: 0,
          min: 0,
          sec: 0,
          millisec: 0
        };
        if (diff >= (365.25 * 86400)) {
          dateData.years = Math.floor(diff / (365.25 * 86400));
          diff -= dateData.years * 365.25 * 86400;
        }
        if (diff >= 86400) {
          dateData.days = Math.floor(diff / 86400);
          diff -= dateData.days * 86400;
        }
        if (diff >= 3600) {
          dateData.hours = Math.floor(diff / 3600);
          diff -= dateData.hours * 3600;
        }
        if (diff >= 60) {
          dateData.min = Math.floor(diff / 60);
          diff -= dateData.min * 60;
        }
        dateData.sec = diff;
        return dateData;
      };
      this.leadingZeros = function(num, length) {
        if (length == null) {
          length = 2;
        }
        num = String(num);
        while (num.length < length) {
          num = "0" + num;
        }
        return num;
      };
      this.update = function(newDate) {
        _this.options.date = newDate;
        return _this;
      };
      this.render = function() {
        _this.options.render.apply(_this, [getDateData(_this.options.date)]);
        return _this;
      };
      this.stop = function() {
        if (_this.interval) {
          clearInterval(_this.interval);
        }
        _this.interval = null;
        return _this;
      };
      this.start = function(refresh) {
        if (refresh == null) {
          refresh = _this.options.refresh || $.countdown.defaultOptions.refresh;
        }
        if (_this.interval) {
          clearInterval(_this.interval);
        }
        _this.render();
        _this.options.refresh = refresh;
        _this.interval = setInterval(function() {
          return _this.render();
        }, _this.options.refresh);
        return _this;
      };
      return this.init();
    };
    $.countdown.defaultOptions = {
      date: "June 7, 2087 15:03:25",
      refresh: 1000,
      onEnd: $.noop,
      render: function(date) {
        return $(this.el).html("" + date.years + " years, " + date.days + " days, " + (this.leadingZeros(date.hours)) + " hours, " + (this.leadingZeros(date.min)) + " min and " + (this.leadingZeros(date.sec)) + " sec");
      }
    };
    $.fn.countdown = function(options) {
      return $.each(this, function(i, el) {
        var $el;
        $el = $(el);
        if (!$el.data('countdown')) {
          return $el.data('countdown', new $.countdown(el, options));
        }
      });
    };
    return void 0;
  })(jQuery);

}).call(this);
define("lib/jquery.countdown", function(){});

/*globals define */
define('modules/event-messaging/common',[
    'domlib',
    'modules/common',
    'lib/jquery.countdown'
], function ($, common) {
    'use strict';

    var eventMessaging = {

        checkDate: function checkDate(endDate) {
            return (new Date(endDate).getTime() > 0 ? true : false);
        },

        init: function init(settings) {
            var settingsCopy = settings || {},
                $countdownContainer = settingsCopy.element
                    ? $(settingsCopy.element)
                    : $('.eventMessaging').find('.countdown'),
                timestamp,
                defaults,
                opts;

            $countdownContainer.each(function () {
                timestamp = $(this).data('endtime');
                defaults = {
                    date: +(new Date(timestamp * 1000)), // date in milliseconds
                    render: function (date) {
                        var hours = date.hours > 0 ? date.hours + 'hr ' : '',
                            mins = date.min > 0 ? date.min + 'min ' : '',
                            secs = date.sec > 0 ? date.sec + 'sec' : '',
                            string = '<span>' + hours + mins + secs + '</span>';

                        $(this.el)[0].innerHTML = string;
                    },
                    onEnd: function () {
                        $(this.el).closest('.eventMessaging').hide();
                    }
                };
                opts = $.extend({}, defaults, settingsCopy);

                if (eventMessaging.checkDate(timestamp)) {
                    $(this).countdown({
                        date: opts.date,
                        render: opts.render,
                        onEnd: opts.onEnd
                    });
                }
            });
        }
    };

    common.init.push(function () {
        eventMessaging.init();
    });

    return eventMessaging;
});

/* eslint-disable */
/* global define: true */
define('modules/colour-swatch/common',['domlib', 'modules/breakpoint', 'modules/common', 'modules/tesco.data', 'modules/tesco.utils', 'modules/product-tile/common', 'modules/page-title/common', 'modules/tesco.analytics', 'modules/product-description/common', 'require', 'modules/tile-carousel/common', 'modules/media-matrix/common', 'modules/pdp-s7viewer/common', 'modules/expand-collapse/common', 'modules/event-messaging/common', 'modules/jargon-buster/common', 'modules/html-parser/HtmlParser'], function ($, breakpoint, common, data, utils, productTile, pageTitle, analytics, pdp, require, carousel, mediaMatrix, s7viewer, expandCollapse, eventMessaging, jargonBuster, HtmlParser) {

    var colourSwatch = {
        maxToShowPerLine: 4,
        maxColours: 20,
        $swatches: null,
        myDataNS: window.Data,
        swatchHeight: 20,

        countColours: function () {
            var self = colourSwatch,
                $this,
                noOfColours = 0;

            $.each(colourSwatch.$swatches, function (index, value) {
                $this = $(this);
                noOfColours = $this.find('> li').length;
                if (noOfColours > self.maxToShowPerLine && noOfColours <= self.maxColours) {
                    $this.parent().find(' > .moreLink').css('display', 'block');
                    $this.parent().find('.swatches').addClass('more');
                } else if (noOfColours > self.maxColours) {
                    $this.parent().find('.mobile').css('display', 'block');
                }
            });
        },

        getSwatchDefaultHeight: function () {
            return colourSwatch.$swatches.parent().height();
        },

        unbindToggle: function () {
            colourSwatch.$swatches.find('li a').off('click');
        },

        bindToggle: function () {
            colourSwatch.$swatches.find('li a').on('click', function (e) {
                e.preventDefault();
                colourSwatch.setTileInfo(e);
                return false;
            });
        },

        hideColours: function ($container) {
            $container.closest('.product').removeClass('swatch-open');
            $container.parents('li').removeClass("colour-swatch-open");
            $container.closest('.product').find('.swatch-overlay').remove();
        },

        showColours: function ($container) {
            $container.closest('.product').addClass('swatch-open').append('<div class="swatch-overlay"></div>');
            $container.parents('li').addClass("colour-swatch-open");
            if (!$('.colour-swatch.open').length) {
                $(document).on('click.swatch', function () {
                    $(document).off('click.swatch');
                });
            }
        },

        swapIcon: function ($parent, icon) {
            $parent.find('.drop-down').text(icon);
        },

        fetchImage: function (e) {
            e.preventDefault();
            var skuid = $(e.currentTarget).data('skuid');
            var request = $.ajax({
                url: '',
                data: {
                    'skuid': skuid
                },
                success: function () {
                    colourSwatch.replaceImage.call(e.currentTarget, skuid);
                    if ($(e.target).closest('li').index() > 4) {
                        $(e.target).closest('li').prependTo($(e.target).closest('.swatches'));
                    }
                },
                error: function () {
                    //console.log('failed image request!');
                }
            });
            return false;
        },

        replaceImage: function (id) {
            $(this).parents('.product').find('.thumbnail img:not(.bcve_ping)').replaceWith(id);

        },

        init: function () {
            var self = colourSwatch;
            var selectedVariantElement;
            var _callDone = false;
            self.$swatches = $('.swatches');
            if (self.$swatches.length > 0) {
                colourSwatch.countColours();
                self.unbindToggle();
                self.bindToggle();
            }
        },

        setupPage: function ($productTiles) {
            if ($productTiles) {
                var varLists = $productTiles.find('ul.drop-down');
            } else {
                $productTiles = $('#product-tile-container li.product, #product-tile-container li.product-bb');
                var varLists = $("#product-tile-container ul.drop-down");
            }
            if (varLists.length > 0) {
                TESCO.PLP.setDropDown(varLists);
            }

            //Required as race conditions are happening with the setGridView call and markup additions above
            var gridItems = $productTiles
            var oProps = [];
            oProps.push(["div.product-variants", 30, 5, false, true]);
            TESCO.Common.formatGridElements(gridItems, 4, oProps);

            // Set selected swatch as the top row
            $productTiles.find('div.product-variants li.selected a').each(function (i, e) {
                TESCO.PLP.moveRowToTop($(e), false);
            });

        },

        getDataId: function (dataId) {
            return dataId.replace('pt-', '').replace('_', ':');
        },

        setTileInfo: function (e) {
         var tile, pdpUrl, savingPrice, variantSavingPrice, savingElem, formerPriceElem,
         fromLabel, variantWasWasPrice, variantWasPrice, wasPrice, wasWasPrice, productName, productNameElem,
         prodImage, prodImageAnchor, prodPingImageElem, prodPingImage,
         pingImage, productDetailBtn, pricePounds, pricePence, pageView,
         thisTile, siblings, swatch, skuId, skuData, newPrice, priceArr,
         colourName, priceContainer, buttonContainer, sellerContainer,
         selectOptionButton, currentlyUnavailableContainer, imgContainerElem, buyBoxElem,
               elem = $(e.target).closest('a'),
               self = colourSwatch,
               $buyButton,
               secondaryVariantValue = '',
               fullProductName = '',
               bPersonalisableProduct = false,
               imgPortraitView,
               imgPortraitViewXL,
               mediaType;

            self.myDataNS = window.Data || {};

            tile = $(elem).parents(".product");
            prodImageAnchor = tile.find("a.thumbnail");
            prodImage = prodImageAnchor.find("img");
            productNameElem = tile.find(".title-author-format h3 a");
            prodPingImageElem = tile.find(".product-ping img");
            imgContainerElem = tile.find(".image-container");
            price = tile.find(".price");

            buyBoxElem = tile.find(".buy-box-container");
            formerPriceElem = tile.find(".former-prices-container");

            buttonContainer = tile.find(".button-container");

            sellerContainer = tile.find(".buy-block");
            currentlyUnavailableContainer = ".unavailable";

            dataId = tile.parent().prop('id');
            dataId = self.getDataId(dataId);

            pdpUrl = $(elem).prop("href");

            var myData = self.myDataNS.PLP.Data[dataId];

            siblings = $(elem).parents("ul.swatches").children("li");
            swatch = $(elem).parent("li");
            colourName = swatch.data("skuid");
            skuData = myData.colourInformation[colourName];

            if (skuData.pingInfoMap) {
              prodPingImage = skuData.pingInfoMap.smallPingURL;
            }

            if (skuData.hasVariants === true) {
              fromLabel = 'from';
            } else {
              fromLabel = '';
            }

            savingPrice = skuData.saving;
            variantSavingPrice =  skuData.minSaving;
            variantWasWasPrice = skuData.minWasWasPrice;
            variantWasPrice = skuData.minWasPrice;
            wasWasPrice = skuData.wasWasPrice;
            wasPrice = skuData.wasPrice;
            skuId = skuData.skuid;
            productName = myData.productName;
            isbcve = prodImageAnchor.data('bcve');

            /*
             * JSON object modified to hold sku-name for given swatch i.e. added skuname key in skuData JSON,
             * title will now show sku-name and not product name with colour and variant value (fullname commented below)
             * url will have sku-name for respective swatch attached rather than product name of tile
             */
            pdpUrl = self.generateProductURL(myData, skuData, e);
            imgPortraitView = $(elem).parents('#listing.grid-33321.imagePreset-portrait');
            imgPortraitViewXL = $(elem).parents('#listing.grid-33321.imagePreset-portraitxl');

            if (imgPortraitViewXL.length) {
                mediaType = 'Portrait-XL';
            } else if (imgPortraitView.length) {
                mediaType = 'Portrait-L';
            } else {
                mediaType = 'Offers';
            }

            // Ajax call to get product image from JSP
            $.get('/' + utils.getSiteContext() + '/blocks/catalog/productImage.jsp?mediaSkuId=' + skuId + '&mediaType=' + mediaType + '&showPromo=true&isBlinkBoxRequired=Y', function (resp) {
                colourSwatch.replaceImage.call(elem, resp);

                var $elemUrl = $(elem).attr('href'),
                    prodImg = $(elem).closest('.image-container').find('.thumbnail');

                prodImg.attr('href', $elemUrl);
                productTile.Height.setHeadingHeights(elem.parents('.product-tile .details-container .title-author-format'));
                productTile.Ellipsis.init($('.title-author-format').find('h3'));

                $('.moreLink').attr('href', $elemUrl);

                if ($(elem).closest('li').index() > colourSwatch.maxToShowPerLine) {
                    $(elem).closest('li').prependTo($(elem).closest('.swatches'));
                }
            });

            //Move swatch row to be visible
            //self.moveRowToTop(elem, true);

            $(siblings).removeClass("selected");
            swatch.addClass("selected");
            prodImageAnchor.prop("href", pdpUrl);
            var myBuyButtonData = skuData['buyButtonInfo'];

            bPersonalisableProduct = $.trim(tile.find('.secondary-button').text()) === "Personalise me"
                ? true
                : false;

            if (bPersonalisableProduct) {
                if (skuData['buyButtonInfo'].P_Current_Button !== "emwbis") {
                    skuData['buyButtonInfo'].P_Current_Button = "personalise";
                }
            }

            if (skuData.hasVariants === false) {
                secondaryVariantValue = skuData.secondaryVariantValue;
            }

            fullProductName = self.getFullProductAndVariantName(productName, colourName, secondaryVariantValue);

            if (skuData.variantProdTitle && skuData.variantProdTitle != null) {
                fullProductName = skuData.variantProdTitle;
            } else {
                //TODO: undo
                //return false;
            }

            //update product name
            self.updateProductName(productNameElem, fullProductName, pdpUrl);

            //update product price
            self.updateProductPrice(skuData.price, price, myData);

            self.updateProductPingImage(prodPingImage, prodPingImageElem, imgContainerElem, myData);

            // Update Buy button state
            if (!window.isKiosk()) {
                self.updateBuyButton(buttonContainer, skuData, fullProductName, pdpUrl);
                self.updateFormerPrice(wasPrice, wasWasPrice, variantWasPrice, variantWasWasPrice, fromLabel, buyBoxElem, myData, e);
                self.updateProductSavingPrice(savingPrice, variantSavingPrice, fromLabel, formerPriceElem, myData);
            }

            // Stop all propergation
            return false;
        },
        decideBuyFrom: function (skuData, sellerContainer, priceContainer) {
            if (skuData.isSingleSeller === true) {
                if (skuData.isSinglePrice === false) {
                    //priceContainer.append("<p class=\"from-text\">From</p>");
                }
                sellerContainer.html("Buy from " + skuData.sellerName);
            } else {
                sellerContainer.html(this.myDataNS.PLP.BuyButton.Label.multipleSellers);
                //priceContainer.append("<p class=\"from-text\">From</p>");
            }

            // If product hasVariants, always display from price.
            if (skuData.hasVariants === true) {
                if (!priceContainer.find('p.from-text').length) {
                    //priceContainer.append("<p class=\"from-text\">From</p>");
                }
            }

        },


        // updateFormerPrice function will update the was and wasWas prices in th buy-box container
        updateFormerPrice: function (
          wasPrice,
          wasWasPrice,
          variantWasPrice,
          variantWasWasPrice,
          fromLabel,
          $buyBoxElem,
          myData, e) {
          var messageString = '&nbsp; &pound;',
            priceWas = '',
            priceWasWas = '',
            formerPriceElem = $buyBoxElem.find('ol.former-prices'),
            self = colourSwatch;

          if (wasPrice > 0 || wasWasPrice > 0 || variantWasPrice > 0 || variantWasWasPrice > 0) {
            if (formerPriceElem.length > 0) {
              formerPriceElem.css('display', 'block');
            } else {
              $buyBoxElem.find('.former-prices-container').prepend("<ol class='former-prices'><li></li></ol>").css('display', 'block');
            }
          } else {
            if (formerPriceElem.length > 0) {
              formerPriceElem.remove();
            }
            if ($buyBoxElem.find('.saving').length > 0) {
              $buyBoxElem.find('.saving').remove();
            }
          }

          if (variantWasPrice > 0 || variantWasWasPrice > 0) {
            priceWas = variantWasPrice;
            priceWasWas = variantWasWasPrice;
          } else {
            priceWas = wasPrice;
            priceWasWas = wasWasPrice;
          }
          priceWas = priceWas.toFixed(2);
          priceWasWas = priceWasWas.toFixed(2);

          if (priceWas > 0) {
            $buyBoxElem.find('li').html('Was ' + fromLabel + messageString + priceWas);
            if (priceWasWas > 0) {
              $buyBoxElem.find('li').html('Was ' + fromLabel + messageString + priceWasWas + '&nbsp;|' + messageString + priceWas);
            }
          } else if (priceWasWas > 0) {
            $buyBoxElem.find('li').html('Was ' + fromLabel + messageString + priceWasWas);
          }
          // rowElems carries just the tiles whose heights have to be adjusted.
          productTile.Height.init(true, self.getRowTiles(e));
        },

        // This finds the product tiles in the row where any of the swatches was clicked.
        getRowTiles: function (e) {
          var rowElems = [],
            currentPrdTile = $(e.target).parents('div.product').parent('li');

          rowElems.push(currentPrdTile[0]);
          if (currentPrdTile.hasClass('row-start')) {
            while (currentPrdTile.next()[0] !== undefined && !currentPrdTile.next().hasClass('row-start')) {
              rowElems.push(currentPrdTile.next()[0]);
              currentPrdTile = currentPrdTile.next();
            }
          } else {
            if (currentPrdTile.next()[0] !== undefined && currentPrdTile.next().hasClass('feature-tile')) {
              rowElems.push(currentPrdTile.next()[0]);
            } else if (currentPrdTile.prev()[0] !== undefined && currentPrdTile.prev().hasClass('feature-tile')) {
              rowElems.push(currentPrdTile.prev()[0]);
            }
            while (currentPrdTile.next()[0] !== undefined && !currentPrdTile.next().hasClass('row-start')) {
              rowElems.push(currentPrdTile.next()[0]);
              currentPrdTile = currentPrdTile.next();
            }
            currentPrdTile = $(e.target).parents('li.product-tile');
            while (currentPrdTile.prev()[0] !== undefined && !currentPrdTile.prev().hasClass('row-start')) {
              rowElems.push(currentPrdTile.prev()[0]);
              currentPrdTile = currentPrdTile.prev();
            }
            if (currentPrdTile.prev()[0] !== undefined && !currentPrdTile.prev().hasClass('feature-tile')) {
              rowElems.push(currentPrdTile.prev()[0]);
            }
          }
          return $(rowElems);
        },

        updateProductPrice: function (myPrice, $priceElem, myData) {
            myPrice = myPrice.toFixed(2);
            var fromElement = $priceElem.find('.from');
            if (myData.showFromprice === true) {
                $priceElem.html('&nbsp' + '&pound;' + myPrice).prepend(fromElement);
            } else {
                $priceElem.html('&pound;' + myPrice);
            }
        },

        //updateProductPing will update the ping image corresponding to each swatch element on click. The data will be fed from JSON response coming in myData
        updateProductPingImage: function(pingImage, $prodPingImageElem, $imgContainerElem, myData) {
            if (pingImage !== undefined) {
                $prodPingImageElem.length > 0 ? $prodPingImageElem.css('display','block').prop('src', pingImage)
                : $imgContainerElem.append("<div class='product-ping' data-pfinit='true'><img src=" + pingImage + " alt='PriceMarkdownPings' /></div>");
                 } else {
            $imgContainerElem.find('.product-ping').remove();
            }
        },

        //updateProductSavingPrice will update the saving element to update the new struck off price of the swatch element

        updateProductSavingPrice: function (savingPrice, variantSavingPrice, fromLabel, $formerPriceElem, myData) {
          var savePrice = '',
            $savingPriceElem = $formerPriceElem.find('.saving');

          if (variantSavingPrice > 0) {
            savePrice = variantSavingPrice;
          } else {
            savePrice = savingPrice;
          }
          savePrice = savePrice.toFixed(2);
          if (savePrice > 0) {
            $savingPriceElem.length
              ? $savingPriceElem.html('Save ' + fromLabel + '&nbsp; &pound;' + savePrice)
              : $formerPriceElem.find('.former-prices').after("<p class='saving'>" +
                'Save ' + fromLabel + '&nbsp; &pound;' + savePrice + "</p>");
          } else {
            $savingPriceElem.remove();
          }
        },

        showCurrentlyUnavailable: function (myBuyButtonData, currentlyUnavailableContainer, $tile, skuData) {
            if (myBuyButtonData['P_Current_Button'] === 'emwbis') {
                $tile.find(currentlyUnavailableContainer).html(this.myDataNS.PLP.BuyButton.Label.currentlyUnavailable);
            } else {
                $tile.find(currentlyUnavailableContainer).html("");
            }
        },
        generateProductURL: function (myData, skuData, e) {
            var productId;

            if ($(e.currentTarget).closest('.product').data('isff') == true) {
                productId = skuData.productId;
            } else {
                productId = myData.productId;
            }

            var pdpUrl = '/' + utils.getSiteContext() + '/' + skuData.variantProdTitle + '/' + productId + '.prd';
            pdpUrl = utils.formatURL(pdpUrl);

            if (!$(e.currentTarget).closest('.product').data('isff')) {
                pdpUrl += '?skuId=' + skuData.skuid;
            }
            if ($(e.currentTarget).closest('.product').data('isff') && $(e.currentTarget).closest('.product').data('isues')) {
                var uesUrl = $(e.currentTarget).prop('href');
                uesId = uesUrl.split('.prd')[1];
                pdpUrl += uesId;
            }

            return pdpUrl;
        },
        updateProductCompare: function ($productTile, skuID, productID, productURL) {
            var dynSessConf = $productTile.find('input[name="_dynSessConf"]').val();
            productURL = encodeURIComponent(productURL);
            var newProductCompareURL = '/' + utils.getSiteContext() + '/search-results/results.page?_DARGS=/blocks/catalog/productlisting/variantsGridItem.jsp_A&_DAV=' + skuID + '|' + productID + '|' + encodeURIComponent(utils.formatURL(productURL)) + '&_dynSessConf=' + dynSessConf + '&product=' + skuID + '|' + productID + '|' + encodeURIComponent(utils.formatURL(productURL)) + '&queryString=' + escape(window.location.search.replace("?", ""));
            $productTile.find('.add-to-compare .text').attr('href', newProductCompareURL);
        },
        updateProductName: function ($productNameElem, fullProductName, pdpUrl) {
            $productNameElem.html(fullProductName);
            $productNameElem.prop("href", pdpUrl);
            $productNameElem.prop('title', fullProductName);
        },
        updateProductDetailsButton: function ($productDetailBtn, fullProductName, pdpUrl) {
            $productDetailBtn.prop('title', fullProductName)
            $productDetailBtn.prop('href', pdpUrl);
        },
        updateBuyButton: function ($buttonContainer, skuData, fullProductName, pdpUrl) {
            var myBuyButtonData = skuData['buyButtonInfo'];
            var switchCase = myBuyButtonData['P_Current_Button'];
            this.removeAllButtons($buttonContainer);

            // Sku cannot be identified
            if (switchCase === 'buy' || switchCase === 'preOrder') {
                if (skuData.hasVariants) {
                    switchCase = 'default';
                }
            }

            switch (switchCase) {
                case "buy":
                    this.setBuyButton($buttonContainer, myBuyButtonData, fullProductName, pdpUrl);
                    break;
                case "emwbis":
                    this.setRequestStockAlert($buttonContainer, myBuyButtonData, fullProductName, pdpUrl);
                    break;
                case "preOrder":
                    this.setBuyButton($buttonContainer, myBuyButtonData, fullProductName, pdpUrl);
                    this.setPreOrder($buttonContainer, myBuyButtonData, fullProductName, pdpUrl);
                    break;
                case "personalise":
                    this.setButtonPersonalised($buttonContainer, myBuyButtonData, fullProductName, pdpUrl);
                    break;
                default:
                    this.setSelectOptions($buttonContainer, myBuyButtonData, fullProductName, pdpUrl);
                    break;
            }
        },
        removeAllButtons: function ($buttonContainer) {
            //Remove all button combination from the button container
            $buttonContainer.find('input.add-to-basket, a.stock-alert, a.btn-select-options').remove();
        },
        removeATGFields: function ($buttonContainer) {
            //Remove ATG specific fields for adding to basket
            $buttonContainer.find('input[name="/atg/commerce/order/purchase/CartModifierFormHandler.addItemToOrder"], input[name="_D:/atg/commerce/order/purchase/CartModifierFormHandler.addItemToOrder"]').remove();
        },
        setBuyButton: function ($buttonContainer, myBuyButtonData, fullProductName, pdpUrl) {
            var $buyButton;
            var scriptName = 'variantsGridItem.jsp';
            this.removeATGFields($buttonContainer);

            //Update hidden form value
            $buttonContainer.find('input[name="/atg/commerce/order/purchase/CartModifierFormHandler.catalogRefIds"]').val(myBuyButtonData['P_Least_Cost_Listing_Id']);

            var $addToBasketButton = $('<input type="submit" class="add-to-basket primary-button" value="' + this.myDataNS.PLP.BuyButton.Label.addToBasket + '" name="/atg/commerce/order/purchase/CartModifierFormHandler.addItemToOrder" title="Add ' + fullProductName + ' to Basket">');
            var $ATGfields = $('<input type="hidden" name="/atg/commerce/order/purchase/CartModifierFormHandler.addItemToOrder" value="submit" /><input type="hidden" name="_D:/atg/commerce/order/purchase/CartModifierFormHandler.addItemToOrder" value=" " /><input type="hidden" name="_D:/atg/commerce/order/purchase/CartModifierFormHandler.addItemToOrder" value=" " />');

            $buttonContainer.find('div:last').before($ATGfields).prev().before($addToBasketButton);
        },

        setRequestStockAlert: function ($buttonContainer, myBuyButtonData, fullProductName, pdpUrl) {
            var $stockAlertButton = $('<a class="stock-alert secondary-button" href="' + pdpUrl + '" title="request stock alert for ' + fullProductName + '"> ' + this.myDataNS.PLP.BuyButton.Label.requestStockAlert + '</a>');
            $buttonContainer.find('form').append($stockAlertButton);
        },

        setPreOrder: function ($buttonContainer, myBuyButtonData, fullProductName, pdpUrl) {
            var $preOrderButton = $buttonContainer.find('.btn-add-to-basket');
            $preOrderButton.val(this.myDataNS.PLP.BuyButton.Label.preOrder);
        },
        setSelectOptions: function ($buttonContainer, myBuyButtonData, fullProductName, pdpUrl) {
            var $selectOptionsButton = $('<a class="stock-alert secondary-button" href="' + pdpUrl + '" title="' + fullProductName + '"> ' + this.myDataNS.PLP.BuyButton.Label.selectOptions + ' </a>');
            $buttonContainer.find('form').append($selectOptionsButton);
        },
        setButtonPersonalised: function ($buttonContainer, myBuyButtonData, fullProductName, pdpUrl) {
            var $selectOptionsButton = $('<a class="stock-alert secondary-button" href="' + pdpUrl + '" title="' + fullProductName + '"> Personalise me </a>');
            $buttonContainer.find('form').append($selectOptionsButton);
        },
        getFullProductAndVariantName: function (productName, colourName, secondaryVariantValue) {
            var newName = '';
            newName = productName + ' - ' + colourName;
            if (secondaryVariantValue !== '') {
                newName += ', ' + secondaryVariantValue;
            }
            return newName;
        },
        moveRowToTop: function ($elem, bToggleDropDown) {
            var $mySwatch = $elem.parent();
            // Drop down is present for this product tile
            if ($mySwatch.parents('.colour-swatch')) {
                var $variantSwatches = $elem.parent().parent().children();
                var myIndex = $variantSwatches.index($mySwatch);
                var myRow = Math.floor((myIndex + 1) / this.maxToShowPerLine); // divider is the amount of swatches per row
                if (myRow !== 0) {
                    if (this.isDropDownExpanded($mySwatch.parents('.colour-swatch'))) {
                        if (bToggleDropDown) {
                            $mySwatch.parents('.colour-swatch').find('.drop-down').trigger('click');
                        }
                    }

                    $mySwatch.parents('.colour-swatch').css('top', -(myRow * this.swatchHeight));
                } else {
                    this.closeDropDown($mySwatch.parents('div.drop-down-container'));
                }
            }
        },
        getProductTileRow: function ($gridItems, $productTile) {
            return Math.ceil(($gridItems.index($productTile) + 1) / 4);
        },
        realignProductTileRow: function ($tile, $productNameElem, skuData) {
            var variantName = " - " + skuData.colourName;
            if (skuData.hasVariants === false) {
                if (skuData.secondaryVariantValue !== '') {
                    variantName += ", " + skuData.secondaryVariantValue;
                }
            }

            utils.formatVariantStyleAndName($productNameElem, variantName);
            productTile.Height.adjust($('#listing'));
        },
        closeDropDown: function ($dropDown) {
            $dropDown.removeClass("open");
        },
        resetDropDown: function ($dropDown) {
            $dropDown.find('.swatches').css('top', '0px');
        },
        isDropDownExpanded: function ($dropDown) {
            return $dropDown.hasClass('open')
                ? true
                : false;
        }
    };

    common.init.push(function () {
        colourSwatch.init();
    });

    return colourSwatch;
});

/* globals define,require,window,AsyncBlockController,r3,RR,console,s */
/* jslint plusplus: true, regexp: true, unparam: true */
define('modules/rich-sort/RichSort', [],function () {
  'use strict';

  var RichSort = null;

  RichSort = function (sProvider) {
    var getSKUsFromProvider = null,
      getSKUsForOffset = null,
      aSortedSKUs = [],
      getSKUsFromRichRelevance = null,
      getSKUsFromAttraqt = null,
      getSKUsFromSlickStitch = null,
      setDOMHrefsToRichRelevance = null,
      setRichRelevanceCallback = null,
      getRichRelevanceJSONValidity = null,
      bRichRelevanceHrefEventsBound = false,
      iRichRelevanceJSONValidIndex = 0,
      sRichRelevancePlacementName = 'category_page.sort_1',
      getCategoryTree = null,
      parseAttraqtData = null,
      getCurrentCategoryId = null,
      _sProvider = sProvider;

    if (!_sProvider) {
      _sProvider = window.richSortProvider || 'RichRelevance';
    }

    getRichRelevanceJSONValidity = function (oData) {
      var bResult = false,
        i = 0;

      for (i = 0; i < oData.length; i += 1) {
        if (oData[i] !== undefined) {
          if (oData[i].placement_name === sRichRelevancePlacementName) {
            bResult = true;
            iRichRelevanceJSONValidIndex = i;
            break;
          }
        }
      }
      return bResult;
    };

    setRichRelevanceCallback = function () {
      var aSKUList = [],
        oRRData = null,
        iSKUsLength = null,
        i = 0;

      RR.jsonCallback = function () {
        if (RR.data.JSON.placements.length > 0) {
          if (getRichRelevanceJSONValidity(RR.data.JSON.placements) === true) {
            oRRData = RR.data.JSON.placements;
            iSKUsLength = oRRData[iRichRelevanceJSONValidIndex].items.length;


            for (i = 0; i < iSKUsLength; i += 1) {
              aSKUList.push(oRRData[iRichRelevanceJSONValidIndex].items[i].id);
            }
            aSortedSKUs = aSKUList;
            if (bRichRelevanceHrefEventsBound === false) {
              setDOMHrefsToRichRelevance(oRRData);
            }
            RR.data.JSON.placements.length = 0;
            $(window).trigger('RichSortDataComplete');
          } else {
            $(window).trigger('RichSortDataComplete', ['oDestroyRichSort']);
          }
        } else {
          $(window).trigger('RichSortDataComplete', ['oDestroyRichSort']);
        }
      };
    };

    if (_sProvider === 'RichRelevance') {
      setRichRelevanceCallback();
    }

    getSKUsFromProvider = function (iOffset) {
      switch (_sProvider) {
        case 'RichRelevance':
          getSKUsFromRichRelevance(iOffset);
          break;
        case 'Attraqt':
          getSKUsFromAttraqt(iOffset);
          break;
        case 'SlickStitch':
          getSKUsFromSlickStitch(iOffset, 40);
          break;
        default:
          // No Default
      }
    };

    getSKUsForOffset = function (iOffset, iLength) {
      var aOffsetSKUs = [],
        sOffsetSKUs = '',
        iNoOfSKUs = iLength || 20;

      if (aSortedSKUs) {
        if (aSortedSKUs.length < iNoOfSKUs) {
          getSKUsFromProvider(iOffset);
        }
        aOffsetSKUs = aSortedSKUs.splice(0, iNoOfSKUs);
        sOffsetSKUs = aOffsetSKUs.join(',');
        return sOffsetSKUs;
      }
      return null;
    };

    getSKUsFromRichRelevance = function (iOffset) {
      window.R3_COMMON.RICHSORT.paginate(iOffset, 60);
      window.r3();
    };

    getSKUsFromAttraqt = function (iOffset) {
      var sUserId = window.s.eVar24 || '',
        sSessionId = $.cookie('JSESSIONID'),
        iPageNo = (iOffset + 20) / 20,
        sCategoryTree = getCategoryTree(),
        sCategoryId = getCurrentCategoryId(),
        sEndPoint = window.Data.PLP.Attraqt.endpoint,
        sSiteId = window.Data.PLP.Attraqt.siteId,
        sURL = sEndPoint + '?'
          + 'siteId=' + sSiteId + '&UID=' + sUserId
          + '&sid=' + sSessionId
          + '&zone0=category&currency=GBP&config_categorytree=' + sCategoryTree
          + '&config_category=' + sCategoryId
          + '&category_page=' + iPageNo;

      $.ajax({
        url: sURL,
        method: 'GET',
        beforeSend: function (jqXHR, settings) {
          var _settings = settings;

          _settings.url = sURL;
        }
      }).done(function (oResponse) {
        parseAttraqtData(oResponse);
        $(window).trigger('RichSortDataComplete');
      }).fail(function () {
        $(window).trigger('RichSortDestroy');
        $('#listing').removeClass('IBBookmark');
      });
    };

    getSKUsFromSlickStitch = function (offset, length) {
      var sDataAttr = $('.products-wrapper').data('schoolskulist'),
        offsetSkus = [],
        slickStitchSkus = [],
        numSkus = 20;

      if (length) {
        numSkus = length;
      }

      if (sDataAttr) {
        slickStitchSkus = sDataAttr.split(',');
        offsetSkus = slickStitchSkus.splice(offset, numSkus);
        aSortedSKUs = offsetSkus.slice();
      }
      $(window).trigger('RichSortDataComplete');
      return offsetSkus;
    };

    getCategoryTree = function () {
      var aCategoryIds = window.Data.PLP.aCategoryHierarchy,
        sCategoryIdsForAttraqt = '';

      if (aCategoryIds.length) {
        sCategoryIdsForAttraqt = aCategoryIds.join('/');
      }

            // sCategoryIdsForAttraqt = 'cat3376685/cat38470010/cat3376549/cat3375936/cat38420004/';
      sCategoryIdsForAttraqt += '/' + getCurrentCategoryId();
      return sCategoryIdsForAttraqt;
    };

    getCurrentCategoryId = function () {
      var sCurrentCategoryId = window.Data.PLP.currentCategoryId;

            // sCurrentCategoryId = 'cat38420006';
      return sCurrentCategoryId;
    };

    parseAttraqtData = function (oRawData) {
      var aResults = [],
        aSKUList = [],
        i = 0;

      if (oRawData) {
        if (oRawData.zones[0]) {
          if (oRawData.zones[0].data.results) {
            aResults = oRawData.zones[0].data.results;
            for (i = 0; i < aResults.length; i += 1) {
              aSKUList.push(aResults[i].fields.product_id.value[0]);
            }
          }
        }
      }
      aSortedSKUs = aSKUList;
    };

    setDOMHrefsToRichRelevance = function (oRRData) {
      var sProductContainerSelector = '#main-content',
        $productContainer = $(sProductContainerSelector),
        $currentTile = null,
        oSKUListWithHrefs = oRRData[iRichRelevanceJSONValidIndex].items,
        sSKUId = null,
        i = null;

      $productContainer.on('RichSortLinkTriggered', '.product', function (e) {
        $currentTile = $(e.target).find('a.thumbnail');
        sSKUId = $currentTile.closest('.product-tile').attr('id').slice(-8);
        for (i = 0; i < oSKUListWithHrefs.length; i += 1) {
          if (sSKUId === oSKUListWithHrefs[i].id) {
            $currentTile.attr('href', oSKUListWithHrefs[i].linkURL);
            break;
          }
        }
      });
      bRichRelevanceHrefEventsBound = true;
    };

    /**
     * [getSKUs get product sku's from third party providers, sort these skus into paginated arrays]
     * @param  {Integer} iOffset [offset from current products, page one would have 0 offset,
     *         further pages would increase the offset]
     * @param  {Integer} iLength [optional fixed maximum length of products]
     * @return {String} [comma separated string of product skus]
     */
    this.getSKUs = function getSKUs(iOffset, iLength) {
      return getSKUsForOffset(iOffset, iLength);
    };

    this.isAvailable = function isAvailable() {
      var bIsAvailableResult = null;

      if (aSortedSKUs.length >= 20) {
        bIsAvailableResult = true;
      } else {
        try {
          bIsAvailableResult = window.RR.data !== undefined
            && window.RR.data.JSON.placements.length > 0;
        } catch (ex) {
          bIsAvailableResult = false;
        }
      }
      return bIsAvailableResult;
    };

    //  Create a public interface for getting SKUs from SlickStitch

    this.getSKUsFromSlickStitchPub = function getSKUsFromSlickStitchPub(offset, length) {
      return getSKUsFromSlickStitch(offset, length);
    };
    this.getSKUsFromProviderPub = function getSKUsFromProviderPub(iOffset) {
      getSKUsFromProvider(iOffset);
    };
  };
  return RichSort;
});

/* eslint-disable */
/*global define, window */
define('modules/load-more/common',[
    'domlib',
    'modules/settings/common',
    'modules/breakpoint',
    'modules/common',
    'modules/product-tile/common',
    'modules/colour-swatch/common',
    'modules/tile-carousel/common',
    'modules/tesco.utils',
    'modules/tesco.data',
    'modules/rich-sort/RichSort',
    'modules/mvc/fn',
    'modules/tesco.analytics'
], function (
    $,
    SETTINGS,
    breakpoint,
    common,
    productTile,
    colourSwatch,
    tileCarousel,
    utils,
    data,
    RichSort,
    fn,
    analytics
) {
    var loadMore = {
        pageRequestUrl: '/blocks/product-tile/product-listing-page-request-data.shtml',
        $listing: $('#listing'),
        viewportColumns: {
            'small': 2,
            'medium': 3,
            'large': 5
        },
        viewport: 0,
        maxProductsPerPage: 20,
        moreProducts: false,
        currentPage: 1,
        currentTileTotal: 0,
        kioskLoadMore: false,
        maxCount: null,
        sellerId: null,
        eventId: null,
        endecaId: null,
        lastSelectedFilter: null,
        promoId: null,
        promoBucketId: null,
        modifySearchQuery: null,
        selectedSortOption: null,
        offset: 20,
        upperPage: 1,
        lowerPage: 0,
        $prevButton: null,
        $nextButton: null,
        bIsCarousel: false,
        pageLoadedWithBookmark: false,
        ajaxInProgress: false,
        bScrolling: false,
        nextTrigger: null,
        prevTrigger: null,
        schoolskuList: null,
        schoolId: null,
        triggerPoints: {
            'mobile': 3,
            'vtablet': 2,
            'htablet': 2,
            'desktop': 2,
            'largedesktop': 2
        },
        $listingChildren: null,
        prevButtonVisible: false,
        nextButtonVisible: false,
        segmentCount: 3,
        initialised: false,
        disableMobileScrolling: false,
        getfilters: false,
        oRichSort: null,
        imagePreset: null,
        aImagePresetNames: ['imagePreset-Detail', 'imagePreset-Default', 'imagePreset-portrait', 'imagePreset-portraitxl'],
        sInfinityBrowseURLParams: 'infinityBrowseURLParams',

        // Event Handler
        onLoadMore: function (e) {
            if (e) {
                e.preventDefault();
            }
            if ($(e.currentTarget).hasClass('disabled')) {
                return;
            }
            if (!loadMore.bIsCarousel) {
                this.fetchNextPage.call(this, e);
            }

        },

        getNoOfTiles: function () {
            var currentCount = loadMore.$listing.find('.product').parent().not('.load-more-tile, .loadingBar, .featureTiledata-variables').length;
            loadMore.currentTileTotal += currentCount;
            return currentCount - loadMore.currentTileTotal;
        },

        totalNoOfPages: function () {
            return parseInt($('#listing').attr('data-maxcount')) !== 0
            ? Math.ceil($('#listing').attr('data-maxcount') / loadMore.maxProductsPerPage) : 1;
        },

        checkKioskLoadMore: function (carousel) {
            //kiosk load more for carousel!
            if (this.$listing.is('.product-carousel')) {
                var currentNumberOfTiles = this.$listing.find(".products li").not("li li").not('.feature-tile').not('.loadingBar').not('.featureTiledata-variables').length,
                    isUnderMaxCount = currentNumberOfTiles < $('#listing').attr('data-maxcount'),
                    numPanels = Math.ceil(carousel.listingCarousel.numItems / common.getNumberOfVisibleItemsForKioskListing($('#listing')));
                if (carousel.listingCarousel.activePanel === (numPanels - 1) && isUnderMaxCount) {
                    this.kioskLoadMore = true;
                    return true;
                } else {
                    this.kioskLoadMore = false;
                    carousel.listingCarousel.kioskListingLayout(true);
                    return false;
                }
            }
        },
        checkKioskLoadPrev: function (carousel) {
            // can be tidied up to create common function to combine this function and checkKioskLoadMore()
            if (this.$listing.is('.product-carousel')) {
                if (loadMore.lowerPage > 0) {
                    return true;
                } else {
                    return false;
                }
            }
        },

        fetchNextPage: function (e) {
            var self = loadMore,
                element = e,
                iCalculatedOffset = 0;

            if (this.currentPage <= this.totalNoOfPages() || this.kioskLoadMore) {
                if (loadMore.oRichSort instanceof RichSort) {
                    if (!loadMore.oRichSort.isAvailable()) {
                        $(window).one('RichSortDataComplete', function (e, oDestroyRichSort) {
                            if (oDestroyRichSort !== undefined) {
                                self.oRichSort = null;
                            }
                            loadMore.getResults(element, null, false, false, true, true);
                        });

                        iCalculatedOffset = self.calculateOffset();
                        loadMore.oRichSort.getSKUsFromProviderPub(iCalculatedOffset);
                    } else {
                        loadMore.getResults(e, null, false, false, true, true);
                    }
                } else {
                    loadMore.getResults(e, null, false, false, true, true);
                }
            }
        },

        fetchPrevPage: function (e) {
            var self = loadMore;
            if (this.currentPage >= 0) {
                if (this.currentPage !== 0) {
                    this.currentPage--;
                }
                loadMore.getResults(e, null, true, false, true, true);
            }
        },

        calculateOffset: function () {
            return loadMore.currentPage * loadMore.maxProductsPerPage;
        },
        hideLoadMoreTile: function () {
            loadMore.$listing.find('.load-more-tile').addClass('hidden');
        },
        changeTileText: function (e) {
            $(e.currentTarget).find('.text').text('Items added');
        },
        showTile: function (viewport) {
            if (loadMore.moreProducts && (loadMore.currentTileTotal % viewport !== 0)) {
                loadMore.setTileHeight();
            }
        },
        getViewport: function (viewport) {
            return loadMore.viewportColumns[viewport];
        },
        init: function () {
            var self = loadMore;
            // Yet another race-condition issue
            self.$listing = $('#listing');

            self.bindProductBookmark();
            self.bindPaginationDestroyer();

            if (common.isPage('productComparison')) {
                $('.pcContinueShopping').on('click', function (e) {
                    e.preventDefault();
                    history.back();
                    return false;
                });
            } else if (!common.isPage('PLP') && !common.isPage('PDP')) {
              self.clearSessionData(self.sInfinityBrowseURLParams);
            }

            if (self.$listing.length) {

                if (typeof TescoData !== 'undefined') {
                    if (typeof TescoData.IB !== 'undefined') {
                        if (typeof TescoData.IB.triggerPoints !== 'undefined') {
                            $.extend(loadMore.triggerPoints, TescoData.IB.triggerPoints);
                        }
                        if (typeof TescoData.IB.disableMobileScrolling !== 'undefined') {
                            self.disableMobileScrolling = TescoData.IB.disableMobileScrolling;
                        }
                    }
                }

                if (self.disableMobileScrolling) {
                    // If parameter is set to true, we need to make sure user is on mobile viewport.
                    if (!breakpoint.mobile) {
                        self.disableMobileScrolling = false;
                    }
                }

                self.$listingChildren = self.$listing.find('.products > li').not('.load-more-tile, .featureTiledata-variables');

                if (window.Data) {
                    if (window.Data.PLP) {
                        if (window.isRichSortEnabled && !loadMore.bRichSortDestroyed) {
                            loadMore.oRichSort = new RichSort();
                            $(window).on('RichSortDestroy', function() {
                                self.bRichSortDestroyed = true;
                                self.oRichSort = null;
                                self.ajaxInProgress = false;
                            });
                        }
                    }
                }

                loadMore.bIsCarousel = self.$listing.is('.product-carousel');

                loadMore.$nextButton = loadMore.$listing.find('.load-more-tile');
                loadMore.$prevButton = $('.product-load-prev');

                loadMore.getNoOfTiles();
                loadMore.handleNextPrevButtons(null, null, true);

                $(self.$listing).on("click", ".product-load-more", function (e) {
                    e.preventDefault();
                    loadMore.nextTrigger = null;
                    loadMore.prevTrigger = null;
                    if (!loadMore.ajaxInProgress) {
                        loadMore.ajaxInProgress = true;
                        loadMore.onLoadMore(e);
                    }
                });

                $('#page-container').on("click", ".product-load-prev", function (e) {
                    e.preventDefault();
                    loadMore.nextTrigger = null;
                    loadMore.prevTrigger = null;
                    if (!loadMore.ajaxInProgress) {
                        loadMore.ajaxInProgress = true;
                        loadMore.fetchPrevPage(e);
                    }
                });

                //breakpoint change methods
                breakpoint.mobileIn.push(function () {
                    loadMore.viewport = loadMore.viewportColumns.small;
                    loadMore.showTile(loadMore.viewportColumns.small);
                });
                breakpoint.vTabletIn.push(function () {
                    loadMore.viewport = loadMore.viewportColumns.medium;
                    loadMore.showTile(loadMore.viewportColumns.medium);
                });
                breakpoint.hTabletIn.push(function () {
                    loadMore.viewport = loadMore.viewportColumns.medium;
                    loadMore.showTile(loadMore.viewportColumns.medium);
                });
                breakpoint.desktopIn.push(function () {
                    loadMore.viewport = loadMore.viewportColumns.large;
                    loadMore.showTile(loadMore.viewportColumns.large);
                });
                breakpoint.largeDesktopIn.push(function () {
                    loadMore.viewport = loadMore.viewportColumns.large;
                    loadMore.showTile(loadMore.viewportColumns.large);
                });

                loadMore.initFramework();
                loadMore.setInitialParameters();

                if (!window.isKiosk()) {
                    loadMore.bindWindowScroll();
                }
            }
        },
        initFramework: function () {
            var myInlineRequests = ['getProducts', 'getProductsAndFilters']; // Part of the existing framework
            var myRequests = {
                'getProducts': [],
                'getProductsAndFilters': []
            }; // Part of the existing framework
            var myActions = {
                'getProducts': ['/' + utils.getSiteContext() + '/blocks/catalog/productlisting/infiniteBrowse.jsp'],
                'getProductsAndFilters': ['/' + utils.getSiteContext() + '/blocks/productlisting/asyncBrowse.jsp']
            }; // Part of the existing frame work to add ajax url
            var myModules = {};
            var myDefaultActions = {
                'getProducts': ['/' + utils.getSiteContext() + '/blocks/catalog/productlisting/infiniteBrowse.jsp'],
                'getProductsAndFilters': ['/' + utils.getSiteContext() + '/blocks/productlisting/asyncBrowse.jsp']
            };


            data.Global.init({
                'inlineRequests': myInlineRequests,
                'requests': myRequests,
                'modules': myModules,
                'actions': myActions,
                'defaultActions': myDefaultActions
            });

        },
        setInitialParameters: function () {
            var $elem = loadMore.$listing.find('.products-wrapper');
            loadMore.maxCount = $('#listing').attr('data-maxcount');
            loadMore.sellerId = $elem.data('sellerid');
            loadMore.eventId = $elem.data('eventid');
            loadMore.endecaId = $elem.data('endecaid');
            //loadMore.lastSelectedFilter = $elem.data('lastselectedfilter');
            loadMore.promoId = $elem.data('promoid');
            loadMore.promoBucketId = $elem.data('promobucketid');
            loadMore.modifySearchQuery = $elem.data('modifysearchquery');
            loadMore.selectedSortOption = $elem.data('selectedsortoption');
            loadMore.segmentCount = $elem.data('segmentcount');
            loadMore.pageViewType = "grid";
            loadMore.schoolskuList = $elem.attr('data-schoolskuList');
            loadMore.schoolId = $elem.attr('data-schoolId');
            if($("#listing").hasClass("list-view")){
            	loadMore.pageViewType = "list";
            }
            loadMore.checkImagePreset();
	          if (window.richSortProvider === 'SlickStitch') {
			          loadMore.maxCount = loadMore.getSchoolProductCount();
			      }

            if (typeof window.currentPageType === 'string' && window.currentPageType !== '') {
              loadMore.currentPageType = utils.removeSpaces(window.currentPageType);
            }
        },
        getParametersForBackend: function () {
              var urlParams = utils.getURLParams(),
                catId = urlParams.catId,
                clrAll = urlParams.clrAll,
                featureTileCount = 0 + $('#listing .feature-tile').last().data('count'),
                featureTileRowCount = $('#listing .featureTiledata-variables').last().data('rowcount'),
                featureTileBlock = $('#listing .featureTiledata-variables').last().data('featuretileblock'),
                hasFTTemplate = $('#listing .featureTiledata-variables').last().data('hasfeaturetiletemplate'),
                myData = '',
                priceRange = urlParams.range,
                productPresetCount_FT = $('#listing .featureTiledata-variables').last().data('productpresetcount'),
                searchQuery = urlParams.searchquery,
                skuListHash = '';
                sSKUList =''
                sortBy = urlParams.sortBy,
                tileCountInRequest_FT = $('#listing .featureTiledata-variables').last().data('tilecountinrequest');

            var findListPattern = new RegExp("/list/");

            if (catId === undefined && loadMore.endecaId !== undefined && loadMore.endecaId) {
                catId = loadMore.endecaId;
            }
            if (searchQuery == null) {
                searchQuery = '';
            }
            if (loadMore.offset == null) {
                loadMore.offset = 0;
            }
            if (sortBy == undefined && loadMore.selectedSortOption !== undefined && loadMore.selectedSortOption) {
                sortBy = loadMore.selectedSortOption;
            }
            if (sortBy == undefined) {
                sortBy = '';
            }
            if (myData.indexOf('&clrAll=true') != -1) {
                myData = myData.replace('&clrAll=true', '');
            }
            if (myData.indexOf('clrAll') == -1 && clrAll) {
                myData = myData + '&clrAll=' + clrAll;
            }
            if ($('#listing .featureTiledata-variables').length) {
                myData = '&view=grid&catId=' + catId + '&sortBy=' + sortBy + '&searchquery=' + searchQuery + '&offset=' + loadMore.offset + '&featureTileCount=' + tileCountInRequest_FT + '&lazyload=true&featuretileblock=' + featureTileBlock + '&rowNumber=' + featureTileRowCount + '&productPresetCount=' + productPresetCount_FT + '&tileCountInRequest=' + tileCountInRequest_FT + '&hasFTTemplate=' + hasFTTemplate + '&test=' + tileCountInRequest_FT;
            } else {
                myData = '&view=grid&catId=' + catId + '&sortBy=' + sortBy + '&searchquery=' + searchQuery + '&offset=' + loadMore.offset + '&lazyload=true';
            }
            if (loadMore.eventId !== undefined && loadMore.eventId) {
                myData = myData + '&eventId=' + loadMore.eventId;
            }
            if (loadMore.sellerId !== undefined && loadMore.sellerId) {
                myData = myData + '&sellerId=' + loadMore.sellerId;
            }
            if (loadMore.promoId !== undefined && loadMore.promoId) {
                myData = myData + '&promoId=' + loadMore.promoId;
            }
            if (loadMore.promoBucketId !== undefined && loadMore.promoBucketId) {
                myData = myData + '&promoBucketId=' + loadMore.promoBucketId;
            }
            if (loadMore.modifySearchQuery !== undefined && loadMore.modifySearchQuery) {
                myData = myData + '&modifySearchQuery=' + loadMore.modifySearchQuery;
            }
            if (priceRange !== undefined && priceRange) {
                if (myData.indexOf('range=') != -1) {
                    myData = loadMore.removeAttr(myData, 'range=');
                }
                myData = myData + '&range=' + priceRange;
            }
            if (findListPattern.test(window.location.href) && myData.indexOf('isListPage') == -1) {
                myData = myData + '&isListPage=true';
            }       

            if (loadMore.imagePreset !== null) {
                myData = myData + '&imagePreset=' + loadMore.imagePreset;
            }

            if (loadMore.oRichSort instanceof RichSort) {
      				sSKUList = loadMore.oRichSort.getSKUs(loadMore.offset);
              if (sSKUList !== '') {
                skuListHash = fn.hashValue(sSKUList);
                if (loadMore.schoolskuList !== undefined && loadMore.schoolskuList) {
        					 myData += '&schoolskuList=' + sSKUList;
                   myData += '&schoolskuListHash=' + skuListHash;
      				  } else {
                  myData += '&skulist=' + sSKUList;
        					myData += '&skulistHash=' + skuListHash;
      				  }
      				}
      			} else if (loadMore.schoolskuList !== undefined && loadMore.schoolskuList) {
      				myData += '&schoolskuList=' + loadMore.schoolskuList;
              myData += '&schoolskuListHash=' + fn.hashValue(loadMore.schoolskuList);
      			}

            if (loadMore.schoolId !== undefined && loadMore.schoolId) {
                myData = myData + '&schoolId=' + loadMore.schoolId;
            }

            if (loadMore.currentPageType) {
              myData = myData + '&currentPageType=' + loadMore.currentPageType;
            }

            return myData+'&pageViewType='+loadMore.pageViewType;
        },
        getParametersForAsyncBrowse: function (urlforBackend, showFilters) {
            var urlParams = utils.getURLParams(urlforBackend),
                myData = $.param(urlParams, true);
            myData = decodeURIComponent(myData),
            searchQuery = urlParams.searchquery,
            priceRange = urlParams.range,
            catId = urlParams.catId,
            sortBy = urlParams.sortBy,
            clrAll = urlParams.clrAll,
            currentPageType = urlParams.currentPageType || null,
            featureTileCount = 0 + $('#listing .feature-tile').last().data('count'),
            featureTileRowCount = $('#listing .featureTiledata-variables').last().data('rowcount'),
            featureTileBlock = $('#listing .featureTiledata-variables').last().data('featuretileblock'),
            productPresetCount_FT = $('#listing .featureTiledata-variables').last().data('productpresetcount'),
            tileCountInRequest_FT = $('#listing .featureTiledata-variables').last().data('tilecountinrequest'),
            hasFTTemplate = $('#listing .featureTiledata-variables').last().data('hasfeaturetiletemplate'),
            loadMoreTile = false;
            var findListPattern = new RegExp("/list/");

            // Destroy Rich sort when any filters are applied.
            if (window.richSortProvider !== 'SlickStitch') {
              loadMore.oRichSort = null;
              loadMore.bRichSortDestroyed = true;              
            }

            if (myData.indexOf('responseToRender') == -1) {
                myData = myData + '&responseToRender=' + showFilters;
            }
            if (searchQuery == null) {
                searchQuery = '';
            }
            if (sortBy == undefined && loadMore.selectedSortOption !== undefined && loadMore.selectedSortOption) {
                sortBy = loadMore.selectedSortOption;
            }
            if ($('#pageType').length && $('#pageType').val() !== undefined) {
                myData = myData + '&pageType=' + $('#pageType').val();
            }
            if (myData.indexOf('sortBy') == -1 && sortBy != undefined) {
                myData = myData + '&sortBy=' + sortBy;
            }
            if (myData.indexOf('&clrAll=true') != -1) {
                myData = myData.replace('&clrAll=true', '');
            }
            if (myData.indexOf('clrAll') == -1 && clrAll) {
                myData = myData + '&clrAll=' + clrAll;
            }
            if ($('#listing .featureTiledata-variables').length) {
                if (myData.indexOf('&offset=') == -1) {
                    myData = myData + '&offset=' + loadMore.offset;
                }
                if (myData.indexOf('&featuretileblock=') == -1) {
                    myData = myData + '&featuretileblock=' + featureTileBlock;
                }
                if (myData.indexOf('&hasFTTemplate=') == -1) {
                    myData = myData + '&hasFTTemplate=' + hasFTTemplate;
                }
            } else {
                if (showFilters !== "LHN") {
                    myData = myData + '&offset=' + loadMore.offset;
                } else {
                    myData = myData;
                }
            }
            if (catId === undefined && loadMore.endecaId !== undefined && loadMore.endecaId) {
                catId = loadMore.endecaId;
                myData = myData + '&catId=' + catId;
            }
            if (loadMore.eventId !== undefined && loadMore.eventId) {
                myData = myData + '&eventId=' + loadMore.eventId;
            }
            if (loadMore.sellerId !== undefined && loadMore.sellerId) {
                myData = myData + '&sellerId=' + loadMore.sellerId;
            }
            if (loadMore.promoId !== undefined && loadMore.promoId) {
                myData = myData + '&promoId=' + loadMore.promoId;
            }
            if (loadMore.promoBucketId !== undefined && loadMore.promoBucketId) {
                myData = myData + '&promoBucketId=' + loadMore.promoBucketId;
            }
            if (loadMore.modifySearchQuery !== undefined && loadMore.modifySearchQuery) {
                myData = myData + '&modifySearchQuery=' + loadMore.modifySearchQuery;
            }
            if (priceRange !== undefined && priceRange) {
                if (myData.indexOf('range=') != -1) {
                    myData = loadMore.removeAttr(myData, 'range=');
                }
                myData = myData + '&range=' + priceRange;
            }
            if ($('.load-more-tile').length == 0) {
                loadMoreTile = true;
                myData = myData + '&loadMoreTile=' + loadMoreTile;
            } else {
                loadMoreTile = false;
                myData = myData + '&loadMoreTile=' + loadMoreTile;
            }
            if (findListPattern.test(window.location.href) && myData.indexOf('isListPage') == -1) {
                myData = myData + '&isListPage=true';
            }

            if (loadMore.imagePreset !== null) {
                myData = myData + '&imagePreset=' + loadMore.imagePreset;
            }
            if (loadMore.schoolskuList !== undefined && loadMore.schoolskuList) {
                myData = myData + '&schoolskuList=' + loadMore.schoolskuList;
                myData = myData + '&schoolskuListHash=' + fn.hashValue(loadMore.schoolskuList);
            }
            if (loadMore.schoolId !== undefined && loadMore.schoolId) {
                myData = myData + '&schoolId=' + loadMore.schoolId;
            }

            if (currentPageType === null && loadMore.currentPageType) {
              myData = myData + '&currentPageType=' + loadMore.currentPageType;
            }

            return myData+'&pageViewType='+loadMore.pageViewType;
        },
        removeAttr: function (myData, param) {
            var splitData = myData.split('&');
            var newData = '';
            for (var i = 0; i < splitData.length; i++) {
                if (splitData[i].indexOf(param) == -1) {
                    newData += splitData[i];
                    if (i != splitData.length - 1) {
                        newData += '&';
                    }
                }
            }
            return newData;
        },
        productBookmarkEvent: function (e, bAddToCompare) {
            //Created this as function because we need to invoke it from another event which prevents bubbling, therefore not triggering.
            var self = this,
                $elem = $(e.target).closest('.product-tile'),
                pgNum = $elem.data('pg'),
                elemId = $elem.prop('id'),
                mySplitResult = window.location.href.split('#'),
                $elemThumbnail = $elem.find('a.thumbnail'),
                hashURL = "#prevTile=" + elemId + "&pg=" + pgNum,
                paginationData = this.createPaginationData(hashURL);

            // No need to bookmark page 1 results
            if (parseInt(pgNum) > 1) {
                self.modifyURL(paginationData);
            } else if (self.$listing.is('.product-carousel') || bAddToCompare || pgNum === 1) {
                hashURL = "#prevTile=" + elemId;
                paginationData = this.createPaginationData(hashURL);
                self.modifyURL(paginationData);
            }

        },
        createPaginationData: function (hashURL) {
          return {
            url: window.location.href,
            pageElem: hashURL
          }
        },
        bindPaginationDestroyer: function () {
          var _this = this;

          $(window).on('loadmore.destroyPaginationData', function (e) {
            _this.clearSessionData(_this.sInfinityBrowseURLParams);
          });
        },
        bindProductBookmark: function () {
          var self = this;

          $('.products-wrapper').on("click", "a", function (e) {
            if (e && e.target) {
              if ($(e.target).
                parents('.add-to-compare, .button-container, .product-load-more, div.store-stock-check-plp').length) {
                return;
              } else {
                self.productBookmarkEvent(e);
                e.stopPropagation();
                try {
                  spindrift.setTrackingCookie(e);
                } catch (e) {}
              }
            }
          });
        },
        modifyURL: function (paginationData) {
            var sessionURLParams = fn.getSessionData(loadMore.sInfinityBrowseURLParams);

            sessionURLParams = sessionURLParams || '';
            fn.setSessionData(loadMore.sInfinityBrowseURLParams, paginationData);
        },
        carousel: null,
        bookmarkExecution: function() {
            var oPhantomElementProps = {};
            loadMore.ajaxInProgress = true;
            loadMore.currentPage = 0;
            loadMore.upperPage = loadMore.currentPage;
            loadMore.lowerPage = loadMore.currentPage;

            if ($('.load-more-tile').length) {
                oPhantomElementProps.currentTarget = $('.load-more-tile').get(0);
            }

            loadMore.getResults(oPhantomElementProps, function () {
                try {
                    loadMore.nextTrigger = null;
                    loadMore.prevTrigger = null;
                } catch (e) {
                    loadMore.bScrolling = false;
                }
            }, false, true, false, false, true);
        },
        handleBookmark: function (carousel) {
            this.carousel = carousel;
            var self = this,
                sessionURLParams = fn.getSessionData(loadMore.sInfinityBrowseURLParams);

            sessionURLParams = sessionURLParams || '';
            if (sessionURLParams !== '' && sessionURLParams.url === window.location.href) {
              sessionURLParams = sessionURLParams.pageElem;
            } else {
              self.clearSessionData(self.sInfinityBrowseURLParams);
              sessionURLParams = '';
            }
            if (sessionURLParams.indexOf("&pg=") === -1 && this.oRichSort instanceof RichSort) {
                // Page is cachable
                if (window.AsyncBlockController.isCachedPage() && !window.forceRichSortPriorToAsyncBlockCall) {
                    // Check if the AsyncBlockController has already completed
                    if (!window.AsyncBlockController.hasCompleted()) {
                        self.$listing.addClass('IBBookmark');
                        $(window).one('AsyncBlockControllerComplete', function () {
                            if (!loadMore.oRichSort.isAvailable()) {
                                $(window).one('RichSortDataComplete', function (e, oDestroyRichSort) {
                                    if (oDestroyRichSort !== undefined) {
                                        self.oRichSort = null;
                                    }
                                    self.bookmarkExecution();
                                });
                                self.oRichSort.getSKUsFromProviderPub(0);
                            } else {
                                self.bookmarkExecution();
                            }
                        });
                    } else {
                      if (!loadMore.oRichSort.isAvailable()) {
                          $(window).one('RichSortDataComplete', function (e, oDestroyRichSort) {
                              if (oDestroyRichSort !== undefined) {
                                  self.oRichSort = null;
                              }
                              self.bookmarkExecution();
                          });
                          this.oRichSort.getSKUs(0);
                      } else {
                          self.bookmarkExecution();
                      }
                    }
                } else {
                    if (!loadMore.oRichSort.isAvailable()) {
                        $(window).one('RichSortDataComplete', function (e, oDestroyRichSort) {
                            if (oDestroyRichSort !== undefined) {
                                self.oRichSort = null;
                            }
                            self.bookmarkExecution();
                        });
                        this.oRichSort.getSKUs(0);
                    } else {
                        self.bookmarkExecution();
                    }
                }
                return;
            }

            if (sessionURLParams.indexOf("&pg=") >= 0 ) {
                loadMore.pageLoadedWithBookmark = true;
                var aURLParams = utils.getURLParams(sessionURLParams);
                var elemId = aURLParams['prevTile'];

                loadMore.nextTrigger = 99999;
                loadMore.prevTrigger = 0;

                // Bookmark does not require Infinity browse call
                if (elemId === '') {
                    if (this.$listing.is('.product-carousel')) {
                        carousel.listingCarousel.moveToProduct(elemId);
                        loadMore.getNextPageIfRequired(carousel);
                    }
                } else {
                    loadMore.ajaxInProgress = true;
                    var pgNum = aURLParams['pg'];
                    loadMore.currentPage = pgNum - 1;
                    loadMore.upperPage = loadMore.currentPage;
                    loadMore.lowerPage = loadMore.currentPage;

                    var e = {};

                    var bIsProductCarousel = this.$listing.is('.product-carousel');

                    if (bIsProductCarousel) {
                        e = carousel;
                    } else {
                        e.currentTarget = $('.load-more-tile').get(0);
                    }

                    loadMore.getResults(e, function () {
                        // Scroll to product tile
                        if (loadMore.$listing.is('.product-carousel')) {
                            carousel.listingCarousel.moveToProduct(elemId);
                            if (loadMore.currentPage !== 1) {
                                carousel.listingCarousel.enablePrevButton();
                            }
                        } else {
                            try {
                                loadMore.nextTrigger = null;
                                loadMore.prevTrigger = null;
                                if (loadMore.$listing.hasClass('list-view')) {
                                    loadMore.scrollToProduct($('#' + elemId));
                                    loadMore.clearSessionData(loadMore.sInfinityBrowseURLParams);
                                } else {
                                    $(window).on('productTilesAdjusted', function (E) {
                                        loadMore.scrollToProduct($('#' + elemId));
                                        $(this).off(E);
                                        loadMore.clearSessionData(loadMore.sInfinityBrowseURLParams);
                                    });
                                }
                            } catch (e) {
                                loadMore.bScrolling = false;
                            }
                        }
                        if (bIsProductCarousel) {
                            loadMore.getNextPageIfRequired(carousel);
                        }
                    }, false, true, false, false, true);
                }

            } else if (sessionURLParams.indexOf("prevTile=") >= 0) {
                var aURLParams = utils.getURLParams(sessionURLParams);
                var elemId = aURLParams['prevTile'];
                loadMore.scrollToProduct($('#' + elemId));
                loadMore.clearSessionData(loadMore.sInfinityBrowseURLParams);
            }
        },
        getNextPageIfRequired: function (carousel) {
            var currentNumberOfTiles = this.$listing.find(".products li").not("li li").not('.feature-tile').not('.loadingBar').length,
                isUnderMaxCount = currentNumberOfTiles < $('#listing').attr('data-maxcount');

            if ((currentNumberOfTiles < (12 * (carousel.listingCarousel.activePanel + 1))) && isUnderMaxCount) {
                this.getResults(carousel, null, false, false, true, true);
            }
        },
        createProductHolder: function (bPrevious, bFromBookmark, offset) {
            var myUniqueID = utils.generateUniqueID();
            var $loaderContainer = $('<li id="' + myUniqueID + '" class="loadingBar"><span>Loading new products...</span>');
            if (offset === 0) {
                $loaderContainer = $('<li id="' + myUniqueID + '" class="loadingBar hidden"><span></span>');
            }
            if (bFromBookmark || bPrevious) {
                $loaderContainer.addClass('fromBookmark');
            }
            bPrevious === true || bFromBookmark ? $(this.$listing.find('.products')).prepend($loaderContainer) : $(this.$listing.find('.products > li:last-child')).after($loaderContainer);
            return myUniqueID;
        },
        getProductsPerRow: function () {
            if (breakpoint.mobile) {
                return 2;
            } else if (breakpoint.largeDesktop || breakpoint.desktop) {
                return 5;
            } else {
                return 3;
            }
        },
        handleNextPrevButtons: function (bIsPrevious, bFromBookmark, bIsInit) {
            // Only handle "previous" button when the page loaded with a bookmark
            if (loadMore.pageLoadedWithBookmark) {
                if (this.currentPage === 0) {
                    this.$prevButton.hide();
                    this.prevButtonVisible = false;
                    // User has been to the first page, "previous" button will never need to be shown again
                    loadMore.pageLoadedWithBookmark = false;
                } else {
                    if (loadMore.disableMobileScrolling) {
                        this.$prevButton.show();
                        this.prevButtonVisible = true;
                    }
                }

            }

            if (this.currentPage === this.totalNoOfPages()) {
                this.$nextButton.hide();
                this.nextButtonVisible = false;
            } else {
                if (this.$listingChildren.last().data('pg') % this.segmentCount === 0) {
                    this.$nextButton.show();
                    this.nextButtonVisible = true;
                }
            }

            /*
             * Needs to removed as it is a "product tile", so it needs to be re-positioned everytime there are more products
             * added to the grid to the bottom
             */
            if ((!bIsPrevious || bFromBookmark) && !bIsInit) {
                //this.$nextButton.remove();
                this.$nextButton.hide();
                this.nextButtonVisible = false;
            }

        },
        appendNextButton: function (bIsPrevious, bFromBookmark) {
            if (this.currentPage !== this.totalNoOfPages()) {
                if (!bIsPrevious || bFromBookmark) {
                    this.$nextButton.removeClass('ajaxLoader');
                    this.$nextButton.show();
                    this.$nextButton.css('display', 'list-item');
                    this.$listing.find('.products > li:last-child').not('.load-more-tile').after(this.$nextButton);
                }
                if (this.currentPage > this.totalNoOfPages()) {
                    this.$nextButton.hide();
                    this.nextButtonVisible = false;
                    $('.loadingBar').hide();
                }
                if (bIsPrevious) {
                    this.$nextButton.removeClass('ajaxLoader');
                }
            }
        },
        hideNextPrevButtons: function () {
            this.$prevButton.hide();
            this.prevButtonVisible = false;
            this.$nextButton.hide();
            this.nextButtonVisible = false;
        },
        getResults: function (e, callback, bIsPrevious, bEmptyBefore, bHideLoader, bFromSamePageBookmark, bFromBookmark, showFilters, sortProducts, urlforBackend) {
            var self = loadMore;
            var request = 'getProducts';
            if (showFilters || sortProducts) {
                request = 'getProductsAndFilters';
                self.bScrolling = true;
            }
            var $form = '';
            var $elem = '';
            var myData = '';
            var DL = new data.DataLayer({
                singleton: true
            });
            var tempProductContainer;
            var $loadmoreButton;
            var urlToBepassed;
            var dataSent;
            var $elemNew = utils.getFormByElement(e.target);
            var priceRange = $('#priceRangeAction');
            var isInfiniteBrowse = !showFilters && !sortProducts;
            if (priceRange.length > 0) {
                var priceRangeForm = priceRange.val();
            }

            //getting the repective URL based on action
            if (!window.isKiosk()) {
                if ($elemNew && $elemNew.is('form#frmTest')) {
                    $form = '';
                } else {
                    $form = utils.getFormByElement(e.target);
                }
            } else {
                $form = '';
            }
            var url = data.Utils.getAction(request, $form);
            if (showFilters !== 'LHN') {
                self.hideNextPrevButtons();
            }

            if (bIsPrevious) {
                loadMore.currentPage = loadMore.lowerPage;
                loadMore.lowerPage--;
                self.offset = ((self.currentPage - 1) * self.maxProductsPerPage) > 0 ? ((self.currentPage - 1) * self.maxProductsPerPage) : 0;
            } else if (showFilters && showFilters !== "LHN") {
                loadMore.currentPage = 1;
                loadMore.upperPage = 1;
                loadMore.lowerPage = 0;
                self.offset = 0;
                self.getfilters = true;

            } else if (sortProducts) {
                loadMore.currentPage = 1;
                loadMore.upperPage = 1;
                loadMore.lowerPage = 0;
                self.offset = 0;
                self.getfilters = false;
            } else {
                if (showFilters !== "LHN") {
                    loadMore.currentPage = loadMore.upperPage;
                    loadMore.upperPage++;
                    self.offset = self.calculateOffset();
                    self.getfilters = false;
                }
            }

            if (showFilters || sortProducts) {
                myData = loadMore.getParametersForAsyncBrowse(urlforBackend, showFilters);
            } else {
                myData = loadMore.getParametersForBackend();
            }

            if (bEmptyBefore) {
                if (showFilters !== "LHN") {
                    $('#listing .products > li').hide();
                }
            }

            if (!loadMore.bIsCarousel) {
                if (showFilters !== "LHN") {
                    tempProductContainer = self.createProductHolder(bIsPrevious, bFromBookmark, self.offset);
                }
            }

            if (!window.isKiosk() && $elemNew.is('form#price-range')) {
                urlToBepassed = priceRangeForm;
                if ($('#listing .featureTiledata-variables').length) {
                    urlforBackend = urlforBackend + '&offset=' + loadMore.offset;
                    urlforBackend = urlforBackend + '&featuretileblock=' + featureTileBlock;
                    urlforBackend = urlforBackend + '&hasFTTemplate=' + hasFTTemplate;
                }
                if ($('#pageType').length && $('#pageType').val() !== undefined) {
                    urlforBackend = urlforBackend + '&pageType=' + $('#pageType').val();
                }
                dataSent = urlforBackend + "&responseToRender=ALL";
            } else {
                myData = loadMore.removeAttr(myData, 'Ntt=');
                if (loadMore.schoolskuList) {
                  urlToBepassed = url + '?' + loadMore.removeAttr(myData, 'schoolskuList=');
                } else {
                  urlToBepassed = url + '?' + loadMore.removeAttr(myData, 'skulist=');
                }
                dataSent = myData;
            }
            DL.get(urlToBepassed, dataSent, $elem, null, request, function (data) {

                var $productdata = '',
                    $filterdata = '',
                    $totalProductsCount = '';

                if (data.productContent) {
                    $productdata = $(data.productContent.products);
                } else {
                    $productdata = $(data.products);
                }

                if (data.leftNavigation) {
                    if (data.leftNavigation.dimensions.dimensionContainer != "") {
                        $filterdata = $.parseJSON(data.leftNavigation.dimensions.dimensionContainer);
                    }
                }
                if (data.totalProductsCount) {
                    $totalProductsCount = data.totalProductsCount;
                }

                if (data.productContent || data.products) {
                    self.initVariantsData(data);
                }

                if (bIsPrevious) {
                    if (self.currentPage !== 0) {
                        self.currentPage--;
                    }
                } else if (sortProducts || showFilters) {
                    if (showFilters !== "LHN") {
                        self.currentPage = 1
                    }
                } else {
                    if (showFilters !== "LHN") {
                        self.currentPage++;
                    }
                }

                if (bEmptyBefore && showFilters !== "LHN") {
                    $('#listing .products li').not('.load-more-tile').not('.loadingBar').remove();
                }

                if (bFromBookmark) {
                    self.$listing.removeClass('IBBookmark');
                }


                var caro = loadMore.carousel;

                data.showFilters = showFilters;

                if (self.$listing.is('.product-carousel')) {
                    if (caro.listingCarousel !== undefined) {

                        if (tempProductContainer) {
                            $('#' + tempProductContainer).replaceWith($productdata);

                        } else {

                            $('#listing .products').append($productdata);
                        }
                        if (showFilters) {
                            caro.listingCarousel.activePanel = 0;
                        }

                        if (!bFromSamePageBookmark) {
                            caro.listingCarousel.kioskListingLayout(true);
                        } else {
                            caro.listingCarousel.kioskListingLayout(false);
                            caro.listingCarousel.checkNav();
                        }
                        if ($('.product-tile').length) {
                            $('.products-wrapper li.product-tile').eq(0).addClass('nth-child-1');
                            $('.products-wrapper li.product-tile').eq(1).addClass('nth-child-2');
                        }

                        productTile.Ellipsis.init($productdata);
                        productTile.checkFrom($productdata);

                        if (window.isKiosk()) {
                            caro.priceFontSize();
                        }
                    }
                } else {
                    if (showFilters === "LHN") {
                        data.showFilters = showFilters;
                    } else {
                        $('#listing .products li.featureTiledata-variables').remove();

                        if (showFilters) {
                            $('#' + tempProductContainer).empty().replaceWith($productdata);
                            data.showFilters = showFilters;
                        } else {
                            $('#' + tempProductContainer).empty().replaceWith($productdata);
                        }

                        self.$listingChildren = $('#listing').find('.products > li').not('.load-more-tile, .featureTiledata-variables');
                        self.handleNextPrevButtons(bIsPrevious, bFromBookmark);
                        var oTemp = {};
                        if (bIsPrevious) {
                            oTemp = {
                                'isPrevious': true
                            };

                            $(window).on('productTilesAdjusted', function (e) {
                                $(this).off(e);
                            });

                        } else {
                            oTemp = {
                                'isPrevious': false
                            };
                        }

                        productTile.Height.adjust($('#listing'), productTile.Ellipsis.init, bIsPrevious, oTemp);

                        self.showTile(self.viewport);
                        self.appendNextButton(bIsPrevious);
                        //productTile.Ellipsis.init($data);
                    }
                }

                if (showFilters !== "LHN") {
                    self.removeDisabledState();
                    colourSwatch.init();
                    picturefill();
                    if ($.isFunction(callback)) {

                        if (data["historyUrl"] !== undefined) {
                            urlforBackend = data.historyUrl;
                        }
                        callback(urlforBackend, data);
                    }
                    loadMore.ajaxInProgress = false;
                    if ($('.product-tile').length) {
                        $('#listing .products li.product-tile').removeClass('nth-child-even, nth-child-odd');
                        $('#listing .products li.product-tile:even').addClass('nth-child-odd');
                        $('#listing .products li.product-tile:odd').addClass('nth-child-even');

                    }

                    if (showFilters || sortProducts) {
                        loadMore.init();
                        if (!breakpoint.kiosk) $('html, body').animate({
                            scrollTop: $("#listing").offset().top
                        }, '600');
                        setTimeout(function () {
                            self.bScrolling = false;
                        }, 250);
                    }
                } else {
                    loadMore.init();
                    if (!breakpoint.kiosk) $('html, body').animate({
                        scrollTop: $("#listing").offset().top
                    }, '600');
                    setTimeout(function () {
                        self.bScrolling = false;
                    }, 250);
                    if ($.isFunction(callback)) {

                        if (data["historyUrl"] !== undefined) {
                            urlforBackend = data.historyUrl;
                        }
                        callback(urlforBackend, data);
                    }
                }

                if (isInfiniteBrowse && data.analytics) {
                    self.submitWebAnalytics(data.analytics);
                }
            }, function () {
                //console.log('failed to retrieve data');
            });
        },
        removeDisabledState: function () {
            if ($('.add-to-basket[disabled]').length) {
                $('.add-to-basket').removeAttr('disabled');
            }
        },
        initVariantsData: function (data) {
            // Init variants data
            if (window.Data.PLP) {

                var $jsonResp;
                if (data.productContent) {
                    if (data.productContent.variants !== '') {
                        $jsonResp = $.parseJSON(data.productContent.variants);
                    }
                } else {
                    if (data.variants !== '') {
                        $jsonResp = $.parseJSON(data.variants);
                    }
                }

                if ($jsonResp) {
                    $.extend(window.Data.PLP.Data, $jsonResp);
                }
            }
        },
        decideIfUserIsTriggering: function () {
            var iRow = loadMore.triggerPoints[breakpoint.currentViewport];
            if (loadMore.nextTrigger === null) {
                var productsPerRow = loadMore.getProductsPerRow();
                var totalRowCount = Math.ceil(loadMore.$listingChildren.length / productsPerRow);
                if (totalRowCount > iRow) {
                    loadMore.nextTrigger = loadMore.$listingChildren.eq(((totalRowCount - iRow) * productsPerRow) - 1).offset().top;
                    loadMore.prevTrigger = loadMore.$listingChildren.first().offset().top + loadMore.$listingChildren.first().height();
                } else if (totalRowCount <= iRow) {
                    loadMore.nextTrigger = 99999;
                    loadMore.prevTrigger = loadMore.$listingChildren.first().offset().top + loadMore.$listingChildren.first().height();
                }
            }
            var scrollTop = $(window).scrollTop();
            if (scrollTop > loadMore.nextTrigger) {
                return 'next';
            } else if (scrollTop < loadMore.prevTrigger) {
                return 'prev';
            } else {
                return '';
            }
        },
        findFirstProductInViewport: function () {
            var $elem = '';
            $.each(loadMore.$listing.find('.product'), function (i, e) {
                if (common.isElementInViewport(e, 100)) {
                    $elem = $(e);
                    return false;
                }
            });

            return $elem;
        },
        scrollToProduct: function ($element) {
            var $masthead = $('#masthead-wrapper'),
            	iMastheadHeight = $masthead.data('outerHeight'),
                iOffSet = 0;

            loadMore.bScrolling = true;

            if ($element.length > 0) {
                iOffSet = $element.offset().top;
            }

            if ($masthead.length > 0) {
                iOffSet = iOffSet - iMastheadHeight;
            }

            $('html, body').animate({
                scrollTop: iOffSet
            }, function () {
                loadMore.bScrolling = false;
            });
        },

        checkImagePreset: function () {
            var aClassList = [],
                i = 0,
                j = 0;

            if (loadMore.$listing.length) {
                aClassList = document.getElementById('listing').className.split(/\s+/);
                loadMore.compareArrays(aClassList, loadMore.aImagePresetNames);
            }
        },

        compareArrays: function (aArraySource, aArrayTarget) {
            if (!aArraySource || !aArrayTarget) {
                return false;
            }

            for (i in aArraySource) {
                for (j in aArrayTarget) {
                    if (aArraySource[i] === aArrayTarget[j]) {
                        loadMore.imagePreset = aArraySource[i];
                        return;
                    }
                }
            }
        },

        bindWindowScroll: function () {
            var self = loadMore;
            // Only bind scroll event if we have more than one page of results
            if (self.totalNoOfPages() !== 1 && !self.disableMobileScrolling) {
                $(window).on('scroll touchmove', function (e) {
                    if (!self.bScrolling) {
                        self.bScrolling = true;
                        if (!self.nextButtonVisible || !self.prevButtonVisible) {
                            if (!self.ajaxInProgress) {
                                var whatToTrigger = self.decideIfUserIsTriggering();

                                if (whatToTrigger === 'next' && !self.nextButtonVisible && parseInt($('#listing').attr('data-maxcount')) !== 0) {
                                    self.nextTrigger = null;
                                    self.prevTrigger = null;

                                    var pageOffset = self.$listingChildren.last().data('pg');
                                    var bShowMore = (pageOffset * self.maxProductsPerPage);

                                    if (bShowMore < self.maxCount) {
                                        if (pageOffset % self.segmentCount === 0) {
                                            self.$nextButton.show();
                                            self.nextButtonVisible = true;
                                        } else {
                                            self.ajaxInProgress = true;
                                            self.fetchNextPage(window);
                                        }
                                    }
                                } else if (whatToTrigger === 'prev' && !self.prevButtonVisible && parseInt($('#listing').attr('data-maxcount')) !== 0) {
                                    self.nextTrigger = null;
                                    self.prevTrigger = null;
                                    whatToTrigger = null;
                                    var pageShown = self.$listingChildren.first().data('pg');
                                    if (pageShown !== 1) {
                                        if ((pageShown - 1) % self.segmentCount === 0) {
                                            self.$prevButton.show();
                                            self.prevButtonVisible = true;
                                        } else {
                                            self.ajaxInProgress = true;
                                            self.fetchPrevPage(window);
                                        }
                                    }
                                }
                            }
                        }
                        self.bScrolling = false;
                    }
                });
            }
        },

        clearSessionData: function (key) {
            if (key !== undefined && typeof key === 'string') {
                fn.clearSessionData(key);
            }
        },
		getSchoolProductCount: function getSchoolProductCount() {
		  var productIds = [];

		  if ($('.products-wrapper').length
			&& $('.products-wrapper').data('schoolskulist') !== undefined) {
			productIds = $('.products-wrapper').data('schoolskulist').split(',');
			// Needing to do this as
			$('#listing').attr('data-maxcount', productIds.length);
			return productIds.length;
		  }
		  return loadMore.maxCount;
		},

        submitWebAnalytics: function submitWebAnalytics(analyticData) {
            var oAnalytics = null, 
                oWebAnalytics = null;

            if (analyticData) {
                oAnalytics = analyticData;

                if (Array.isArray(analyticData)) {
                    oAnalytics = analyticData[0];
                }
            }
            
            if (oAnalytics) {
                oWebAnalytics = new analytics.WebMetrics();
                oWebAnalytics.submit([oAnalytics]);
            }
        },

        isLoadedWithBookmark: function isLoadedWithBookmark() {
            return this.pageLoadedWithBookmark;
        }
    };

    common.init.push(loadMore.init);

    return loadMore;
});
/*jslint plusplus: true*/
define('modules/pagination/pagination', [], function () {
    'use strict';

    function Pagination(oCollection) {
        this.oCollection = oCollection;

        var defOpts = {
            sHeaderSelector: ".products-header",
            sPaginationClass: "pagination",
            sPageSelector: ".pagination li",
            sPageClass: "nav-dot",
            sSelectedPageClass: "selected",
            sPageButtonClass: "dot-action"
        };

        this.options = $.extend({}, defOpts, this.oCollection.options.oPaginationOptions);
    }

    Pagination.prototype = {
        constructor: Pagination,

        bindEvents: function bindEvents() {
            var self = this;

            if (self.$paginationElement) {
                self.$paginationElement.on('click', this.options.sPageSelector, self.pageClickHandler.bind(self));
            }
        },

        pageClickHandler: function pageClickHandler(e) {
            var sSelectedPageIndex = $(e.currentTarget).attr("data-index"),
                iSelectedPageIndex = parseInt(sSelectedPageIndex, 10);

            if (iSelectedPageIndex >= 0) {
                this.oCollection.moveToPage(iSelectedPageIndex); // move e.g. carousel (then the after move handler will set the current position indicator)
            }
        },

        init: function init() {
            if (this.oCollection) {
                if (this.iNumberOfPageIndicators === this.oCollection.getNumberOfPages()) {
                    return;
                }

                if (this.$paginationElement) {
                    this.removePageIndicatorsFromDOM();
                }
                this.iNumberOfPageIndicators = this.oCollection.getNumberOfPages();

                this.$paginationElement = this.createPageIndicators();

                if (this.$paginationElement) {
                    this.addPageIndicatorsToDOM();
                    this.updateAttributeForNumberOfPages();
                    this.updateSelectedIndicator();
                    this.bindEvents();
                }
            }
        },

        createPageIndicators: function createPageIndicators() {
            var $newPageIndicator,
                $listOfPageIndicators = null,
                i;

            if (this.iNumberOfPageIndicators > 1) {
                $listOfPageIndicators = $(document.createElement("ol"));
                $listOfPageIndicators.addClass(this.options.sPaginationClass);

                for (i = 0; i < this.iNumberOfPageIndicators; i++) {
                    $newPageIndicator = $('<li class="' + this.options.sPageClass + '" data-index="' + i + '"><button class="' + this.options.sPageButtonClass + '"><span class="screen-reader-text">page ' + i + '</span></button></li>"');

                    $listOfPageIndicators.append($newPageIndicator);
                }
            }
            return $listOfPageIndicators;
        },

        addPageIndicatorsToDOM: function addPageIndicatorsToDOM() {
            if (this.oCollection.$element && this.oCollection.$element.length) {
                this.oCollection.$element.find(this.options.sHeaderSelector).append(this.$paginationElement);
            }
        },

        afterMoveHandler:  function afterMoveHandler() {
            this.updateSelectedIndicator();
        },

        getSelectedPageIndex: function getSelectedPageIndex() {
            return this.oCollection.currentPageIndex();
        },

        updateSelectedIndicator: function updateSelectedIndicator() {
            var iCurrentPageIndex = this.getSelectedPageIndex(),
                allPageIndicators;

            if (this.$paginationElement) {
                allPageIndicators = this.$paginationElement.find(this.options.sPageSelector);

                allPageIndicators.removeClass(this.options.sSelectedPageClass);

                allPageIndicators.filter('[data-index="' + iCurrentPageIndex + '"]').addClass(this.options.sSelectedPageClass);
            }
        },
        removePageIndicatorsFromDOM: function removePageIndicatorsFromDOM() {
            this.$paginationElement.remove();
        },
        updateAttributeForNumberOfPages: function updateAttributeForNumberOfPages() {
            if (this.oCollection.$element) {
                this.oCollection.$element.attr("data-items-count", this.iNumberOfPageIndicators);
            }
        }
    };

    return Pagination;
});
/*globals define, $, window */
/*jslint plusplus: true*/
/**
 * A small carousel library for the tesco UI
 * @param element
 * @param opts {
 * nextClass: class name for the next anchor
 * prevClass: class name for the previous anchor
 * itemSelector: class name for the items in the carousel, this is used to calculate the number of visible items
 * wrapperClass: in case a specific class is used to wrap the items, this item will be moved
 * }
 * @constructor
 */
define('modules/responsive-carousel/responsive-carousel',['modules/breakpoint', 'modules/pagination/pagination'], function (breakpoint, Pagination) {
    'use strict';

    var aCarousels = [],
        resizeCarouselHandler = function resizeCarouselHandler() {
            var i = 0;

            for (i = 0; i < aCarousels.length; i++) {
                aCarousels[i].adjust();
            }
        },
        ResCarousel = function ResCarousel(element, opts) {
            var defOpts = {
                nextClass: ".next",
                prevClass: ".previous",
                itemSelector: ".carousel-item",
                itemSelectorActive: "active",
                wrapperClass: false,
                all: true,
                enablePeep: false,
                peepThreshold: 0.2,
                itemWidth: 0,
                scrollLimit: 0,
                centraliseThumbnails: {
                    enabled: false,
                    clickActionCallback: null
                },
                stopOnLastItem: false,
                enableAutoHideArrows: true,
                continuousLoop: false,
                afterMove: false,
                elasticBounceOnEmptySwipe: false,
                iBounceSpeed: 250,
                wiggleStartupCeremony: false,
                iWiggleAnimationDuration: 1000,
                bIncludePagination: false,
                oPaginationOptions: {},
                sHiddenClass: "displayNone",
                bHideNextPreviousIfAllItemsVisible: false,
                bFitsItemWidthsAndPaddingForNumberOfItemsMinusOne: false,
                vertical: false
            },
                self = this;

            this.options = $.extend({}, defOpts, opts);
            this.$element = element;
            this.disableRightArrow = false;
            this.start();
            this.setTriggerStates();
            //this.setResponsiveEvents();
            this.transitioning = false;
            this.bouncing = false;
            this.iBounceDistance = 0;
            this.iTouchStartXCoords = 0;
            this.iTouchEndXCoords = 0;
            this.bWiggleStartupAnimationHasRun = false;
            if (this.options.bIncludePagination) {
                self.oCarouselPagination = new Pagination(self);
                self.oCarouselPagination.init();
            }
            aCarousels.push(this);
        };

    $(window).on('windowResizeEnd.carouselHandler', resizeCarouselHandler);

    ResCarousel.prototype = {
        setup: function setup(args) {
            var argsCopy = args || {},
                carouselItems = [];

            function addDataAtributes(items) {
                var i = 0;

                for (i = 0; i < items.length; i += 1) {
                    $(items[i]).attr('data-index', i);
                }
            }

            carouselItems = this.$element.find(this.options.itemSelector);

            if (typeof this.options.itemWidth === 'function') {
                this.itemWidth = this.options.itemWidth();
            } else {
                this.itemWidth = this.options.itemWidth !== 0 ? this.options.itemWidth : carouselItems.outerWidth(true);
            }

            this.itemHeight = this.options.itemHeight !== 0 ? this.options.itemHeight : carouselItems.outerHeight(true); // Vertical Req
            this.$itemsWrapper = this.options.wrapperClass ? this.$element.find(this.options.wrapperClass) : $(carouselItems.parent());
            this.setVisibleItems(carouselItems);
            this.totalCarouselItems = carouselItems.length;
            this.supportTransitions = window.Modernizr.csstransforms && window.Modernizr.csstransitions ? true : false;
            this.scrollAmount = argsCopy.calcScroll ? this.calcScroll() : this.scrollAmount !== undefined ? this.scrollAmount : 0;
            this.moveBy = this.options.all ? this.visibileItems : 1;    // should the carousel move all items at once or by just 1

            if (this.options.bIncludePagination) {
                this.setNumberOfPages();
                this.setVisibleItemsTo2DecimalPlaces(carouselItems);
            }

            if (this.options.bHideNextPreviousIfAllItemsVisible) {
                this.hideNextPreviousIfAllItemsVisible();
            }

            addDataAtributes(carouselItems);
        },

        bindEvents: function bindEvents() {
            var selfContext = this,
                oCarouselSelectorReference = selfContext.$element[0] || null;

            this.$element.on("click", this.options.prevClass, function (oEvent) {
                oEvent.preventDefault();
                oEvent.stopPropagation();
                if (!selfContext.$prevHandle.hasClass("disabled")) {
                    selfContext.moveLeft();
                }
            });

            this.$element.on("click", this.options.nextClass, function (oEvent) {
                oEvent.preventDefault();
                oEvent.stopPropagation();
                if (!selfContext.$nextHandle.hasClass("disabled")) {
                    selfContext.moveRight();
                }
            });

            if (this.options.centraliseThumbnails && this.options.centraliseThumbnails.enabled) {
                this.$element.on("click", this.options.itemSelector, function (oEvent, oTriggerData) {
                    oTriggerData = oTriggerData || {};
                    selfContext.centraliseActiveItems($(this));
                    if (!oTriggerData.cancelCallback && selfContext.options.centraliseThumbnails.clickActionCallback && typeof selfContext.options.centraliseThumbnails.clickActionCallback === 'function') {
                        selfContext.options.centraliseThumbnails.clickActionCallback(oEvent);
                    }
                    oEvent.stopPropagation();
                });
            }

            //swipe events
            if (!this.options.vertical) {
                this.$itemsWrapper.on("swipeLeft", this.moveRight.bind(this));
                this.$itemsWrapper.on("swipeRight", this.moveLeft.bind(this));
            }

            if (this.isElasticBounceEnabled() === true) {
                this.$itemsWrapper.on("touchstart", function (event) {
                    selfContext.iTouchStartXCoords = event.originalEvent.touches[0].pageX;
                });
                this.$itemsWrapper.on("touchend", function (event) {
                    selfContext.iTouchEndXCoords = event.originalEvent.changedTouches[0].pageX;
                });
            }

            // transition events
            // register click events on the handles
            this.$itemsWrapper.on("transitionend legacytransitionend", function () {
                selfContext.transitioning = false;
                selfContext.setTriggerStates();
            });
            this.$itemsWrapper.on("transitionstart legacytransitionstart", function () {
                selfContext.transitioning = true;
            });

            //scroll events
            if (selfContext.getWiggleStartupCeremonyEnabled()) {
                $(window).scroll(function () {
                    if (selfContext.bWiggleStartupAnimationHasRun === false) {
                        if (oCarouselSelectorReference !== null && window.inVisibleViewport(oCarouselSelectorReference, true, true) === true) {
                            selfContext.wiggleStartupCeremonyHandler();
                        }
                    }
                });
            }


        },
        add: function addCarouselItem(args) {
            var argsCopy = args || {},
                position = argsCopy.position || 'prepend',
                index = 0,
                callback = argsCopy.callback,
                newItem = argsCopy.item,
                $itemsList = this.$itemsWrapper,
                $output = null,
                $addedItem = null;

            if (position === 'prepend') {
                $itemsList.prepend(newItem);
            } else if (position === 'append') {
                $itemsList.append(newItem);
            } else if (typeof position === 'number') {
                index = position - 1;
                $itemsList.find('[data-index="' + index + '"]').before(newItem);
            } else if (typeof position === 'function') {
                $output = $(position($itemsList));

                if ($output.length) {
                    index = $output.data('index');
                    $output.before(newItem);
                }
            }

            this.adjust();

            if (position === 'prepend') {
                $addedItem = $itemsList.children().first();
            } else if (position === 'append') {
                $addedItem = $itemsList.children().last();
            } else if (typeof position === 'number' || typeof position === 'function') {
                $addedItem = $itemsList.find('[data-index="' + index + '"]');
            }

            if (typeof callback === 'function') {
                callback($addedItem);
            }
        },
        remove: function removeCarouselItem(args) {
            var argsCopy = args || {},
                position = argsCopy.position,
                index = 0,
                callback = argsCopy.callback,
                $itemsList = this.$itemsWrapper,
                $output = null;

            if (position === 'first') {
                $itemsList.children().first().remove();
            } else if (position === 'last') {
                $itemsList.children().last().remove();
            } else if (position === 'all') {
                $itemsList.children().remove();
            } else if (typeof position === 'number') {
                index = position - 1;
                $itemsList.find('[data-index="' + index + '"]').remove();
            } else if (typeof position === 'function') {
                $output = $(position($itemsList));

                if ($output.length) {
                    $output.remove();
                }
            }

            this.adjust();

            if (typeof callback === 'function') {
                callback();
            }
        },
        destroy: function destroyCarousel() {
            var i = 0;

            this.$element.data('carousel', null).off();
            this.$itemsWrapper.attr('style', '').off()[0].innerHTML = '';

            for (i = 0; i < aCarousels.length; i += 1) {
                if (aCarousels[i].$element === this.$element) {
                    aCarousels.splice(i, 1);
                }
            }

        },
        calcScroll: function calcScrollAmount() {
            var isNegative = false,
                scrollAmount = 0;

            if (this.scrollAmount === undefined) {
                return scrollAmount;
            }

            if (this.scrollAmount < 0) {
                isNegative = true;
            }

            if (this.visibileItems === 1) {
                scrollAmount = this.options.vertical ? this.itemHeight : this.itemWidth;
            }

            return isNegative ? -scrollAmount : scrollAmount;
        },
        centraliseActiveItems: function centraliseActiveItems($context) {
            if (!isNaN(this.visibileItems) && !$context.hasClass(this.options.itemSelectorActive)) {
                var iMiddleItem = Math.ceil(this.visibileItems / 2),
                    iClickedItem = $context.index() + 1,
                    iMaxLeftValue = iMiddleItem,
                    iMaxRightValue = this.totalItems() - (iMiddleItem - 1),
                    iMoveBy = iMiddleItem - iClickedItem;

                // WHEN user clicks on an item AND it can move to the centre THEN it should scroll it to the centre
                if (iClickedItem >= iMaxLeftValue && iClickedItem <= iMaxRightValue) {
                    this.move(iMoveBy);
                } else {
                    // OTHERWISE it should scroll the last item into view
                    // if (iClickedItem >= iMiddleItem && iClickedItem <= this.totalItems()) {
                    if (iClickedItem >= iMiddleItem && iClickedItem <= this.totalItems() && iClickedItem >= this.visibileItems) {
                        this.move(-1 * (this.totalItems() - this.visibileItems));
                        // OR the first item into view
                    } else {
                        this.move(0);
                    }
                }

                $(this.options.itemSelector, this.$element).removeClass(this.options.itemSelectorActive);
                $context.addClass(this.options.itemSelectorActive);
            }
        },
        // move the carousel by an x amount, the direction is determined by the sign of the number
        move: function move(by, bCalledFromAdjust) {

            this.scrollAmount = this.options.vertical ? by * this.itemHeight : by * this.itemWidth;

            if (this.options.stopOnLastItem) {
                if (this.options.vertical) {
                    this.disableRightArrow = this.scrollAmount <= (-1 * ((this.totalItems() * this.itemHeight) - (this.visibileItems * this.itemHeight))) ? true : false;
                    if (this.scrollAmount <= (-1 * ((this.totalItems() * this.itemHeight) - ((this.visibileItems - 1) * this.itemHeight)))) {
                        return;
                    }
                } else {
                    this.disableRightArrow = this.scrollAmount <= (-1 * ((this.totalItems() * this.itemWidth) - (this.visibileItems * this.itemWidth))) ? true : false;
                    if (this.scrollAmount <= (-1 * ((this.totalItems() * this.itemWidth) - ((this.visibileItems - 1) * this.itemWidth)))) {
                        return;
                    }
                }
            }

            if (this.options.scrollLimit === 0) {
                this.animate(this.scrollAmount);
            } else {
                if (this.scrollAmount > 0) {
                    this.scrollAmount = 0;
                }

                if (this.options.vertical) {
                    if (this.scrollAmount < (-1 * this.options.scrollLimit * this.itemHeight)) {
                        this.scrollAmount = -1 * this.options.scrollLimit * this.itemHeight;
                    }
                } else {
                    if (this.scrollAmount < (-1 * this.options.scrollLimit * this.itemWidth)) {
                        this.scrollAmount = -1 * this.options.scrollLimit * this.itemWidth;
                    }
                }

                this.animate(this.scrollAmount);
            }

            if (this.options.afterMove && typeof this.options.afterMove === 'function') {
                if (!bCalledFromAdjust) {
                    this.options.afterMove(by);
                }
            }

            if (this.options.bIncludePagination) {
                this.oCarouselPagination.afterMoveHandler();
            }
        },
        animate: function animate(iScrollAmount) {
            var selfContext = this;
            if (selfContext.$itemsWrapper.length > 0) {
                if (selfContext.supportTransitions) {
                    if (selfContext.options.vertical) {
                        selfContext.$itemsWrapper.css({
                            transform: 'translate3d(0, ' + iScrollAmount + 'px, 0)'
                        });
                    } else {
                        selfContext.$itemsWrapper.css({
                            transform: 'translate3d(' + iScrollAmount + 'px, 0, 0)'
                        });
                    }
                } else {
                    selfContext.$itemsWrapper.trigger('legacytransitionstart');

                    if (selfContext.options.vertical) {
                        selfContext.$itemsWrapper.animate({
                            top: iScrollAmount
                        }, 100, function () {
                            selfContext.$itemsWrapper.trigger('legacytransitionend');
                        });
                    } else {
                        selfContext.$itemsWrapper.animate({
                            marginLeft: iScrollAmount
                        }, 100, function () {
                            selfContext.$itemsWrapper.trigger('legacytransitionend');
                        });
                    }
                }
            }
        },
        peep: function peep(by) {
            this.animate(this.scrollAmount + parseInt((by * this.itemWidth), 10));
        },
        /*
         returns the current index of the carousel, i.e how much we have moved.
         The sign on the returned value indicates the direction, e.g -10 means we have move
         ten items to the right
         */
        currentIndex: function currentIndex() {
            return this.options.vertical ? Math.round(this.scrollAmount / this.itemHeight) : Math.round(this.scrollAmount / this.itemWidth);
        },
        start: function start() {
            var selfContext = this;

            // this bit is due to our layout, the active classes goes on the parent of the handle element
            // set these before setup because these are used in setup if e.g. bHideNextPreviousIfAllItemsVisible option is true
            this.$nextHandle = $(this.$element.find(this.options.nextClass).parent());
            this.$prevHandle = $(this.$element.find(this.options.prevClass).parent());

            this.setup();
            this.bindEvents();

            if (this.options.enablePeep) {
                this.$nextHandle.mouseenter(function (evt) {
                    if (!selfContext.transitioning && !selfContext.$nextHandle.hasClass("disabled")) {
                        var li = $($(evt.target).parent()).parent();
                        if (!li.hasClass("disabled")) {
                            selfContext.peep(-selfContext.options.peepThreshold);
                        }
                    }
                });
                this.$prevHandle.mouseenter(function (evt) {
                    if (!selfContext.transitioning && !selfContext.$prevHandle.hasClass("disabled")) {
                        var li = $($(evt.target).parent()).parent();
                        if (!li.hasClass("disabled")) {
                            selfContext.peep(selfContext.options.peepThreshold);
                        }
                    }
                });

                this.$prevHandle.mouseleave(this.adjust.bind(this));
                this.$nextHandle.mouseleave(this.adjust.bind(this));
            }
        },
        /*
         This should be called should in case the width of our carousel item changes, e.g an orientation
         change
         */
        adjust: function adjust(opts) {
            this.setup(opts);

            if (this.options.bIncludePagination) {
                if (this.moveToFirstItemInPageRequired()) {
                    this.moveToFirstItemInPage();
                } else {
                    this.move(this.calculateIndexToFitLastItemToRightOfCarouselTo2DecimalPlaces(), true);
                }
                this.reInitialisePagination();
            } else {
                var cIndex = this.currentIndex(),
                    leftOvers = this.totalItems() - Math.abs(cIndex);

                if (leftOvers < this.visibileItems) {
                    this.move(Math.min(cIndex + 1, 0), true);
                } else {
                    this.move(cIndex, true);
                }
            }

            this.setTriggerStates();
        },
        reset: function reset() {
            this.move(0);
        },
        setTriggerStates: function setTriggerStates() {
            if (this.options.enableAutoHideArrows) {
                this.$prevHandle.toggleClass("disabled", this.canMoveRight() || this.isCarouselFull());
                this.$nextHandle.toggleClass("disabled", this.canMoveLeft() || this.isCarouselFull() || this.disableRightArrow || this.moveLeftWouldShowUnwantedWhitespace());
            }
        },
        canMoveLeft: function canMoveLeft() {
            var cIndex = Math.abs(this.currentIndex()),
                totalItems = this.totalItems();

            if (this.options.scrollLimit > 0) {
                totalItems = this.options.scrollLimit + 1;
            }
            return (cIndex + this.moveBy) >= totalItems;
        },
        isCarouselFull: function isCarouselFull() {
            return this.totalItems() < this.visibileItems;
        },
        canMoveRight: function canMoveRight() {
            return this.currentIndex() === 0;
        },
        setResponsiveEvents: function setResponsiveEvents() {
            var adjustFunc = this.adjust.bind(this);

            $(window).resize(function () {
                setTimeout(adjustFunc, 250);
            });
        },
        moveRight: function moveRight() {
            var totalMoved = Math.abs(this.currentIndex()),
                remaining = this.totalItems() - (totalMoved + this.moveBy),
                moveThreshold,
                iElasticBounceDirection = 1;

            if (this.options.bIncludePagination) {
                moveThreshold = this.calculateMoveThresholdForMoveRightWithPagination(remaining);
            } else {
                moveThreshold = this.currentIndex() - Math.min(this.moveBy, remaining);
            }

            if (this.options.continuousLoop && remaining === 0) {
                moveThreshold = 0;
            }

            this.move(moveThreshold);

            if (this.isElasticBounceEnabled() === true && this.$nextHandle.hasClass('disabled')) {
                this.elasticBounceDistanceHandler();
                this.elasticBounceHandler(iElasticBounceDirection);
            }
        },
        moveLeft: function moveLeft() {
            var moveThreshold = Math.min(this.currentIndex() + this.moveBy, 0),
                iPreviousSlideCurrentIndex = this.currentIndex(),
                iElasticBounceDirection = 0;

            if (this.options.continuousLoop && this.currentIndex() === moveThreshold) {
                moveThreshold = this.totalItems() - 1;
                moveThreshold = -1 * moveThreshold;
            }

            if (this.moveToFirstItemInLastPage()) {
                moveThreshold = this.calculateIndexOfFirstItemInLastPage();
            }

            this.move(moveThreshold);

            if (this.isElasticBounceEnabled() === true && iPreviousSlideCurrentIndex === 0) {
                this.elasticBounceDistanceHandler();
                this.elasticBounceHandler(iElasticBounceDirection);
            }
        },
        totalItems: function totalItems() {
            return this.totalCarouselItems;
        },
        isElasticBounceEnabled: function isElasticBounceEnabled() {
            var bIsElasticBounceEnabled = false;

            if (this.options.elasticBounceOnEmptySwipe === true && this.options.continuousLoop === false && this.supportTransitions) {
                bIsElasticBounceEnabled = true;
            }
            return bIsElasticBounceEnabled;
        },
        elasticBounceHandler: function elasticBounceHandler(iElasticBounceDirection) {
            var selfContext = this,
                iBounceSpeed = selfContext.options.iBounceSpeed || 250;

            if (iElasticBounceDirection === "undefined" || iElasticBounceDirection === undefined) {
                return;
            }
            if (selfContext.$itemsWrapper.length > 0) {
                if (selfContext.getIsCurrentBouncing() === false) {
                    selfContext.setIsCurrentlyBouncing(true);
                    selfContext.elasticBounceOut(iElasticBounceDirection);
                    setTimeout(function elasticBounceReturnBounceHandler() {
                        selfContext.elasticBounceReset();
                        selfContext.setIsCurrentlyBouncing(false);
                    }, iBounceSpeed);
                }
            }
        },
        elasticBounceOut: function elasticBounceOut(iElasticBounceDirection) {
            if (iElasticBounceDirection === "undefined" || iElasticBounceDirection === undefined) {
                return;
            }
            if (iElasticBounceDirection === 1) {
                this.animate((this.scrollAmount - this.getBounceDistance()));
            } else {
                this.animate((this.scrollAmount + this.getBounceDistance()));
            }
        },
        elasticBounceReset: function elasticBounceReset() {
            this.animate(this.scrollAmount);
        },
        setIsCurrentlyBouncing: function setIsCurrentlyBouncing(bCurrentlyBouncing) {
            if (bCurrentlyBouncing !== "undefined" && bCurrentlyBouncing !== undefined) {
                this.bouncing = bCurrentlyBouncing;
            }
        },
        getIsCurrentBouncing: function getIsCurrentBouncing() {
            return this.bouncing;
        },
        elasticBounceDistanceHandler: function elasticBounceDistanceHandler() {
            var iTouchStartXCoords = this.iTouchStartXCoords,
                iTouchEndXCoords = this.iTouchEndXCoords,
                iCarouselWidth = (this.itemWidth * this.moveBy),
                iDistanceTravelled = Math.abs(iTouchStartXCoords - iTouchEndXCoords),
                iBounceDistance = Math.floor((iDistanceTravelled / iCarouselWidth) * 100);

            this.setBounceDistance(iBounceDistance);
        },
        setBounceDistance: function setBounceDistance(iBounceDistance) {
            if (iBounceDistance !== "undefined" && iBounceDistance !== undefined) {
                this.iBounceDistance = iBounceDistance;
            }
        },
        getBounceDistance: function getBounceDistance() {
            return this.iBounceDistance;
        },
        getVisibleItems: function getVisibleItems() {
            return this.visibileItems;
        },
        // calculate each time to avoid value getting out of sync
        currentPageIndex: function currentPageIndex() {
            var iCurrentIndex = this.currentIndex(),
                iItemsPerPage = this.getVisibleItems(),
                iHighestIndexOfItem = this.totalItems() - 1,
                iCurrentPageIndex,
                iHighestIndexOfPage;

            if (Math.abs(iCurrentIndex) > iHighestIndexOfItem) {
                iCurrentIndex = iHighestIndexOfItem;
            }

            if (iItemsPerPage < 1) {
                iCurrentPageIndex = 0;
            } else {
                iCurrentPageIndex = Math.round(Math.abs(iCurrentIndex) / iItemsPerPage);
                iHighestIndexOfPage = this.getNumberOfPages() - 1;
                if (iCurrentPageIndex > iHighestIndexOfPage) {
                    iCurrentPageIndex = iHighestIndexOfPage;
                }
            }

            return iCurrentPageIndex;
        },
        getNumberOfPages: function getNumberOfPages() {
            return this.iNumberOfPages;
        },
        setNumberOfPages: function setNumberOfPages() {
            var iTotalNumberOfItems = this.totalItems(),
                iNumberOfItemsPerPage = this.getVisibleItems();
            this.iNumberOfPages = this.calculateNumberOfPages(iTotalNumberOfItems, iNumberOfItemsPerPage);
        },
        calculateNumberOfPages: function calculateNumberOfPages(iTotalNumberOfItems, iItemsPerPage) {
            var iNumberOfPages = 0;

            if (iItemsPerPage > 0) {
                iNumberOfPages = Math.ceil(iTotalNumberOfItems / iItemsPerPage);
                if (iNumberOfPages < 0) {
                    iNumberOfPages = 0;
                }
            }
            return iNumberOfPages;
        },
        moveToPage: function moveToPage(iSelectedPageIndex) {
            var iCurrentPageIndex = this.currentPageIndex(),
                iNumberOfPagesToMove,
                i,
                j;

            if (iSelectedPageIndex >= 0 && iSelectedPageIndex < this.getNumberOfPages()) {

                iNumberOfPagesToMove = iSelectedPageIndex - iCurrentPageIndex;

                if (iNumberOfPagesToMove < 0) {
                    iNumberOfPagesToMove = Math.abs(iNumberOfPagesToMove);
                    for (i = 0; i < iNumberOfPagesToMove; i++) {
                        this.moveLeft();
                    }
                } else {
                    for (j = 0; j < iNumberOfPagesToMove; j++) {
                        this.moveRight();
                    }
                }
            }
        },
        getWiggleStartupCeremonyEnabled: function getWiggleStartupCeremonyEnabled() {
            var bIsWiggleStartupCeremonyEnabled = false;

            if (this.options.wiggleStartupCeremony === true && this.options.continuousLoop === false && this.supportTransitions) {
                if (breakpoint.mobile || breakpoint.vTablet || breakpoint.hTablet) {
                    bIsWiggleStartupCeremonyEnabled = true;
                }
            }
            return bIsWiggleStartupCeremonyEnabled;
        },
        wiggleStartupCeremonyHandler: function wiggleStartupCeremonyHandler() {
            var selfContext = this,
                iCarouselWidth = (selfContext.itemWidth * selfContext.moveBy),
                iWiggleDistance = Math.floor(iCarouselWidth / 3);

            if (isNaN(iWiggleDistance) === false && iWiggleDistance > 0 && selfContext.bWiggleStartupAnimationHasRun === false && selfContext.iNumberOfPages > 1) {
                selfContext.animate((selfContext.scrollAmount - iWiggleDistance));

                setTimeout(function wiggleStartupCeremonyReturnHandler() {
                    selfContext.elasticBounceReset();
                    selfContext.bWiggleStartupAnimationHasRun = true;
                }, selfContext.options.iWiggleAnimationDuration);
            }
        },
        moveToFirstItemInPage: function moveToFirstItemInPage() {
            var iFirstItemInPage = this.currentPageIndex() * this.getVisibleItems(),
                iIndexOfFirstItemInPage = 0;
            if (iFirstItemInPage !== 0) {
                iIndexOfFirstItemInPage = -iFirstItemInPage;
            }
            this.move(iIndexOfFirstItemInPage, true); // move to item at first index in page
        },
        reInitialisePagination: function reInitialisePagination() {
            this.oCarouselPagination.init();
        },
        hideNextPreviousIfAllItemsVisible: function hideNextPreviousIfAllItemsVisible() {
            if (this.totalItems() <= this.getVisibleItems()) {
                this.$prevHandle.addClass(this.options.sHiddenClass);
                this.$nextHandle.addClass(this.options.sHiddenClass);
            } else {
                this.$prevHandle.removeClass(this.options.sHiddenClass);
                this.$nextHandle.removeClass(this.options.sHiddenClass);
            }
        },
        setVisibleItems: function setVisibleItems(carouselItem) {
            var containerWidth = $(this.$itemsWrapper.parent()).outerWidth(),
                padding,
                unroundedNumberOfVisibleItems,
                containerHeight = $(this.$itemsWrapper.parent()).outerHeight(true);

            if (this.options.bFitsItemWidthsAndPaddingForNumberOfItemsMinusOne) {
                padding = this.itemWidth - carouselItem.width();
                unroundedNumberOfVisibleItems = (containerWidth + padding) / this.itemWidth;
                this.visibileItems = Math.floor(unroundedNumberOfVisibleItems);
            } else {
                if (this.options.vertical) {
                    this.visibileItems = Math.floor(containerHeight / this.itemHeight);
                } else {
                    this.visibileItems = Math.round(containerWidth / this.itemWidth);
                }
            }
        },
        // START - functions to support the design when limitWhitespaceAfterLastItemInCurrentBreakpoint returns true
        // if this returns true the last item should stay to the right of the carousel rather than moving to the left leaving whitespace to the right
        // as per last image of SVP and vTablet design carousel_spec  09/11/2015 attached to GFO-4856
        limitWhitespaceAfterLastItemInCurrentBreakpoint: function limitWhitespaceAfterLastItemInCurrentBreakpoint() {
            if (this.options.oPaginationOptions.breakpointsToAvoidMovingPastLastItem !== undefined) {
                if ((breakpoint.mobile && this.options.oPaginationOptions.breakpointsToAvoidMovingPastLastItem.mobile !== undefined) ||
                        (breakpoint.vTablet && this.options.oPaginationOptions.breakpointsToAvoidMovingPastLastItem.vTablet !== undefined)) {
                    return true;
                }
            }

            return false;
        },
        getWhitespaceToLeaveToRightOfCarousel: function getWhitespaceToLeaveToRightOfCarousel() {
            if (this.limitWhitespaceAfterLastItemInCurrentBreakpoint()) {
                if (breakpoint.mobile) {
                    return this.options.oPaginationOptions.breakpointsToAvoidMovingPastLastItem.mobile.paddingToRightOfCarousel;
                }
                if (breakpoint.vTablet) {
                    return this.options.oPaginationOptions.breakpointsToAvoidMovingPastLastItem.vTablet.paddingToRightOfCarousel;
                }
            }
            return 0;
        },
        getVisibleItemsTo2DecimalPlaces: function getVisibleItemsTo2DecimalPlaces() {
            return this.visibleItemsTo2DecimalPlaces;
        },
        setVisibleItemsTo2DecimalPlaces: function setVisibleItemsTo2DecimalPlaces(carouselItem) {
            var containerWidth = $(this.$itemsWrapper.parent()).outerWidth(),
                padding,
                paddingToRightOfCarousel,
                unroundedNumberOfVisibleItems;

            if (this.options.bFitsItemWidthsAndPaddingForNumberOfItemsMinusOne) {
                paddingToRightOfCarousel = this.getWhitespaceToLeaveToRightOfCarousel();
                padding = this.itemWidth - carouselItem.width();
                unroundedNumberOfVisibleItems = (containerWidth - paddingToRightOfCarousel + padding) / this.itemWidth;

                this.visibleItemsTo2DecimalPlaces = Math.round(unroundedNumberOfVisibleItems * 100) / 100;
            }
        },
        currentIndexTo2DecimalPlaces: function currentIndexTo2DecimalPlaces() {
            return Math.round((this.scrollAmount / this.itemWidth) * 100) / 100;
        },
        moveLeftWouldShowUnwantedWhitespace: function moveLeftWouldShowUnwantedWhitespace() {
            return this.limitWhitespaceAfterLastItemInCurrentBreakpoint() && this.isShowingLastItemToRightOfCarousel();
        },
        moveToFirstItemInLastPage: function moveToFirstItemInLastPage() {
            var bShowingWholeOfFirstItemInPage = (this.currentIndexTo2DecimalPlaces() === this.currentIndex());
            return this.moveLeftWouldShowUnwantedWhitespace() && !bShowingWholeOfFirstItemInPage;
        },
        calculateIndexToFitLastItemToRightOfCarouselTo2DecimalPlaces: function calculateIndexToFitLastItemToRightOfCarouselTo2DecimalPlaces() {
            return Math.round((this.getVisibleItemsTo2DecimalPlaces() - this.totalItems()) * 100) / 100;
        },
        calculateIndexOfFirstItemInLastPage: function calculateIndexOfFirstItemInLastPage() {
            return Math.ceil(this.calculateIndexToFitLastItemToRightOfCarouselTo2DecimalPlaces());
        },
        isShowingLastItemToRightOfCarousel: function isShowingLastItemToRightOfCarousel() {
            var indexOfFirstItemInLastPage = this.calculateIndexToFitLastItemToRightOfCarouselTo2DecimalPlaces();

            if (Math.abs(this.currentIndexTo2DecimalPlaces()) === Math.abs(indexOfFirstItemInLastPage)) {
                return true;
            }
            return false;
        },
        isShowingLastItem: function isShowingLastItem() {
            var iIndexOfFirstItemInLastPage = this.calculateIndexOfFirstItemInLastPage();

            if (Math.abs(this.currentIndex()) >= Math.abs(iIndexOfFirstItemInLastPage)) {
                return true;
            }
            return false;
        },
        moveToFirstItemInPageRequired: function moveToFirstItemInPageRequired() {
            return !(this.limitWhitespaceAfterLastItemInCurrentBreakpoint() && this.isShowingLastItem());
        },
        calculateMoveThresholdForMoveRightWithPagination: function calculateMoveThresholdForMoveRightWithPagination(remaining) {
            var moveThreshold;

            if (this.limitWhitespaceAfterLastItemInCurrentBreakpoint()) {
                if (remaining <= this.moveBy) {
                    moveThreshold = this.calculateIndexToFitLastItemToRightOfCarouselTo2DecimalPlaces();
                } else {
                    moveThreshold = this.currentIndex() - this.moveBy;
                }
            } else {
                if (remaining > 0) {
                    moveThreshold = this.currentIndex() - this.moveBy;
                } else {
                    moveThreshold = this.currentIndex();
                }
            }
            return moveThreshold;
        }
        // END - functions to support the design when limitWhitespaceAfterLastItemInCurrentBreakpoint returns true
    };

    $.fn.carousel = function (opts) {
        return $(this).each(function (index, element) {
            var ele = $(element),
                carousel = new ResCarousel(ele, opts);
            index = index !== undefined || index !== null ? index : "";
            ele.data("carousel", carousel);
        });
    };

    return ResCarousel;
});

define('modules/tile-carousel/common',[
	'domlib',
	'modules/breakpoint',
	'modules/common',
	'modules/product-tile/common',
	'modules/load-more/common',
	'modules/responsive-carousel/responsive-carousel'
], function($, breakpoint, common, productTile, loadMore){

  	/** @namespace */
	var carousel = {

		carousels: [],
		numPanels: 5,
		oneCol: 2.5,
		listingCarousel: null,
		thumbnails: false,
		bPortraitImagesEnabled: false,
		iKioskPortraitProductTileWidth: 0,
		iKioskPortraitProductTileCount: 5,

		create: function (target) {
			var self = this;

			//variables
			self.target = target;
			self.activePanel = 0;
			self.numItems = $('.products > li', target).not('.feature-tile').not('.loadingBar').length;
			self.swipe = true;
			self.numPanels = 5,
			self.thumbnailPanel = 0;
			self.noOfThumbnailsPerPanel = 0;

			self.next = function (e, button) {
				if (e) {
					e.stopImmediatePropagation();
					e.preventDefault();
				}

				if (button) {
					button.blur();
				}

				//is this carousel or button disabled?
				if (!$('.next', target).hasClass('disabled')) {
					var move,
					//calculate number of panels for current viewport
					panels = Math.ceil(self.numItems / self.numPanels);

					if (self.kioskListing) {
						panels = Math.ceil(carousel.listingCarousel.numItems / self.numPanels);
					}

					//shall we go forward?
					if (self.activePanel < (panels - 1) && !self.thumbnails) {
						$('.products', target).removeClass('fast');
						self.activePanel += 1;
						move = self.calculateDistance() * self.activePanel;

						//if this is kiosk let's add more!
						if (self.kioskListing) {
							if (loadMore.checkKioskLoadMore(carousel)) {
								loadMore.fetchNextPage(carousel);
								move = self.calculateDistance() * self.activePanel;
								self.thumbNav(self.activePanel);
								self.animate(move, true);
								self.updateCurrentNo(target);
								self.activeThumb(self.activePanel);
								self.numItems = self.getNumItems();
							}
						}
						else if (self.isShopBy && window.isKiosk()) {
							self.animate(move, true);
						}
						else {
							self.animate(move);
							self.checkNav();
						}

					} else {
						if(e.type === 'tap' || e.type === 'click' || e.type === 'touchstart'){
							if (self.thumbnails && self.thumbnailPanel !== self.totalThumbnailPanels-1) {
								self.thumbnailPanel += 1;
								self.shiftThumbnails(self.thumbnailPanel, self.noOfThumbnailsPerPanel);
								self.checkThumbNav();
							}
						}else{
							if(e.type === 'swipeLeft' || e.type === 'swipeRight'){
								if (self.activePanel < (panels - 1)) {
									self.activePanel += 1;
									move = self.calculateDistance() * self.activePanel;
									self.thumbNav(self.activePanel);
									self.animate(move);
									self.updateCurrentNo(target);
									self.activeThumb(self.activePanel);

								}
							}
						}
						//self.spring('next');
					}
					if(common.isPage('PDP') && $(target).hasClass('pdp-main-image')) {
						self.updateCurrentNo(target);
					}
				}
				return false;
			};

			self.back = function (e, button) {
				var move;

				if (button) {
					button.blur();
				}
				if (e) {
//						e.stopPropagation();
					e.preventDefault();
				}

				//is this carousel or button disabled?
				if (!$('.previous', target).hasClass('disabled') || self.thumbnails) {

					//shall we go back?
					if (self.activePanel > 0 && !self.thumbnails || (loadMore.lowerPage > 0 && e !== undefined)) {
						$('.products', target).removeClass('fast');
						self.activePanel -= 1;
						if (loadMore.lowerPage > 1) {
							self.activePanel = 1;
							move = self.calculateDistance();
						}
						else {
							move = self.calculateDistance() * self.activePanel;
						}

						//if this is kiosk let's add more!
						if (self.kioskListing) {
							if(loadMore.checkKioskLoadPrev(carousel)){
								loadMore.fetchPrevPage(carousel);
								self.activePanel++; // = Math.ceil(self.getNumItems() / 12) (loadMore.lowerPage * 20)
								move = self.calculateDistance() * self.activePanel;
								self.thumbNav(self.activePanel);
								//self.animate(move, true);
								self.updateCurrentNo(target);
								self.activeThumb(self.activePanel);
							}
							else {

							}
							self.animate(move, true);

						}
						else if (self.isShopBy && window.isKiosk()) {
							self.animate(move, true);
						}
						else {
							self.animate(move);
						}

						self.checkNav();
					}
					else {
						if (self.thumbnails) {
							if (typeof e !== 'undefined') {
								if((e.type === 'tap' || e.type === 'click' || e.type === 'touchstart') && self.thumbnailPanel !== 0){
									self.thumbnailPanel -= 1;
									//self.shiftThumbnails(self.thumbnailPanel);
									//self.checkThumbNav();

									self.shiftThumbnails(self.thumbnailPanel, self.noOfThumbnailsPerPanel);
									self.checkThumbNav();
								}else{
									if((e.type === 'swipeLeft' || e.type === 'swipeRight') && self.activePanel !== 0 ){
										self.activePanel -= 1;
										move = self.calculateDistance() * self.activePanel;
										self.thumbNav(self.activePanel);
										self.animate(move);

										self.activeThumb(self.activePanel);
									}
								}
							}
						}
						//self.spring('back');
					}
					if(common.isPage('PDP') && $(target).hasClass('pdp-main-image')) {
						self.updateCurrentNo(target);
					}
				}
				if (loadMore.lowerPage > 1) {
					self.enablePrevButton();
				}
				return false;
			};

			self.spring = function(){
				//used only in touch... Empty function to stop errors!
			};

			self.getNumItems = function() {
				var count = $('.products > li', target).not('.feature-tile').not('.loadingBar').length;

				if ($(target).hasClass('shop-by') && !breakpoint.mobile) {
					count = $('.products > li .product', target).not('.feature-tile').not('.loadingBar').length;
				}

				return count;
			},

			self.checkNav = function () {
				self.numItems = self.getNumItems();

				var panels = Math.ceil(self.numItems / self.numPanels);
				if (self.activePanel > 0) {
					$('a.previous', target).parent().removeClass('disabled');
				} else {
					$('a.previous', target).parent().addClass('disabled');
				}

				if (self.activePanel < (panels - 1)) {
					$('a.next', target).parent().removeClass('disabled');
				} else {
					$('a.next', target).parent().addClass('disabled');
				}

				if (self.activePanel >= panels) {
					self.back();
				}
			};

			self.checkThumbNav = function () {
				self.numItems = self.getNumItems();

				if (self.thumbnailPanel > 0) {
					$('a.previous', target).parent().removeClass('disabled');
				} else {
					$('a.previous', target).parent().addClass('disabled');
				}

				if (self.thumbnailPanel < (self.totalThumbnailPanels-1)) {
					$('a.next', target).parent().removeClass('disabled');
				} else {
					$('a.next', target).parent().addClass('disabled');
				}

			};

			self.calculateDistance = function () {
				var move = 0, marginWidth, marginOffset, pageWidth, percentage, productWidth, productsWidth, offset;

				if(self.kioskListing){
					var perc = ((1830) / $(window).width()) * 100;
					if (carousel.bPortraitImagesEnabled) {
						var iMoveDistance = carousel.iKioskPortraitProductTileWidth * 5;
						move = iMoveDistance;
					} else {
						move = 1728;
					}
				}else{

					if($(self.target).closest('.product-description').length){
						if(!breakpoint.mobile) {
							move = 100;
						}
						else{
							move = 100 - 7.9;
						}
					}
					else{

						if (self.numItems > 0) {

							var isTablet = breakpoint.vTablet || breakpoint.hTablet;

							if (self.numPanels < 3 || (self.isShopBy && isTablet)) {

								if (breakpoint.mobile){
									//mobile
									switch (self.numPanels) {
										//set margins based on grid! Hard coded due to browser inconsistancies (esp. mobile devices);
									case(1):
										marginWidth = 7.5;
										break;
									case(2):
										marginWidth = (self.isShopBy && breakpoint.mobile) ? 7.7 : 5.1;
										break;
									//tablet shop by brand
									case(4):
										marginWidth = 5;
										break;
									}
								}
								else{
									switch (self.numPanels){
										// For publishing grid layout changes - 1 column carousel /2 column carousel
										case(1):
											//marginWidth = -7.2;
											marginWidth = 7.5;
											break;
										case(2):
											//marginWidth = -3.5;
											marginWidth = (self.isShopBy && breakpoint.mobile) ? 7.7 : 5.1;
											break;
									}
								}
                                //move = 100 - marginWidth;
                                move = 100;

							} else {
								// kiosk shop by
								if (self.isShopBy && window.isKiosk()) {
									var $wrapper  = $('.products-wrapper', self.target),
										numItems  = $('.view-all', self.target).is(':visible') ? 4 : 5,
										itemWidth = $wrapper.outerWidth() / numItems;

									move = itemWidth * numItems;
								}

								// desktop
								else if (self.numPanels < 6) {
									marginWidth = parseFloat($(target).css('padding-left')) * 2;
									percentage  = (marginWidth / $(target).width()) * 100;

									move = 100 + percentage;
                                    move = 100;
								}

								// kiosk!
								else {
									marginWidth = parseFloat($('.product:eq(0)', target).css('padding-left')) * 4;
									marginWidth = marginWidth + parseFloat($('.product:eq(0)', target).css('padding-right'));
									percentage  = (marginWidth / $(target).width()) * 100;

									move = 100 - percentage;
								}
							}
						}
					}
				}

				return move;
			};

			self.animate = function (move, pixels) {
				var unit = pixels ? 'px' : '%';
				var posX = (-move) + unit;
				var $htmlDoc  = $('html');
				var $products = $('.products', self.target);
				// do animation
				if (!common.isAndroid() && Modernizr.csstransforms3d) {
					$products.css({
                        '-webkit-transform': 'translate3D(' + posX +',0,0)',
                           '-moz-transform': 'translate3D(' + posX +',0,0)',
                                'transform': 'translate3D(' + posX +',0,0)'
					});
				}

				// check for transition support as well as transform (ie 9 supports transforms but not transitions)
				else if (!common.isAndroid() && Modernizr.csstransforms && Modernizr.csstransitions) {
					$products.css({
                        '-webkit-transform': 'translateX(' + posX + ')',
                           '-moz-transform': 'translateX(' + posX + ')',
                              'msTransform': 'translateX(' + posX + ')',
                                'transform': 'translateX(' + posX + ')'
					});
				}

				// fallback animation
				else {
					var speed = ($products.hasClass('fast')) ? 150 : 600;
					$products.animate({
						left: posX
					}, speed);
				}

			};

			self.reset = function () {

				self.activePanel = 0;
				self.animate(0);
				self.hasThumbnails();
				self.checkNav();

				// shift the thumbnails back to the top and ensure that only the first has the selected class
				if(self.thumbnails && (breakpoint.desktop || breakpoint.largeDesktop || window.isKiosk())){
					self.thumbnailPanel = 0;
					self.activeThumb(0);
					self.shiftThumbnails(0,0);
					self.activeThumb(self.activePanel);
					self.updateThumbnails();
					self.checkThumbNav();
					self.thumbNav(self.activePanel);

					// update the current x of x images numbering ready for mobile/tablet
				}
				self.updateCurrentNo(self.target);
				if ((breakpoint.kiosk || breakpoint.vTablet || breakpoint.hTablet) && self.numItems > 1) {
					self.displayInfo();
				}
			};

			self.kioskListingLayout = function(animate){
				var containerWidth = 0;

				carousel.iKioskPortraitProductTileWidth = $('.products > li').first().outerWidth(true);
				$('.load-more-tile', target).remove();
				self.numItems = self.getNumItems();

				if (carousel.bPortraitImagesEnabled) {
					containerWidth = (carousel.iKioskPortraitProductTileWidth * Math.ceil(self.numItems));
				} else {
					containerWidth = (1760 * Math.ceil(self.numItems/12));
					$('#listing .products-wrapper').width(containerWidth);
				}

				$('.products',target).width(containerWidth);

				if(animate){
					var move = self.calculateDistance() * self.activePanel;
					self.animate(move, true);
					self.checkNav();
				}

			};

			//do a nav check on load
			self.checkNav();

			if(window.isKiosk()){
				if($(self.target).parent('#listing').length > 0){
					self.kioskListingLayout();
					self.kioskListing = true;
					//tile click  .products.compare
					$('#listing').on('click', '.products:not(.compare) .product', function(e){
						e.preventDefault();
                        if(!$(e.target).hasClass('add-to-basket')){
							var product = $(e.target).closest('.product');
							window.location = $('h3 a', product).attr('href');
							return false;
                        };
					});
				}
			}

			self.activeThumb = function(){
				var thumbs = $(target).find('.thumbnails li');
				thumbs.removeClass('selected');
				thumbs.eq(self.activePanel).addClass('selected');
			};

			self.setupThumbnails = function(){
				$(target).find('.thumbnails li a').each(function(){
					var select = (common.isTouch())? 'tap click' : 'click';
					$(this).on(select, function(e) {
						e.preventDefault();
						self.thumbNav($(this).parent('li').index());
						return false;
					});
				});

				$(target).find('.thumbnails li').eq(0).addClass('selected');

				if(self.totalThumbnailPanels === 1) {
					$(target).find('.product-carousel-nav').hide();
				}
				else {
					$(target).find('.product-carousel-nav').show();
				}
			};

			self.setThumbnailListWidthOrHeight = function () {
				var widthOrHeight = 0;
				if (window.isKiosk()) {

					$(target).find('.thumbnails li').each(function () {
						widthOrHeight += $(this).outerWidth(true);
					});
					$(target).find('.thumbnails > ul').width(widthOrHeight);

					if($(target).find('.thumbnails li').length <= 8){
						$(target).find('.thumbnails').css('left', '0').css('width','100%');
					}

				} else {

					$(target).find('.thumbnails li').each(function () {
						widthOrHeight += $(this).outerHeight(true);
					});
					$(target).find('.thumbnails > ul').height(widthOrHeight);

				}
			};

			self.getTotalThumbnailPanels = function () {
				var thumbnailNum = $(target).find('.thumbnails li').length;

				switch (breakpoint.currentViewport) {
					case 'kiosk':
						self.noOfThumbnailsPerPanel = 6;
						break;
					case 'largedesktop':
						if(thumbnailNum > 6){
							self.noOfThumbnailsPerPanel = 5;
						}else{
							self.noOfThumbnailsPerPanel = 6;
						}
						break;
					case 'desktop':
						if(thumbnailNum > 4){
							self.noOfThumbnailsPerPanel = 3;
						}else{
							self.noOfThumbnailsPerPanel = 4;
						}

				}
				self.totalThumbnailPanels =  Math.ceil(thumbnailNum / self.noOfThumbnailsPerPanel);
			};

			self.thumbNav = function(index){
				self.activePanel = index;
				self.activeThumb();
				var move = self.calculateDistance() * self.activePanel;
				self.animate(move);
				self.updateCurrentNo(target);
				self.checkThumbNav();
			};

			self.shiftThumbnails = function (increment, noOfThumbsShown) {
				var unit  = 'px',
					speed = 600,
					translate  = '',
					$thumbWrap = $(target).find('.thumbnails'),
					$thumbList = $('.product-description .product-carousel .thumbnails ul');

				if (common.isModern() && !common.isAndroid()) {
					switch (noOfThumbsShown) {
					case 3:
						translate =  '0,' + (-increment * $thumbWrap.height()) + unit + ', 0';
						break;
					case 5:
						translate =  '0,' + (-increment * $thumbWrap.height()) + unit + ', 0';
						break;
					case 6:
						translate = (-increment * $thumbWrap.width()) + unit + ', 0, 0';
						break;
					case 0:
						translate = '0, 0, 0';
						break;
					}

					$thumbList.css({
                        '-webkit-transform': 'translate3D(' + translate + ')',
                           '-moz-transform': 'translate3D(' + translate + ')',
                                'transform': 'translate3D(' + translate + ')'
					});
				} else {
					speed = $thumbList.hasClass('fast') ? 150 : 600;
					if (noOfThumbsShown === 3 || noOfThumbsShown === 5 || noOfThumbsShown === 0) {
						$thumbList.animate({ marginTop: -increment * $thumbWrap.height() + unit }, speed);
					} else if (noOfThumbsShown === 6) {
						$thumbList.animate({ marginLeft: -increment * $thumbWrap.width() + unit }, speed);
					}
				}

			};

			self.displayTotalNo = function (target) {
				$(target).find('.carousel-info .image-total').html($(target).find('.products li').length);
			};

			self.displayConjunction = function (target) {
				$(target).find('.carousel-info .conjunction').html(' of ');
			};

			self.updateCurrentNo = function (target) {
				setTimeout(function(){
					if (self.numItems > 1) {
						$(target).find('.carousel-info .image-no').text(self.activePanel+1);
					}
				}, 300);
			};

			self.displayInfo = function () {
				self.displayTotalNo(target);
				self.displayConjunction(target);
				self.updateCurrentNo(target);
			};

			self.addImagesText = function () {
				$(target).find('.carousel-info .info-container').append('<span> images</span>');
			};

			self.updateThumbnails = function () {
				self.setThumbnailListWidthOrHeight();
				self.getTotalThumbnailPanels();
				self.setupThumbnails();
			};

			self.hasThumbnails = function(){
				//does this have thumbnails?
				if($(target).find('.thumbnails').length && $(target).find('.thumbnails').is(':visible')){
					self.thumbnails = true;
				}else{
					self.thumbnails = false;
				}
			};

			self.hasThumbnails();

			if ((breakpoint.kiosk || breakpoint.vTablet || breakpoint.hTablet) && self.numItems > 1) {
				self.displayInfo();
				if (breakpoint.vTablet || breakpoint.hTablet) {
					self.addImagesText();
				}
			}

			// Below required for Infinity Browse
			self.moveToProduct = function(elemId) {
				try {
					var self = this,
						leftPos = $('#' + elemId).offset().left,
						theDistance = self.calculateDistance();

					self.activePanel = Math.floor(leftPos / theDistance);
					if (self.activePanel >= 1) {
						move = theDistance * (self.activePanel);
						self.animate(move, true);
						self.thumbnailPanel = self.activePanel;
						self.checkThumbNav();
						self.activeThumb(self.activePanel);
					}
				}
				catch(e) {}
			};

			self.enablePrevButton = function() {
				var self = this;
				$('a.previous', self.target).parent().removeClass('disabled');
			};

		},



		resetAll: function () {
			var i;
			for (i = 0; i < carousel.carousels.length; i++) {
				if (!$(carousel.carousels[i].target).parent().is('#listing')) {
					carousel.carousels[i].reset();
				}
				else {
					carousel.carousels[i].checkNav();
				}
			}
		},

		setNumPanels: function (num) {
			var i;
			for (i = 0; i < carousel.carousels.length; i++) {

				var viewportNum = 'data-itemsperpage-' + breakpoint.currentViewport;
				var $elem = $(carousel.carousels[i].target);

				if($elem.hasClass("tabbed")) {
					//carousel.carousels[i].numPanels = parseInt($(carousel.carousels[i].target).attr(viewportNum), 10);
					carousel.carousels[i].numPanels = Math.floor($elem.width() / $elem.find('.products li').eq(0).width());
				}
				else {
					if ($(carousel.carousels[i].target).hasClass('shop-by')) {
						carousel.carousels[i].numPanels = breakpoint.mobile ? 2 : 4;
					}
					else if ($elem.parent('#listing').length) {
						carousel.carousels[i].numPanels = common.getNumberOfVisibleItemsForKioskListing($elem.parent('#listing'));
					}
					else if($(carousel.carousels[i].target).parent('.main-details').length) {
						carousel.carousels[i].numPanels = 1;
					}
					else {
						carousel.carousels[i].numPanels = num;
					}
				}
				if(carousel.carousels[i].numItems <= carousel.carousels[i].numPanels) {
					if($(carousel.carousels[i].target).hasClass('pdp-main-image')){
						$('.product-carousel-nav','.pdp-main-image').hide();
						return false;
					}
					else{
						$('.product-carousel-nav',carousel.carousels[i].target).hide();
					}
				}
				else {
					if (!breakpoint.mobile) $('.product-carousel-nav',carousel.carousels[i].target).show();
				}
			}

			if(window.isKiosk()){
				$('.product-carousel.tabbed').each(function(index){
					if(index > 0){
						$(this).addClass('hidden');
					}
				});
			}
		},

		createNewCarousel: function(target){
			var c = new carousel.create(target);
			if (carousel.extend) {
			    c = carousel.extend(c);
			    c.bindEvents();
			}
			return c;
		},

		// adjust the position of the former prices so that they sit to the right of the current price
		priceFontSize: function(){
			$('.product-carousel .product').each(function(){
				var $product = $(this),
					$former  = $('.former-prices', this);

				if ($former.children('li').length) {
					var $current = $('.price', this),
						pWidth   = ($product.innerWidth() - parseInt( $product.css('padding-left'), 10 ) - parseInt( $product.css('padding-right'), 10 )),
						fWidth   = $former.outerWidth(),
						value    = $current.text().replace(/[^0-9]/g, '');

					// portrait kiosk images do not use padding so some extra space needs adding to this calculation
					if (carousel.bPortraitImagesEnabled) {
						pWidth = ($product.find('.details-buy-box-container').innerWidth() - parseInt( $product.find('.details-buy-box-container').css('padding-left'), 10 ) - parseInt( $product.find('.details-buy-box-container').css('padding-right'), 10 ));
					}

					// if we're working with a large current price, add the 'smaller' class to reduce it's size
					if (value.length > 5 || ($('.from', $current).length && value > 4)) {
						$current.addClass('smaller');
					}

					// get the remaining width to apply to the former price container
					pWidth = pWidth - $current.outerWidth(true) - 2;

					// if the former price exceeds the remaining width, apply the 'wrapped' class to correct the line height
					if (fWidth > pWidth) {
						$former.addClass('wrapped');
					}

					// assign the remaining width the former price container
					$former.css('width', pWidth);
				}

			});
		},

		init: function ($elem) {

	        $(".product-carousel-nav a").bind("touchstart", function() {
	          if(!$(this).parents('li').hasClass("disabled")) {
	            $(this).addClass("touchactive");
	          }
	        });
	        $(".product-carousel-nav a").bind("touchend", function() {
	          //if(!$(this).parents('li').hasClass("disabled")){
	            $(this).removeClass("touchactive");
	          //}
	        });
			$(".product-carousel-nav a").bind("tap click", function(e) {
				$(".product-carousel-nav a").each(function(){
					$(this).removeClass("touchactive");
				});
				if($('#myOrdersForm').length <= 0){
					e.preventDefault();
				}
			});
	        // if it's the listing product grid for kiosk, set up as a product carousel
	        if (window.isKiosk()) {
	          $('#listing').addClass('product-carousel');
	          $('.seller-directory').find('#main-content').addClass('product-carousel');
			  carousel.bPortraitImagesEnabled = $('#listing').hasClass('imagePreset-portraitxl') || false;	// check for kiosk portrait images
			}

			if(window.isKiosk() && $elem === undefined){
	          var tabsReadyTimer = setInterval(function(){tabsReadyCheck()},500); // check dom is ready for tab logic

	          function tabsLogic() {
	            var $tabs = $('#product-carousel-tabs');
	            var $tabsCount = $('li', $tabs).length;

	            if(!$tabsCount){
	              $('.product-carousel.tabbed').each(function(){
	                if($(this).find('.products-header h2').css('display') != 'block'){
	                  $('.product-carousel.tabbed').addClass('hidden');
	                }
	              });
	            }
	            else{
	              var $tabsContent = $tabs.parent().nextAll().filter(':lt('+$tabsCount+')');
	              var $tabbedGrids = $('.product-grid', $tabsContent);

	              if($tabbedGrids.length){
	                $tabbedGrids.each(function () {
	                  $(this).removeClass('product-grid').addClass('product-carousel tabbed');
	                  $(this).find('div.products-header').append('<ul class="product-carousel-nav"><li class="disabled"><a href="#" class="previous"><span class="label">Previous</span><span aria-hidden="true" class="icon"></span></a></li><li><a href="#" class="next"><span class="label">Next</span><span aria-hidden="true" class="icon"></span></a></li></ul>');
	                });
	              }
	            }
	          }

	          function tabsReadyCheck() {
	            if($('#main-content .product-carousel').length >= 3) {
	              clearInterval(tabsReadyTimer);
	              tabsLogic();
	            }
	          }
	        }

	        var exists = false;

            var $carouselElem = $('#listing.product-carousel, .shop-by');
	        if ($elem !== undefined) {
	          $carouselElem = $elem;
	        }

			//if($carouselElem.length && !(window.isKiosk())){			// reverted this back (tfs defect 35857) as it stops carousel rendering in kiosk category pages
			//if($carouselElem.length && !($('#listing').length)){		// caused issue 52377 fix on next line
			if(($carouselElem.length && !window.isKiosk()) || ($carouselElem.length && window.isKiosk() & !$('#listing').length)){ // Not kiosk OR is kiosk page not containing #listing

	          $carouselElem.each(function () {
	            var c = carousel.createNewCarousel(this);

	            c.isShopBy = $(this).hasClass('shop-by');
					// Streamline basket epic - class is added in '/stubs/streamline-basket/rich-rel.php'
					c.isStreamLineBasket = $(this).hasClass('streamline-basket-carousel');

	            if(breakpoint.mobile){
	              c.numPanels = (c.isShopBy) ? 2 : 1;
	            }else{
	              if(breakpoint.vTablet || breakpoint.hTablet){
	                c.numPanels = (c.isShopBy) ? 4 : 2;
	              }else{
	                if(breakpoint.desktop){
	                  c.numPanels = 4;
	                }else{
	                  if(breakpoint.largeDesktop){
									c.numPanels = 5;
	                  }else{
	                    if(breakpoint.kiosk){
	                      c.numPanels = 6;
	                    }
	                  }
	                }
	              }
	            }

	            // toggle the display of the view all link in the kiosk viewport
	            if (c.isShopBy && window.isKiosk()) {
	              if ($('.products li', this).length > 5) {
	                var $wrapper  = $('.products-wrapper', this),
	                  wrapWidth = $wrapper.outerWidth(),
	                  itemWidth = wrapWidth / 5;

	                $wrapper.css('width', wrapWidth - itemWidth);

	                $('.view-all', this).css('display', 'inline-block');
	              }
	            }

	            c.checkNav();

	            carousel.carousels.push(c);
	          });

	          exists = true;
	        }

	        if(window.isKiosk() && $('#listing .products-wrapper').length){
	          $('#listing .products-wrapper .load-more-tile').remove();
	          var c = carousel.createNewCarousel($('#listing .products-wrapper'));
	          carousel.carousels.push(c);

	          carousel.listingCarousel = c;
	          productTile.checkFrom();
	          exists = true;
	        }

	        // This is placed here due to race-conditions with the load-more module having a dependancy on the tile-carousel
			if (!common.isPage('PDP') && loadMore) {
				if (!loadMore.initialised) {
					loadMore.initialised = true;
	       			loadMore.handleBookmark(carousel);
				}
			}

	        // Blocks are lazy loaded on PDP and are generated by property file which needs a generic function to re-initialise the content
			if (common.isPage('PDP')) {
	          common.initDeferredMethods();
	        }

	        if (typeof $elem !== 'undefined') {
	          if ($elem.parent().hasClass('carousel-1')) {
	            $elem.removeClass('hidden');
	          }
	          else {
	            $elem.addClass('hidden');
	          }
	          $elem.parent().hasClass('beenInitialised');
	        }

	        return exists;
	      },

		initTabs: function () {

	          var tabbedCarousels   = $('.product-carousel.tabbed'),
	            hiddenCarousels   = $('.product-carousel.tabbed.hidden'),
	            tabbingInProgress = false;

	          //productTile.Height.init();
	          carousel.priceFontSize();

			hiddenCarousels.hide();

	          var select  = (common.isTouch())? 'tap click' : 'click';

	          var $tabs = $('#product-carousel-tabs a');
	          $tabs.on(select, function (e) {
	            e.preventDefault();
	            e.stopPropagation();

	            tabbedCarousels = $tabs.parents('.row').nextAll('.row').find('.product-carousel.tabbed');

	            var index = $tabs.index(this);

	            var oldSelectedCarousel = tabbedCarousels.not('.hidden').first(),
	              newSelectedCarousel = tabbedCarousels.eq(index);

	            if (tabbingInProgress || tabbedCarousels.index(oldSelectedCarousel) === index) {
	              tabbingInProgress = false;
	              return false;
	            }

	            newSelectedCarousel.show();

	            // Update tab selected state
	            $('#product-carousel-tabs li').removeClass('selected');
	            $(this).parent().addClass('selected');

	            tabbingInProgress = true;

	            tabbedCarousels.unbind('transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd');

	            // added kiosk check as modernizer is returning false for the common.isModern() check with chrome
	            if (window.isKiosk() || (common.isModern() && !common.isAndroid())) {
	              var isRunning = false;
	              oldSelectedCarousel
	                .bind('transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd', function(e) {
	                  // stop event from being fired twice
	                  if (isRunning) {
	                    return;
	                  }
	                  isRunning = true;

	                  $(this).hide();

	                  newSelectedCarousel
	                    .show(0, function () {
	                      $(this).removeClass('hidden');
	                      tabbingInProgress = false;
	                    });

	                  productTile.Height.adjust( newSelectedCarousel, productTile.Ellipsis.init, false, false );
	                })
	                .addClass('hidden');
	            } else {
	              oldSelectedCarousel
	                .animate({'top': oldSelectedCarousel.outerHeight(), 'opacity': '0'}, 300, function () {
	                  $(this).hide();
	                  newSelectedCarousel
	                    .show()
	                    .animate({'top': '0', 'opacity': '1'}, 300, function () {
	                      $(this).removeClass('hidden');
	                      tabbingInProgress = false;
	                    });
	                })
	                .addClass('hidden');
	            }

	            tabbingInProgress = false;
	          });
	        },

        getScrollLimit: function getScrollLimit() {
            var currentWindowWidth = window.currentDocumentWidth;
            if (currentWindowWidth < 584) {//SVP
                return 0;
            } else if (currentWindowWidth >= 584 && currentWindowWidth < 944) {//MVP
                return 8;
            } else {
                return 4;//LVP + LLVP
            }
        },

        resetResCarousel: function resetResCarousel() {
            var $carousels = $('.product-carousel-heroic, .product-carousel').not("#listing.product-carousel, .product-carousel.shop-by"),
                oCarousel;

            if ($carousels.length > 0) {
                var scrollLimit = carousel.getScrollLimit();

                $carousels.each(function (){
                    oCarousel = $(this).data('carousel');
                    if (oCarousel) {
                    	if ($(this).hasClass('product-carousel-heroic')) {
	                        oCarousel.options.scrollLimit = scrollLimit;
	                        common.Ellipsis.init($(this).find('.product h3'));
	                    }
	                    oCarousel.reset();
                    }
                });
            }
        },

        initResCarousel: function initResCarousel() {
            var self = this;
            $(".product-carousel").not("#listing.product-carousel, .product-carousel.shop-by").carousel({
                enablePeep:!window.isKiosk(),
                itemSelector: "ul.products > li"
            });

            $(".product-carousel-heroic").carousel({
                itemSelector: "ul.products > li",
                scrollLimit: self.getScrollLimit(),
                enablePeep: false
            });

            common.Ellipsis.init($(".product-carousel-heroic").find('.product h3'));

            breakpoint.mobileIn.push(self.resetResCarousel);
            breakpoint.vTabletIn.push(self.resetResCarousel);
            breakpoint.hTabletIn.push(self.resetResCarousel);
            breakpoint.desktopIn.push(self.resetResCarousel);
            breakpoint.largeDesktopIn.push(self.resetResCarousel);
        }
	};

	//viewport functions
	breakpoint.mobileIn.push(function(){
		carousel.setNumPanels(1);
		carousel.resetAll();
	});
	breakpoint.vTabletIn.push(function(){
		carousel.setNumPanels(2);
		carousel.resetAll();
	});
	breakpoint.hTabletIn.push(function(){
		carousel.setNumPanels(2);
		carousel.resetAll();
	});
	breakpoint.desktopIn.push(function(){
		carousel.setNumPanels(4);
		carousel.resetAll();
	});
	breakpoint.largeDesktopIn.push(function(){
		carousel.setNumPanels(5);
		carousel.resetAll();
	});
	breakpoint.kioskIn.push(function(){
		carousel.setNumPanels(6);
		carousel.resetAll();
	});

	common.init.push(function() {
        carousel.initResCarousel();
    });

	return carousel;

});

/**
 * Footer Module
 */
/*global common: true*/
define('modules/footer/common',['domlib', 'modules/breakpoint', 'modules/common'], function ($, breakpoint, common) {
    'use strict';

    var footer = {
        //footer accordion selector
        accordion: '.accordion',

        showAccordianItem: function showAccordianItem(accordionItem) {
            this.hideAccordianItem($('.accordion-element'));
            accordionItem.addClass('accordion-item-active');
        },

        hideAccordianItem: function hideAccordianItem(accordionItem) {
            accordionItem.css('min-height', 0)
                .removeClass('accordion-item-active');

        },

        checkAccordianItemsHeight: function checkAccordianItemsHeight(accordion) {
            if (accordion.length > 0) {
                accordion.each(function () {
                    var content = $(this).find('.content');
                    if (breakpoint.mobile) {
                        $(window).load(function () {
                            /*jslint unparam:true*/
                            //To stop unused variable error with JSLint (i  & e)
                            content.each(function (i, e) {
                                var self = $(this),
                                    myHeight = self.height();
                                self.data('contentHeight', myHeight);
                            });
                            content.each(function (i, e) {
                                var self = $(this);
                                self[0].style.minHeight = self.data('contentHeight') + 'px';
                            });
                            /*jslint unparam:false*/
                        });
                    } else {
                        content.css('min-height', '0');
                    }
                });

            }
        },

        bindEvents: function bindEvents(accordion) {
            accordion.on('tap click', '.title-box', function () {
                if (breakpoint.mobile) {
                    //check if mobile
                    var self = $(this),
                        accordionItem = self.parent('.accordion-element');

                    if (accordionItem.hasClass('accordion-item-active')) {
                        footer.hideAccordianItem(accordionItem);
                    } else {
                        footer.showAccordianItem(accordionItem);
                    }
                }
                return false;
            });
        },

        mobileInOut: function mobileInOut() {
            footer.checkAccordianItemsHeight($(footer.accordion));
        },

        setup: function setup(accordion) {
            accordion.each(function () {
                var self = $(this);
                footer.bindEvents(self);
            });
        },

        init: function init() {
            var accordion = $(footer.accordion);
            //check footer element exists
            if (accordion.length) {
                footer.setup(accordion);

                /** Add functions to breakpoint arrays **/
                breakpoint.mobileIn.push(footer.mobileInOut);
                breakpoint.mobileOut.push(footer.mobileInOut);

                if (!common.checkPreviewEnvironment(document.URL)) {
                    common.showCookieBanner();
                }
            }
        }

    };

    //Initialise this module
    common.init.push(footer.init);

});


define('text!templates/views/breadcrumbListView.html',[],function () { return '{{#items}}\r\n\t<li class="{{className}}" itemtype="{{itemtype}}" itemscope="{{itemscope}}">\r\n\t<a  data-category-id="{{categoryID}}" itemprop="url" href="{{url}}">\r\n\t\t<span itemprop="title">{{text}}</span>\r\n\t</a>\r\n\t</li>\r\n{{/items}}';});

define('modules/breadcrumb-cache/common',['require','exports','module','modules/common','modules/mvc/fn','mustache','text!templates/views/breadcrumbListView.html'],function (require, exports, module) {
  'use strict';

  var common = require('modules/common'),
    fn = require('modules/mvc/fn'),
    mustache = require('mustache'),
    template = require('text!templates/views/breadcrumbListView.html'),
    breadcrumbCache = null;

  breadcrumbCache = {
    allowedParams: { catId: true, searchquery: true },
    breadcrumbKey: 'breadcrumbs',
    plpBreadcrumbId: null,
    pdpBreadcrumbId: null,
    /**
     *
     * @param {Object} options
     * @return {void}
     */
    init: function init(options) {
      var _options = options || {},
        breadcrumb = null;

      this.pdpBreadcrumbId = _options.pdpBreadcrumbId || 'breadcrumb-v2';
      this.plpBreadcrumbId = _options.plpBreadcrumbId || 'breadcrumb';

      if (window.localStorage) {
        if (common.isPage('PLP')) {
          this.cacheBreadcrumb(document.location.href + document.location.search);
        } else if (common.isPage('PDP')) {
          this.renderBreadcrumb(document.referrer);
          breadcrumb = document.getElementById(this.pdpBreadcrumbId);

          if (breadcrumb) {
            breadcrumb.style.visibility = 'visible';
          }
        }
      }
    },
    /**
     *
     * @param {string} key
     * @return {void}
     */
    renderBreadcrumb: function renderBreadcrumb(key) {
      var breadcrumb = $('#' + this.pdpBreadcrumbId + ' ul'),
        content = null,
        _key = this.normaliseKey(key),
        cache = null;

      if (!breadcrumb.length || !_key) {
        return;
      }

      cache = this.getCache();
      content = cache[_key];

      if (!content) {
        return;
      }

      breadcrumb[0].innerHTML = mustache.render(template, { items: content });
    },
    /**
     *
     * @param {string} key
     * @return {void}
     */
    cacheBreadcrumb: function cacheBreadcrumb(key) {
      var _this = this,
        $breadcrumb = $('#' + this.plpBreadcrumbId),
        $listItems = null,
        _key = this.normaliseKey(key),
        cache = null,
        data = null;

      if ($breadcrumb.length && _key) {
        $listItems = $breadcrumb.find('li');

        data = $listItems.map(function (index, elm) {
          return _this.extractAttributes(_key, elm, index, $listItems.length);
        });

        cache = this.getCache();
        cache[_key] = data.get();
        this.saveCache(cache);
      }
    },
    /**
     *
     * @param {string} key
     * @param {Element} elm
     * @param {number} index
     * @param {number} count
     * @return {Object}
     */
    extractAttributes: function extractAttributes(key, elm, index, count) {
      var className = '',
        url = '';

      if (!elm || !elm.getAttribute) {
        return {};
      }

      if (index === 0) {
        className = 'first';
      } else if (index === count - 1) {
        className = 'last';
        url = key;
      }
      return {
        className: className,
        url: elm.getAttribute('data-bc-href') || url,
        text: elm.getAttribute('data-bc-text') || '',
        itemscope: elm.getAttribute('itemscope') || '',
        itemtype: elm.getAttribute('itemtype') || '',
        categoryID: elm.getAttribute('data-bc-category-id') || ''
      };
    },
    /**
     *
     * @return {Object}
     */
    getCache: function getCache() {
      return fn.getLocalStorageData(this.breadcrumbKey) || {};
    },
    /**
     *
     * @param {Object} cache
     * @return {void}
     */
    saveCache: function saveCache(cache) {
      fn.setLocalStorageData(this.breadcrumbKey, cache);
    },
    /**
     *
     * @param {string} url
     * @return {string}
     */
    normaliseKey: function normaliseKey(url) {
      var parts = url.split('?'),
        path = parts[0] || '',
        params = parts[1] || '',
        paramsList = [],
        allowedParams = this.allowedParams;

      if (!path) {
        return '';
      }

      paramsList = params.split('&').reduce(function (accumulator, param) {
        var pair = param.split('=');

        if (pair.length > 1 && allowedParams[pair[0]]) {
          accumulator.push(param);
        }

        return accumulator;
      }, []);

      path += '?' + paramsList.join('&');
      return path;
    }
  };

  module.exports = breadcrumbCache;
});

/*global define, window, history, document, setTimeout */
/**
 * Breadcrumb Module : Manage breadcrumb
 */
define('modules/breadcrumb/common',['domlib', 'modules/breakpoint', 'modules/common', 'modules/breadcrumb-cache/common'], function ($, breakpoint, common, breadcrumbCache) {

    'use strict';

    var crumb = {

        element: null,
        itemNum: 0,
        isOpen: false,
        totalWidth: 0,
        maxMobileLength: 35,
        maxTabletLength: 90,
        sBreadcrumbElementId: '#breadcrumb',

        /**
         * Get li height from mobile viewport for open / close animation
         * @return {int} LI line hight for an individual breadcrumb item.
         */
        liHeight: function () {
            return $('li', crumb.element).eq(0).outerHeight();
        },

        ulHeight: function () {
            return $('ul', crumb.element).eq(0).outerHeight();
        },

        supportsHistoryApi: function () {
            return !!(window.history && history.pushState);
        },

        /**
         * Add interaction for mobile
         * @param  {boolean} setMobile Run mobile JS?
         */
        mobileIn: function () {
            setTimeout(function () {
                crumb.close(false);
                crumb.element.css({
                    height: crumb.liHeight()
                }).addClass('animate');
            }, 25);
        },

        mobileOut: function () {
            crumb.open(false);
            crumb.element.css({
                height: 'auto'
            }).removeClass('animate');
        },


        /**
         * Open breadcrumb (Mobile and Vertical tablet only)
         */
        open: function (animate) {

            if (crumb.element.hasClass('noAnimate')) {
                crumb.element.removeClass('noAnimate');
            }

            //show all breadcrumbs
            if (animate) {
                if (crumb.sBreadcrumbElementId === '#breadcrumb-v2') {
                    if (!common.isModern()) {
                        crumb.element.animate({
                            // height: (crumb.liHeight() * crumb.itemNum)
                            height: crumb.ulHeight()
                        }, 600, 'easeInOutQuart');
                    } else {
                        crumb.element.css({
                            // height: (crumb.liHeight() * crumb.itemNum)
                            height: crumb.ulHeight()
                        });
                    }
                } else {
                    if (!common.isModern()) {
                        crumb.element.animate({
                            // height: (crumb.liHeight() * crumb.itemNum)
                            height: crumb.ulHeight()
                        }, 600, 'easeInOutQuart');
                    } else {
                        crumb.element.css({
                            // height: (crumb.liHeight() * crumb.itemNum)
                            height: crumb.ulHeight()
                        });
                    }
                }
            } else {
                crumb.element.css({
                    // height: (crumb.liHeight() * crumb.itemNum)
                    height: crumb.ulHeight()
                });
            }

            $('.toggle', crumb.element).attr('data-icon', 'c');
            crumb.isOpen = true;

        },


        /**
         * Close breadcrumb (Mobile and Vertical tablet only)
         */
        close: function (animate, override) {

            //hide all items except the last one
            if (!override) {
                if (animate) {
                    if (!common.isModern()) {
                        crumb.element.animate({
                            height: crumb.liHeight()
                        }, 600, 'easeInOutQuart');
                    } else {
                        crumb.element.css({
                            height: crumb.liHeight()
                        });
                    }
                } else {
                    crumb.element.css({
                        height: crumb.liHeight()
                    });
                }
            } else {
                if ($(document).scrollTop() > crumb.element.height()) {
                    crumb.scroll();
                    crumb.element.addClass('noAnimate').css({
                        height: crumb.liHeight()
                    });
                } else {
                    crumb.element.css({
                        height: crumb.liHeight()
                    });
                }
            }

            $('.toggle', crumb.element).attr('data-icon', 'a');
            crumb.isOpen = false;

        },


        /**
         * Toggle the breadcrumb open/closed
         */
        toggle: function (e) {

            var $target = $(e.target);

            if (e) {
                e.stopPropagation();
            }

            if (breakpoint.mobile || breakpoint.vTablet || breakpoint.hTablet) {
                if (crumb.isOpen) {
                    if (($target.hasClass('toggle') && $target.parent(crumb.sBreadcrumbElementId))) {
                        crumb.close(true);
                    } else if (!($target.parents(crumb.sBreadcrumbElementId).length)) {
                        crumb.close(true, true);
                    }
                } else {
                    if ($target.hasClass('toggle') && $target.parent(crumb.sBreadcrumbElementId)) {
                        crumb.open(true);
                    }
                }
            }
        },


        /**
         * If the length of a breadcrumb item is greater than 28 characters then truncate and add ellipses
         * @param  {object} el Breadcrumb item element
         */
        truncate: function () {
            var text,
                fullString,
                truncated;

            $('li a', crumb.element).each(function () {
                text = $.trim($(this).text());
                if (crumb.maxMobileLength <= text.length) {
                    fullString = text;
                    $(this).data('fullString', fullString);
                    truncated = fullString.slice(0, crumb.maxMobileLength - 3) + '...';
                    $(this).text(truncated);
                }
            });
        },

        /**
         * Undo mobileTruncate()
         */
        unTruncate: function () {
            $('li a', crumb.element).each(function () {
                var fullString = $(this).data('fullString');
                if (fullString) {
                    $(this).text(fullString);
                }
            });
        },

        bindEvents: function () {
            $(crumb.sBreadcrumbElementId + ' .toggle').on('click', crumb.toggle);
        },

        scroll: function () {
            $('html, body').scrollTop(($(document).scrollTop() - crumb.element.height()) + crumb.liHeight());
        },

        init: function () {

            var sBackToSearchText = "Back to search results",
                sPattern = "direct\\/search-results\\/results.page",
                sReferrerURL = document.referrer;

            if (crumb.sBreadcrumbElementId === '#breadcrumb-v2' && sReferrerURL.search(sPattern) > 0) {
                $(crumb.sBreadcrumbElementId + ' .first').removeClass("first");
                $(crumb.sBreadcrumbElementId + ' ul').prepend('<li class="back-to-results first"><a href="' + sReferrerURL + '"><span>' + sBackToSearchText + '</span></a></li>');
            }

            crumb.element = $(crumb.sBreadcrumbElementId);
            if (crumb.element.length) {
                crumb.bindEvents();
                //get number of items
                crumb.itemNum = $('li', crumb.element).length;

                //if only one item then hide the button
                if (crumb.itemNum < 2) {
                    $('.toggle', crumb.element).hide();
                }

                // do truncate by javascript only on old pdp.
                if (crumb.sBreadcrumbElementId === '#breadcrumb') {
                    crumb.truncate();
                }

                if (!crumb.supportsHistoryApi() || window.isKiosk()) {
                    $('.last_applied_filter').show();
                }

                breakpoint.mobileIn.push(crumb.mobileIn);
                breakpoint.vTabletIn.push(crumb.mobileIn);
                breakpoint.hTabletIn.push(crumb.mobileIn);
                breakpoint.mobileOut.push(crumb.mobileOut);
                breakpoint.vTabletOut.push(crumb.mobileOut);
                breakpoint.hTabletOut.push(crumb.mobileOut);

                breadcrumbCache.init({});
                return true;
            }
            return false;
        }

    };

    common.init.push(function () {
        if ($("#breadcrumb-v2").length > 0) {
            crumb.sBreadcrumbElementId = '#breadcrumb-v2';
        }
        crumb.init();
    });

    return crumb;
});

/*global define: true */
define('modules/navigation/common',['domlib', 'modules/common', 'modules/breakpoint', 'modules/overlay/common'], function($, common, breakpoint, overlay) {

	var navigation = {
		clickEvent: window.isKiosk() ? 'touchstart click' : 'tap click',
		// id of the current active secondary menu
		activeSecondaryID: '',
		// overlay/lightbox content width
		overlayWidth: 0,
		// string to create the id for the secondary menu (category id from list item data-id is appended)
		secondaryID: 'sub-menu-',
		// json category data
		categoryData: null,
		// jquery animate speed
		animSpeed: 500,

		getWrapperSelector: function() {
			return breakpoint.kiosk ? '#lightbox' : '#navigation';
		},
		getPrimarySelector: function() {
			return breakpoint.kiosk ? '#lightbox-content' : '#navigation > .wrapper';
		},

		setupPrimaryMenu: function(){
			var self = navigation;

			// wrap the existing content - treat as primary menu
			$( self.getPrimarySelector() ).wrapInner('<div id="main-menu" />');
			
			if (window.isKiosk()) {
				$('#main-menu .menu ul > li > a').on(navigation.clickEvent, function(e){				
					e.stopImmediatePropagation();
	
					// exit if the json data hasn't loaded
					if (!self.categoryData) {
						return;
					}
	
					e.preventDefault();
					
					var $item = $(this).parent('li');
	
					if (typeof self.categoryData[$item.data('id')] === 'object') {
						self.showSecondaryMenu($item);
					}
				});
			}
		},

		// slide out the secondary and slide in the primary
		showPrimaryMenu: function() {
			var self = navigation;
			var $primary = $('#main-menu');
			var $secondary = $('#' + self.activeSecondaryID);

			$secondary.animate({
				left: $( self.getWrapperSelector() ).outerWidth(),
				opacity: 0
			}, self.animSpeed);

			$primary.animate({
				left: 0,
				opacity: 1
			}, self.animSpeed);

			// as primary is now the view, adjust the overlay height to match
			self.updateOverlayHeight( $primary.outerHeight() );
		},

		// slide out the primary and slide in the secondary
		showSecondaryMenu: function($item) {
			var self = navigation;
			var $primary = $('#main-menu');
			var $secondary = $('#' + self.secondaryID + $item.data('id'));

			// check if the menu has already been created
			if (!$secondary.length) {
				$secondary = self.createSecondaryMenu($item);
			}

			$primary.animate({
				left: 0 - $( self.getWrapperSelector() ).outerWidth(),
				opacity: 0
			}, self.animSpeed);

			$secondary.animate({
				left: 0,
				opacity: 1
			}, self.animSpeed);

			// store the current/active secondary id
			self.activeSecondaryID = $secondary.attr('id');

			// as secondary is now the view, adjust the overlay height to match
			self.updateOverlayHeight( $secondary.outerHeight() );
		},

		createSecondaryMenu: function($item) {
			var self  = navigation;
			var data  = self.categoryData[$item.data('id')];
			var $menu = $( $('#tmplt-overlay-submenu').html().trim() );

			// update secondary menu properties
			$menu.attr('id', self.secondaryID + $item.data('id'));
			$menu.css('left', $( self.getWrapperSelector() ).outerWidth() );
			$menu.appendTo( $( self.getPrimarySelector() ) );


			// header
			$menu.find('.title h2').html(data.title);

			// if not kiosk, then allow the title to be clickable
			if (!breakpoint.kiosk) {
				$menu.find('.title h2').on('click', function(){
					$(this).prev('a.back').trigger('click');
				});
			}

			// view all button
			var $viewAll = $('.title .view-all', $menu);

			$viewAll.find('span').html(data.viewAll.label);
			$viewAll.data('url', data.viewAll.link).on('click', function(){
				document.location.href = $(this).data('url');
			});

			// back button
			$menu.find('.title > a.back').on(navigation.clickEvent, function(e){
				var self = navigation;
				e.preventDefault();
				e.stopPropagation();
				self.showPrimaryMenu();
			});

			// generate list
			var $list = $menu.find('ul');

			$(data.list).each(function(key, value){
				$list.append('<li><a href="' + value[1] + '"><span>' + value[0] + '</span></a></li>');
			});

			return $menu;
		},

		// adjust the overlay height to match the passed view size
		updateOverlayHeight: function( newHeight ){
			var self = navigation;

			$( self.getPrimarySelector() ).animate({
				height: newHeight + 1
			}, navigation.animSpeed);
		},

		jumpTo: function(position) {
			if (typeof jQuery !== 'undefined') {
				$('html, body').animate({
					scrollTop: position
				}, 500);
			} else {
				$(document).scrollTop( position );
			}
		},

		init: function init() {
			var self = navigation;

			if (!$('#navigation').length) {
				return;
			}
			
			/*Below code is to hide view-all-categories button when there are no popular cat navigation items from backend*/
			if(breakpoint.kiosk && $('#navigation').find('li').length > 0) {
				$('#view-all-categories').show();
			}
			
			if (breakpoint.kiosk) {
				$('#view-all-categories').on(navigation.clickEvent, function(e){
					e.preventDefault();
					e.stopImmediatePropagation();

					var content = $( $.trim( $('#tmplt-overlay').html() ) );
					
					content.filter('#lightbox-content').html( $.trim( $('#navigation').html() ) );
					content = content.wrapAll('<div />').parent().html();

					overlay.show({
						content: content
					});

					self.setupPrimaryMenu();
				});
			} else {
				self.setupPrimaryMenu();
			}

			$('#visual-nav .anchor .wrapper').on(navigation.clickEvent, function(e){
				e.preventDefault();
				e.stopImmediatePropagation();
				self.jumpTo( $('#navigation').offset().top );
				return false;
			});

			$('#navigation .anchor .wrapper').on(navigation.clickEvent, function(e){
				e.preventDefault();
				e.stopImmediatePropagation();
				if ($('#visual-nav').length) {
					self.jumpTo( $('#visual-nav').offset().top );
				}
				else {
					self.jumpTo( $('#page-container').offset().top );
				}
				return false;
			});
		}
	};

	breakpoint.mobileIn.push(navigation.init);
	breakpoint.vTabletIn.push(navigation.init);
	breakpoint.hTabletIn.push(navigation.init);
	breakpoint.desktopIn.push(navigation.init);
	breakpoint.largeDesktopIn.push(navigation.init);
	breakpoint.kioskIn.push(navigation.init);

	return navigation;
});
/*globals define,require,window */
/*jslint plusplus: true, regexp: true, unparam: true */
define('modules/smart-menu-hover/common', ['domlib', 'modules/breakpoint'], function ($, breakpoint) {
    'use strict';

    var SmartMenuHover = function SmartMenuHover(oConfig) {
        if (!oConfig || !oConfig.delegate || !oConfig.target || !oConfig.child || !oConfig.position.desktop) {
            return;
        }
        this.oSelectors = {
            delegate: oConfig.delegate,
            target: oConfig.target,
            child: oConfig.child
        };
        this.oElements = {
            parent: null,
            target: null,
            child: null,
            prevParent: null
        };
        this.oMenuPos = {
            desktop: oConfig.position.desktop,
            device: oConfig.position.device || oConfig.position.desktop
        };
        this.oAngles = {
            from: null,
            to: null
        };
        this.oStates = {
            advanced: oConfig.advanced || false,
            cursorPolling: false,
            menuOpened: false,
            mouseEntered: false,
            cursorSlowedEventBound: false,
            cursorAngleChangedEventBound: false
        };
        this.reset = oConfig.reset || null;

        if (this.reset !== null) {
            this.reset.event = oConfig.reset.event + '.smartMenuHover';
        }
    };

    SmartMenuHover.prototype.init = function () {
        this.bindEvents();

        if (this.reset !== null) {
            this.bindResetToConfigEvent();
        }
    };

    SmartMenuHover.prototype.bindEvents = function () {
        $(this.oSelectors.delegate).on('mouseenter.smartMenuHover', this.oSelectors.target, this.mouseEnter.bind(this))
            .on('mouseleave.smartMenuHover', this.oSelectors.target, this.mouseLeave.bind(this));
    };

    SmartMenuHover.prototype.bindResetToConfigEvent = function () {
        var self = this;

        $(self.reset.delegate).on(self.reset.event, self.resetStates.bind(self));
    };

    SmartMenuHover.prototype.resetStates = function (e) {
        this.oStates.menuOpened = false;
        this.oStates.mouseEntered = false;
        this.oStates.cursorSlowedEventBound = false;
        this.oStates.cursorAngleChangedEventBound = false;
    };

    SmartMenuHover.prototype.mouseEnter = function (e) {
        var self = this,
            $eventTarget = $(e.currentTarget),
            parentElem = $(e.currentTarget).closest('ul')[0];

        if (self.oStates.cursorAngleChangedEventBound === true) {
            return;
        }

        self.oElements.child = e.currentTarget.querySelectorAll(self.oSelectors.child)[0];

        window.CursorMovement.startPolling();
        self.oStates.cursorPolling = true;

        if (parentElem !== e.fromElement && parentElem.contains(e.fromElement) && self.oStates.menuOpened === true && self.oStates.advanced === true) {
            if (self.oStates.mouseEntered === false) {
                $eventTarget.trigger('smartMenuHover.mouseenter');
                self.oStates.mouseEntered = true;
                self.oStates.menuOpened = true;
            }
        } else {
            self.oStates.cursorSlowedEventBound = true;

            $(window).on('cursorMovement.slowed', function () {
                if (self.oStates.mouseEntered === false) {
                    $eventTarget.trigger('smartMenuHover.mouseenter');
                    self.oStates.mouseEntered = true;
                    self.oStates.menuOpened = true;
                }
            });
        }
    };

    SmartMenuHover.prototype.mouseLeave = function (e) {
        var self = this,
            prevTargetElem = e.currentTarget,
            toElement = e.toElement,
            toTargetElem,
            parentElem = $(e.currentTarget).closest('ul')[0],
            currentPositionElem;

        if (self.oStates.mouseEntered === false) {
            $(window).off('cursorMovement.slowed');
            self.oStates.cursorSlowedEventBound = false;
            window.CursorMovement.stopPolling();
            self.oStates.cursorPolling = false;
            return;
        }

        if (self.oStates.mouseEntered === true) {
            if (parentElem === toElement || parentElem.contains(toElement) === false || self.oElements.child === undefined || self.oStates.advanced === false) {
                $(prevTargetElem).trigger('smartMenuHover.mouseleave');
                self.oStates.mouseEntered = false;
                $(window).off('cursorMovement.slowed');
                self.oStates.cursorSlowedEventBound = false;
                window.CursorMovement.stopPolling();
                self.oStates.cursorPolling = false;
                return;
            }

            self.getCursorMoveArea();
            window.CursorMovement.setAngles(self.oAngles.from, self.oAngles.to);
            self.oStates.cursorAngleChangedEventBound = true;

            $(window).on('cursorMovement.angleChanged', function (e) {
                currentPositionElem = window.CursorMovement.getCurrentPositionElement();
                toTargetElem = $(currentPositionElem).closest(self.oSelectors.target)[0] || null;

                if (toTargetElem === null) {
                    return;
                }

                if (toTargetElem === prevTargetElem || prevTargetElem.contains(currentPositionElem)) {
                    self.oStates.cursorAngleChangedEventBound = false;
                    $(window).off('cursorMovement.angleChanged');
                    window.CursorMovement.unsetAngles();
                    return;
                }

                self.oStates.cursorAngleChangedEventBound = false;
                $(window).off('cursorMovement.angleChanged');
                window.CursorMovement.unsetAngles();
                $(prevTargetElem).trigger('smartMenuHover.mouseleave');
                $(toTargetElem).trigger('smartMenuHover.mouseenter');
            });
        }
    };

    SmartMenuHover.prototype.getCursorMoveArea = function () {
        var cursorPosY = window.CursorMovement.getPosition().y,
            cursorPosX = window.CursorMovement.getPosition().x,
            pos = this.getPointPositions(this.getElementCoordinates(this.oElements.child));

        this.oAngles.from = this.getAngleBetweenPoints(pos.to.y, cursorPosY, pos.to.x, cursorPosX);
        this.oAngles.to = this.getAngleBetweenPoints(pos.from.y, cursorPosY, pos.from.x, cursorPosX);
    };

    SmartMenuHover.prototype.getElementCoordinates = function (elem) {
        return elem.getBoundingClientRect();
    };

    SmartMenuHover.prototype.getPointPositions = function (elemRect) {
        var menuPos = breakpoint.desktop || breakpoint.largeDesktop ? this.oMenuPos.desktop : this.oMenuPos.device,
            posFrom,
            posTo;

        switch (menuPos) {
        case 'below':
            posFrom = {
                y: elemRect.top,
                x: elemRect.left
            };
            posTo = {
                y: elemRect.top,
                x: elemRect.right
            };
            break;
        case 'right':
            posTo = {
                y: elemRect.top,
                x: elemRect.left
            };
            posFrom = {
                y: elemRect.bottom,
                x: elemRect.left
            };
            break;
        }

        return {
            from: posFrom,
            to: posTo
        };
    };

    SmartMenuHover.prototype.getAngleBetweenPoints = function (farPosY, nearPosY, farPosX, nearPosX) {
        return Math.atan2(farPosY - nearPosY, farPosX - nearPosX) * 180 / Math.PI;
    };

    return SmartMenuHover;

});
/*globals define,require,window */
/*jslint plusplus: true, regexp: true, unparam: true */
define('modules/catalog-navigation/common', ['domlib', 'modules/breakpoint', 'modules/common', 'modules/smart-menu-hover/common', 'modules/mvc/fn'], function ($, breakpoint, common, SmartMenuHover, fn) {
    'use strict';

    var CatalogNavigation = function CatalogNavigation() {
        var pvInit,
            createJqueryObjects,
            setNoChildCategoriesDataAttr,
            bindEvents,
            initSmartMenuHoverObjs,
            bindBackLinkEvents,
            bindNavigationEvents,
            catalogNavigationCloseeEventsHandler,
            bindDepartmentEvents,
            departmentEventsDefaultHandler,
            departmentEventsMouseEnterHandler,
            departmentEventsMouseLeaveHandler,
            bindCategoryEvents,
            categoryEventsDefaultHandler,
            categoryEventsMouseEnterHandler,
            categoryEventsMouseLeaveHandler,
            openDepartment,
            closeDepartment,
            closeOpenDepartments,
            addDepartmentFlyoutImage,
            openCategory,
            closeCategory,
            closeOpenCategories,
            scrollToPosition,
            scrollToPositionHandler,

            oSELECTORS = {
                BACKLINK: '#catalogue-nav-back-link',
                MENULINK: '#catalogue-nav-link',
                MASTHEADWRAPPER: '#masthead-wrapper',
                CATNAV: '#catalogue-nav-wrapper',
                DEPARTMENTS: '#catalogue-nav ul.departments > li',
                CATEGORIES: '#catalogue-nav ul.categories-l1 > li',
                DEPARTMENTSLINK: '#catalogue-nav ul.departments > li > a',
                CATEGORIESLINK: '#catalogue-nav ul.categories-l1 > li > a'
            },
            oCSSCLASS = {
                CATEGORYOPEN: 'catNavCategoryOpen',
                DEPARTMENTOPEN: 'catNavDepartmentOpen',
                NAVIGATIONOPEN: 'catNavOpen',
                DROPDOWNOPEN: 'dropdownOpen',
                NOCHILDCATEGORIES: 'noChildCategories',
                CATEGORIESVISIBLE: 'categoriesVisible',
                SUBCATEGORIESVISIBLE: 'subCategoriesVisible'
            },
            oEVENTS = {
                CATEGORYOPENCOMPLETE: 'catalogNavigationCategoryOpenComplete',
                CATEGORYCLOSECOMPLETE: 'catalogNavigationCategoryCloseComplete',
                DEPARTMENTOPENCOMPLETE: 'catalogNavigationDepartmentOpenComplete',
                DEPARTMENTCLOSECOMPLETE: 'catalogNavigationDepartmentCloseComplete',
                NAVIGATIONOPENCOMPLETE: 'catalogNavigationOpenComplete',
                NAVIGATIONCLOSECOMPLETE: 'catalogNavigationCloseComplete',
                OPENNAVIGATIONDROPDOWN: 'openNavigationDropdown',
                CLOSENAVIGATIONDROPDOWN: 'closeNavigationDropdown',
                SCROLLTOTOP: 'catalogNavScrollToTop'
            },
            oJQUERYOBJS = {
                $CATNAV: null,
                $MASTHEADWRAPPER: null
            },
            oSmartMenuHovers = {
                departments: null,
                caregories: null
            },

            oTimeouts = {},
            bIsTouch = false,
            bindFlyoutImageEvents;

        pvInit = function pvInit(bForceTouch) {
            if ((window.isKiosk() && common.isPage('homepage')) === false) {
                if ($(oSELECTORS.CATNAV).length) {
                    bIsTouch = bForceTouch === true || window.isKiosk() ? true : common.isTouch();
                    createJqueryObjects();
                    setNoChildCategoriesDataAttr();
                    bindEvents();

                    if (bIsTouch === false) {
                        initSmartMenuHoverObjs();
                    }
                }
            }
        };

        createJqueryObjects = function createJqueryObjects() {
            oJQUERYOBJS.$MASTHEADWRAPPER = $(oSELECTORS.MASTHEADWRAPPER);
            oJQUERYOBJS.$CATNAV = $(oSELECTORS.CATNAV);
        };

        setNoChildCategoriesDataAttr = function setNoChildCategoriesDataAttr() {
            oJQUERYOBJS.$CATNAV.find('.has-no-category').data(oCSSCLASS.NOCHILDCATEGORIES, true);
        };

        bindEvents = function bindEvents() {
            var sEvent = 'click';
            if (!bIsTouch) {
                sEvent = 'hover';
            }
            bindBackLinkEvents(sEvent);
            bindNavigationEvents();
            bindDepartmentEvents(sEvent);
            bindCategoryEvents(sEvent);
            bindFlyoutImageEvents();
        };

        initSmartMenuHoverObjs = function initSmartMenuHoverObjs() {
            oSmartMenuHovers.departments = new SmartMenuHover({
                advanced: true,
                delegate: oSELECTORS.CATNAV,
                target: oSELECTORS.DEPARTMENTS,
                child: 'ul.categories-l1',
                position: {
                    desktop: 'below',
                    device: 'right'
                },
                reset: {
                    delegate: oSELECTORS.MASTHEADWRAPPER,
                    event: oEVENTS.NAVIGATIONCLOSECOMPLETE
                }
            });
            oSmartMenuHovers.departments.init();

            oSmartMenuHovers.caregories = new SmartMenuHover({
                advanced: true,
                delegate: oSELECTORS.CATNAV,
                target: oSELECTORS.CATEGORIES,
                child: 'ul.categories-l2',
                position: {
                    desktop: 'right',
                },
                reset: {
                    delegate: oSELECTORS.CATNAV,
                    event: oEVENTS.DEPARTMENTCLOSECOMPLETE
                }
            });
            oSmartMenuHovers.caregories.init();
        };

        bindBackLinkEvents = function bindBackLinkEvents(sEvent) {
            $(oSELECTORS.BACKLINK).on(sEvent, function bindBackLinkEventsHandler(e) {
                e.preventDefault();
                if ($(this).data(oCSSCLASS.CATEGORYOPEN) === true && $(this).data(oCSSCLASS.DEPARTMENTOPEN) === true) {
                    closeOpenCategories('nav', oJQUERYOBJS.$CATNAV, true);
                } else {
                    closeOpenDepartments('nav', oJQUERYOBJS.$CATNAV, true);
                }
            });
        };

        bindNavigationEvents = function bindNavigationEvents() {
            oJQUERYOBJS.$MASTHEADWRAPPER.on('catalogNavigationCloseComplete', catalogNavigationCloseeEventsHandler);
            oJQUERYOBJS.$MASTHEADWRAPPER.on(oEVENTS.SCROLLTOTOP, scrollToPositionHandler.bind(this));
        };

        catalogNavigationCloseeEventsHandler = function catalogNavigationCloseeEventsHandler() {
            closeOpenDepartments('nav', oJQUERYOBJS.$CATNAV, false);
        };

        scrollToPosition = function scrollToPosition(oArgs) {
            if (!oArgs || !oArgs.sScrollBaseElement) {
               return;
            }
            if (oArgs.iScrollBasePosition !== undefined && fn.isFalsy(oArgs.iScrollBasePosition)) {
              return;
            }
            $(oArgs.sScrollBaseElement).scrollTop(oArgs.iScrollBasePosition);
        };

        scrollToPositionHandler = function scrollToPositionHandler(oEvent, sElement, iPosition) {
            var oArgs = {};

            oArgs.sScrollBaseElement = sElement !== undefined ? sElement : null;
            oArgs.iScrollBasePosition = iPosition !== undefined && $.isNumeric(iPosition) ? iPosition : 0;

            if (oArgs.sScrollBaseElement !== null && $(oArgs.sScrollBaseElement).length > 0) {
                if ($(oArgs.sScrollBaseElement).scrollTop() > oArgs.iScrollBasePosition) {
                    scrollToPosition(oArgs);
                }
            }
        };

        bindDepartmentEvents = function bindDepartmentEvents(sEvent) {
            if (sEvent === 'click') {
                oJQUERYOBJS.$CATNAV.on(sEvent, oSELECTORS.DEPARTMENTSLINK, departmentEventsDefaultHandler.bind(this));
            } else {
                oJQUERYOBJS.$CATNAV.on('smartMenuHover.mouseenter', oSELECTORS.DEPARTMENTS, departmentEventsMouseEnterHandler.bind(this))
                    .on('smartMenuHover.mouseleave', oSELECTORS.DEPARTMENTS, departmentEventsMouseLeaveHandler.bind(this));
            }
        };

        departmentEventsDefaultHandler = function departmentEventsDefaultHandler(e) {
            var $department = $(e.target).parent('li');

            e.preventDefault();
            if ($department.data(oCSSCLASS.DEPARTMENTOPEN)) {
                if (breakpoint.desktop || breakpoint.largeDesktop) {
                    closeDepartment($department, true, true);
                } else {
                    closeDepartment($department, false, true);
                }
            } else {
                openDepartment($department);
            }
        };

        departmentEventsMouseEnterHandler = function departmentEventsMouseEnterHandler(e) {
            if ($(e.target).is(oSELECTORS.DEPARTMENTS)) {
                clearTimeout(oTimeouts.closeDepartment);
                openDepartment($(e.currentTarget));
            }
        };

        departmentEventsMouseLeaveHandler = function departmentEventsMouseLeaveHandler(e) {
            var eventCurrentTarget = e.currentTarget;

            if ($(e.target).is(oSELECTORS.DEPARTMENTS)) {
                oTimeouts.closeDepartment = setTimeout(function () {
                    if (breakpoint.desktop || breakpoint.largeDesktop) {
                        closeDepartment($(eventCurrentTarget), true, true);
                    } else {
                        closeDepartment($(eventCurrentTarget), false, true);
                    }
                }, 599);
            }
        };

        bindCategoryEvents = function bindCategoryEvents(sEvent) {
            if (sEvent === 'click') {
                oJQUERYOBJS.$CATNAV.on(sEvent, oSELECTORS.CATEGORIESLINK, categoryEventsDefaultHandler.bind(this));
                $('#catalogue-nav').on(sEvent, '.flyout-image img', function (e) {
                	   window.location.href = e.target.getAttribute('href');
                });
            } else {
                oJQUERYOBJS.$CATNAV.on('smartMenuHover.mouseenter', oSELECTORS.CATEGORIES, categoryEventsMouseEnterHandler.bind(this))
                    .on('smartMenuHover.mouseleave', oSELECTORS.CATEGORIES, categoryEventsMouseLeaveHandler.bind(this));
            }
        };

        categoryEventsDefaultHandler = function categoryEventsDefaultHandler(e) {
            var $category = $(e.target).parent('li');

            if ($category.data(oCSSCLASS.NOCHILDCATEGORIES) !== true) {
                e.preventDefault();
                if ($category.data(oCSSCLASS.CATEGORYOPEN)) {
                    closeCategory($category, true);
                } else {
                    openCategory($category);
                }
            }
        };

        categoryEventsMouseEnterHandler = function categoryEventsMouseEnterHandler(e) {
            if ($(e.target).is(oSELECTORS.CATEGORIES)) {
                clearTimeout(oTimeouts.closeCategory);
                openCategory($(e.currentTarget));
            }
        };

        categoryEventsMouseLeaveHandler = function categoryEventsMouseLeaveHandler(e) {
            var eventCurrentTarget = e.currentTarget;

            if ($(e.target).is(oSELECTORS.CATEGORIES)) {
                oTimeouts.closeCategory = setTimeout(function () {
                    closeCategory($(eventCurrentTarget), true);
                }, 300);
            }
        };

        openDepartment = function openDepartment($department) {
            var $categoryList = $department.children('ul');

            $categoryList.addClass(oCSSCLASS.CATEGORIESVISIBLE);

            if (oJQUERYOBJS.$CATNAV.data(oCSSCLASS.DEPARTMENTOPEN) === true) {
                closeOpenDepartments('dep', $department, false);
            }

            if (breakpoint.desktop || breakpoint.largeDesktop || window.isKiosk()) {
                addDepartmentFlyoutImage($department);
            }

            $department.addClass(oCSSCLASS.DEPARTMENTOPEN)
                .data(oCSSCLASS.DEPARTMENTOPEN, true);
            oJQUERYOBJS.$CATNAV.addClass(oCSSCLASS.DEPARTMENTOPEN)
                .data(oCSSCLASS.DEPARTMENTOPEN, true)
                .trigger(oEVENTS.DEPARTMENTOPENCOMPLETE);
            $(oSELECTORS.BACKLINK).addClass(oCSSCLASS.DEPARTMENTOPEN)
                .data(oCSSCLASS.DEPARTMENTOPEN, true);

            if (breakpoint.mobile || breakpoint.vTablet || breakpoint.hTablet) {
                oJQUERYOBJS.$MASTHEADWRAPPER.trigger(oEVENTS.SCROLLTOTOP, [oSELECTORS.CATNAV, 0]);
            }
            if (breakpoint.desktop || breakpoint.largeDesktop) {
                if (oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.NAVIGATIONOPEN) !== true) {
                    oJQUERYOBJS.$MASTHEADWRAPPER.trigger(oEVENTS.OPENNAVIGATIONDROPDOWN);
                }
            }
        };

        closeDepartment = function closeDepartment($department, bCloseNav, bTransition) {
            var $categoryList = $department.children('ul');

            if (window.isKiosk()) {
                bTransition = false;
            }

            if (bTransition) {
                if (bCloseNav) {
                    $categoryList.removeClass(oCSSCLASS.CATEGORIESVISIBLE);
                } else {
                    if (window.Modernizr.csstransitions) {
                        $categoryList.one('transitionend', function () {
                            $categoryList.removeClass(oCSSCLASS.CATEGORIESVISIBLE);
                        });
                    } else {
                        $categoryList.removeClass(oCSSCLASS.CATEGORIESVISIBLE);
                    }
                }
            } else {
                $categoryList.removeClass(oCSSCLASS.CATEGORIESVISIBLE);
            }

            closeOpenCategories('dep', $department, false);

            $department.removeClass(oCSSCLASS.DEPARTMENTOPEN)
                .data(oCSSCLASS.DEPARTMENTOPEN, false);
            oJQUERYOBJS.$CATNAV.removeClass(oCSSCLASS.DEPARTMENTOPEN)
                .data(oCSSCLASS.DEPARTMENTOPEN, false)
                .trigger(oEVENTS.DEPARTMENTCLOSECOMPLETE);
            $(oSELECTORS.BACKLINK).removeClass(oCSSCLASS.DEPARTMENTOPEN)
                .data(oCSSCLASS.DEPARTMENTOPEN, false);

            if (breakpoint.desktop || breakpoint.largeDesktop) {
                if (bCloseNav) {
                    oJQUERYOBJS.$MASTHEADWRAPPER.trigger(oEVENTS.CLOSENAVIGATIONDROPDOWN);
                }
            }
        };

        addDepartmentFlyoutImage = function addDepartmentFlyoutImage($department) {
            var $flyoutImage = $department.find('.flyout-image'),
                sImageTag = '<img></img>',
                sUrl,
                sHref;

            if ($flyoutImage.length > 0 && $flyoutImage.data('srcimg') !== false) {
                sUrl = $flyoutImage.data('srcimg');
                sHref = $flyoutImage.data('url');
                $flyoutImage[0].innerHTML = sImageTag;
                $flyoutImage.find('img')
                    .attr('src', sUrl)
                    .attr('href', sHref);
                $flyoutImage.data('srcimg', false);
            }
        };

        closeOpenDepartments = function closeOpenDepartments(sKey, $selector, bTransition) {
            var $department;

            if (sKey === 'nav') {
                $department = oJQUERYOBJS.$CATNAV.find('li.catNavDepartmentOpen');
            } else {
                $department = $selector.siblings('li.catNavDepartmentOpen');
            }

            if ($department.length === 1) {
                closeDepartment($department, false, bTransition);
            } else if ($department.length > 1) {
                $department.each(function () {
                    closeDepartment($(this), false, bTransition);
                });
            }
        };

        openCategory = function openCategory($category) {
            var $subCategory = $category.children('ul');
            $subCategory.addClass(oCSSCLASS.SUBCATEGORIESVISIBLE);

            if (oJQUERYOBJS.$CATNAV.data(oCSSCLASS.CATEGORYOPEN) === true) {
                closeOpenCategories('cat', $category, false);
            }

            $category.addClass(oCSSCLASS.CATEGORYOPEN)
                .data(oCSSCLASS.CATEGORYOPEN, true);
            oJQUERYOBJS.$CATNAV.addClass(oCSSCLASS.CATEGORYOPEN)
                .data(oCSSCLASS.CATEGORYOPEN, true)
                .trigger(oEVENTS.CATEGORYOPENCOMPLETE);
            $(oSELECTORS.BACKLINK).addClass(oCSSCLASS.CATEGORYOPEN)
                .data(oCSSCLASS.CATEGORYOPEN, true);

            if (breakpoint.mobile || breakpoint.vTablet || breakpoint.hTablet) {
                oJQUERYOBJS.$MASTHEADWRAPPER.trigger(oEVENTS.SCROLLTOTOP, [oSELECTORS.CATNAV, 0]);
            }
        };

        closeCategory = function closeCategory($category, bTransition) {
            var $subCategory = $category.children('ul');

            if (bTransition) {
                if (window.Modernizr.csstransitions) {
                    oJQUERYOBJS.$CATNAV.one('transitionend', function () {
                        $subCategory.removeClass(oCSSCLASS.SUBCATEGORIESVISIBLE);
                    });
                } else {
                    $subCategory.removeClass(oCSSCLASS.SUBCATEGORIESVISIBLE);
                }
            } else {
                $subCategory.removeClass(oCSSCLASS.SUBCATEGORIESVISIBLE);
            }

            $category.removeClass(oCSSCLASS.CATEGORYOPEN)
                .data(oCSSCLASS.CATEGORYOPEN, false);
            oJQUERYOBJS.$CATNAV.removeClass(oCSSCLASS.CATEGORYOPEN)
                .data(oCSSCLASS.CATEGORYOPEN, false)
                .trigger(oEVENTS.CATEGORYCLOSECOMPLETE);
            $(oSELECTORS.BACKLINK).removeClass(oCSSCLASS.CATEGORYOPEN)
                .data(oCSSCLASS.CATEGORYOPEN, false);
        };

        closeOpenCategories = function closeOpenCategories(sKey, $selector, bTransition) {
            var $category;

            if (sKey === 'dep' || sKey === 'nav') {
                $category = $selector.find('li.catNavCategoryOpen');
            } else {
                $category = $selector.siblings('li.catNavCategoryOpen');
            }

            if ($category.length === 1) {
                closeCategory($category, bTransition);
            } else if ($category.length > 1) {
                $category.each(function () {
                    closeCategory($(this), bTransition);
                });
            }
        };

        bindFlyoutImageEvents = function bindFlyoutImageEvents() {
            if (oJQUERYOBJS.$CATNAV.length) {
                oJQUERYOBJS.$CATNAV.on('click', '.flyout-image img', function (e) {
                    var sImageHREF = $(e.target).attr('href');
                    if (sImageHREF) {
                        window.location.href = sImageHREF;
                    }
                });
            }
        };

        return {
            init: function init(bForceTouch) {
                pvInit(bForceTouch);
            }
        };

    };

    return CatalogNavigation;

});

/*globals define,require,window */
/*jslint plusplus: true, regexp: true, unparam: true */
define('modules/catalog-navigation/init', ['modules/catalog-navigation/common', 'modules/common'], function (CatalogNavigation, common) {
    'use strict';

    var oCatalogNavigation = new CatalogNavigation();
    common.init.push(function () {
        oCatalogNavigation.init();
    });
});
/* globals define,require,window,document,setTimeout,clearTimeout */
/* jslint plusplus: true, regexp: true, unparam: true */
define('modules/fixed-header/common', ['domlib', 'modules/breakpoint', 'modules/common', 'modules/smart-menu-hover/common'], function ($, breakpoint, common, SmartMenuHover) {
  'use strict';

  var FixedHeader = function FixedHeader() {
    var pvInit,
      bindEvents,
      toggleHeaderVisibility,
      slideUp,
      slideDown,
      reloadBasketBadge,
      initSmartMenuHoverObjs,
      createJqueryObjs,
      bindInputFocusEvents,
      inputFocusFixedPositionFix,
      removeHeaderFixedPosition,
      addHeaderFixedPosition,
      slideHeaderUpOutOfView,
      slideHeaderDownIntoView,
      findActiveDropdown,
      findActiveScrollPane,
      measureElements,
      resetMeasurements,
      bindWindowResizeEvents,
      bindBreakpointChangeEvent,
      bindScrollEvents,
      calcWindowScrollTop,
      setUnsetHeaderScrollingClass,
      setUnsetHeaderHideNavClass,
      bindNavigationDropdownEvents,
      fixedHeaderNavigationOpenDropdownEventsHandler,
      fixedHeaderNavigationCloseDropdownEventsHandler,
      bindSearchifyDropdownEvents,
      fixedHeaderSearchifyOpenDropdownEventsHandler,
      fixedHeaderSearchifyCloseDropdownEventsHandler,
      bindSearchbarEvents,
      searchbarKeyupEventHandler,
      searchbarFocusEventHandler,
      searchifyscrollEventsHandler,
      closeOpenDropdownsOnSearchFocus,
      searchbarBlurEventHandler,
      searchbarTouchstartEventHandler,
      searchCloseLinkEventHandler,
      searchbarIOSFocusScrollTopFix,
      enableDisableSearchSubmitButton,
      resizeSearchDropdown,
      resetSearchDropdownHeight,
      closeSearchifyDropdownOnEmptyInput,
      addFocusToSearchInputField,
      removeFocusFromSearchInputField,
      slideUpHeaderOnSearchFocus,
      slideDownHeaderOnSearchBlur,
      resizeSearchDropdownOnHidingKeyboard,
      emptySearchInput,
      bindParentLinkEvents,
      parentLinkEventDefaultHandler,
      searchLinkTouchstartEventHandler,
      parentLinkEventMouseEnterHandler,
      parentLinkEventMouseLeaveHandler,
      openDropdown,
      closeDropdown,
      returnClassFromLinkID,
      returnEventFromLinkID,
      closeOpenDropdown,
      loadBasketContent,
      addBasketLoader,
      removeBasketLoader,
      injectBasketContent,
      removeBasketContent,
      calcBasketFlyoutHeights,
      setBasketFlyoutHeight,
      unsetBasketFlyoutHeight,
      setBasketContentHeight,
      unsetBasketContentHeight,
      setBasketContentScroll,
      unsetBasketContentScroll,
      enableBackgroundMask,
      addBackgroundMaskOpacity,
      disableBackgroundMask,
      removeBackgroundMaskOpacity,
      bindBackgroundMaskEvents,
      setFixedHeaderStyles,
      unsetFixedHeaderStyles,
      setCategoryListItemAlignmentFix,
      unsetCategoryListItemAlignmentFix,
      setSearchWrapperHeightFix,
      unsetSearchWrapperHeightFix,
      setFixedHeaderBottomClass,
      unsetFixedHeaderBottomClass,
      setFixedHeaderScrollPaneHeights,
      setFixedHeaderBasketContentHeight,
      unsetFixedHeaderScrollPaneHeights,
      pvAsyncBlockCallbacks,
      deferAsyncCallbackHandler,
      bindRecentlyViewedEvents,
      scrollToRecentlyViewed,
      searchbarSubmitHandler,
      updateBasketBadge,

      oSELECTORS = {
        WRAPPER: '#wrapper',
        HEADER: '#header',
        MASTHEADWRAPPER: '#masthead-wrapper',
        MASTHEAD: '#masthead',
        MENUSEARCHFLYOUTS: '.menu-search-header-flyouts > li',
        ACCOUNTBASKETFLYOUTS: '.account-basket-header-flyouts > li',
        PARENTLINK: '.parent-header-link',
        DROPDOWN: '.header-dropdown',
        MENULINK: '#catalogue-nav-link',
        CATNAV: '#catalogue-nav-wrapper',
        CATNAVBACKLINK: '#catalogue-nav-back-link',
        SEARCHLINK: '#search-link',
        SEARCHWRAPPER: '#search-wrapper',
        SEARCHCLOSELINK: '.search-close-link',
        RESULTSWRAPPER: '#search-results-wrapper',
        SEARCHINPUT: '#search-field',
        SEARCHSUBMIT: '#search-submit',
        ACCOUNTLINK: '#account-link',
        RECENTLYVIEWEDLINK: '.recently-viewed > a',
        RECENTLYVIEWED: '#recently-viewed',
        BASKETLINK: '#basket-link',
        BASKETFLYOUT: '#basket-flyout-menu',
        BASKETCONTENTSWRAPPER: '.basket-flyout-contents-wrapper',
        BASKETCONTENTS: '.basket-flyout-contents',
        BASKETFOOTERWRAPPER: '.basket-flyout-footer-wrapper',
        PAGEMASK: '#page-background-mask',
        SEARCHFORM: '#search-wrapper form',
        BASKETITEMSBADGE: '.basket-items',
        BASKETMENUTITLE: '.menu-title'
      },
      oJQUERYOBJS = {
        $WRAPPER: null,
        $HTML: null,
        $BODY: null,
        $HEADER: null,
        $MASTHEADWRAPPER: null,
        $MASTHEAD: null,
        $PARENTLINK: null,
        $MENULINK: null,
        $CATNAV: null,
        $SEARCHLINK: null,
        $SEARCHWRAPPER: null,
        $SEARCHINPUT: null,
        $SEARCHSUBMIT: null,
        $ACCOUNTLINK: null,
        $BASKETLINK: null,
        $BASKETFLYOUT: null,
        $PAGEMASK: null,
        $SEARCHFORM: null
      },
      oCSSCLASS = {
        TEXTINPUTINFOCUS: 'textInputInFocus',
        OUTOFVIEWTRANSENABLED: 'outOfViewTransEnabled',
        HEADEROUTOFVIEW: 'headerOutOfView',
        DROPDOWNOPEN: 'dropdownOpen',
        CATNAVOPEN: 'catNavOpen',
        SEARCHBAROPEN: 'searchBarOpen',
        ACCOUNTFLYOUTOPEN: 'accountFlyoutOpen',
        BASKETFLYOUTOPEN: 'basketFlyoutOpen',
        BASKETCONTENTSCROLLABLE: 'basketContentScrollable',
        PAGEMASKVISIBLE: 'pageMaskVisible',
        PAGEMASKOPACITY: 'pageMaskOpacity',
        PAGESCROLLING: 'pageScrolling',
        HIDECATNAV: 'hideCatNav',
        FIXHEADERTOBOTTOM: 'fixHeaderToBottom',
        DISABLEBODYSCROLL: 'disableBodyScroll',
        SCROLLTORECENTLYVIEWED: 'scrollToRecentlyViewed',
        BASKETCONTENTLOADING: 'basketContentLoading',
        DISABLED: 'disabled'
      },
      oEVENTS = {
        DROPDOWNOPENSTART: 'dropdownOpenStart',
        DROPDOWNOPENCOMPLETE: 'dropdownOpenComplete',
        DROPDOWNCLOSESTART: 'dropdownCloseStart',
        DROPDOWNCLOSECOMPLETE: 'dropdownCloseComplete',
        NAVIGATIONOPENCOMPLETE: 'catalogNavigationOpenComplete',
        NAVIGATIONCLOSECOMPLETE: 'catalogNavigationCloseComplete',
        SEARCHBAROPENCOMPLETE: 'searchBarOpenComplete',
        SEARCHBARCLOSECOMPLETE: 'searchBarCloseComplete',
        ACCOUNTFLYOUTOPENCOMPLETE: 'accountFlyoutOpenComplete',
        ACCOUNTFLYOUTCLOSECOMPLETE: 'accountFlyoutCloseComplete',
        BASKETFLYOUTOPENCOMPLETE: 'basketFlyoutOpenComplete',
        BASKETFLYOUTCLOSECOMPLETE: 'basketFlyoutCloseComplete'
      },
      oMeasurements = {
        windowHeight: null,
        windowScrollTop: null,
        windowScrollTo: null,
        mastheadHeight: null,
        catNatHeight: null,
        dropdownHeight: null,
        activeScrollPaneOffsetTop: null,
        basketContentsWrapperHeight: null,
        basketFooterWrapperHeight: null,
        recentlyViewedOffsetTop: null
      },
      oTimeouts = {},
      $activeDropdown = null,
      $activeScrollPane = null,
      sFlyoutBasketContentJspURL = null,
      sEventState = 'click',
      bIsTouch = false,
      bIsLegacyPage = false,
      bIsSearchFocus = false,
      bBasketLoaderVisible = false,
      bIsIOS = false,
      bIsHeaderFixed = true,
      isMastheadVisible = true,
      oEvents = {
        slideUp: 'mastheadSlideUp',
        slideDown: 'mastheadSlideDown'
      };

    pvInit = function pvInit(bForceTouch) {
      if ($(oSELECTORS.MASTHEADWRAPPER).length > 0 && $('#wrapper.checkout').length === 0 && $('#wrapper.order-confirmation').length === 0) {
        bIsTouch = bForceTouch === true || window.isKiosk() ? true : common.isTouch();
        bIsLegacyPage = common.isPage('legacy');
        bIsIOS = common.isIOS();
        createJqueryObjs();
        sFlyoutBasketContentJspURL = oJQUERYOBJS.$BASKETLINK.data('flyoutbasketcontenturl');
        $(oSELECTORS.RECENTLYVIEWEDLINK).addClass(oCSSCLASS.DISABLED);
        bindEvents();
        deferAsyncCallbackHandler();
        measureElements(true);

        if (bIsTouch === false) {
          initSmartMenuHoverObjs();
        }

      }
    };

    bindEvents = function bindEvents() {
      if (!bIsTouch) {
        sEventState = 'hover';
      }
      if (!window.isKiosk()) {
        bindScrollEvents();
        bindInputFocusEvents();
      }
      if ((window.isKiosk() && common.isPage('homepage')) === false) {
        bindNavigationDropdownEvents();
        bindWindowResizeEvents();
        bindBreakpointChangeEvent();
        bindRecentlyViewedEvents();
        bindParentLinkEvents();
      }
      bindBackgroundMaskEvents();
      bindSearchifyDropdownEvents();
      bindSearchbarEvents();

      $(window).on(oEvents.slideUp, toggleHeaderVisibility.bind(this))
                .on(oEvents.slideDown, toggleHeaderVisibility.bind(this))
                .on('addToBasketSuccess', updateBasketBadge.bind(this))
                .on('reloadBasketFlyoutBadge', reloadBasketBadge.bind(this));
    };

    toggleHeaderVisibility = function fnToggleHeaderVisibility(e) {
      if (e.type === oEvents.slideUp) {
        slideUp();
      } else if (e.type === oEvents.slideDown) {
        slideDown();
      }
    };

    slideUp = function fnSlideUp() {
      oJQUERYOBJS.$MASTHEADWRAPPER.addClass(oCSSCLASS.OUTOFVIEWTRANSENABLED)
                .addClass(oCSSCLASS.HEADEROUTOFVIEW);

      isMastheadVisible = false;
    };

    slideDown = function fnSlideDown() {
      oJQUERYOBJS.$MASTHEADWRAPPER.removeClass(oCSSCLASS.HEADEROUTOFVIEW);
      oJQUERYOBJS.$MASTHEADWRAPPER.on('transitionend.slideDown', function (e) {
        oJQUERYOBJS.$MASTHEADWRAPPER.addClass(oCSSCLASS.OUTOFVIEWTRANSENABLED);
        oJQUERYOBJS.$MASTHEADWRAPPER.off('transitionend.slideDown');
      });

      isMastheadVisible = true;
    };

    reloadBasketBadge = function fnReloadBasketBadge() {
      $.ajax({
        url: '/direct/blocks/common/flyoutBasketLink.jsp'
      }).done(function (mData, sTextStatus, oJqXHR) {
        $(oSELECTORS.BASKETLINK)[0].outerHTML = mData;
      });
    };

    initSmartMenuHoverObjs = function initSmartMenuHoverObjs() {
      var oSmartMenuHovers = new SmartMenuHover({
        advanced: false,
        delegate: oSELECTORS.MASTHEADWRAPPER,
        target: oSELECTORS.ACCOUNTBASKETFLYOUTS,
        child: oSELECTORS.DROPDOWN,
        position: {
          desktop: 'below'
        }
      });
      oSmartMenuHovers.init();
    };

    createJqueryObjs = function createJqueryObjs() {
      oJQUERYOBJS.$HTML = $('html');
      oJQUERYOBJS.$BODY = $('body');
      oJQUERYOBJS.$WRAPPER = $(oSELECTORS.WRAPPER);
      oJQUERYOBJS.$HEADER = $(oSELECTORS.HEADER);
      oJQUERYOBJS.$MASTHEADWRAPPER = $(oSELECTORS.MASTHEADWRAPPER);
      oJQUERYOBJS.$MASTHEAD = $(oSELECTORS.MASTHEAD);
      oJQUERYOBJS.$MENULINK = $(oSELECTORS.MENULINK);
      oJQUERYOBJS.$CATNAV = $(oSELECTORS.CATNAV);
      oJQUERYOBJS.$SEARCHLINK = $(oSELECTORS.SEARCHLINK);
      oJQUERYOBJS.$SEARCHWRAPPER = $(oSELECTORS.SEARCHWRAPPER);
      oJQUERYOBJS.$SEARCHINPUT = $(oSELECTORS.SEARCHINPUT);
      oJQUERYOBJS.$SEARCHSUBMIT = $(oSELECTORS.SEARCHSUBMIT);
      oJQUERYOBJS.$ACCOUNTLINK = $(oSELECTORS.ACCOUNTLINK);
      oJQUERYOBJS.$BASKETLINK = $(oSELECTORS.BASKETLINK);
      oJQUERYOBJS.$PAGEMASK = $(oSELECTORS.PAGEMASK);
      oJQUERYOBJS.$SEARCHFORM = $(oSELECTORS.SEARCHFORM);
    };

    bindInputFocusEvents = function bindInputFocusEvents() {
      var sInputTypes = 'input[type="text"], input[type="password"], input[type="email"], input[type="tel"]';

      oJQUERYOBJS.$WRAPPER.on('focus.inputFocusFixedPositionFix', sInputTypes, inputFocusFixedPositionFix)
                .on('blur.inputFocusFixedPositionFix', sInputTypes, inputFocusFixedPositionFix);
    };

    inputFocusFixedPositionFix = function inputFocusFixedPositionFix(e) {
      if (!isMastheadVisible || $(e.currentTarget)[0].id === 'search-field'
                || ((breakpoint.largeDesktop || breakpoint.desktop) && bIsIOS === false)) {
        return false;
      }

      if (e.type === 'focusin') {
        if (bIsIOS === true) {
          removeHeaderFixedPosition();
        } else {
          slideHeaderUpOutOfView();
        }
      } else if (e.type === 'focusout') {
        if (bIsIOS === true) {
          addHeaderFixedPosition();
        } else {
          slideHeaderDownIntoView();
        }
      }
    };

    removeHeaderFixedPosition = function removeHeaderFixedPosition() {
      if (bIsHeaderFixed === true) {
        oJQUERYOBJS.$MASTHEADWRAPPER.addClass(oCSSCLASS.TEXTINPUTINFOCUS);
        bIsHeaderFixed = false;
      }
    };

    addHeaderFixedPosition = function addHeaderFixedPosition() {
      if (bIsHeaderFixed === false) {
        oJQUERYOBJS.$MASTHEADWRAPPER.removeClass(oCSSCLASS.TEXTINPUTINFOCUS);
        bIsHeaderFixed = true;
      }
    };

    slideHeaderUpOutOfView = function slideHeaderUpOutOfView() {
      if (bIsHeaderFixed === true) {
        if (oMeasurements.windowScrollTop < oMeasurements.mastheadHeight) {
          oJQUERYOBJS.$MASTHEADWRAPPER.addClass(oCSSCLASS.HEADEROUTOFVIEW)
                        .addClass(oCSSCLASS.TEXTINPUTINFOCUS);

          bIsHeaderFixed = false;
          return;
        }

        if (window.Modernizr.csstransitions === true) {
          oJQUERYOBJS.$MASTHEADWRAPPER.one('transitionend', function () {
            oJQUERYOBJS.$MASTHEADWRAPPER.addClass(oCSSCLASS.TEXTINPUTINFOCUS);
          });
        }

        oJQUERYOBJS.$MASTHEADWRAPPER.addClass(oCSSCLASS.OUTOFVIEWTRANSENABLED)
                    .addClass(oCSSCLASS.HEADEROUTOFVIEW);

        if (window.Modernizr.csstransitions !== true) {
          oJQUERYOBJS.$MASTHEADWRAPPER.addClass(oCSSCLASS.TEXTINPUTINFOCUS);
        }

        bIsHeaderFixed = false;
      }
    };

    slideHeaderDownIntoView = function slideHeaderDownIntoView() {
      if (bIsHeaderFixed === false) {
        if (oMeasurements.windowScrollTop < oMeasurements.mastheadHeight) {
          oJQUERYOBJS.$MASTHEADWRAPPER.removeClass(oCSSCLASS.OUTOFVIEWTRANSENABLED)
                        .removeClass(oCSSCLASS.TEXTINPUTINFOCUS)
                        .removeClass(oCSSCLASS.HEADEROUTOFVIEW);

          bIsHeaderFixed = true;
          return;
        }

        if (window.Modernizr.csstransitions === true) {
          oJQUERYOBJS.$MASTHEADWRAPPER.one('transitionend', function () {
            oJQUERYOBJS.$MASTHEADWRAPPER.removeClass(oCSSCLASS.OUTOFVIEWTRANSENABLED);
          });
        }

        oJQUERYOBJS.$MASTHEADWRAPPER.removeClass(oCSSCLASS.TEXTINPUTINFOCUS)
                    .removeClass(oCSSCLASS.HEADEROUTOFVIEW);

        if (window.Modernizr.csstransitions !== true) {
          oJQUERYOBJS.$MASTHEADWRAPPER.removeClass(oCSSCLASS.OUTOFVIEWTRANSENABLED);
        }

        bIsHeaderFixed = true;
      }
    };

    findActiveDropdown = function findActiveDropdown() {
      $activeDropdown = $(oSELECTORS.DROPDOWN).filter('.dropdownOpen');
    };

    findActiveScrollPane = function findActiveScrollPane() {
      if (oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.CATNAVOPEN) === true) {
        if (breakpoint.desktop || breakpoint.largeDesktop) {
          $activeScrollPane = $('.header-dropdown.dropdownOpen .fixedHeaderScrollPaneDesktop');
        } else {
          $activeScrollPane = $('.header-dropdown.dropdownOpen.fixedHeaderScrollPaneDevices');
        }
      } else {
        $activeScrollPane = $('.header-dropdown.dropdownOpen .fixedHeaderScrollPane');
      }
    };

    measureElements = function measureElements(isViewChange) {
      oMeasurements.mastheadHeight = oJQUERYOBJS.$MASTHEADWRAPPER.outerHeight(true) - oJQUERYOBJS.$CATNAV.outerHeight(true);
      oJQUERYOBJS.$MASTHEADWRAPPER.data('outerHeight', oMeasurements.mastheadHeight);

      if (isViewChange) {
        oMeasurements.catNatHeight = oJQUERYOBJS.$CATNAV.outerHeight(true);
      } else {
        oMeasurements.windowScrollTop = calcWindowScrollTop();
        oMeasurements.windowHeight = window.innerHeight || document.documentElement.clientHeight;
        oMeasurements.dropdownHeight = $activeDropdown.outerHeight(true) + $activeDropdown.offset().top - oMeasurements.windowScrollTop;
        oMeasurements.activeScrollPaneOffsetTop = $activeScrollPane.offset().top - oMeasurements.windowScrollTop;
      }
    };

    resetMeasurements = function resetMeasurements() {
      var prop;
      for (prop in oMeasurements) {
        if (oMeasurements.hasOwnProperty(prop)) {
          prop = null;
        }
      }
    };

    bindWindowResizeEvents = function bindWindowResizeEvents(e) {
      $(window).on('resize', function fixedHeaderWindowResizeEventsHandler(e) {
        setTimeout(function () {
          resizeSearchDropdownOnHidingKeyboard();
        }, 400);
      });
    };

    bindBreakpointChangeEvent = function bindBreakpointChangeEvent(e) {
      $(window).on('breakpointChange', function breakpointChangeHandler(e) {
        closeOpenDropdown(false);
        emptySearchInput();
        if (oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.PAGEMASKVISIBLE) === true) {
          disableBackgroundMask();
        }
        resetMeasurements();
        setTimeout(function () {
          measureElements(true);
        }, 300);
      });
    };

    bindScrollEvents = function bindScrollEvents() {
      if (!common.isBrowserIE()) {
        $(document).on('scroll.bindFixedHeaderScrollEventsHandler', function bindFixedHeaderScrollEventsHandler(e) {
          setTimeout(function fixedHeaderScrollHandlerInt() {
            oMeasurements.windowScrollTop = calcWindowScrollTop();
            setUnsetHeaderScrollingClass();
            if (breakpoint.desktop || breakpoint.largeDesktop) {
              setUnsetHeaderHideNavClass();
            }
          }, 0);
        });
      }
    };

    calcWindowScrollTop = function calWindowScrollTop() {
      return $(window).scrollTop();
    };

    setUnsetHeaderScrollingClass = function setUnsetHeaderScrollingClass() {
      if (oMeasurements.windowScrollTop > 1) {
        oJQUERYOBJS.$MASTHEADWRAPPER.addClass(oCSSCLASS.PAGESCROLLING)
                    .data(oCSSCLASS.PAGESCROLLING, true);
      } else {
        if (oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.FIXHEADERTOBOTTOM) !== true) {
          oJQUERYOBJS.$MASTHEADWRAPPER.removeClass(oCSSCLASS.PAGESCROLLING)
                        .data(oCSSCLASS.PAGESCROLLING, false);
        }
      }
    };

    setUnsetHeaderHideNavClass = function setUnsetHeaderHideNavClass() {
      if (oJQUERYOBJS.$CATNAV.data(oCSSCLASS.CATNAVOPEN) !== true) {
        if (oMeasurements.windowScrollTop > oMeasurements.catNatHeight) {
          oJQUERYOBJS.$MASTHEADWRAPPER.addClass(oCSSCLASS.HIDECATNAV)
                        .data(oCSSCLASS.HIDECATNAV, true);
          oJQUERYOBJS.$CATNAV.addClass(oCSSCLASS.HIDECATNAV);
        } else {
          if (oJQUERYOBJS.$BODY.data(oCSSCLASS.DISABLEBODYSCROLL) !== true || bIsLegacyPage === true) {
            oJQUERYOBJS.$MASTHEADWRAPPER.removeClass(oCSSCLASS.HIDECATNAV)
                            .data(oCSSCLASS.HIDECATNAV, false);
            oJQUERYOBJS.$CATNAV.removeClass(oCSSCLASS.HIDECATNAV);
          }
        }
      }
    };

    bindParentLinkEvents = function bindParentLinkEvents() {
      if (sEventState === 'click') {
        oJQUERYOBJS.$MASTHEADWRAPPER.on(sEventState, oSELECTORS.PARENTLINK, parentLinkEventDefaultHandler.bind(this))
                    .on('touchstart.searchLinkTouchstartEventHandler', oSELECTORS.SEARCHLINK, searchLinkTouchstartEventHandler);
      } else {
        oJQUERYOBJS.$MASTHEADWRAPPER.on('click', oSELECTORS.PARENTLINK, parentLinkEventDefaultHandler.bind(this))
                    .on('mouseenter', oSELECTORS.MENUSEARCHFLYOUTS, parentLinkEventMouseEnterHandler.bind(this))
                    .on('mouseleave', oSELECTORS.MENUSEARCHFLYOUTS, parentLinkEventMouseLeaveHandler.bind(this))
                    .on('smartMenuHover.mouseenter', oSELECTORS.ACCOUNTBASKETFLYOUTS, parentLinkEventMouseEnterHandler.bind(this))
                    .on('smartMenuHover.mouseleave', oSELECTORS.ACCOUNTBASKETFLYOUTS, parentLinkEventMouseLeaveHandler.bind(this));
      }
    };

    parentLinkEventDefaultHandler = function parentLinkEventDefaultHandler(e) {
      var $dropdown = $(e.currentTarget).siblings(oSELECTORS.DROPDOWN);

      e.preventDefault();

      if (sEventState === 'hover') {
        return;
      }

      if ($dropdown.data(oCSSCLASS.DROPDOWNOPEN) === true) {
        closeDropdown($(e.currentTarget), $dropdown, true);

        if ($(e.currentTarget)[0].id === 'search-link') {
          removeFocusFromSearchInputField();
        }
      } else {
        if ($(e.currentTarget)[0].id === 'basket-link') {
          loadBasketContent($(e.currentTarget), $dropdown);
        } else {
          openDropdown($(e.currentTarget), $dropdown);
        }

        if ($(e.currentTarget)[0].id === 'search-link') {
          addFocusToSearchInputField();
        }
      }
    };

    searchLinkTouchstartEventHandler = function searchLinkTouchstartEventHandler() {
      searchbarIOSFocusScrollTopFix();
    };

    parentLinkEventMouseEnterHandler = function parentLinkEventMouseEnterHandler(e) {
      var $link = $(e.currentTarget).children(oSELECTORS.PARENTLINK),
        $dropdown = $(e.currentTarget).children(oSELECTORS.DROPDOWN);

      if (breakpoint.desktop || breakpoint.largeDesktop) {
        if ($link[0].id === 'basket-link' || $link[0].id === 'account-link') {
          clearTimeout(oTimeouts.closeDropdown);

          if ($link[0].id === 'basket-link') {
            loadBasketContent($link, $dropdown);
          } else if ($link[0].id === 'account-link') {
            openDropdown($link, $dropdown);
          }
        }
      } else {
        clearTimeout(oTimeouts.closeDropdown);

        if ($link[0].id === 'basket-link') {
          loadBasketContent($link, $dropdown);
        } else {
          openDropdown($link, $dropdown);
        }
      }
    };

    parentLinkEventMouseLeaveHandler = function parentLinkEventMouseLeaveHandler(e) {
      var $link = $(e.currentTarget).children(oSELECTORS.PARENTLINK),
        $dropdown = $(e.currentTarget).children(oSELECTORS.DROPDOWN);

      if (breakpoint.desktop || breakpoint.largeDesktop) {
        if ($link[0].id === 'basket-link' || $link[0].id === 'account-link') {
          oTimeouts.closeDropdown = setTimeout(function () {
            closeDropdown($link, $dropdown, true);
          }, 300);
        }
      } else {
        oTimeouts.closeDropdown = setTimeout(function () {
          closeDropdown($link, $dropdown, true);
        }, 600);
      }
    };

    bindNavigationDropdownEvents = function bindNavigationDropdownEvents() {
      oJQUERYOBJS.$MASTHEADWRAPPER.on('openNavigationDropdown', fixedHeaderNavigationOpenDropdownEventsHandler)
                .on('closeNavigationDropdown', fixedHeaderNavigationCloseDropdownEventsHandler);
    };

    fixedHeaderNavigationOpenDropdownEventsHandler = function fixedHeaderNavigationOpenDropdownEventsHandler(e) {
      openDropdown($(oSELECTORS.MENULINK), oJQUERYOBJS.$CATNAV);
    };

    fixedHeaderNavigationCloseDropdownEventsHandler = function fixedHeaderNavigationCloseDropdownEventsHandler(e) {
      closeDropdown($(oSELECTORS.MENULINK), oJQUERYOBJS.$CATNAV, true);
    };

    bindSearchifyDropdownEvents = function bindSearchbarDropdownEvents() {
      oJQUERYOBJS.$MASTHEADWRAPPER.on('openSearchifyDropdown', fixedHeaderSearchifyOpenDropdownEventsHandler)
                .on('closeSearchifyDropdown', fixedHeaderSearchifyCloseDropdownEventsHandler);
    };

    fixedHeaderSearchifyOpenDropdownEventsHandler = function fixedHeaderSearchifyOpenDropdownEventsHandler(e) {
      if (oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.SEARCHBAROPEN) !== true) {
        openDropdown($(oSELECTORS.SEARCHLINK), oJQUERYOBJS.$SEARCHWRAPPER);
        resizeSearchDropdown();
      }
    };

    fixedHeaderSearchifyCloseDropdownEventsHandler = function fixedHeaderSearchifyCloseDropdownEventsHandler(e) {
      if (breakpoint.desktop || breakpoint.largeDesktop || window.isKiosk()) {
        closeDropdown($(oSELECTORS.SEARCHLINK), oJQUERYOBJS.$SEARCHWRAPPER, true);
      } else {
        if (oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.FIXHEADERTOBOTTOM) === true) {
          unsetFixedHeaderStyles('search-link');
        }
        resetSearchDropdownHeight();
      }
    };

    bindSearchbarEvents = function bindSearchbarEvents() {
      oJQUERYOBJS.$MASTHEADWRAPPER.on('keyup.searchbarKeyupEventHandler', oSELECTORS.SEARCHINPUT, searchbarKeyupEventHandler)
                .on('focus.searchbarFocusEventHandler', oSELECTORS.SEARCHINPUT, searchbarFocusEventHandler)
                .on('blur.searchbarBlurEventHandler', oSELECTORS.SEARCHINPUT, searchbarBlurEventHandler)
                .on('touchstart.searchbarTouchstartEventHandler', oSELECTORS.SEARCHINPUT, searchbarTouchstartEventHandler)
                .on('click.searchCloseLinkEventHandler', oSELECTORS.SEARCHCLOSELINK, searchCloseLinkEventHandler);
      $(oSELECTORS.RESULTSWRAPPER).on('touchstart.searchifyscrollEventsHandler', searchifyscrollEventsHandler);
      oJQUERYOBJS.$SEARCHFORM.on('submit.searchbarSubmitHandler', searchbarSubmitHandler);
    };

    searchbarSubmitHandler = function searchbarSubmitHandler(e) {
      if ($.trim(oJQUERYOBJS.$SEARCHINPUT.val()) === '') {
        e.preventDefault();
      }
    };

    searchbarKeyupEventHandler = function searchbarKeyupEventHandler() {
      resizeSearchDropdown();
      closeSearchifyDropdownOnEmptyInput();
    };

    searchbarFocusEventHandler = function searchbarFocusEventHandler(e) {
      closeOpenDropdownsOnSearchFocus();
      bIsSearchFocus = true;
    };

    searchbarBlurEventHandler = function searchbarBlurEventHandler() {
      bIsSearchFocus = false;
    };

    searchbarTouchstartEventHandler = function searchbarTouchstartEventHandler() {
      searchbarIOSFocusScrollTopFix();
    };

    searchCloseLinkEventHandler = function searchCloseLinkEventHandler(e) {
      e.preventDefault();
      closeDropdown($(oSELECTORS.SEARCHLINK), $(oSELECTORS.SEARCHWRAPPER), true);
    };

    searchifyscrollEventsHandler = function searchifyscrollEventsHandler() {
      if (oJQUERYOBJS.$SEARCHWRAPPER.data('searchifyOpen') === true) {
        if (bIsSearchFocus === true) {
          removeFocusFromSearchInputField();
        }
      }
    };

    searchbarIOSFocusScrollTopFix = function searchbarIOSFocusScrollTopFix() {
      if (bIsIOS === true && bIsSearchFocus === false) {
        window.scrollTo(0, 1);
      }
    };

    resizeSearchDropdown = function resizeSearchDropdown() {
      var iSearchBarHeight = 70;
      if (breakpoint.desktop || breakpoint.largeDesktop) {
        iSearchBarHeight = 28;
      } else if (breakpoint.mobile) {
        iSearchBarHeight = 52;
      }

      if (oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.FIXHEADERTOBOTTOM) !== true) {
        setTimeout(function () {
          if (window.Modernizr.csstransitions === true) {
            oJQUERYOBJS.$SEARCHWRAPPER.one('transitionend', function () {
              setFixedHeaderStyles('search-link');
            });
          }

          if (oJQUERYOBJS.$MASTHEADWRAPPER.data('searchifyOpen') === true && oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.SEARCHBAROPEN) === true) {
            oJQUERYOBJS.$SEARCHWRAPPER.outerHeight($(oSELECTORS.RESULTSWRAPPER).outerHeight(true) + iSearchBarHeight);
          }

          if (window.Modernizr.csstransitions !== true) {
            setFixedHeaderStyles('search-link');
          }
        }, 300);
      }
    };

    resetSearchDropdownHeight = function resetSearchDropdownHeight() {
      oJQUERYOBJS.$SEARCHWRAPPER.attr('style', '');
    };

    closeOpenDropdownsOnSearchFocus = function closeOpenDropdownsOnSearchFocus() {
      bIsSearchFocus = true;
      if (breakpoint.desktop || breakpoint.largeDesktop || window.isKiosk()) {
        if (oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.DROPDOWNOPEN) === true && oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.SEARCHBAROPEN) !== true) {
          if (oJQUERYOBJS.$SEARCHINPUT.val() === '') {
            closeOpenDropdown(true);
          }
        }
      }
    };

    enableDisableSearchSubmitButton = function enableDisableSearchSubmitButton() {
      if ($.trim(oJQUERYOBJS.$SEARCHINPUT.val()) !== '') {
        oJQUERYOBJS.$SEARCHSUBMIT.prop('disabled', false);
      } else {
        oJQUERYOBJS.$SEARCHSUBMIT.prop('disabled', true);
      }
    };

    closeSearchifyDropdownOnEmptyInput = function closeSearchifyDropdownOnEmptyInput() {
      if ($.trim(oJQUERYOBJS.$SEARCHINPUT.val()) === '') {
        oJQUERYOBJS.$MASTHEADWRAPPER.trigger('closeSearchifyDropdown');
      }
    };

    addFocusToSearchInputField = function addFocusToSearchInputField() {
      oJQUERYOBJS.$SEARCHINPUT.focus();
      bIsSearchFocus = true;
    };


    removeFocusFromSearchInputField = function removeFocusFromSearchInputField() {
      oJQUERYOBJS.$SEARCHINPUT.blur();
      bIsSearchFocus = false;
    };

    slideUpHeaderOnSearchFocus = function slideUpHeaderOnSearchFocus() {
      if (!(breakpoint.desktop || breakpoint.largeDesktop || window.isKiosk())) {
        oJQUERYOBJS.$MASTHEADWRAPPER.addClass(oCSSCLASS.OUTOFVIEWTRANSENABLED)
                    .addClass(oCSSCLASS.HEADEROUTOFVIEW);
      }
    };

    slideDownHeaderOnSearchBlur = function slideDownHeaderOnSearchBlur() {
      if (!(breakpoint.desktop || breakpoint.largeDesktop || window.isKiosk())) {
        if (window.Modernizr.csstransitions === true) {
          oJQUERYOBJS.$MASTHEADWRAPPER.one('transitionend', function () {
            oJQUERYOBJS.$MASTHEADWRAPPER.removeClass(oCSSCLASS.OUTOFVIEWTRANSENABLED);
          });
        }

        oJQUERYOBJS.$MASTHEADWRAPPER.removeClass(oCSSCLASS.HEADEROUTOFVIEW);

        if (window.Modernizr.csstransitions !== true) {
          oJQUERYOBJS.$MASTHEADWRAPPER.removeClass(oCSSCLASS.OUTOFVIEWTRANSENABLED);
        }
      }
    };

    resizeSearchDropdownOnHidingKeyboard = function resizeSearchDropdownOnHidingKeyboard() {
      var iLatestWindowHeight = $(window).height();

      if (oJQUERYOBJS.$MASTHEADWRAPPER.data('searchifyOpen') === true) {
        if (iLatestWindowHeight > oMeasurements.windowHeight) {
          oMeasurements.windowHeight = iLatestWindowHeight;
          setFixedHeaderScrollPaneHeights();
        }
      }
    };

    emptySearchInput = function emptySearchInput() {
      oJQUERYOBJS.$SEARCHINPUT.val('');
    };

    openDropdown = function openDropdown($link, $dropdown) {
      var bDropdownOpen = false,
        sLinkID = $link[0].id;

      if (oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.DROPDOWNOPEN) === true) {
        bDropdownOpen = true;
      }

      if (bDropdownOpen) {
        closeOpenDropdown(false);
      }

      if (sLinkID === 'search-link') {
        slideUpHeaderOnSearchFocus();
      }

      if (window.Modernizr.csstransitions === true) {
        $dropdown.one('transitionend', function () {
          oJQUERYOBJS.$MASTHEADWRAPPER.trigger(oEVENTS.DROPDOWNOPENCOMPLETE);
          oJQUERYOBJS.$MASTHEADWRAPPER.trigger(returnEventFromLinkID(sLinkID, 'opened'));

          if (sLinkID !== 'search-link' && sLinkID !== 'basket-link') {
            setFixedHeaderStyles(sLinkID);
          }

          if (!bDropdownOpen) {
            addBackgroundMaskOpacity();
          }
        });
      }

      $link.addClass(oCSSCLASS.DROPDOWNOPEN);
      $dropdown.addClass(oCSSCLASS.DROPDOWNOPEN)
                .data(oCSSCLASS.DROPDOWNOPEN, true);
      oJQUERYOBJS.$MASTHEADWRAPPER.addClass(oCSSCLASS.DROPDOWNOPEN)
                .addClass(returnClassFromLinkID(sLinkID))
                .data(oCSSCLASS.DROPDOWNOPEN, true)
                .data(returnClassFromLinkID(sLinkID), true);

      if (!bDropdownOpen) {
        enableBackgroundMask();
      }

      if (window.Modernizr.csstransitions !== true) {
        oJQUERYOBJS.$MASTHEADWRAPPER.trigger(oEVENTS.DROPDOWNOPENCOMPLETE);
        oJQUERYOBJS.$MASTHEADWRAPPER.trigger(returnEventFromLinkID(sLinkID, 'opened'));

        if (sLinkID !== 'search-link' && sLinkID !== 'basket-link') {
          setFixedHeaderStyles(sLinkID);
        }

        if (!bDropdownOpen) {
          addBackgroundMaskOpacity();
        }
      }
    };

    closeDropdown = function closeDropdown($link, $dropdown, bCloseMask) {
      var sLinkID = $link[0].id;

      oJQUERYOBJS.$MASTHEADWRAPPER.trigger(oEVENTS.DROPDOWNCLOSESTART);

      if (bBasketLoaderVisible === true) {
        removeBasketLoader();
      }

      if (sLinkID === 'search-link') {
        slideDownHeaderOnSearchBlur();
      }

      if (window.Modernizr.csstransitions === true) {
        $dropdown.one('transitionend', function () {
          oJQUERYOBJS.$MASTHEADWRAPPER.trigger(oEVENTS.DROPDOWNCLOSECOMPLETE);
          oJQUERYOBJS.$MASTHEADWRAPPER.trigger(returnEventFromLinkID(sLinkID, 'closed'));

          if (sLinkID === 'basket-link') {
            if ($(oSELECTORS.BASKETFLYOUT).data(oCSSCLASS.BASKETCONTENTSCROLLABLE) === true) {
              unsetBasketContentHeight();
              unsetBasketContentScroll();
            }
            removeBasketContent();
          } else if (sLinkID === 'search-link') {
            if (!(breakpoint.desktop || breakpoint.largeDesktop || window.isKiosk())) {
              emptySearchInput();
              oJQUERYOBJS.$MASTHEADWRAPPER.removeClass(oCSSCLASS.HEADEROUTOFVIEW)
                                .removeClass(oCSSCLASS.OUTOFVIEWTRANSENABLED);
            }
          }

          if (bCloseMask) {
            removeBackgroundMaskOpacity();
          }
        });
      }

      if (oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.FIXHEADERTOBOTTOM) === true) {
        unsetFixedHeaderStyles(sLinkID);
      }

      $link.removeClass(oCSSCLASS.DROPDOWNOPEN);
      $dropdown.removeClass(oCSSCLASS.DROPDOWNOPEN)
                .data(oCSSCLASS.DROPDOWNOPEN, false);
      oJQUERYOBJS.$MASTHEADWRAPPER.removeClass(oCSSCLASS.DROPDOWNOPEN)
                .removeClass(returnClassFromLinkID(sLinkID))
                .data(oCSSCLASS.DROPDOWNOPEN, false)
                .data(returnClassFromLinkID(sLinkID), false);

      if (sLinkID === 'basket-link') {
        unsetBasketFlyoutHeight();
      } else if (sLinkID === 'search-link') {
        resetSearchDropdownHeight();
      }

      if (window.Modernizr.csstransitions !== true) {
        oJQUERYOBJS.$MASTHEADWRAPPER.trigger(oEVENTS.DROPDOWNCLOSECOMPLETE);
        oJQUERYOBJS.$MASTHEADWRAPPER.trigger(returnEventFromLinkID(sLinkID, 'closed'));

        if (sLinkID === 'basket-link') {
          if ($(oSELECTORS.BASKETFLYOUT).data(oCSSCLASS.BASKETCONTENTSCROLLABLE) === true) {
            unsetBasketContentHeight();
            unsetBasketContentScroll();
          }
          removeBasketContent();
        } else if (sLinkID === 'search-link') {
          if (!(breakpoint.desktop || breakpoint.largeDesktop || window.isKiosk())) {
            emptySearchInput();
          }
        }

        if (bCloseMask) {
          removeBackgroundMaskOpacity();
        }
      }
    };

    returnClassFromLinkID = function returnClassFromLinkID(sLinkID) {
      var sClass;

      if (sLinkID === 'search-link') {
        sClass = oCSSCLASS.SEARCHBAROPEN;
      } else if (sLinkID === 'catalogue-nav-link') {
        sClass = oCSSCLASS.CATNAVOPEN;
      } else if (sLinkID === 'account-link') {
        sClass = oCSSCLASS.ACCOUNTFLYOUTOPEN;
      } else if (sLinkID === 'basket-link') {
        sClass = oCSSCLASS.BASKETFLYOUTOPEN;
      }

      return sClass;
    };

    returnEventFromLinkID = function returnEventFromLinkID(sLinkID, sState) {
      var sEvent;

      if (sState === 'opened') {
        if (sLinkID === 'search-link') {
          sEvent = oEVENTS.SEARCHBAROPENCOMPLETE;
        } else if (sLinkID === 'catalogue-nav-link') {
          sEvent = oEVENTS.NAVIGATIONOPENCOMPLETE;
        } else if (sLinkID === 'account-link') {
          sEvent = oEVENTS.ACCOUNTFLYOUTOPENCOMPLETE;
        } else if (sLinkID === 'basket-link') {
          sEvent = oEVENTS.BASKETFLYOUTOPENCOMPLETE;
        }
      } else {
        if (sLinkID === 'search-link') {
          sEvent = oEVENTS.SEARCHBARCLOSECOMPLETE;
        } else if (sLinkID === 'catalogue-nav-link') {
          sEvent = oEVENTS.NAVIGATIONCLOSECOMPLETE;
        } else if (sLinkID === 'account-link') {
          sEvent = oEVENTS.ACCOUNTFLYOUTCLOSECOMPLETE;
        } else if (sLinkID === 'basket-link') {
          sEvent = oEVENTS.BASKETFLYOUTCLOSECOMPLETE;
        }
      }

      return sEvent;
    };

    closeOpenDropdown = function closeOpenDropdown(bCloseMask) {
      var $link,
        $dropdown;

      $link = $(oSELECTORS.PARENTLINK).filter(function () {
        return $(this).hasClass(oCSSCLASS.DROPDOWNOPEN);
      });
      $dropdown = $link.siblings(oSELECTORS.DROPDOWN);

      if ($link.length) {
        closeDropdown($link, $dropdown, bCloseMask);

        if ($link[0].id === 'search-link' && sEventState !== 'hover') {
          removeFocusFromSearchInputField();
        }
      }
    };

    loadBasketContent = function loadBasketContent($link, $dropdown) {
      addBasketLoader();
      openDropdown($link, $dropdown);
      $.ajax({
        url: sFlyoutBasketContentJspURL,
        success: function success(response) {
          injectBasketContent(response);
          calcBasketFlyoutHeights();
          setBasketFlyoutHeight();
          removeBasketLoader();
          if (oMeasurements.basketContentsWrapperHeight > 560) {
            setBasketContentHeight();
            setBasketContentScroll();
          }
          setTimeout(function () {
            setFixedHeaderStyles($link[0].id);
          }, 300);

        }
      });
    };

    addBasketLoader = function addBasketLoader() {
      $(oSELECTORS.BASKETFLYOUT).addClass(oCSSCLASS.BASKETCONTENTLOADING);
      bBasketLoaderVisible = true;
    };

    removeBasketLoader = function removeBasketLoader() {
      $(oSELECTORS.BASKETFLYOUT).removeClass(oCSSCLASS.BASKETCONTENTLOADING);
      bBasketLoaderVisible = false;
    };

    injectBasketContent = function injectBasketContent(response) {
      $(oSELECTORS.BASKETFLYOUT).append(response);
    };

    removeBasketContent = function removeBasketContent() {
      $(oSELECTORS.BASKETCONTENTSWRAPPER).remove();
    };

    calcBasketFlyoutHeights = function calcBasketFlyoutHeights() {
      oMeasurements.basketContentsWrapperHeight = $(oSELECTORS.BASKETCONTENTSWRAPPER).outerHeight(true);
      oMeasurements.basketFooterWrapperHeight = $(oSELECTORS.BASKETFOOTERWRAPPER).outerHeight(true);
    };

    setBasketFlyoutHeight = function setBasketFlyoutHeight() {
      var iBasketFlyoutHeight = oMeasurements.basketContentsWrapperHeight > 560 ? 560 : oMeasurements.basketContentsWrapperHeight;
      $(oSELECTORS.BASKETFLYOUT).outerHeight(iBasketFlyoutHeight);
    };

    unsetBasketFlyoutHeight = function unsetBasketFlyoutHeight() {
      $(oSELECTORS.BASKETFLYOUT).attr('style', '');
    };

    setBasketContentHeight = function setBasketContentHeight(iHeight) {
      var iBaseHeight = iHeight || 560,
        iBasketContentsHeight = iBaseHeight - oMeasurements.basketFooterWrapperHeight;

      $(oSELECTORS.BASKETCONTENTS).outerHeight(iBasketContentsHeight - 3);
    };

    unsetBasketContentHeight = function unsetBasketContentHeight() {
      $(oSELECTORS.BASKETCONTENT).attr('style', '');
    };

    setBasketContentScroll = function setBasketContentScroll() {
      $(oSELECTORS.BASKETFLYOUT).addClass(oCSSCLASS.BASKETCONTENTSCROLLABLE)
                .data(oCSSCLASS.BASKETCONTENTSCROLLABLE, true);
    };

    unsetBasketContentScroll = function unsetBasketContentScroll() {
      if ($(oSELECTORS.BASKETFLYOUT).data(oCSSCLASS.BASKETCONTENTSCROLLABLE) === true) {
        $(oSELECTORS.BASKETFLYOUT).removeClass(oCSSCLASS.BASKETCONTENTSCROLLABLE)
                    .data(oCSSCLASS.BASKETCONTENTSCROLLABLE, false);
      }
    };

    enableBackgroundMask = function enableBackgroundMask() {
      oJQUERYOBJS.$PAGEMASK.addClass(oCSSCLASS.PAGEMASKVISIBLE);

      if (oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.CATNAVOPEN) === true && (breakpoint.desktop || breakpoint.largeDesktop || window.isKiosk())) {
        oJQUERYOBJS.$PAGEMASK.addClass(oCSSCLASS.CATNAVOPEN);
      }
    };

    addBackgroundMaskOpacity = function addBackgroundMaskOpacity() {
      oJQUERYOBJS.$PAGEMASK.addClass(oCSSCLASS.PAGEMASKOPACITY);
      oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.PAGEMASKVISIBLE, true);
    };

    removeBackgroundMaskOpacity = function removeBackgroundMaskOpacity() {
      oJQUERYOBJS.$PAGEMASK.removeClass(oCSSCLASS.PAGEMASKOPACITY);

      if (window.Modernizr.csstransitions === true) {
        oJQUERYOBJS.$PAGEMASK.one('transitionend', function () {
          if (oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.DROPDOWNOPEN) !== true) {
            disableBackgroundMask();
          }
          if (oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.SCROLLTORECENTLYVIEWED) === true) {
            scrollToRecentlyViewed();
          }
        });
      }

      if (window.Modernizr.csstransitions !== true) {
        if (oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.DROPDOWNOPEN) !== true) {
          disableBackgroundMask();
        }
        if (oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.SCROLLTORECENTLYVIEWED) === true) {
          scrollToRecentlyViewed();
        }
      }
    };

    disableBackgroundMask = function disableBackgroundMask() {
      oJQUERYOBJS.$PAGEMASK.removeClass(oCSSCLASS.PAGEMASKVISIBLE)
                .removeClass(oCSSCLASS.CATNAVOPEN);

      oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.PAGEMASKVISIBLE, false);
    };

    bindBackgroundMaskEvents = function bindBackgroundMaskEvents() {
      oJQUERYOBJS.$PAGEMASK.on('click.bindBackgroundMaskEventsHandler', function bindBackgroundMaskEventsHandler(e) {
        closeOpenDropdown(true);
      });
    };

    setFixedHeaderStyles = function setFixedHeaderStyles(sLinkID) {
      findActiveDropdown();
      if ($activeDropdown.length) {
        findActiveScrollPane();
        measureElements();

        if (oMeasurements.dropdownHeight >= oMeasurements.windowHeight) {
          if (sLinkID === 'basket-link' && $(oSELECTORS.BASKETFLYOUT).data(oCSSCLASS.BASKETCONTENTSCROLLABLE) !== true) {
            setBasketContentHeight(oMeasurements.windowHeight - oMeasurements.activeScrollPaneOffsetTop);
            setBasketContentScroll();
          }

          setFixedHeaderBottomClass();
          setFixedHeaderScrollPaneHeights();
          setCategoryListItemAlignmentFix(sLinkID);
          setSearchWrapperHeightFix(sLinkID);
        }
      }
    };

    unsetFixedHeaderStyles = function unsetFixedHeaderStyles(sLinkID) {
      unsetFixedHeaderBottomClass();
      unsetFixedHeaderScrollPaneHeights();
      unsetCategoryListItemAlignmentFix(sLinkID);
      unsetSearchWrapperHeightFix(sLinkID);
    };

    setCategoryListItemAlignmentFix = function setCategoryListItemAlignmentFix(sLinkID) {
      if (sLinkID === 'catalogue-nav-link' && (breakpoint.desktop || breakpoint.largeDesktop)) {
        $('#catalogue-nav ul.categories-l1 > li').css('margin-right', '-1px');
      }
    };

    unsetCategoryListItemAlignmentFix = function unsetCategoryListItemAlignmentFix(sLinkID) {
      if (sLinkID === 'catalogue-nav-link' && (breakpoint.desktop || breakpoint.largeDesktop)) {
        $('#catalogue-nav ul.categories-l1 > li').css('margin-right', '');
      }
    };

    setSearchWrapperHeightFix = function setSearchWrapperHeightFix(sLinkID) {
      var iSearchWrapperHeight = '600px';

      if (sLinkID === 'search-link') {
        if (breakpoint.desktop || breakpoint.largeDesktop) {
          iSearchWrapperHeight = '550px';
        }

        oJQUERYOBJS.$SEARCHWRAPPER.css('height', iSearchWrapperHeight);
      }
    };

    unsetSearchWrapperHeightFix = function unsetSearchWrapperHeightFix(sLinkID) {
      if (sLinkID === 'search-link') {
        oJQUERYOBJS.$SEARCHWRAPPER.css('height', '');
      }
    };

    setFixedHeaderBottomClass = function setFixedHeaderBottomClass() {
      oJQUERYOBJS.$MASTHEADWRAPPER.addClass(oCSSCLASS.FIXHEADERTOBOTTOM)
                .data(oCSSCLASS.FIXHEADERTOBOTTOM, true);
    };

    unsetFixedHeaderBottomClass = function unsetFixedHeaderBottomClass() {
      oJQUERYOBJS.$MASTHEADWRAPPER.removeClass(oCSSCLASS.FIXHEADERTOBOTTOM)
                .data(oCSSCLASS.FIXHEADERTOBOTTOM, false);
    };

    setFixedHeaderScrollPaneHeights = function setFixedHeaderScrollPaneHeights() {
      var iNewScrollPaneHeight = oMeasurements.windowHeight - oMeasurements.activeScrollPaneOffsetTop;

      $activeScrollPane.outerHeight(iNewScrollPaneHeight - 1);

      if (!(breakpoint.desktop || breakpoint.largeDesktop)) {
        if (oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.CATNAVOPEN) === true) {
          $(oSELECTORS.CATNAVBACKLINK).outerHeight(iNewScrollPaneHeight - 1);
        }
      }

      if (oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.BASKETFLYOUTOPEN) === true) {
        setFixedHeaderBasketContentHeight(iNewScrollPaneHeight);
      }
    };

    setFixedHeaderBasketContentHeight = function setFixedHeaderBasketContentHeight(iNewScrollPaneHeight) {
      oMeasurements.basketFooterWrapperHeight = $(oSELECTORS.BASKETFOOTERWRAPPER).outerHeight(true);

      $(oSELECTORS.BASKETCONTENTS).outerHeight(iNewScrollPaneHeight - oMeasurements.basketFooterWrapperHeight - 2);
    };

    unsetFixedHeaderScrollPaneHeights = function unsetFixedHeaderScrollPaneHeights() {
      $activeScrollPane.attr('style', '');

      if (oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.CATNAVOPEN) === true) {
        $(oSELECTORS.CATNAVBACKLINK).attr('style', '');
      }
    };

    deferAsyncCallbackHandler = function deferAsyncCallbackHandler() {
      if (window.AsyncBlockController.deferDefaultCall()) {
        $(oSELECTORS.ACCOUNTLINK).one('click mouseenter', function deferredDropDownHandler(e) {
          e.preventDefault();
          e.stopPropagation();
          if (window.AsyncBlockController.deferDefaultCall()) {
            $(window).trigger(window.AsyncBlockController.getDeferredEventName());
            $(window).one(window.AsyncBlockController.getCompleteEventName(),
            function deferredDropDownTriggerHandler() {
              /*
              Wrapped in setTimeout as the success callback from AsyncBlockController is
              referencing a mobule with the default almond 4ms delay
               */
              setTimeout(function () {
                $(oSELECTORS.ACCOUNTLINK).trigger('click');
              }, 10);
            });
          } else {
            $(oSELECTORS.ACCOUNTLINK).trigger('click');
          }
        });
      }
      if (window.AsyncBlockController.deferDefaultCall()) {
        $(oSELECTORS.BASKETLINK).one('click', function deferredBasketDropDownHandler(e) {
          e.preventDefault();
          e.stopPropagation();
          if (window.AsyncBlockController.deferDefaultCall()) {
            $(window).trigger(window.AsyncBlockController.getDeferredEventName());
            $(window).one(window.AsyncBlockController.getCompleteEventName(),
            function deferredDropDownTriggerHandler() {
              setTimeout(function () {
                $(oSELECTORS.BASKETLINK).trigger('click');
              }, 10);
            });
          } else {
            $(oSELECTORS.BASKETLINK).trigger('click');
          }
        });
      }
    };

    pvAsyncBlockCallbacks = function pvAsyncBlockCallbacks() {
      var oCallbacks = {};

      oCallbacks.success = function (oResp) {
        if (typeof oResp === 'string') {
          oResp = $.parseJSON(oResp);
        }
        $('#asyncTopMenuHolder').replaceWith(oResp[this.sBlockID]);
        if (oResp.RVI) {
          $(oSELECTORS.RECENTLYVIEWEDLINK).removeClass(oCSSCLASS.DISABLED);
        }
      };
      return oCallbacks;
    };

    bindRecentlyViewedEvents = function bindRecentlyViewedEvents() {
      if ($(oSELECTORS.RECENTLYVIEWED).length) {
        $(oSELECTORS.RECENTLYVIEWEDLINK).removeClass(oCSSCLASS.DISABLED);
      }
      oJQUERYOBJS.$MASTHEADWRAPPER.on('click.recentlyViewedEventsHandler', oSELECTORS.RECENTLYVIEWEDLINK, function recentlyViewedEventsHandler(e) {
        e.preventDefault();
        if ($(e.currentTarget).hasClass(oCSSCLASS.DISABLED)) {
          return;
        }
        oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.SCROLLTORECENTLYVIEWED, true);
        closeOpenDropdown(true);
      });
    };

    scrollToRecentlyViewed = function scrollToRecentlyViewed() {
      var iMastheadHeight = oMeasurements.mastheadHeight,
        iScrollTo = $(oSELECTORS.RECENTLYVIEWED).offset().top - iMastheadHeight;

      $('html, body').animate({
        scrollTop: iScrollTo
      }, 500);

      oJQUERYOBJS.$MASTHEADWRAPPER.data(oCSSCLASS.SCROLLTORECENTLYVIEWED, false);
    };

    updateBasketBadge = function updateBasketBadge(e) {
      if (e) {
        try {
          if (!$(oSELECTORS.BASKETITEMSBADGE).length) {
            $(oSELECTORS.BASKETLINK).find(oSELECTORS.BASKETMENUTITLE).
                after('<span class="badge"><span class="basket-items"></span></span>');
          }
          $(oSELECTORS.BASKETITEMSBADGE)[0].innerHTML =
                e.oData.success.data.basket.total;
        } catch (ex) {}
      }
    };

    return {
      init: function init(bForceTouch) {
        pvInit(bForceTouch);
      },
      asyncBlockCallbacks: function asyncBlockCallbacks() {
        return pvAsyncBlockCallbacks();
      }
    };
  };

  return FixedHeader;
});

/*global define: true, window: true, localStorage: true*/

/**
 * Searchify
 *
 * Search As You Type.
 * Results include: auto-completed search suggestions and auto-suggested products based on search term.
 *
 * Example usage:
 * new Searchify({searchbox : 'search-input'});
 *
 */

define('modules/searchify/common', ['domlib'], function ($) {

    'use strict';

    function Searchify(opts) {
        this.conf = $.extend({}, this.conf, opts);
    }

    Searchify.prototype = {

        conf: {
            searchbox: 'search-field', //Input (text) for searches.
            url_results: 'https://search.api.tesco.com/sayt', // Endpoint for searches.
            dom_search_results: 'searchify', // Searchify module.
            dom_search_items: 'searchify-autocomplete', // Autocomplete module.
            dom_search_item: 'autocomplete-item', // Autocomplete list item.
            dom_products_items: 'searchify-autosuggest', // Autosuggest products module.
            dom_products_item: 'autosuggest-item', // Autosuggest product list item.
            cache_limit: 200, // Max capacity of entries in cache.
            max_suggestions: 4, // Max number of suggestions in results.
            max_products: 4 // Max number of products in results.
        },

        session: {
            local_storage_supported: false, // Is localStorage supported in the browser?
            criteria: null, // Current user search criteria.
            xhr: null, // XHR request used for searches.
            xhr_result: null, // XHR JSON Result.
            cache: [], // Cache search results.
            results_visible: false // Search results currently showing?
        },

        oSELECTORS: {
            MASTHEADWRAPPER: '#masthead-wrapper',
            SEARCHWRAPPER: '#search-wrapper',
            SEARCHINPUT: '#search-field',
            SEARCHRESULTSWRAPPER: '#search-results-wrapper'
        },

        oCSSCLASSES: {
            SEARCHIFYOPEN: 'searchifyOpen'
        },

        oEVENTS: {
            OPENSEARCHIFYDROPDOWN: 'openSearchifyDropdown',
            CLOSESEARCHIFYDROPDOWN: 'closeSearchifyDropdown'
        },

        init: function init() {

            this.unbindEvents();
            try {
                this.session.local_storage_supported = !!(typeof localStorage.setItem === 'function');
                this.retainSearchTerm();
            } catch (ex) {
                this.session.local_storage_supported = false;
            }
            this.bindEvents();

            if (!window.isKiosk()) {
                this.processAnalytics();
            }
        },

        /**
         * Remove Autosuggest binds.
         * (Autosuggest is loaded first and only needs to work on Kiosk)
         */
        unbindEvents: function unbindEvents() {

            var self = this;

            $('#' + self.conf.searchbox).unbind().off('keyup keyup.autocomplete');
        },

        /**
         * Retain the searched term in the searchbox on search results.
         */
        retainSearchTerm: function retainSearchTerm() {

            var self = this,
                search_term = window.localStorage.getItem('sayt_autosuggest_string_searched');

            if (self.session.local_storage_supported && search_term) {
                window.localStorage.removeItem('sayt_autosuggest_string_searched');
                $('#' + self.conf.searchbox).val(search_term);
            }
        },

        bindEvents: function bindEvents() {

            var self = this;

            /**
             * User input event on searchbox.
             * Up/Down arrows scroll through search results.
             */
            $('#' + self.conf.searchbox).on('keyup', function (e) {
                self.onSearchBoxKeyup(e);
            });

            $(self.oSELECTORS.MASTHEADWRAPPER).on('focus.getSearchifyResultsOnSearchInputFocus', self.oSELECTORS.SEARCHINPUT, function getSearchifyResultsOnSearchInputFocus() {
                if ($.trim($(self.oSELECTORS.SEARCHINPUT).val() !== '')) {
                    self.search();
                }
            });

            /**
             * Search products results click event.
             * Set localstorage for post analytics.
             * Trigger a search submit.
             */
            $(self.oSELECTORS.SEARCHRESULTSWRAPPER).on('click', '#' + self.conf.dom_search_results + ' #' + self.conf.dom_products_items + ' .' + self.conf.dom_products_item + ' .item-link', function (e) {

                self.storeItem('sayt_productsuggest_term', 'SAYT - suggested Product'); // eVar3.
                self.storeItem('sayt_productsuggest_string', $('#' + self.conf.searchbox).val()); // eVar16.
                self.storeItem('sayt_productsuggest_index', 'Suggested Product P' + ($(e.currentTarget).parent('.' + self.conf.dom_products_item).index() + 1)); // eVar40.
            });

            /**
             * Search results suggestions click event.
             * Set localstorage for post analytics.
             * Trigger a search submit.
             */
            $(self.oSELECTORS.SEARCHRESULTSWRAPPER).on('click', '#' + self.conf.dom_search_results + ' #' + self.conf.dom_search_items + ' .' + self.conf.dom_search_item + ' .item-link', function (e) {

                // Track the Autosuggested term click.
                self.storeItem('sayt_autosuggest_term', 'SAYT  suggested Search Term'); // eVar3.
                self.storeItem('sayt_autosuggest_string', $(e.currentTarget).text()); // eVar16.
                self.storeItem('sayt_autosuggest_index', 'Autosuggest Term P' + ($(e.currentTarget).parent('.' + self.conf.dom_search_item).index() + 1)); // eVar40.
                self.storeItem('sayt_autosuggest_string_searched', $(e.currentTarget).text()); // retained search term.

                $('#' + self.conf.searchbox).val($(e.currentTarget).text());
                $('#search-submit').trigger('click');
            });

            /**
             * Hide search results
             */
            $(self.oSELECTORS.MASTHEADWRAPPER).on('searchBarCloseComplete', function () {
                self.removeSearchResults();
            });
        },

        /**
         * User typed in searchbox.
         */
        onSearchBoxKeyup: function onSearchBoxKeyup(e) {

            var self = this,
                key = (window.event) ? e.which : e.keyCode;

            switch (key) {

                /**
                 * (38) Up arrow pressed.
                 * Scroll upwards through search results.
                 */
            case 38:
                e.preventDefault();
                self.NavigateSearchResults('up');
                break;

                /**
                 * (40) Down arrow pressed.
                 * Scroll downwards through search results.
                 */
            case 40:
                e.preventDefault();
                self.NavigateSearchResults('down');
                break;

                /**
                 * Ignore the following keys:
                 * (37/39) Left/Right arrow pressed.
                 * (32) Spacebar.
                 */
            case 37:
            case 39:
            case 32:
                break;

                /**
                 * Search performed.
                 */
            case 13:
                e.preventDefault();
                self.storeItem('sayt_autosuggest_string_searched', $('#' + self.conf.searchbox).val()); // retained search term.
                $('#search-submit').trigger('click');
                break;

                /**
                 * Close the menu if escape is pressed.
                 */
            case 27:
                self.removeSearchResults();
                break;

                /**
                 * Any other key.
                 * Perform a search.
                 */
            default:
                self.search();
                break;
            }
        },

        /**
         * Store an item in browser local storage.
         * Try catch used because private browsing in iOS breaks localStorage.
         */
        storeItem: function storeItem(key, val) {

            if (this.session.local_storage_supported) {
                try {
                    localStorage.setItem(key, val);
                    return true;
                } catch (e) {
                    return false;
                }
            }
        },

        /**
         * Removes the search results from the DOM.
         */
        removeSearchResults: function removeSearchResults() {

            var self = this;

            $(self.oSELECTORS.MASTHEADWRAPPER).removeClass(self.oCSSCLASSES.SEARCHIFYOPEN)
                .data(self.oCSSCLASSES.SEARCHIFYOPEN, false);
            $(self.oSELECTORS.SEARCHWRAPPER).removeClass(self.oCSSCLASSES.SEARCHIFYOPEN)
                .data(self.oCSSCLASSES.SEARCHIFYOPEN, false);

            $('#' + self.conf.dom_search_results).remove();

            self.session.results_visible = false;
        },


        /**
         * Updates the popular results messagaging.
         */
        updatePopularResults: function updatePopularResults() {

            var self = this,
                $popular_results = $('#searchify-popular'),
                content = '<span>Our most popular results matching </span><b>&ldquo;' + $('#' + self.conf.searchbox).val() + '&rdquo;</b>';

            if ($('#' + self.conf.dom_products_items + ' .' + self.conf.dom_products_item).length) {

                if ($popular_results.length) {
                    $popular_results.html(content);
                } else {
                    $('<div id="searchify-popular" class="searchify-popular">' + content + '</div>').insertAfter($('#' + self.conf.dom_search_items));
                }
            } else {
                $('#searchify-popular').remove();
            }
        },

        /**
         * Search for product categories & products based on user's search criteria.
         */
        search: function search(criteria) {

            var self = this,
                i,
                i_len;

            /**
             * Sanatise and validate user search criteria.
             * Do not perform the previous search again.
             */
            self.session.criteria = criteria || self.sanatiseCriteria($('#' + self.conf.searchbox).val());
            if (!self.isCriteriaValid(self.session.criteria)) {
                self.removeSearchResults();
                return;
            }
            if (self.isCriteriaCached(self.session.criteria)) {
                i_len = self.session.cache.length;
                for (i = 0; i < i_len; i += 1) {
                    if (self.session.criteria === self.session.cache[i].criteria) {
                        self.showSearchResults(i);
                        break;
                    }
                }
                return;
            }

            /** Fetch suggestions and associated products then show the results. */
            $.when(self.fetchSuggestions(true))
                .then(function () {
                    self.processSuggestions();
                    $.when(self.fetchProducts())
                        .then(function () {
                            self.processProducts();
                            self.showSearchResults();
                        });
                });

        },

        /**
         * Adds the search results to the DOM.
         */
        showSearchResults: function showSearchResults() {

            var self = this,
                i = self.getIndexByCriteria(),
                suggestions = self.createSearchResultsItems(i);

            if (suggestions.iResults === 0) {
                if ($(self.oSELECTORS.MASTHEADWRAPPER).data(self.oCSSCLASSES.SEARCHIFYOPEN) === true) {
                    $(self.oSELECTORS.MASTHEADWRAPPER).trigger(self.oEVENTS.CLOSESEARCHIFYDROPDOWN);
                    self.removeSearchResults();
                }
            } else {
                self.updateSearchResultsContainerContent(suggestions.sMarkup);
                self.updateSearchResultsProducts(i);
                self.updatePopularResults();

                self.session.results_visible = true;

                if ($(self.oSELECTORS.MASTHEADWRAPPER).data(self.oCSSCLASSES.SEARCHIFYOPEN) !== true) {
                    $(self.oSELECTORS.SEARCHWRAPPER).addClass(self.oCSSCLASSES.SEARCHIFYOPEN)
                        .data(self.oCSSCLASSES.SEARCHIFYOPEN, true);
                    $(self.oSELECTORS.MASTHEADWRAPPER).addClass(self.oCSSCLASSES.SEARCHIFYOPEN)
                        .data(self.oCSSCLASSES.SEARCHIFYOPEN, true)
                        .trigger(self.oEVENTS.OPENSEARCHIFYDROPDOWN);
                }
            }
        },

        /**
         * Adds products from search results.
         */
        updateSearchResultsProducts: function updateSearchResultsProducts(index) {

            var self = this,
                items = '',
                item = '',
                i,
                i_len = self.session.cache[index].products.length,
                product_url;

            for (i = 0; i < i_len; i += 1) {
                product_url = self.session.cache[index].products[i].productUrl + '&icid=spiffy_' + window.escape(self.session.cache[index].suggestions[0].id) + '_' + self.session.cache[index].products[i].id + '_' + self.session.criteria;
                item = '<li class="autosuggest-item"><a class="item-link" href="' + product_url + '">';
                item += '<div class="image-wrapper">';

                if (self.session.cache[index].products[i].g_image) { // Image may not exist, or it may not be base64.
                    if (self.session.cache[index].products[i].g_image.substring(0, 7) === 'http://') {
                        item += '<img src="' + self.session.cache[index].products[i].g_image + '" />';
                    } else {
                        item += '<img src="data:image/jpeg;base64,' + self.session.cache[index].products[i].g_image + '" />';
                    }
                } else {
                    item += '<img src="' + self.conf.url_results + '/searchbar/img/na.jpg" />';
                }
                item += '</div>';
                item += '<div class="item-name">' + self.session.cache[index].products[i].name.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)(" + self.session.criteria + ")(?![^<>]*>)(?![^&;]+;)", "gi"), "<strong class='link-highlight'>$1</strong>") + '</div>';
                item += '</a></li>';
                items += item;

                if (i + 1 === self.conf.max_products) { // Enforce max limit.
                    break;
                }
            }

            if ($('#' + self.conf.dom_products_items).length) { // Create container if not already present in DOM.
                $('#' + self.conf.dom_products_items).html(items);
            } else {
                $('<ul id="' + self.conf.dom_products_items + '" class="' + self.conf.dom_products_items + '">' + items + '</ul>').insertAfter('#' + self.conf.dom_search_items);
            }
        },

        /**
         * Checks whether a specified search criteria exists in the cache.
         */
        isCriteriaCached: function isCriteriaCached(criteria) {

            return this.getIndexByCriteria(criteria) >= 0 ? true : false;
        },

        /**
         * Ensures a user's search criteria is valid to use.
         */
        isCriteriaValid: function isCriteriaValid(criteria) {

            return $.trim(criteria) !== '' ? true : false;
        },

        /**
         * Creates structured URL to use for searching with.
         */
        createSearchURL: function createSearchURL(criteria) {

            var criteria_touse = criteria || this.session.criteria;

            return this.conf.url_results + '/k?v=' + criteria_touse;

        },

        /**
         * Creates structured URL to use for searching products from ID.
         */
        createProductsURLFromID: function createProductsURLFromID(ids) {

            return this.conf.url_results + '/p?v=id:' + ids.join(' OR id:');
        },

        /**
         * Make AJAX request to endpoint to fetch results for user search criteria.
         */
        fetchSuggestions: function fetchSuggestions(force_abort) {

            var self = this,
                defer = $.Deferred();

            if (force_abort && self.session.xhr) {
                self.session.xhr.abort();
            }

            self.session.xhr = $.ajax({
                url: self.createSearchURL(),
                type: 'GET',
                success: function (xhr) {
                    self.session.xhr_result = xhr;
                    defer.resolve();
                },
                dataType: 'jsonp',
                jsonp: 'json.wrf'
            });

            return defer.promise();
        },

        /**
         * Process search results.
         * Gets the product categories and the products.
         */
        processSuggestions: function processSuggestions() {

            var self = this;

            /**
             * Manage cache limit.
             */
            if (self.session.cache.length >= self.conf.cache_limit) {
                self.session.cache = [];
            }

            /**
             * Add search results to the cache.
             */
            self.session.cache.push({
                criteria: self.session.criteria,
                suggestions: self.session.xhr_result,
                products: []
            });

        },

        /**
         * Process products search results.
         */
        processProducts: function processProducts() {

            this.session.cache[this.getIndexByCriteria()].products = this.session.xhr_result;

        },

        /**
         * Create the items for the search results.
         */
        createSearchResultsItems: function createSearchResultsItems(index) {

            var self = this,
                items = '',
                i,
                i_len,
                markup;

            i_len = self.session.cache[index].suggestions.length;

            for (i = 0; i < i_len; i += 1) {
                items += '<li class="' + self.conf.dom_search_item + '"><button class="item-link">' + self.session.cache[index].suggestions[i].id.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)(" + self.session.criteria + ")(?![^<>]*>)(?![^&;]+;)", "gi"), "<b class='link-highlight'>$1</b>") + '</button></li>';
                if (i + 1 === self.conf.max_suggestions) {
                    break;
                }
            }

            markup = '<ul id="' + self.conf.dom_search_items + '" class="' + self.conf.dom_search_items + '">' + items + '</ul>';

            return {
                sMarkup: markup,
                iResults: i_len
            };

        },

        /**
         * Create the DOM container for search results.
         */
        updateSearchResultsContainerContent: function updateSearchResultsContainerContent(content) {

            var self = this,
                search_container;

            content = content || '';
            if (!$('#' + self.conf.dom_search_results).length) {
                search_container = '<div class="m-' + self.conf.dom_search_results + '" id="' + self.conf.dom_search_results + '">' + content + '</div>';
                $('#search-results-wrapper').append(search_container);
            } else {
                $('#' + self.conf.dom_search_results).html(content);
            }
        },


        /**
         * Gets the products for the top suggestion.
         */
        fetchProducts: function fetchProducts() {

            var self = this,
                defer = $.Deferred(),
                ids = self.session.xhr_result.length ? self.session.xhr_result[0].Products : [];

            self.session.xhr = $.ajax({
                url: self.createProductsURLFromID(ids),
                type: 'GET',
                success: function (xhr) {
                    self.session.xhr_result = xhr;
                    defer.resolve();
                },
                dataType: 'jsonp',
                jsonp: 'json.wrf'
            });

            return defer.promise();
        },

        /**
         * Sanatise user search criteria.
         */
        sanatiseCriteria: function sanatiseCriteria(criteria) {

            return $.trim(criteria.toLowerCase());
        },

        /**
         * Return the index of the specified search criteria in the cache.
         */
        getIndexByCriteria: function getIndexByCriteria(criteria) {

            var self = this,
                i,
                i_len = self.session.cache.length;

            criteria = criteria || self.session.criteria;

            for (i = 0; i < i_len; i += 1) {
                if (self.session.cache[i].criteria === criteria) {
                    return i;
                }
            }

            return -1;
        },

        /**
         * Move upwards/donwards through the search results.
         */
        NavigateSearchResults: function NavigateSearchResults(direction) {

            var self = this,
                $cur_selected;

            if ($('#' + self.conf.dom_search_items + ' .' + self.conf.dom_search_item).length) {

                if (direction === 'up') { // Move up the suggestions 1 by 1.
                    $cur_selected = $('#' + self.conf.dom_search_items + ' .' + self.conf.dom_search_item + '.is-selected').prev();
                    if (!$cur_selected.length) {
                        $cur_selected = $('#' + self.conf.dom_search_items + ' .' + self.conf.dom_search_item).last();
                    }
                    $cur_selected.siblings().removeClass('is-selected');
                    $cur_selected.addClass('is-selected');
                } else if (direction === 'down') { // Move down the suggestions 1 by 1.
                    $cur_selected = $('#' + self.conf.dom_search_items + ' .' + self.conf.dom_search_item + '.is-selected').next();
                    if (!$cur_selected.length) {
                        $cur_selected = $('#' + self.conf.dom_search_items + ' .' + self.conf.dom_search_item).first();
                    }
                    $cur_selected.siblings().removeClass('is-selected');
                    $cur_selected.addClass('is-selected');
                }

                self.updateProductsFromSelection($cur_selected);

            }
        },

        /**
         * Updates the product suggestions based on the selected autosuggest term.
         */
        updateProductsFromSelection: function updateProductsFromSelection($selected_item) {

            var self = this;

            $('#' + self.conf.searchbox).val($selected_item.text()); // Update the searchbox to reflect suggestion selected.
            self.session.criteria = self.sanatiseCriteria($('#' + self.conf.searchbox).val());

            if (self.isCriteriaCached(self.session.criteria)) { // Get the products for the selected search suggestion and ONLY update the products results.
                if (self.session.cache[self.session.criteria] && self.session.cache[self.session.criteria].products.length === 0) {
                    self.session.cache.splice(self.session.cache.indexOf(self.session.cache[self.session.criteria]), 1);
                }
                self.updateSearchResultsProducts(self.getIndexByCriteria());
                self.updatePopularResults();
            } else {
                $.when(self.fetchSuggestions(true))
                    .then(function () {
                        self.processSuggestions();
                        $.when(self.fetchProducts())
                            .then(function () {
                                self.processProducts();
                                self.updateSearchResultsProducts(self.getIndexByCriteria());
                                self.updatePopularResults();
                            });
                    });
            }
        },

        /**
         * Reads previously set analytics and assigns values to eVars.
         * Used in publishing JS.
         */
        processAnalytics: function processAnalytics() {

            var auto_terms = [
                { eVar: 'eVar3', item: 'sayt_autosuggest_term' },
                { eVar: 'eVar16', item: 'sayt_autosuggest_string' },
                { eVar: 'eVar40', item: 'sayt_autosuggest_index' },
                { eVar: 'eVar3', item: 'sayt_productsuggest_term' },
                { eVar: 'eVar16', item: 'sayt_productsuggest_string' },
                { eVar: 'eVar40', item: 'sayt_productsuggest_index' }
            ],
                i,
                i_len,
                storedItem;

            if (window.s && this.session.local_storage_supported) {
                i_len = auto_terms.length;
                for (i = 0; i < i_len; i += 1) {
                    storedItem = localStorage.getItem(auto_terms[i].item);
                    if (storedItem) {
                        window.s[auto_terms[i].eVar] = storedItem;
                        localStorage.removeItem(auto_terms[i].item);
                    }
                }
            }
        }

    };

    return Searchify;

});

/*globals define,require,window */
/*jslint plusplus: true, regexp: true, unparam: true */
define('modules/fixed-header/init', ['modules/fixed-header/common', 'modules/searchify/common', 'modules/common'], function (FixedHeader, Searchify, common) {
    'use strict';

    var oFixedHeader = new FixedHeader(),
        oSearchify = new Searchify();

    window.FixedHeader = oFixedHeader;
    window.Searchify = oSearchify;

    common.init.push(function () {
        oFixedHeader.init(true);
        oSearchify.init();
    });

});
/*jslint plusplus: true, nomen: true */
/*globals window,document,console,define,require */
define('modules/product-offers/common',['domlib', 'modules/breakpoint', 'modules/common', 'modules/overlay/common', 'modules/tesco.utils'], function ($, breakpoint, common, overlay, utils) {
    'use strict';
    var viewOffers = {
            offerListURL: "/direct/blocks/catalog/productlisting/productPromotions.jsp",
            container : $('#listing'),
            init : function () {
                $("#listing .products").on('click', 'a.special-offer', viewOffers.offerHandler);
            },
            tile : {
                el: {},
                top: 0,
                left: 0,
                height: 0,
                width: 0,
                offersId: 0
            },
            isListView: function () {
                if (viewOffers.container.length === 0) {
                    viewOffers.container = $('#listing');
                }
                return viewOffers.container.hasClass("list-view");
            },
            isGrid33321View: function () {
                if (viewOffers.container.length === 0) {
                    viewOffers.container = $('#listing');
                }
                return viewOffers.container.hasClass("grid-33321");
            },
            useFixedWidthLightbox: function () {
                return !viewOffers.isListView() && !viewOffers.isGrid33321View();
            },
            offerHandler : function (e) {
                e.preventDefault();
                e.stopPropagation();
                viewOffers.tile.el = $(this).closest('.product');
                overlay.pageScroll.isEnabled = false;

                viewOffers.tile.offersId = $(this).data('offerlist');
                viewOffers.setDimensions();
                viewOffers.displayLightBox();

                viewOffers.hideOverlayOnOrientationChange();
            },
            hideOverlayOnOrientationChange: function () {
                var eventName, isMobileDevice = common.isTouch() && !breakpoint.kiosk;
                if (!isMobileDevice) {
                    return;
                }
                eventName = window.orientation === undefined ? 'resize.productOffers' : 'orientationchange.productOffers';
                $(window).on(eventName, function () {
                    overlay.hide();
                    $(window).unbind(eventName);
                });
            },
            setDimensions: function () {
                var tile = viewOffers.tile.el,
                    p = tile.offset(),
                    tileWidth = tile.width() + 16;
                viewOffers.tile.top = p.top;
                viewOffers.tile.left = p.left + tileWidth;
                viewOffers.tile.height = tile.height();
                viewOffers.tile.width = tileWidth * 2;
                overlay.defaultOptions.customClass = 'light-box-offer';
                if (viewOffers.isListView()) {
                    overlay.defaultOptions.customClass += ' centered-view';
                }
                if (viewOffers.isGrid33321View()) {
                    overlay.defaultOptions.customClass += ' grid-33321 centered-view';
                }
                overlay.pageScroll.scrollTop = viewOffers.tile.top;
                if (breakpoint.mobile) {
                    overlay.pageScroll.isEnabled = true;
                    overlay.pageScroll.scrollTop = 0;
                    $('#overlay').hide();
                }
            },
            displayLightBox : function () {
                if (!breakpoint.mobile) {
                    viewOffers.setDimensions();
                }

                var options = {
                    content: '<div class="loader" id="tempLoader"><div class="loader-overlay"></div><div class="loader-text"></div></div>',
                    fixedWidth: viewOffers.useFixedWidthLightbox() ? viewOffers.tile.width : 0,
                    hideOnOverlayClick: true,
                    lightboxPosition: function ($overlay) {
                        var p = viewOffers.tile,
                            isLastTile = (p.left + p.width / 2) > window.innerWidth;

                        if (!breakpoint.mobile) {
                            $overlay.css('top', p.top + 40);
                            if (viewOffers.useFixedWidthLightbox()) {
                                if (isLastTile) {
                                    p.left = p.left - (p.width / 2);
                                }
                                $overlay.css('left', p.left);
                                $overlay.css('height', p.height + 16);
                            }
                        } else {
                            $overlay.css('top', 0);
                        }
                    },
                    callback: function () {
                        if (!breakpoint.mobile) {
                            utils.scrollToElem(viewOffers.tile.el, 600);
                        } else {
                            $('html, body').animate({scrollTop: 0}, '600');
                        }
                    }
                };
                overlay.show(options);
                viewOffers.loadData();
            },
            displayOffers: function (d) {
                if (d.content === "") {
                    return;
                }
                if (!breakpoint.mobile) {
                    viewOffers.setDimensions();
                }
                var lb = $('#lightbox'), list, title, pdpLink, link, viewMore, i, offerTitles, offerTitle;

                lb.find('#tempLoader').remove();
                lb.append(d.content);

                list = lb.find('.productPromotionsContent');
                title = lb.find('a.title');
                pdpLink = title.attr('href');
                link = lb.find('.promoContainer');
                viewMore = lb.find('.view-more');
                offerTitles = list.find('.promoOffer');


                link.attr('href', pdpLink);
                viewMore.attr('href', pdpLink);
                $(title).dotdotdot({
                    ellipsis  : '...',
                    wrap      : 'word',
                    watch     : false,
                    tolerance : 0
                });
                for (i = 0; i < 3; i++) {
                    offerTitle = $(offerTitles[i]);
                    offerTitle.css('height', offerTitle.height());
                    offerTitle.dotdotdot({
                        ellipsis  : '...',
                        wrap      : 'word',
                        watch     : false,
                        tolerance : 0
                    });
                    offerTitle.css('display', 'table-cell');
                }
            },
            loadData: function () {
                $.ajax({
                    url: viewOffers.offerListURL + viewOffers.tile.offersId
                }).done(function (d) {
                    viewOffers.displayOffers(d);
                });
            }
        };
    common.init.push(function () {
        if (!window.isKiosk()) {
            viewOffers.init();
        }
    });
    return viewOffers;
});

/*global define: true */
define('modules/product-sort-by/common',['domlib', 'modules/common'], function($, common){


	/** @namespace */
	var productSortBy = {
		productTitle: ".add-to-basket-overlay .product-title",
		module: "#product-sort-by",
		overlayBG: ".overlay-screen",
		overlay: ".sort-by-overlay",
		trigger: ".trigger",
		
		
		getCategoryListHTML: function ($link) {
			$.ajax({
				url: $link.data('url'),
				complete: function (data) {
					$("body").append("<div class='overlay-screen'></div>");
					$link.parents(productSortBy.module).append(data.responseText);
					productSortBy.toggleOverlay();
					productSortBy.centerOverlay();
					productSortBy.bindOverlayEvents();
				}
			});
		},


		centerOverlay: function () {
			//centers overlay vertically - half height negative margin top. Horizontal centering already handled as fixed width
			var overlayHeight = $(productSortBy.overlay).height();
			$(productSortBy.overlay).css("margin-top", "-" + overlayHeight / 2 + "px");
		},


		overlayExists: function () {
			return $(productSortBy.overlayBG).length > 0;
		},


		toggleOverlay: function () {
			var cssTransitionsSupported = common.isModern(),
			overlays = $(productSortBy.overlayBG).add(productSortBy.overlay);
			if (cssTransitionsSupported) {
				overlays.toggleClass("show-overlay");
			}
			else {
				productSortBy.toggleOverlayFallback(overlays);
			}
		},


		toggleOverlayFallback : function (overlays) {
			var opacityValue = !overlays.hasClass("show-overlay");
			overlays.each(function () {
				$(this).animate({opacity : opacityValue}, 150);
			});
			overlays.toggleClass("show-overlay");
		},

		
		bindOverlayEvents: function () {
			$(".overlay-screen, .sort-by-overlay .close").on("click", function () {
				productSortBy.toggleOverlay();
				return false;
			});
		},


		bindTrigger: function () {
			$(productSortBy.trigger).on("click", function () {
				var overlayExists = productSortBy.overlayExists();
				if (overlayExists) {
					productSortBy.toggleOverlay();
				}
				else {
					productSortBy.getCategoryListHTML($(this));
				}
				return false;
			});
		},


		init: function () {
			var module = $(productSortBy.module);
			if (module.length) {
				module.each(function () {
					productSortBy.bindTrigger($(this));
				});
			}
		}
	};

	common.init.push(productSortBy.init);

	return productSortBy;
});
/* eslint-disable */
define('modules/recently-viewed/common',['domlib', 'modules/breakpoint', 'modules/common', 'dotdotdot'], function ($, breakpoint, common) {
    'use strict';

    /** @namespace */
    var recent = {

        $element: null,
        carousel: {},
        oRecentlyViewedCarousel: {},
        CONSTANTS: {
            SRVICAROUSELSELECTOR: '#recently-viewed',
            SHIDDENCLASS: 'carousel-hidden',
            SHIDERVISELECTOR: '.toggle-hide button',
            SHIDETEXT: 'Hide',
            SSHOWTEXT: 'Show',
            SCLEARITEMSSELECTOR: '.clear-all',
            SCLEARITEMSBUTTONSELECTOR: '.clear-all button',
            SDISABLECAROUSELSELECOR: 'carousel-disabled',
            SCAROUSELITEMSSELECTOR: '.carousel-items-list li',
            SDISABLEDSELECTOR: 'disabled',
            SEMPTYCAROUSELMESSAGESELECTOR: '.empty-carousel-message',
            SDISABLEEMPTYCAROUSELMESSAGECLASS: 'message-disabled',
            SPDPV2SELECTOR: 'PDP-Version2',
            SOLDCAROUSELSTYLESCLASS: 'cfw-old-carousel-styles',
            SRVICOMPONENTPARENTSELECTOR: '.PDP-Version2__page',
            SPDPV2PAGECLASS: 'PDP-Version2__page'
        },
        bRVICarouselClosed: false,
        bSmallViewport: (breakpoint.mobile || breakpoint.vTablet || breakpoint.hTablet) ? true : false,
        label: {
            off: "Hide",
            on : "Show"
        },

        initResponsiveCarousel: function () {
            var self = this;

            this.checkPDPV2();
            $(self.CONSTANTS.SRVICAROUSELSELECTOR).carousel({
                itemSelector: self.CONSTANTS.SCAROUSELITEMSSELECTOR,
                wrapperClass: '.carousel-items-list',
                prevClass: '.product-carousel-nav li a.previous',
                nextClass: '.product-carousel-nav li a.next',
                all: true,
                elasticBounceOnEmptySwipe: true,
                bHideNextPreviousIfAllItemsVisible: true,
                setActive: true,
                enablePeep: true,
                iemHeight: $(self.CONSTANTS.SRVICAROUSELSELECTOR).find(self.CONSTANTS.SCAROUSELITEMSSELECTOR).height(),
                itemWidth: $(self.CONSTANTS.SRVICAROUSELSELECTOR).find(self.CONSTANTS.SCAROUSELITEMSSELECTOR).outerWidth(),
                bFitsItemWidthsAndPaddingForNumberOfItemsMinusOne: true
            });
            this.oRecentlyViewedCarousel = $(this.CONSTANTS.SRVICAROUSELSELECTOR).data('carousel');
            this.bindEvents();
            this.checkEmptyCarousel();
        },

        bindEvents: function () {
            this.bindRemoveItemEvents();
            this.bindClearAllItemsEvent();
            this.bindRVIToggle();
        },

        bindRemoveItemEvents: function () {
            var self = this,
                args = {},
                sCarouselItemSelector = '.carousel-items-list li',
                $currentTarget,
                iItemPosition;

            $(sCarouselItemSelector).on('click', '.remove', function (event) {
                event.preventDefault();

                $currentTarget = $(event.target);
                iItemPosition = $currentTarget.parent().data('index') + 1;
                args.position = iItemPosition;
                self.oRecentlyViewedCarousel.remove(args);
                self.removeItemFromRVICookie($currentTarget.prop('href'));
                self.checkEmptyCarousel();
            });
        },

        bindClearAllItemsEvent: function () {
            var self = this,
                args = {};

            $(self.CONSTANTS.SRVICAROUSELSELECTOR).on('click', self.CONSTANTS.SCLEARITEMSSELECTOR, function (event) {
                event.preventDefault();

                if ($(event.target).find('button').hasClass(self.CONSTANTS.SDISABLEDSELECTOR)) {
                    return false;
                }
                args.position = 'all';
                self.oRecentlyViewedCarousel.remove(args);
                self.clearRVICookie();
                self.checkEmptyCarousel();
            });
        },

        bindRVIToggle: function () {
            var self = this;

            $(self.CONSTANTS.SRVICAROUSELSELECTOR).on('click', self.CONSTANTS.SHIDERVISELECTOR, function (event) {
                event.preventDefault();

                if (self.bRVICarouselClosed) {
                    self.showRVICarousel();
                } else {
                    self.hideRVICarousel();
                }
            });
        },

        checkEmptyCarousel: function () {
            if (this.countCarouselItems() === 0) {
                this.disableClearAllButton();
            }
        },

        checkPDPV2: function () {
            if (!$('body').hasClass(this.CONSTANTS.SPDPV2SELECTOR)) {
                $(this.CONSTANTS.SRVICAROUSELSELECTOR).addClass(this.CONSTANTS.SOLDCAROUSELSTYLESCLASS);
                $(this.CONSTANTS.SRVICAROUSELSELECTOR).closest(this.CONSTANTS.SRVICOMPONENTPARENTSELECTOR).removeClass(this.CONSTANTS.SPDPV2PAGECLASS);
            }
        },

        showRVICarousel: function () {
            var $elRVICarousel = $(this.CONSTANTS.SRVICAROUSELSELECTOR);

            if ($elRVICarousel.hasClass(this.CONSTANTS.SHIDDENCLASS)) {
                $elRVICarousel.removeClass(this.CONSTANTS.SHIDDENCLASS);
                $elRVICarousel.find(this.CONSTANTS.SHIDERVISELECTOR).html(this.CONSTANTS.SHIDETEXT);
                this.bRVICarouselClosed = false;
            }
        },

        hideRVICarousel: function () {
            var $elRVICarousel = $(this.CONSTANTS.SRVICAROUSELSELECTOR);

            if (!$elRVICarousel.hasClass(this.CONSTANTS.SHIDDENCLASS)) {
                $elRVICarousel.addClass(this.CONSTANTS.SHIDDENCLASS);
                $elRVICarousel.find(this.CONSTANTS.SHIDERVISELECTOR).html(this.CONSTANTS.SSHOWTEXT);
                this.bRVICarouselClosed = true;
            }
        },

        countCarouselItems: function () {
            var iCarouselItemCount = 0;

            if ($(this.CONSTANTS.SRVICAROUSELSELECTOR).find(this.CONSTANTS.SCAROUSELITEMSSELECTOR).length > 0) {
                iCarouselItemCount = $(this.CONSTANTS.SRVICAROUSELSELECTOR).find(this.CONSTANTS.SCAROUSELITEMSSELECTOR).length;
            }

            return iCarouselItemCount;
        },

        disableClearAllButton: function () {
            $(this.CONSTANTS.SRVICAROUSELSELECTOR).find(this.CONSTANTS.SCLEARITEMSBUTTONSELECTOR)
                .removeClass(this.CONSTANTS.SDISABLEDSELECTOR)
                .addClass(this.CONSTANTS.SDISABLEDSELECTOR);
            this.disableCarouselNavigation();
        },

        disableCarouselNavigation: function () {
            $(this.CONSTANTS.SRVICAROUSELSELECTOR).addClass(this.CONSTANTS.SDISABLECAROUSELSELECOR);
        },

        getQueryParameters: function (query_string) {
            var query_params = {},
                query = query_string.split('?'),
                current,
                i = 0,
                j;

            if (query && query.length > 1) {
                query = query[1].split('&');
                for (i = 0, j = query.length; i < j; i += 1) {
                    current = query[i].split('=');
                    query_params[current[0]] = current[1];
                }
            }

            return query_params;
        },

        removeItemFromRVICookie: function (sQueryString) {
            var sURLParams = recent.getQueryParameters(sQueryString),
                sProductId,
                aRVIList,
                sTempRVI,
                oRVIData = null,
                i = 0;

            if (sURLParams.pid) {
                sProductId = sURLParams.pid.replace('#recently-viewed', '');
                oRVIData = $.cookie('tesco_rvi_');
                oRVIData = oRVIData !== null ? oRVIData.replace(/"/g, '') : '';
                aRVIList = oRVIData.split("@");

                for (i = 0; i < aRVIList.length; i += 1) {
                    if (aRVIList[i].search(sProductId) !== -1) {
                        aRVIList.splice(i, 1);
                        sTempRVI = aRVIList.join('@');
                        break;
                    }
                }
                oRVIData = '\"' + sTempRVI + '\"';
                $.cookie('tesco_rvi_', oRVIData, { path: '/', raw: true });
            }
        },

        clearRVICookie: function () {
            $.cookie('tesco_rvi_', null, { path: '/' });
        },

        init: function () {
            recent.$element = $(this.CONSTANTS.SRVICAROUSELSELECTOR);
            if (recent.$element.length > 0 && !window.isKiosk()) {
                common.Ellipsis.init($('h3', recent.$element));
                return true;
            }
        },

        asyncBlockCallbacks: function asyncBlockCallbacks() {
            var oCallbacks = {};

            oCallbacks.success = function (oResp) {
                var sBlockId = this.sBlockID,
                    oRecentlyViewed = this;

                if (typeof oResp === "string") {
                    oResp = $.parseJSON(oResp);
                }
                if (oResp[sBlockId] && !oResp[sBlockId].productIds) {
                    $(recent.CONSTANTS.SRVICAROUSELSELECTOR).replaceWith(oResp[oRecentlyViewed.sBlockID]);
                    recent.initResponsiveCarousel();
                }
            };
            return oCallbacks;
        }

    };

    common.init.push(function () {
        if (!window.AsyncBlockController.isCachedPage()) {
            recent.initResponsiveCarousel();
        }
    });

    return recent;
});

define('modules/sort-by/common',['domlib', 'modules/breakpoint', 'modules/common', 'modules/overlay/common', 'modules/tesco.utils', 'modules/tesco.analytics'], function($, breakpoint, common, overlay, utils, analytics){

	var sortBy = {
		productListing: '#listing',
		timer: null,
		sortbyIsVisible: false,
        loaded: false,

		observe: function () {

			var self = sortBy;
			var event = (common.isTouch()) ? 'tap click' : 'touchstart click';
			
			if (!common.isTouch() && !this.loaded) {
                this.loaded = true;
				$('#product-filter-actions>.sort').on('mouseenter', self.navMouseEnter);
				$('#product-filter-actions>.sort').on('mouseleave', self.navMouseLeave);
				
				$('#product-filter-actions>.sort').on('mouseenter', function () {
					window.clearTimeout(self.timer);
				});
				
				$('#product-filter-actions>.sort').on('mouseleave', function () {
					self.timer = setTimeout(function () {
						self.navMouseLeave();
					}, 10000);
				});
				
			}
			
			if ($('#product-filter-actions .sort-by-list li a.current').length)
			{
				var selectedSortoption = $('#product-filter-actions .sort-by-list li a.current').eq(0).text();

				$('#product-filter-actions .control > strong').text(selectedSortoption);
				$("#frmTest input.selected-sort-option").val(selectedSortoption);
			}
			else{
				defaultSortoption = $('#product-filter-actions .sort-by-list li a').eq(0).text();
				$("#product-filter-actions .control > strong").text(defaultSortoption);
				
			}
			

			$('#product-filter-actions .control').on(event, function(e) {
				e.preventDefault();
				e.stopImmediatePropagation();

				if (breakpoint.mobile || breakpoint.hTablet || breakpoint.vTablet) {
					overlay.show({
						content: $('#product-filter-actions .sort .sort-by-list').clone()[0]
					});


				} else {
					var icon = $(e.currentTarget).find('.icon'),
						changeIcon = icon.attr('data-icon') === '2' ? '1' : '2';

					$(e.currentTarget).parent().toggleClass('open');
					icon.attr('data-icon', changeIcon);

					sortBy.sortbyIsVisible = true;
				}
				
				return false;
			});
		},
        updateSelection: function(selectedNumber) {
            if(selectedNumber != 0){
	        	$("#product-filter-actions .sort-by-list li a").removeClass("current");
	            var selectedSortoption = $("#product-filter-actions .sort-by-list li a[data-val='"+selectedNumber+"']")
	                    .addClass("current").eq(0).text();
	            if(selectedSortoption == '' ){
					selectedSortoption = 'Relevance'
					}
	              
	            $('#product-filter-actions .control > strong').text(selectedSortoption);
	            $("#frmTest input.selected-sort-option").val(selectedSortoption);
            }
        },
        sortByAnalytics: function(selectedNumber){
        	var view;
        	var selectedSortoption = $("#product-filter-actions .sort-by-list li a[data-val='"+selectedNumber+"']")
            .addClass("current").eq(0).text();
		    if(selectedSortoption == '' ){
				selectedSortoption = 'Relevance'
			}
        	if($("#listing").hasClass("list-view")){
            	view="list";
            }
            else {
            	view="grid";
            }
              var _oWebAnalytics = new analytics.WebMetrics();
              var v = [{
                  'eVar8': 'view:'+view+'|sort:'+selectedSortoption ,
                  'prop25': 'view:'+view+'|sort:'+selectedSortoption
              }];  
              _oWebAnalytics.submit(v);
        },
        closeDropDown: function() {
            var el = $('#product-filter-actions .control'),
                icon = $(el).find('.icon'),
                changeIcon = icon.attr('data-icon') === '2' ? '1' : '2';

            $(el).parent().removeClass('open');
            icon.attr('data-icon', changeIcon);
            sortBy.sortbyIsVisible = false;

        },

		navMouseEnter: function (e) {
			var self = sortBy;
			window.clearTimeout(self.mouseLeaveTimer);
		},

		navMouseLeave: function (e) {
			var self = sortBy;
            var that = this;
			
			self.mouseLeaveTimer = setTimeout(function () {
				if (self.sortbyIsVisible) {
					var target = $('.sort.open'),
						icon = $(target).find('.icon'),
						changeIcon = icon.attr('data-icon') === '2' ? '1' : '2';
					target.removeClass('open');
					icon.attr('data-icon', changeIcon);
				}
			}, 1000);
			
		},

		init: function () {
			if($('#product-filter-actions .sort').length){

				if ($(sortBy.productListing).length) {

					sortBy.observe();
					var selectEvent = (common.isTouch()) ? 'tap click':'click';
					$(document).on(selectEvent, function (e) {
						if (sortBy.sortbyIsVisible) {
							var target = $('.sort.open'),
								icon = $(target).find('.icon'),
								changeIcon = icon.attr('data-icon') === '2' ? '1' : '2';
							target.removeClass('open');
							icon.attr('data-icon', changeIcon);
						}
					});
				}
                
                /*
                Defect 46448, sort by option is not updating in Kiosk PLP. 
                This is a temporary fix in the JS for GMO5. Will be removed for a proper solution made to the JSP in GMO6
                */
                sortBy.updateSortByOption();               
			}
			
			//$('#frmTest').appendTo('#active-product-filters');
		},
        
        updateSortByOption: function () {
			if (window.isKiosk()) {
			    
		        if ($('#product-filter-actions').length) {
		        
		        	sortBy.fixBuyListSortOrder();
		        	
		        	var $el = $('#product-filter-actions');
		            var $elSort = $('#product-filter-actions a.sort');
		            var $elCurrent = $('#product-filter-actions a.current');
		            
		            // Get sortBy param
		            var URLParams = utils.getURLParams();
		            var getSortByParam = URLParams['sortBy'];
		            
		            if (getSortByParam != undefined) {
		                
		                // Remove existing .current classes
		                if ($elCurrent.length) {
		                    $elSort.removeClass('current');
		                }
		                
		                if (getSortByParam === '' || getSortByParam.indexOf('P_') >= 0) {
		                	$elSort.eq(0).addClass('current');
		                	$el.find('.sort .control strong').text($elSort.eq(0).text());
		                }
		                
		                // For each sort link
		                $elSort.each(function() {
		                    // If data-val eq to sortBy param,
		                    // add class .current,
		                    // copy link text to display text for selected option
		                    if ($(this).data('val') == getSortByParam) {
		                        $(this).addClass('current');
		                        $el.find('.sort .control strong').text($(this).text());
		                    }
		                });
		            }
		            
		            else {
		                // default
		            	var $controlLabel = $('#product-filter-actions a.sort:first'); 
		            	$controlLabel.addClass('current');
		            	$el.find('.sort .control strong').text($controlLabel.text());		                
		            }
		            
		        }
		    }
        },
        fixBuyListSortOrder: function() {        		
        	var $el = $('#product-filter-actions');
        	
            //fix the drop down option as well.
    		$el.find('.sort-by-list li a').each(function(i, e) {;
    			var $el = $(this);
    			var tempVal = $el.text(); 
    			if (tempVal.indexOf('???') > 0) {
    				$el.text('Recommended');
    				$el.data('val', tempVal.replace(/[/\?]*[\r\n]*/gm, ""));    				    				
    			}            		
    		});  
        	
        }
	};

	return sortBy;
});
/*globals define,require,window,console */
/*jslint plusplus: true, regexp: true, unparam: true */
define('modules/set-page-title/SetPageTitle', [],function () {
    'use strict';

    function SetPageTitle(oSettings) {
        if (typeof oSettings !== 'object') {
            throw new Error("The parameter passed to the Set Page Title class is not an object.");
        }

        this.sCachedPageTitle;
        this.sCachedNoFiltersPageTitle;
        this.sSetPageTitleEventName = oSettings.sSetPageTitleEventName ? oSettings.sSetPageTitleEventName : 'updatePageTitle';
        this.sResetPageTitleEventName = oSettings.sResetPageTitleEventName ? oSettings.sResetPageTitleEventName : 'resetPageTitle';
        this.sSuffixText = oSettings.sSuffixText ? oSettings.sSuffixText : '- Tesco.com';
        this.sHiddenFilterNameSelector = 'h1.page-title span.last_applied_filter';
        this.bEventsBound = false;
        this.bGlobalFallbackEnabled = this.fnCheckForGlobalFallback();
        this.bOriginalPageTitleCached = false;
        this.bReplaceEntireTitle = oSettings.bReplaceEntireTitle ? oSettings.bReplaceEntireTitle : false;
        this.bAppendBeforeSuffix = oSettings.bAppendBeforeSuffix ? oSettings.bAppendBeforeSuffix : true;
        this.init();
    }

    SetPageTitle.prototype = {
        constructor: SetPageTitle,

        fnBindEventListeners: function fnBindEventListeners() {
            var self = this;

            if (this.bEventsBound === false) {
                $(window).on(this.sSetPageTitleEventName, function(e, oData) {
                    e.stopImmediatePropagation();
                    self.fnUpdatePageTitle(e, oData)
                });

                $(window).on(this.sResetPageTitleEventName, function() {
                    self.fnResetPageTitle();
                })
                this.bEventsBound = true;
            }
        },

        fnCheckForGlobalFallback: function fnCheckForGlobalFallback() {
            if (window.TescoData === undefined) {
                window.TescoData = {};
            }
            if (window.TescoData.plp === undefined) {
                window.TescoData.plp = {};
            }
            return window.TescoData.plp.bGlobalPageTitleFallback ? true : false;
        },

        fnGetPageTitle: function fnGetPageTitle() {
            return document.title;
        },

        fnSetOriginalPageTitle: function fnSetOriginalPageTitle(sCurrentPageTitle) {
            this.sCachedPageTitle = sCurrentPageTitle;
            this.bOriginalPageTitleCached = true;
        },

        fnSetPageTitle: function fnSetPageTitle(oData) {
            var sUpdatedPageTitlePartial,
                sFinalisedPageTitle,
                sCurrentPageTitleWithSuffixRemoved,
                sCurrentPageTitle = this.sCachedPageTitle;

            if (oData === undefined) {
                return;
            }
            sUpdatedPageTitlePartial = oData.sUpdatedPageTitlePartial;

            if (this.bReplaceEntireTitle) {
                sFinalisedPageTitle = sUpdatedPageTitlePartial;
            }
            if (this.bAppendBeforeSuffix) {
                sCurrentPageTitleWithSuffixRemoved = sCurrentPageTitle.replace(this.sSuffixText, '');
                sFinalisedPageTitle = sCurrentPageTitleWithSuffixRemoved + sUpdatedPageTitlePartial + ' ' + this.sSuffixText;
            }
            document.title = sFinalisedPageTitle;
        },

        fnUpdatePageTitle: function fnUpdatePageTitle(e, oData) {
            var sCurrentPageTitle;

            if (e) {
                sCurrentPageTitle = this.fnGetPageTitle();
                if (!this.bOriginalPageTitleCached) {
                    this.fnSetOriginalPageTitle(sCurrentPageTitle);
                }
                this.fnSetPageTitle(oData, sCurrentPageTitle);
            }
        },

        fnResetPageTitle: function fnResetPageTitle() {
            if (this.bOriginalPageTitleCached === true) {
                document.title = this.sCachedPageTitle;
            }
        },

        init: function init() {
            if (!this.bGlobalFallbackEnabled) {
                this.fnBindEventListeners();
            }
        }
    };

    return SetPageTitle;
});
/*jslint plusplus: true, nomen: true */
/*globals console,window,define,require,$ */
define('modules/product-filters/common',['domlib', 'modules/breakpoint', 'modules/common', 'modules/load-more/common', 'modules/sort-by/common', 'modules/tesco.analytics', 'modules/overlay/common', 'modules/tesco.utils', 'modules/set-page-title/SetPageTitle', 'modules/toggle-expand-collapse/common'],
    function ($, breakpoint, common, loadMore, sortBy, analytics, overlay, util, SetPageTitle, ToggleExpandCollapse) {
        "use strict";

        var imageList = {
                "a_0_TO_1": "../../images/rating_large_1.png",
                "a_1_TO_2": "../../images/rating_large_2.png",
                "a_2_TO_3": "../../images/rating_large_3.png",
                "a_3_TO_4": "../../images/rating_large_4.png",
                "a_4_TO_5": "../../images/rating_large_5.png"
            },
            validate = {
                init: function () {

                    var priceRangeForm = $('.filter-priceRangeWrap'),
                        form = $('.filter-priceRange'),
                        errors = $(".filter-priceRangeErrorWrap", priceRangeForm),
                        isValid = {
                            from: false,
                            to: false},
                        input = {
                            from: $('input[name="from"]', priceRangeForm),
                            to: $('input[name="to"]', priceRangeForm)},
                        label = {
                            from: $('[for="from"]', errors),
                            to: $('[for="to"]', errors)};

                    form.off("submit").on("submit", function (ev) {
                        ev.preventDefault();

                        var fromVal = parseFloat(input.from.val()),
                            toVal = parseFloat(input.to.val());

                        validate(input.from);
                        validate(input.to);
                        if (isValid["from"] && isValid["to"]) {

                            if (toVal > fromVal) {

                                if (history.pushState) {
                                    var postData = form.serialize(),
                                        formURL = form.attr("action");

                                    productFilters.refreshData(ev, formURL + '?' + postData, false, false, "ALL", false);
                                } else {
                                    this.submit();
                                }
                            }
                            else {
                                showError(input.to, "Please enter a 'To' value more than a 'From' value");
                            }
                        }
                    }).off("focusout").on("focusout", 'input[name="to"],input[name="from"]', function () {
                        validate($(this));
                    });

                    function validate(el) {
                        var value = el.val();

                        if (value === '') {
                            showError(el, el.data('msg-required'));

                        }
                        else if (!/^\d*(\.\d{0,9})?$/.test(value)) {
                            showError(el, el.data('msg-number'));
                        }
                        else {
                            hideAllErrors(el);
                        }

                    }

                    function showError(el, msg) {
                        var name = el.attr("name");
                        isValid[name] = false;

                        el.addClass('error').removeClass("valid");
                        errors.show();
                        label[name].css("display", "block").text(msg);
                    }

                    function hideAllErrors(el) {
                        var name = el.attr("name");
                        isValid[name] = true;

                        if (isValid["from"] && isValid["to"]) {
                            hideError("from");
                            hideError("to");
                            errors.hide();
                        } else if (isValid["from"]) {
                            hideError("from");
                        } else if (isValid["to"]) {
                            hideError("to");
                        }
                    }

                    function hideError(name) {
                        input[name].removeClass("error").addClass("valid");
                        label[name].hide();
                    }
                }
            },


            historyManager = {

                stack: [],
                isChanged: false,
                lastHash: '',

                init: function () {
                    var that = this;
                    var param = util.getURLParams();
                    var stateDataObj = {
                        state_getfilters: "ALL",
                        state_sortProducts: false,
                        state_currentURL: window.location.href,
                        state_sortBy: $.isNumeric(param.sortBy) ? param.sortBy : 0
                    };

                    historyManager.replaceUrl(stateDataObj.state_currentURL, stateDataObj);

                    $(window).on("popstate", function (ev) {

                        if (historyManager.isChanged && window.location.hash === historyManager.lastHash) {
                            $.each(historyManager.stack, function (k, callback) {
                                callback(ev, window.location.search, true);
                            });
                        }
                    });
                    window.setTimeout(function(){
                       historyManager.isChanged = true;
                    }, 1000);
                },

                setUrl: function (url, data) {
                    this.isChanged = true;
                    if (history.pushState) {
                        history.pushState(data, null, url);
                    }
                    this.lastHash = window.location.hash;
                    $(window).trigger('historyManagerSetUrlFired');
                },

                replaceUrl: function (url, data) {
                    if (history.pushState) {
                        history.replaceState(data, null, url);
                    }
                }
            },

            templates = {

                overlayWait: '<div class="filter-overlayWaiting"><div class="filter-overlayText">Please wait while we update your selection</div></div>',
                //overlayWait: '<div class="filter-overlayWaiting"><div class="newLoader">Loading...</div><div class="filter-overlayText">Please wait while we update your selection</div></div>',

                categoryList: function () {
                    return '<div class="filter-categoryList">' +
                        '<h3 class="filter-categoryLabel">View by Category</h3>' +
                        '<div class="filter-categoryMore">Show all <span class="filter-categoryCount"></span> categories</div>' +
                        '<div class="filter-categoryOptionList">' +
                        '</div>' +
                        '</div>';
                },

                categoryItem: function (o) {
                    return '<a id="' + o.id + '" href="' + o.url + '" class="filter-categoryItem ' + (o.count === 0 ? "filter-categoryItem_disabled" : "") + '" data-catid="' + o.id + '">' +
                        o.displayName + '<span class="filter-categoryOptionCount">(' + o.count + ')</span></a>';
                },

                filterGroup: function (id, o) {

                    var priceRange = '';
                    if (o.type === "Multi_SearchRange") {
                        priceRange = '<li class="filter-priceRangeWrap"></li>';
                    }

                    return '<div class="filter-filterGroup filter-filterGroup_active">' +
                        '<h3 class="filter-filterGroupLabel" id="' + id + '">' + o.displayName + '</h3>' +
                        '<div class="filter-filterOptionList">' +
                        '<ul class="filter-filterOptionListWrap">' +

                        '<li class="filter-filterOptionMore">' +
                        '<div class="filter-filterOptionMoreButton" id="' + o.displayName + '">View all</div>' +
                        '</li>' + priceRange +
                        '</ul>' +
                        '</div>' +
                        '</div>';
                },

                filterOption: function (o) {
                    if (o.type === "Multi_Image") {
                        o.displayName = '<img src="' + imageList[o.displayName] + '" class="filter-filterOptionImage">';
                    }
                    return '<li><a id="' + o.id + '" href="' + o.url + '" class="filter-filterOption" data-optionid="' + o.id + '">' +
                        o.displayName + '<span class="filter-filterOptionCount">(' + o.count + ')</span></a></li>';
                }
            },

            productFilters = {

                isOverlayOpen: false,
                bOverlayDirty: false,
				isBottomShadow: false,

                init: function () {

                    productFilters.fnBindSetTitleEvents();

                    var that = this,
                        click = 'click',
						mousedown = 'mousedown',
						evt = '',
	                    overlayState = "";
                    if($('.detail-specification-bullet').length){
                    	 $('.detail-specification-bullet ul li').each(function(){
                         	common.Ellipsis.init($(this));
                         });
                    }

                    productFilters.fnSetGlobalFilterVars();
                    !window.isKiosk() && productFilters.collapseCategories();

					if(common.isTouch()){
						evt = click;
					} else{
						evt = mousedown;
					}

                    if (common.isPage('PLP')) {
                    	historyManager.init();
                    }
                    productFilters.lastState = window.location.pathname + window.location.search;
                    productFilters.savedState = productFilters.lastState;

                    historyManager.stack.push(function (ev, url, isBackButton) {

                            if (window.location.hash === "" && productFilters.isOverlayOpen === true) {
                                productFilters.toggleOverlay(false);
                                overlay.hide()
                            }
                            var getFilter = ev.originalEvent.state && ev.originalEvent.state.state_getfilters;
                            if (ev.originalEvent.state) {
                           		 productFilters.refreshData(ev, url, isBackButton, false, getFilter, false);
                            }
                            sortBy.updateSelection(productFilters.sortBy);

                    });

                    $("body")
                        .on('click touchend', ".filter-filterOption", function (ev) {
                            ev.preventDefault();
                            ev.stopImmediatePropagation();

                            if (!$(this).hasClass("filter-filterOption_disabled") || $(this).hasClass("filter-filterOption_active")) {
                                if (productFilters.isOverlayOpen) {
                                	productFilters.bOverlayDirty = true;
                            	}
                                var getFilter = breakpoint.largeDesktop ? 'ALL' : 'LHN';
                            	getFilter = breakpoint.largeDesktop && productFilters.isOverlayOpen ? 'LHN' : getFilter;
                                productFilters.refreshData(ev, $(this).attr("href"), false, true, getFilter, false);
                            }
                        })
                        .on(click, ".filter-lightbox .close", function (ev) {
                            ev.preventDefault();
                            ev.stopImmediatePropagation();
                            overlay.hide();
                        })
                        .on(click, ".filter-lightbox .filter-overlayApply", function (ev) {
                        //.on(click, ".filter-lightbox .filter-showAllPoducts", function (ev) {
                            ev.preventDefault();
                            ev.stopImmediatePropagation();
                            overlay.hide();

                            productFilters.isOverlayOpen = false;

                            if (productFilters.bOverlayDirty) {
                                window.setTimeout(function () {
                            		productFilters.refreshData(ev, productFilters.savedState, false, false, "Products", false);
                       			}, 20);
                            }
                            productFilters.bOverlayDirty = false;


                        })
                        .append(templates.overlayWait);


                    $(".refine a")
                        .on(click, function (ev) {
                            ev.preventDefault();
                            ev.stopImmediatePropagation();
                            productFilters.toggleOverlay(true);
                            $(".filter-filterListWrap,.filter-filterOptionListWrap").scrollTop(0);
                            overlayState = window.location.search;
                            if (breakpoint.vTablet || breakpoint.hTablet || breakpoint.desktop || breakpoint.kiosk) {
                                productFilters.showFirstGroup();
								productFilters.setDropShadow();
                            }
							else if(breakpoint.mobile){
								productFilters.setDropShadow();
							}
                        });


                    var event = (common.isTouch()) ? 'tap click' : 'touchstart click';
                    $(document).on(event, 'ul.sort-by-list li a', function (e) {
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        if($(e.target).attr('class').indexOf('current') == -1){
                            var selectedNumber = $(this).data('val');
                            sortBy.updateSelection(selectedNumber);
                            sortBy.sortByAnalytics(selectedNumber);
                            productFilters.sortBy = selectedNumber;
                            if (history.pushState) {
                                $("#frmTest").submit(function (e) {
                                    e.preventDefault();
                                    sortBy.closeDropDown();
                                    e.stopImmediatePropagation();

                                    productFilters.refreshData(e, window.location.search, false, false, "ALL", true);
                                    overlay.hide();
                                });
                            }
                            $('#sortBy').val(selectedNumber);
                            $('#frmTest').submit();
                        } else{
                            sortBy.closeDropDown();
                        }
                    });

                    $(".filter-side")
                        .on(click, ".filter-activeClose", function (ev) {
                            ev.preventDefault();
                            ev.stopImmediatePropagation();

                            if (productFilters.bOverlayDirty) {
								productFilters.bOverlayDirty = false;
                                productFilters.refreshData(ev, overlayState, false, false, "LHN", false, true);
                            }
                            productFilters.toggleOverlay(false);
                        })
                        .on(evt, ".filter-categoryItem", function (ev) {
                            if ($(this).hasClass("filter-categoryItem_disabled")) {
                                ev.preventDefault();
                            }
							var currentUrl = window.location.href;
							var removeSort = $(this).attr('href').replace(/\&sortBy\=\d+/,'');
							if(currentUrl.indexOf('sortBy') != -1){
								var sortByValue = productFilters.getSortByVal(currentUrl);
								var hrefAttrVal = removeSort+'&'+sortByValue;
								$(this).attr('href', hrefAttrVal);
							}
                        })
                        .on(click, ".filter-categoryMore", function (ev) {
                            ev.preventDefault();
                            overlay.show({
                                content: $(".filter-categoryList").html()
                            })
                        })
                        .on(click, ".filter-activeClearAll", function (ev) {
                            ev.preventDefault();
                            ev.stopImmediatePropagation();
                        	productFilters.bOverlayDirty = true;
                            if (!$(this).hasClass("filter-activeClearAll_disabled")) {
                                var getFilter = breakpoint.largeDesktop || productFilters.isOverlayOpen === false ? "ALL" : "LHN";
                                productFilters.refreshData(ev, $(this).attr("href"), false, false, getFilter, false);
                            }
                        })
                        .on(click, ".filter-activeItem", function (ev) {
                            ev.preventDefault();
                            ev.stopImmediatePropagation();
                            productFilters.refreshData(ev, $(this).attr("href"), false, false, "ALL", false);
                        })
                        .on(click, ".filter-filterOption", function (ev) {
                            ev.preventDefault();
                            ev.stopImmediatePropagation();
                            productFilters.bOverlayDirty = true;

                            if (!$(this).hasClass("filter-filterOption_disabled") || $(this).hasClass("filter-filterOption_active")) {

                                var getFilter = breakpoint.largeDesktop ? "ALL" : "LHN";
                                productFilters.refreshData(ev, $(this).attr("href"), false, !breakpoint.largeDesktop, getFilter, false);

                            }
                        })
                        .on(click, ".filter-filterOptionMoreButton", function (ev) {
                            ev.preventDefault()
                            productFilters.isOverlayOpen = true;
                            overlayState = window.location.search;

                            var targetDimName = $(ev.target).attr('id'),
                            	$facetList = $(this).parents(".filter-filterOptionList").clone(),
                            	$totalProducts = $('#product-filter-actions .filter-productCount b').text();

                            $facetList.html(productFilters.fnAlphabeticallySortIfRequired(ev, $facetList));

                            overlay.show({
                                customClass: "filter-lightbox",
                                content: '<h3>Refine by \''+$.trim(targetDimName)+'\'</h3><div class="filter-filterList">' +
                                    $facetList.html() +
                                    '</div><div class="filter-overlayApply">Apply</div>',
                                    /*content: '<h3>Refine by \''+$.trim(targetDimName)+'\'</h3><div class="filter-filterList">' +
                                    $facetList.html() +
                                    '</div><div class="filter-showAllPoducts">SHOW <span class="selectedProducts">'+ $totalProducts +'</span> PRODUCTS</div>', */
                                onHideCallback: function () {
                                    productFilters.isOverlayOpen = false;
                                    if (productFilters.bOverlayDirty) {
                                    	if (history.pushState) {
                                            window.setTimeout(function () {
                                            	productFilters.refreshData(ev, overlayState, false, false, "LHN", false, true);
                                            }, 20);
                                        }
                                    }
                                    productFilters.bOverlayDirty = false;
                                }
                            });
                        })

                        .on(click, ".filter-footerApply", function (ev) {
                            ev.preventDefault();
                            ev.stopImmediatePropagation();

                            productFilters.bOverlayDirty = false;
                            if ($(".filter-footerApply b").html() === "0") {
                                $(".filter-warning").addClass("filter-warning_enabled");
                            } else {

                                    productFilters.refreshData(ev, productFilters.savedState, false, false, "ALL", false);

                                productFilters.toggleOverlay(false);
                            }
                        })
                        .on(click, ".filter-warningRefine", function (ev) {
                            ev.preventDefault();
                            ev.stopImmediatePropagation();
                            $(".filter-warning").removeClass("filter-warning_enabled");
                        })
                        .on(click, ".filter-warningClearAll", function (ev) {
                            ev.preventDefault();
                            ev.stopImmediatePropagation();
                            productFilters.refreshData(ev, $(this).attr("href"), false, false, "LHN", false);
                            $(".filter-warning").removeClass("filter-warning_enabled");
                        })

                        .on(click, ".filter-filterGroupLabel", function (ev) {
                            ev.preventDefault();
                            ev.stopImmediatePropagation();
                            if (breakpoint.vTablet || breakpoint.hTablet || breakpoint.desktop || breakpoint.kiosk) {
                                productFilters.showActiveGroup($(this).parent());
                            } else {
                                productFilters.toggleFilter($(this).parent());
                            }
                        })
                        .on(click, ".filter-scrollUp, .filter-scrollDown", function (ev) {
                            ev.preventDefault();
                            ev.stopImmediatePropagation();
                            if(breakpoint.kiosk){
								productFilters.scroll($(this).parent().find(".filter-filterListWrap"), $(this).hasClass("filter-scrollUp") ? 1 : -1);
							} else if(breakpoint.hTablet || breakpoint.vTablet || breakpoint.desktop){
								return false;
							}
                        });


                    // disable IOS bounce scroll
                    $(".filter-overlayWaiting").on("touchmove", function (ev) {
                        ev.preventDefault();
                    });

                    $(document).on("touchmove", function (ev) {
                        if (productFilters.isOverlayOpen) {
                            ev.preventDefault();
                        }
                    });

                    $(".filter-overlay").on("touchmove", function (ev) {
                        if (productFilters.isOverlayOpen) {
                            ev.stopPropagation();
                            ev.preventDefault();
                        }
                    });


                    $(".filter-filterListWrap")
                        .on("scroll", function (ev) {

                            productFilters.scroll($(this), 0);
                        })
                        .on('touchstart', function (ev) {
                            if (productFilters.isOverlayOpen) {
                                var event = ev.originalEvent.touches[0];
                                this.allowUp = (this.scrollTop > 0);
                                this.allowDown = (this.scrollTop < this.scrollHeight - this.clientHeight);
                                this.slideBeginY = event.pageY;
                                this.slideStart = event.pageY;
                                ev.stopPropagation();
                            }
                        })
                        .on("touchmove", function (ev) {
                            if (productFilters.isOverlayOpen) {
                                var event = ev.originalEvent.touches[0];
                                var up = (event.pageY > this.slideBeginY);
                                var down = (event.pageY < this.slideBeginY);
                                this.slideBeginY = event.pageY;
                                if ((up && this.allowUp) || (down && this.allowDown)) {
                                    ev.stopPropagation();
                                } else {
                                   ev.preventDefault();
                                }
                            }
                        })
                        .on("touchend", function (ev) {
                            if (productFilters.isOverlayOpen && Math.abs(this.slideStart - this.slideBeginY) > 20) {
                                ev.stopImmediatePropagation();
                            }
                        });

                    if($(".filter-activeList").find(".filter-activeItem").length === 0){
                        $('.filter-overlay').addClass('filter-activeList_disabled');
                    }

                    if (common.isLegacyIe()) {
                        $('.filter-priceRangeInput[placeholder]').each(function(){
                            $(this).placeholder({
                                inputWrapper: '<span style="position:relative; display:block;"></span>',
                                placeholderCSS: {
                                    "display": "block",
                                    "position": "absolute",
                                    "top": "6px",
                                    "left": "7px",
                                    "color": "#aaaaaa"
                                }
                            });
                        });
                    }

                    validate.init();
                    sortBy.init();

                },
                getSortByVal: function(urlVal){
					var splitVal = urlVal.split('?');
                	var splitAmp = splitVal[1].split('&');
                	var sortBySplit;
                	for(var i=0; i <splitAmp.length; i++){
                		if(splitAmp[i].indexOf('sortBy') != -1){
                			sortBySplit = splitAmp[i];
                		}
                	}
                	return sortBySplit;
                },

				setDropShadow: function(){
					if(breakpoint.mobile){
						if($('.filter-filterList').height() > $(window).height()){
							$('.filter-footer').css('box-shadow', '0 -5px 10px -5px #696868');
						} else{
							$('.filter-footer').css('box-shadow', 'none');
						}
					}
					else if(breakpoint.vTablet || breakpoint.hTablet || breakpoint.desktop){
						if($('.filter-filterList').height() > $(window).height()){
							$('.filter-filterList .filter-scrollDown').addClass('dropShadowBottom');
						} else{
							$('.filter-filterList .filter-scrollDown').removeClass('dropShadowBottom');
						}
						if($('.filter-filterOptionTablet').height() > $(window).height()){
							$('.filter-filterOptionTablet .filter-scrollDown').addClass('dropShadowBottom');
						} else{
							$('.filter-filterOptionTablet .filter-scrollDown').removeClass('dropShadowBottom');
						}
					}
				},

                scroll: function (el, direction) {

                    var pos = el.scrollTop() - direction * 100,
                        scrollHeight = el.prop('scrollHeight');

                    if (pos <= 0) {
                        pos = 0;
                    } else if (pos + el.height() >= scrollHeight) {
                        pos = scrollHeight;
                    }
                    el.parent().find('.filter-scrollUp').toggleClass('filter-scroll_disabled', pos === 0);
                    el.parent().find('.filter-scrollDown').toggleClass('filter-scroll_disabled', pos === scrollHeight);

					if(breakpoint.hTablet || breakpoint.vTablet || breakpoint.desktop){
						if(pos === 0){
							if((el.height() + el.offset().top) > $('.filter-footer').offset().top){
								el.parent().find('.filter-scrollDown').addClass('dropShadowBottom');
							}
							if(el.parent().find('.filter-scrollUp').hasClass('dropShadowTop')){
								el.parent().find('.filter-scrollUp').removeClass('dropShadowTop');
							}
						}
						if(pos === scrollHeight){
							el.parent().find('.filter-scrollUp').addClass('dropShadowTop');
							if(el.parent().find('.filter-scrollDown').hasClass('dropShadowBottom')){
								el.parent().find('.filter-scrollDown').removeClass('dropShadowBottom');
							}
						}
						if(pos != 0 && pos != scrollHeight){
							el.parent().find('.filter-scrollDown').addClass('dropShadowBottom');
							el.parent().find('.filter-scrollUp').addClass('dropShadowTop');
						}
					} else if(breakpoint.mobile){
						if(pos === 0){
							if((el.height() + el.offset().top) > $('.filter-footer').offset().top){
								$('.filter-footer').css('box-shadow','0 -5px 10px -5px #696868');
							}
							$('.filter-activeList').removeAttr('style');
							productFilters.isBottomShadow = true;
						}
						if(pos === scrollHeight){
							$('.filter-activeList').css('box-shadow', '0 3px 5px #696868');
							$('.filter-footer').removeAttr('style');
							productFilters.isBottomShadow = false;
						}
						if(pos != 0 && pos != scrollHeight){
							$('.filter-footer').css('box-shadow','0 -5px 10px -5px #696868');
							$('.filter-activeList').css('box-shadow', '0 3px 5px #696868');
							productFilters.isBottomShadow = true;
						}
					} else if(breakpoint.kiosk){
						if(!el.parent().find('.filter-scrollUp').hasClass('filter-scroll_disabled')){
							el.parent().find('.filter-scrollUp').css({'box-shadow':'0 5px 10px -5px','z-index':'100'});
						} else{
							el.parent().find('.filter-scrollUp').removeAttr('style');
						}
						if(!el.parent().find('.filter-scrollDown').hasClass('filter-scroll_disabled')){
							el.parent().find('.filter-scrollDown').css('box-shadow','-3px -3px 10px #696868');
						} else{
							el.parent().find('.filter-scrollDown').removeAttr('style');
						}
					}
                    if (direction !== 0) {
                        el.scrollTop(pos);
                    }
                },
                lastState: '',

                sortBy: 0,
                savedState: '',

                refreshData: function (ev, url, isManager, forceAjax, getFilters, sortProducts, replaceState) {
                    var that = this,
                        body = $("html"),
                        //sortBy = $.isNumeric(productFilters.sortBy) ? "&sortBy=" + productFilters.sortBy : "";
                        sortByval = '',
						$categoryNav = '',
						$selectedDimensionNav = '',
	                    $elem = util.getFormByElement(ev.target);

                    if($elem.is('form')){
						if($elem.is('form#frmTest')){
							sortByval = $.isNumeric(productFilters.sortBy) ? "&sortBy=" + productFilters.sortBy : "&sortBy=";
						}
					}

                    if (this.isOverlayOpen) {
                        this.lastState = url;
                    }

                    this.savedState = url;
                    if (history.pushState || forceAjax) {
                    	body.addClass("filter-refresh");
                        loadMore.getResults(ev, function (urlfromBackend, data) {
                            if (data.analytics) {
                                loadMore.submitWebAnalytics(data.analytics);
                            }

                            if (breakpoint.kiosk) urlfromBackend += '&kiosk';

                            if (isManager !== true && !productFilters.isOverlayOpen) {
                                var stateDataObj = {
                                    state_getfilters: getFilters,
                                    state_sortProducts: sortProducts,
                                    state_currentURL: urlfromBackend,
                                    state_sortBy: productFilters.sortBy
                                };
                                if (!replaceState) {
                                    historyManager.setUrl(urlfromBackend, stateDataObj);
                                } else {
                                    historyManager.replaceUrl(urlfromBackend, stateDataObj);
                                }
                            }
                            if (data.showFilters !== "Products") {
                            	var $categoryNav = '';
								var $selectedDimensionNav = '';
								var $dimensions;
								if(data.leftNavigation.selectedDimensionNav !== ''){
									$selectedDimensionNav = $.parseJSON(data.leftNavigation.selectedDimensionNav);
								}
								if(data.leftNavigation.categoryNav !== ''){
									$categoryNav = $.parseJSON(data.leftNavigation.categoryNav);
								}

								if(data.leftNavigation.dimensions !== ''){
									$dimensions = data.leftNavigation.dimensions;
								}                                productFilters.refreshCategory($categoryNav.facetArray);
                                productFilters.refreshActiveFilter($selectedDimensionNav);
                                productFilters.refreshFilter(
                                    $dimensions,
                                    data.totalProductsCount,
                                    $selectedDimensionNav.facetArray);
                                productFilters.refreshProducts({
                                    total: data.totalProductsCount,
                                    productList: data.productContent
                                });
                            }
                            body.removeClass("filter-refresh");
                            productFilters.sortBy = data.selectedSortOption;
							sortBy.updateSelection(productFilters.sortBy);
							if($('.detail-specification-bullet').length){
		                    	 $('.detail-specification-bullet ul li').each(function(){
		                         	common.Ellipsis.init($(this));
		                         });
		                    }

							/*
		                     * GFO-4787 - New PLP design

							if ($('.filter-lightbox').length) {
								console.log("totalCount"+data.totalProductsCount);
								$('.filter-lightbox .filter-showAllPoducts .selectedProducts').text(data.totalProductsCount);
							}  */

                        }, false, true, true, false, false, getFilters, sortProducts, url + sortByval);


                    } else {
                        window.location = url;
                    }
                },

                refreshCategory: function (data) {
                    var wrap = $(".filter-categoryOptionList"),
                        activeList = [],
                        element = null,
                        lastElement = null,
                        html = null;

                    if(data !== undefined){
	                    if (data.length === 0) {
	                        $(".filter-categoryList").text('');
	                    } else {
	                        if (wrap.length === 0) {
                                $(".filter-categoryList").replaceWith(templates.categoryList());
                                !window.isKiosk() && productFilters.collapseCategories();
                                wrap = $(".filter-categoryOptionList");
	                        }


	                        wrap.find(".filter-categoryItem").addClass("filter-categoryItem_disabled");

	                        $.each(data, function (key, item) {

	                            element = wrap.find("#" + item.id);
	                            if (element.length !== 0) {
	                                element.attr("href", item.url)
	                                    .find(".filter-categoryOptionCount")
	                                    .text("(" + item.count + ")");
	                            } else {
	                                html = templates.categoryItem(item);
	                                if (lastElement) {
	                                    lastElement.after(html);
	                                } else {
	                                    wrap.prepend(html);
	                                }
	                            }

	                            lastElement = wrap.find("#" + item.id)
	                                .toggleClass("filter-categoryItem_disabled", item.count === 0);

	                            if (item.count != 0) {
	                                activeList.push(item.id);
	                            }

	                        });
	                    }
                    } else{
                    	 $(".filter-categoryList").text('');
                    }
                    $(".filter-categoryCount").html(activeList.length);

                },

                activeFilters: [],

                refreshActiveFilter: function (data) {
                    var html = "",
                        that = this;
                    this.activeFilters = [];

                    $(".filter-activeItem").remove();
                	if(data !== ''){
	                    $(".filter-activeClearAll")
	                        .toggleClass("filter-activeClearAll_disabled", data.facetArray.length === 0)
	                        .attr("href", data.clearAllURL);

	                    $(".filter-warningClearAll")
                        .toggleClass("filter-warningClearAll_disabled", data.facetArray.length === 0)
                        .attr("href", data.clearAllURL);

	                    $(".filter-overlay").toggleClass("filter-activeList_disabled", data.facetArray.length === 0);

	                    if (data) {
	                        $.each(data.facetArray, function (key, item) {
	                            productFilters.activeFilters.push(item.id);
	                            if (item.type === "Multi_Image") {
	                                item.displayName = '<img src="' + imageList[item.displayName] + '" class="filter-filterOptionImage">';
	                            }
	                            html = html + '<a href="' + item.url + '" class="filter-activeItem">' +
	                                item.displayName +
	                                '</a>';
	                        });

	                        $(".filter-activeLabel").after(html);
	                    }
                	} else{
						$(".filter-activeClearAll")
						.addClass("filter-activeClearAll_disabled");
						$(".filter-overlay").toggleClass("filter-activeList_disabled", true);
                	}
                },

                refreshFilter: function (data, count, filters) {
                    var $data = '';
                    if(data.dimensionContainer !== ""){
                        $data = $.parseJSON(data.dimensionContainer);
                    }
                    var wrap = $(".filter-filterList,.filter-filterOptionTablet"),
                        active = false,
                        that = this,
                        group = $(".filter-filterListWrap"),
                        iSpliceAmount,
                        aFacets,
                        oFacetsSegment,
                        $selector,
                        $chunk,
                        iFilterSpliceAmount = 0,
                        lastDimension=null;

                    wrap.find(".filter-filterOption")
                        .addClass("filter-filterOption_disabled")
                        .removeClass("filter-filterOption_active")
                        .attr('rel','follow');

                    $selector = wrap.find(".filter-filterOption .filter-filterOptionCount");
                    iFilterSpliceAmount = $selector.length;
                    //console.log(iFilterSpliceAmount);
                    if (iFilterSpliceAmount > 40) {
                        var iDivisable = Math.floor(iFilterSpliceAmount / 40);
                        iFilterSpliceAmount = Math.floor(iFilterSpliceAmount / iDivisable);
                    }
                    while($selector.length) {
                        $chunk = $($selector.splice(0, iFilterSpliceAmount));
                        (function($selectorChunk) {
                            setTimeout(function() {
                                $selectorChunk.text('(0)');
                            }, 20);
                        })($chunk);
                    }

                    wrap.find(".filter-filterGroupLabel")
                        .removeClass("filter-filterGroupLabel_selected");

                    if (count === 0) {
                        $(".filter-priceRangeWrap").html("");
                    }

                    $.each($data, function (k, v) {
                        var lastElement = null;
                        active = false;
                        if (v.facetArray) {
                            if ($('#' + k).length === 0) {
                                if(lastDimension)
                                {
                                    lastDimension.parent().after(templates.filterGroup(k, v));
                                }else{
                                    group.prepend(templates.filterGroup(k, v));
                                }
                            }
                            lastDimension=$('#' + k);

                            aFacets = v.facetArray.slice(0);
                            iSpliceAmount = aFacets.length;

                            if (iSpliceAmount > 20) {
                                var iDivisable = Math.floor(iSpliceAmount / 20);
                                iSpliceAmount = Math.floor(iSpliceAmount / iDivisable);
                            }

                            var count = 0;
                            while(aFacets.length) {
                                oFacetsSegment = aFacets.splice(0, iSpliceAmount);
                                (function internalFacetLoop(oInternalFacetsSegment) {
                                    setTimeout(function deferredFactLoop() {
                                        var html = null,
                                            element = null,
                                            lastElement = null,
                                            filters = null,
                                            item = null,
                                            key;
                                            for (key in oInternalFacetsSegment) {
                                                if (oInternalFacetsSegment.hasOwnProperty(key)) {
                                                    item = oInternalFacetsSegment[key];

                                                element = wrap.find("#" + item.id);
                                                if (element.length !== 0) {
                                                    element.attr("href", item.url)
                                                    element = element.find(".filter-filterOptionCount");

                                                    var sFacetCount = "(" + item.count + ")";
                                                    element.text(sFacetCount);

                                                    count+=1;
                                                } else {
                                                    html = templates.filterOption(item);
                                                    //group the facets under respective dimension after applying filter and pge refresh
                                                    if (lastElement != null && lastElement.parents().find('.filter-filterGroup').children('h3').attr('id') == k) {
                                                        lastElement.parent().after(html);
                                                    }
                                                    else {
                                                        if(count > 0){
                                                            $("#" + k).parent().find(".filter-filterOptionListWrap>li:nth-child("+count+")").after(html);
                                                        } else {
                                                            $("#" + k).parent().find(".filter-filterOptionListWrap").prepend(html);
                                                        }
                                                    }
                                                    productFilters.refreshFacetCheckForToggleClass(k);
                                                }

                                                wrap.find("#" + item.id)
                                                    .toggleClass("filter-filterOption_disabled", parseInt(item.count, 10) === 0)
                                                    .toggleClass("filter-filterOption_active", $.inArray(item.id, productFilters.activeFilters) !== -1);

                                                if ($.inArray(item.id, productFilters.activeFilters) !== -1) {
                                                    active = true;
                                                }
                                            }
                                        }
                                    }, 30);
                                })(oFacetsSegment);
                            }
                        }
                    });
                    if (data.priceRangeHtml !== undefined) {
                            $(".filter-priceRangeWrap").replaceWith(data.priceRangeHtml);
                            $("#price-range #from").val('');
                            $("#price-range #to").val('');
                            $('#price-range').attr('action', $('#priceRangeAction').val());
                            validate.init();
                    }  else{
                            $(".filter-priceRangeWrap").html("");
                    }
                    if(filters !== undefined){
                        $.each(filters, function (k, v) {

                            wrap.find("#" + v.id).addClass("filter-filterOption_active")
                                .attr({
                                  "href": v.url,
                                  "rel" : "nofollow"
                                })
                                .parents(".filter-filterGroup")
                                .find(".filter-filterGroupLabel")
                                .addClass("filter-filterGroupLabel_selected");

                        });
                    }

                    $(".refine a")
                    .toggleClass("filter_refine_hasFilter", $(".filter-activeList").find(".filter-activeItem").length !== 0);

                },

                refreshFacetCheckForToggleClass: function(sKey) {
                    var filters = $('#' + sKey)
                                    .parent()
                                    .find(".filter-filterOptionList");

                    var bShowLongList = filters.find(".filter-filterOption").length > 8;
                    filters.toggleClass("filter-filterOptionList_long", bShowLongList);

                },

                refreshProducts: function (data) {
                    $(".filter-productCount b").text(data.total);
                    $(".filter-footerApply b").text(data.total);

                    $(".filter-footerApply").toggleClass("filter-footerApply_disabled", data.total === 0);

                    $('#listing').attr('data-maxcount', data.total);
                },

                showActiveGroup: function (el) {
                    var list = $(".filter-filterOptionTablet .filter-filterListWrap"),
                        $facetHeading = el.find(".filter-filterGroupLabel");

                    $(".filter-activeAreaText b").html($facetHeading.text());
                    list.html(productFilters.fnAlphabeticallySortIfRequired(el, list));

                    $(".filter-filterGroupLabel_active").removeClass("filter-filterGroupLabel_active");
                    el.find(".filter-filterGroupLabel").addClass("filter-filterGroupLabel_active");

                    $(".filter-filterGroup_active", '.filter-filterListWrap').removeClass("filter-filterGroup_active");
                    el.addClass("filter-filterGroup_active");

                    if (breakpoint.kiosk) {
                        this.scroll(list, 0);
                    }
    				if(breakpoint.vTablet ||breakpoint.hTablet || breakpoint.desktop){
    					if(list.find('.filter-filterOptionListWrap').height() > $('.filter-footer').position().top){
    						$('.filter-filterOptionTablet .filter-scrollDown').addClass('dropShadowBottom');
    					} else{
    						$('.filter-filterOptionTablet .filter-scrollDown').removeClass('dropShadowBottom');
    					}
    					if(el.parent().height() > $('.filter-footer').position().top){
    						$('.filter-filterList .filter-scrollDown').addClass('dropShadowBottom');
    					} else{
    						$('.filter-filterList .filter-footer').removeClass('dropShadowBottom');
    					}
    					//console.log('check for parent::'+(el.parent()));
    				}
                },

                showFirstGroup: function () {
                    this.showActiveGroup($(".filter-filterGroup:first-child"));
                },

                scrollPosition: 0,

                toggleOverlay: function (setOpen) {
                    this.isOverlayOpen = setOpen;
                    if (breakpoint.mobile) {
                        this.toggleAllFilters(false);
                    }

                    if (setOpen) {
                        this.scrollPosition = $(window).scrollTop();
                        $(window).scrollTop(0);
                    }
                    setTimeout(function () {
                        $(".filter-overlay").toggleClass("filter-overlay_active", setOpen);
                        $("#wrapper").css({
                        	"overflow": setOpen ? "hidden" : "",
                        	"height": setOpen ? "100%" : ""
                    });
                    }, 100);

                    if (!setOpen) {
                        if (this.scrollPosition) {
                            $(window).scrollTop(this.scrollPosition);
                        }
                    }

                    if (breakpoint.kiosk) {
                        this.scroll($(".filter-filterListWrap"), 0);
                    }
                    if ($('.filter-filterListWrap').length) {
    			      FastClick.attach($('.filter-filterListWrap').get(0));
    			    }
                },

                toggleFilterTimer: null,

                toggleFilter: function (el, setOpen) {

                	var filterList = el.find(".filter-filterOptionList"),
                    filterListHeight = filterList.children().outerHeight(true),
                    isOpen = el.hasClass("filter-filterGroup_active"),
    				that = this;

    				if (setOpen === undefined) {
    					 setOpen = !isOpen;
    				}

    				el.toggleClass("filter-filterGroup_active", setOpen);
    				if (isOpen) {
    					filterList.css({ 'max-height': '0' });

    				} else {
    					filterList.css({ 'max-height': filterListHeight });
    				}


    			  if(breakpoint.mobile){

                        var list = $(".filter-filterGroup .filter-filterOptionList .filter-filterListWrap");

                        list.html(productFilters.fnAlphabeticallySortIfRequired(el, list));

    				  if($('.filter-filterListWrap').prop('scrollHeight') !== 0){

						 setTimeout(function() {
							if(($(".filter-filterListWrap").scrollTop() + $('.filter-filterListWrap').height() == $('.filter-filterListWrap').prop('scrollHeight'))){
								$('.filter-footer').css('box-shadow', 'none');
							} else{
								$('.filter-footer').css('box-shadow', '0 -5px 10px -5px #696868');
							}
    					}, 50);
    				  }
    				  if(productFilters.isOverlayOpen === false) {
    					this.toggleFilterTimer = setTimeout(function () {
    						filterList.css({height: ""});
    					}, 2500);
    				  }
    			  }
    			},

                toggleAllFilters: function (setOpen) {
                    var that = this,
                        $productFilterGroups = $(".filter-filterGroup"),
                        iFilterSpliceAmount = Math.ceil($productFilterGroups.length),
                        aChunk;

                    while($productFilterGroups.length) {
                        aChunk = $productFilterGroups.splice(0, iFilterSpliceAmount);
                        (function (aSelectorChunk, bSetOpen, productFiltersRef) {
                            setTimeout(function () {
                                //for (var i = 0; i < aSelectorChunk.length; i++) {
                                    productFiltersRef.toggleFilter($(aSelectorChunk[0]), bSetOpen);
                                    $('.filter-filterGroup_active .filter-filterOptionList').attr("style", "max-height:auto");
                               // }
                            }, 20);
                        })(aChunk, setOpen, productFilters);
                    }
                },

                fnAlphabeticallySortIfRequired: function(el, list){
                	var $facetHeading,
                		$facetContent;

                    if (!breakpoint.largeDesktop) {

                        $facetHeading = el.find(".filter-filterGroupLabel");
                        $facetContent = el.find(".filter-filterOptionList");

                    } else {

                        $facetHeading = $(el.target).parents('.filter-filterGroup').find('.filter-filterGroupLabel');
                        $facetContent = list;

                    }

                    if (productFilters.isAlphabetSortedRequired($facetHeading.prop('id')) && $facetHeading.data('beenSorted') !== true) {
                        $facetContent = productFilters.fnSortListAlphabetically($facetContent);
                        if (!breakpoint.largeDesktop) {
                           $facetHeading.data('beenSorted', true);
                        }
                    }


                    return $facetContent.html();

                },

                isAlphabetSortedRequired: function(sID) {
                    return $.inArray(sID, productFilters.aEndecaIDsForAlphabetSort) === -1 ? false : true;
                },

                fnSortListAlphabetically: function($facetList) {

                    var $sortedFacets = $('li', $facetList).get().sort(function(a, b) {
                        var sCleanA = a.textContent.toLowerCase().replace("\n", ""),
                            sCleanB = b.textContent.toLowerCase().replace("\n", "");
                        if (sCleanA < sCleanB) {
                            return -1;
                        } else if (sCleanA > sCleanB) {
                            return 1
                        } else {
                            return 0;
                        }
                    }),
                    $facetWrapper = $('<ul class="filter-filterOptionListWrap" />').html($sortedFacets);

                    $facetList.html($facetWrapper);

                    return $facetList;
                },

                fnSetGlobalFilterVars: function(){

                    window.TescoData = window.TescoData || {};
                    window.TescoData.filterGroupOptions = window.TescoData.filterGroupOptions || {};
                    window.TescoData.filterGroupOptions.idsForAlphabetSort = window.TescoData.filterGroupOptions.idsForAlphabetSort || [];
                    window.TescoData.filterGroupOptions.idsForAlphabetSort.push("40084", "40068", "40104", "40525", "40261", "40344", "55104", "40234", "55101", "40389", "40567", "40255", "50466", "51781", "40222", "40711", "40710", "40303", "51816", "40625");
                    productFilters.aEndecaIDsForAlphabetSort = window.TescoData.filterGroupOptions.idsForAlphabetSort;

                },

                fnCopyFilterList: function(){
                    productFilters.unsortedFilterList = $('.filter-filterList').clone(true);
                },

                fnResetFilterList: function(){
                    $('.filter-filterList').html(productFilters.unsortedFilterList.html());
                    productFilters.unsortedFilterList = null;
                },

                aEndecaIDsForAlphabetSort: [],
                unsortedFilterList: null,
                oURLParams: null,

                fnInitSetTitle: function() {
                	productFilters.oSetPageTitle = new SetPageTitle({    // instantiate the set page title class with pre selected settings
                        sSuffixText: '- Tesco.com',
                        sSetPageTitleEventName: 'updatePageTitle',
                        sResetPageTitleEventName: 'resetPageTitle',
                        bReplaceEntireTitle: false,
                        bAppendBeforeSuffix: true
                    });
                },

                fnBindSetTitleEvents: function() {
                	/*
                     * GFO-5897 - New code to trigger a Page Title update on page load
                     * The title should reflect the "last applied filter" hidden span
                     */
                	productFilters.fnInitSetTitle();

                    if (productFilters.oSetPageTitle) {
                        var sLastAppliedFilter,
                            sHiddenFilterNameSelector = 'h1.page-title span.last_applied_filter',
                            sLastFilterDirty,
                            sLastAppliedFilterDirty,
                            sDecodeURL,
                            sLastAppliedFilterConvertChars,
                            sLastAppliedFilter;

                        if ($.trim($(sHiddenFilterNameSelector).text()) !== '') {    // check if the hidden dom element has valid text, if so trigger update page title event
                            sLastAppliedFilter = $.trim($(sHiddenFilterNameSelector).text());

                            $(window).trigger('updatePageTitle', {
                                sUpdatedPageTitlePartial: sLastAppliedFilter
                            });
                        }

                        $(window).on('historyManagerSetUrlFired', function() {    // bind event lister to trigger function updating the page title after the url has changed
                            if (productFilters.oSetPageTitle) {
                                productFilters.oURLParams = common.getURLParams();
                                sLastAppliedFilterDirty = productFilters.oURLParams.lastFilter;

                                if (sLastAppliedFilterDirty === undefined) {
                                    $(window).trigger('resetPageTitle');
                                } else {
                                    sDecodeURL = decodeURI(sLastAppliedFilterDirty);
                                    sLastAppliedFilterConvertChars = sDecodeURL.replace(/\+|_/g, ' ');
                                    sLastAppliedFilter = '- ' + sLastAppliedFilterConvertChars.replace(/\|/g, ': ').replace(/\%26/g, '&').replace(/\%A3/g, decodeURI('%C2%A3'));
                                    $(window).trigger('updatePageTitle', {
                                        sUpdatedPageTitlePartial: sLastAppliedFilter
                                    });
                                }
                            }
                        });
                    }
                },

                collapseCategories: function collapseCategories() {
                    var toggleElementParent = '.clothing-filter .filter-categoryList',
                        toggleCustomEventName = 'toggle-categories',
                        categoryExpandCollapse = null,
                        categoryListItems = null,
                        categoryListItemLength = 0,
                        i=0;
                    if (!$('.filter-filterListWrap .clothing-filter').length) {
                        $('.filter-filterListWrap').append($('.clothing-filter').detach());
                    }
                    categoryExpandCollapse = new ToggleExpandCollapse({
                        bEnableCustomEvent: true,
                        sSetCollapsedCSSClassName: 'categoryList_collapsed',
                        sSetExpandedCSSClassName: 'categoryList_expanded',
                        sToggleContainer: '.clothing-filter .filter-categoryList',
                        sToggleCustomEventName: toggleCustomEventName,
                        sToggleElementParent: toggleElementParent,
                        sToggleTriggerElement: '.filter-categoryLabel'
                    });
                    categoryExpandCollapse.init();
                    $(window).on(toggleCustomEventName, function (evt, data) {
                        var categoryListWrapper = $(toggleElementParent).find('.filter-categoryOptionList'),
                            listWrapperHeight = 0;
                        if (!categoryListWrapper.length) {
                            return;
                        }
                        categoryListItems = categoryListWrapper.children();
                        categoryListItemLength = categoryListItems.length;
                        switch (data.toggleEventType) {
                            case 'toggle-expand':
                                for (i = 0; i < categoryListItemLength; i++) {
                                    listWrapperHeight += categoryListItems[i].offsetHeight;
                                }
                                categoryListWrapper.css({'max-height': listWrapperHeight + 'px'});
                            break;
                            case 'toggle-collapse':
                                categoryListWrapper.css({'max-height': listWrapperHeight});
                            break;
                            // no default
                        }
                        return;
                    });
                }

            };

        common.init.push(productFilters.init);

        breakpoint.mobileIn.push(function () {
            productFilters.fnCopyFilterList();

            if (common.isPage('PLP')) {
                productFilters.toggleAllFilters(false);
            }
        });
        breakpoint.mobileOut.push(function () {
            productFilters.fnResetFilterList();
        });

        breakpoint.vTabletIn.push(function(){
            productFilters.fnCopyFilterList();
        });
        breakpoint.vTabletOut.push(function () {
            productFilters.fnResetFilterList();
        });

        breakpoint.hTabletIn.push(function(){
            productFilters.fnCopyFilterList();
        });
        breakpoint.hTabletOut.push(function () {
            productFilters.fnResetFilterList();
        });

        breakpoint.desktopIn.push(function(){
            productFilters.fnCopyFilterList();
        });
        breakpoint.desktopOut.push(function () {
            productFilters.fnResetFilterList();
        });

        breakpoint.largeDesktopIn.push(function () {
            if (common.isPage('PLP')) {
                productFilters.toggleOverlay(false);
                productFilters.toggleAllFilters(true);

            }

            if (productFilters.unsortedFilterList != null){
                $('.filter-filterList').html(productFilters.unsortedFilterList.html());
            }

            $('.filter-footer').css('box-shadow', '');
            $('.filter-activeList').css('box-shadow', '');

        });
        breakpoint.largeDesktopOut.push(function () {
            if (common.isPage('PLP')) {
                overlay.hide();
            }
        });

        breakpoint.kioskIn.push(function () {
            if (common.isPage('PLP')) {
                //TODO hack because modernizer does not recognize touch in kiosk
                $("html").removeClass("no-touch").addClass("touch");

            }
        });

        return productFilters;
    });

/*jslint plusplus: true */
/*global define: true, console: true */
define('modules/home-page-stamps/common',['domlib', 'modules/common', 'modules/breakpoint'], function ($, common, breakpoint) {

    'use strict';

    var stamps = {
        el: '.homepage-trade-stamp',
        elWidth: 0,
        items: 0,
        activeItem: 0,
        infiniteOffsetWidth: 1152,
        isAnimated: false,
        initialSet: null,

        next: function (e) {

            e.preventDefault();
            e.stopPropagation();
            if (!stamps.isAnimated) {
                stamps.append(true);
            }
            return false;
        },

        previous: function (e) {

            e.preventDefault();
            e.stopPropagation();
            if (!stamps.isAnimated) {
                stamps.prepend(true);
            }
            return false;
        },

        append: function (animate) {

            var el = $(stamps.el + ' li').eq(0),
                clone = el.clone();

            clone.appendTo(stamps.el + ' ul');

            if (animate) {
                stamps.activeItem++;
                stamps.animate(el, true);
            } else {
                el.remove();
            }
        },

        prepend: function (animate) {

            var el = $(stamps.el + ' li').eq(stamps.items - 1),
                clone = el.clone();

            clone.prependTo(stamps.el + ' ul');

            if (animate) {
                stamps.activeItem++;
                stamps.setActiveItem(false);
                stamps.activeItem--;
                stamps.animate(el);
            } else {
                el.remove();
            }
        },

        animate: function (el, append) {

            var ul = $(stamps.el + ' ul');
            stamps.isAnimated = true;

            setTimeout(function () {
                ul.addClass('animate');
                stamps.setActiveItem();

                setTimeout(function () {
                    ul.removeClass('animate');
                    if (append) {
                        stamps.activeItem--;
                        stamps.setActiveItem(false);
                        el.remove();
                        stamps.isAnimated = false;
                    } else {
                        el.remove();
                        stamps.isAnimated = false;
                    }
                }, 600);
            }, 150);
        },

        getWindowCenter: function () {

            var wCenter;

            $('body, html').css({overflow: 'hidden'});
            wCenter = $(window).width() / 2;
            setTimeout(function () {
                $('body, html').css({overflow: ""});
            }, 20);

            wCenter = Math.round(wCenter);

            return wCenter;
        },


        setActiveItem: function (animate) {

            var wCenter = $(window).width() / 2,
                tileOffset = stamps.elWidth / 2,
                compensation = (common.isTouch()) ? 0 : 5,
                activeOffset = stamps.activeItem * (stamps.elWidth + 17),
                left = (wCenter - tileOffset) - activeOffset - 8 - compensation;

            if (common.isModern()) {
                $(stamps.el + ' ul').css({
                    '-webkit-transform': 'translate3d(' + left + 'px,0,0)',
                    '-moz-transform': 'translate3d(' + left + 'px,0,0)',
                    '-ms-transform': 'translate3d(' + left + 'px,0,0)',
                    '-o-transform': 'translate3d(' + left + 'px,0,0)',
                    'transform': 'translate3d(' + left + 'px,0,0)'
                });
            } else {
                if (animate) {
                    $(stamps.el + ' ul').animate({left: left}, 400);
                } else {
                    $(stamps.el + ' ul').css({left: left});
                }
            }
        },

        initPrepend: function () {

            return ($(stamps.el + ' li').eq(0).offset().left > 8) ? false : true;
        },

        reset: function () {

            if (stamps.isCarousel()) {
                $(stamps.el).removeClass('carousel');
                $(stamps.el + ' ul').removeClass('animated');
                stamps.unbindEvents();
                stamps.resetOrder();
                stamps.activeItem = 0;
                stamps.isAnimated = false;

                setTimeout(function () {
                    $(stamps.el + ' ul').attr('style', '');
                }, 50);
                stamps.setHeights();
            }
        },

        resetOrder: function () {

            $(stamps.el + ' ul').html(stamps.initialSet);
        },

        exists: function () {

            return $(stamps.el).length;
        },

        itemsPerPage: function () {

            return Math.floor($(window).width() / stamps.elWidth);
        },

        firstItem: function () {

            return Math.ceil(stamps.itemsPerPage() / 2) - 1;
        },

        isCarousel: function () {

            return $(stamps.el).hasClass('carousel');
        },

        resize: function () {

            var firstItem;

            stamps.elWidth  = $('li', stamps.el).eq(0).width();
            stamps.setActiveItem();
            firstItem = $('ul li', stamps.el).eq(0);

            if (parseInt(firstItem.offset().left, 10) > 8 && stamps.isCarousel()) {
                stamps.activeItem++;
                stamps.prepend();
            }
        },

        bindEvents: function () {

            $(window).on('resize orientationchange', stamps.resize);
            $(stamps.el).on('swipeLeft', stamps.next);
            $(stamps.el).on('swipeRight', stamps.previous);
        },

        unbindEvents: function () {

            $(window).off('resize orientationchange', stamps.resize);
            $(stamps.el).off('swipeLeft', stamps.next);
            $(stamps.el).off('swipeRight', stamps.previous);
        },

        tileClick: function () {

            $(stamps.el + ' li').each(function () {
                var self = this;

                $(self).on('click', function () {
                    var link = $(self).find('a').attr('href');
                    window.location = link;
                    return false;
                });
            });
        },

        setHeights: function () {

            var maxHeight = 0,
                elHeight;

            $(stamps.el + ' li').css('height', 'auto');
            /*jslint unparam: true*/
            $(stamps.el + ' li').each(function (i, e) {
                elHeight = e.offsetHeight;
                if (elHeight > maxHeight) {
                    maxHeight = elHeight;
                }
            });
            /*jslint unparam: false*/
            $(stamps.el + ' li').css('height', maxHeight);
        },

        init: function () {

            if (stamps.exists()) {
                setTimeout(function () {
                    stamps.setHeights();
                }, 100);

                if (!stamps.isCarousel() && (breakpoint.mobile || breakpoint.vTablet || breakpoint.hTablet)) {

                    if (breakpoint.mobile || breakpoint.vTablet || breakpoint.hTablet) {
                        $(stamps.el).addClass('show-nav');
                        $(stamps.el).find('.nav .next').on('click tap', stamps.next);
                        $(stamps.el).find('.nav .back').on('click tap', stamps.previous);
                    }

                    $(stamps.el).addClass('carousel');
                    stamps.elWidth  = $('li', stamps.el).eq(0).width();
                    stamps.items  = $('li', stamps.el).length;
                    stamps.activeItem = stamps.firstItem();
                    stamps.initialSet = $(stamps.el + ' li');
                    if (stamps.initPrepend()) {
                        stamps.prepend();
                        stamps.activeItem++;
                    }
                    stamps.bindEvents();

                    setTimeout(function () {
                        stamps.elWidth  = $('li', stamps.el).eq(0).width();
                        stamps.setActiveItem();
                    }, 250);
                }
            }
        }

    };

    common.init.push(stamps.tileClick);
    breakpoint.mobileIn.push(stamps.init);
    breakpoint.vTabletIn.push(stamps.init);
    breakpoint.vTabletOut.push(stamps.reset);
    breakpoint.hTabletIn.push(stamps.init);
    breakpoint.hTabletOut.push(stamps.reset);
    breakpoint.desktopIn.push(stamps.init);
    breakpoint.desktopOut.push(stamps.reset);
    breakpoint.largeDesktopIn.push(stamps.init);
    breakpoint.largeDesktopOut.push(stamps.reset);
    breakpoint.kioskIn.push(stamps.init);

    return stamps;
});

/* eslint-disable */

define('modules/sticky-sidebar/common',['domlib', 'modules/breakpoint', 'modules/common'], function ($, breakpoint, common) {

    // get the bottom position of the first element in the collection
    $.fn.getBottom = function () {
        return parseInt(this.eq(0).offset().top + this.eq(0).outerHeight(), 10);
    };

    var stickySidebar = {

        // elements required for sticky sidebar functions
        $wrapper: [],
        $primary: [],
        $secondary: [],

        isBlocked: function () {
            var self = stickySidebar;
            return breakpoint.mobile || !self.$secondary.length;
        },

        // stop any running animations (an animation on the secondary
        // could be running from saveForLater.show() function)
        stop: function () {
            var self = stickySidebar;
            if (typeof jQuery !== 'undefined') {
                self.$secondary.stop();
            }
        },

        // reset/clear any of the amended position related css rules
        // important for mobile to ensure the secondary clears correctly
        // when going to a stacked layout
        reset: function () {
            var self = stickySidebar;

            if (breakpoint.mobile || common.isTouch()) {
                self.$secondary.css({
                    position: 'static',
                    bottom: 'auto',
                    right: 'auto',
                    top: 'auto'
                });
            } else {
                self.$secondary.css({
                    position: 'absolute',
                    bottom: 'auto',
                    right: 0,
                    top: 0
                });
            }
        },

        // lock position of the secondary bar so it doesn't move (used
        // when animating into new position)
        lock: function (forceTop) {
            var self = stickySidebar;

            if (self.isBlocked()) {
                return;
            }

            var css = {
                position: 'absolute',
                bottom: 'auto',
                top: 'auto',
                right: 0
            };

            self.stop();

            // check if we're at the bottom, otherwise assume at top
            // or off screen
            // + 1 to compensate for discrepancy when animating
            if (!forceTop && self.$secondary.getBottom() + 1 >= self.$wrapper.getBottom()) {
                css.bottom = 0;
            } else {
                css.top = self.$secondary.offset().top - self.$primary.offset().top;
            }

            self.$secondary.css(css);
        },

        // if the secondary bar is off the screen, animate or snap it
        // back into position
        animate: function () {
            var self = stickySidebar;

            if (self.isBlocked()) {
                return;
            }

            self.lock();

            var primaryY = self.$primary.offset().top;
            var secondaryY = 0;

            // exit if the secondary is already at the top
            if (self.$secondary.offset().top <= primaryY) {
                return;
            }

            var scrollY = $(document).scrollTop();

            // animate to top if the scroll height plus the
            // secondary height does not exceed the base of the
            // wrapper
            if (scrollY + self.$secondary.outerHeight() < self.$wrapper.getBottom()) {
                secondaryY = scrollY - primaryY;
            }

            // snap or animate to bottom
            else {

                // if the secondary exceeds the height of the
                // wrapper, then don't animate - just snap into
                // place
                // snap rather than animate as at this point the
                // seconary wrapper will be overlapping page
                // content
                // + 1 to compensate for discrepancy when
                // animating
                if (self.$secondary.getBottom() + 1 >= self.$wrapper.getBottom()) {
                    self.$secondary.css({
                        bottom: 0,
                        top: 'auto'
                    });

                    return;
                }

                // animate to bottom of the wrapper
                else {
                    secondaryY = self.$wrapper.getBottom() - self.$secondary.outerHeight() - primaryY;
                }

                return;

            }

            self.$secondary.animate({
                top: secondaryY
            }, 500);
        },

        // keep the secondary panel (has basket summary) in view when
        // scrolling
        sticky: function () {
            var self = stickySidebar;

            // on window resize, if the device/viewport is blocked,
            // then reset the sticky sidebar
            // otherwise animate into updated position
            $(window).on('breakpointChange', function handleBreakpointChange(e) {
                if (e.newViewport !== 'mobile') {
                    // Reset height of container and let "handleResize" method resize if the user switches viewport. 
                    self.$wrapper.css('height', 'auto');

                    /*
                    * do not reset on order details page because on order details
                    * page the payment summary column is being given a negative top
                    * position, on resize from mobile to tablet
                    */
                    if (!($('#order-details').length)) {
                        if (self.isBlocked()) {
                            self.reset();
                        }
                    }
                    self.animate();
                    setTimeout(function () {
                        self.handleResize(true);
                    }, 100);
                }
            });

            $(window).scroll(function () {
                self.handleResize();
            });

            if (!breakpoint.mobile) {
                $(window).load(function () {
                    self.handleResize();
                });
            }
        },

        handleResize: function (isViewportChange) {
            var self = stickySidebar,
                $confirmChangesButton = $('#confirm-changes'),
                confirmChangesButtonFactor = $confirmChangesButton.length ? $confirmChangesButton.outerHeight() + parseInt($confirmChangesButton.css('margin-top'), 10) : 0,
                $masthead = $('#masthead-wrapper'),
                $mastheadTop = $masthead.length ? $masthead.offset().top : 0,
                mastheadFactor = $masthead.length ? $masthead.outerHeight() + 20 : 0;

            if (self.isBlocked()) {
                return;
            }

            var scrollY = $(document).scrollTop();
            // default css rules to ensure when resizing viewports the
            // secondary column styles reset styles not needed
            var css = {
                position: 'absolute',
                bottom: 'auto',
                right: 0,
                top: 0
            };

            // stop any running animations
            self.stop();

            // allow scrolling if:
            // - the secondary column is larger than the primary column
            // - the scroll y position exceeds the top of the primary
            // column
            if ((self.$secondary.outerHeight() < self.$wrapper.outerHeight() && scrollY > self.$primary.offset().top) && !isViewportChange) {

                // if the secondary column is at the base of the
                // primary
                // then position the bottom of the secondary to
                // match the base of the primary
                if (self.$wrapper.getBottom() - scrollY < self.$secondary.outerHeight() + confirmChangesButtonFactor) {
                    css.position = 'absolute';
                    css.top = 'auto';
                    css.right = 0;
                    css.bottom = 0;
                } else {
                    // secondary column is not at the base of the
                    // primary
                    // then fix the position to the top of the screen
                    css.position = 'fixed';
                    css.right = self.$wrapper.offset().left;
                    css.top = 0 + mastheadFactor;
                }
            }

            if (self.$secondary.outerHeight() > self.$wrapper.outerHeight()) {
                self.$wrapper.height(self.$secondary.outerHeight());
            }

            self.$secondary.css(css);

        },

        init: function (data) {
            var self = stickySidebar;

            if (!data.$wrapper.length || !data.$primary.length || !data.$secondary.length) {
                return;
            }

            self.$wrapper = data.$wrapper;
            self.$primary = data.$primary;
            self.$secondary = data.$secondary;

            self.sticky();
        }
    };

    return stickySidebar;

});
/*globals define,require,window */
/*jslint plusplus: true, regexp: true, unparam: true */
define('modules/product-description/eventMessagingCountDown', ['domlib', 'modules/event-messaging/common'], function ($, countDownClock) {
    'use strict';

    var EventMessaging,
        EventMessagingManager,
        EventMessage,
        CountDown,
        EventMessagingManagerException;

    EventMessagingManagerException = function EventMessagingManagerException(sMsg) {
        this.name = 'EventMessagingManagerException';
        this.message = sMsg || 'Error';
    };

    EventMessagingManagerException.prototype = Object.create(Error.prototype);
    EventMessagingManagerException.prototype.constructor = EventMessagingManagerException;

    // Instance per seller
    EventMessagingManager = function EventMessagingManager(oParams) {
        if (!oParams) {
            throw new EventMessagingManagerException('No JSON in constructor');
        }
        this.sellerID = oParams.sellerID || null;
        this.listingId = oParams.listingId || null;
        this.tCurrentTime = oParams.currentTime || window.currentTimeAsync;
        this.aEvents = [];
        this.createEvents(oParams.events);
        this.sEventMessageSelector = oParams.selector || null;
        this.$eventMessage = null;
        this.sParsedMessage = "";
        this.oPoller = null;
        this.currentEligibleEvent = null;
        this.iPollingInterval = oParams.pollingInterval || 20000;
        this.oCountDown = this.createCountDown(oParams.countdown) || null;
        this.initCountdown = oParams.initCountdown;
        this.bindEvents();
    };

    EventMessagingManager.prototype.bindEvents = function () {
        $(window).on(
            'getEligibleCountdown.' + this.listingId,
            this.onGetEligibleCountdown.bind(this)
        );
    };

    EventMessagingManager.prototype.onGetEligibleCountdown = function (event) {
        if (event.oData.callback) {
            if (this.aEvents.length === 0 || !this.getEligibleEvent(window.currentTimeAsync)) {
                event.oData.callback({
                    countdown: this.oCountDown,
                    clock: countDownClock
                });
            }
        }
    };

    EventMessagingManager.prototype.addEvent = function addEvent(oEvent) {
        if (oEvent instanceof EventMessaging) {
            this.aEvents.push(oEvent);
        }
    };

    EventMessagingManager.prototype.isCountDownValid = function isCountDownValid(tCurrentTime) {
        var oEvent = this.getEligibleEvent(tCurrentTime);
        if (!oEvent) {
            return this.oCountDown && this.oCountDown.isEligible(tCurrentTime);
        }
        return false;
    };

    EventMessagingManager.prototype.show = function show(selector) {
        var oEvent,
            bEventEligible = false;

        if (selector) {
            this.sEventMessageSelector = selector;
        }

        if (this.sEventMessageSelector) {
            this.$eventMessage = $(this.sEventMessageSelector);
            if (this.$eventMessage.length) {
                if (this.aEvents.length > 0) {
                    oEvent = this.getEligibleEvent(this.tCurrentTime);
                    if (oEvent instanceof EventMessaging) {
                        if (oEvent !== this.currentEligibleEvent) {
                            this.currentEligibleEvent = oEvent;
                            bEventEligible = true;
                            this.$eventMessage.html(oEvent.getEligibleMessage(this.tCurrentTime));
                        }
                    }
                }
            }

            if (!bEventEligible) {
                if (this.oCountDown && this.initCountdown !== false) {
                    this.oCountDown.show();
                    countDownClock.init();
                }
            }
        }

        /* if (!this.oPoller) {
            this.poll();
        } */

    };

    EventMessagingManager.prototype.get = function get() {
        var oEvent,
            bEventEligible = false,
            oRenderedEventMessage = {};

        if (this.aEvents.length > 0) {
            oEvent = this.getEligibleEvent(this.tCurrentTime);
            if (oEvent instanceof EventMessaging) {
                if (oEvent !== this.currentEligibleEvent) {
                    this.currentEligibleEvent = oEvent;
                    bEventEligible = true;
                    oRenderedEventMessage.eventMessage =
                        oEvent.getEligibleMessage(this.tCurrentTime);
                }
            }
        }

        if (!bEventEligible) {
            if (this.oCountDown) {
                oRenderedEventMessage.countdownMessage =
                    this.oCountDown.get();
            }
        }

        return oRenderedEventMessage;
    };

    EventMessagingManager.prototype.createEvents = function createEvents(aRawEvents) {
        var i = 0;
        if (aRawEvents.length > 0) {
            for (i = 0; i < aRawEvents.length; i++) {
                this.aEvents.push(new EventMessaging(aRawEvents[i]));
            }
            this.aEvents.sort(function (a, b) {
                return a.priority < b.priority;
            });
        }
    };

    EventMessagingManager.prototype.getEligibleEvent = function getEligibleEvent(tCurrentTime) {
        var i = 0,
            oEvent;

        for (i = 0; i < this.aEvents.length; i++) {
            oEvent = this.aEvents[i];
            if (oEvent.isEligible(tCurrentTime)) {
                return oEvent;
            }
        }
        return null;
    };

    EventMessagingManager.prototype.createCountDown = function createCountDown(oRawCountDown) {
        if (oRawCountDown) {
            return new CountDown(oRawCountDown);
        }
    };

    EventMessagingManager.prototype.poll = function poll() {
        var self = this;
        this.oPoller = window.setInterval(function () {
            self.show();
        }, this.iPollingInterval);
    };

    EventMessagingManager.prototype.stopPoll = function stopPoll() {
        window.clearInterval(this.oPoller);
        this.oPoller = null;
    };

    EventMessagingManager.prototype.getEvents = function getEvents() {
        return this.aEvents;
    };

/************************************************************************************************************************/

    EventMessage = function EventMessage(oParams) {
        this.tStartTime = parseFloat(oParams.startTime) || null;
        this.tEndTime = parseFloat(oParams.endTime) || null;
        this.sMessage = oParams.message || "";
    };

    EventMessage.prototype.isEligible = function isEligible(tCurrentTime) {
        return tCurrentTime >= this.tStartTime && tCurrentTime <= this.tEndTime;
    };

/************************************************************************************************************************/

    EventMessaging = function EventMessaging(oParams) {
        this.iPriority = oParams.priority || 0;
        this.tStartTime = parseFloat(oParams.startTime) || null;
        this.tEndTime = parseFloat(oParams.endTime) || null;
        this.sEventMessageSelector = oParams.selector || null;
        this.$eventMessage = null;
        this.sParsedMessage = "";
        this.aMessages = [];
        this.createMessages(oParams.messages);
    };

    EventMessaging.prototype.isEligible = function isEligible(tCurrentTime) {
        return tCurrentTime >= this.tStartTime && tCurrentTime <= this.tEndTime;
    };

    EventMessaging.prototype.getEligibleMessage = function getEligibleMessage(tCurrentTime) {
        var i = 0,
            oMessage;
        for (i = 0; i < this.aMessages.length; i++) {
            oMessage = this.aMessages[i];
            if (oMessage.isEligible(tCurrentTime)) {
                return oMessage.sMessage;
            }
        }
        return "";
    };

    EventMessaging.prototype.createMessages = function createMessages(aRawMessages) {
        var i = 0;
        if (aRawMessages.length > 0) {
            for (i = 0; i < aRawMessages.length; i++) {
                this.aMessages.push(new EventMessage(aRawMessages[i]));
            }
        }
    };

    EventMessaging.prototype.getMessages = function getMessages() {
        return this.aMessages;
    };

/********************************************************************************************************************************/
    CountDown = function CountDown(oParams) {
        this.tStartTime = parseFloat(oParams.startTime) || null;
        this.tEndTime = parseFloat(oParams.endTime) || null;
        this.tCurrentTime = oParams.currentTime || null;
        this.sEligibleMsg = oParams.message || "";
        this.sCountdownSelector = oParams.selector || null;
        this.$countdownMessage = null;
    };

    CountDown.prototype.isEligible = function isEligible(tCurrentTime) {
        return tCurrentTime >= this.tStartTime && tCurrentTime <= this.tEndTime;
    };

    CountDown.prototype.show = function show(params) {
        var paramsCopy = params || {},
            sRenderedText = '';

        if (paramsCopy.element) {
            this.sCountdownSelector = paramsCopy.element;
        }

        if (this.sCountdownSelector) {
            this.$countdownMessage = $(this.sCountdownSelector);
        }

        if (!this.$countdownMessage.length) {
            return false;
        }

        if (!this.isEligible(this.tCurrentTime)) {
            return false;
        }

        sRenderedText = this.sEligibleMsg.replace('%countdown%', '<time data-endtime="' + Math.round((this.tEndTime) / 1000) + '" data-currenttime="' + Math.round((this.tCurrentTime) / 1000) + '" class="countdown"></time>');
        this.$countdownMessage.html(sRenderedText);

        return true;
    };

    CountDown.prototype.get = function get() {
        var sRenderedText = '';
        if (this.isEligible(this.tCurrentTime)) {
            sRenderedText = this.sEligibleMsg.replace(
                '%countdown%',
                '<time data-endtime="' + Math.round((this.tEndTime) / 1000) +
                    '" data-currenttime="' + Math.round(
                        (this.tCurrentTime) / 1000
                    ) + '" class="countdown"></time>'
            );
        }
        return sRenderedText;
    };

    return {
        EventMessaging: EventMessaging,
        EventMessagingManager: EventMessagingManager,
        EventMessage: EventMessage,
        CountDown: CountDown,
        EventMessagingManagerException: EventMessagingManagerException
    };

});

/* global define,require,window,document */
/* jslint plusplus: true, regexp: true */
define('modules/buy-from/common',[
  'domlib',
  'modules/breakpoint',
  'modules/common',
  'modules/tesco.data',
  'modules/overlay/common',
  'modules/product-description/common',
  'modules/tesco.analytics',
  'modules/product-description/eventMessagingCountDown',
  'modules/tesco.utils'
], function ($, breakpoint, common, Data, overlay, pdp, analytics, eventMessagingCountDown, utils) {
  'use strict';

  var buyFrom = {

    clickEvent: 'click tap',
    module: '.buy-from',

    otherSellers: '.otherSellers',

    icon: "<span class='icon' data-icon='r' aria-hidden='true'/>",

    init: function ($module) {
      $module = $module || $('#virtualPage .buy-from');
      if ($module.length) {
        buyFrom.setup($module);
        buyFrom.initFramework();
        if (common.isPage('PDP')) {
          if ($('#ndoURLContainer').data('url')) {
            buyFrom.triggerNDOCall();
          } else {
            $('.buy-from').find('.loader').remove();
          }
        } else {
          buyFrom.triggerNDOCall();
        }
        buyFrom.buyBoxQty();
        common.customCheckBox.init($module);
        $('.newDeliveryOptions').not('.tescoBuyBox').find('.show-all').on('click', function (e) {
          e.preventDefault();
          buyFrom.showItems($(this));
        });
        if ($('#errorDiv').length) {
          var $qty = $('#errorDiv').closest('form').find('.quantity-display');
          buyFrom.throwQuantityValidationError($qty);
        }
        if (!window.isKiosk()) {
          $('.other-sellers .seller', $module).each(function () {
            $(this).find('.details .header').after($(this).find('> .seller-price-info'));
          });
        }
      }
    },

    asyncBlockCallbacks: function asyncBlockCallbacks() {
      var oCallbacks = {};

      oCallbacks.success = function (oResp) {
        if (typeof oResp === 'string') {
          oResp = $.parseJSON(oResp);
        }

        if (oResp.ServerTime !== undefined) {
          window.currentTimeAsync = oResp.ServerTime;
        }

        if (oResp[this.sBlockID] === '') {
          throw new Error('No response for: ' + this.sBlockID);
        }

        $(buyFrom.module).replaceWith(oResp[this.sBlockID]);
        buyFrom.init($(buyFrom.module));
      };
      return oCallbacks;
    },

    initFramework: function () {
      var myInlineRequests = [],
        myRequests = {
          newdeliveryOptions: ['deliveryOptionsContainer']
        },
        myModules = {
          deliveryOptionsContainer: ['.newDeliveryOptions', '', true, false, true]
        },
        myActions = {
          newdeliveryOptions: ['/stubs/delivery-options.php']
        },
        myDefaultActions = {
          newdeliveryOptions: ['/stubs/delivery-options.php']
        };
      Data.Global.init({
        inlineRequests: myInlineRequests,
        requests: myRequests,
        modules: myModules,
        actions: myActions,
        defaultActions: myDefaultActions
      });
    },
    triggerNDOCall: function () {
      var sRequest = 'newdeliveryOptions',
        sUrl = common.isPage('PDP') ? $('#ndoURLContainer').data('url') : $('#ndoURLContainer').data('url') + "&_=" + $.now(),
        DL = new Data.DataLayer(),
        $parentContainer = common.isPage('basket') ? $('#basket-primary') : $('.seller'),
        $descriptionLI,
        $module,
        $thisItem,
        $listShown,
        iNDOCount;

      if (sUrl !== undefined || sUrl !== null) {
        DL.get(sUrl, null, null, buyFrom.Handler, sRequest, null, null, function (xhr) {
          var oParsedJSON = JSON.parse(xhr.responseText),
            oEventMessagingManager,
            oWebAnalytics,
            eVar;

                    /* Start - Event Messaging */
          if (common.isPage('PDP')) {
            $.each(oParsedJSON, function (k, v) {
              if (v.countdown || v.events) {
                v.selector = '#' + k + ' .eventMessaging.asynContainer .content p';
                if (v.countdown) {
                  v.countdown.selector = v.selector;
                  v.countdown.currentTime = window.currentTimeAsync;
                }
                oEventMessagingManager = new eventMessagingCountDown.EventMessagingManager(v);
                oEventMessagingManager.show();
              }
              if (v.stockService) {
               v.stockSelector = '#' + k + ' .stockService';
               $(v.stockSelector).html(v.stockService);
               if ($('.stockAvailability').length > 0) {
                 buyFrom.bindStockEvent();
               }
             }

              if (v.analytics) {
                oWebAnalytics = new analytics.WebMetrics();
                oWebAnalytics.submit(v.analytics);
              }
            });
            if ($('#grocery-DO').length) {
              oWebAnalytics = new analytics.WebMetrics();
              eVar = [{
                eVar17: 'DBT available PDP'
              }];
              oWebAnalytics.submit(eVar);
            }
          }
                    /* End - Event Messaging */

          if (common.isPage('basket')) {
            $.each(oParsedJSON, function (k, v) {
              if (v.events) {
                v.selector = '.' + k + ' .eventMessaging.asynContainer .content p';
                if (v.countdown) {
                  delete v.countdown;
                }
                oEventMessagingManager = new eventMessagingCountDown.EventMessagingManager(v);
                oEventMessagingManager.show();
              }
            });
          }

          $parentContainer.find('.newDeliveryOptions ul').each(function () {
            $thisItem = $(this).parents('.newDeliveryOptions');
            iNDOCount = $thisItem.data('count') - 1;
            if (iNDOCount === undefined || isNaN(iNDOCount)) {
              iNDOCount = -1;
            }
            $listShown = 'li:gt(' + iNDOCount + ')';
            if (iNDOCount === -1) {
              $(this).children('li').show();
            } else {
              $(this).children($listShown).hide();
            }
          });
          $module = $(buyFrom.module);
          $('.newDeliveryOptions.tescoBuyBox').find('.show-all').on('click', function (e) {
            e.preventDefault();
            buyFrom.showItems($(this));
          });
          $module.find('a.active').on('click', function (e) {
            e.preventDefault();
            $module.find('.show-all').trigger(e.type);
          });
          $descriptionLI = $module.find('ul').children('li.description');
          if ($descriptionLI.length) {
            $module.find('ul').children('li.description').hide();
          }
          $('.newDeliveryOptions').removeClass('preNDOCall');
          if ($('div.product-description').length) {
            $('.offerTitle').css('min-height', '');
            buyFrom.populateBuyBoxesFromDom();
          }
          $('.loader', $(buyFrom.module)).hide();
          $(buyFrom.module).addClass('buyFromLoaded');
        }, 'GET');
      }
    },
    bindStockEvent: function () {
      $('#checkStock').on(buyFrom.clickEvent, function (e) {
        e.preventDefault();
        e.stopPropagation();
        buyFrom.toggleCheckStock(e);
      });
      $('#stockSubmit').off().on(buyFrom.clickEvent, function (e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).prop('disabled', true);
        buyFrom.storeFieldValidation($('#store-check-postcode'), e);
      });
    },
    toggleCheckStock: function (e) {
      var $target = e ? $(e.target) : $('.stockAvailability #checkStock'),
        postCodeFld = $('.stockAvailability').find('#pcFieldWrapper');

      if (!postCodeFld.is(':visible')) {
        buyFrom.showPostCodeFld(e);
      } else {
        buyFrom.hidePostCodeFld(e);
      }
      return false;
    },
    showPostCodeFld: function (e) {
      var $target = e ? $(e.target) : $('.stockAvailability #checkStock'),
        postCodeFld = $('.stockAvailability').find('#pcFieldWrapper');

      postCodeFld = e.type ? postCodeFld : $('.stockAvailability').find('#store-check-postcode');

      if (common.isTouch()) {
        postCodeFld.show();
      } else {
        postCodeFld.slideDown();
      }

      $target.addClass('open');

      return false;
    },
    hidePostCodeFld: function (e) {
      var $target = e ? $(e.target) : $('.stockAvailability #checkStock'),
        postCodeFld = $('.stockAvailability').find('#pcFieldWrapper');

            // postcodeValidator.resetForm();

      if (common.isTouch()) {
        postCodeFld.hide();
      } else {
        postCodeFld.slideUp();
      }

      $target.removeClass('open');
      $('.stockService').css({ height: 'auto', overflow: 'hidden' });
      return false;
    },
    storeFieldValidation: function ($txtObj, e) {
      if ($txtObj.val().length > 0) {
        if ($txtObj.prev().attr('class') != 'undefined' && $txtObj.prev().attr('class') == 'error') {
          $txtObj.removeClass('error');
          $txtObj.prev().remove();
          $('#stockCheckForm label').show();
        }
                // $('#stockSubmit').prop('disabled', false);
        var sHeight = $('#nearestStore').is(':visible') ? '191px' : '113px';
        $('.stockService').append('<div class="storeLoader">Checking local stock</div>').css({ height: sHeight, overflow: 'hidden' });
        buyFrom.getStockStoreDetails(e, $(e.target));
      } else {
        if (!$txtObj.hasClass('error')) {
          $txtObj.before('<span class="error">Postcode or town invalid</span>').addClass('error');
          $('#stockCheckForm label').hide();
        }
        $('#stockSubmit').prop('disabled', false);
      }
    },
    getStockStoreDetails: function (e, $elem) {
      e.preventDefault();
      var myInlineRequests = [],
        _myInlineRequests = [];
      var _myRequests = {
        storeCall: ['stockForm', 'storesArray', 'stockMapDetails', 'stockStoreInfo', 'stockError']
      };
      var _myModules = {
        stockForm: ['#stockForm', '', false],
        storesArray: ['#storesArray', '', true],
        stockMapDetails: ['#stockMapDetails', '', true],
        stockStoreInfo: ['.stockStoreInfo', '', true],
        stockError: ['.invalid2', '', true]
      };

      var _myActions = {
        storeCall: ['/stubs/delivery-options.php']
      };
      var _myDefaultActions = {
        storeCall: ['/stubs/delivery-options.php']
      };

      Data.Global.init({
        inlineRequests: _myInlineRequests,
        requests: _myRequests,
        modules: _myModules,
        actions: _myActions,
        defaultActions: _myDefaultActions
      });

      var _request = 'storeCall';
      var DL = new Data.DataLayer();
      var $form = utils.getFormByElement($elem);
      var myData = $form.serialize();
      var _url = Data.Utils.getAction(_request);

      DL.get(null, myData, $elem, null, _request, null, null, function (data) {
        var storeResponse = JSON.parse(data.responseText);
        var $postCodeFld = ($form.attr('id') === 'stockCheckForm') ? $('#store-check-postcode') : $('#store-check-postcode1');
        if (storeResponse.stockForm) {
          if ($postCodeFld.prev().attr('class') != 'undefined' && $postCodeFld.prev().attr('class') == 'error') {
            $postCodeFld.removeClass('error');
            $postCodeFld.prev().remove();
          }
          var overlayContent = storeResponse.stockForm + storeResponse.storesArray + storeResponse.stockMapDetails;
          var params = {
            content: overlayContent,
            customClass: 'storeDetailsOverlay',
            hideOnOverlayClick: true,
            hideOnEsc: true
          };

          if (breakpoint.hTablet || breakpoint.mobile || breakpoint.vTablet) {
            var backLink = "<a href='#' class='back'><span class='icon' data-icon='g' aria-hidden='true'></span> Back </a>";
            var opts = {
              content: backLink + overlayContent,
              closeSelector: '.back'
            };
            common.virtualPage.show(opts);
            $('#virtual-page').addClass('stockVirtualPage');
            $('.stockService').css({ height: 'auto', overflow: 'hidden' });
          } else {
            overlay.show(params);
          }
          $('#stockCheckForm label').show();
          $('#stockSubmit').prop('disabled', false);
          buyFrom.storeMap(e, storeResponse, $postCodeFld);
          $('.storeLoader').remove();
          $('.stockService').css({ height: 'auto', overflow: 'hidden' });
          return;
        }
        if (storeResponse.stockError) {
          if (!$postCodeFld.hasClass('error')) {
            var errorText = $($.parseHTML(storeResponse.stockError)).html();
            $postCodeFld.before('<span class="error">' + errorText + '</span>').addClass('error');
            $('#stockCheckForm label').hide();
            $('#stockSubmit').prop('disabled', false);
            $('.stockService').css({ height: 'auto', overflow: 'hidden' });
          }
          $('.storeLoader').remove();
          $('.stockService').css({ height: 'auto', overflow: 'hidden' });
          return;
        }
      });
    },
    storeMap: function (e, response, $postCodeFld) {
      var storesLatLong = $(response.storesArray).find('#coordinates'),
        latLongArray = [],
        activePinIndex = 0,
        liStoresArray = $(response.storesArray).find('li'),
        maxStoresPerPage = 5;
      var infobox;
      var visibleStoreArray;
      var defaultStoreTiming;
      var currentStoreIndex, prevStoreIndex = 0;

      if (liStoresArray.length > maxStoresPerPage) {
        $('#storesArray ul').find('li:gt(4)').hide();
        visibleStoreArray = $('#storesArray li:visible');
      }


      $('#overlayStockSubmit').off().on(buyFrom.clickEvent, function (e) {
        e.preventDefault();
        e.stopPropagation();
        buyFrom.storeFieldValidation($('#store-check-postcode1'), e);
        $('.moreStoreLink').addClass('moreStoreLinkDisabled');
        $('.moreStoreLink').off('click');
      });

      $(visibleStoreArray).each(function (i) {
        var storeTimings;
        $('.storeDetails:visible a.storeLink').on('click', $(this), function (e) {
          e.preventDefault();
          if (breakpoint.hTablet || breakpoint.mobile) {
            return false;
          } else {
            $('#storesArray ul li').removeClass('highlightStore');
            $(this).parent().addClass('highlightStore');
            buyFrom.storeMap.storeClick($(this), i);
          }
        });

        $(this).mouseover(function () {
          $(this).addClass('highlightStore');
        })
                    .mouseout(function () {
                      if ($(this).find('.selectedStore').length == 0) {
                        $(this).removeClass('highlightStore');
                      }
                    });
      });

      $('.closeMsg').each(function (i) {
        $('.closeMsg').on(buyFrom.clickEvent, $(this), function (e) {
          e.preventDefault();
          e.stopPropagation();
          $(this).parent().fadeOut();
          return;
        });
      });

      $('.storeInfo').each(function (i) {
        $(this).on(buyFrom.clickEvent, function (e) {
          e.preventDefault();
          e.stopPropagation();
          if (breakpoint.mobile) {
            if ($(this).parent().siblings('#collectiveData').length > 0) {
              $(this).removeClass('open');
              $(this).parent().siblings('#collectiveData').remove();
            } else {
              var $timingDiv = $('<div />');
              $timingDiv.html($(this).parent().nextAll('#timings').html());
              $timingDiv.attr('id', 'collectiveData');
              $(this).parent().siblings('.stockStatus').after($timingDiv);
              $(this).addClass('open');
            }
          } else if (breakpoint.hTablet || breakpoint.vTablet) {
            if (!$(this).parent().nextAll('#timings').is(':visible')) {
              $(e.target).parent().parent().css('height', 'auto');
              $(this).parent().nextAll('#timings').show();
              $(this).addClass('open');
            } else {
              $(e.target).parent().parent().css('height', '92px');
              $(this).parent().nextAll('#timings').hide();
              $(this).removeClass('open');
            }
          }
          $(this).parent().find('#storeValue').html($('#store-check-postcode').val());
          $('#nearestStore').html($(this).parent().html() + $(this).parent().next()[0].outerHTML);
          $('#nearestStore').show();
          $('#checkStock span').html('Check stock in other stores');
        });
      });

      $('.storeTIme').each(function (i) {
        var timeTxt = $(this).text().trim();
        if (/[0-9]/.test(timeTxt)) {
          if (timeTxt.length > 11) {
            $(this).text(timeTxt.substr(0, 11));
          }
        }
      });

      $('a.moreStoreLink').on(buyFrom.clickEvent, $(this), function (e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).fadeOut(1000, function () {
          $('.moreStoreLinkHolder').addClass('loadingBar').delay(1000).queue(function () {
            $(this).removeClass('loadingBar').dequeue();
            $('#storesArray').css({
              height: '351px'
            });
            $('#storesArray ul').find('li:gt(4)').fadeIn(1000);
                        // $('#storesArray ul').find('li:gt(4)').show('slow');
            $('#storesArray ul').css('margin-right', '10px');
            $('#storesArray').animate({
              scrollTop: $('#storesArray ul li:nth-child(5)').position().top
            }, 2000);
          });
        });
        visibleStoreArray = $('#storesArray ul li');
        $(visibleStoreArray).each(function (i) {
          buyFrom.storeMap.createPins(i);
          $('.storeDetails a.storeLink').on('click', $(this), function (e) {
            e.preventDefault();
            $('#storesArray ul li').removeClass('highlightStore');
            $(this).parent().addClass('highlightStore');
            buyFrom.storeMap.storeClick($(this), i);
          });
          $(this).mouseover(function () {
            $(this).addClass('highlightStore');
          })
                        .mouseout(function () {
                          if ($(this).find('.selectedStore').length == 0) {
                            $(this).removeClass('highlightStore');
                          }
                        });
        });
      });

      $('.disabledReserve').on(buyFrom.clickEvent, $(this), function (e) {
        e.preventDefault();
        e.stopPropagation();
      });

            // get location details for group (show 3 of group)
      storesLatLong.each(function (i, el) {
        var lat = parseFloat($('#lat', this).text(), 10),
          lon = parseFloat($('#lon', this).text(), 10);

        latLongArray.push({
          lat: lat,
          lon: lon
        });
      });

            // plot locations on map
      var locations = [],
        i;
      for (i = 0; i < latLongArray.length; i++) {
        locations.push(new Microsoft.Maps.Location(latLongArray[i].lat, latLongArray[i].lon));
      }
            // generate map
      var map = common.getMap($('#stockMapDetails'), $('#mapContainer'), locations);

      buyFrom.storeMap.storeClick = function ($this, i) {
        $('#storesArray ul li:nth-child(' + (i + 1) + ')').find('.storeIndex').removeClass('selectedStore');
        currentStoreIndex = $this.attr('id');
        activePinIndex = parseInt($this.attr('id'));
        buyFrom.storeMap.createPins(i);
        storeTimings = $this.parent().find('#timings').html();
        $('.stockStoreInfo').html(storeTimings);
        $this.parent().find('.storeIndex').addClass('selectedStore');
        prevStoreIndex = currentStoreIndex;
        $this.parent().find('#storeValue').html($postCodeFld.val());
        $('#nearestStore').html($this.html() + $this.next()[0].outerHTML);
        $('#nearestStore').show();
        $('#checkStock span').html('Check stock in other stores');
      };

            // create pins
      buyFrom.storeMap.createPins = function (index) {
                // set group locations
        var pushpinOptions = {
          icon: (activePinIndex === index) ? globalStaticAssetsPath + 'map-pin-selected.png' : globalStaticAssetsPath + 'map-pin.png',
          width: 27,
          height: 42,
          typeName: (activePinIndex === index) ? 'map-pin-selected' : 'map-pin',
          textOffset: new Microsoft.Maps.Point(0, 6),
          text: (index + 1).toString()
        };

                // create pin
        var pin = new Microsoft.Maps.Pushpin(locations[index], pushpinOptions);

                // add pushpin to map
        map.entities.push(pin);

        buyFrom.storeMap.createInfoBox(activePinIndex);
        buyFrom.storeMap.showStoreDetOnMap(map);

                // attach click events to pushpin
        var pinClick = Microsoft.Maps.Events.addHandler(pin, 'click', function (vi) {
                   // vi.originalEvent.preventDefault();
          activePinIndex = parseInt(pin._text) - 1;
          buyFrom.storeMap.showDetailOnPin(pin, vi.originalEvent);
        });
      };

      buyFrom.storeMap.createInfoBox = function (activeIndex, ev) {
                // remove already existing info box
        for (var i = 0; i < map.entities.getLength(); i++) {
                    // not a push pin
          var entity = map.entities.get(i);
          if (entity._typeName === 'Infobox') {
                        // hide if visible
            if (entity._options.visible) {
              entity.setOptions({
                visible: false
              });
            }
          }
          if (ev != undefined) {
            if (entity._typeName === 'map-pin-selected') {
                            // de-highlight
              entity.setOptions({
                icon: globalStaticAssetsPath + 'map-pin.png',
                typeName: 'map-pin'
              });
            }
          }
        }

                // create infobox
        var infoboxContent = $(liStoresArray).find('a.storeLink').eq(activeIndex).find('.storeName').html().toLowerCase() + '<br/>' +
                    '(' + $(liStoresArray).find('a.storeLink').eq(activeIndex).find('.storeDistance').html() + ')';

        var infoboxOptions = {
          visible: true,
          offset: new Microsoft.Maps.Point(-7, 28),
          showCloseButton: true,
          height: 50,
          width: 190,
          description: infoboxContent
        };


        infobox = new Microsoft.Maps.Infobox(locations[activeIndex], infoboxOptions);

        var infoClick = Microsoft.Maps.Events.addHandler(infobox, 'click', function (vi) {
          vi.originalEvent.preventDefault();
          var isClose = $(vi.originalEvent.target).is('.infoClose');
          if (isClose) {
            infobox.setOptions({
              visible: false
            });
          }
        });
        map.entities.push(infobox);

        if (ev != undefined) {
          var pushpinOptions = {
            icon: globalStaticAssetsPath + 'map-pin-selected.png',
            width: 27,
            height: 42,
            typeName: 'map-pin-selected',
            textOffset: new Microsoft.Maps.Point(0, 6),
            text: (activeIndex + 1).toString()
          };

                    // create pin
          var clickedPin = new Microsoft.Maps.Pushpin(locations[activeIndex], pushpinOptions);

                    // add pushpin to map
          map.entities.push(clickedPin);
                    // attach click events to pushpin
          var pinClick = Microsoft.Maps.Events.addHandler(clickedPin, 'click', function (vi) {
            buyFrom.storeMap.showDetailOnPin(clickedPin, vi.originalEvent);
          });
        }
      };

      buyFrom.storeMap.showStoreDetOnMap = function (map) {
        for (var i = 0; i < map.entities.getLength(); i++) {
                    // not a push pin
          var entity = map.entities.get(i);
          if (entity._typeName === 'Infobox') {
                        // hide if visible
            if (entity._options.visible) {
              entity.setOptions({
                visible: false
              });
            }
          }
        }

        infobox.setOptions({
          visible: true
        });
        map.setView({
          center: infobox.getLocation(),
          centerOffset: new Microsoft.Maps.Point(0, 130)
        });
      };
      buyFrom.storeMap.showDetailOnPin = function (pin, ev) {
        var clickedIndex = parseInt(pin._text) - 1;
        var storeTimingCont;
        buyFrom.storeMap.createInfoBox(clickedIndex, ev);
        storeTimingCont = $('#storesArray ul li').eq(clickedIndex).find('#timings').html();
        $('.stockStoreInfo').html(storeTimingCont);
        $('#storesArray ul li').eq(prevStoreIndex).find('.storeIndex').removeClass('selectedStore');
        currentStoreIndex = clickedIndex;
        $('#storesArray ul li').eq(clickedIndex).find('.storeIndex').addClass('selectedStore');
        $('#storesArray ul li').eq(prevStoreIndex).removeClass('highlightStore');
        $('#storesArray ul li').eq(clickedIndex).addClass('highlightStore');
        if (parseInt(pin._text) > 5) {
          $('#storesArray').scrollTop($('#storesArray')[0].scrollHeight);
        } else {
          $('#storesArray').scrollTop(0);
        }
        prevStoreIndex = currentStoreIndex;
        map.setView({
          center: infobox.getLocation(),
          centerOffset: new Microsoft.Maps.Point(0, 130)
        });
        var storeDet = $('#storesArray ul li').eq(clickedIndex).find('a.storeLink');
        $('#storeValue').html($postCodeFld.val());
        $('#nearestStore').html(storeDet.html() + storeDet.next()[0].outerHTML);
        $('#nearestStore').show();
        $('#checkStock span').html('Check stock in other stores');
      };

            // loop through group locations and create pins with info boxes!
      for (i = 0; i < visibleStoreArray.length; i++) {
        buyFrom.storeMap.createPins(i);
      }

            // display default store i.e first store on overlay open
      defaultStoreTiming = $('#storesArray ul li:nth-child(1)').find('#timings').html();
      $('.stockStoreInfo').html(defaultStoreTiming);
      $('#storesArray ul li:nth-child(1)').find('.storeIndex').addClass('selectedStore');

      return false;
    },
    populateBuyBoxesFromDom: function () {
      var self = null,
        seller = $(buyFrom.module).find('.other-sellers .seller'),
        firstDeliveryElemText = '',
        collapsedDOelem = null,
        collapsedDOULelem = null,
        price = '',
        image = null;

      function replaceDeliveryDurations(s) {
        return s.replace('(next day *)', '').replace('(2-5 days*)', '');
      }

      if (seller.length) {
        seller.each(function () {
          self = $(this);
                    // Delivery...
          firstDeliveryElemText = replaceDeliveryDurations(self.find('.delivery ul > li > a:first').text());
          collapsedDOelem = self.find('.collapsed-DO');
          collapsedDOULelem = collapsedDOelem.find('ul');
          collapsedDOULelem.html('<li>' + firstDeliveryElemText + '</li>');
                    // Price...
          price = collapsedDOULelem.data('price');
          self.find('.current-price').html(price);
                    // Image...
          image = collapsedDOelem.find('img').removeClass('displayNone');
          self.find('.header-wrapper .available-from').after(image);
          self.find('div.price-info').show();
                    // Hide loader...
          collapsedDOelem.find('.loader').hide();
        });
      }
    },
    moduleExists: function () {
      return $(this.module).length > 0;
    },

    Handler: {
      handler: function (oJSON) {
        var oWebAnalytics,
          sModuleSelector,
          sMarkup,
          $optionalContainer;

        $.each(oJSON, function (k, v) {
          if (k === 'analytics') {
            oWebAnalytics = new analytics.WebMetrics();
            oWebAnalytics.submit(v);
          } else if (k === 'redirection') {
            window.location.href = v;
          } else {
            if (common.isPage('basket')) {
              sModuleSelector = '.' + k;
            } else {
              sModuleSelector = '#' + k;
            }
            sMarkup = buyFrom.Handler.cleanMarkup(v.deliveryOptionsHTML);
            try {
              if (sMarkup !== '') {
                $optionalContainer = $(sModuleSelector).find('.newDeliveryOptions');
                if (!$optionalContainer.length) {
                  $optionalContainer = $(sModuleSelector);
                }
                if (common.isPage('basket')) {
                  $optionalContainer.html(sMarkup);
                } else {
                  $optionalContainer.get(0).innerHTML = sMarkup;
                }
              }
            } catch (ignore) {}
          }
        });
      },
      cleanMarkup: function (sHTML) {
        var markup = (sHTML !== null) ? sHTML.replace(/<(script|style|title)[^<]+<\/(script|style|title)>/gm, '').replace(/<(link|meta)[^>]+>/g, '') : '';

        return markup;
      }
    },

    setup: function ($module) {
      this.toggleAlternativeSellerLinks($module);
      if ($module.find('.options ul').length > 0 && this.isDesktop()) {
        this.initAccordians($module.find('.options ul'));
      } else if ($module.find('.options ul').length > 0 && !this.isDesktop()) {
        this.initAccordians($module.find('.offers ul'));
      }
            // this.setButtonStates($module.find(".quantity input"));
      this.bindEvents($module);
    },

    isDesktop: function () {
      return breakpoint.desktop || breakpoint.largeDesktop || breakpoint.vTablet || breakpoint.hTablet;
    },

    doAlternativeSellerLinksExist: function ($module) {
      return $module.find('a.details').length > 0;
    },

    toggleAlternativeSellerLinks: function ($module) {
      var module = $module || $('.buy-from'),
        linksExist = buyFrom.doAlternativeSellerLinksExist(module),
        breakPointRequiresLinks = (!linksExist && breakpoint.mobile) || (!linksExist && breakpoint.vTablet) || (!linksExist && breakpoint.hTablet),
        breakPointRequiresDivs = (linksExist && breakpoint.desktop) || (linksExist && breakpoint.largeDesktop);
      if (breakPointRequiresLinks) {
        buyFrom.amendAlternativeSellerDetails(module, true);
      } else if (breakPointRequiresDivs) {
        buyFrom.amendAlternativeSellerDetails(module, false);
      }
    },
    toggleStockOverlay: function () {
      if ($('.stockAvailability').length) {
        common.virtualPage.page.length = 0;
        $('.stockService').css({ height: 'auto', overflow: 'hidden' });
        overlay.hide();
      }
    },
        // Can take optional params: $module, requiresLink
    amendAlternativeSellerDetails: function () {
      return;
    },

    initAccordians: function (list) {
      list.each(function () {
        var listShown, specialOfferLinks, showMore,
          thisItem = $(this).parents('.newDeliveryOptions'),
          count = thisItem.data('count') - 1;

        if (count === undefined || isNaN(count)) {
          count = -1;
        }

        listShown = 'li:gt(' + count + ')';
        if (count === -1) {
          listShown = 'li.description';
        }

        if ($(this).parent().hasClass('offers')) {
          $(this).find('li:gt(0)').hide();
        } else {
          $(this).find(listShown).hide();
        }

                // if there is only 1 special offers list item then hide the show more link

        $('.buy-from .offers ul').each(function () {
          specialOfferLinks = $(this).find('li');
          showMore = $(this).next('.show-more');

          if (specialOfferLinks.length <= 1) {
            showMore.hide();
          } else {
            showMore.show();
          }
        });
      });
    },

    addAccordianLink: function (list) {
      if (list.siblings('.show-more').length <= 0) {
        list.after("<a href='#' class='show-more'><span>" + list.parent('div').data('closed-text') + '</span></a>');
      }
    },

    showItems: function (link) {
      var list = link.siblings('ul'),
        container = list.parent(),
        thisItem = list.parents('.newDeliveryOptions'),
        count = thisItem.data('count') - 1;

      if (!link.hasClass('open')) {
        list.find('.active').hide();
        list.find('li, p, .non-active').show({
          duration: 200,
          complete: pdp.changeColumnLayout
        });
        if (container.hasClass('newDeliveryOptions')) {
          link.html('Show less delivery options').addClass('open');
        } else {
          link.text(link.data('clicktext')).addClass('open');
        }
      } else {
        list.find('.active').show();

        if (container.hasClass('newDeliveryOptions')) {
          list.find(' li:gt(' + count + '), p, .non-active, .description').hide({
            duration: 200,
            complete: pdp.changeColumnLayout
          });
          link.html('Show all delivery options').removeClass('open');
        } else {
          list.find('li:gt(0), p, .non-active, .description').hide({
            duration: 200,
            complete: pdp.changeColumnLayout
          });
          link.text(link.data('closedtext')).removeClass('open');
        }
      }
    },
    listToggleExpand: function (link) {
      var list = link.siblings('ul'),
        currentText = link.text();

      if (!link.hasClass('open')) {
        list.find('li').not('[data-init-active="true"]').show();
        link.css({
          'min-width': link.innerWidth()
        });
        link.html(link.data('clicktext')).addClass('open');
      } else {
        list.find('li').not('[data-init-active="true"]').hide();
        link.html(link.data('clicktext')).removeClass('open');
      }
      link.data('clicktext', currentText);
    },

    bindEvents: function ($module) {
      var byFromElem,
        quantityInput = $module.find('.quantity input'),
        quantity,
        decreaseButton = quantityInput.siblings('a').not('.increase');

      quantity = quantityInput.length ? quantityInput.val() : undefined;
            // if (window.isKiosk()) {
      if (quantity === 1) {
        decreaseButton.addClass('disabled');
      }
      $module.find('.quantity a').on('click', function (e) {
        var $self = $(this);
        buyFrom.incrementQuantity($self);
        e.preventDefault();
      });
      if (quantityInput) {
        quantityInput.on('change', function () {
          var $self = $(this);
          buyFrom.updateQuantity($self);
        });
      }
            // }
            /* Check to see if device is a Hudl first because IE10 doesn't recognise special characters, therefore doesn't valiate */
      if (common.isHudl()) {
                /* Fix for HUDL - to slice the characters to 2 if the user types more than 2 */
        quantityInput.on('keyup', function (e) {
          var $self = $(this),
            maxlength = $self.attr('maxlength'),
            lengthValue = $self.val().length,
            finalText;

          if (lengthValue >= maxlength || !$.isNumeric($self.val())) {
            finalText = $(this).val().slice(0, maxlength);
            $(this).val(finalText);
            e.stopImmediatePropagation();
            return false;
          }
        });
      }
            /* Fix for HUDL */


      $module.find('.show-more').on('click', function (e) {
        e.preventDefault();
        buyFrom.showItems($(this));
      });
      $module.find('.promoMoreAvailible').on('click', function (e) {
        e.preventDefault();
        buyFrom.listToggleExpand($(this));
      });
      $module.find('a.active').on('click', function (e) {
        e.preventDefault();
        $module.find('.show-more').trigger(e.type);
      });

      if ($('p.quantity-errMsg').length) {
        buyFrom.throwQuantityValidationError(quantityInput);
      }
            // insert alternative seller show more link
      $('.collapsed-DO').after('<span class="seller-toggle">More<span aria-hidden="true" class="icon">2</span></span>');

      byFromElem = $(buyFrom.module);

      byFromElem.off('click', '.options li a');
      byFromElem.on('click', '.options li a', function (e) {
        if (!$(e.target).parents('.popup').length && !$(e.target).is('.close .icon')) {
          buyFrom.deliveryOptionPopup(e);
        } else if ($(e.target).parents('.popup').length && !$(e.target).is('.close .icon')) {
          document.location.href = $(e.target).prop('href');
        }
      });

      byFromElem.on('click', '.popup, .popup a.close', buyFrom.deliveryOptionClose);
            // on click of other seller buy box toggle content accordingly
      byFromElem.on('click', '.other-sellers .seller .details .seller-toggle', buyFrom.alternativeSellerToggle);

      $(document).on('click', buyFrom.deliveryOptionClose);
    },

    incrementQuantity: function (link) {
      var isIncreasing = link.hasClass('increase'),
        quantityInput = link.siblings('input'),
        currentValue = quantityInput.val(),
        newValue = isIncreasing ? parseInt(currentValue, 10) + 1 : parseInt(currentValue, 10) - 1;
      buyFrom.updateQuantity(quantityInput, newValue);
    },


    triggerTooltip: function ($link) {
      var $next, html;

      if ($link.hasClass('add-to-wishlist')) {
        $next = $link.next('.user-wishlists');
      }
      if ($link.hasClass('stock-alerts')) {
        $next = $link.parents('.buy-box-stock-alerts').find('.tooltip-register-for-alerts');
      }

      html = $next.length ? $next.html().trim() : '';
      if (html !== '') {
        if (!breakpoint.mobile && !breakpoint.vTablet && !breakpoint.hTablet) {
          common.tooltip.show({
            trigger: $link,
            html: html,
            closeTriggers: '.secondary',
            callback: buyFrom.bindCustomTooltipEvents
          });
        } else {
          overlay.show({
            content: '<div class="generic">' + html + '</div>',
            callback: buyFrom.bindCustomTooltipEvents,
            fixedWidth: '280'
          });
        }
      }
    },

    bindCustomTooltipEvents: function (tooltip) {
      var addToWishlistTrigger = tooltip.find('.add-item-to-wishlist'),
        registerForStockAlertsButton = tooltip.find('.secondary-button'),
        doNotRegisterForStockAlertsButton = tooltip.find('.tertiary-button');

      registerForStockAlertsButton.on('click tap', function (e) {
        e.preventDefault();
        if (tooltip.attr('id') === 'lightbox') {
          overlay.hide();
        } else {
          common.tooltip.hide(tooltip);
        }
        buyFrom.registerStockAlerts($(this));
      });

      doNotRegisterForStockAlertsButton.on('click tap', function (e) {
        e.preventDefault();
        if (tooltip.attr('id') === 'lightbox') {
          overlay.hide();
        } else {
          common.tooltip.hide(tooltip);
        }
      });

      addToWishlistTrigger.on('click tap', function (e) {
        e.preventDefault();
        if (common.isLoggedIn()) {
          if (tooltip.attr('id') === 'lightbox') {
            overlay.hide();
          } else {
            common.tooltip.hide(tooltip);
          }
          buyFrom.addToWishlist(tooltip);
        }
      });
    },

    addToWishlist: function (button) {
      return button;
    },

    registerStockAlerts: function (button) {
      return button;
    },

    setButtonStates: function ($input) {
      var currentValue = parseInt($input.val(), 10),
        increaseButton = $input.siblings('.increase'),
        decreaseButton = $input.siblings('a').not('.increase');
      decreaseButton.attr('disabled', !buyFrom.isRangeValid($input, currentValue - 1));
      increaseButton.attr('disabled', !buyFrom.isRangeValid($input, currentValue + 1));
    },

        // prevent add to basket button submitting form if error in qty field
    buyBoxQty: function () {
      var buyBoxQty = $('.buy-from .buy form');
      buyBoxQty.each(function () {
        $(this).validate({
          submitHandler: function (form) {
            if (!$(form).find('.stock-alerts').length) {
              var $buyBoxInput = $(form).find('.quantity input'),
                buyBoxInputRange = buyFrom.isRangeValid($buyBoxInput);
              if (buyBoxInputRange) {
                form.submit();
              } else {
                buyFrom.throwQuantityValidationError($buyBoxInput);
                return false;
              }
            } else {
              form.submit();
            }
          }
        });
      });
    },
    checkQuantityRange: function checkQuantityRange($buyBoxQty) {
      var $buyBoxInput = $('.quantity input'),
        buyBoxInputRange = buyFrom.isRangeValid($buyBoxInput);

      if (buyBoxInputRange) {
        $buyBoxQty.submit();
      } else {
        buyFrom.throwQuantityValidationError($buyBoxInput);
        return false;
      }
    },

    updateQuantity: function (quantityInput, newValue) {
      var isQuantityValid = buyFrom.isRangeValid(quantityInput, newValue),
        decreaseButton = quantityInput.siblings('a').not('.increase'),
        increaseButton = quantityInput.siblings('.increase'),
        val;

      if (isQuantityValid) {
        quantityInput.parents('.quantity').removeClass('error');

        if (newValue) {
          quantityInput.val(newValue);
        }
        buyFrom.setButtonStates(quantityInput);
      } else {
        buyFrom.throwQuantityValidationError(quantityInput);
      }

      val = newValue || quantityInput.val();

      if (val <= 1) {
        decreaseButton.addClass('disabled');
      } else {
        decreaseButton.removeClass('disabled');
      }

      if (val >= 99) {
        increaseButton.addClass('disabled');
      } else {
        increaseButton.removeClass('disabled');
      }
    },

    isRangeValid: function (buyFromTxt) {
      var maxLimit = buyFromTxt.attr('max'),
        inputVal = buyFromTxt.val();

      if (parseInt(inputVal) > parseInt(maxLimit)) {
        return false;
      }
      else {
        return true;
      }
    },

    throwQuantityValidationError: function (quantityInput) {
      var html,
        maxQtyErrorMsg;

      html = "<span class='error'><span class='icon' data-icon='8' aria-hidden='true'></span>" + quantityInput.data('error-text') + '</span>';
      if ($('p.quantity-errMsg').length) {
        maxQtyErrorMsg = $('p.quantity-errMsg').text();
        html = "<span class='error'><span class='icon' data-icon='8' aria-hidden='true'></span>" + maxQtyErrorMsg + '</span>';
      }
      buyFrom.errorTooltip(quantityInput, html);
    },
    errorTooltip: function (quantityInput, html) {
      if (!breakpoint.mobile && !breakpoint.vTablet && !breakpoint.hTablet) {
        var settings = {
          trigger: quantityInput,
          isError: true,
          html: html,
          isInline: false
        };
        common.tooltip.show(settings);
      } else {
        overlay.show({
          content: html,
          isError: true,
          defaultBreakPointBehavior: false,
          fixedWidth: '280'
        });
      }
    },
    deliveryOptionPopup: function (e) {
            // hide all other popups before launching the current one
      e.stopPropagation();
      if ($(e.currentTarget).parent('li').length && !window.isKiosk()) {
        var self = buyFrom,
          deliveryOptionTitle,
          oWebAnalytics,
          v;

        self.deliveryOptionClose(e);
        $(e.target).parents('li').find('div').show();

                // Set omniture on delivery option tooltip
        deliveryOptionTitle = $(e.target).parents('li').find('.del-text').text();
        oWebAnalytics = new analytics.WebMetrics();
        v = [{
          eVar59: deliveryOptionTitle,
          events: 'event32'
        }];
        oWebAnalytics.submit(v);
      }
    },
    deliveryOptionClose: function (e) {
      if (!window.isKiosk()) {
        if ($(e.target).parents('.newDeliveryOptions').length) {
          e.preventDefault();
        }
        $(buyFrom.module).find('.popup').hide();
      }
    },

    alternativeSellerToggle: function () {
      var self = $(this).parents('.other-sellers').find('> .seller');
      if (self.children('.content').is(':hidden')) {
        self.removeClass('collapsed');
        self.children('.content').show();
        buyFrom.heightCheckForSellerExpand();
        self.find('.oo-stock, .low-stock').removeClass('displayNone');
        self.children('.details').find('.seller-toggle').html('Less<span aria-hidden="true" class="icon">1</span>');
      } else {
        self.addClass('collapsed');
        self.children('.content').hide();
        buyFrom.heightCheckForSellerExpand();
        self.find('.oo-stock, .low-stock').addClass('displayNone');
        self.children('.details').find('.seller-toggle').html('More<span aria-hidden="true" class="icon">2</span>');
      }
    },

        // Increase the height of the page wrapper in accordance with the sidebar
    heightCheckForSellerExpand: function (noChange) {
      var $pageContainer = $('#page-container'),
        mainHeight = parseInt($('#main-content').height(), 10),
        sideHeight = parseInt($pageContainer.find('.secondary-content').height(), 10);

      if (sideHeight > mainHeight) {
        $pageContainer.css('min-height', sideHeight + 130);
      } else if (!noChange) {
        $pageContainer.css('min-height', mainHeight);
      }
    },
    orientationChageEvents: function () {
      if (window.addEventListener) {
        window.addEventListener('orientationchange', function () {
          if ($('.tooltipPopup:visible').length) {
            common.richTexttooltipPopup.checkTooltipPos($('.tooltipPopup:visible').prev('.fnToolTip'));
          }
        }, false);
      }
    }
  };
  breakpoint.mobileIn.push(function () {
    buyFrom.toggleAlternativeSellerLinks();
  });

  breakpoint.mobileOut.push(function () {
    buyFrom.toggleStockOverlay();
  });
  breakpoint.vTabletIn.push(function () {
    buyFrom.toggleAlternativeSellerLinks();
    buyFrom.toggleStockOverlay();
  });
  breakpoint.hTabletIn.push(function () {
    buyFrom.toggleAlternativeSellerLinks();
    buyFrom.toggleStockOverlay();
  });
  breakpoint.desktopIn.push(function () {
    buyFrom.toggleAlternativeSellerLinks();
  });
  breakpoint.largeDesktopIn.push(function () {
    buyFrom.toggleAlternativeSellerLinks();
  });
  breakpoint.kioskIn.push(function () {
    buyFrom.toggleAlternativeSellerLinks();
  });

  return buyFrom;
});

/*globals define, window*/
/*jslint regexp: true, plusplus: true */
define('modules/basket/common',['domlib', 'modules/breakpoint', 'modules/common', 'modules/sticky-sidebar/common', 'modules/overlay/common', 'modules/buy-from/common'], function($, breakpoint, common, stickySidebar, overlay, buyFrom) {
    'use strict';
	var basket = {
		// store the  list of basket items
		$basketItems: $('#basket-primary, #basket-attach').find('.basket-item'),

		// check if the add to basket button should be enabled/disabled
		updateProductOptions: function( $options ) {
			var $addButton = $('input:submit', $options);

			if ($options.find('label.selected').length < 1) {
				$addButton.attr('disabled', 'disabled');
			} else {
				$addButton.removeAttr('disabled');
			}
		},

		// monitors for a change in the product option checkbox states, if one of the checkboxes becomes checked
		// then the add to basket button becomes enabled
		productOptions: function () {
			var self  = basket;

			self.$basketItems.find('.available-product-options').each(function(){
				var $options = $(this);

				$options.find('label').on(self.event, function(e){
					e.preventDefault();
                    var $target = $(e.target),
                        $checkbox = $(this).find('input:checkbox');

                    if($target.hasClass('checkbox')) {

                        $(this).toggleClass('selected');

                        if ($(this).hasClass('selected')) {
                            $checkbox.attr('checked', 'checked');
                        } else {
                            $checkbox.removeAttr('checked');
                        }

                        self.updateProductOptions( $options );

                    }
				});

				self.updateProductOptions( $options );
			});
		},

		// check if the update button should be enabled/disabled
		// check if theincrease and decrease buttons should be enabled/disabled (mobile and tablet only)
		updateItemQuantity: function($input, event) {
            var $form = $input.parents('form'),
				$update   = $form.find('input.update'),
				$increase = $form.find('a.increase'),
				$decrease = $form.find('a.decrease'),
				nValue    = $.trim( $input.val() ),
				oValue    = parseInt( $input.data('original-quantity'), 10),
				max       = $input.data('max'),
				min       = $input.data('min');

			// restore the original value if the quantiy is zero or non numeric is entered
            if (event && !(event.keyCode === 8) && isNaN(nValue) && nValue !== 0) {
				$input.val(oValue);
				nValue = oValue;
			}
			nValue    = parseInt( $.trim( $input.val() ), 10);

			// if the new value is the same as the original value, then disable the update button
			if (nValue === oValue || isNaN(nValue)) {
				$update.attr('disabled', 'disabled');
			} else {
				$update.removeAttr('disabled');
			}

			if (!breakpoint.desktop && !breakpoint.largeDesktop) {
				$increase.removeClass('disabled');
				$decrease.removeClass('disabled');

				if (nValue === min) {
					$decrease.addClass('disabled');
				}

				if (nValue === max) {
					$increase.addClass('disabled');
				}
			}
		},

		// monitors for a change in the quantity value, if value changes from what was the original value
		// then the update button becomes enabled
		// increase and decrease buttons are only setup for mobile and tablet only
		itemQuantity: function() {
			var self = basket;

			self.$basketItems.find('.quantity').each(function(){
                var $input = $('input[type=number], input[type=text]', this).eq(0);

				if (!$input.length) {
					return;
				}

				// change input type number back to number for mobile/tablet
				// not a good idea - to review for alternative

				// was originally type=number in html - but input type number ignores the maxlength
				// and uses 'max' attribute.  max attribute behaves differently across all browsers
				// most notable difference is in chrome, where the max isn't applied until the submit
				// button is pressed and then chrome will display it's own validation messages
				// set the min and max using data attributes for consistency

				// if (!breakpoint.desktop && !breakpoint.largeDesktop && !breakpoint.kiosk) {
				//	$input.attr('type', 'number');
				// }

				// store the original quantity value
				$input.data('original-quantity', $.trim( $input.val() ));

				// check onblur if the value has changed and update button disabled states
				$input.on('keyup', function(e){
					self.updateItemQuantity($(this) , e);
				});

				// update button disabled states
				self.updateItemQuantity( $input );

				// setup increase/decrease quantity buttons
				$('a.increase, a.decrease', this).on(self.event, function(e){
					e.preventDefault();
					e.stopPropagation();

					if (breakpoint.desktop || breakpoint.largeDesktop) {
						return false;
					}

					var nValue = parseInt( $input.val(), 10 ),
						max    = $input.data('max'),
						min    = $input.data('min');

					// if the user enters a value that's not a number, restore the original value
					if (isNaN(nValue)) {
						nValue = $input.data('original-quantity');
					}

					// decrease quantity value (check max limit)
					if ($(this).hasClass('increase')) {
						nValue++;
						if (nValue >= max) {
							nValue = max;
						}
					}

					// decrease quantity value (check min limit)
					if ($(this).hasClass('decrease')) {
						nValue--;
						if (nValue <= min) {
							nValue = min;
						}
					}

					// update the new value and update the disabled state of the update button
					$input.val( nValue );

					// update button disabled states
					self.updateItemQuantity( $input );
					
					
					return false;
				});
			});
		},
        
		// for mobile and tablet only! if a page error exists, display it in an overlay/modal
		pageError: function(){			
			if ($('.page-error').length) {			
				var content = $( $('#tmplt-basket-page-error-overlay').html().trim() ),
					htmlString = "";
				
				$('.page-error').each(function(){
					htmlString = htmlString + $(this).html();
				});
	
				content = content.filter('#lightbox-content').html( htmlString );
				content = content.wrapAll('<div />').parent().html();
				
				overlay.show({
					content: content,
					customClass: 'error'
				});			
			}
		},

		// for mobile, make the item count clickable in the mini summary and scroll to the basket items
		jumpToItems: function() {
			var self  = basket;

			$('#basket-summary-mini h2 span.items').on(self.event, function(e){
				e.preventDefault();
				e.stopPropagation();

				if (breakpoint.mobile) {
					$(document).scrollTop( self.$basketItems.eq(0).offset().top );
				}
			});
		},

		// generic basket overlay trigger, looks for the overlay template id in the 'data-overlay-id'
		// attribute of the triggering element
		overlay: {

			position: function($overlay){
                var scrollY = $(document).scrollTop(),
					marginTop = parseInt($overlay.css('margin-top'), 10) + scrollY;

				if ($overlay.offset().top < scrollY) {
					$overlay.css('margin-top', marginTop);
				}
			},

			init: function($elms){
				var self  = basket;

				$elms.on(self.event, function(e){
					e.preventDefault();
					e.stopPropagation();

					var content = $('#' + $(this).data('overlay-id') ).html();

					if (breakpoint.desktop || breakpoint.largeDesktop) {

						common.tooltip.show({
							trigger: $(this),
							html: content
						});
						$('#emptyBasketConfirm a.no').on(self.event, function(e){
							e.preventDefault();
							e.stopPropagation();

							common.tooltip.hide();
						});

					} else {
						overlay.show({
							content: content,
							customClass: 'basket-overlay',
							callback: self.overlay.position
						});

						$('#lightbox .lightbox-actions a.no').on(self.event, function(e){
							e.preventDefault();
							e.stopPropagation();

							overlay.hide();
						});
					}
				});
			}
		},
		
		bindMobileEvents: function () {
			basket.unbindEvents();
		},
		
		bindEvents: function () {
			basket.unbindEvents();
		},
		
		unbindEvents: function () {
			$('.bcve-show-more').off('tap click');
		},
		init: function () {
			
			$(document).on('tap click','.one', function(){
	         var opts;
	         var data = $('.blink').html();
				if (breakpoint.mobile || breakpoint.vTablet) {
	                opts = {
	                    content : data,
	                    closeSelector : '.close'
	                };
	                common.virtualPage.show(opts);
	            }
	            else {
	                opts = {
	                    content : data,
	                    callback : '',
	                    defaultBreakPointBehavior : true,
	                    customClass : '',
	                    isError : false,
	                    fixedWidth : 713
	                };
	                overlay.show(opts);
	            }
			});
			
			var self = basket;
			
			self.$basketItems = $('#basket-primary, #basket-attach').find('.basket-item');
			
			if (common.isPage('basket') || common.isPage('basketAttach')) {
			
				buyFrom.init($('#ndoURLContainer'));
				$('#basket-checkout, #basket-checkout-mini').on('click', function(){
					$('.jsEnableCheck').val('true');
				});
				
				if (breakpoint.mobile || breakpoint.vTablet || breakpoint.hTablet) {
					self.pageError();
				}
				
				if (!self.$basketItems.length) {
					return;
				}
	
				self.event = 'click';
				//self.event+= breakpoint.kiosk ? '' : ' tap';
	
				self.itemQuantity();
				self.productOptions();
				
				$(document).on('tap click', '.bcve-show-more', function(e){
	
					e.preventDefault();
					e.stopPropagation();
	
					var content = $(this).parent().next('.bcve-tooltip').html();
					
					if (breakpoint.desktop || breakpoint.largeDesktop) {
	
						common.tooltip.show({
							trigger: $(this),
							html: content,
							close: true,
							closeTriggers: "a.close"
						});
	
					} else {
						overlay.show({
							content: content,
							callback: self.overlay.position
						});
					}
				});
	
				self.overlay.init( $('#basket-empty input[name="empty-basket"]') );
				self.overlay.init( self.$basketItems.find('.price-promise a') );
				self.overlay.init( self.$basketItems.find('.product-extras p.supplier a') );
	
				if (!breakpoint.kiosk) {
					// setup the sticky sidebar
					stickySidebar.init({
						$wrapper   : $('#basket-wrapper'),
						$primary   : $('#basket-primary'),
						$secondary : $('#basket-secondary')
					});
				}
				
				breakpoint.mobileIn.push(function () {
					self.bindMobileEvents();
				});
				
				breakpoint.vTabletIn.push(function () {
					self.bindMobileEvents();
				});
				
				breakpoint.hTabletIn.push(function () {
					self.bindMobileEvents();
				});
				
				if (!breakpoint.mobile && !breakpoint.vTablet && !breakpoint.hTablet) {
					return;
				}
				
				// mobile only
				if (breakpoint.mobile) {
					self.jumpToItems();
				}	
			}
		}
	};
	common.init.push(function(){
		basket.init();
        if (!window.isKiosk()) {
            common.richTexttooltipPopup.init();
        }
	});

	return basket;
});
/*global console:true */
define('modules/compare-page/common',['domlib', 'modules/common', 'modules/breakpoint'], function($, common, breakpoint){

	var compare = {

		table: '#compare-table',
		selected: 0,


		select: function(e){
			$(e.target).parent('a').toggleClass('selected');

			if($(e.target).parent('a').hasClass('selected')){
				compare.selected++;
			}else{
				compare.selected--;
			}

			if(compare.selected > 0){
				$('.filter').removeClass('disabled');
			}else{
				$('.filter').addClass('disabled');
			}

			return false;
		},


		filter: function(e){
			e.preventDefault();
			var label;

			if(!$(e.target).hasClass('disabled')){
				//apply filter
				compare.table.addClass('filtered');

				//hide non selected rows
				compare.table.find('.checkbox')
					.parent('a').not('.selected')
					.closest('tr').hide();

					//hide tables if they have no selected rows
				compare.table.find('.compare-group').each(function(){
				if(!$(this).has('.selected').length){
						$(this).hide();
					}
				});

				$('.buttons .show-all').show();

				$("html, body").animate({ scrollTop: 0 }, 400, 'swing');

				$(this).addClass('disabled');
			}

			return false;
		},

		showAll: function(e){
			//remove filter
			compare.table.removeClass('filtered');

			$('.buttons .show-all').hide();

			$('.buttons .filter').removeClass('disabled');
			
			compare.table.find('.compare-group').each(function(){
				$(this).show();
				$(this).find('tr').show();
			});
		},


		remove: function(e){
			var colIndex = $(e.target).closest('td').index();

			var productLink = $('.products-wrapper').attr('data-compare-ds-url');
			productLink += '?method=remove&product=' + encodeURI($(e.target).attr('data-compare'));
			$.get(productLink, function(data) {

				var remaining = 0;

				$('.products td').eq(colIndex).fadeOut(function(){
					$(this).html('').appendTo('.products tr').show();
					remaining = compare.checkProducts();
				});

				$('.compare-group tr').each(function(){
					var cell = $(this).find('td').eq(colIndex), self = this;
					cell.fadeOut(function(){
						cell.html('').appendTo(self).show().addClass('removed');
						if (remaining===4) {
							$("#compare-table").fadeOut();
						}
					});
				});



			});
			return false;
		},

		checkProducts: function(e){

			var max = 4,
				num = $('.products td .product').length,
				remaining = max - num;

			//show overlay, change label and set class
			$('.empty-column-overlay').addClass('remaining-' + remaining).find('.remaining').text(' '+ remaining);

			//plural?
			var plural = $('.empty-column-overlay').find('.plural');
			if(remaining > 1){
				if(remaining <= 3){
					plural.text('s');
				}else{
					$('.empty-column-overlay .content p b').text('4 products');
				}
			}else{
				plural.text('');
			}

			//update h2 label
			$('.products h2 .num-items').text(num);
			return remaining;
		},


		carousel: {

			columns: [],
			offset: 0,
			trail: [0],

			stickyTitle: function(){
				var self = compare.carousel,
					activeCol = $('.compare-group tbody tr').eq(self.activeCol()),
					group = activeCol.closest('.compare-group'),
					title = activeCol.closest('.compare-group').find('thead .group-title'),
					//offset = self.columns[self.activeCol()].offset - group.offset().left + $('.compare-groups-wrapper').offset().left;
					offset = title.position().left - self.offset - 8, //8 padding
					width = group.width() + offset - 16; //16 padding

				$('thead .group-title').css({'-webkit-transform': 'none', width: '100%'}).removeClass('truncate');

				title.css({'-webkit-transform': 'translate3D(' + -offset + 'px,0,0)', width: width}).addClass('truncate');
			},


			activeCol: function(){
				var self = compare.carousel,
					activeCol;

				for(var i=0;i<self.columns.length;i++){
					if(self.offset === self.columns[i].offset){
						activeCol = i;
						break;
					}
				}

				return activeCol;
			},


			previous: function(){
				var self = compare.carousel,
					nextCol;

				if(self.trail.length > 1){

					nextCol = self.trail[self.trail.length-2];

					$('.compare-groups').css({'-webkit-transform': 'translate3D(' + -self.columns[nextCol].offset + 'px,0,0)'});

					self.trail.pop();
					self.offset = self.columns[nextCol].offset;

					self.navCheck();
					self.stickyTitle();

				}

				return false;

			},


			next: function(){
				var self = compare.carousel,
					nextCol;

				if(self.offset + $(window).width() - $('.compare-groups-wrapper').offset().left < self.columns[self.columns.length-1].offset + self.columns[self.columns.length-1].width){

					for(var i=0;i<self.columns.length;i++){
						var col = self.columns[i];

						if(col.offset - self.offset > $(window).width() - $('.compare-groups-wrapper').offset().left){
							break;
						}

						nextCol = i;
					}

					self.offset = self.columns[nextCol].offset;
					self.trail.push(nextCol);

					$('.compare-groups').css({'-webkit-transform': 'translate3D(' + -self.columns[nextCol].offset + 'px,0,0)'});

					self.navCheck();
					self.stickyTitle();
				}
				return false;
			},



			navCheck: function(){
				var self = compare.carousel;

				if(self.trail.length > 1){
					$('.kiosk-carousel-nav .previous').parent('li').removeClass('disabled');
				}else{
					$('.kiosk-carousel-nav .previous').parent('li').addClass('disabled');
				}

				if(self.offset + $(window).width() - $('.compare-groups-wrapper').offset().left < self.columns[self.columns.length-1].offset + self.columns[self.columns.length-1].width){
					$('.kiosk-carousel-nav .next').parent('li').removeClass('disabled');
				}else{
					$('.kiosk-carousel-nav .next').parent('li').addClass('disabled');
				}

				return false;
			},



			init: function(){
				var self = this;

				$('.compare-group tbody tr').each(function(){
					var col = {
						width: $(this).width(),
						offset: $(this).offset().left - $('.compare-groups-wrapper').offset().left
					};
					self.columns.push(col);
				});

				//bind events
				$('.kiosk-carousel-nav .next').on('click', self.next);
				$('.kiosk-carousel-nav .previous').on('click', self.previous);
				common.kioskSwipe('left', $('.compare-groups-wrapper'), self.next);
				common.kioskSwipe('right', $('.compare-groups-wrapper'), self.previous);

			}

		},


		init: function(){

			if(breakpoint.desktop || breakpoint.largeDesktop || window.isKiosk()){
				compare.table = $(compare.table);
				if(compare.table.length){

					//bind events
					$('.checkbox', compare.table).parent('a').on('click', compare.select);
					$('.buttons .filter').on('click', compare.filter).addClass('disabled');
					$('.buttons .show-all').on('click', compare.showAll);
					$('.product .close', compare.table).on('click', compare.remove);

				}
			}

			if(window.isKiosk()){
				compare.carousel.init();
				$('.buttons .continue-shopping').addClass('secondary-button');
			}
		}

	};

	common.init.push(compare.init);

	return compare;

});

define('modules/visual-nav/common',['domlib', 'modules/navigation/common', 'modules/common', 'modules/overlay/common'], function ($, navigation, common, overlay) {
    'use strict';

    var visualNav = {

        clickEvent: window.isKiosk() ? 'touchstart click' : 'tap click',
        visualNavElement: $('#visual-nav'),

        init: function () {

            visualNav.visualNavElement = $('#visual-nav');

            if (visualNav.visualNavElement.length) {

                $('#visual-nav ul li a span').dotdotdot({
                    ellipsis: '',
                    wrap: 'word',
                    tolerance : 0
                });

                if (window.isKiosk()) {

                    $('#visual-nav .anchor .wrapper, .visual-nav .anchor .wrapper').on(visualNav.clickEvent, function () {
                        navigation.Scroll.to();
                        return false;
                    });

                    $('.shop-by .view-all').on(visualNav.clickEvent, function (e) {

                        e.preventDefault();

                        var content,
                            heading;

                        content = $(this).siblings('.products-wrapper').clone();
                        heading = '<h1>' + $(this).siblings('.products-header').children('h2').text() + '<h1>';

                        overlay.show({
                            overlayContent: content,
                            defaultBreakPointBehavior: false,
                            customClass: 'shop-by',
                            fixedWidth: 1338,
                            enablePagination: true,
                            paginationHeader: heading
                        });
                    });

                    // add grouped class if both shop by brand and price are present
                    var $elemCache = $('.shop-by-nav');
                    if ($elemCache.length > 1) {
                        $elemCache.each(function () {
                            $(this).addClass('shop-by-grouped');
                        });
                    }
                }
            }
        }
    };

    common.init.push(function () {
        common.init.push(visualNav.init);
    });

    return visualNav;

});
define('modules/seller-directory/common',['domlib', 'modules/breakpoint', 'modules/common'], function($, breakpoint, common){
	
	var sellerDir = {
		init: function () {
//			console.log('init');
		}
	};
	
	common.init.push(function () {
		if ($('.seller-directory').length){
			common.init.push(sellerDir.init);
		}
	});

	return sellerDir;
});
/*global define:true, Microsoft: true */
define('modules/buying-guides/common',['domlib', 'modules/common', 'modules/breakpoint'], function($, common, breakpoint){

	var buyingGuides = {

		topics: {
			$wrapper : [],
			$trigger : [],
			$menu    : [],
			selector : '#main-content .topic-list',

			// show the 'select topics' button
			enable: function() {
				var topics = buyingGuides.topics;

				if (breakpoint.mobile) {
					topics.$wrapper.removeClass('open');
					topics.$trigger.show();
				}
			},

			// hide the 'select topics' button
			disable: function() {
				var topics = buyingGuides.topics;

				topics.$wrapper.removeClass('open');
				topics.$trigger.hide();

				// remove focus from trigger link otherwise button stays highlighted when moving between viewports
				topics.$trigger.find('a').blur();
			},

			open: function() {
				var topics = buyingGuides.topics;

				if (breakpoint.mobile) {
					topics.$wrapper.addClass('open');
					topics.$trigger.find('a').attr('data-icon', 1);

					// close any other drop downs that may be open
					common.dropdownCheck(topics.close, topics.selector);
				}
			},

			close: function() {
				var topics = buyingGuides.topics;

				if (breakpoint.mobile) {
					topics.$wrapper.removeClass('open');
					topics.$trigger.find('a').attr('data-icon', 2);

					// cleanup dropdown close detection
					common.clearCancelDropdown();
				}
			},

			// hide/show the display of the ul menu by toggling 'open' class on the topics wrapper
			toggle: function(e) {
				var topics = buyingGuides.topics;

				e.preventDefault();
				e.stopPropagation();

				if (breakpoint.mobile) {
					if (topics.$wrapper.hasClass('open')) {
						topics.close();
					} else {
						topics.open();
					}
				}

				return false;
			},

			// content placement adjustments for desktop and large desktop
			contentAdjust: function() {

				var doAdjust = function(extendOptions) {
					var defaults = {
						isEnabled: false,
						className: '',
						selector : '',
						$content : ''
					};

					var opts = $.extend({}, defaults, extendOptions);

					if (opts.$content === '' || opts.selector === '' || opts.className === '') {
						return;
					}

					var $element = opts.$content.find(opts.selector).eq(0);
					var $parent  = $element.parents('.topic-content-inner');

					if ($element.length && $parent.length) {
						// add the class first so the elements position is adjusted before attempting to get it's height and position
						// set the min height of the first inner content container as the element will now be positioned absolutely
						if (opts.isEnabled) {
							opts.$content.addClass( opts.className );
							$parent.css('min-height', $element.outerHeight() + parseInt($element.css('margin-bottom'), 10) );
							$element.css('top', $parent.offset().top - opts.$content.offset().top );
						}

						// reset
						else {
							if (opts.$content.hasClass( opts.className )) {
								opts.$content.removeClass( opts.className );
								$parent.css('min-height', '');
								$element.css('top', '');
							}
						}
					}
				};

				$('#main-content .topic-content').each(function(){
					var $content = $(this);

					// blockquotes
					doAdjust({
						isEnabled: breakpoint.largeDesktop,
						$content : $content,
						selector : 'blockquote',
						className: 'topic-content-with-block-quote'
					});

					// videos
					doAdjust({
						isEnabled: breakpoint.desktop || breakpoint.largeDesktop,
						$content : $content,
						selector : '.video-container',
						className: 'topic-content-with-video'
					});

					// small images
					doAdjust({
						isEnabled: breakpoint.desktop || breakpoint.largeDesktop,
						$content : $content,
						selector : '.topic-image-small',
						className: 'topic-content-with-video'
					});
				});
			}
		},

		init: function() {
			var topics = buyingGuides.topics;

			topics.$wrapper = $(topics.selector);

			if (!topics.$wrapper.length) {
				return;
			}

			topics.$trigger = topics.$wrapper.find('.select-topic');
			topics.$menu    = topics.$wrapper.find('ul');

			// bind toggle to trigger to show/hide the menu (toggle() function checks if mobile)
			topics.$trigger.find('a').on('tap click', topics.toggle);

			// bind menu close to the menu links (close() function checks if mobile)
			topics.$menu.find('a').on('tap click', topics.close);

			// init the breakpoint functions here so only enabled if the wrapper is found
			breakpoint.mobileIn.push(function(){
				buyingGuides.topics.enable();
				buyingGuides.topics.contentAdjust();
			});

			breakpoint.vTabletIn.push(function(){
				buyingGuides.topics.disable();
				buyingGuides.topics.contentAdjust();
			});

			breakpoint.hTabletIn.push(function(){
				buyingGuides.topics.disable();
				buyingGuides.topics.contentAdjust();
			});

			breakpoint.desktopIn.push(function(){
				buyingGuides.topics.disable();
				buyingGuides.topics.contentAdjust();
			});

			breakpoint.largeDesktopIn.push(function(){
				buyingGuides.topics.disable();
				buyingGuides.topics.contentAdjust();
			});
		}
	};

	// init module
	common.init.push(buyingGuides.init);

	return buyingGuides;
});
/*global define:true, Microsoft: true */
define('modules/buying-guides-directory/common',['domlib', 'modules/common', 'modules/breakpoint'], function($, common, breakpoint){

	var buyingGuidesDirectory = {

		$wrapper: $('#buying-guides-directory'),

		eventClick: 'click',
		eventTransitionEnd: 'transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd',

		animSpeed: 500,

		isBusy: false,

		classNoSubMenu: 'no-sub-menu',

		// used for the breakpoint reset
		currentSubMenu: [],

		getParentMenu: function( $elm ) {
			return $elm.parents('ul').first();
		},

		getParentItem: function( $elm ) {
			if ($elm[0].tagName.toLowerCase() !== 'li') {
				$elm = $elm.parents('li').eq(0);
			}
			return $elm;
		},

		getSubMenu: function( $elm ) {
			return buyingGuidesDirectory.getParentItem( $elm ).find('> .sub-menu > ul, > ul');
		},

		setSelected: function( $elm ) {
			return buyingGuidesDirectory.getParentItem( $elm ).addClass('selected');
		},

		// adjust the wrapper height to match the passed elements height
		updateWrapperHeight: function( $subMenu ) {
			var self = buyingGuidesDirectory;

			if (!$subMenu || !$subMenu.length) {
				return false;
			}

			self.$wrapper.animate({
				height: $subMenu.outerHeight()
			}, self.animSpeed);
		},

		showLevelTwo: function(e) {
			var self = buyingGuidesDirectory;

			e.preventDefault();
			e.stopPropagation();

			if (self.isBusy) {
				return false;
			}

			self.isBusy  = true;

			var $target  = $(e.target);
			var $subMenu = self.getSubMenu( $target );

			// create the link to go back to level two
			if (!$subMenu.find('.level-back').length) {
				var backHTML   = '<li class="level-back"><a href="#">All buying guides</a></li>';
				var $backUpper = $( backHTML ).addClass('upper').on( self.eventClick, self.animateOut );
				var $backLower = $( backHTML ).addClass('lower').on( self.eventClick, self.animateOut );

				$subMenu.prepend( $backUpper );
				$subMenu.append( $backLower );
			}

			self.animateIn( $target );

			return false;
		},

		showLevelThree: function(e) {
			var self = buyingGuidesDirectory;

			e.preventDefault();
			e.stopPropagation();

			if (self.isBusy) {
				return false;
			}

			self.isBusy  = true;

			var $target  = $(e.target);
			var $subMenu = self.getSubMenu( $target );

			// create the link to go back to level two
			if (!$subMenu.find('.level-back').length) {
				var backHTML   = '<li class="level-back"><a href="#">All ' + $target.text() + ' buying guides</a></li>';
				var $backUpper = $( backHTML ).addClass('upper').on( self.eventClick, self.animateOut );
				var $backLower = $( backHTML ).addClass('lower').on( self.eventClick, self.animateOut );

				$subMenu.prepend( $backUpper );
				$subMenu.append( $backLower );
			}

			self.animateIn( $target );

			return false;
		},

		animateIn: function( $target ) {
			var self        = buyingGuidesDirectory;
			var $parentItem = self.getParentItem( $target );
			var $parentMenu = self.getParentMenu( $target );
			var $subMenu    = self.getSubMenu( $target );

			// slide in the sub menu
			$subMenu.show();

			self.updateWrapperHeight( $subMenu );
			$parentItem.addClass('selected');
			$parentMenu.addClass('animateIn').one( self.eventTransitionEnd, function() {
				self.isBusy = false;
			});

			self.currentSubMenu = $subMenu; // used for the breakpoint reset
		},

		animateOut: function(e) {
			var self    = buyingGuidesDirectory;

			e.preventDefault();
			e.stopPropagation();

			if (self.isBusy) {
				return false;
			}

			self.isBusy = true;

			var $target       = $(e.target);
			var $subMenu      = self.getParentMenu( $target );
			var $parentItem   = self.getParentItem( $target );
			var $selectedItem = $target.parents('.selected').first();
			var $animateMenu  = $target.parents('.animateIn').first();

			self.updateWrapperHeight( $animateMenu );

			// slide out the menu
			$animateMenu.addClass('animateOut').one( self.eventTransitionEnd, function() {
				$selectedItem.removeClass('selected');
				$animateMenu.removeClass('animateIn animateOut');
				$subMenu.hide();

				// used for the breakpoint reset
				if (self.currentSubMenu.hasClass('level-three')) {
					self.currentSubMenu = self.currentSubMenu.parents('.level-two');
				}
				else if (self.currentSubMenu.hasClass('level-two')) {
					self.currentSubMenu = self.currentSubMenu.parents('.level-one');
				}

				self.isBusy = false;
			});
		},

		bindEvents: function() {
			var self  = buyingGuidesDirectory;

			self.$wrapper.find('.level-one > li').not('.' + self.classNoSubMenu ).find('> a').on( self.eventClick, self.showLevelTwo );
			self.$wrapper.find('.level-two > li').not('.' + self.classNoSubMenu ).find('> a').on( self.eventClick, self.showLevelThree );
		},

		// if there's no sub menu is for a categery/sub category, then assume there is none
		// so add 'no-sub-menu' class to ensure the arrow icon is hidden
		hasSubMenuCheck: function( $menu ) {
			var self = buyingGuidesDirectory;

			self.$wrapper.find('ul.level-one, ul.level-two').each(function(){
				var $menu = $(this);

				$menu.find('> li').each(function(){
					var $item = $(this);

					if (!self.getSubMenu( $item ).length) {
						$item.addClass( self.classNoSubMenu );
					}
				});
			});
		},

		breakpointReset: function() {
			var self = buyingGuidesDirectory;
			self.updateWrapperHeight( self.currentSubMenu );
		},

		init: function() {
			var self = buyingGuidesDirectory;

			if (!self.$wrapper.length) {
				return;
			}

			// update the event type for touch devices
			if (common.isTouch()) {
				self.eventClick = common.isWindowsPhone() ? 'MSPointerDown' : 'tap click';
			}

			self.hasSubMenuCheck();
			self.bindEvents();
		}
	};

	// init module
	common.init.push(buyingGuidesDirectory.init);


	breakpoint.mobileIn.push(function() {
		buyingGuidesDirectory.breakpointReset();
	});

	breakpoint.vTabletIn.push(function() {
		buyingGuidesDirectory.breakpointReset();
	});

	breakpoint.hTabletIn.push(function() {
		buyingGuidesDirectory.breakpointReset();
	});

	breakpoint.desktopIn.push(function() {
		buyingGuidesDirectory.breakpointReset();
	});

	breakpoint.largeDesktopIn.push(function() {
		buyingGuidesDirectory.breakpointReset();
	});

	return buyingGuidesDirectory;
});

define('modules/deferred-block/common',['domlib', 'modules/common'], function($, common) {	
	var deferredBlock = {
		init: function(selector) {
			common.initDeferredMethods($(selector));
		}
	};	
	
	return deferredBlock;
});
/*globals define*/
/*jslint plusplus:true*/
define('modules/pdp-configurator/product-updater',[
    'domlib',
    'modules/breakpoint',
    'modules/common'
], function () {
    'use strict';
    var subscribers = [];

    return {
        subscribe: function (subscribeFn) {
            subscribers.push(subscribeFn);
            return subscribers;
        },
        update: function () {
            var len = subscribers.length,
                i;

            for (i = 0; i < len; i++) {
                subscribers[i].apply(this, arguments);
            }
        }
    };
});
/*globals define*/
/*jslint plusplus: true */
define('modules/pdp-configurator/colour-menu',[
    'domlib',
    'modules/breakpoint',
    'modules/common'
], function ($) {
    'use strict';

    var ColourMenu = function ColourMenu() {

        return this;
    };

    ColourMenu.prototype.init = function ($parent) {
        this.$menu = $parent.find('.colour-menu');
        this.callbacks = [];
        this.initListeners();
    };

    ColourMenu.prototype.initListeners = function () {
        var colourMenu = this;

        $(colourMenu.$menu).find('ul li a').on('click', function (e) {
            e.preventDefault();
            colourMenu.performCallbacks(e);
        });
    };

    ColourMenu.prototype.onItemSelected = function (inputFunction) {
        this.callbacks.push(inputFunction);
    };

    ColourMenu.prototype.performCallbacks = function (id) {
        var i;

        for (i = 0; i < this.callbacks.length; i++) {
            this.callbacks[i](id);
        }
    };

    return {
        createColourMenu: function () {
            return new ColourMenu();
        }

    };
});
/*global window, define*/
/*jslint plusplus:true*/
define('modules/pdp-configurator/product-info-carousel',[
    'domlib',
    'modules/basic-carousel/common',
    'modules/breakpoint',
    'modules/common'
], function ($, BasicCarousel) {
    'use strict';
    var IndicatorCarousel = function IndicatorCarousel(noOfSlides, elId, carousel) {
        var indicatorCarousel = this;

        indicatorCarousel.carousel = carousel;
        indicatorCarousel.$indicators = $(indicatorCarousel.create(noOfSlides));

        indicatorCarousel.setIndicatorEvents();
        indicatorCarousel.$indicators.find('li:first-child').addClass('active');
        indicatorCarousel.$indicators.appendTo('#' + elId);

        if (window.isTouch()) {
            indicatorCarousel.carousel.$carouselItemsContainer.find('li').on('swipeRight', function () {
                indicatorCarousel.carousel.$btnPrev.trigger('click');
            });
            indicatorCarousel.carousel.$carouselItemsContainer.find('li').on('swipeLeft', function () {
                indicatorCarousel.carousel.$btnNext.trigger('click');
            });
        }
    };

    IndicatorCarousel.prototype = {
        create : function (len) {
            var i,
                items = '<ul class="carousel-indicators">';

            for (i = 0; i < len; i++) {
                items += '<li></li>';
            }

            items += '</ul>';

            return items;
        },
        setActiveIndicator : function (index) {
            this.$indicators.find('li')
                .eq(index).addClass('active')
                .siblings().removeClass('active');
        },
        setIndicatorEvents : function () {
            var indicatorCarousel = this;

            indicatorCarousel.$indicators.on('click', 'li', function () {
                var index = $(this).index();
                indicatorCarousel.carousel.setItem(index);
            });
            indicatorCarousel.$indicators.on('click', 'li', function () {
                indicatorCarousel.setActiveIndicator($(this).index());
            });
            indicatorCarousel.carousel.$btnNext.on('click', function () {
                if (!$(this).hasClass('disabled')) {
                    indicatorCarousel.setActiveIndicator(indicatorCarousel.carousel.activePanel);
                }
            });
            indicatorCarousel.carousel.$btnPrev.on('click', function () {
                if (!$(this).hasClass('disabled')) {
                    indicatorCarousel.setActiveIndicator(indicatorCarousel.carousel.activePanel - 2);
                }
            });

        }
    };

    return {
        create : function init(elId, slides) {
            var carousel, content, noOfSlides;

            content = $.trim(slides);
            noOfSlides = $('<ul></ul>').append(content).find('li').length;
            carousel = new BasicCarousel({
                elementId: elId,
                isHorizontal : true,
                content : content
            });
            // we need to override this method as this method is tightly coupled with scene7 carousels
            carousel.calculatePanels = function (visibleItems) {
                var selectedIndex = 0,
                    updatedPanel;
                this.panelItemCount = 0;
                this.numPanels = 0;
                this.panelWidth = 0;
                this.animateSet(0);
                this.panelItemCount = visibleItems;
                this.numPanels = Math.ceil(this.numItems / this.panelItemCount);
                this.panelWidth = this.itemSize * this.panelItemCount;
                if (this.numPanels < 2) {
                    this.$btnNext.addClass('disabled');
                }

                if ((selectedIndex + 1) > this.panelItemCount) {
                    updatedPanel = Math.ceil(selectedIndex / this.panelItemCount);
                    this.activePanel = updatedPanel;
                    this.animateSet(null, this.activePanel);
                } else {
                    this.activePanel = 1;
                }

                if (selectedIndex < this.panelItemCount) {
                    this.$btnPrev.addClass('disabled');
                }
            };

            return new IndicatorCarousel(noOfSlides, elId, carousel);
        }
    };
});
/*global window, define*/
/*jslint nomen:true*/
define('modules/pdp-configurator/product-info',[
    'domlib',
    'modules/media-matrix/common',
    'modules/pdp-configurator/product-updater',
    'modules/pdp-s7viewer/common',
    'modules/pdp-configurator/product-info-carousel',
    'modules/common',
    'modules/breakpoint'
], function ($, mediaMatrix, productUpdater, pdpScene7, infoCarousel) {
    'use strict';
    var init,
        initProductInfoEvents,
        showProductInfo,
        hideProductInfoBtn,
        setBtnEvents,
        prodInfoCarousel,
        skuID,
        getCurrentSku,
        initS7Params,
        changeBannerTitles,
        $hideProductInfoBtn,
        $productInfoOverlay,
        $configuratorBanner;

    initProductInfoEvents = function initProductInfoEvents() {
        var carouselContent = $productInfoOverlay.find('.info-carousel-slider ul').html(),
            $carouselContent = $('<ul />').append(carouselContent);

        if (carouselContent) {
            $productInfoOverlay.removeClass('is-info-single');
            $productInfoOverlay.addClass('is-info-shown');
            if ($carouselContent.find('li').length > 1) {
                prodInfoCarousel = infoCarousel.create('product-carousel-info', carouselContent);
                prodInfoCarousel.carousel.calculateVisibleItems();
            } else {
                $productInfoOverlay.addClass('is-info-single');
            }
        } else {
            $productInfoOverlay.find('#pdp-product-info').remove();
            $productInfoOverlay.find('#pdp-product-zoom').addClass('current');
            $productInfoOverlay.find('#product-carousel').toggleClass('prodInfoVisible zoomVisible');
        }

        initS7Params();
        pdpScene7.init();
        setBtnEvents();
    };

    showProductInfo = function showProductInfo() {
        $productInfoOverlay.addClass('is-info-shown');
        $('.configurator-banner').addClass('is-product-info');
    };

    hideProductInfoBtn = function hideProductInfoBtn() {
        $productInfoOverlay.removeClass('is-info-shown');
        $configuratorBanner.removeClass('is-product-info');

        window.setTimeout(function () {
            // stop the video
            $productInfoOverlay.detach().appendTo('.configurator-container');
        }, 750);
    };

    setBtnEvents = function setBtnEvents() {
        $productInfoOverlay.find('.media-controls .button').on('click', changeBannerTitles);
        $hideProductInfoBtn.on('click', hideProductInfoBtn);
        $configuratorBanner.find('.product-info-banner .back-btn').on('click', hideProductInfoBtn);
    };

    getCurrentSku = function getCurrentSku() {
        return skuID;
    };

    changeBannerTitles = function changeBannerTitles() {
        $configuratorBanner.find('.product-info-banner .banner-msg').text($(this).text());
    };

    initS7Params = function initS7Params() {
        var $infoContainer = $productInfoOverlay.find('.pdp-configurator-info'),
            scene7PdpData;

        window.TescoData = window.TescoData || {};
        window.TescoData.pdp = window.TescoData.pdp || {};
        window.TescoData.pdp.scene7 = window.TescoData.pdp.scene7 || {};
        window._mediaCollectionUpdated = [];

        scene7PdpData = window.TescoData.pdp.scene7;
        scene7PdpData.s7ServerUrl = $infoContainer.data('serverurl');
        scene7PdpData.s7ImageSet = $infoContainer.data('imageset').replace(/ /gi, '');
        scene7PdpData.s7SpinSet =  $infoContainer.data('spinset');
        scene7PdpData._s7VideoSet = $infoContainer.data('videoset').replace(/[\[\]\'\" ]/gi, '').split(',');
        mediaMatrix.init();
    };

    init = function init(id, dataAttributes) {
        skuID = id;
        $productInfoOverlay = $('#productInfoOverlay');
        $hideProductInfoBtn = $productInfoOverlay.find('.close');
        $configuratorBanner = $('.configurator-banner');
        $('.pdp-configurator-info').empty();
        productUpdater.update(dataAttributes, 'productDetailOverlay', function (infoPromise) {
            infoPromise.then(function (d) {
                $('.pdp-configurator-info').replaceWith(d.productDetailOverlay);
                return this;
            }).done(initProductInfoEvents);
        });
    };

    return {
        init : init,
        show : showProductInfo,
        getCurrentSku : getCurrentSku
    };
});
/*globals define*/
define('modules/pdp-configurator/observer',[
    'domlib',
    'modules/breakpoint',
    'modules/common'
], function () {
    'use strict';
    var subscribers = [],
        subscribe,
        unsubscribe,
        publish,
        loopThroughSubscribers;

    subscribe = function (callback) {
        subscribers.push(callback);
    };

    unsubscribe = function (callback) {
        loopThroughSubscribers('unsubscribe', callback);
    };

    publish = function () {
        loopThroughSubscribers('publish', arguments);
    };

    loopThroughSubscribers = function (action, arg) {
        var i, max = subscribers.length;

        for (i = 0; i < max; i += 1) {
            if (action === 'publish') {
                subscribers[i].apply(this, arg);
            } else if (subscribers[i] === arg) {
                subscribers.splice(i, 1);
            }
        }
    };

    return {
        subscribe: subscribe,
        unsubscribe: unsubscribe,
        publish: publish
    };
});
/*globals window, define*/
/*jslint plusplus:true*/
define('modules/pdp-configurator/product-factory',[
    'domlib',
    'modules/pdp-configurator/colour-menu',
    'modules/pdp-configurator/product-info',
    'modules/pdp-configurator/observer',
    'modules/pdp-configurator/product-info-carousel'
], function ($, colourMenuFactory, productInfo, observer, productCarousel) {
    'use strict';
    var ProductFactory = function Product(name) {
        var product = this;

        product.name = name;
        product.inits = [];
        product.colourMap = {};
        product.$parentContainer = null;
        product.currentColour = null;
        product.currentColourContrast = null;
        product.currentColourName = null;
        product.currentSKU = null;

        product.inits.push(function (containerSelector) {
            product.$parentContainer = $(containerSelector);
            if (product.$parentContainer.find('.product-selector-inner').length > 0) {
                product.currentColourName = $.trim(product.$parentContainer.find('.colour-menu input[name=colour]').val());
                product.currentSKU = $.trim(product.$parentContainer.find('.product-selector-inner').attr('data-sku'));
                product.currentColour = product.getMapColour(product.currentColourName).primary;
                product.currentColourContrast = product.getMapColour(product.currentColourName).secondary;
                product.initColourMenu();
                product.initListeners();
                product.initCarousel();
                product.initImages();
                product.updateColour();
            }
        });
    };

    ProductFactory.prototype = {
        init: function () {
            var product = this,
                len = product.inits.length,
                i;

            for (i = 0; i < len; i++) {
                product.inits[i].apply(this, arguments);
            }
        },
        initCarousel: function () {
            var product = this,
                $carouselParent = product.$parentContainer.find('.product-front-back'),
                imageSet = $carouselParent.data('images').split(','),
                imageBase = $carouselParent.data('imageurl'),
                tmpl = '<li data-index="{index}"><img alt="" src="{base}{url}"></li>',
                frontBack,
                content = "";

            if (imageSet.length === 1) {
                $carouselParent.html('<img alt="" src="{base}{url}" />'.replace('{base}', imageBase).replace('{url}', imageSet[0]));
            } else if (imageSet.length > 1) {
                $.each(imageSet, function (key, val) {
                    if (key > 1) {
                        return false;
                    }

                    content += tmpl.replace('{base}', imageBase)
                        .replace('{url}', val)
                        .replace('{index}', key);
                });
                frontBack = productCarousel.create(product.name + '-front-back', content);
                frontBack.carousel.calculateVisibleItems();
                $(window).off('orientationchange').on('orientationchange', function () {
                    frontBack.carousel.calculateVisibleItems();
                    frontBack.setActiveIndicator(0);
                });
            }
        },
        initColourMenu: function () {
            var product = this,
                colourMenu;

            colourMenu = colourMenuFactory.createColourMenu();
            colourMenu.init(product.$parentContainer);
            colourMenu.onItemSelected(function (e) {
                product.currentColourName = $(e.currentTarget).attr('data-name');
                product.currentColour = product.getMapColour(product.currentColourName).primary;
                product.currentColourContrast = product.getMapColour(product.currentColourName).secondary;
                product.currentSKU = $(e.currentTarget).attr('data-sku');
                observer.publish(product.name + '-selector,colour-selected', e);
            });
        },
        initListeners: function () {
            var product = this;
            product.$parentContainer.find('button').on('click', function (e) {
                observer.publish(product.name + '-selector,' + $(this).data('action'), e);
            });

            product.$parentContainer.find('.show-product-info').on('click', function () {
                var skuID = $(this).data('skuid');
                productInfo.init(skuID, $(this).data());
                productInfo.show();
            });
        },
        initImages: function () {
            window.picturefill();
        },
        updateColour: function () {
            var product = this;
            product.$parentContainer.find('.border-color-btn').css({
                'color': product.currentColourContrast || product.currentColour,
                'backgroundColor': '#fff',
                'border': '1px solid ' + (product.currentColourContrast || product.currentColour)
            });
            product.$parentContainer.find('.background-color-btn').css({
                'color': '#fff',
                'backgroundColor': product.currentColourContrast || product.currentColour,
                'border': '1px solid ' + (product.currentColourContrast || product.currentColour)
            });
            product.$parentContainer.find('.colour-menu-item a').each(function () {
                var $colourItem = $(this),
                    colour = product.getMapColour($colourItem.data('value'));
                $colourItem.css({
                    'color': colour.secondary,
                    'backgroundColor': colour.primary,
                    'border': '1px solid ' + colour.secondary
                });
            });
        },
        registerForStockAlerts: function (isAjax) {
            var product = this,
                defer = $.Deferred(),
                promise = defer.promise(),
                $form = product.$parentContainer.find('.basket-form-action form'),
                $manageAlerts = product.$parentContainer.find('.basket-form-action .btn-manage-stock-alerts'),
                hasForm = $form.length > 0,
                hasManageAlertsLink = $manageAlerts.length > 0;

            $form.find('input[type="submit"][name*="AlertFormHandler.set"]').attr('type', 'hidden');
            if (isAjax) {
                if (hasForm) {
                    promise = $.post($form.attr('action'), $form.serialize());
                } else {
                    defer.resolve();
                }
            } else {
                if (hasForm) {
                    $form.submit();
                } else if (hasManageAlertsLink) {
                    window.location.href = $manageAlerts.attr('href');
                }
            }

            return promise;
        },
        addToBasket: function () {
            var product = this,
                defer = $.Deferred(),
                promise = defer.promise(),
                $form = product.$parentContainer.find('.basket-form-action form'),
                hasForm = $form.length > 0;

            if (hasForm) {
                promise = $.post($form.attr('action'), $form.serialize());
            } else {
                defer.resolve();
            }

            return promise;
        },
        gaGetProduct: function () {
            var product = this,
                productId = $.trim(product.$parentContainer.find('.product-selector-inner').attr('data-sku')),
                productName = $('h2', product.$parentContainer).text(),
                productCategory = $('#breadcrumbCategoryOnly').val();

            return {
                'id': productId,
                'name': productName,
                'category': productCategory,
            };

        },
        animate: function ($view) {
            var $selector = $view || this.$parentContainer;

            if (!$selector.hasClass('animating') && $('html').hasClass('csstransitions')) {
                $selector.addClass('animating');
                window.setTimeout(function () {
                    $selector.removeClass('animating');
                }, 800);
            }

            return $selector;
        },
        show: function () {
            this.animate();
            return this.$parentContainer.removeClass('background closed');
        },
        showSummary: function () {
            this.animate();
            return this.$parentContainer.removeClass('closed').addClass('background');
        },
        hide: function () {
            this.animate();
            return this.$parentContainer.removeClass('background').addClass('closed');
        },
        getMapColour: function (colourName) {
            var product = this,
                defaultSecondary = null,
                currentMap = window.PDPCONFIGURATOR.colourMap,
                primaryMap = {},
                secondaryMap = {};

            colourName = $.trim(colourName.toLowerCase());

            if (product.colourMap[colourName]) {
                return product.colourMap[colourName];
            }

            $.map(currentMap, function (val, key) {
                var colourValues = val.split(','),
                    primaryColour = colourValues[0],
                    secondaryColour = colourValues[1];
                primaryMap[$.trim(key).toLowerCase()] = $.trim(primaryColour);
                secondaryMap[$.trim(key).toLowerCase()] = $.trim(secondaryColour || defaultSecondary);
            });

            product.colourMap[colourName] = {
                primary: primaryMap[colourName] || colourName,
                secondary: secondaryMap[colourName] || defaultSecondary
            };

            return product.colourMap[colourName];
        },
        getSelectedColour: function () {
            return this.currentColour;
        },
        getContrastColour: function () {
            return this.currentColourContrast;
        },
        getSelectedColourName: function () {
            return this.currentColourName;
        },
        getSelectedSKU: function () {
            return this.currentSKU;
        }
    };

    return ProductFactory;
});

/*globals window, define*/
define('modules/pdp-configurator/tablet-selector',[
    'domlib',
    'modules/pdp-configurator/product-factory',
    'modules/breakpoint',
    'modules/common'
], function ($, ProductFactory) {
    'use strict';
    var tabletSelector = new ProductFactory('tablet');

    tabletSelector.initRatings = function () {
        if (window.$BV && window.$BV.configure && window.$BV.ui) {
            window.$BV.configure('global', {
                productId: $.trim(tabletSelector.currentSKU)
            });
            window.$BV.ui("rr", "show_reviews");
        }
    };

    tabletSelector.inits.push(tabletSelector.initRatings);
    return tabletSelector;
});
/*globals define*/
define('modules/pdp-configurator/case-selector',[
    'domlib',
    'modules/pdp-configurator/product-factory',
    'modules/pdp-configurator/observer',
    'modules/breakpoint',
    'modules/common'
], function ($, ProductFactory, observer) {
    'use strict';
    var caseSelector = new ProductFactory('case');

    caseSelector.initCategory = function () {
        $('.category-selector.case-category').find('[data-action]').off('.case-category')
            .on('click.case-category', function (e) {
                observer.publish('case-selector,' + $(this).data('action'), e);
            });
    };

    caseSelector.showCategories = function () {
        $('.category-selector.case-category').addClass('open');
        $('.configurator-banner').addClass('is-case-category');
    };

    caseSelector.hideCategories = function () {
        $('.category-selector.case-category').removeClass('open');
        $('.configurator-banner').removeClass('is-case-category');
    };

    caseSelector.animateCategories = function () {
        caseSelector.animate($('.category-selector.case-category'));
    };

    caseSelector.addCase = function () {
        return $('.configurator-container').addClass('has-case');
    };

    caseSelector.removeCase = function () {
        caseSelector.animate();
        return $('.configurator-container').removeClass('has-case');
    };

    caseSelector.hasCase = function () {
        return $('.configurator-container').hasClass('has-case');
    };

    return caseSelector;
});
/*globals define*/
define('modules/pdp-configurator/add-to-basket',[
    'domlib',
    'modules/common',
    'modules/tesco.analytics',
    'modules/pdp-configurator/observer',
    'modules/pdp-configurator/tablet-selector',
    'modules/pdp-configurator/case-selector'
], function ($, common, analytics, observer, tabletSelector, caseSelector) {
    'use strict';

    var init,
        initListeners,
        $parentContainer,
        updateColor,
        setAnalytics,
        setBasketCount,
        showDetails,
        hideDetails;

    init = function init(containerSelector) {
        $parentContainer = $(containerSelector);
        initListeners();
    };

    initListeners = function initListeners() {
        $parentContainer.find('button').on('click', function (e) {
            observer.publish('add-to-basket,' + $(this).data('action'), e);
        });
    };

    updateColor = function updateColor(headerColor, hasCase) {
        var caseBtnTxt = (hasCase ? 'Change' : 'Add a') + ' <span class="heavy">case</span>';

        $parentContainer.find('.header-mask').css({
            'background-color': headerColor
        });

        if (hasCase) {
            $parentContainer.find('button.add-a-case').css({
                'background-color': caseSelector.getSelectedColour(),
                'border': 'none',
                'color': (caseSelector.getContrastColour() || '#fff')
            }).html(caseBtnTxt);
        } else {
            $parentContainer.find('button.add-a-case').css({
                'background-color': (tabletSelector.getContrastColour() || '#fff'),
                'color': tabletSelector.getSelectedColour(),
                'border': '1px solid ' + tabletSelector.getSelectedColour()
            }).html(caseBtnTxt);
        }
        $parentContainer.find('button.update-tablet ').css({
            'background-color': tabletSelector.getSelectedColour(),
            'color': tabletSelector.getContrastColour()
        });
    };

    setAnalytics = function setAnalytics(d) {
        var oWebAnalytics;
        try {
            oWebAnalytics = new analytics.WebMetrics();
            oWebAnalytics.submit($.parseJSON(d).analytics);
        } catch (ignore) {}
    };

    setBasketCount = function setBasketCount() {
        var $mainBasket = $('.basketMenu'),
            $lozenge = $mainBasket.find('.numberOfItems');
        $mainBasket.addClass('.withItems');
        $lozenge.text(parseInt($lozenge.text(), 10) + 1);
        common.detectBasketStatus();
    };

    showDetails = function showDetails() {
        return $parentContainer.removeClass('closed');
    };

    hideDetails = function hideDetails() {
        return $parentContainer.addClass('closed');
    };

    return {
        init: init,
        updateColor: updateColor,
        setAnalytics: setAnalytics,
        setBasketCount: setBasketCount,
        showDetails: showDetails,
        hideDetails: hideDetails
    };
});
/*globals define*/
define('modules/pdp-configurator/inspiration-panel',[
    'domlib',
    'modules/pdp-configurator/observer',
    'modules/breakpoint',
    'modules/common'
], function ($, observer) {
    'use strict';
    var init,
        initListeners,
        $parentContainer;

    init = function init(containerSelector) {
        $parentContainer = $(containerSelector);
        initListeners();
    };

    initListeners = function initListeners() {
        $parentContainer.find('a').on('click', function (e) {
            e.preventDefault();
            observer.publish('inspiration-panel,' + $(this).data('action'), e);
        });
    };

    return {
        init: init
    };
});
/*global window, define */
/*jslint regexp: true */

define('modules/pdp-configurator/combinationsHelper',[
    'domlib',
    'modules/breakpoint',
    'modules/common'
], function ($, breakpoint) {
    'use strict';
    var init,
        utils,
        config,
        getUpsellMsgTpl,
        getTitle,
        getPrice,
        getPoints,
        getReleaseDate,
        getStatusData,
        getImage,
        setTitle,
        setPrice,
        setPoints,
        setImage,
        setStatus,
        setStatusTxt,
        setStatusAction,
        setAll,
        $p1,
        $p2,
        $combinedProduct;



    config = {
        imageSize: {
            mobile: "s",
            desktop: "l",
            kiosk: "xl"
        },
        statusId: {
            noItem: "noitem",
            preOrder: "preOrder",
            inStock: "buy",
            outOfStock: "emwbis"
        },
        statusAction: {
            addP1: "addTablet",
            addP2: "addCase",
            addP1P2: "addAll",
            alertP1: "alertTablet",
            alertP2: "alertCase",
            alertP1P2: "alertAll"
        },
        data: function () {
            var PDPCONFIGURATOR = window.PDPCONFIGURATOR;
            return PDPCONFIGURATOR.data;
        }
    };

    utils = {
        hasP2: function () {
            return $('.configurator-container').hasClass('has-case');
        },
        strToNum: function (num) {
            return window.parseFloat(num.replace(/[^0-9\.]+/g, ''));
        },
        getImagePath: function () {
            return $combinedProduct.data('base-image') + "{p1}_{p2}_{size}." + $combinedProduct.data('base-image-type');
        }
    };

    getUpsellMsgTpl = function getUpsellMsgTpl(msg) {
        var title1 = $p1.find('header h2').text(),
            title2 = utils.hasP2() ? (" + " + $p2.find('header h2').text()) : "";

        return msg.replace("{p1}", title1)
            .replace("{p2}", title2);
    };

    getReleaseDate = function getReleaseDate(p1Date, p2Date) {
        if (typeof p1Date !== "string") {
            p1Date = "";
        }

        if (typeof p2Date !== "string") {
            p2Date = "";
        }

        if ($.trim(p1Date).length < 1 && $.trim(p2Date).length > 0) {
            return p2Date;
        }

        return p1Date;
    };

    getTitle = function getTitle(title1, title2, releaseDate) {
        var $tmpl,
            tmpl = config.data().titleTmpl;

        tmpl = tmpl.replace('{p1}', title1);
        tmpl = tmpl.replace('{p2}', title2);
        tmpl = tmpl.replace('{date}', releaseDate);
        $tmpl = $(tmpl);

        if (!utils.hasP2()) {
            $tmpl.find('.p2-title').remove();
            $tmpl.find('.combination').remove();
        }

        if (!releaseDate) {
            $tmpl.find('.release-date').remove();
        }

        return $tmpl;
    };

    getPrice = function getPrice(p1Price, p2Price) {
        p1Price = utils.strToNum(p1Price);
        p2Price = utils.hasP2() ? utils.strToNum(p2Price) : 0;

        return "&pound;" + (p1Price + p2Price).toFixed(2);
    };

    getPoints = function getPoints(p1Points, p2Points) {
        p2Points = utils.hasP2() ? p2Points : 0;

        return config.data().clubCardMsg.replace('{points}', (p1Points + p2Points));
    };

    /*
     * For inventory availability matrix, see Adam Johnston(PO)
     */
    getStatusData = function getStatusData(p1StatusId, p2StatusId) {
        var data = {
            msg: "",
            text: "",
            action: null,
            hasReleaseDate: false
        };

        if (p1StatusId === config.statusId.preOrder && p2StatusId === config.statusId.preOrder) {
            data.msg = config.data().statusMsg.generic;
            data.text = config.data().statusText.preOrder;
            data.action = config.statusAction.addP1P2;
            data.hasReleaseDate = true;
        } else if (p1StatusId === config.statusId.preOrder && p2StatusId === config.statusId.inStock) {
            data.msg = config.data().statusMsg.generic;
            data.text = config.data().statusText.preOrder;
            data.action = config.statusAction.addP1P2;
            data.hasReleaseDate = true;
        } else if (p1StatusId === config.statusId.inStock && p2StatusId === config.statusId.preOrder) {
            data.msg = config.data().statusMsg.generic;
            data.text = config.data().statusText.preOrder;
            data.action = config.statusAction.addP1P2;
            data.hasReleaseDate = true;
        } else if (p1StatusId === config.statusId.inStock && p2StatusId === config.statusId.inStock) {
            data.msg = config.data().statusMsg.generic;
            data.text = config.data().statusText.add;
            data.action = config.statusAction.addP1P2;
        } else if (p1StatusId === config.statusId.outOfStock && p2StatusId === config.statusId.inStock) {
            data.msg = config.data().statusMsg.noP1Msg;
            data.text = config.data().statusText.alert;
            data.action = config.statusAction.alertP1;
        } else if (p1StatusId === config.statusId.inStock && p2StatusId === config.statusId.outOfStock) {
            data.msg = config.data().statusMsg.noP2Msg;
            data.text = config.data().statusText.alert;
            data.action = config.statusAction.alertP2;
        } else if (p1StatusId === config.statusId.outOfStock && p2StatusId === config.statusId.preOrder) {
            data.msg = config.data().statusMsg.noP1Msg;
            data.text = config.data().statusText.alert;
            data.action = config.statusAction.alertP1;
        } else if (p1StatusId === config.statusId.preOrder && p2StatusId === config.statusId.outOfStock) {
            data.msg = config.data().statusMsg.noP2Msg;
            data.text = config.data().statusText.alert;
            data.action = config.statusAction.alertP2;
        } else if (p1StatusId === config.statusId.outOfStock && p2StatusId === config.statusId.outOfStock) {
            data.msg = config.data().statusMsg.noP1P2Msg;
            data.text = config.data().statusText.alert;
            data.action = config.statusAction.alertP1P2;
        } else if (p1StatusId === config.statusId.preOrder && p2StatusId === config.statusId.noItem) {
            data.msg = config.data().statusMsg.generic;
            data.text = config.data().statusText.preOrder;
            data.action = config.statusAction.addP1;
            data.hasReleaseDate = true;
        } else if (p1StatusId === config.statusId.inStock && p2StatusId === config.statusId.noItem) {
            data.msg = config.data().statusMsg.generic;
            data.text = config.data().statusText.add;
            data.action = config.statusAction.addP1;
        } else if (p1StatusId === config.statusId.outOfStock && p2StatusId === config.statusId.noItem) {
            data.msg = config.data().statusMsg.noP1Msg;
            data.text = config.data().statusText.alert;
            data.action = config.statusAction.alertP1;
        }

        return data;
    };

    getImage = function getImage(p1Sku, p2Sku) {
        var imageUrl = utils.getImagePath().replace('{p1}', p1Sku);

        if (!utils.hasP2()) {
            imageUrl = imageUrl.replace('_{p2}', '');
        } else {
            imageUrl = imageUrl.replace('{p2}', p2Sku);
        }

        if (breakpoint.mobile) {
            imageUrl = imageUrl.replace('{size}', config.imageSize.mobile);
        } else if (breakpoint.kiosk) {
            imageUrl = imageUrl.replace('{size}', config.imageSize.kiosk);
        } else {
            imageUrl = imageUrl.replace('{size}', config.imageSize.desktop);
        }

        return imageUrl;
    };

    setTitle = function setTitle($title) {
        $combinedProduct.find('header h2').replaceWith($title);
    };

    setPrice = function setPrice() {
        var p1Price = $p1.find('.current-price:first').text(),
            p2Price = $p2.find('.current-price:first').text(),
            price = getPrice(p1Price, p2Price);
        $combinedProduct.find('.product-description .price').html(price);
    };

    setPoints = function setPoints() {
        var p1Points = utils.strToNum($p1.find('.clubcard:first').text()),
            p2Points = utils.strToNum($p2.find('.clubcard:first').text()),
            points = getPoints(p1Points, p2Points);
        $combinedProduct.find('.product-description .points').text(points);
    };

    setImage = function setImage() {
        var p1Sku = $p1.find('.product-selector-inner').data('sku'),
            p2Sku = $p2.find('.product-selector-inner').data('sku'),
            img = 'url("{url}")'.replace('{url}', getImage(p1Sku, p2Sku));
        $combinedProduct.find('.image-container').css({
            backgroundImage: img
        });
    };

    setStatus = function setStatus() {
        var p1StatusId = $p1.find('.product-selector-inner').data('status'),
            p2StatusId = !utils.hasP2() ? config.statusId.noItem : $p2.find('.product-selector-inner').data('status'),
            statusData = getStatusData(p1StatusId, p2StatusId);

        setStatusTxt(statusData);
        setStatusAction(statusData.action);
    };

    setStatusTxt = function setStatusTxt(statusData) {
        var p1Title = $p1.find('header h2').text(),
            p2Title = $p2.find('header h2').text(),
            p1Date = $p1.find('.product-selector-inner').data('release'),
            p2Date = $p2.find('.product-selector-inner').data('release'),
            releaseDate = statusData.hasReleaseDate ? getReleaseDate(p1Date, p2Date) : undefined,
            title = getTitle(p1Title, p2Title, releaseDate);

        $combinedProduct.find('.highlight').html(statusData.msg);
        $combinedProduct.find('.add-to-basket').text(statusData.text);
        $combinedProduct.find('.add-to-basket').toggleClass('out-of-stock', statusData.text === config.data().statusText.alert);
        setTitle(title);
    };

    setStatusAction = function setStatusAction(action) {
        $combinedProduct.find('button.add-to-basket').data('formaction', action);
    };

    setAll = function setAll() {
        setStatus();
        setPrice();
        setPoints();
        setImage();
        $combinedProduct.find('.add-to-basket-inner').detach().appendTo($combinedProduct);
    };

    init = function init(p1, p2, combinedView) {
        $p1 = $(p1);
        $p2 = $(p2);
        $combinedProduct = $(combinedView);
        setAll();
    };

    return {
        init: init,
        config: config,
        setAll: setAll,
        getUpsellMsgTpl: getUpsellMsgTpl
    };
});
/*globals window, define*/
define('modules/pdp-configurator/accessory-selector',[
    'modules/pdp-configurator/product-factory',
    'domlib',
    'modules/common'
], function (ProductFactory) {
    'use strict';

    var accessorySelector = new ProductFactory('accessory');

    accessorySelector.inits.push(function () {
        var action = accessorySelector.$parentContainer.find('.product-selector-inner').data('status'),
            $button = accessorySelector.$parentContainer.find('button.add-to-basket');
        $button.text(accessorySelector.getStatusText(action));

        if (action === "emwbis") {
            $button.addClass('out-of-stock');
        }
    });

    accessorySelector.getUpsellMsgTpl = function () {
        var title1 = accessorySelector.$parentContainer.find('header h2').text(),
            msg = window.PDPCONFIGURATOR.data.upsellMsgTpl.add;
        return msg.replace("{p1}", title1).replace("{p2}", "");
    };

    accessorySelector.getStatusText = function (action) {
        switch (action) {
        case "preOrder":
            return window.PDPCONFIGURATOR.data.statusText.preOrder;
        case "emwbis":
            return window.PDPCONFIGURATOR.data.statusText.alert;
        case "buy":
            return window.PDPCONFIGURATOR.data.statusText.add;
        }
    };

    return accessorySelector;
});
/*globals window, define*/
define('modules/pdp-configurator/upsell-selector',[
    'domlib',
    'modules/pdp-configurator/observer',
    'modules/breakpoint',
    'modules/common'
], function ($, observer) {
    'use strict';
    var init,
        initListeners,
        toggleUpsellView,
        setUpsellMsg,
        $upsellSelector,
        $configuratorContainer;

    init = function init(containerSelector) {
        $configuratorContainer = $('.configurator-container');
        $upsellSelector = $(containerSelector);
        initListeners();
    };

    initListeners = function initListeners() {
        $upsellSelector.find('[data-action]').off('.upsell')
            .on('click.upsell', function (e) {
                observer.publish('upsell-selector,' + $(this).data('action'), e);
            });
    };

    toggleUpsellView = function toggleUpsellView(isShow) {
        $upsellSelector.toggleClass('open', isShow);
        $configuratorContainer.toggleClass('has-upsell-view', isShow);
    };

    setUpsellMsg = function setUpsellMsg(msg) {
        $upsellSelector.find('.added-to-basket').text(msg);
    };

    return {
        init : init,
        toggleUpsellView : toggleUpsellView,
        setUpsellMsg : setUpsellMsg
    };
});
/*globals window, define*/
define('modules/pdp-configurator/product-service',[
    'domlib',
    'modules/common',
    'modules/tesco.data',
    'modules/pdp-configurator/product-updater',
    'modules/tesco.utils',
    'modules/breakpoint'
], function ($, common, data, productUpdater) {
    'use strict';
    var init,
        addQueryParam,
        globalOptions;

    globalOptions = {
        'inlineRequests': [],
        'requests': {
            'tablet': ['tablet'],
            'productDetailOverlay': ['productDetailOverlay'],
            'case': ['case'],
            'accessory': ['accessory']
        },
        'modules': {
            'productDetailOverlay': ['.pdp-configurator-info', '', true, false, true, true],
            'tablet': ['.configurator-container .product-selector.tablet .product-selector-block', '', true, false, true, true],
            'case': ['.configurator-container .product-selector.case .product-selector-block', '', true, false, true, true],
            'accessory': ['.configurator-container .accessory .product-selector-block', '', true, false, true, true]
        },
        'actions': {
            'productDetailOverlay': ['/direct/json/productdetails/hudlMediaData.jsp']
        },
        'defaultActions': {
            'productDetailOverlay': ['/direct/json/productdetails/hudlMediaData.jsp']
        }
    };

    init = function init() {
        productUpdater.subscribe(function (requestParams, requestName, onCompleteCallback) {
            var url = requestParams.actionurl || data.Utils.getAction(requestName, null),
                dataLayer = new data.DataLayer(),
                requestModule = {
                    modules: globalOptions.requests[requestName]
                };

            dataLayer.get(addQueryParam(url, 'dataBlockId', window.PDPCONFIGURATOR.dataBlockId), $.extend(requestParams, requestModule), null, null, requestName, null, null, onCompleteCallback);
        });
    };

    addQueryParam = function addQueryParam(url, key, val) {
        url = url + (url.indexOf('?') > -1 ? '&' : '?');
        url = url + key + '=' + val;
        return url;
    };

    common.init.push(function () {
        if ($('.pdp-configurator').length > 0) {

            if ($('.pdp-configurator').hasClass('BUILDKIT')) {
                globalOptions.actions.productDetailOverlay = ['/stubs/hudl2-variants.php'];
                globalOptions.defaultActions.productDetailOverlay = ['/stubs/hudl2-variants.php'];
            }

            data.Global.init(globalOptions);
            init();
        }
    });

    return {
        addQueryParam : addQueryParam
    };

});
/*global window, define*/
define('modules/pdp-configurator/configurator',[
    'domlib',
    'modules/breakpoint',
    'modules/pdp-configurator/product-updater',
    'modules/pdp-configurator/tablet-selector',
    'modules/pdp-configurator/case-selector',
    'modules/pdp-configurator/add-to-basket',
    'modules/pdp-configurator/inspiration-panel',
    'modules/pdp-configurator/observer',
    'modules/pdp-configurator/combinationsHelper',
    'modules/pdp-configurator/accessory-selector',
    'modules/pdp-configurator/upsell-selector',
    'modules/pdp-configurator/product-service',
    'modules/common'
], function ($, breakpoint, productUpdater, tabletSelector, caseSelector, addToBasketView, inspirationPanel, observer, combiner, accessorySelector, upsellSelector, productService) {
    'use strict';

    var init,
        loadInitialProduct,
        actionMap,
        actionMapMobile,
        openTabletContainer,
        tabletSelected,
        updateColourTheme,
        tabletColourUpdated,
        openCaseContainer,
        caseSelected,
        cancelSelection,
        changeTabletColour,
        caseColourUpdated,
        changeCaseColour,
        selectCaseCategory,
        addToBasket,
        upselllSelection,
        closeTabletContainer,
        closeCaseCategory,
        addCase,
        removeCase,
        reloadATBView,
        performAction,
        postInitMobile,
        tabletSelectedMobile,
        openCaseCategory,
        removeCaseMobile,
        openAccessorySelector,
        addToBasketAccessory,
        closeAccessorySelector,
        inspirationSelected,
        inspirationSelectPre,
        accessoryColourUpdated,
        changeAccessoryColour,
        cancelSelectionProduct,
        getProductData,
        updateProductColour,
        viewBasket,
        data = {};

    init = function init() {

        actionMap = {
            'tablet-selector,change-product': changeTabletColour,
            'tablet-selector,product-selected': tabletSelected,
            'tablet-selector,colour-selected': tabletColourUpdated,
            'tablet-selector,product-cancel': cancelSelection,
            'tablet-selector,close': cancelSelectionProduct,
            'tablet-selector,add-case': openCaseCategory,

            'case-selector,change-colour': changeCaseColour,
            'case-selector,change-category': openCaseCategory,
            'case-selector,colour-selected': caseColourUpdated,
            'case-selector,product-selected': caseSelected,
            'case-selector,product-cancel': cancelSelectionProduct,
            'case-selector,case-category-close': closeCaseCategory,
            'case-selector,select-category': selectCaseCategory,
            'case-selector,no-case': removeCase,
            'case-selector,remove-case': removeCase,

            'add-to-basket,add-case': openCaseCategory,
            'add-to-basket,update-tablet': openTabletContainer,
            'add-to-basket,add-to-basket': addToBasket,

            'accessory-selector,change-product': changeAccessoryColour,
            'accessory-selector,add-to-basket': addToBasketAccessory,
            'accessory-selector,colour-selected': accessoryColourUpdated,
            'accessory-selector,close': closeAccessorySelector,

            'inspiration-panel,inspiration-selected': inspirationSelected,

            'upsell-selector,upsell-selected': upselllSelection,
            'upsell-selector,open-accessory-selector': openAccessorySelector,
            'upsell-selector,view-basket': viewBasket
        };

        actionMapMobile = {
            'tablet-selector,product-selected': tabletSelectedMobile,
            'configurator,post-init': postInitMobile,
            'case-selector,no-case': removeCaseMobile
        };

        loadInitialProduct();
        inspirationPanel.init('.inspiration-panel');
        observer.subscribe(function () {
            performAction.apply(this, arguments);
        });

        performAction('configurator,post-init');

        $('.configurator-banner .accessories-banner .back-btn').on('click', closeAccessorySelector);

    };

    loadInitialProduct = function loadInitialProduct() {
        tabletSelector.init('.product-selector.tablet');
        upsellSelector.init('.category-selector.upsell');
        caseSelector.init('.product-selector.case');
        caseSelector.initCategory();
        addToBasketView.init('.add-to-basket-container');
        combiner.init('.product-selector.tablet', '.product-selector.case', '.add-to-basket-container');
        updateColourTheme();
        $('.pdp-configurator .content-container > .loader').fadeOut('fast');
    };

    performAction = function performAction(message, event) {
        if (actionMapMobile[message] && breakpoint.mobile) {
            actionMapMobile[message](event);
        } else {
            if (actionMap[message]) {
                actionMap[message](event);
            }
        }
    };

    viewBasket = function viewBasket() {
        window.location.href = '/direct/basket-details/basket-details.page';
    };

    addCase = function addCase() {
        caseSelector.addCase();
        reloadATBView();
    };

    removeCase = function removeCase(event) {
        if (event) {
            event.preventDefault();
        }

        caseSelector.removeCase();
        closeCaseCategory();
        reloadATBView();
        addToBasketView.showDetails();
        tabletSelector.showSummary();
        caseSelector.hide();
        caseSelector.animateCategories();
    };

    tabletSelected = function tabletSelected() {
        data.originalTabletSku = tabletSelector.getSelectedSKU();
        data.originalTabletColour = tabletSelector.getSelectedColourName();
        reloadATBView();
        closeTabletContainer();
    };

    openTabletContainer = function openTabletContainer() {
        addToBasketView.hideDetails();
        tabletSelector.show();
        caseSelector.hide();
    };

    closeTabletContainer = function closeTabletContainer() {
        tabletSelector.showSummary();
        caseSelector.showSummary();
        addToBasketView.showDetails();
    };

    changeTabletColour = function changeTabletColour() {
        data.originalTabletSku = tabletSelector.getSelectedSKU();
        data.originalTabletColour = tabletSelector.getSelectedColourName();

        if (breakpoint.mobile) {
            $('.product-selector.tablet .colour-menu').addClass('open');
        } else {
            openTabletContainer();
        }
    };

    tabletColourUpdated = function tabletColourUpdated(event) {
        updateProductColour(getProductData($(event.currentTarget)), 'tablet', function () {
            tabletSelector.show();
        });
    };

    caseColourUpdated = function caseColourUpdated(event) {
        updateProductColour(getProductData($(event.currentTarget)), 'case', function () {
            caseSelector.show();
        });
    };

    openCaseContainer = function openCaseContainer() {
        addToBasketView.hideDetails();
        caseSelector.show();
        tabletSelector.hide();
    };

    openCaseCategory = function openCaseCategory(event) {
        if (event && $(event.currentTarget).hasClass('add-case')) {
            $('.category-selector.case-category').addClass('has-close-all');
        }

        if (event && ($('.product-selector.case').hasClass('background') || $('.product-selector.case').hasClass('closed'))) {
            caseSelector.animateCategories();
        }

        addToBasketView.hideDetails();
        caseSelector.showCategories();
        caseSelector.show();
        tabletSelector.hide();
    };

    closeCaseCategory = function closeCaseCategory(event) {
        if (event && $('.category-selector.case-category').hasClass('has-close-all')) {
            $('.category-selector.case-category').removeClass('has-close-all');
            cancelSelection();
        }
        caseSelector.hideCategories();
    };

    selectCaseCategory = function selectCaseCategory(event) {
        event.preventDefault();
        closeCaseCategory();
        productUpdater.update(getProductData($(event.currentTarget)), 'case', function (initProduct) {
            initProduct.done(function () {
                openCaseContainer();
                caseSelector.init('.product-selector.case');
                $('.category-selector.case-category').removeClass('has-close-all');
            });
        });
    };

    changeCaseColour = function changeCaseColour() {
        data.originalCaseSku = caseSelector.getSelectedSKU();
        data.originalCaseColour = caseSelector.getSelectedColourName();

        if (breakpoint.mobile) {
            $('.product-selector.case .colour-menu').addClass('open');
        } else {
            openCaseContainer();
        }
    };

    caseSelected = function caseSelected() {
        data.originalCaseSku = caseSelector.getSelectedSKU();
        data.originalCaseColour = caseSelector.getSelectedColourName();
        caseSelector.showSummary();
        tabletSelector.showSummary();
        addToBasketView.showDetails();
        addCase();
    };

    updateColourTheme = function updateColourTheme() {
        var hasCase = caseSelector.hasCase(),
            dominantColor;

        if (hasCase) {
            dominantColor = caseSelector.getContrastColour() || caseSelector.getSelectedColour();
        } else {
            dominantColor = tabletSelector.getContrastColour() || tabletSelector.getSelectedColour();
        }
        $('.colour-aware').css({
            'backgroundColor': dominantColor
        });
        addToBasketView.updateColor(dominantColor, hasCase);
        tabletSelector.updateColour();
        caseSelector.updateColour();
    };

    cancelSelection = function cancelSelection() {
        caseSelector.showSummary();
        tabletSelector.showSummary();
        addToBasketView.showDetails();
    };

    cancelSelectionProduct = function cancelSelectionProduct(event) {
        var $productSelector = $(event.currentTarget).closest('.product-selector'),
            isTablet = $productSelector.hasClass('tablet'),
            colourName = isTablet ? data.originalTabletColour : data.originalCaseColour,
            $colourMenu = $productSelector.find('.colour-menu'),
            $colourItem = $colourMenu.find('a[data-name="colour"][data-value="' + colourName + '"]');

        if (colourName && colourName.length > 0) {
            updateProductColour(getProductData($colourItem), isTablet ? 'tablet' : 'case', cancelSelection);
        } else {
            cancelSelection();
        }
    };

    addToBasket = function addToBasket(event) {
        var $this = $(event.currentTarget),
            action = $this.data('formaction'),
            hasCaseLoaded = false,
            hasTabletLoaded = false,
            isCaseOnlyAction = action === combiner.config.statusAction.addP2 || action === combiner.config.statusAction.alertP2,
            isTabletOnlyAction = action === combiner.config.statusAction.addP1 || action === combiner.config.statusAction.alertP1,
            isAlertAction = action === combiner.config.statusAction.alertP1 || action === combiner.config.statusAction.alertP2 || action === combiner.config.statusAction.alertP1P2,
            upsellMsgTpl = combiner.getUpsellMsgTpl(combiner.config.data().upsellMsgTpl.add),
            cb = function cb(d) {
                var hasBothLoaded = hasCaseLoaded && hasTabletLoaded;
                addToBasketView.setAnalytics(d);
                addToBasketView.setBasketCount();
                if (isCaseOnlyAction || isTabletOnlyAction || hasBothLoaded) {
                    openTabletContainer();
                    upsellSelector.toggleUpsellView(true);
                    upsellSelector.setUpsellMsg(upsellMsgTpl);

                    window.setTimeout(function () {
                        $this.removeClass('loading');
                    }, 750);
                }
            };

        if (!$this.hasClass('loading')) {
            $this.addClass('loading');
            if (isAlertAction) {
                if (isCaseOnlyAction) {
                    caseSelector.registerForStockAlerts();
                } else if (isTabletOnlyAction) {
                    tabletSelector.registerForStockAlerts();
                } else {
                    caseSelector.registerForStockAlerts(true).always(function () {
                        tabletSelector.registerForStockAlerts();
                    });
                }
                $this.removeClass('loading');
            } else {
                if (isCaseOnlyAction) {
                    caseSelector.addToBasket().then(cb);
                } else if (isTabletOnlyAction) {
                    tabletSelector.addToBasket().then(cb);
                } else {
                    tabletSelector.addToBasket().then(function () {
                        hasTabletLoaded = true;
                        return this;
                    }).then(cb);
                    caseSelector.addToBasket().then(function () {
                        hasCaseLoaded = true;
                        return this;
                    }).then(cb);
                }
            }
        }
        return false;
    };

    addToBasketAccessory = function addToBasketAccessory(event) {
        event.preventDefault();
        var $this = $(event.currentTarget),
            $accessorySelector = accessorySelector.$parentContainer,
            action = $accessorySelector.find('.product-selector-inner').data('status'),
            isAlertAction = action === combiner.config.statusId.outOfStock;

        if (!$this.hasClass('loading')) {
            $this.addClass('loading');
            if (isAlertAction) {
                accessorySelector.registerForStockAlerts();
            } else {
                accessorySelector.addToBasket().then(function (d) {
                    upsellSelector.setUpsellMsg(accessorySelector.getUpsellMsgTpl());
                    $this.removeClass('loading');
                    addToBasketView.setAnalytics(d);
                    addToBasketView.setBasketCount();
                    return this;
                }).done(closeAccessorySelector);
            }
        }
    };

    upselllSelection = function upselllSelection() {

        if (!breakpoint.mobile) {
            closeTabletContainer();
        }
        upsellSelector.toggleUpsellView(false);
        loadInitialProduct();
        removeCase();
        reloadATBView();
    };

    reloadATBView = function reloadATBView() {
        updateColourTheme();
        combiner.setAll();
    };

    openAccessorySelector = function openAccessorySelector(event) {
        event.preventDefault();
        closeTabletContainer();
        $('.category-selector.accessory').removeClass('closed').addClass('open');
        $('.category-selector.accessory .product-selector').addClass('background').removeClass('open');
        addToBasketView.hideDetails();
        productUpdater.update(getProductData($(event.currentTarget)), 'accessory', function (initProduct) {
            initProduct.done(function () {
                accessorySelector.init(".category-selector.accessory .product-selector");
                $('.category-selector.accessory .product-selector').removeClass('background').addClass('open');
                if (breakpoint.mobile) {
                    $('.configurator-banner').addClass('is-accessory');
                }
            });
        });
    };

    postInitMobile = function postInitMobile() {
        openTabletContainer();
        $('.pdp-configurator').addClass('init-complete');
    };

    tabletSelectedMobile = function tabletSelectedMobile() {
        data.originalTabletSku = tabletSelector.getSelectedSKU();
        data.originalTabletColour = tabletSelector.getSelectedColourName();

        reloadATBView();

        if (caseSelector.hasCase()) {
            closeTabletContainer();
        } else {
            openCaseCategory();
        }
    };

    removeCaseMobile = function removeCaseMobile(event) {
        event.preventDefault();
        caseSelector.removeCase();
        closeCaseCategory();
        reloadATBView();
        caseSelector.showSummary();
        tabletSelector.showSummary();
        addToBasketView.showDetails();
        caseSelector.animateCategories();
    };

    changeAccessoryColour = function changeAccessoryColour() {
        $('.accessory .product-selector .colour-menu').addClass('open');
    };

    accessoryColourUpdated = function accessoryColourUpdated(event) {
        event.preventDefault();
        $('.accessory .product-selector .colour-menu').removeClass('open');
        productUpdater.update(getProductData($(event.currentTarget)), 'accessory', function (initProduct) {
            initProduct.done(function () {
                accessorySelector.init(".category-selector.accessory .product-selector");
            });
        });
    };

    closeAccessorySelector = function closeAccessorySelector() {
        $('.category-selector.accessory').removeClass('open').addClass('closed');
        upsellSelector.toggleUpsellView(true);
        if (breakpoint.mobile) {
            $('.configurator-banner').removeClass('is-accessory');
        }
    };

    inspirationSelectPre = function inspirationSelectPre() {
        $('html,body').animate({
            scrollTop: $('.configurator-banner').offset().top
        }, 'slow');
        $('.product-selector-block').css('position', 'relative').append('<div class="loader-both"></div>');
        caseSelector.showSummary().addClass('animating-both');
        tabletSelector.showSummary().addClass('animating-both');
        addToBasketView.showDetails();
        caseSelector.addCase();
        $('.category-selector.accessory').removeClass('open').addClass('closed');
        $('#productInfoOverlay').removeClass('is-info-shown');
        closeCaseCategory();
        upsellSelector.toggleUpsellView(false);
    };

    inspirationSelected = function inspirationSelected(event) {
        event.preventDefault();

        var $inspirationItem = $(event.currentTarget),
            $inspirationForms = $inspirationItem.closest('li').find('form'),
            hasTabletLoaded,
            hasCaseLoaded,
            cb;

        inspirationSelectPre();
        $inspirationForms.each(function () {
            var $form = $(this),
                aboutBlock = window.PDPCONFIGURATOR.aboutBlockMap[$form.find('.fav-product-id').val()],
                postData = {
                    actionurl: productService.addQueryParam($form.attr('action'), 'about', aboutBlock)
                };
            $form.serializeArray().map(function (x) {
                postData[x.name] = x.value;
            });

            productUpdater.update(postData, $form.hasClass('primary-product-form') ? 'tablet' : 'case', function (initProduct) {
                initProduct.then(function () {
                    if ($form.hasClass('primary-product-form')) {
                        hasTabletLoaded = true;
                    } else {
                        hasCaseLoaded = true;
                    }
                    return this;
                }).done(cb);
            });
        });

        cb = function cb() {
            $('.product-selector-block').css('position', 'relative').append('<div class="loader-both"></div>');
            if (hasCaseLoaded && hasTabletLoaded) {
                tabletSelector.init('.product-selector.tablet');
                caseSelector.init('.product-selector.case');
                addCase();
                $('.category-selector.case-category').removeClass('has-close-all');
                addToBasketView.showDetails();
                caseSelector.showSummary().removeClass('animating-both');
                tabletSelector.showSummary().removeClass('animating-both');
                $('.product-selector-block').find('.loader-both').remove();
            }
        };
    };

    /* Shared product query handler methods */

    updateProductColour = function updateProductColour(postData, id, cb) {
        $('.colour-menu').removeClass('open');
        productUpdater.update(postData, id, function (initProduct) {
            initProduct.done(cb).done(function () {
                switch (id) {
                case "tablet":
                    tabletSelector.init('.product-selector.tablet');
                    break;
                case "case":
                    caseSelector.init('.product-selector.case');
                    break;
                }
            });
        });
    };

    getProductData = function getProductData($selector) {
        var $selectorForm = $selector.closest('form'),
            postData = {
                actionurl: $selectorForm.attr('action'),
                sku: $selector.data('sku')
            };

        $selectorForm.serializeArray().map(function (x) {
            postData[x.name] = x.value;
        });

        if ($selector.data('name') && $selector.data('value')) {
            postData[$selector.data('name')] = $selector.data('value');
        }
        return postData;
    };


    return {
        init: init
    };
});
/*globals define*/
define('modules/pdp-configurator/common',[
    'domlib',
    'modules/common',
    'modules/pdp-configurator/configurator'
], function ($, common, configurator) {
    'use strict';
    var init = function init() {
        if ($('.pdp-configurator').length > 0) {
            configurator.init();
        }
    };

    common.init.push(init);
});
define('modules/pdp/BaseClass', [
  'domlib'
], function ($) {
  'use strict';

  // NOTE: The methods in this file are being deprecated in favour of a utils file that
  // a dev can require at the top of a module. The file is located at: modules/mvc/fn.js.
  // This file is a work in progress so if the method not been migrated, just use the method
  // in this file. - Dylan Aubrey (so24) - 27/09/16

  /**
   * The base class that the base model, view and controller inherit from.
   * @return {void}
   */
  function BaseClass() {}

  /**
   * A shorthand for checking if an variable is an array.
   * @param {[type]} mVar The variable to check.
   * @param {Boolean} hasLength Whether to check if the array has length
   * @return {Boolean} Whether the variable is an array.
   */
  BaseClass.prototype.isArray = function (mVar, hasLength) {
    if (mVar && Array.isArray(mVar)) {
      if (!hasLength) {
        return true;
      }

      if (hasLength && mVar.length > 0) {
        return true;
      }
    }

    return false;
  };

  /**
   * A shorthand for checking if a variable is an object.
   * @param {Mixed} mVar The variable to check.
   * @param {Boolean} hasProps Whether to check if the object has properties.
   * @return {Boolean} Whether the variable is an object.
   */
  BaseClass.prototype.isObject = function (mVar, hasProps) {
    if (mVar && typeof mVar === 'object' && !this.isArray(mVar)) {
      if (!hasProps) {
        return true;
      }

      if (hasProps && !$.isEmptyObject(mVar)) {
        return true;
      }
    }

    return false;
  };

  /**
   * A shorthand for creating a deep copy of an object or an array.
   * @param {Object|Array} mVar The variable to make a copy of.
   * @return {Object|Array} The copied object/array.
   */
  BaseClass.prototype.deepCopy = function (mVar) {
    var mCopy = null,
      iObjCount = 0;

    if (this.isArray(mVar, true)) {
      this.forLoop(mVar, function (i) {
        if (this.isObject(mVar[i], true)) {
          iObjCount += 1;
        }
      });

      if (iObjCount === 0) {
        mCopy = mVar.slice();
      } else if (iObjCount === mVar.length) {
        mCopy = $.map(mVar, function (obj) {
          return $.extend(true, {}, obj);
        });
      }
    } else if (this.isObject(mVar, true)) {
      mCopy = $.extend(true, {}, mVar);
    } else {
      mCopy = mVar;
    }

    return mCopy;
  };

  /**
   * A shorthand for merging to array and returning a new array of unique values.
   * @param {Array} arrayOne The first array to merge.
   * @param {Array} arrayTwo The second array to marge.
   * @return {Array} The merged array of unique index values.
   */
  BaseClass.prototype.mergeArraysUnique = function (arrayOne, arrayTwo) {
    var newArray = [],
      concatArray = [];

    if (!this.isArray(arrayOne) || !this.isArray(arrayTwo)) {
      return false;
    }

    concatArray = arrayOne.concat(arrayTwo);

    this.forLoop(concatArray, function (i) {
      if (newArray.indexOf(concatArray[i]) === -1) {
        newArray.push(concatArray[i]);
      }
    });

    return newArray;
  };

  /**
   * Merges two objects and returns the newly merged object based on the options passed in. The
   * properties of objTwo will overwrite those in objOne.
   * @param {Object} objOne The first object to merge.
   * @param {Object} objTwo The second object to merge.
   * @param {Object} options The configuration for the merge.
   * @return {Object} The newly merged object.
   */
  BaseClass.prototype.mergeObjects = function (objOne, objTwo, options) {
    var _this = this,
      _objOne = objOne,
      _options = options || {},
      newObj = {},
      isFalsy = undefined,
      loopObject = undefined,
      loopArray = undefined;

    isFalsy = function (value) {
      if (value === undefined
          || value === null
          || value === ''
          || (_this.isObject(value) && $.isEmptyObject(value))) {
        return true;
      }

      return false;
    };

    loopObject = function (object) {
      var newObject = {};

      _this.forInLoop(object, function (prop) {
        if (_this.isObject(object[prop])) {
          newObject[prop] = loopObject(object[prop]);
        } else if (_this.isArray(object[prop])) {
          newObject[prop] = loopArray(object[prop]);
        } else {
          newObject[prop] = object[prop];
        }
      });

      return newObject;
    };

    loopArray = function (array) {
      var newArray = [];

      _this.forLoop(array, function (i) {
        if (_this.isObject(array[i])) {
          newArray.push(loopObject(array[i]));
        } else if (_this.isArray(array[i])) {
          newArray.push(loopArray(array[i]));
        } else {
          newArray.push(array[i]);
        }
      });

      return newArray;
    };

    if (!_options.count) {
      _options.count = 1;
    } else {
      _options.count += 1;
    }

    newObj = _options.extend ? _objOne : {};

    if (this.isObject(_objOne) && this.isObject(objTwo)) {
      this.forInLoop(objTwo, function (propTwo) {
        if (!_objOne.hasOwnProperty(propTwo)) {
          if (_options.shallow) {
            newObj[propTwo] = objTwo[propTwo];
          } else if (this.isObject(objTwo[propTwo])) {
            newObj[propTwo] = loopObject(objTwo[propTwo]);
          } else if (this.isArray(objTwo[propTwo])) {
            newObj[propTwo] = loopArray(objTwo[propTwo]);
          } else {
            newObj[propTwo] = objTwo[propTwo];
          }
        }

        this.forInLoop(_objOne, function (propOne) {
          if (propOne === propTwo) {
            if (!isFalsy(objTwo[propTwo])) {
              if (_options.shallow) {
                newObj[propOne] = objTwo[propTwo];
              } else if (this.isObject(objTwo[propTwo])) {
                newObj[propOne] = loopObject(objTwo[propTwo]);
              } else if (this.isArray(objTwo[propTwo])) {
                newObj[propOne] = loopArray(objTwo[propTwo]);
              } else {
                newObj[propOne] = objTwo[propTwo];
              }
            }
          } else if (!objTwo.hasOwnProperty(propOne)) {
            if (_options.shallow) {
              newObj[propOne] = _objOne[propOne];
            } else if (this.isObject(_objOne[propOne])) {
              newObj[propOne] = loopObject(_objOne[propOne]);
            } else if (this.isArray(_objOne[propOne])) {
              newObj[propOne] = loopArray(_objOne[propOne]);
            } else {
              newObj[propOne] = _objOne[propOne];
            }
          }
        });
      });

      return newObj;
    }

    return undefined;
  };

  /**
   * A shorthand for doing a for loop on an array
   * @param {Array} array The array to loop.
   * @param {Function} callback The function to execute within the loop.
   * @param {Integer} index The optional starting array index.
   * @return {void}
   */
  BaseClass.prototype.forLoop = function (array, callback, index) {
    var i = index || 0,
      count = 0,
      output = null;

    if (!this.isArray(array, true)) {
      return undefined;
    }

    count = array.length;

    for (; i < count; i += 1) {
      output = callback.call(this, i);

      if (output !== undefined) {
        return output;
      }
    }

    return undefined;
  };

  /**
   * A shorthand for doing a for in loop on an object.
   * @param {Object} obj The object to loop.
   * @param {Function} callback The function to execute within the loop.
   * @return {void}
   */
  BaseClass.prototype.forInLoop = function (obj, callback) {
    var output = undefined,
      keys = Object.keys(obj);

    return this.forLoop(keys, function loopObjectKeys(i) {
      output = callback.call(this, keys[i]);

      if (output !== undefined) {
        return output;
      }
      return undefined;
    });
  };

  /**
   * A shorthand for creating, namespacing and firing an event.
   * @param {Object} oData The data to be added to the event on the oData property.
   * @param {Boolean} isNamespaced Whether to namespace the event.
   * @param {Boolean} isTriggered Whether to trigger the event within the method.
   * @return {Object} The event object.
   */
  BaseClass.prototype.setEvent = function (oData, isNamespaced, isTriggered) {
    var oEvent = $.Event(oData.sName);

    oEvent.oData = $.extend({}, oData);

    if (isNamespaced) {
      oEvent.namespace = oData.sNamespace;
    }

    if (isTriggered) {
      $(window).trigger(oEvent);
    }

    return oEvent;
  };

  /**
   * A shorthand for creating, namespacing and firing multiple events.
   * @param {Array} aData The data to be added to the events on the oData property.
   * @param {Boolean} isNamespaced Whether to namespace the event.
   * @param {Boolean} isTriggered Whether to trigger the event within the method.
   * @return {Object} The event object.
   */
  BaseClass.prototype.setEvents = function (aData, isNamespaced, isTriggered) {
    var aEvents = [],
      _isNamespaced = false,
      _isTriggered = false;

    if (this.isArray(aData, true)) {
      this.forLoop(aData, function (i) {
        _isNamespaced = isNamespaced || aData[i].isNamespaced || false;
        _isTriggered = isTriggered || aData[i].isTriggered || false;
        aEvents.push(this.setEvent(aData[i].oData, _isNamespaced, _isTriggered));
      });
    }

    return aEvents;
  };

  /**
   * A shorthand for generating a unique Id
   * @param {String} sPrefix An optional prefix to add to the id.
   * @param {Integer} iDigits The number of digets for the id to be.
   * @return {String|Integer} The unique id.
   */
  BaseClass.prototype.createUniqueId = function (sPrefix, iDigits) {
    var _sPrefix = sPrefix || '',
      iMultiplyBy = iDigits
          ? iDigits * 10
          : 1000000000;

    return _sPrefix + Math.floor(Math.random() * iMultiplyBy);
  };

  /**
   * Creates a hash code for a string that can be used to compare to strings.
   * @param {Mixed} value The value to be hashed
   * @return {Integer} The hash value.
   */
  BaseClass.prototype.hashCode = function (value) {
    var hash = 0,
      chr = null,
      str = '';

    if (Array.isArray(value) && value.length === 0) {
      return -1;
    }

    if (typeof value !== 'string') {
      if (value) {
        str = value.toString();
      }
    } else {
      str = value;
    }

    if (!str.length) {
      return hash;
    }

    this.forLoop(str, function (i) {
      chr = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + chr;
      hash |= 0;
    });

    return hash;
  };

  /**
   * Checks whether data being passed into view is correct.
   * @param {Object} data Data to be checked.
   * @return {Boolean} Whether the data is correct or not.
   */
  BaseClass.prototype.sanityCheckData = function (data) {
    var counters = {
        objects: 0,
        ids: 0
      },
      _data = data,
      flags = {
        objects: false,
        ids: false
      };

    if (typeof _data === 'string') {
      flags.ids = true;
    } else if (this.isObject(_data, true)
        && _data.hasOwnProperty('id')
        && typeof _data.id === 'string') {
      flags.objects = true;
      flags.ids = null;
    } else if (this.isArray(_data, true)) {
      this.forLoop(_data, function (i) {
        if (typeof _data[i] === 'string') {
          counters.ids += 1;
        } else if (this.isObject(_data[i], true)
            && _data[i].hasOwnProperty('id')
            && typeof _data[i].id === 'string') {
          counters.objects += 1;
        }
      });

      if (_data.length === counters.ids) {
        flags.ids = true;
      } else if (_data.length === counters.objects) {
        flags.objects = true;
        flags.ids = null;
      }
    }

    return flags;
  };

  /**
   * Triggers a callback to run on transitionend of a given element's transition. It includes
   * a fallback for browsers that do not support transitionend.
   * @param {Function} callback The function to run on transitionend.
   * @param {Object} options Configuration options such as the target and transition property.
   * @return {void}
   */
  BaseClass.prototype.triggerOnTransitionEnd = function (callback, options) {
    var _this = this,
      _options = options;

    if (!window.Modernizr.csstransitions) {
      callback.call(this);
      return;
    }

    if (typeof _options.target === 'string') {
      _options.target = $(_options.target)[0];
    }

    if (_options.target instanceof Element) {
      $(_options.target).on('transitionend', function ($event) {
        var sourceElement = $event.originalEvent.srcElement
            ? $event.originalEvent.srcElement
            : $event.originalEvent.target;

        if (sourceElement === _options.target
            && $event.originalEvent.propertyName === _options.propertyName) {
          callback.call(_this);
        }

        $(_options.target).off('transitionend');
      });
    }
  };

  /**
   * Gets target events from provided element and returns them.
   * @param {String|Object} target The target to get the events from.
   * @param {String} name The name of the event.
   * @param {String} namespace The namespace of the event.
   * @return {Array} The list of events.
   */
  BaseClass.prototype.getTargetEvents = function (target, name, namespace) {
    var targetElement = typeof target === 'string'
          ? $(target)[0]
          : target,
      _namespace = namespace || '',
      eventList = {},
      events = [];

    if (targetElement instanceof Element || targetElement.self === window) {
      eventList = $._data(targetElement, 'events');

      if (!this.isObject(eventList, true)) {
        return false;
      }

      if (!eventList.hasOwnProperty(name)) {
        return false;
      }

      this.forLoop(eventList[name], function loopEvents(i) {
        if (eventList[name][i].namespace === _namespace) {
          events.push(eventList[name][i]);
        }
      });

      if (events.length > 0) {
        return events;
      }
    }

    return false;
  };

  BaseClass.prototype.parseHtml = function (args) {
    var _args = args || {},
      tag = typeof _args.tag === 'string' ? _args.tag : 'div',
      html = '',
      elm = null;

    if (typeof _args.html !== 'string') {
      return null;
    }

    html = _args.trim ? _args.html.trim() : _args.html;
    elm = document.createElement(tag);
    elm.innerHTML = html;

    return elm.children;
  };

  return BaseClass;
});

define('modules/pdp/BaseViewController', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/BaseClass'
], function ($, fn, BaseClass) {
  'use strict';

  /**
   * The base class that the base view and controller inherit from.
   * @return {void}
   */
  function BaseViewController() {}

  fn.inherit(BaseViewController, BaseClass);

  BaseViewController.prototype._bindDestroyPanelRefs = function () {
    $(window).on(
      'destroyPanel.' + this.id,
      this._onDestroyPanel.bind(this)
    );
  };

  BaseViewController.prototype._unbindDestroyPanelRefs = function () {
    $(window).off('destroyPanel.' + this.id);
  };

  /**
   * When a panel is destroyed, we need to remove references to it held by other controllers.
   * @param {Object} oEvent The event object.
   * @return {void}
   */
  BaseViewController.prototype._onDestroyPanel = function (oEvent) {
    var oPanel = oEvent.oData.oView;

    if (this._activePanel[oPanel.sTag]
        && this._activePanel[oPanel.sTag].id === oEvent.oData.oView.id) {
      this._activePanel[oPanel.sTag] = null;
      this._unbindDestroyPanelRefs();
    }
  };

  /**
   * Renders a error lightbox with a generic message that can be overwriten in the args.
   * @param {Object} args The configurations for the lightbox.
   * @return {void}
   */
  BaseViewController.prototype.renderNotification = function (args) {
    var _args = args || {},
      classList = '',
      ERROR_MESSAGE = 'Oops! Something went wrong. Please try again.';

    if (typeof _args.classList === 'string') {
      classList += _args.classList;
    }

    this.renderOverlay({
      sTag: 'notification',
      sClassNames: classList,
      oStyles: {
        allDesktops: ['notification', 'fullScreen'],
        allDevices: ['notification', 'fullScreen']
      },
      sOverlayContent: _args.message || ERROR_MESSAGE,
      toDestroyOnClose: true,
      callback: _args.callback
    });
  };

  /**
   * Creates a tooltip and optionally renders and triggers it. This should be used on controllers
   *   and views, but not models (obviously).
   * @param {Object} oParamData The data and config to be passed to tooltip.
   * @return {Object} The tooltip view object.
   */
  BaseViewController.prototype.createTooltip = function (oParamData) {
    var _this = this;

    if (this._activePanel.tooltip
        && this._activePanel.tooltip.oElms.elTrigger === oParamData.elTrigger) {
      if (this._activePanel.tooltip.sTooltopMessage !== oParamData.sTooltopMessage) {
        this._activePanel.tooltip.updateContent(oParamData.sTooltopMessage);
      }

      return false;
    }

    /**
     * TooltipPanelView requires the BaseView, which requires the BaseClass so this needs to be
     * wrapped in a require otherwise requirejs gets into an infinite loop of requiring.
     */
    return require(['modules/pdp/views/TooltipPanelView'], function (TooltipPanelView) {
      var ERROR_MESSAGE = 'Oops! Something went wrong. Please try again.',
        sClassNames = '',
        toRender = oParamData.toRender || true,
        toOpen = oParamData.toOpen || true,
        oTooltip = {},
        tooltipMessage = oParamData.sTooltopMessage
            || (oParamData.sType === 'error' && ERROR_MESSAGE);

      if (oParamData.sType === 'error') {
        sClassNames = 'info-panel-tooltip-error';
      } else if (oParamData.sType === 'hover') {
        sClassNames = 'info-panel-tooltip-hover';
      }

      oTooltip = new TooltipPanelView({
        oStyles: _this.oTooltipStyles || {
          kiosk: ['tooltip-bottom'],
          allDesktops: ['tooltip-bottom'],
          allDevices: ['tooltip-bottom']
        },
        sTooltipType: oParamData.sType,
        sTooltopMessage: tooltipMessage,
        elTarget: oParamData.elTarget || $('body')[0],
        elTrigger: oParamData.elTrigger,
        oData: {
          sClassNames: sClassNames,
          aSubViews: [
            { render: tooltipMessage }
          ]
        },
        iSubViewCount: 1
      });

      if (toRender) {
        oTooltip.render();

        if (toOpen) {
          oTooltip.open();
          _this._activePanel.tooltip = oTooltip;

          if (oParamData.sType === 'error') {
            _this._bindDestroyPanelRefs();
          }
        }
      }

      return oTooltip;
    });
  };

  /**
   * Gets the data required to add to the overlay and calls the createOverlay method.
   * @param {Object} params The data required to get the overlay data and configure the overlay.
   * @param {Object} eventData The jQuery event object that triggered the overlay method.
   * @return {void}
   */
  BaseViewController.prototype.compileAndRenderOverlay = function (params, eventData) {
    var _this = this,
      _params = params,
      modelName = _params.modelName || $(eventData.currentTarget).data('mvc-model'),
      searchKey = _params.searchKey || $(eventData.currentTarget).data('mvc-key'),
      searchValue = _params.searchValue || $(eventData.currentTarget).data('mvc-value'),
      dataObject = null;

    if (!modelName) {
      if (this.oModel) {
        dataObject = this.oModel.get({
          sSearchKey: searchKey || 'id',
          mSearchValue: searchValue
        });

        if (this.isObject(dataObject, true)
            && dataObject.hasOwnProperty(_params.sProp)
            && dataObject[_params.sProp]) {
          _params.elTrigger = eventData.currentTarget;
          _params.sOverlayContent = _params.editContent
              ? _params.editContent(dataObject[_params.sProp])
              : dataObject[_params.sProp];
          this.renderOverlay(_params);
        }
      }
    } else {
      this.queryModel({
        sNamespace: modelName,
        sCommand: 'get',
        oQueryParams: {
          sSearchKey: searchKey || 'id',
          mSearchValue: searchValue
        }
      }).done(function (queryData) {
        if (_this.isObject(queryData, true)
            && queryData.hasOwnProperty(_params.sProp)
            && queryData[_params.sProp]) {
          _params.elTrigger = eventData.currentTarget;
          _params.sOverlayContent = _params.editContent
              ? _params.editContent(queryData[_params.sProp])
              : queryData[_params.sProp];
          _this.renderOverlay(_params);
        }
      });
    }
  };

  /**
   * Creates a overlay and optionally renders and triggers it. This should be used on controllers
   *   and views, but not models (obviously).
   * @param {Object} params The data and config to be passed to overlay.
   * @return {Object} The overlay group view object.
   */
  BaseViewController.prototype.renderOverlay = function (params) {
    var _this = this,
      activePanel = this._activePanel[params.sTag];

    if (activePanel) {
      if (activePanel.oElms.elTrigger === params.elTrigger || params.forceUpdateActive) {
        if (params.forceUpdateActive || (params.updateActive
            && activePanel.contentHash !== this.hashCode(params.sOverlayContent))) {
          activePanel.updateContent(params.sOverlayContent);

          if (params.sTitle) {
            activePanel.oElms.elTitle.innerHTML = params.sTitle;
            activePanel.oElms.elContentTitle.innerHTML = params.sTitle;
          }

          if (params.callback) {
            params.callback(activePanel.sSelector);
          }
        }

        return false;
      }
    }

    /**
     * Views require the BaseView, which requires the BaseClass so this needs to be
     * wrapped in a require otherwise requirejs gets into an infinite loop of requiring.
     */
    return require([
      'modules/pdp/views/OverlayPanelGroupView',
      'modules/pdp/views/OverlayPanelView'
    ], function (OverlayPanelGroupView, OverlayPanelView) {
      var toRender = params.toRender || true,
        toOpen = params.toOpen || true,
        toDestroyOnClose = params.toDestroyOnClose || false,
        _getPanelGroup = null,
        _createPanelGroup = null,
        _addPanel = null;

      _getPanelGroup = function (_params) {
        _this.setEvent({
          sName: 'getPanelGroup',
          tag: _params.sTag,
          callback: function (panelGroup) {
            if (!panelGroup) {
              _createPanelGroup(_params);
            } else {
              _addPanel(panelGroup, _params, {
                output: 'prepend',
                target: panelGroup.oElms.elWrapper,
                render: true
              });
            }
          }
        }, false, true);
      };

      _createPanelGroup = function (_params) {
        var panel = null,
          panelGroup = new OverlayPanelGroupView({
            oStyles: _params.oStyles || {
              kiosk: ['lightbox', 'fullScreen'],
              allDesktops: ['lightbox', 'fullScreen'],
              allDevices: ['lightbox', 'fullScreen']
            },
            sTag: _params.sTag || null,
            sViewName: _params.sTag
                ? 'OverlayPanelGroupView-' + _params.sTag
                : 'OverlayPanelGroupView',
            oData: {
              sClassNames: _params.sClassNames
            },
            elTarget: _params.elTarget || $('body')[0]
          });

        if (toDestroyOnClose) {
          panelGroup._panelGroupClosedHook = function (eventData) {
            this.destroy(eventData);
          };
          _this._bindDestroyPanelRefs();
        }

        panel = _addPanel(panelGroup, _params);

        if (toRender) {
          panelGroup.render();

          if (_params.callback) {
            _params.callback(panel.sSelector);
          }

          if (toOpen) {
            panel.open();
            _this._activePanel[_params.sTag] = panel;
          }
        }
      };

      _addPanel = function (panelGroup, _params, options) {
        var _options = options || {},
          panel = {};

        panel = panelGroup.createSubView({
          ViewClass: OverlayPanelView,
          mParamData: {
            sTag: _params.sTag || null,
            sViewName: _params.sTag
                ? 'OverlayPanelView-' + _params.sTag
                : 'OverlayPanelView',
            oStyles: _params.oStyles || {
              kiosk: ['lightbox', 'fullScreen'],
              allDesktops: ['lightbox', 'fullScreen'],
              allDevices: ['lightbox', 'fullScreen']
            },
            sOutput: _options.output,
            elTarget: _options.target,
            elTrigger: _params.elTrigger || null,
            sOverlayContent: _params.sOverlayContent || '',
            oData: {
              sTitle: _params.sTitle || null,
              sContentClasses: _params.sContentClasses,
              aSubViews: [
                { render: _params.sOverlayContent }
              ]
            },
            iSubViewCount: 1
          }
        });

        if (_options.render) {
          panel.render();

          if (_params.callback) {
            _params.callback(panel.sSelector);
          }

          if (toOpen) {
            panel.open();
            _this._activePanel[_params.sTag] = panel;
          }
        }

        return panel;
      };

      _getPanelGroup(params);
    });
  };

  /**
   * Method allows a view/controller to query a model without having scope of the model and
   * get the model to run a method and return the result back to the view/controller.
   * @param {Object} oParams The parameters to pass to the event and onto the model.
   * @return {Object} The deferred promise.
   */
  BaseViewController.prototype.queryModel = function (oParams) {
    var oDeferred = new $.Deferred();

    this.setEvent({
      sName: 'queryModel',
      sCommand: oParams.sCommand || null,
      sNamespace: oParams.sNamespace || null,
      oQueryParams: oParams.oQueryParams,
      oDeferred: oDeferred
    }, false, true);

    return oDeferred.promise();
  };

  return BaseViewController;
});

define('modules/pdp/controllers/BaseController', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/BaseViewController'
], function ($, fn, BaseViewController) {
  'use strict';

  /**
   *
   * @param {Array<Object>|Object} models
   * @param {Object} options
   * @return {void}
   */
  function BaseController(models, options) {
    var _options = options || {};

    this.type = 'controller';
    this.id = this.createUniqueId();
    this._activeView = null;
    this._activePanel = {};
    this._pendingActions = [];
    this._actionInViewport = [];
    fn.mergeObjects(this, _options, { extend: true });

    if (fn.isArray(models)) {
      this.models = {};

      fn.loopArray.call(this, models, function loopModels(i) {
        this.models[models[i].sNamespace] = models[i];
      });

      if (this.sNamespace !== 'inherit') {
        this.oModel = this.models[this.sNamespace];
      }
    } else {
      this.oModel = models || null;
    }

    if (typeof this._bindEvents === 'function') {
      this._bindEvents();
    }
  }

  fn.inherit(BaseController, BaseViewController);

  /**
   * Method creates a view and runs post render actions on the view. This method is used for when
   * a component is bieng rendered from the server and we still want to create a view and bind
   * events in the client.
   * @param {Object} oData The data required to create the view.
   * @return {void}
   */
  BaseController.prototype.createView = function (oData) {
    var _oData = oData,
      ClsView = this.views.classes[_oData.sViewName],
      oView = null;

    if (typeof ClsView !== 'function') {
      return false;
    }

    _oData.oModel = this.oModel;
    oView = new ClsView(_oData);

    this._storeView(oView);

    if (this.isArray(_oData.methods, true)) {
      _oData.oView = oView;

      this.forLoop(_oData.methods, function (i) {
        this[_oData.methods[i]](oData);
      });
    }

    return oView;
  };

  BaseController.prototype.destroyView = function (args) {
    var view = this._getStoredView(args.sViewName, args.getView);

    if (this.isObject(view, true)) {
      view.destroy();
      this._deleteStoredView(args.sViewName, args.getView);
    }
  };

  BaseController.prototype.postRenderHook = function (oData) {
    oData.oView.postRenderHook();
    this._storeView(oData.oView);

    if (this._bindEventsPostRender !== undefined) {
      this._bindEventsPostRender();
    }

    if (this._bindViewEvents !== undefined) {
      this._bindViewEvents(oData);
    }

    this._resolvePendingActions();
  };

  BaseController.prototype._storeView = function (view) {
    var i = 0;

    if (!this.hasOwnProperty('views')) {
      this.views = {};
    }

    if (!this.views.hasOwnProperty('objects')) {
      this.views.objects = {};
    }

    if (!this.views.objects.hasOwnProperty(view.sViewName)) {
      this.views.objects[view.sViewName] = [];
    }

    i = this.views.objects[view.sViewName].length - 1;

    for (; i >= 0; i -= 1) {
      if (view.sViewId === this.views.objects[view.sViewName][i].sViewId) {
        this.views.objects[view.sViewName].splice(i, 1);
      } else if (!document.getElementById(this.views.objects[view.sViewName][i].sViewId)) {
        this.views.objects[view.sViewName].splice(i, 1);
      }
    }

    this.views.objects[view.sViewName].push(view);
  };

  BaseController.prototype._resolvePendingActions = function () {
    var i = 0,
      resolved = false;

    if (this.isArray(this._pendingActions, true)) {
      i = this._pendingActions.length - 1;

      for (; i >= 0; i -= 1) {
        if (typeof this._pendingActions[i] === 'function') {
          resolved = this._pendingActions[i].call(this);

          if (resolved) {
            this._pendingActions.splice(i, 1);
          }
        }
      }
    }
  };

  BaseController.prototype._getDataFromModel = function (oData, _fnCallback) {
    var _this = this,
      oPromise = _this.oModel.promise({
        sSearchKey: oData.oGetParams.sSearchKey,
        mSearchValue: oData.oGetParams.mSearchValue,
        sPropKey: oData.oGetParams.sPropKey
      });

    oPromise.done(function (mPromiseData) {
      var oParams = {};

      if (_this.isArray(mPromiseData, true)
          || (!_this.isArray(mPromiseData, true) && mPromiseData)) {
        oParams.oData = oData;
        oParams.mPromiseData = mPromiseData;
        _fnCallback.call(_this, oParams);
      }
    });
  };

  BaseController.prototype.renderView = function (params) {
    var _this = this,
      _params = params,
      view = undefined;

    this._collateData(_params).done(function collateDataResponse(updatedParams) {
      var _updatedParams = updatedParams,
        toObserve = _params.oView === false,
        renderParams = toObserve ? { observe: true } : {};

      if (_updatedParams.toRefresh) {
        _updatedParams.noCollate = true;
        _this.refreshView(_updatedParams);
        return;
      }

      view = !_params.oView ? _this.createView(_updatedParams) : _params.oView;

      if (view) {
        view.render(renderParams);
      }
    });
  };

  BaseController.prototype.refreshView = function (params) {
    var _params = params,
      view = this._getStoredView(_params.sViewName, _params.getView);

    if (!view && this.isObject(_params.render, true)) {
      $.extend(_params, _params.render);
      delete _params.render;
      this.renderView(_params);
      return;
    }

    if (_params.noCollate) {
      view.refresh(_params);
      return;
    }

    this._collateData(_params).done(function collateDataResponse(updatedParams) {
      view.refresh(updatedParams);
    });
  };

  BaseController.prototype._collateData = function (params) {
    var _params = params,
      flags = {},
      modelData = null,
      deferred = $.Deferred();

    if (this._collateDataDependancies !== undefined) {
      flags = this.sanityCheckData(_params.mParamData.mvc[_params.sNamespace]);

      if (flags.ids && !flags.objects) {
        if (this.isObject(this.oModel, true)) {
          modelData = this.oModel.get({
            mSearchValue: _params.mParamData.mvc[this.sNamespace],
            noFetch: true
          });

          if (this.sanityCheckData(modelData).objects) {
            _params.mParamData.mvc[this.sNamespace] = modelData;
          }
        } else if (this.isObject(this.models, true)
            && this.isObject(this.models[_params.sNamespace])) {
          modelData = this.models[_params.sNamespace].get({
            mSearchValue: _params.mParamData.mvc[_params.sNamespace],
            noFetch: true
          });

          if (this.sanityCheckData(modelData).objects) {
            _params.mParamData.mvc[_params.sNamespace] = modelData;
          }
        }
      }
    }

    if ((this._collateDataDependancies !== undefined
          && this._collateDataConditional === undefined)
        || (this._collateDataDependancies !== undefined
          && this._collateDataConditional !== undefined
          && this._collateDataConditional(_params))) {
      _params.deferred = deferred;
      this._collateDataDependancies(_params);
    } else {
      deferred.resolve(_params);
    }

    return deferred.promise();
  };

  BaseController.prototype._getStoredView = function (name, method) {
    if (!this.isObject(this.views) || !this.isObject(this.views.objects)
        || !this.isArray(this.views.objects[name])) {
      return false;
    }

    return this.forLoop(this.views.objects[name], function loopViews(i) {
      if (method.call(this, this.views.objects[name][i])) {
        return this.views.objects[name][i];
      }
      return undefined;
    });
  };

  BaseController.prototype._deleteStoredView = function (name, method) {
    this.forLoop(this.views.objects[name], function loopViews(i) {
      if (method.call(this, this.views.objects[name][i])) {
        this.views.objects[name].splice(i, 1);
        return true;
      }
      return undefined;
    });
  };

  BaseController.prototype.fetchData = function (params) {
    var _params = params,
      callback = undefined;

    if (!_params.queryParams.searchValue
        || (Array.isArray(_params.queryParams.searchValue)
            && !_params.queryParams.searchValue.length)) {
      return;
    }

    callback = function fetchDataCallback(data) {
      if (_params.queryParams.doneCallback) {
        _params.queryParams.doneCallback.call(this, data);
      }
    };

    this.oModel.fetch({
      sSearchKey: _params.queryParams.searchKey || 'id',
      mSearchValue: _params.queryParams.searchValue,
      sModelMethod: _params.queryParams.modelMethod,
      createEndpointCallback: _params.queryParams.createEndpointCallback,
      doneCallback: callback.bind(this)
    });
  };


  /**
   *
   * @param {Function|Undefined} destroyRootView
   * @param {JQueryDeferred} deferred
   * @return {Function}
   */
  BaseController.prototype._setRejectDeferredMethod = function (destroyRootView, deferred) {
    /**
     *
     * @param {any} data optional
     * @return {void}
     */
    return function rejectDeferred(data) {
      if (typeof destroyRootView === 'function') {
        destroyRootView();
      }
      deferred.reject(data);
    };
  };


  /**
   *
   * @param {string} viewID
   * @param {JQueryDeferred} _deferred Used for unit tests
   * @return {void}
   */
  BaseController.prototype._checkInViewport = function (viewID, _deferred) {
    var checkInViewport = { name: 'checkInViewport' };

    checkInViewport.data = { _deferred: _deferred, scope: this, viewID: viewID };
    fn.createEvent(checkInViewport).fire();
  };


  /**
   *
   * @return {Array<Object>}
   */
  BaseController.prototype.getActionInViewport = function () {
    return this._actionInViewport;
  };


  /**
   *
   * @param {Object} args
   * @param {Element} args.element
   * @param {Object} args.callbackArgs
   * @return {this}
   */
  BaseController.prototype.setActionInViewport = function (args) {
    var _args = args || {};

    if (!(_args.element instanceof Element)
        || !fn.isObject(args.callbackArgs, { notEmpty: true })) {
      return this;
    }

    this._actionInViewport.push(args);
    return this;
  };


  return BaseController;
});

define('modules/pdp/controllers/FormHandlerController', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/controllers/BaseController'
], function ($, fn, BaseController) {
  'use strict';

  /**
   *
   * @param {Array<Object>|Object} models
   * @param {Object} options
   * @return {void}
   */
  function FormHandlerController(models, options) {
    this.sNamespace = 'formHandler';
    this.parent.parent.constructor.call(this, models, options);
  }

  fn.inherit(FormHandlerController, BaseController);
  return FormHandlerController;
});

define('modules/pdp/views/BaseView', [
  'domlib',
  'mustache',
  'modules/mvc/fn',
  'modules/pdp/BaseViewController'
], function ($, mustache, fn, BaseViewController) {
  'use strict';

  /**
   *
   * @param {Object} oConfig
   * @return {void}
   */
  function BaseView(oConfig) {
    // Used for queryModel done callback scoping.
    var _this = this;

    this.type = 'view';
    this.id = this.createUniqueId();

    if (this.sNamespace === 'inherit' && typeof oConfig.sNamespace === 'string') {
      this.sNamespace = oConfig.sNamespace;
      this.inherits = true;
    } else {
      this.inherits = false;
    }

    this.iSubViewCount = oConfig.iSubViewCount || (this.iSubViewCount || 0);

    this.hasData = false;
    this.hasIds = false;

    /**
     * Allows backwards compatibility for any views using the new way of passing data
     * that include views using the legacy way of passing data.
     */
    if (oConfig.mParamData && oConfig.mParamData.hasOwnProperty('mvc')) {
      this._hasDataObjects(oConfig.mParamData.mvc[this.sNamespace]);
      this.mParamData = oConfig.mParamData.mvc[this.sNamespace] || null;
    } else {
      this._hasDataObjects(oConfig.mParamData);
      this.mParamData = oConfig.mParamData || null;
    }

    this.oElms = {
      elWrapper: null,
      elTarget: oConfig.elTarget || null,
      elTrigger: oConfig.elTrigger || null
    };
    this.sKeyId = oConfig.sKeyId || oConfig.id || this.id;
    this.sViewId = this.sViewClass + '-' + this.sKeyId;
    this.sSelector = (oConfig.hasNoId || this.hasNoId)
        ? '.' + this.sViewClass
        : '#' + this.sViewId;
    this.sOutput = oConfig.sOutput || (this.sOutput || 'outer');

    if (this.isMVC) {
      this.sTemplate = $(this.sTemplate)[0].innerHTML;
    }

    this._activePanel = {};

    this.oData = {
      sViewId: this.sViewId,
      sViewClass: this.sViewClass,
      tag: this.sTag,
      sClassNames: this.sClassNames || '',
      mViewData: {},
      aSubViews: [],
      // NOTE: added below props to prepare for react integration.
      state: {},
      props: {},
      views: {},
      // ends...
      oEvent: this._setRenderedEvent(),
      addViewDataAttr: function () {
        window.oAppController.oPageController.views[_this.sViewId] = _this;

        return '<script>(function (id) {'
            + 'if (window.oAppController.oPageController.views[id]) {'
            + 'var _this = window.oAppController.oPageController.views[id],'
            + 'selector = "#" + _this.sViewId;'
            + '$(selector).data("mvc-self", _this);'
            + 'window.oAppController.oPageController.views[id] = null'
            + '}'
            + '})("' + _this.sViewId + '")</script>';
      }
    };

    if (oConfig.oData) {
      $.extend(true, this.oData, oConfig.oData);
    }

    /**
     * Adds style attributes to the view's wrapper DOM element.
     */
    if (!this.oStyles) {
      this.oStyles = {};
    }

    this._setStyleProps(oConfig.oStyles);

    /**
     * New flags object to be used for all view specific Boolean checks. Data specific
     * Boolean checks should be added to the data object being passed into the view and
     * not onto the flags object.
     * @type {Object}
     */
    this.flags = oConfig.flags || {};

    if (!this.flags.views) {
      this.flags.views = {};
    }

    if (!this.flags.data) {
      this.flags.data = {};
    }

    this.flags.data.objects = false;
    this.flags.data.ids = false;

    if (!this.flags.required) {
      this.flags.required = {};
    }

    this.flags.required.model = oConfig.modelRequired || true;

    /**
     * If the mParamData object has the property 'mvc', it means the view is not using the
     * legacy way of passing data between views.
     */
    if (oConfig.mParamData && oConfig.mParamData.hasOwnProperty('mvc')) {
      /**
       * New data object to allow access to new data in mustache templates.
       * @type {Object}
       */
      this.oData.mvc = oConfig.mParamData.mvc;
      this.flags.data = this.sanityCheckData(this.oData.mvc[this.sNamespace]);

      if (!this.oData.mvc.info) {
        this.oData.mvc.info = {};
      }

      if (!this.oData.mvc.custom) {
        this.oData.mvc.custom = {};
      }

      if (!this.oData.mvc.flags) {
        this.oData.mvc.flags = {};
      }
    }

    /**
     * If a view's model was not passed through from the parent view in the config,
     * run the query model method to get the view's model. Note: this is a bit messy because
     * it has to support legacy flow as well.
     */
    if (this.flags.required.model && !oConfig.oModel) {
      this.queryModel({
        sNamespace: this.sNamespace
      }).done(function (oQueryData) {
        _this.oModel = oQueryData;

        if ((_this.flags.data.ids && _this.flags.required.data !== false) || _this.hasIds) {
          _this._getData();
        }
      });
    } else {
      this.oModel = oConfig.oModel;

      if ((_this.flags.data.ids && _this.flags.required.data !== false) || _this.hasIds) {
        this._getData();
      }
    }

    if (this.flags.required.data !== false && this._bindEventsPreRender !== undefined) {
      this._bindEventsPreRender();
    }

    if (this.isObject(this.oData.mvc, true)) {
      this._compileData(this.oData.mvc);
    }
  }

  fn.inherit(BaseView, BaseViewController);

  /**
   * Takes styles added to a viewport group and adds them to each viewport.
   * @param {Object} oConfigStyles A object of styles per viewport group to be broken down into each
   *   viewport.
   * @return {void}
   */
  BaseView.prototype._setStyleProps = function (oConfigStyles) {
    var _oStyles = oConfigStyles
        ? $.extend(true, {}, this.oStyles, oConfigStyles)
        : this.oStyles;

    if (this.isObject(_oStyles, true)) {
      if (_oStyles.allDesktops) {
        _oStyles.desktop = this.mergeArraysUnique(_oStyles.desktop || [], _oStyles.allDesktops);
        _oStyles.largedesktop = this.mergeArraysUnique(
          _oStyles.largedesktop || [], _oStyles.allDesktops
        );
        _oStyles.allDesktops = null;
      }

      if (_oStyles.allDevices) {
        _oStyles.mobile = this.mergeArraysUnique(_oStyles.mobile || [], _oStyles.allDevices);
        _oStyles.vtablet = this.mergeArraysUnique(_oStyles.vtablet || [], _oStyles.allDevices);
        _oStyles.htablet = this.mergeArraysUnique(_oStyles.htablet || [], _oStyles.allDevices);
        _oStyles.allDevices = null;
      }

      this.oStyles = _oStyles;
      this._addStyleClasses();
    }
  };

  /**
   * Adds the style classes for each viewport to the view's outer DOM element suffixed with the
   * viewport they are applicable for.
   * @return {void}
   */
  BaseView.prototype._addStyleClasses = function () {
    if (this.oStyles) {
      this.forInLoop(this.oStyles, function (sProp) {
        if (this.isArray(this.oStyles[sProp], true)) {
          this.forLoop(this.oStyles[sProp], function (i) {
            this.oData.sClassNames += ' ' + this.oStyles[sProp][i] + '-' + sProp;
          });
        }
      });
    }
  };

  BaseView.prototype.createSubView = function (oParams) {
    var oSubView = new oParams.ViewClass(oParams.mParamData);

    this.oData.aSubViews.push(oSubView);
    this.iSubViewCount += 1;

    return oSubView;
  };

  BaseView.prototype._hasDataObjects = function (mData) {
    if ((this.isArray(mData, true) && this.isObject(mData[0], true))
        || this.isObject(mData, true)) {
      this.hasData = true;
      this.hasIds = null;
      return true;
    } else if ((this.isArray(mData, true)
          && typeof mData[0] === 'string' && mData[0].length > 0)
        || (typeof mData === 'string' && mData.length > 0)) {
      this.hasIds = true;
      return false;
    }

    return undefined;
  };

  /**
   * Gets data from a model attached to a view and add the data to the view's data object.
   * The method offers backward compatibility with new and legacy flows.
   * @return {void}
   */
  BaseView.prototype._getData = function () {
    var flags = {},
      isLegacy = this.oData.hasOwnProperty('mvc') === false,
      mSearchValue = isLegacy ? this.mParamData : this.oData.mvc[this.sNamespace],
      oModel = this.oModel.model || this.oModel,
      mOutput = oModel.get({
        sSearchKey: 'id',
        mSearchValue: mSearchValue,
        noFetch: true
      });

    flags = this.sanityCheckData(mOutput);

    if (flags.objects) {
      this.flags.data = flags;

      if (!isLegacy) {
        this.oData.mvc[this.sNamespace] = mOutput;
      }

      this.mParamData = mOutput;
    }
  };

  /**
   * Compiles a sub view and returns the instance of the sub view class.
   * @param {Object} params The sub view class and range value.
   * @return {Object} The initialised sub view.
   */
  BaseView.prototype._compileSubView = function (params) {
    var ClsSubView = params._class,
      _flags = params.flags || {},
      _dataFlag = _flags.data || {},
      _dataRequiredFlag = _dataFlag.required || false,
      SubviewNamespace = ClsSubView.sNamespace,
      doNamespacesMatch = false,
      toInherit = false,
      sParentNamespace = '',
      mvcData = params.mvcData ? params.mvcData : this.deepCopy(this.oData.mvc),
      _mvcData = null,
      sClass = '';

    /**
     * If the sub view class function does not have a namespace it is using the old way of
     * passing data and this method should not be used to initialise the sub view.
     */
    if (!SubviewNamespace) {
      return '';
    }

    if (SubviewNamespace === 'inherit') {
      if (params.namespace) {
        SubviewNamespace = params.namespace;
      } else {
        SubviewNamespace = this.sNamespace;
      }

      toInherit = true;
    }

    /**
     * If data property is passed into the method and that value is falsy or an empty array
     * when there is no data to render and we should not compile the view.
     */
    if (params.hasOwnProperty('data')
        && !params.force
        && (!params.data || (Array.isArray(params.data) && !params.data.length))) {
      return '';
    }

    if (params.index) {
      mvcData[this.sNamespace] = params.index;
    }

    doNamespacesMatch = SubviewNamespace === this.sNamespace;

    /**
     * If the sub view class and the current view object do not have the same namespace then
     * the data structure needs to be manipulated before being passed through.
     */
    if (!doNamespacesMatch) {
      if (!mvcData.hasOwnProperty(SubviewNamespace)) {
        mvcData[SubviewNamespace] = null;

        /**
         * If the current view data has the property of the child view's data, then add that
         * data to the newly created property, except when data has been passed into the method.
         */
        if (mvcData[this.sNamespace].hasOwnProperty(SubviewNamespace)) {
          mvcData[SubviewNamespace] = mvcData[this.sNamespace][SubviewNamespace];
          sParentNamespace = this.sNamespace;
        }
      }
    }

    /**
     * If data has been passed into the method, add it to the namespace property.
     */
    if (params.data) {
      mvcData[SubviewNamespace] = params.data;
    }

    /**
     * Now the data structure will be flat, i.e. the namespaces of 'products' and
     * 'sellers' will both be properties of the mvcData object.
     */

    /**
     * If an mIndex value was provided, it means the mvcData property that matches the
     * sub view's namespace must be an array. Therefore, take the index value(s) and
     * assign them to the property value.
     */
    if (typeof params.range === 'number') {
      _mvcData = mvcData[SubviewNamespace][params.range];
      mvcData[SubviewNamespace] = _mvcData;
    } else if (this.isArray(params.range, true)) {
      _mvcData = [];
      /**
       * If 99 is provided as the second array value, the method takes that as meaning
       * an array of two values has been provided, signifying a range. The range is from
       * the first index to the end of the array.
       */
      if (params.range.indexOf(-1) === 1) {
        this.forLoop(mvcData[SubviewNamespace], function (i) {
          _mvcData.push(mvcData[SubviewNamespace][i]);
        }, params.range[0]);
      } else {
        /**
         * Otherwise, the method will just retreive the values at the indexes provided.
         */
        this.forLoop(params.range, function (j) {
          _mvcData.push(mvcData[SubviewNamespace][params.range[j]]);
        });
      }

      mvcData[SubviewNamespace] = _mvcData;
    }

    /**
     * If the value of the sub view namespace's property is falsly or is an empty array,
     * and the ctlr flag is falsy, return an empty string.
     */
    if (_dataRequiredFlag !== false) {
      if (!params.ctlr
          && !params.force
          && (!mvcData[SubviewNamespace]
          || (this.isArray(mvcData[SubviewNamespace])
              && mvcData[SubviewNamespace].length === 0))) {
        return '';
      }
    }


    if (toInherit) {
      mvcData.inherit = mvcData[SubviewNamespace];
    } else {
      mvcData.inherit = null;
    }

    this.iSubViewCount += 1;

    if (typeof params.dataCallback === 'function') {
      mvcData = params.dataCallback(mvcData);
    }

    /**
     * If the controller flag is truthy, fire a trigger render so that the view's controller can
     * take over, get the data, create the view and then inject the markup into the placeholder.
     */
    if (params.ctlr) {
      sClass = sParentNamespace
          ? ClsSubView._name + '-' + mvcData[this.sNamespace].id + '-placeholder'
          : ClsSubView._name + '-placeholder';

      return this._triggerRender({
        sClass: sClass,
        sNamespace: SubviewNamespace,
        sTag: params.tag || ClsSubView.sTag,
        sViewName: ClsSubView._name,
        filterOptions: params.filterOptions,
        flags: params.flags,
        inherits: toInherit,
        oData: {
          sClassNames: params.className,
          state: params.state
        },
        mParamData: { mvc: mvcData },
        sTemplate: params.template,
        ctlr: params.ctlr
      });
    }

    /**
     * NOTE: this is a hack to get view refreshing working, we need to look at this going forward.
     */
    if (params.returnData) {
      return { mvc: mvcData };
    }

    return new ClsSubView({
      sNamespace: SubviewNamespace,
      sTag: params.tag,
      // Assign data to mvc object os sub view knows how to deal with it.
      mParamData: { mvc: mvcData },
      // If some namespace, pass model to sub view.
      oModel: doNamespacesMatch ? this.oModel : null,
      flags: params.flags,
      oData: {
        sClassNames: params.className,
        state: params.state
      },
      sTemplate: params.template
    });
  };

  BaseView.prototype._triggerRender = function (oParams) {
    var sUniqueId = this.createUniqueId(),
      sClass = oParams.sClass + '-' + sUniqueId,
      sSelector = '.' + sClass,
      oEvent = this.setEvent({
        sName: 'render',
        sNamespace: oParams.sNamespace,
        sTag: oParams.sTag,
        sViewName: oParams.sViewName,
        filterOptions: oParams.filterOptions,
        flags: oParams.flags,
        inherits: oParams.inherits,
        oData: oParams.oData,
        elTarget: sSelector,
        sOutput: oParams.sOutput || 'outer',
        mParamData: oParams.mParamData || null,
        sTemplate: oParams.sTemplate
      }, false, false),
      sScript = '<script>(function (sId) {'
          + '$(window).trigger('
          + 'window.oAppController.oEventStore[sId]'
          + ');'
          + 'window.oAppController.oEventStore[sId] = null;'
          + '})("' + sUniqueId + '")</script>';

    window.oAppController.oEventStore[sUniqueId] = oEvent;

    return { render: '<div class="' + sClass + '">' + sScript + '</div>' };
  };

  BaseView.prototype.render = function (params) {
    var _this = this,
      _params = params || {},
      sHtml = '',
      elTarget = _params.elTarget || this.oElms.elTarget,
      sOutput = _params.sOutput || this.sOutput,
      mParamData = _params.mParamData || this.mParamData,
      toAddSubViews = this._addSubViews !== undefined;

    if (this.isObject(_params.mParamData, true) && _params.mParamData.hasOwnProperty('mvc')) {
      mParamData.setData = true;
    }

    if (elTarget === 'self') {
      elTarget = $(this.sSelector);
    }

    /**
     * Set the rendered event to null so that if you are re-rendering a view, you do not have
     * to have all the post-render methods running if you don't require them.
     */
    if (_params.newEvent) {
      this.oData.oEvent = this._setRenderedEvent();
    }

    /**
     * If the property observe is passed into the render function with a value of true,
     * then we will check if the view has the necessary data objects to render and if not the
     * view will query its model and try and re-render. This is recursive.
     */
    if (_params.observe) {
      if (this.flags.data.ids && !this.flags.data.objects) {
        this._getData();

        if (this.flags.data.ids && !this.flags.data.objects) {
          this.oModel.observe({
            searchKey: 'id',
            searchValue: this.oData.mvc[this.sNamespace],
            action: 'add',
            once: true,
            callback: function (resp) {
              var flags = _this.sanityCheckData(resp.data.observe);

              if (flags.objects) {
                _this.flags.data = flags;
                _this.oData.mvc[_this.sNamespace] = resp.data.observe;
                _this.render();
              } else {
                _this.render({ observe: true });
              }
            }
          });

          return false;
        }
      }
    }

    this._setData(mParamData);

    if (toAddSubViews) {
      this._addSubViews(mParamData);
    }

    sHtml = mustache.render(this.sTemplate, this.oData);

    if (_params.sourceOutput === 'inner') {
      sHtml = $.parseHTML($.trim(sHtml), document, true)[0].innerHTML;
    }

    if (sOutput === 'none') {
      return false;
    }

    if (elTarget) {
      if (sOutput === 'outer') {
        $(elTarget).replaceWith(sHtml);
      } else if (sOutput === 'inner') {
        $(elTarget).html(sHtml);
      } else if (sOutput === 'append') {
        $(elTarget).append(sHtml);
      } else if (sOutput === 'prepend') {
        $(elTarget).prepend(sHtml);
      }
    }

    this.oData.oEvent = null;
    this.oData.addViewDataAttr = null;

    return sHtml;
  };

  BaseView.prototype._setData = function (params) {
    if (params) {
      if (this.isObject(params, true) && params.setData) {
        this.oData.mvc = params.mvc;
        this._compileData(this.oData.mvc);
      }

      this.oData.mViewData = params;
    }
  };

  BaseView.prototype._compileData = function (data) {
    if (this._setProps) {
      this.mergeObjects(this.oData.props, this._setProps(data), { extend: true, shallow: true });
    }

    if (this._setStates) {
      this.mergeObjects(this.oData.state, this._setStates(data), { extend: true, shallow: true });
    }
  };

  BaseView.prototype._setRenderedEvent = function (isNamespaced) {
    var bNamespace = isNamespaced === true,
      sUniqueId = this.createUniqueId(),
      oEvent = this.setEvent({
        sName: 'rendered',
        sNamespace: this.sNamespace,
        sTag: this.sTag,
        sViewName: this.sViewName,
        oView: this,
        inherits: this.inherits
      }, bNamespace, false),
      sScript = '<script>(function (sId) {'
          + '$(window).trigger('
          + 'window.oAppController.oEventStore[sId]'
          + ');'
          + 'window.oAppController.oEventStore[sId] = null;'
          + '})("' + sUniqueId + '")</script>';

    window.oAppController.oEventStore[sUniqueId] = oEvent;

    return sScript;
  };

  BaseView.prototype.postRenderHook = function () {
    this._cacheDomElms();

    if (this._addAttributes !== undefined) {
      this._addAttributes();
    }

    if (this._bindEvents !== undefined) {
      this._bindEvents();
    }

    if (this._initDependancies !== undefined) {
      this._initDependancies();
    }
  };

  BaseView.prototype._cacheDomElms = function () {
    var $elWrapper = $(this.sSelector);

    if ($elWrapper.length) {
      this.oElms.elWrapper = $elWrapper.get(0);
    }
  };

  BaseView.prototype._hasStyle = function (sSearchValue, sViewport) {
    var bOutput = false;

    if (this.isArray(this.oStyles[sViewport], true)) {
      this.forLoop(this.oStyles[sViewport], function (i) {
        if (this.oStyles[sViewport][i] === sSearchValue) {
          bOutput = true;
        }
      });
    }

    return bOutput;
  };

  BaseView.prototype._setRefreshPoint = function () {
    if (!this.isArray(this.oData.mvc.refreshPoints)) {
      this.oData.mvc.refreshPoints = [];
    }

    this.oData.mvc.refreshPoints.push({
      viewId: this.sViewId,
      viewName: this.sViewName,
      namespace: this.inherits ? 'inherit' : this.sNamespace,
      tag: this.sTag
    });
  };

  /**
   * Wrapper function for binding an event handler that will also trigger an event to check
   * the events already bound to the target and remove any stale events.
   * @param {Object} params The configuration for the method.
   * @return {void}
   */
  BaseView.prototype.bindEvent = function (params) {
    var eventName = params.namespace
        ? params.name + '.' + params.namespace
        : params.name,
      events = undefined;

    /**
     * Loops through the list of events and checks if the selector in the data property is
     * in the DOM. If not, it removes the event from the window.
     * @param {Array} eventList List of events.
     * @return {void}
     */
    function removeStaleEvents(eventList) {
      var j = 0;

      if (!eventList || (Array.isArray(eventList) && !eventList.length)) {
        return;
      }

      j = eventList.length - 1;

      for (; j >= 0; j -= 1) {
        if (eventList[j].data.selector && $(eventList[j].data.selector).length === 0) {
          eventList.splice(j, 1);
        }
      }
    }

    events = this.getTargetEvents(params.target, params.name, params.namespace);

    if (!events) {
      $(params.target).on(
        eventName,
        { selector: '#' + this.sViewId },
        params.method.bind(this)
      );
    }

    if (params.runCleanup !== false) {
      setTimeout(function () {
        removeStaleEvents(events);
      }, 500);
    }
  };

  BaseView.prototype.destroy = function () {
    $(this.sSelector).remove();
  };

  return BaseView;
});

define('modules/pdp/views/AddRemoveServiceView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView'
], function ($, fn, BaseView) {
  'use strict';

  /**
   * Service add/remove view constructor sets view's core data and calls parent constructor.
   * @param {Object} oConfig The configuration to populate the view's dynamic properties.
   * @return {void}
   */
  function AddRemoveServiceView(oConfig) {
    this.sViewName = 'AddRemoveServiceView';
    this.sNamespace = 'formHandler';
    this.sTag = 'services';
    this.sViewClass = 'check-box-wrapper';
    this.sTemplate = $('#service-check-box-template')[0].innerHTML;
    this.parent.constructor.call(this, oConfig);
  }

  fn.inherit(AddRemoveServiceView, BaseView);

  AddRemoveServiceView._name = 'AddRemoveServiceView';
  AddRemoveServiceView.sNamespace = 'formHandler';
  AddRemoveServiceView.sTag = 'services';

  AddRemoveServiceView.prototype._cacheDomElms = function () {
    var $selector = $(this.sSelector);

    this.parent._cacheDomElms.call(this);
    this.oElms.elCheckbox = $selector.find('input[type="checkbox"]')[0];
    this.oElms.elFakeCheckbox = $selector.find('.check-box')[0];
  };

  return AddRemoveServiceView;
});

define('modules/pdp/controllers/AddRemoveServiceController', [
  'modules/mvc/fn',
  'modules/pdp/controllers/FormHandlerController',
  'modules/pdp/views/AddRemoveServiceView',
  'modules/tesco.analytics'
], function (fn, FormHandlerController, AddRemoveServiceView, analytics) {
  'use strict';

  /**
   * Add/remove service controller constructor sets controller's core data and calls parent
   * constructor.
   * @param {Object} oModel The services model.
   * @param {Object} oView The services view.
   * @return {void}
   */
  function AddRemoveServiceController(oModel, oView) {
    this.sTag = 'services';
    this.views = {
      classes: {
        AddRemoveServiceView: AddRemoveServiceView
      }
    };
    this.parent.constructor.call(this, oModel, oView);
  }

  fn.inherit(AddRemoveServiceController, FormHandlerController);

  AddRemoveServiceController.prototype._bindViewEvents = function (oData) {
    $(oData.oView.oElms.elCheckbox).on(
      'change',
      { oView: oData.oView },
      this._onToggleService.bind(this)
    );
  };

  AddRemoveServiceController.prototype._onToggleService = function (oEvent) {
    var oView = oEvent.data.oView;

    this._activeView = oView;
    this.oModel.send({
      oPromise: {
        sSearchKey: $(oEvent.currentTarget).data('mvc-key'),
        mSearchValue: $(oEvent.currentTarget).data('mvc-value')
      },
      fnDoneCallback: this._onToggleServiceSuccess.bind(this),
      fnFailCallback: this._onToggleServiceFailure.bind(this)
    });
  };

  AddRemoveServiceController.prototype._onToggleServiceSuccess = function (mRespData, oSendParams) {
    if (mRespData.hasOwnProperty('success')) {
      this.setEvents([
        { oData: { sName: 'toggleServiceSuccess', oRespData: mRespData } },
        { oData: { sName: 'reloadBasketFlyoutBadge', oRespData: mRespData } }
      ], false, true);

      this.oModel.remove({
        sSearchKey: 'id',
        mSearchValue: oSendParams.mSearchValue
      });

      if (mRespData.success.data) {
        this.setEvent({
          sName: 'dataFetched',
          mfetchedData: mRespData.success.data
        }, false, true);
      }

      if (this._activePanel.tooltip) {
        this._activePanel.tooltip.close();
      }

      // Short term code to reload basket summary on add/remove service
      if ($(this._activeView.oElms.elWrapper).closest('.basket-overlay__services').length > 0) {
        this._reloadBasketSummary();
      }
      this._analyticsTracking(mRespData.success.analytics, mRespData.success.data.services);
    } else {
      this.setEvent({
        sName: 'toggleServiceFailure',
        oRespData: mRespData
      }, false, true);

      if ($(this._activeView.oElms.elCheckbox).is(':checked')) {
        $(this._activeView.oElms.elCheckbox).attr('checked', false);
      } else {
        $(this._activeView.oElms.elCheckbox).attr('checked', true);
      }

      this.createTooltip({
        sTooltopMessage: mRespData.failure.message,
        elTrigger: this._activeView.oElms.elFakeCheckbox,
        sType: 'error'
      });
    }
  };

  AddRemoveServiceController.prototype._onToggleServiceFailure = function (sErrorMsg, oJqXHR) {
    this.setEvent({
      sName: 'toggleServiceFailure',
      oRespData: oJqXHR
    }, false, true);

    if ($(this._activeView.oElms.elCheckbox).is(':checked')) {
      $(this._activeView.oElms.elCheckbox).attr('checked', false);
    } else {
      $(this._activeView.oElms.elCheckbox).attr('checked', true);
    }

    this.createTooltip({
      sTooltopMessage: sErrorMsg,
      elTrigger: this._activeView.oElms.elFakeCheckbox,
      sType: 'error'
    });
  };

  AddRemoveServiceController.prototype._reloadBasketSummary = function () {
    $.ajax({
      url: '/direct/blocks/catalog/productdetailv2/basketOverlaySummary.jsp'
    }).done(function (mData) {
      $('.basket-overlay__summary')[0].outerHTML = mData;
    });
  };

  AddRemoveServiceController.prototype._analyticsTracking = function (
    analyticsResponse, mRespDataServices
  ) {
    var _oWebAnalytics = null,
      analyticProps = [],
      extendedVars = null,
      servicePrice = null,
      i = 0,
      isChecked = null,
      message = null,
      events = null,
      scProp = null,
      checkedElement = null,
      serviceSkuId = null,
      sellerId = null,
      serviceSellerId = null,
      analyticEventsProps = [],
      extendedAnalyticsProps = null;

    for (i = 0; i < mRespDataServices.length; i += 1) {
      checkedElement = this._activeView.oElms.elCheckbox.id.split('-')[1];
      if (mRespDataServices[i].id === checkedElement) {
        servicePrice = mRespDataServices[i].price;
        serviceSkuId = mRespDataServices[i].skuId;
        serviceSellerId = mRespDataServices[i].sellerId;
        break;
      }
    }

    isChecked = $(this._activeView.oElms.elCheckbox).is(':checked');
    message = isChecked ? 'add to basket' : 'remove from basket';
    scProp = isChecked ? 'scAdd' : 'scRemove';
    events = isChecked ? ';;;event26=1|event27=' : ';;;event28=1|event29=';
    sellerId = (serviceSellerId === '1000001' || serviceSellerId === undefined) ? '1000001' : serviceSellerId;
    analyticProps = [{
      eVar45: message,
      prop19: message,
      eVar59: 'basket overlay - ' + message,
      prop42: 'basket overlay - ' + message,
      eVar25: sellerId,
      products: ';' + serviceSkuId + events + servicePrice + ';eVar25=' + sellerId
    }];
    if (isChecked) {
      analyticEventsProps = [{
        scAdd: scProp,
        event26: '1',
        event27: servicePrice
      }];
    } else {
      analyticEventsProps = [{
        scRemove: scProp,
        event28: '1',
        event29: servicePrice,
        events: 'scRemove,event28,event29'
      }];
    }

    extendedAnalyticsProps = $.extend(true, [{}], analyticProps, analyticEventsProps);

    _oWebAnalytics = new analytics.WebMetrics();
    extendedVars = $.extend(true, [{}], analyticsResponse, extendedAnalyticsProps);
    _oWebAnalytics.submit(extendedVars);
  };
  return AddRemoveServiceController;
});


define('text!templates/views/addToBasketView.html',[],function () { return '<form id="{{sViewId}}" class="{{sViewClass}} {{sClassNames}} float-wrapper\r\n    {{props.state}}-state {{^state.hideQuantity}}with-quantity{{/state.hideQuantity}}" novalidate>\r\n  {{^state.hideQuantity}}\r\n    <label class="screen-reader">Quantity:</label>\r\n    <input type="text" class="text-box product-quantity pull-left-all" maxlength="2" pattern="[0-9]*"\r\n        data-max-qty="{{props.maxQuantity}}" value="1" data-mvc-key="quantity"\r\n        {{#state.disabled}}disabled="disabled"{{/state.disabled}}/>\r\n  {{/state.hideQuantity}}\r\n  <div class="add-to-basket-button-wrapper">\r\n    <button id="{{props.formHandlerId}}" type="button" data-mvc-key="id" class="button primary"\r\n        data-mvc-value="{{props.formHandlerId}}" {{#state.disabled}}disabled="disabled"{{/state.disabled}}>\r\n      <span>{{props.label}}</span>\r\n    </button>\r\n  </div>\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</form>\r\n';});

define('modules/pdp/views/AddToBasketView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','text!templates/views/addToBasketView.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    template = require('text!templates/views/addToBasketView.html');

  /**
   * Add to basket view constructor sets view's core data and calls parent constructor.
   * @param {Object} oConfig The configuration to populate the view's dynamic properties.
   * @return {void}
   */
  function AddToBasketView(oConfig) {
    this.sViewName = 'AddToBasketView';
    this.sNamespace = 'formHandler';
    this.sTag = 'addToBasket';
    this.sViewClass = 'add-to-basket-view';
    this.sTemplate = template;
    this.parent.constructor.call(this, oConfig);
  }

  fn.inherit(AddToBasketView, BaseView);
  AddToBasketView._name = 'AddToBasketView';
  AddToBasketView.sNamespace = 'formHandler';
  AddToBasketView.sTag = 'addToBasket';

  AddToBasketView.prototype._setProps = function (data) {
    var hasSellerData = false,
      hasFormhanlderData = false;

    if (this.isObject(data.sellers, true)) {
      hasSellerData = true;
    }

    if (this.isObject(data.formHandler, true)) {
      hasFormhanlderData = true;
    }


    return {
      state: hasSellerData && (data.sellers.buyBoxMessage || ''),
      maxQuantity: hasSellerData && (data.sellers.maxQuantity || ''),
      formHandlerId: hasFormhanlderData && (data.formHandler.id || ''),
      label: hasSellerData && (data.sellers.buyButtonLabel || '')
    };
  };

  AddToBasketView.prototype._setStates = function (data) {
    var hasFlags = false,
      isDigitalMedia = false;

    if (this.isObject(data.flags, true)) {
      hasFlags = true;
    }

    if (this.isObject(data.sku, true)) {
      if (data.sku.isDigitalSku && data.flags.isKiosk) {
        isDigitalMedia = true;
      }
    }

    return {
      disabled: hasFlags && (!!data.flags.disabled || !!data.flags.disableAddToBasket
        || isDigitalMedia),
      hideQuantity: hasFlags && !!data.flags.hideQuantity
    };
  };

  AddToBasketView.prototype.enable = function () {
    this.oData.mvc.flags.disabled = false;
    this.oElms.elSubmitBtn.disabled = false;
    this.oElms.elQtyInput.disabled = false;
  };

  AddToBasketView.prototype.disable = function () {
    this.oData.mvc.flags.disabled = true;
    this.oElms.elSubmitBtn.disabled = true;
    this.oElms.elQtyInput.disabled = true;
  };

  AddToBasketView.prototype._cacheDomElms = function () {
    var $wrapper = null;

    this.parent._cacheDomElms.call(this);
    $wrapper = $(this.oElms.elWrapper);
    this.oElms.elSubmitBtn = $wrapper.find('button')[0];

    if (!this.oData.mvc.flags.hideQuantity) {
      this.oElms.elQtyInput = $wrapper.find('input.product-quantity')[0];
    }
  };

  AddToBasketView.prototype.refresh = function (args) {
    var $node = $(this.parseHtml(
        { html: this.render({ mParamData: { mvc: args.data } }), trim: true }
      ));

    fn.refreshElement(this.oElms.elSubmitBtn, $node.find('button')[0]);

    if (this.oElms.elQtyInput) {
      fn.refreshElement(this.oElms.elQtyInput, $node.find('input.product-quantity')[0]);
    }
  };

  module.exports = AddToBasketView;
});

define('modules/pdp/controllers/AddToBasketController',['require','exports','module','modules/mvc/fn','modules/pdp/controllers/FormHandlerController','modules/pdp/views/AddToBasketView','modules/tesco.analytics','modules/chip-and-pin/kmf-io','modules/google-analytics/pdpTracking','modules/recommenders/common'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    FormHandlerController = require('modules/pdp/controllers/FormHandlerController'),
    AddToBasketView = require('modules/pdp/views/AddToBasketView'),
    analytics = require('modules/tesco.analytics'),
    kmfIO = require('modules/chip-and-pin/kmf-io'),
    googleEC = require('modules/google-analytics/pdpTracking'),
    recommenders = require('modules/recommenders/common');

  /**
   *
   * @param {Array<Object>} models
   * @param {Object} options
   * @return {void}
   */
  function AddToBasketController(models, options) {
    this.sTag = 'addToBasket';
    this.oTooltipStyles = {
      kiosk: ['tooltip-left'],
      allDesktops: ['tooltip-left'],
      allDevices: ['tooltip-bottom']
    };
    this.views = { classes: { AddToBasketView: AddToBasketView } };
    this.parent.constructor.call(this, models, options);
  }

  fn.inherit(AddToBasketController, FormHandlerController);
  AddToBasketController.modelNames = ['formHandler'];

  /**
   *
   * @param {Object} res
   * @return {void}
   */
  AddToBasketController.prototype._analyticsTracking = function (res) {
    var baseValue = '',
      customerOriginRRData = recommenders.richRelevanceOriginAnalyticsHandler(),
      flags = fn.getValue(this._activeView, 'oData', 'mvc', 'flags'),
      isPDP = this.pageGroup === 'productDetails',
      isPLP = this.pageGroup === 'listings',
      message = '',
      variantOne = '',
      variantTwo = '',
      v = [],
      webAnalytics = null;

    if (isPDP && !flags.inBasketOverlay) baseValue = 'pdp';
    if (isPDP && flags.inBasketOverlay) baseValue = 'basket overlay';
    if (isPLP && !flags.inBasketOverlay) baseValue = 'plp';
    if (isPLP && flags.inBasketOverlay) baseValue = 'basket overlay';

    if (isPDP && (flags.bundle)) variantOne = 'bundle';
    if (isPDP && flags.carousel) variantOne = 'carousel';
    if (isPDP && flags.grid) variantOne = 'grid';

    if (isPLP && this.pageType === 'Category') variantOne = 'catalogue';
    if (isPLP && this.pageType === 'Search') variantOne = 'search';

    if (isPDP && flags.outfitBuilder) variantTwo = 'outfit builder';
    if (isPDP && flags.shopTheRange) variantTwo = 'shop the range';
    if (isPDP && flags.fbt) variantTwo = 'fbt';
    if (isPDP && flags.linksave) variantTwo = 'linksave';
    if (isPDP && flags.accessories) variantTwo = 'accessories';
    if (isPDP && flags.completeTheLook) variantTwo = 'complete the look';

    message = baseValue;
    if (variantOne) message += ':' + variantOne;
    if (variantTwo) message += ':' + variantTwo;

    v = [{
      eVar45: 'add to basket',
      eVar59: message,
      eVar61: message,
      events: res[0].events + ',event32,event45',
      products: res[0].products && isPDP ? res[0].products + '|eVar61=' + message : res[0].products,
      prop19: 'add to basket',
      prop42: message
    }];

    if (customerOriginRRData !== null) {
      v[0].linkTrackVars = 'prop39,eVar49,eVar61';
      v[0].list3 = customerOriginRRData;
      v[0].prop39 = 'rich releance ' + baseValue + ' clickthrough';
      v[0].eVar49 = 'prop39';
      v[0].eVar61 = baseValue + ' - rich relevance';
    }

    webAnalytics = new analytics.WebMetrics();
    webAnalytics.submit($.extend(true, [{}], res, v));
  };

  /**
   *
   * @return {void}
   */
  AddToBasketController.prototype._bindLegacyAddToBasket = function () {
    var _this = this;

    $(this.pageEventDelegator).on('click', 'input[type=submit].add-to-basket', function (e) {
      e.preventDefault();
      _this._onLegacyAddToBasket(e);
    });
  };

  /**
   *
   * @param {Object} args
   * @return {void}
   */
  AddToBasketController.prototype._bindViewEvents = function (args) {
    var view = args.oView,
      elms = view.oElms;

    $(elms.elWrapper).on('click', 'button', { view: view }, this._onAddToBasket.bind(this));

    if (!elms.elQtyInput) {
      return;
    }

    $(elms.elWrapper)
      .on('change', 'input.product-quantity', { view: view }, this._onQuantityChange.bind(this))
      .on('keyup', 'input.product-quantity', { view: view }, this._onQuantityKeyup.bind(this))
      .on('keypress', 'input.product-quantity', { view: view }, this._handleQuantityKeypress.bind(this));
  };

  /**
   *
   * @return {JQueryObject}
   */
  AddToBasketController.prototype._getLegacyFormSelector = function () {
    var selector = '';

    switch (this.pageGroup) {
      case 'listings':
        selector = '[id^=addToBasket_PLP_]';
        break;
      case 'productDetails':
        selector = '#addBundleTobasket';
        break;
      // no default
    }

    return selector;
  };

  /**
   *
   * @param {JQueryEvent} e
   * @return {void}
   */
  AddToBasketController.prototype._handleQuantityKeypress = function (e) {
    if (e.which === 13) {
      e.preventDefault();
      this._onQuantityChange(e);
      this._onAddToBasket(e);
      $(e.currentTarget).blur();
    }
  };

  /**
   *
   * @return {void}
   */
  AddToBasketController.prototype._initDependancies = function () {
    this._bindLegacyAddToBasket();
  };

  /**
   *
   * @param {JQueryEvent} e
   * @return {void}
   */
  AddToBasketController.prototype._onAddToBasket = function (e) {
    var formHdlrModel = this.models.formHandler,
      view = e.data.view;

    $(view.oElms.elSubmitBtn).addClass('submitting');
    this._activeView = view;

    formHdlrModel.send({
      oPromise: {
        sSearchKey: $(view.oElms.elSubmitBtn).data('mvc-key'),
        mSearchValue: $(view.oElms.elSubmitBtn).data('mvc-value')
      },
      fnDoneCallback: this._onAddToBasketSuccess.bind(this),
      fnFailCallback: this._onAddToBasketFailure.bind(this)
    });
  };

  /**
   *
   * @param {string} err
   * @param {Object} jqXHR
   * @return {void}
   */
  AddToBasketController.prototype._onAddToBasketFailure = function (err, jqXHR) {
    var elms = this._activeView.oElms;

    fn.createEvent({
      name: 'addToBasketFailure',
      propName: 'oData',
      data: jqXHR
    }).fire();

    this.createTooltip({
      sTooltopMessage: err,
      elTrigger: elms.elQtyInput || elms.elSubmitBtn,
      sType: 'error'
    });

    $(elms.elSubmitBtn).removeClass('submitting');
  };

  /**
   *
   * @param {Object} res
   * @return {void}
   */
  AddToBasketController.prototype._onAddToBasketSuccess = function (res) {
    var mvcData = this._activeView.oData.mvc,
      elms = this._activeView.oElms,
      quanityAdded = 0,
      basketQuantity = 0;

    if (res.hasOwnProperty('success')) {
      fn.createEvent({
        name: 'addToBasketSuccess',
        namespace: this._activeView.id,
        propName: 'oData',
        data: res
      }).fire();

      quanityAdded = res.success.data.itemsAdded.quantity;
      basketQuantity = res.success.data.basket.total;
      kmfIO.enableBasketButton(basketQuantity);

      if (res.success.data) {
        fn.createEvent({
          name: 'dataFetched',
          propName: 'oData',
          data: { mfetchedData: res.success.data }
        }).fire();
      }

      googleEC.setAnalytics(res.success.data.itemsAdded.items, 'addToBasket');
      this._analyticsTracking(res.success.analytics);

      this.renderOverlay({
        sTag: 'basketOverlay',
        sClassNames: 'basket-overlay with-header',
        oStyles: {
          allDesktops: ['lightbox', 'fullScreen'],
          allDevices: ['slideIn-left', 'fullScreen']
        },
        sTitle: quanityAdded > 1
            ? '<strong>' + quanityAdded + ' items</strong> added to basket'
            : '<strong>' + quanityAdded + ' item</strong> added to basket',
        sOverlayContent: res.success.html,
        toDestroyOnClose: true,
        forceUpdateActive: true,
        callback: function overlayRenderedCallback() {
          var skuData = mvcData.sku,
            e = null;

          if (fn.getValue(skuData, 'personalisation', 'isPersonalised')) {
            e = $.Event('resetPersonalisation');
            e.oData = { skuId: skuData.id };
            $(window).trigger(e);
          }
        }
      });
    } else {
      fn.createEvent({
        name: 'addToBasketFailure',
        propName: 'oData',
        data: res
      }).fire();

      this.createTooltip({
        sTooltopMessage: res.failure.message,
        elTrigger: elms.elQtyInput || elms.elSubmitBtn,
        sType: 'error'
      });
    }

    $(elms.elSubmitBtn).removeClass('submitting');
  };

  /**
   *
   * @private
   * @param {JQueryEvent} e
   * @return {void}
   */
  AddToBasketController.prototype._onLegacyAddToBasket = function (e) {
    var $submit = $(e.currentTarget);
    var selector = this._getLegacyFormSelector();
    var $form = $submit.closest(selector);
    if (!$form.length) return;
    var formHdlrModel = this.models.formHandler;
    var data = formHdlrModel.serialize($form[0]);
    formHdlrModel.add(data);

    var view = {
      id: fn.createId(),
      oData: { mvc: { flags: {} } },
      oElms: { elSubmitBtn: $submit[0] }
    };

    if (selector === '#addBundleTobasket') {
      view.oData.mvc.flags.linksave = true;
      view.oData.mvc.flags.bundle = true;
    } else {
      view.oData.mvc.flags.listingTile = true;
    }

    $submit
      .data('mvc-key', 'id')
      .data('mvc-value', data.name);

    e.data = { view: view };
    this._onAddToBasket(e);
  };

  /**
   *
   * @param {JQueryEvent} e
   * @return {void}
   */
  AddToBasketController.prototype._onQuantityChange = function (e) {
    var formHdlrModel = this.models.formHandler,
      view = e.data.view,
      elms = view.oElms;

    formHdlrModel.update({
      sSearchKey: $(elms.elSubmitBtn).data('mvc-key'),
      mSearchValue: $(elms.elSubmitBtn).data('mvc-value'),
      sUpdateKey: 'oData',
      mUpdateValue: null,
      sUpdatePropKey: $(elms.elQtyInput).data('mvc-key'),
      mUpdatePropValue: elms.elQtyInput.value
    });
  };

  /**
   *
   * @param {JQueryEvent} e
   * @return {void}
   */
  AddToBasketController.prototype._onQuantityKeyup = function (e) {
    var MESSAGE = 'Please enter a valid number.',
      view = e.data.view,
      regex = /^([0-9]+)$|^$/,
      value = view.oElms.elQtyInput.value;

    if (!value.match(regex)) {
      this.createTooltip({
        sTooltopMessage: MESSAGE,
        elTrigger: view.oElms.elQtyInput,
        sType: 'error'
      });
    } else if (this._activePanel.tooltip) {
      this._activePanel.tooltip.close();
    }
  };

  module.exports = AddToBasketController;
});

define('modules/pdp/data-stores/Asset', [], function () {
  'use strict';

  /**
   * Structured data object for assets, i.e. BCC block content.
   * @param {Object} oData Data to be added into the structured data object.
   * @return {void}
   */
  function Asset(oData) {
    this.id = oData.id || null;
    this.lookupNameDefault = oData.lookupNameDefault || null;
    this.folder = oData.folder || null;
    this.text = oData.text || null;
    this.lookupName = oData.lookupName || null;
    this.type = oData.type || null;
    this.name = oData.name || null;
  }

  return Asset;
});

define('modules/pdp/StoreModelMap', [], function () {
  'use strict';

  /**
   * Map used in base model to look up namespaced data models.
   * @return {void}
   */
  function StoreModelMap() {
    this.aMap = [
      'products',
      'sku',
      'sellers',
      'promotions',
      'deliveryOptions',
      'services',
      'formHandler',
      'storeStockCheck',
      'stores'
    ];
  }

  StoreModelMap.prototype.isStoreMapped = function (sProp) {
    var i = 0,
      iCount = this.aMap.length;

    for (; i < iCount; i += 1) {
      if (this.aMap[i] === sProp) {
        return true;
      }
    }

    return false;
  };

  return StoreModelMap;
});

define('modules/pdp/DataEndpointMap', [], function () {
  'use strict';

  var DataEndpointMap = function DataEndpointMap() {
    this.oMap = {
      bucketgroup: {
        action: {
          fetch: {
            href: 'content/catalog/bucketGroup/'
          }
        }
      },
      products: {
        action: {
          fetch: {
            href: 'content/catalog/product/'
          }
        },
        type: 'product'
      },
      sku: {
        action: {
          buybox: {
            href: '/direct/blocks/catalog/productdetailv2/buyBoxDetails.jsp?'
                + 'skuID=%SKUID%&productID=%PRODUCTID%&asyncBuyBoxPassed=true'
                + '&onAsync=true%SCHOOLID%%SCHOOLNAME%%SLOGOREF%'
          },
          fetch: {
            href: 'content/catalog/sku/'
          },
          ndo: {
            href: '/direct/blocks/catalog/productdetailv2/JSON/fetchDOForListing.jsp?skuId='
          },
          price: {
            href: 'price/sku/'
          },
          relationships: {
            href: 'content/relationships/{relationship}/'
          },
          competitors: {
            href: 'competitor/price/sku/'
          }
        },
        type: 'skus'
      },
      inventorysku: {
        action: {
          fetch: {
            href: 'inventory/sku/'
          }
        }
      },
      inventoryproduct: {
        action: {
          fetch: {
            href: 'inventory/product/'
          }
        }
      },
      marketingsku: {
        action: {
          fetch: {
            href: 'marketing/sku/'
          }
        }
      },
      promotions: {
        action: {
          fetch: {
            href: 'content/catalog/promotion/'
          }
        }
      },
      categories: {
        action: {
          fetch: {
            href: 'content/catalog/category/'
          }
        }
      },
      stores: {
        action: {
          fetch: {
            href: 'storeSearch?lat={LAT}&lon={LON}&num=30&formats=Extra,Superstore'
          },
          storeDetails: {
            href: 'content/stores/store/'
          }
        }
      },
      inventorystore: {
        action: {
          fetch: {
            href: 'availability?listingIds={LISTINGID}&locationIds={STOREIDS}'
          }
        }
      },
      links: {
        action: {
          relationships: { href: 'content/relationships/{relationship}/' }
        }
      }
    };
  };

  DataEndpointMap.prototype.getEndpoint = function (sProp) {
    var sSanitisedProp = '';

    if (sProp) {
      sSanitisedProp = sProp.toLowerCase();
      if (this.oMap.hasOwnProperty(sSanitisedProp)) {
        return this.oMap[sSanitisedProp];
      }
    }
    return null;
  };

  return DataEndpointMap;
});

define('modules/pdp/HyperMediaModelMap', [], function () {
  'use strict';

  var HyperMediaModelMap = function HyperMediaModelMap() {
    this.oHyperMediaModelMap = [
      {
        type: 'sku',
        model: 'sku'
      }, {
        type: 'product',
        model: 'products'
      },
      {
        type: 'booksSku',
        model: 'sku'
      },
      {
        type: 'directSku',
        model: 'sku'
      }, {
        type: 'booksSku',
        model: 'sku'
      }
    ];
  };

  HyperMediaModelMap.prototype.getModelFromHyperMediaType = function (sType) {
    var i = 0;

    for (i = 0; i < this.oHyperMediaModelMap.length; i += 1) {
      if (this.oHyperMediaModelMap[i].type === sType) {
        return this.oHyperMediaModelMap[i].model;
      }
    }
    return null;
  };

  return HyperMediaModelMap;
});

define('modules/pdp/api/RESTAPIRequest', [
  'domlib',
  'modules/pdp/HyperMediaModelMap'
], function ($, HyperMediaModelMap) {
  'use strict';

  var RESTAPIRequest = null,
    fnSuccessCallbackDefault = null,
    fnErrorCallbackDefault = null,
    checkIfHyperMediaLinkIsRequired = null;

  fnSuccessCallbackDefault = function (oData, defer) {
    if (defer) {
      defer.resolve(oData);
    }
  };

  fnErrorCallbackDefault = function (args) {
    if (args.deferred) {
      args.deferred.reject({
        params: args.params,
        errorResp: args.errorResp
      });
    }
  };

  checkIfHyperMediaLinkIsRequired = function (oData, oParams) {
    var bResult = false;

    if (!oParams.processHyperMediaType) {
      bResult = oData.href || false;
    } else {
      bResult = (oData.type === oParams.processHyperMediaType) && (oData.href !== undefined);
    }
    return bResult;
  };

  RESTAPIRequest = function (opts) {
    var defOpts = {
      sBaseURL: '/direct/rest/'
    };

    this.options = $.extend({}, defOpts, opts);
    this.aData = [];
    this.oHyperMediaModelMap = new HyperMediaModelMap();
  };

  /* jslint unparam: true*/
  RESTAPIRequest.prototype.send = function send(sEndOfRoute, oParams) {
    var numOfTries = 0,
      maxRetries = 3,
      sUrl = '',
      _this = this,
      params = {};

    if ((oParams && typeof oParams === 'object')) {
      params = oParams;
    }

    if (sEndOfRoute.indexOf('/rest/content/') >= 0) {
      sUrl = sEndOfRoute;
    } else if (sEndOfRoute.indexOf('/direct/blocks/') >= 0) {
      sUrl = sEndOfRoute;
    } else {
      sUrl = this.options.sBaseURL + sEndOfRoute;
    }

    $.ajax({
      method: 'GET',
      timeout: 15000,
      url: sUrl,
      beforeSend: function () {
        var args = arguments;

        args[1].url = sUrl;
      },
      contentType: params.contentType || 'application/json; charset=utf-8',
      dataType: 'json',
      success: function success(oResponseData, sStatusText, oXHR) {
        var parsedResponse = {},
          bCallDefaultSuccessCallback = true,
          aPromises = null;

        try {
          if (oXHR.responseText === undefined
              || oXHR.responseText === ''
              || oXHR.responseText === '{}') {
            throw new SyntaxError('RESTAPIRequest - No data from the server ' + sEndOfRoute);
          }
          parsedResponse = JSON.parse(oXHR.responseText);
        } catch (syntaxError) {
          if (params.fnErrorCallback) {
            params.fnErrorCallback({
              params: oParams,
              deferred: params.oDeferred,
              errorResp: syntaxError
            });
          } else {
            fnErrorCallbackDefault({
              params: oParams,
              deferred: params.oDeferred,
              errorResp: syntaxError
            });
          }
          return;
        }
        if (params.processHyperMedia) {
          if (parsedResponse.links && Array.isArray(parsedResponse.links)) {
            bCallDefaultSuccessCallback = false;
          }
          params.processHyperMedia = false;
          aPromises = _this.processHyperMediaLinks(parsedResponse, params);
        }
        if (aPromises) {
          params.oDeferred.notify(parsedResponse);
          $.when.apply($, aPromises).done(function () {
            fnSuccessCallbackDefault(parsedResponse, params.oDeferred);
          });
        }
        if (params.fnSuccessCallback) {
          params.fnSuccessCallback.call(_this, parsedResponse, params);
        } else if (bCallDefaultSuccessCallback) {
          params.oDeferred.notify(parsedResponse);
          fnSuccessCallbackDefault(parsedResponse, params.oDeferred);
        }
      },
      error: function error(oXHR, sTextStatus) {
        if (sTextStatus === 'timeout') {
          numOfTries += 1;

          if (numOfTries <= maxRetries) {
            $.ajax(this);
            return;
          }
        }

        if (params.fnErrorCallback) {
          params.fnErrorCallback({ params: oParams, deferred: params.oDeferred, errorResp: oXHR });
        } else {
          fnErrorCallbackDefault({ params: oParams, deferred: params.oDeferred, errorResp: oXHR });
        }
      }
    });
  };

  RESTAPIRequest.prototype.fetchData = function fetchData(
    aAPIHrefs, fnSuccessCallback, fnErrorCallback, oParams
  ) {
    var _this = this,
      oDeferred = {},
      params = {},
      fnFetch = function fnFetch(sHref) {
        oDeferred = new $.Deferred();
        params = {
          oDeferred: oDeferred,
          fnSuccessCallback: fnSuccessCallback,
          fnErrorCallback: fnErrorCallback
        };
        if (oParams) {
          params.processHyperMedia = oParams.processHyperMedia || false;
          params.processHyperMediaType = oParams.processHyperMediaType || false;
          params.addHyperMediaLookupToModel = oParams.addHyperMediaLookupToModel || true;
          params.parentDefer = oParams.oDeferred;
          params.sEndpoint = sHref;
        }
        _this.send(sHref, params);
        return oDeferred.promise();
      };

    return $.map(aAPIHrefs, fnFetch, _this);
  };
  RESTAPIRequest.prototype.processHyperMediaLinks = function (oResponseData, oParams) {
    var i = 0,
      aAdditionalRequests = [];

    if (oResponseData.links && Array.isArray(oResponseData.links)) {
      for (i = 0; i < oResponseData.links.length; i += 1) {
        if (checkIfHyperMediaLinkIsRequired(oResponseData.links[i], oParams)) {
          aAdditionalRequests.push({
            id: oResponseData.links[i].id,
            type: oResponseData.links[i].type,
            href: oResponseData.links[i].href
          });
        }
      }
    }
    if (aAdditionalRequests.length) {
      return this.fetchSubsequentHyperMediaLinks(aAdditionalRequests, oParams);
    }
    return null;
  };

  RESTAPIRequest.prototype.fetchSubsequentHyperMediaLinks = function (aAdditionalRequests,
    oParams) {
    var i = 0,
      aHREF = [];

    if (aAdditionalRequests.length) {
      for (i = 0; i < aAdditionalRequests.length; i += 1) {
        aHREF.push(aAdditionalRequests[i].href);
      }
      return this.fetchData(aHREF, this.hyperMediaSuccessHandler, null, oParams);
    }
    return null;
  };

  RESTAPIRequest.prototype.hyperMediaSuccessHandler = function (oData, oParams) {
    var oParsedData = oData,
      oSelfEntity = null;

    if (oParams.parentDefer) {
      oSelfEntity = this.getSelfEntityFromResponse(oParsedData);
      oParsedData.id = oSelfEntity.id;
      oParams.parentDefer.notify(oParsedData);
    }

    /*
    if (oParams.addHyperMediaLookupToModel) {
      this.hyperMediaProgressHandler(oData, oParams);
    }
    */

    oParams.oDeferred.resolve(oParsedData);
  };

  RESTAPIRequest.prototype.hyperMediaProgressHandler = function (oData) {
    var oEventDataAdd = new $.Event('addData'),
      sResponseModelType = '',
      sResponseHyperMediaType = '',
      oSelfHyperMediaEntity = this.getSelfEntityFromResponse(oData);

    if (oSelfHyperMediaEntity) {
      sResponseHyperMediaType = oSelfHyperMediaEntity.type;
      sResponseModelType = this.oHyperMediaModelMap.getModelFromHyperMediaType(
        sResponseHyperMediaType
      );

      oEventDataAdd.namespace = sResponseModelType;
      oEventDataAdd.oData = {
        mAddData: oData
      };
      $(window).trigger(oEventDataAdd);
    }
  };

  RESTAPIRequest.prototype.getSelfEntityFromResponse = function (oData) {
    var i = 0;

    if (oData.links) {
      if (Array.isArray(oData.links)) {
        for (i = 0; i < oData.links.length; i += 1) {
          if (oData.links[i].rel === 'self') {
            return oData.links[i];
          }
        }
      } else {
        return oData.links.self;
      }
    }
    return null;
  };

  return RESTAPIRequest;
});

define('modules/pdp/models/BaseModel', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/BaseClass',
  'modules/pdp/StoreModelMap',
  'modules/pdp/DataEndpointMap',
  'modules/pdp/api/RESTAPIRequest',
  'modules/pdp/HyperMediaModelMap'
], function (
  $,
  fn,
  BaseClass,
  StoreModelMap,
  DataEndpointMap,
  RESTAPIRequest,
  HyperMediaModelMap
) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function BaseModel(config) {
    this.type = 'model';
    this._aDataStores = [];
    this.observers = [];
    this.oStoreModelMap = new StoreModelMap();
    this.oDataEndpointMap = new DataEndpointMap();
    this.oHyperMediaModelMap = new HyperMediaModelMap();
    this.baseURL = fn.isObject(config) ? config.baseURL : '';
    this._bindEvents();
  }

  fn.inherit(BaseModel, BaseClass);

  BaseModel.prototype._bindEvents = function () {
    $(window).on(
      'dataRequest.' + this.sNamespace,
      this._onDataRequest.bind(this)
    );
  };

  BaseModel.prototype._onDataRequest = function (oEvent) {
    var _this = this,
      oData = oEvent.oData,
      oPromise = _this.promise({
        sSearchKey: oData.oGetParams.sSearchKey,
        mSearchValue: oData.oGetParams.mSearchValue,
        sPropKey: oData.oGetParams.sPropKey
      });

    oPromise.done(function (mDataStores) {
      _this.setEvent({
        sName: 'dataResponse',
        sNamespace: oEvent.sRespNamespace,
        mRespData: mDataStores
      }, true, true);
    });
  };

  BaseModel.prototype.promise = function (oParams) {
    var _oParams = oParams,
      oDeferred = new $.Deferred();

    _oParams.oDeferred = oDeferred;

    this.get(_oParams);

    return oDeferred.promise();
  };


  BaseModel.prototype.get = function (args) {
    var _args = args,
      wasArray = true,
      deferred = _args.oDeferred,
      fetch = !_args.noFetch,
      missingData = [],
      output = null,
      propKey = _args.sPropKey,
      searchKey = _args.sSearchKey || 'id',
      searchValue = _args.mSearchValue;

    if (!searchValue) {
      return null;
    }

    if (_args.originalValue !== undefined) {
      searchValue = _args.originalValue;
      delete _args.originalValue;
    }

    if (fn.isArray(searchValue)) {
      output = this._getMultiple({
        sSearchKey: searchKey,
        mSearchValue: searchValue,
        sPropKey: propKey
      });
    } else {
      output = this._getSingle({
        sSearchKey: searchKey,
        mSearchValue: searchValue,
        sPropKey: propKey
      });
    }

    if (!fn.isArray(output)) {
      wasArray = false;
      output = [output];
      searchValue = [searchValue];
    }

    if (!_args.fetched && fetch) {
      fn.loopArray.call(this, output, function loopOutput(i) {
        if (output[i] === undefined || output[i] === null
            || this._checkDataStores(output[i]).length) {
          missingData.push(searchValue[i]);
        }
      });

      if (missingData.length > 0 && missingData.length !== searchValue.length) {
        _args.originalValue = wasArray ? searchValue : searchValue[0];
        _args.mSearchValue = wasArray ? missingData : missingData[0];
      }

      if (missingData.length) {
        _args.fetched = true;
        this.fetch(_args);
        return null;
      }
    } else {
      fn.loopArray.call(this, output, function loopOutput(i) {
        if (output[i] === undefined || output[i] === null) {
          output.splice(i, 1);
        }
      }, { backward: true });
    }

    if (deferred) {
      deferred.resolve(fn.copy(wasArray ? output : output[0], { deep: true }));
      return null;
    }

    return fn.copy(wasArray ? output : output[0], { deep: true });
  };


  /**
   * Hook method designed to be superceded by derived classes that need to do
   * a custom check on data to decide whether to return the output or
   * initiate a fetch of the data from the server.
   *
   * @return {Array}
   */
  BaseModel.prototype._checkDataStores = function () {
    return [];
  };


  BaseModel.prototype._getMultiple = function (oParams) {
    var sSearchKey = oParams.sSearchKey,
      mSearchValue = oParams.mSearchValue,
      sPropKey = oParams.sPropKey,
      aOutput = [];

    this.forLoop(mSearchValue, function (i) {
      aOutput.push(this._getSingle({
        sSearchKey: sSearchKey,
        mSearchValue: mSearchValue[i],
        sPropKey: sPropKey
      }));
    });

    return aOutput;
  };

  BaseModel.prototype._getSingle = function (oParams) {
    var sSearchKey = oParams.sSearchKey,
      mSearchValue = oParams.mSearchValue,
      sPropKey = oParams.sPropKey,
      mOutput = null;

    return this.forLoop(this._aDataStores, function (i) {
      if (this.isArray(this._aDataStores[i][sSearchKey], true)) {
        mOutput = this.forLoop(this._aDataStores[i][sSearchKey], function (j) {
          if (this._aDataStores[i][sSearchKey][j] === mSearchValue) {
            return this._aDataStores[i];
          }

          return undefined;
        });
      } else if (this._aDataStores[i][sSearchKey] === mSearchValue) {
        mOutput = this._aDataStores[i];
      }

      if (mOutput && !sPropKey) {
        return mOutput;
      }

      if (mOutput && sPropKey) {
        return mOutput[sPropKey];
      }

      return undefined;
    });
  };

  BaseModel.prototype._onDataResponse = function (oEvent) {
    var oPromise = this.promise({
      sSearchKey: 'id',
      mSearchValue: oEvent.oData.mRespData
    });

    oPromise.done(function (mDataStores) {
      oEvent.data.oDeferred.resolve(mDataStores);
    });
  };

  /**
   *
   * @param {Object} args
   * @return {void}
   */
  BaseModel.prototype.send = function (args) {
    var ERROR_MESSAGE = 'Oops! Something went wrong. Please try again.',
      data = null,
      promise = this.promise({
        sSearchKey: args.oPromise.sSearchKey,
        mSearchValue: args.oPromise.mSearchValue
      });

    promise.done(function (oDataStore) {
      $.ajax({
        url: oDataStore.action,
        method: oDataStore.method,
        data: oDataStore.oData
      }).done(function (res) {
        data = typeof res === 'string' ? JSON.parse(res) : res;
        args.fnDoneCallback(data, args.oPromise);
      }).fail(function (oJqXHR) {
        args.fnFailCallback(ERROR_MESSAGE, oJqXHR, args.oPromise);
      });
    });
  };

  BaseModel.prototype.update = function (oParams) {
    var i = 0,
      aDataStores = this._aDataStores,
      iCount = aDataStores.length,
      sSearchKey = oParams.sSearchKey || 'id',
      mSearchValue = oParams.mSearchValue,
      sUpdateKey = oParams.sUpdateKey,
      mUpdateValue = oParams.mUpdateValue,
      sUpdatePropKey = oParams.sUpdatePropKey,
      mUpdatePropValue = oParams.mUpdatePropValue,
      mOutput = null,
      sRgxdPropKey = null,
      oDataStore = null,
      sObjRefProp = null;

    if (this.isObject(mUpdateValue) || this.isArray(mUpdateValue, true)) {
      mUpdateValue = this.deepCopy(mUpdateValue);
    }

    if (this.isObject(mUpdatePropValue) || this.isArray(mUpdatePropValue, true)) {
      mUpdatePropValue = this.deepCopy(mUpdatePropValue);
    }

    for (i = 0; i < iCount; i += 1) {
      if (aDataStores[i][sSearchKey] === mSearchValue) {
        if (mUpdateValue) {
          aDataStores[i][sUpdateKey] = mUpdateValue;
          mOutput = aDataStores[i][sUpdateKey];
          oDataStore = aDataStores[i];
          sObjRefProp = sUpdateKey;
        } else {
          sRgxdPropKey = this._updateRegexHook({
            oData: aDataStores[i][sUpdateKey],
            sProp: sUpdatePropKey
          });
          aDataStores[i][sUpdateKey][sRgxdPropKey] = mUpdatePropValue;
          mOutput = aDataStores[i][sUpdateKey][sRgxdPropKey];
          oDataStore = aDataStores[i][sUpdateKey];
          sObjRefProp = sRgxdPropKey;
        }

        if (this.isArray(mOutput, true)) {
          this._setMultipleObjRefs(oDataStore, sObjRefProp);
        } else if (this.isObject(mUpdatePropValue)) {
          this._setSingleObjRef(oDataStore, sObjRefProp);
        }

        this.notify({ action: 'update', data: mOutput });

        return this.deepCopy(oDataStore);
      }
    }

    return null;
  };

  BaseModel.prototype._updateRegexHook = function (oParam) {
    return oParam.sProp;
  };

  BaseModel.prototype.add = function (mData) {
    var mOutput = undefined;

    if (mData) {
      if (this.isArray(mData, true)) {
        mOutput = this._addMultiple(this.deepCopy(mData));
      } else {
        mOutput = this._addSingle(this.deepCopy(mData));
      }

      this.setEvent({
        sName: 'dataAdded',
        sNamespace: this.sNamespace,
        mAddedData: mOutput
      }, true, true);

      this.notify({ action: 'add', data: mOutput });

      return this.deepCopy(mOutput);
    }

    return null;
  };

  BaseModel.prototype._addMultiple = function (aData) {
    var i = 0,
      iCount = aData.length,
      aOutput = [];

    for (i = 0; i < iCount; i += 1) {
      aOutput.push(this._addSingle(aData[i]));
    }

    return aOutput;
  };

  BaseModel.prototype._addSingle = function (oData) {
    var oDataStore = null,
      oDuplicate = null;

    if (this.sanityCheckData(oData).objects) {
      oDataStore = new this.DataStoreClass(oData);

      this._setObjRefs(oDataStore);

      oDuplicate = this._findDuplicate(oDataStore);

      if (!oDuplicate) {
        this._aDataStores.push(oDataStore);
      } else {
        this.mergeObjects(oDuplicate, oDataStore, { extend: true });
      }

      return oDuplicate || oDataStore;
    }

    return null;
  };

  BaseModel.prototype._findDuplicate = function (oDataStore) {
    var i = 0,
      iCount = this._aDataStores.length;

    for (i = 0; i < iCount; i += 1) {
      if (this._aDataStores[i].id === oDataStore.id) {
        return this._aDataStores[i];
      }
    }

    return undefined;
  };

  BaseModel.prototype._isInstanceOf = function (oData) {
    if (oData instanceof this.DataStoreClass) {
      return true;
    }

    return false;
  };

  BaseModel.prototype._setObjRefs = function (oData) {
    fn.loopObject.call(this, oData, function loopData(prop) {
      if (oData[prop] && this.oStoreModelMap.isStoreMapped(prop)) {
        if (Array.isArray(oData[prop]) && oData[prop].length) {
          this._setMultipleObjRefs(oData, prop);
        } else {
          this._setSingleObjRef(oData, prop);
        }
      }
    });
  };

  BaseModel.prototype._setMultipleObjRefs = function (oData, sProp) {
    var i = 0,
      iCount = oData[sProp].length;

    for (i = 0; i < iCount; i += 1) {
      this._setSingleObjRef(oData, sProp, i);
    }
  };

  BaseModel.prototype._setSingleObjRef = function (data, prop, i) {
    var _data = data;

    /**
     * Sets object references
     * @param {String} propName The property name.
     * @param {Mixed} value The data value to set the object referneces on.
     * @return {void}
     */
    function setRefs(propName, value) {
      var flags = this.sanityCheckData(value);

      if (flags.objects) {
        return value.id;
      }

      if (flags.ids) {
        if (propName === 'formHandler') {
          return $($.parseHTML(value)).attr('name');
        }
      }

      return value;
    }

    if (i !== undefined) {
      _data[prop][i] = setRefs.call(this, prop, _data[prop][i]);

      if (this.isArray(_data[prop][i], true) || this.isObject(_data[prop][i], true)) {
        this._setObjRefs(_data[prop][i]);
      }
    } else {
      _data[prop] = setRefs.call(this, prop, _data[prop]);

      if (this.isArray(_data[prop], true) || this.isObject(_data[prop], true)) {
        this._setObjRefs(_data[prop]);
      }
    }
  };

  /**
   * Removes an object from a model's data store.
   * @param {Object} oParams The search params, including mSearchValue, which will accept an id,
   *   an object to remove, an array of ids or an array of objects to remove.
   * @return {Object|Array|Boolean} The object or array of objects removed.
   */
  BaseModel.prototype.remove = function (oParams) {
    var mOutput = null;

    if (this.isArray(oParams.mSearchValue, true)) {
      mOutput = this._removeMultiple(oParams);
    } else {
      mOutput = this._removeSingle(oParams);
    }

    if (mOutput) {
      this.setEvent({
        sName: 'dataRemoved',
        sNamespace: this.sNamespace,
        mRemovedData: mOutput
      }, true, true);

      this.notify({ action: 'remove', data: mOutput });

      return mOutput;
    }

    return false;
  };

  /**
   * Iterates through an array and calls the removeSingle method on each index value.
   * @param {Object} oParams Search params, including array of values to be iterated over.
   * @return {Array} Array of objects removed from the model.
   */
  BaseModel.prototype._removeMultiple = function (oParams) {
    var aOutput = [];

    this.forLoop(oParams.mSearchValue, function (i) {
      aOutput.push(this._removeSingle({
        mSearchValue: oParams.mSearchValue[i]
      }));
    });

    return aOutput;
  };

  /**
   * Gets the object to remove and removes it from the data store, then returns the object.
   * @param {Object} oParams Search params, including a reference to the object to remove.
   * @return {Object|Boolean} Neither the removed object or false if remove failed.
   */
  BaseModel.prototype._removeSingle = function (oParams) {
    var oDataStore = {},
      index = null;

    // get the object from the model's data store
    oDataStore = this.get({
      sSearchKey: oParams.sSearchKey,
      mSearchValue: oParams.mSearchValue,
      sPropKey: oParams.sPropKey,
      oDeferred: oParams.oDeferred
    });

    // if a data object was returned, get the index and remove from data store.
    if (oDataStore) {
      index = this.forLoop(this._aDataStores, function (i) {
        if (this._aDataStores[i].id === oParams.mSearchValue) {
          return i;
        }

        return undefined;
      });

      this._aDataStores.splice(index, 1);
      return oDataStore;
    }

    return false;
  };

  /**
   * Sets up an observer on an object/group of objects or on an objects property or group of
   * objects' properties.
   * @param {Object} oParams The configuration to set up the observer.
   * @return {void}
   */
  BaseModel.prototype.observe = function (oParams) {
    var _oParams = oParams || {};

    if (oParams && !oParams.hasOwnProperty('model')) {
      _oParams.hash = fn.hashValue(this.get({
        sSearchKey: _oParams.searchKey || 'id',
        mSearchValue: _oParams.searchValue || this.getDataStoreIds(),
        sPropKey: _oParams.propKey || null,
        noFetch: true
      }));
    }

    _oParams.action = oParams.action || 'all';
    this.observers.push(_oParams);
  };

  /**
   * Checks if observed data has changed and if it has it notifies observers by executing the
   * callback the observer provided.
   * @param {Object} oParams The data changed in the model and the model action.
   * @return {void}
   */
  BaseModel.prototype.notify = function (oParams) {
    var i = 0,
      _params = {},
      result = undefined,
      hash = undefined;

    if (this.isArray(this.observers, true)) {
      i = this.observers.length - 1;

      for (; i >= 0; i -= 1) {
        _params = {};
        result = undefined;
        hash = undefined;

        if (this.observers[i].model) {
          this.observers[i].callback(this);

          if (this.observers[i].once) {
            this.observers.splice(i, 1);
          } else {
            this.observers[i].hash = hash;
          }
        } else {
          result = this.get({
            sSearchKey: this.observers[i].searchKey,
            mSearchValue: this.observers[i].searchValue,
            sPropKey: this.observers[i].propKey,
            noFetch: true
          });
          hash = fn.hashValue(result);

          if (this.observers[i].hash !== hash) {
            if (this.observers[i].action === 'all' || this.observers[i].action === oParams.action) {
              _params.action = oParams.action;
              _params.data = {};
              _params.data[oParams.action] = oParams.data;
              _params.data.observe = this.get({
                sSearchKey: this.observers[i].searchKey,
                mSearchValue: this.observers[i].searchValue,
                noFetch: true
              });
              this.observers[i].callback(_params);

              if (this.observers[i].once) {
                this.observers.splice(i, 1);
              } else {
                this.observers[i].hash = hash;
              }
            }
          }
        }
      }
    }
  };

  /**
   * Gets the ids of every data store in the model.
   * @return {Array} List of data store ids
   */
  BaseModel.prototype.getDataStoreIds = function () {
    var ids = [];

    this.forLoop(this._aDataStores, function (i) {
      ids.push(this._aDataStores[i].id);
    });

    return ids;
  };

  BaseModel.prototype.fetch = function (args) {
    var _this = this,
      _args = args || {},
      isDeferred = this.isObject(_args.oDeferred, true),
      i = 0,
      values = this.isArray(_args.mSearchValue) ? _args.mSearchValue : [_args.mSearchValue],
      APIRequest = new RESTAPIRequest(),
      promises = null;

    if (this.isObject(_args.fetch, true)) {
      $.extend(_args, _args.fetch);
      delete _args.fetch;
    }

    if (typeof _args.doneCallback !== 'function') {
      _args.doneCallback = function () {
        _this.get(_args);
      };
    }

    _args.endpoints = this.createEndpointsArray({
      values: values,
      increment: _args.increment,
      modelMethod: _args.sModelMethod,
      hrefData: _args.hrefData,
      createEndpointCallback: _args.createEndpointCallback
    });

    if (_args.endpoints.length) {
      promises = APIRequest.fetchData(
        _args.endpoints,
        this._fetchSuccessCallback,
        this._fetchErrorCallback,
        _args
      );

      for (; i < promises.length; i += 1) {
        promises[i].progress(function (resp) {
          _this.dataHandler(resp, _args);

          if (_args.progressCallback) {
            _args.progressCallback(_args.mSearchValue, resp);
          }
        });
      }

      $.when
        .apply($, promises)
        .done(function (resp) {
          _args.doneCallback.call(this, resp, _args.oDeferred);
        })
        .fail(function handleFetchPromiseFailure(failureArgs) {
          if (!_this.isObject(failureArgs) || !_this.isObject(failureArgs.errorResp)) {
            if (isDeferred) {
              _args.oDeferred.reject();
            }
          }

          if (failureArgs.errorResp.status === 500) {
            _this.forLoop(_args.endpoints, function loopEndpoints(j) {
              if (failureArgs.params.sEndpoint === _args.endpoints[j]) {
                if (Array.isArray(_args.mSearchValue)) {
                  _args.mSearchValue.splice(j, 1);
                }
                return true;
              }
              return undefined;
            });

            _args.doneCallback.call(this, failureArgs.params);
            return;
          }

          if (failureArgs.errorResp.status === 400) {
            _args.increment = !_args.increment ? 10 : Math.ceil(_args.increment / 2);

            if (_args.increment >= 5) {
              _this.get(_args);
              return;
            }
          }

          if (isDeferred) {
            _args.oDeferred.reject();
          }
        });
    } else if (isDeferred) {
      _args.oDeferred.resolve();
    }
  };

  BaseModel.prototype.createEndpointsArray = function (args) {
    var _args = args || {},
      increment = _args.increment || 20,
      endpoints = [],
      count = 0,
      i = 0,
      values = [],
      begin = 0,
      end = increment;

    if (!this.isArray(_args.values)) {
      return endpoints;
    }

    count = Math.ceil(_args.values.length / increment);

    for (; i < count; i += 1) {
      values.push(_args.values.slice(begin, end));
      begin += increment;
      end += increment;
    }

    if (!values.length) {
      return endpoints;
    }

    this.forLoop(values, function loopValues(j) {
      if (values[j]) {
        endpoints = endpoints.concat(this.createEndpoint({
          values: values[j],
          modelMethod: args.modelMethod,
          hrefData: args.hrefData,
          createEndpointCallback: args.createEndpointCallback
        }));
      }
    });

    return endpoints;
  };

  BaseModel.prototype.createEndpoint = function (args) {
    var i = 0,
      values = args.values,
      count = values.length,
      endpoints = [],
      endpoint = null,
      url = '',
      placeholderRegex = /{[^{}]*}/g,
      bracketRegex = /[{}]/g,
      placeholderContent = '',
      validUrl = true;

    /**
     * Finds instances of placeholders in url and replaces them with relevant data.
     * @param {String} placeholder The placeholder content, including brackets.
     * @return {String} The data add in place of the placeholder.
     */
    function placeholderReplace(placeholder) {
      placeholderContent = placeholder.replace(bracketRegex, '');

      if (!args.hrefData.hasOwnProperty(placeholderContent)) {
        validUrl = false;
        return '';
      }

      return args.hrefData[placeholderContent];
    }

    for (i = 0; i < count; i += 1) {
      if (typeof values[i] === 'object' && values[i].hasOwnProperty('href')) {
        endpoints.push(values[i].href);
      } else {
        endpoint = this.oDataEndpointMap.getEndpoint(this.sNamespace);

        if (endpoint) {
          if (args.modelMethod) {
            url = endpoint.action[args.modelMethod].href;
          } else {
            url = endpoint.action.fetch.href;
          }

          if (url.match(placeholderRegex)) {
            if (!this.isObject(args.hrefData, true)) {
              validUrl = false;
            } else {
              url = url.replace(placeholderRegex, placeholderReplace);
            }
          }

          if (validUrl) {
            url += values[i];

            if (typeof args.createEndpointCallback === 'function') {
              url = args.createEndpointCallback(url);
            }

            endpoints.push(url);
          }
        }
      }
    }

    return endpoints;
  };


  /**
   *
   * @param {Object} args
   * @param {String} legacyArg The id to look up the objects with.
   * @return {Array<Object>}
   */
  BaseModel.prototype.getLinks = function (args, legacyArg) {
    var key = '',
      value = undefined,
      childKey = '',
      childValue = undefined,
      objData = {},
      filteredlinks = [];

    /**
     * First clause added to make method backwards compatable
     * after refactor. - Dylan Aubrey (so24) on 22/06/2016
     */
    if (typeof args === 'string') {
      key = 'rel';
      value = args;
      objData = this.resolveDataArg(legacyArg);
    } else if (this.isObject(args, true)) {
      key = args.key || 'rel';
      value = args.value || undefined;
      childKey = args.childKey || '';
      childValue = args.childValue || undefined;
      objData = this.resolveDataArg(args.data);
    }

    if (!objData
        || (typeof key !== 'string' || key.length === 0)
        || typeof childKey !== 'string') {
      return filteredlinks;
    }

    objData = !this.isArray(objData) ? [objData] : objData;

    this.forLoop(objData, function loopDataStores(i) {
      if (this.isObject(objData[i], true) && this.isArray(objData[i].links, true)) {
        this.forLoop(objData[i].links, function loopLinks(j) {
          if (value !== undefined) {
            if (objData[i].links[j][key] === value) {
              filteredlinks.push(objData[i].links[j]);
            }
          } else if (childKey.length > 0
              && this.isObject(objData[i].links[j][key], true)
              && objData[i].links[j][key][childKey] === childValue) {
            filteredlinks.push(objData[i].links[j]);
          }
        });
      }
    });

    return filteredlinks;
  };

  BaseModel.prototype.getLinkIds = function (links) {
    var ids = [];

    this.forLoop(links, function loopLinks(i) {
      if (typeof links[i].id === 'string') {
        ids.push(links[i].id);
      }
    });

    return ids;
  };


  /**
   *
   * @param {Object|string} data
   * @return {Object}
   */
  BaseModel.prototype.getSelfLink = function (data) {
    var selfLink = this.getLinks({ value: 'self', data: data });

    if (!fn.isArray(selfLink, { notEmpty: true })) {
      return {};
    }

    return selfLink[0];
  };


  BaseModel.prototype.dataHandler = function (oResponse) {
    var _oResponse = oResponse,
      sResponseModelType = null,
      oEventDataAdd = new $.Event('addData'),
      oAPIRequest = new RESTAPIRequest(),
      oSelfEntity = oAPIRequest.getSelfEntityFromResponse(_oResponse);

    if (oSelfEntity) {
      _oResponse.id = oSelfEntity.id;
      _oResponse.type = oSelfEntity.type;
      sResponseModelType = this.oHyperMediaModelMap.getModelFromHyperMediaType(_oResponse.type);

      if (sResponseModelType !== this.sNamespace) {
        oEventDataAdd.oData = {
          sNamespace: sResponseModelType,
          mAddData: _oResponse
        };
        $(window).trigger(oEventDataAdd);
      } else {
        this.add(_oResponse);
      }

      this.triggerDataFetched(_oResponse);
    } else {
      this.nonCompliantDataHandler(_oResponse);
    }
  };

  BaseModel.prototype.triggerDataFetched = function (oResponse) {
    var eDataFetched = null;

    eDataFetched = $.Event('dataFetched');
    eDataFetched.oData = {
      mfetchedData: oResponse
    };
    $(window).trigger(eDataFetched);
  };

  BaseModel.prototype.nonCompliantDataHandler = function (oResponse) {
    this.setEvent({
      sName: 'dataFetched',
      mfetchedData: oResponse
    }, false, true);
  };


  /**
   *
   * @param {Object|String|Array<Object>|Array<String>} data
   * @return {Object|String|Array<Object>}
   */
  BaseModel.prototype.resolveDataArg = function (data) {
    var isArray = fn.isArray(data),
      _data = isArray ? data : [data],
      dataObj = null,
      output = [];

    fn.loopArray.call(this, _data, function loopData(i) {
      dataObj = null;

      if (typeof _data[i] === 'string') {
        dataObj = this.getDataStoreByID(_data[i]);
      } else if (fn.checkData(_data[i])) {
        dataObj = _data[i];
      }

      if (dataObj) {
        output.push(dataObj);
      }
    });

    return isArray ? output : output[0];
  };


  /**
   *
   * @param {String} id
   * @return {Object}
   */
  BaseModel.prototype.getDataStoreByID = function (id) {
    if (typeof id !== 'string') {
      return null;
    }

    return this.getDataStores({ value: id }) || {};
  };


  /**
   * This is wrapper function for .get() and will eventually
   * superseed .get()... so this should be used going forward.
   * - Dylan Aubrey (so24) 6/12/16
   *
   * @param {Object} [args]
   * @param {string} [args.key]
   * @param {any} [args.value]
   * @param {boolean} [args.fetch]
   * @return {Object|Array<Object>|JQueryPromise}
   */
  BaseModel.prototype.getDataStores = function (args) {
    var deferred = null,
      isArray = false,
      itemData = undefined,
      masterDeferred = null,
      paramObj = null;

    if (!args) {
      return this._aDataStores;
    }

    if (args.fetch || args.forceFetch) {
      deferred = $.Deferred();
      masterDeferred = $.Deferred();
    }

    isArray = fn.isArray(args.value);

    paramObj = {
      sSearchKey: args.key || 'id',
      mSearchValue: args.value,
      noFetch: !args.fetch,
      oDeferred: deferred
    };

    if (args.forceFetch) {
      this.fetch(paramObj);
    } else {
      itemData = this.get(paramObj);
    }

    if (args.fetch || args.forceFetch) {
      deferred
        .done(function handleDeferredSuccess(respData) {
          masterDeferred.resolve(respData);
        })
        .fail(function handleDeferredFailure() {
          masterDeferred.resolve(isArray ? [] : {});
        });

      return masterDeferred.promise();
    }

    if (!fn.checkData(itemData)) {
      if (!args.observe) {
        return isArray ? [] : {};
      }

      masterDeferred = $.Deferred();

      this.observe({
        action: 'add',
        callback: function observeCallback(resp) {
          masterDeferred.resolve(resp.data.observe);
        },
        once: true,
        searchValue: args.value
      });

      return masterDeferred.promise();
    }

    return itemData;
  };


  /**
   * This is wrapper function for .add() and will eventually
   * superseed .add()... so this should be used going forward.
   * - Dylan Aubrey (so24) 6/12/16
   *
   * @param {Object|Array<Object>} data
   * @return {this}
   */
  BaseModel.prototype.setDataStores = function (data) {
    this.add(data);
    return this;
  };


  /**
   * This is wrapper function for .remove() and will eventually
   * superseed .remove()... so this should be used going forward.
   * - Dylan Aubrey (so24) 6/12/16
   *
   * @param {Object} args optional
   * @param {String} args.key
   * @param {any} args.value
   * @return {this}
   */
  BaseModel.prototype.unsetDataStores = function (args) {
    if (!args) {
      this._aDataStores = [];
    } else {
      this.remove({ sSearchKey: args.key, mSearchValue: args.value });
    }
    return this;
  };


  /**
   *
   * @param {Object|String} data
   * @param {Object|Array<Object>} links
   * @return {this}
   */
  BaseModel.prototype.setLinks = function (data, links) {
    var _links = fn.isArray(links) ? links : [links],
      itemData = this.resolveDataArg(data);

    if (!fn.isObject(itemData, { notEmpty: true }) || !fn.typeofArrayValues('object', _links)) {
      return this;
    }

    if (!fn.isArray(itemData.links)) {
      itemData.links = [];
    }

    itemData.links = itemData.links.concat(_links);
    this.setDataStores(itemData);
    return this;
  };


  /**
   *
   * @param {Object|String} data
   * @param {String} key
   * @param {any} value
   * @return {this}
   */
  BaseModel.prototype.unsetLinks = function (data, key, value) {
    var itemData = this.resolveDataArg(data),
      links = [];

    if (!fn.isObject(itemData, { notEmpty: true })
        || !fn.isArray(itemData.links, { notEmpty: true })) {
      return this;
    }

    links = itemData.links;

    if (!key && !value) {
      links.splice(0, links.length);
    } else {
      fn.loopArray(links, function loopSkuMedia(i) {
        if (links[i][key] === value) {
          links.splice(i, 1);
        }
      }, { backward: true });
    }

    this.setDataStores(itemData);
    return this;
  };


  return BaseModel;
});

define('modules/pdp/models/AssetModel', [
  'modules/mvc/fn',
  'modules/pdp/data-stores/Asset',
  'modules/pdp/models/BaseModel'
], function (fn, Asset, BaseModel) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function AssetModel(config) {
    this.DataStoreClass = Asset;
    this.sNamespace = 'assets';
    this.parent.constructor.call(this, config);
  }

  fn.inherit(AssetModel, BaseModel);

  return AssetModel;
});

define('modules/pdp/data-stores/bucket-group/index',['require','exports','module'],function (require, exports, module) {
  'use strict';

  /**
   *
   * @param {Object} data
   * @return {void}
   */
  module.exports = function BucketGroup(data) {
    this.id = data.id || null;
    this.displayName = data.displayName || null;
    this.links = data.links || null;
  };
});

define('modules/pdp/models/bucket-group/index',['require','exports','module','modules/mvc/fn','modules/pdp/data-stores/bucket-group/index','modules/pdp/models/BaseModel'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn');
  var Bucket = require('modules/pdp/data-stores/bucket-group/index');
  var BaseModel = require('modules/pdp/models/BaseModel');

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  var BucketGroupModel = function BucketGroupModel(config) {
    this.DataStoreClass = Bucket;
    this.sNamespace = 'bucketGroup';
    this.parent.constructor.call(this, config);
  };

  fn.inherit(BucketGroupModel, BaseModel);

  BucketGroupModel.prototype.dataHandler = function (res) {
    if (!fn.isArray(res, { notEmpty: true }) && !fn.isObject(res, { notEmpty: true })) return;
    this.add(res);
  };

  module.exports = BucketGroupModel;
});


define('text!templates/views/productTileTitleView.html',[],function () { return '<div id="{{sViewId}}" class="{{sViewClass}} {{sClassNames}}">\r\n  <a href="{{{props.link}}}" data-productid="{{props.id}}">\r\n      <h3 class="tile-title">{{{props.displayName}}}</h3>\r\n  </a>\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/ProductTileTitleView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','modules/recommenders/common','text!templates/views/productTileTitleView.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    recommenders = require('modules/recommenders/common'),
    template = require('text!templates/views/productTileTitleView.html');

  /**
   * The view class that renders the tile title.
   * @param {oConfig} oConfig The configuration for the view.
   * @return {void}
   */
  function ProductTileTitleView(oConfig) {
    this.sViewName = 'ProductTileTitleView';
    this.sNamespace = 'inherit';
    this.sTag = 'title';
    this.sViewClass = 'product-tile-title';
    this.sTemplate = template;
    this.parent.constructor.call(this, oConfig);
  }


  fn.inherit(ProductTileTitleView, BaseView);
  ProductTileTitleView._name = 'ProductTileTitleView';
  ProductTileTitleView.sNamespace = 'inherit';
  ProductTileTitleView.sTag = 'title';


  ProductTileTitleView.prototype._setProps = function (data) {
    var flags = data.flags,
      itemData = data.inherit;

    return {
      displayName: itemData.displayName,
      id: itemData.id,
      link: flags.richRelevance && itemData.rrLink ? itemData.rrLink : itemData.publicLink
    };
  };


  ProductTileTitleView.prototype._cacheDomElms = function () {
    this.parent._cacheDomElms.call(this);
    this.oElms.elTitle = $(this.oElms.elWrapper).find('h3');
  };


  ProductTileTitleView.prototype._bindEvents = function () {
    $(window).off('breakpointChange.ProductTileTitleView')
    .on('breakpointChange.ProductTileTitleView',
      this._initDotDotDot.bind(this)
    );

    $(this.oElms.elTitle).on(
      'click',
      this._analyticsTracking.bind(this)
    );
  };


  ProductTileTitleView.prototype._initDependancies = function () {
    this._initDotDotDot();
  };


  ProductTileTitleView.prototype._initDotDotDot = function () {
    var _this = this;

    setTimeout(function () {
      $(_this.oElms.elTitle).dotdotdot({ height: 48 });
    }, 10);
  };


  ProductTileTitleView.prototype.refresh = function (params) {
    this.sNamespace = params.sNamespace;

    this.render({
      newEvent: true,
      sourceOutput: 'inner',
      sOutput: 'inner',
      elTarget: 'self',
      mParamData: params.mParamData
    });
  };


  ProductTileTitleView.prototype._analyticsTracking = function () {
    var mvcData = this.oData.mvc,
      flags = mvcData.flags,
      info = mvcData.info,
      relationship = '',
      _s = fn.copyObject(window.s),
      placementData = {},
      formattedItemsArray = [],
      productPosition = null;

    relationship = flags.completeTheLook ? 'Complete the Look' : relationship;
    relationship = flags.outfitBuilder ? 'Outfit Block' : relationship;
    relationship = flags.shopTheRange ? 'Shop The Range' : relationship;
    relationship = flags.bundle ? 'Frequently Bought Together' : relationship;

    if (info.rrPlacement !== undefined) {
      formattedItemsArray = info.rrPlacement.formattedItemsArray;
      fn.loopArray(formattedItemsArray, function loopRRProductIDs(i) {
        if (formattedItemsArray[i].id.indexOf(mvcData.inherit.id) > -1) {
          productPosition = (i + 1);
        }
      });
      placementData.productPosition = productPosition;
      placementData.placement = info.rrPlacement;
      placementData.productId = mvcData.inherit.id;
      recommenders.triggerRichRelevanceClickEventAnalytics(null, placementData);
    }

    if (relationship) {
      _s.linkTrackEvents = 'event32,event45';
      _s.linkTrackVars = 'prop19,eVar45,prop42,eVar59,events,products';
      _s.products = ';' + mvcData.inherit.id + ';;';
      _s.prop19 = 'product click';
      _s.eVar45 = _s.prop19;
      _s.prop42 = 'pdp - ' + relationship + ' - product click';
      _s.eVar59 = _s.prop42;
      _s.events = 'event32,event45';
      _s.tl(true, 'o', relationship + ' - product click');
    }
  };

  module.exports = ProductTileTitleView;
});


define('text!templates/views/productTileImageView.html',[],function () { return '<div id="{{sViewId}}" class="{{sViewClass}} {{sClassNames}}">\r\n  <a href="{{{props.link}}}" class="thumbnail" data-productid="{{props.id}}" title="{{props.displayName}}">\r\n    <div class="thumbnail-alts" data-picture="" data-alt="{{props.displayName}}">\r\n      <div data-src="{{{props.imageSrcLarge}}}" data-media="(min-width: 600px)"></div>\r\n      <div data-src="{{{props.imageSrcDetail}}}" data-media="(max-width: 599px)"></div>\r\n      <!--[if (lt IE 9) & (!IEMobile)]>\r\n          <div data-src="{{{props.imageSrcDetail}}}"></div>\r\n      <![endif]-->\r\n      <noscript>\r\n        <img src="{{{props.imageSrcLarge}}}" alt="{{props.displayName}}" />\r\n      </noscript>\r\n    </div>\r\n  </a>\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/ProductTileImageView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','modules/recommenders/common','text!templates/views/productTileImageView.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    recommenders = require('modules/recommenders/common'),
    template = require('text!templates/views/productTileImageView.html');

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function ProductTileImageView(config) {
    this.sViewName = 'ProductTileImageView';
    this.sNamespace = 'inherit';
    this.sTag = 'productImage';
    this.sViewClass = 'product-tile-image';
    this.sTemplate = template;
    this.parent.constructor.call(this, config);
  }

  fn.inherit(ProductTileImageView, BaseView);
  ProductTileImageView._name = 'ProductTileImageView';
  ProductTileImageView.sNamespace = 'inherit';
  ProductTileImageView.sTag = 'productImage';

  ProductTileImageView.prototype._setProps = function (data) {
    var flags = data.flags,
      itemData = data.inherit;

    return {
      displayName: itemData.displayName,
      id: itemData.id,
      imageSrcDetail: this._populateImageTemplate(flags, itemData, 'detail'),
      imageSrcLarge: this._populateImageTemplate(flags, itemData, 'large'),
      link: flags.richRelevance && itemData.rrLink ? itemData.rrLink : itemData.publicLink
    };
  };

  ProductTileImageView.prototype._populateImageTemplate = function (flags, itemData, type) {
    var _this = this,
      PLACEHOLDER = '[preset]',
      CAROUSEL_PRESET = 'Carousel-306',
      DETAIL_PRESET = 'Detail',
      PORTRAIT_PRESET = 'Portrait-S',
      defaultImage = {},
      detailPreset = flags.isFF ? PORTRAIT_PRESET : DETAIL_PRESET,
      isFF = false,
      largePreset = '',
      preset = '',
      productData = this.oData.mvc.products;

    defaultImage = (function () {
      var mediaAssets = itemData.mediaAssets || {};

      if (_this.sNamespace === 'sku') return mediaAssets.defaultImage;
      return fn.getValue(mediaAssets.defaultSku, 'defaultImage');
    }());

    if (flags.hasOwnProperty('isFF')) {
      isFF = flags.isFF;
    } else if (this.sNamespace === 'products') {
      isFF = this.oModel.isFF(itemData);
    } else if (fn.isObject(productData)) {
      isFF = fn.getValue(productData, 'dynamicAttributes', 'supplier') === 'FF';
    }

    if (isFF) {
      largePreset = PORTRAIT_PRESET;
    } else if (defaultImage.renderSource === 'Scene 7') {
      largePreset = CAROUSEL_PRESET;
    } else {
      largePreset = DETAIL_PRESET;
    }

    if (type === 'detail') {
      preset = detailPreset;
    } else if (type === 'large') {
      preset = largePreset;
    }

    return defaultImage.src.replace(PLACEHOLDER, preset);
  };

  ProductTileImageView.prototype._initDependancies = function () {
    window.picturefill();
  };

  ProductTileImageView.prototype.refresh = function (params) {
    this.sNamespace = params.sNamespace;

    this.render({
      newEvent: true,
      sourceOutput: 'inner',
      sOutput: 'inner',
      elTarget: 'self',
      mParamData: params.mParamData
    });
  };

  ProductTileImageView.prototype._bindEvents = function () {
    $(this.oElms.elWrapper).on(
      'click', 'a',
      this._analyticsTracking.bind(this)
    );
  };

  ProductTileImageView.prototype._analyticsTracking = function () {
    var mvcData = this.oData.mvc,
      flags = mvcData.flags,
      info = mvcData.info,
      relationship = '',
      _s = fn.copyObject(window.s),
      placementData = {},
      formattedItemsArray = [],
      productPosition = null;

    relationship = flags.completeTheLook ? 'Complete the Look' : relationship;
    relationship = flags.outfitBuilder ? 'Outfit Block' : relationship;
    relationship = flags.shopTheRange ? 'Shop The Range' : relationship;
    relationship = flags.bundle ? 'Frequently Bought Together' : relationship;

    if (info.rrPlacement !== undefined) {
      formattedItemsArray = info.rrPlacement.formattedItemsArray;
      fn.loopArray(formattedItemsArray, function loopRRProductIDs(i) {
        if (formattedItemsArray[i].id.indexOf(mvcData.inherit.id) > -1) {
          productPosition = (i + 1);
        }
      });
      placementData.productPosition = productPosition;
      placementData.placement = info.rrPlacement;
      placementData.productId = mvcData.inherit.id;
      recommenders.triggerRichRelevanceClickEventAnalytics(null, placementData);
    }

    if (relationship) {
      _s.linkTrackEvents = 'event32,event45';
      _s.linkTrackVars = 'prop19,eVar45,prop42,eVar59,events,products';
      _s.products = ';' + mvcData.inherit.id + ';;';
      _s.prop19 = 'product click';
      _s.eVar45 = _s.prop19;
      _s.prop42 = 'pdp - ' + relationship + ' - product click';
      _s.eVar59 = _s.prop42;
      _s.events = 'event32,event45';
      _s.tl(true, 'o', relationship + ' - product click');
    }
  };

  module.exports = ProductTileImageView;
});


define('text!templates/views/productPriceView.html',[],function () { return '<div id="{{sViewId}}" class="{{sViewClass}} {{sClassNames}} {{#state.hasWasWasPrice}}has-was-was{{/state.hasWasWasPrice}}">\r\n\r\n  {{#state.hasFromPrice}}\r\n    <strong><small class="from-prefix product-price-from-prefix">From </small></strong>\r\n    <span class="product-price" itemprop="priceCurrency" content="GBP">&pound;</span><span class="product-price" itemprop="price">{{props.fromPrice}}</span>\r\n  {{/state.hasFromPrice}}\r\n\r\n  {{#state.hasPrice}}\r\n    <span class="product-price" itemprop="priceCurrency" content="GBP">&pound;</span><span class="product-price" itemprop="price">{{props.price}}</span>\r\n  {{/state.hasPrice}}\r\n\r\n  {{#state.showSavings}}\r\n    <div class="savings-wrapper text smaller">\r\n\r\n      {{#state.hasRrpPrice}}\r\n        <del class="rrp-price">\r\n          <span class="rrp-prefix">RRP </span>\r\n          &pound;{{props.rrpPrice}}\r\n        </del>\r\n      {{/state.hasRrpPrice}}\r\n\r\n      {{#state.hasWasPrice}}\r\n        {{#state.hasWasWasPrice}}\r\n          <del class="was-was-price">\r\n            <span class="was-prefix">Was </span>\r\n\r\n            {{#state.hasFromPrice}}\r\n              <span class="from-prefix">from </span>\r\n            {{/state.hasFromPrice}}\r\n\r\n            &pound;{{props.wasWasPrice}}\r\n          </del>\r\n\r\n          <span class="was-was-price-divider"></span>\r\n        {{/state.hasWasWasPrice}}\r\n        <del class="was-price">\r\n          <span class="was-prefix">Was </span>\r\n\r\n          {{#state.hasFromPrice}}\r\n            <span class="from-prefix">from </span>\r\n          {{/state.hasFromPrice}}\r\n\r\n          &pound;{{props.wasPrice}}\r\n        </del>\r\n      {{/state.hasWasPrice}}\r\n      {{#state.hasSavings}}\r\n        <span class="saving">\r\n          <span class="save-prefix">Save </span>\r\n\r\n          {{#state.hasFromPrice}}\r\n            <span class="from-prefix">from </span>\r\n          {{/state.hasFromPrice}}\r\n\r\n          &pound;{{props.savings}}</span>\r\n        </span>\r\n      {{/state.hasSavings}}\r\n    </div>\r\n  {{/state.showSavings}}\r\n\r\n  {{#state.showPoints}}\r\n    {{^state.isBoost}}\r\n      {{#state.hasClubcardPoints}}\r\n        <p class="clubcard-points">\r\n          Earn\r\n          {{#state.hasFromPrice}}\r\n            <span class="from-prefix">from </span>\r\n          {{/state.hasFromPrice}}\r\n          <strong>\r\n            {{props.clubcardPoints}} Clubcard points\r\n          </strong>\r\n        </p>\r\n      {{/state.hasClubcardPoints}}\r\n    {{/state.isBoost}}\r\n  {{/state.showPoints}}\r\n\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>';});

define('modules/pdp/views/ProductPriceView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','text!templates/views/productPriceView.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    template = require('text!templates/views/productPriceView.html');

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function ProductPriceView(config) {
    this.sNamespace = 'inherit';
    this.sTag = 'prices';
    this.sViewName = 'ProductPriceView';
    this.sViewClass = 'product-price-view';
    this.sTemplate = template;
    this.views = { classes: {} };
    this.parent.constructor.call(this, config);
  }

  fn.inherit(ProductPriceView, BaseView);
  ProductPriceView._name = 'ProductPriceView';
  ProductPriceView.sNamespace = 'inherit';
  ProductPriceView.sTag = 'prices';

  ProductPriceView.prototype._compileData = function () {
    if (this.sNamespace !== 'sellers') {
      this.oData.mvc.inherit.prices = this.oModel.getPrices(this.oData.mvc.inherit.id);
    }

    this.parent._compileData.call(this, this.oData.mvc);
  };

  ProductPriceView.prototype._setProps = function (data) {
    return {
      fromPrice: data.inherit.prices.fromPrice,
      toPrice: data.inherit.prices.toPrice,
      price: data.inherit.prices.price,
      rrpPrice: data.inherit.prices.rrp,
      wasPrice: data.inherit.prices.was,
      wasWasPrice: data.inherit.prices.wasWas,
      savings: data.inherit.prices.savings,
      clubcardPoints: data.inherit.prices.clubcardPoints
    };
  };

  ProductPriceView.prototype._setStates = function (data) {
    var hasSeller = this.isObject(data.sellers, true);

    return {
      hasFromPrice: !!data.inherit.prices.fromPrice,
      hasToPrice: !!data.inherit.prices.toPrice,
      hasPrice: !!data.inherit.prices.price,
      hasRrpPrice: !!data.inherit.prices.rrp,
      hasWasPrice: !!data.inherit.prices.was,
      hasWasWasPrice: !!data.inherit.prices.wasWas,
      hasSavings: !!data.inherit.prices.savings,
      hasClubcardPoints: !!data.inherit.prices.clubcardPoints,
      isBoost: hasSeller && !!data.sellers.isBCVE,
      showSavings: undefined,
      showPoints: undefined
    };
  };

  ProductPriceView.prototype.refresh = function (args) {
    this.sNamespace = args.sNamespace;

    this.render({
      sourceOutput: 'inner',
      sOutput: 'inner',
      elTarget: 'self',
      mParamData: args.mParamData
    });
  };

  module.exports = ProductPriceView;
});

define('modules/custom-dropdown/oo-dropdown',[
  'domlib',
  'modules/common',
  'mustache'
], function ($, common, mustache) {
  'use strict';

  var customDropdown = {};

  /**
   * The custom dropdown class.
   * @return {void}
   */
  function CustomDropdown() {
    var $template = $('#custom-dropdown-template');

    this.id = Math.floor(Math.random() * 1000000000);

    // store the event type (updated in init for touch devices)
    this.eventType = 'click';

    // used by the mouse enter/leave events to set a timer to close any
    // open menus if left inactive
    this.closeTimer = null;

    // defaults
    this.defaultSettings = {
      wrapperClass: 'select-wrapper',
      dropdownClass: 'dropdown-customised',
      controlClass: 'control',
      template: $template.length > 0 && $template[0].innerHTML,
      clearSelected: false,
      defaultNativeWidth: false,
      renderedCallback: null,
      overrideDefaultTouch: false,
      overrideTimer: false,
      hasSwatches: false
    };

    if ($template.length === 0) {
      return false;
    }
  }

  customDropdown.instances = [];
  customDropdown.openInstance = null;
  customDropdown.init = function ($select, opts) {
    var $selectCopy = $select,
      self = {},
      ua = '';

    if ($selectCopy.hasClass('been-customised')) {
      return false;
    }

    self = new CustomDropdown();

    if (!self) {
      return false;
    }

    self.isTouch = opts.overrideDefaultTouch ? false : common.isTouch();

    /**
     * update the event type (default is click -
     * click too slow on windows phone, tap not recognised)
     */
    if (self.isTouch) {
      self.eventType = (common.isWindowsPhone()) ? 'MSPointerDown' : 'click.customDropdown';

      /*
       * add fix for earlier version of Android (2.x)
       * issue - tap on the $dropdown.find('.control') element is returning the select element
       * this fix is only required for Android (2.x) - applying the fix to Android 4.x will
       * cause it to break (oh joy!)
       */
      if (common.isAndroid()) {
        ua = navigator.userAgent.toLowerCase();

        if (parseFloat(ua.slice(ua.indexOf('android') + 8)) < 4) {
          $selectCopy.css('z-index', 0);
        }
      }
    }

    if ($selectCopy.length > 0 && opts && typeof opts === 'object' && !Array.isArray(opts)) {
      self.settings = $.extend({}, self.defaultSettings, opts);
    }

    self.setup($selectCopy);

    customDropdown.instances.push(self);

    return self;
  };

  CustomDropdown.prototype = {
    constructor: CustomDropdown,
    setup: function ($select) {
      var $options = null,
        $selectedOpt = null;

      if (!$select[0] instanceof Element) {
        return;
      }

      $options = $select.find('option');
      $selectedOpt = $select.find('option:selected');

      if (this.settings.clearSelected) {
        $selectedOpt.removeAttr('selected');
      }

      if (this.isTouch && !window.isKiosk()) {
        $select.addClass('native-select-trigger');
      }

      this.createMenu({
        $select: $select,
        $options: $options,
        $selectedOpt: this.settings.clearSelected ? null : $selectedOpt
      });

      if (this.settings.renderedCallback) {
        this.settings.renderedCallback(this.elms.$dropdown, $selectedOpt);
      }
    },
    createMenu: function (args) {
      var data = this.collateOptionsData({
        $select: args.$select,
        $options: args.$options,
        $selectedOpt: args.$selectedOpt
      });

      this.renderDropdown({
        data: data,
        $select: args.$select
      });
      this.cacheDomElms();
      this.bindEvents();
    },
    collateOptionsData: function (elms, opts) {
      var _opts = opts || {},
        i = 0,
        data = {},
        selectedValue = '',
        $opt = null,
        opt = {};

      /**
       * Creates a string of data attributes and their values/
       * @param {Object} args The option node to iterate over.
       * @return {String} The string of data attributes.
       */
      function getDataAttr(args) {
        var dataAttr = args.$opt.data(),
          prop = '',
          attrStr = '';

        if ($.isEmptyObject(dataAttr)) {
          return null;
        }

        for (prop in dataAttr) {
          if (dataAttr.hasOwnProperty(prop)) {
            attrStr += ' data-' + prop.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase()
                + '="' + dataAttr[prop] + '"';
          }
        }

        return attrStr;
      }

      selectedValue = elms.$selectedOpt.val();
      data.label = elms.$select[0].id;
      data.selectedText = elms.$selectedOpt.text().trim();
      data.selectedSwatch = elms.$selectedOpt.data('swatch-url') || '';
      data.selectedAttr = getDataAttr({ $opt: elms.$selectedOpt });
      data.options = [];

      if (_opts.control) {
        return data;
      }

      for (i = 0; i < elms.$options.length; i += 1) {
        $opt = $(elms.$options[i]);
        opt = {};
        opt.value = elms.$options[i].value;
        opt.innerHTML = elms.$options[i].innerHTML;
        opt.currentClass = $opt.val() === selectedValue ? 'current' : '';
        opt.disabled = elms.$options[i].disabled ? 'disabled' : '';
        opt.swatch = $opt.data('swatch-url') || '';
        opt.dataAttr = getDataAttr({ $opt: $opt });

        data.options.push(opt);
      }

      return data;
    },
    renderDropdown: function (args) {
      var html = mustache.render(this.settings.template, $.extend(true, this.settings, args.data)),
        node = $.parseHTML($.trim(html), document, true)[0];

      $(node).insertAfter(args.$select);
      args.$select.addClass('been-customised');
    },
    cacheDomElms: function () {
      var $container = this.settings.$container;

      if ($container.length === 0) {
        return;
      }

      this.elms = {
        $wrapper: $container.find('.' + this.settings.wrapperClass),
        $dropdown: $container.find('.' + this.settings.dropdownClass),
        $control: $container.find('.' + this.settings.controlClass),
        $dropdownList: $container.find('ul'),
        $dropdownLinks: $container.find('a.option'),
        $currentDropdownLink: $container.find('a.option.current'),
        $innerText: $container.find('.innerText'),
        $additionalText: $container.find('.additionalText'),
        $select: $container.find('select'),
        $options: $container.find('option'),
        $selectedOpt: $container.find('option:selected')
      };
    },
    bindEvents: function () {
      if (!this.isTouch || window.isKiosk()) {
        this.elms.$dropdown.on(this.eventType, 'a.control', this.handleControlClick.bind(this));
        this.elms.$dropdown.on(this.eventType, 'a.option', this.handleDropdownLinkClick.bind(this));
      }

      this.elms.$select.on('change', this.changeControlText.bind(this));
    },
    handleBodyClick: function (event) {
      var $targetDropdown = null,
        $openDropdown = null;

      if (!customDropdown.openInstance) {
        return;
      }

      $openDropdown = customDropdown.openInstance.elms.$dropdown;

      if (event.target === $openDropdown[0]) {
        return;
      }

      $targetDropdown = $(event.target).closest('.' + this.settings.dropdownClass);

      if ($targetDropdown.length && $targetDropdown[0] === $openDropdown[0]) {
        return;
      }

      customDropdown.openInstance.close();
    },
    handleControlClick: function () {
      if (this.isOpen) {
        this.close();
      } else {
        this.open();
      }
    },
    open: function () {
      var i = 0,
        dropdowns = [];

      this.isOpening = true;
      this.elms.$dropdown.addClass('open');
      this.elms.$control.addClass('active');
      this.elms.$wrapper.addClass('open');

      $('body').on('click.' + this.id, this.handleBodyClick.bind(this));

      if (!this.settings.overrideTimer) {
        this.elms.$dropdown.on(
          'mouseenter', this.closeTimerClear.bind(this)
        ).on(
          'mouseleave', this.closeTimerStart.bind(this)
        );
      }

      dropdowns = customDropdown.instances;

      for (i = 0; i < dropdowns.length; i += 1) {
        if (!dropdowns[i].isOpening) {
          if (dropdowns[i].isOpen) {
            dropdowns[i].close();
          }
        }
      }

      customDropdown.openInstance = this;

      this.isOpen = true;
      this.isOpening = false;
    },
    close: function () {
      $('body').off('click.' + this.id);

      if (!this.settings.overrideTimer) {
        this.elms.$dropdown.off('mouseenter').off('mouseleave');
      }

      this.elms.$wrapper.removeClass('open');
      this.elms.$dropdown.removeClass('open');
      this.elms.$control.removeClass('active');
      this.elms.$select.trigger('blur');
      this.isOpen = false;
    },
    handleDropdownLinkClick: function (event) {
      if ($(event.currentTarget).attr('data-disabled') === 'disabled') {
        return;
      }

      this.select(event);
    },
    select: function (event) {
      var value = '';

      if (event.currentTarget === this.elms.$currentDropdownLink[0]) {
        return;
      }

      this.elms.$currentDropdownLink.removeClass('current');
      this.elms.$currentDropdownLink = $(event.currentTarget);
      this.elms.$currentDropdownLink.addClass('current');
      value = this.elms.$currentDropdownLink.attr('data-value');

      this.elms.$selectedOpt.removeAttr('selected');
      this.elms.$selectedOpt = this.elms.$options.filter('[value="' + value + '"]');
      this.elms.$selectedOpt.attr('selected', 'selected');

      this.elms.$select[0].selectedIndex = this.elms.$options.index(this.elms.$selectedOpt);
      this.elms.$select.val(value).trigger('change');

      this.close();
    },
    changeControlText: function () {
      var snippet = '<a class="{{controlClass}} block-link" {{{selectedAttr}}}>'
          + '{{#selectedSwatch}}'
            + '<img src="{{selectedSwatch}}">'
          + '{{/selectedSwatch}}'
          + '<span class="innerText">{{selectedText}}</span>'
          + '<span class="additionalText">{{additionalText}}</span>'
        + '</a>',
        data = this.collateOptionsData({
          $select: this.elms.$select,
          $options: this.elms.$select.find('option'),
          $selectedOpt: this.elms.$select.find('option:selected')
        }, { control: true });

      this.elms.$control[0].outerHTML = mustache.render(
        snippet, $.extend(true, this.settings, data)
      );
      this.elms.$control = this.elms.$dropdown.find('.' + this.settings.controlClass);
      this.elms.$innerText = this.elms.$control.find('.innerText');
      this.elms.$additionalText = this.elms.$control.find('.additionalText');
    },
    closeTimerClear: function () {
      window.clearTimeout(this.closeTimer);
    },
    closeTimerStart: function () {
      var _this = this;

      this.closeTimer = window.setTimeout(function () {
        _this.close();
      }, 10000);
    },
    update: function () {
      this.updateDropdown({ data: this.collateOptionsData({
        $select: this.elms.$select,
        $options: this.elms.$select.find('option'),
        $selectedOpt: this.elms.$select.find('option:selected')
      }) });
    },
    updateDropdown: function (args) {
      var html = mustache.render(this.settings.template, $.extend(true, this.settings, args.data)),
        node = $.parseHTML($.trim(html), document, true)[0];

      this.elms.$dropdownList[0].innerHTML = $(node).find('ul')[0].innerHTML;
      this.elms.$dropdownLinks = this.elms.$dropdownList.find('a.option');
      this.elms.$currentDropdownLink = this.elms.$dropdownList.find('a.option.current');
      this.elms.$options = this.elms.$select.find('option');
      this.elms.$selectedOpt = this.elms.$select.find('option:selected');
    }
  };

  return customDropdown;
});


define('text!templates/views/swatchVariantView.html',[],function () { return '<div id="{{sViewId}}" class="{{sViewClass}} {{sClassNames}}">\r\n  {{#state.toDisplayOption}}\r\n    <div class="swatch-variant-information">\r\n      <strong>{{props.name}}:</strong> <span class="swatch-variant-display-name">{{props.selectedValue}}</span>\r\n    </div>\r\n    <ul class="swatch-variant" data-variant-group="{{props.internalName}}" data-productID="{{props.productID}}">\r\n      {{#props.links}}\r\n        <li {{#selected}}class="swatch-variant-selected"{{/selected}}>\r\n          <a title="{{value}}" class="{{^available}}swatch-variant-unavailable{{/available}}" data-variant-value="{{value}}"\r\n              data-variant-id="{{id}}" data-product-variant="{{isProductVariant}}" data-variant-group-type="{{props.type}}" data-variant-type="{{type}}">\r\n            <img src="{{swatch}}" title="{{value}}" alt="{{value}}" />\r\n            <span class="swatch-variant-label">{{value}}</span>\r\n          </a>\r\n        </li>\r\n      {{/props.links}}\r\n    </ul>\r\n\r\n    <div class="swatch-variant-mobile">\r\n      {{#state.inDropdown}}\r\n        <div class="select-wrapper">\r\n          <label for="{{props.internalName}}" class="screen-reader">Select {{props.name}}</label>\r\n          <select id="{{props.internalName}}" name="{{props.internalName}}" data-variant-group="{{props.internalName}}" data-productID="{{props.productID}}">\r\n            {{#props.links}}\r\n              <option value="{{id}}" data-variant-id="{{id}}" {{^available}}data-available="false"{{/available}}\r\n                  data-variant-value="{{value}}" data-inventory="{{inventoryMerged}}" {{#selected}}selected="selected"{{/selected}}\r\n                  data-swatch-url="{{swatch}}" data-product-variant="{{isProductVariant}}" data-variant-group-type="{{props.type}}"\r\n                  data-variant-type="{{type}}">\r\n                {{value}}\r\n                {{#inventoryMerged}}\r\n                  {{^available}} - Sold out{{/available}}\r\n                {{/inventoryMerged}}\r\n              </option>\r\n            {{/props.links}}\r\n          </select>\r\n        </div>\r\n      {{/state.inDropdown}}\r\n\r\n      {{^state.inDropdown}}\r\n      <div class="dropdown-customised">\r\n        {{#props.links}}\r\n        <span class="control block-link single-swatch-only {{^available}}swatch-variant-unavailable{{/available}}">\r\n          <img src="{{swatch}}" title="{{value}}" alt="{{value}}" />\r\n          <span class="innerText">\r\n            {{value}}\r\n            {{#inventoryMerged}}\r\n              {{^available}} - Sold out{{/available}}\r\n            {{/inventoryMerged}}\r\n          </span>\r\n        </span>\r\n        {{/props.links}}\r\n      </div>\r\n      {{/state.inDropdown}}\r\n    </div>\r\n  {{/state.toDisplayOption}}\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/SwatchVariantView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/custom-dropdown/oo-dropdown',
  'text!templates/views/swatchVariantView.html'
], function ($, fn, BaseView, customDropdown, template) {
  'use strict';

  /**
   * The view class that renders the color variants.
   * @param {oConfig} oConfig The configuration for the view.
   * @return {void}
   */
  function SwatchVariantView(oConfig) {
    this.sViewName = 'SwatchVariantView';
    this.sNamespace = 'products';
    this.sTag = 'variants';
    this.sViewClass = 'swatch-variant-view';
    this.sTemplate = template;
    this.parent.constructor.call(this, oConfig);
  }

  fn.inherit(SwatchVariantView, BaseView);

  SwatchVariantView._name = 'SwatchVariantView';
  SwatchVariantView.sNamespace = 'products';
  SwatchVariantView.sTag = 'variants';

  SwatchVariantView.prototype._setProps = function (data) {
    var opts = data.vm;

    if (!this.isObject(opts, true)) {
      return null;
    }

    this.forLoop(opts.links, function loopLinks(i) {
      opts.links[i].value = opts.links[i].options[opts.type];
      opts.links[i].swatch = opts.links[i].options.swatch;
    });

    return {
      internalName: opts.internalName,
      links: opts.links,
      name: opts.name,
      productID: data.products.id,
      selectedValue: opts.selectedValue,
      type: opts.type
    };
  };

  SwatchVariantView.prototype._setStates = function (data) {
    var opts = data.vm;

    if (!this.isObject(opts, true)) {
      return null;
    }

    return {
      inDropdown: opts.inDropdown,
      toDisplayOption: opts.toDisplayOption
    };
  };

  SwatchVariantView.prototype._cacheDomElms = function () {
    var $wrapper = null;

    this.parent._cacheDomElms.call(this);
    $wrapper = $(this.oElms.elWrapper);
    this.oElms.$swatchInfo = $wrapper.find('.swatch-variant-information');
    this.oElms.$swatchLinksList = $wrapper.find('.swatch-variant');
    this.oElms.$mobileSwatch = $wrapper.find('.swatch-variant-mobile');
    this.oElms.$mobileSelect = $wrapper.find('select');
  };

  SwatchVariantView.prototype._initDependancies = function () {
    if (this.oElms.$mobileSelect.length > 0) {
      this._dropdown = customDropdown.init(this.oElms.$mobileSelect, {
        $container: $(this.oElms.$mobileSwatch),
        defaultNativeWidth: true,
        overrideDefaultTouch: true,
        overrideTimer: true,
        additionalText: 'View all colours'
      });
    }
  };

  SwatchVariantView.prototype.refresh = function (args) {
    var html = this.render({ mParamData: args.data }),
      node = $.parseHTML($.trim(html), document, true)[0],
      onUpdateInventory = this.isObject(args.data.mvc.flags, true)
          && args.data.mvc.flags.onUpdateInventory;

    if (!onUpdateInventory) {
      this.oElms.$swatchInfo[0].innerHTML = node.querySelectorAll(
        '.swatch-variant-information'
      )[0].innerHTML;

      this.oElms.$swatchLinksList[0].innerHTML = node.querySelectorAll(
        '.swatch-variant'
      )[0].innerHTML;
    }

    this.oElms.$select[0].innerHTML = node.getElementsByTagName('select')[0].innerHTML;

    this._cacheDomElms();

    if (this.isObject(this._dropdown, true)) {
      this._dropdown.update();
    }
  };

  return SwatchVariantView;
});


define('text!templates/views/dropdownVariantView.html',[],function () { return '<div id="{{sViewId}}" class="{{sViewClass}} {{sClassNames}}">\r\n  {{#state.toDisplayOption}}\r\n    <div class="element-wrapper">\r\n      {{#state.inDropdown}}\r\n        <div class="select-wrapper">\r\n          <label for="{{props.internalName}}" class="screen-reader">Select {{props.name}}</label>\r\n          <select id="{{props.internalName}}" name="{{props.internalName}}" data-variant-group="{{props.internalName}}" data-productID="{{props.productID}}">\r\n            {{^state.hideDefaultOption}}\r\n              <option value="" data-variant-value="" data-option-index="-1">\r\n                  Select {{props.name}}\r\n              </option>\r\n            {{/state.hideDefaultOption}}\r\n            {{#props.links}}\r\n              <option value="{{id}}" data-value="{{id}}" {{^subscribable}}{{^available}}disabled="disabled"{{/available}}{{/subscribable}}\r\n                  data-variant-value="{{value}}" data-inventory="{{inventoryMerged}}" {{#selected}}selected="selected"{{/selected}}\r\n                  data-product-variant="{{isProductVariant}}" data-variant-group-type="{{props.type}}" data-variant-type="{{type}}">\r\n                {{value}}\r\n                {{#inventoryMerged}}\r\n                  {{^available}} - Sold out{{/available}}\r\n                {{/inventoryMerged}}\r\n              </option>\r\n            {{/props.links}}\r\n          </select>\r\n        </div>\r\n      {{/state.inDropdown}}\r\n\r\n      {{^state.inDropdown}}\r\n        <strong class="single-variant-type">{{props.name}}</strong>:\r\n        {{#props.links}}\r\n          <span>\r\n            {{value}}\r\n            {{#inventoryMerged}}\r\n              {{^available}} - Sold out{{/available}}\r\n            {{/inventoryMerged}}\r\n          </span>\r\n        {{/props.links}}\r\n      {{/state.inDropdown}}\r\n    </div>\r\n  {{/state.toDisplayOption}}\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/DropdownVariantView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/custom-dropdown/oo-dropdown',
  'modules/tesco.analytics',
  'text!templates/views/dropdownVariantView.html'
], function ($, fn, BaseView, customDropdown, analytics, template) {
  'use strict';

  /**
   * The view class that renders the secondary variants.
   * @param {oConfig} oConfig The configuration for the view.
   * @return {void}
   */
  function DropdownVariantView(oConfig) {
    this.sViewName = 'DropdownVariantView';
    this.sNamespace = 'products';
    this.sTag = 'variants';
    this.sViewClass = 'dropdown-variant-view';
    this.sTemplate = template;
    this.parent.constructor.call(this, oConfig);
  }

  fn.inherit(DropdownVariantView, BaseView);

  DropdownVariantView._name = 'DropdownVariantView';
  DropdownVariantView.sNamespace = 'products';
  DropdownVariantView.sTag = 'variants';

  DropdownVariantView.prototype._setProps = function (data) {
    var opts = data.vm;

    if (!this.isObject(opts, true)) {
      return null;
    }

    this.forLoop(opts.links, function loopLinks(i) {
      opts.links[i].value = opts.links[i].options[opts.type];
      opts.links[i].swatch = opts.links[i].options.swatch;
    });

    return {
      internalName: opts.internalName,
      links: opts.links,
      name: opts.name,
      productID: data.products.id,
      selectedValue: opts.selectedValue,
      type: opts.type
    };
  };

  DropdownVariantView.prototype._setStates = function (data) {
    var opts = data.vm;

    if (!this.isObject(opts, true)) {
      return null;
    }

    return {
      inDropdown: opts.inDropdown,
      toDisplayOption: opts.toDisplayOption
    };
  };

  DropdownVariantView.prototype._cacheDomElms = function () {
    var $wrapper = null;

    this.parent._cacheDomElms.call(this);
    $wrapper = $(this.oElms.elWrapper);
    this.oElms.$select = $wrapper.find('select');
    this.oElms.$firstOption = this.oElms.$select.find('option:first');
  };

  DropdownVariantView.prototype._initDependancies = function () {
    var variantOpts = this.oData.mvc.vm;

    if (this.oElms.$select.length > 0) {
      if (this.oElms.$firstOption.text().toLowerCase().indexOf('select ') > 0) {
        this.oElms.$firstOption.text(this.oElms.$firstOption.text().toUpperCase());
      }

      this._dropdown = customDropdown.init(this.oElms.$select, {
        $container: $(this.oElms.elWrapper),
        defaultNativeWidth: true,
        hasSwatches: !!variantOpts.hasSwatches
      });
    }
  };

  DropdownVariantView.prototype.refresh = function (args) {
    var html = this.render({ mParamData: args.data }),
      node = $.parseHTML($.trim(html), document, true)[0],
      optionsHtml = node.getElementsByTagName('select')[0].innerHTML;

    this.oElms.$select.html(optionsHtml);
    this._cacheDomElms();

    if (this.isObject(this._dropdown, true)) {
      this._dropdown.update();
    }
  };

  DropdownVariantView.prototype._bindEvents = function () {
    var view = this.oData.mvc,
      flags = view.flags || {},
      $wrapper = null;

    $wrapper = $(this.oElms.elWrapper);

    if (flags.outfitBuilder) {
      $wrapper.on(
        'click', '.option', { view: view },
        this._analyticsTracking.bind(this)
      );
    }
  };

  DropdownVariantView.prototype._analyticsTracking = function (event) {
    var mvcData = event.data.view,
      flags = mvcData.flags,
      relationship = '',
      webMetrics = {},
      data = [];

    if (flags.outfitBuilder) {
      relationship = 'Outfit block';
    }

    if (relationship) {
      webMetrics = new analytics.WebMetrics();
      data = [{
        linkTrackEvents: 'event32, event45',
        linkTrackVars: 'prop19, eVar45, prop42, eVar59, events',
        products: ';' + mvcData.products.id + ';;',
        prop19: 'select size',
        eVar45: 'select size',
        prop42: 'pdp - ' + relationship + ' - select size',
        eVar59: 'pdp - ' + relationship + ' - select size',
        events: 'event32, event45'
      }];

      webMetrics.submit(data);
    }
  };

  return DropdownVariantView;
});


define('text!templates/views/variantsView.html',[],function () { return '  <div id="{{sViewId}}" class="{{sViewClass}} {{sClassNames}}">\r\n    {{#aSubViews}}\r\n      {{{render}}}\r\n    {{/aSubViews}}\r\n    {{{oEvent}}}{{{addViewDataAttr}}}\r\n  </div>';});

define('modules/pdp/views/VariantsView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','modules/pdp/views/SwatchVariantView','modules/pdp/views/DropdownVariantView','text!templates/views/variantsView.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    SwatchVariantView = require('modules/pdp/views/SwatchVariantView'),
    DropdownVariantView = require('modules/pdp/views/DropdownVariantView'),
    template = require('text!templates/views/variantsView.html');

  /**
   * The view class that renders the variants.
   * @param {oConfig} oConfig The configuration for the view.
   * @return {void}
   */
  function VariantsView(oConfig) {
    this.sNamespace = 'products';
    this.sTag = oConfig.sTag || 'variants';
    this.sViewName = 'VariantsView';
    this.sViewClass = oConfig.sViewClass || 'variants-view';
    this.sTemplate = template;
    this.sOutput = 'inner';
    this.views = {
      classes: {
        SwatchVariantView: SwatchVariantView,
        DropdownVariantView: DropdownVariantView
      }
    };
    this.parent.constructor.call(this, oConfig);
  }

  fn.inherit(VariantsView, BaseView);

  VariantsView._name = 'VariantsView';
  VariantsView.sNamespace = 'products';
  VariantsView.sTag = 'variants';

  VariantsView.prototype._addSubViews = function () {
    var hidePrimary = this.oData.mvc.flags.hidePrimaryVariant,
      options = this.oData.mvc.vm;

    this.forInLoop(options, function loopOptions(prop) {
      if (this.isObject(options[prop], true)) {
        if ((prop === 'primary' && !hidePrimary) || prop === 'secondary') {
          if (options[prop].hasSwatches) {
            this.oData.aSubViews.push(
              this._compileSubView({
                _class: this.views.classes.SwatchVariantView,
                dataCallback: function filterOptionsData(mvcData) {
                  var _mvcData = mvcData;

                  _mvcData.vm = _mvcData.vm[prop];
                  return _mvcData;
                }
              })
            );
          } else {
            this.oData.aSubViews.push(
              this._compileSubView({
                _class: this.views.classes.DropdownVariantView,
                dataCallback: function filterOptionsData(mvcData) {
                  var _mvcData = mvcData;

                  _mvcData.vm = _mvcData.vm[prop];
                  return _mvcData;
                }
              })
            );
          }
        }
      }
    });
  };

  VariantsView.prototype.refresh = function (args) {
    var subviews = this.oData.aSubViews,
      variantOptions = args.data.mvc.vm;

    fn.loopArray(subviews, function loopViews(i) {
      var subview = subviews[i],
        subviewData = subview.oData;

      subviewData.mvc.vm = variantOptions[subviewData.mvc.vm.type];
      subview.refresh({ data: subviewData });
    });
  };

  module.exports = VariantsView;
});

define('modules/size-guide/sizeGuide', [
    'domlib'
], function ($) {
    'use strict';

    var sizeGuide = {
        isInit: false,
        init: function (options) {
            var optionsCopy = options || {},
                selector = optionsCopy.selector ? optionsCopy.selector : '.size_guide',
                $selector = $(selector),
                $guideWrappers = $selector.find('.guide_wrapper'),
                $guideCheckboxes = $selector.find('.guide_tgl--checkbox');

            // Global
            $guideWrappers.find('th.dual').hide();

            // All references tied to parent wrapper
            $selector.on('click', '.guide_update_trigger', function() {
                var $this = $(this);
                $this.closest('ul').find('button').removeClass('guide_table--active_option').removeAttr('disabled');
                $this.addClass('guide_table--active_option').attr('disabled', true);
                $this.closest('.guide_wrapper').find('tbody th').toggle();
            });

            // Measurement unit switch
            $selector.on('click', '.guide_tgl--btn', function() {
                var $this = $(this),
                  imperialValues = $this.closest('.guide_wrapper').find('.imperial'),
                  metricValues = $this.closest('.guide_wrapper').find('.metric'),
                  imperialTooltip = $this.closest('.guide_wrapper').find('.tooltip.imperial'),
                  metricTooltip = $this.closest('.guide_wrapper').find('.tooltip.metric');

                if ($this.prev('.guide_tgl--checkbox').prop('checked') == false) {
                    $this.prev('.guide_tgl--checkbox').prop('checked', true);

                    metricValues.addClass('guide_unit--switchOut');
                    imperialValues.addClass('guide_unit--switchIn');

                    setTimeout(function(){ imperialValues.show().siblings('.metric').hide().removeClass('guide_unit--switchOut') }, 50);
                    setTimeout(function(){ imperialValues.removeClass('guide_unit--switchIn') }, 100);

                    imperialTooltip.show().removeClass('inactive_tooltip').addClass('active_tooltip');
                    metricTooltip.hide().removeClass('active_tooltip').addClass('inactive_tooltip');
                } else {
                    $this.prev('.guide_tgl--checkbox').prop('checked', false);

                    metricValues.addClass('guide_unit--switchIn');
                    imperialValues.addClass('guide_unit--switchOut');

                    setTimeout(function(){ metricValues.show().siblings('.imperial').hide().removeClass('guide_unit--switchOut'); }, 50);
                    setTimeout(function(){ metricValues.removeClass('guide_unit--switchIn') }, 100);

                    imperialTooltip.hide().removeClass('active_tooltip').addClass('inactive_tooltip');
                    metricTooltip.show().removeClass('inactive_tooltip').addClass('active_tooltip');
                }

                $this.siblings('h5.guide_tgl--label').toggleClass('guide_tgl--active_label');
            });

            sizeGuide.isInit = true;
        },
    }

    return sizeGuide;
});


define('text!templates/views/sizeGuideView.html',[],function () { return '<div id="{{sViewId}}" class="{{sViewClass}} {{sClassNames}}">\r\n  <a class="size-guide-link" data-mvc-model="assets" data-mvc-key="lookupName"\r\n      data-mvc-value="{{mvc.products.custom.sizeGuideLookupName}}">Size guide</a>\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/SizeGuideView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','modules/size-guide/sizeGuide','text!templates/views/sizeGuideView.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    sizeGuide = require('modules/size-guide/sizeGuide'),
    template = require('text!templates/views/sizeGuideView.html');

  /**
   * The view class that renders the size guide link and triggers the display.
   * @param {Object} config The configuration for the view.
   * @return {void}
   */
  function SizeGuideView(config) {
    this.sViewName = 'SizeGuideView';
    this.sNamespace = 'products';
    this.sTag = 'sizeGuide';
    this.sViewClass = 'size-guide';
    this.sTemplate = template;
    this.parent.constructor.call(this, config);
  }

  fn.inherit(SizeGuideView, BaseView);
  SizeGuideView._name = 'SizeGuideView';
  SizeGuideView.sNamespace = 'products';
  SizeGuideView.sTag = 'sizeGuide';

  SizeGuideView.prototype._setData = function (params) {
    this.parent._setData.call(this, params);

    if (!this.oData.mvc.products.custom) {
      this.oData.mvc.products.custom = {};
    }

    this.oData.mvc.products.custom.sizeGuideLookupName = this._getLookupName();
  };

  SizeGuideView.prototype._getLookupName = function () {
    var GENDER_MAP = {
        Mens: 'sizeguideblockmen',
        Womens: 'sizeguideblockwomen',
        Adults: 'sizeguideblockadults',
        Boys: 'sizeguideblockboys',
        Girls: 'sizeguideblockgirls',
        Kids: 'sizeguideblockkids'
      },
      ageSuitability = null,
      key = null;

    key = fn.getValue(this.oData, 'mvc', 'products', 'dynamicAttributes', 'gender');
    if (!key) {
      return '';
    }
    if (key.indexOf('Unisex') >= 0) {
      ageSuitability = fn.getValue(this.oData, 'mvc', 'products', 'dynamicAttributes', 'ageSuitability');
      if (!ageSuitability) {
        return '';
      }
      key = ageSuitability === 'Adult' ? 'Adults' : 'Kids';
    }

    return GENDER_MAP[key] || '';
  };

  SizeGuideView.prototype._cacheDomElms = function () {
    var SIZE_GUIDE = '.size-guide-link';

    this.parent._cacheDomElms.call(this);
    this.oElms.link = $(this.oElms.elWrapper).find(SIZE_GUIDE);
  };

  SizeGuideView.prototype._bindEvents = function () {
    $(this.oElms.link).on(
      'click',
      this._onLinkClick.bind(this)
    );
  };

  SizeGuideView.prototype._onLinkClick = function (eventData) {
    this.compileAndRenderOverlay({
      sTag: 'sizeGuide',
      sClassNames: 'size-guide-overlay',
      elTrigger: eventData.currentTarget,
      sProp: 'text',
      callback: function (selector) {
        sizeGuide.init({ selector: selector });
      }
    }, eventData);
  };

  module.exports = SizeGuideView;
});


define('text!templates/views/personaliseView.html',[],function () { return '<div id="{{sViewId}}" class="{{sViewClass}} {{sClassNames}}">\r\n  {{^state.isPersonalised}}\r\n    <button type="button" class="button primary personalise-button"><span>Personalise me</span></button>\r\n  {{/state.isPersonalised}}\r\n  {{#state.isPersonalised}}\r\n    <a class="edit-personalise-link"><small>Edit personalisation</small></a>\r\n  {{/state.isPersonalised}}\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/PersonaliseView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','text!templates/views/personaliseView.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    template = require('text!templates/views/personaliseView.html');

  /**
   * Add to basket view constructor sets view's core data and calls parent constructor.
   * @param {Object} config The configuration to populate the view's dynamic properties.
   * @return {void}
   */
  function PersonaliseView(config) {
    this.sViewName = 'PersonaliseView';
    this.sNamespace = 'sku';
    this.sTag = 'personalise';
    this.sViewClass = 'personalise-view';
    this.sTemplate = template;
    this.parent.constructor.call(this, config);
  }

  fn.inherit(PersonaliseView, BaseView);
  PersonaliseView._name = 'PersonaliseView';
  PersonaliseView.sNamespace = 'sku';
  PersonaliseView.sTag = 'personalise';

  PersonaliseView.prototype._setStates = function (data) {
    var hasSkuData = this.sanityCheckData(data.sku).objects;

    return {
      isPersonalised: hasSkuData && data.sku.personalisation.isPersonalised
    };
  };

  PersonaliseView.prototype._cacheDomElms = function () {
    var $wrapper = null,
      $personaliseBtn = null,
      $editLink = null;

    this.parent._cacheDomElms.call(this);

    $wrapper = $(this.oElms.elWrapper);
    $personaliseBtn = $wrapper.find('.personalise-button');
    $editLink = $wrapper.find('.edit-personalise-link');

    if ($personaliseBtn.length > 0) {
      this.oElms.personaliseBtn = $personaliseBtn[0];
    }

    if ($editLink.length > 0) {
      this.oElms.editLink = $editLink[0];
    }
  };

  module.exports = PersonaliseView;
});


define('text!templates/views/requestStockAlertView.html',[],function () { return '<form id="{{sViewId}}" class="{{sViewClass}} {{sClassNames}} float-wrapper {{mvc.sellers.buyBoxMessage}}-state">\r\n    <button id="{{mvc.formHandler.id}}" type="button" data-mvc-key="id"\r\n        data-mvc-value="{{mvc.formHandler.id}}" class="button secondary" {{mvc.custom.disabled}}>\r\n      <span>{{mvc.sellers.buyButtonLabel}}</span>\r\n    </button>\r\n    <div class="stock-alert-success">\r\n      <div class="stock-alert-success__box">\r\n        <div class="icon-wrapper"><span class="icon larger" data-icon="5"></span></div>\r\n        <p><small><strong>Your stock alert is set up</strong></small></p>\r\n        <p>We will email you when this item is back in stock</p>\r\n      </div>\r\n      <p class="stock-alert-success__link">\r\n        <a href="/direct/my/email-when-stock-back.page">Manage stock alerts</a> within your account\r\n      </p>\r\n    </div>\r\n    {{{oEvent}}}{{{addViewDataAttr}}}\r\n</form>\r\n';});

define('modules/pdp/views/RequestStockAlertView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','text!templates/views/requestStockAlertView.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    template = require('text!templates/views/requestStockAlertView.html');

  /**
   * Request stock alert view constructor sets view's core data and calls parent constructor.
   * @param {Object} oConfig The configuration to populate the view's dynamic properties.
   * @return {void}
   */
  function RequestStockAlertView(oConfig) {
    this.sViewName = 'RequestStockAlertView';
    this.sNamespace = 'formHandler';
    this.sTag = 'requestStockAlert';
    this.sViewClass = 'request-stock-alert-view';
    this.sTemplate = template;
    this.parent.constructor.call(this, oConfig);
  }

  fn.inherit(RequestStockAlertView, BaseView);
  RequestStockAlertView._name = 'RequestStockAlertView';
  RequestStockAlertView.sNamespace = 'formHandler';
  RequestStockAlertView.sTag = 'requestStockAlert';

  RequestStockAlertView.prototype._setData = function (params) {
    var STOCK_ALERT_SET = 'stock-alert-set ';

    this.parent._setData.call(this, params);

    if (!this.oData.mvc.sellers.formHandler) {
      this.oData.sClassNames += STOCK_ALERT_SET;
    }

    if (this.oData.mvc.flags.disabled) {
      this.oData.mvc.custom.disabled = 'disabled';
    }
  };

  RequestStockAlertView.prototype.enable = function () {
    this.oData.mvc.flags.disabled = false;
    this.oElms.elSubmitBtn.disabled = false;
  };

  RequestStockAlertView.prototype.disable = function () {
    this.oData.mvc.flags.disabled = true;
    this.oElms.elSubmitBtn.disabled = true;
  };

  RequestStockAlertView.prototype._cacheDomElms = function () {
    var $wrapper = null;

    this.parent._cacheDomElms.call(this);
    $wrapper = $(this.oElms.elWrapper);
    this.oElms.elSubmitBtn = $wrapper.find('button')[0];
  };

  module.exports = RequestStockAlertView;
});


define('text!templates/views/itemActionsView.html',[],function () { return '<div id="{{sViewId}}" class="{{sViewClass}} {{sClassNames}}">\r\n  {{#aSubViews}}\r\n      {{{render}}}\r\n  {{/aSubViews}}\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/ItemActionsView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','modules/pdp/views/SizeGuideView','modules/pdp/views/AddToBasketView','modules/pdp/views/PersonaliseView','modules/pdp/views/RequestStockAlertView','text!templates/views/itemActionsView.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    SizeGuideView = require('modules/pdp/views/SizeGuideView'),
    AddToBasketView = require('modules/pdp/views/AddToBasketView'),
    PersonaliseView = require('modules/pdp/views/PersonaliseView'),
    RequestStockAlertView = require('modules/pdp/views/RequestStockAlertView'),
    template = require('text!templates/views/itemActionsView.html');

  /**
   * The view class that renders an item's actions such as add to basket button.
   * @param {Object} config The configuration for the view.
   * @return {void}
   */
  function ItemActionsView(config) {
    this.sViewName = 'ItemActionsView';
    this.sNamespace = 'inherit';
    this.sTag = 'itemActions';
    this.sViewClass = 'item-actions-view';
    this.sTemplate = template;
    this.parent.constructor.call(this, config);

    this._conditionalEventData = {
      isBound: false,
      sellerId: ''
    };
  }

  fn.inherit(ItemActionsView, BaseView);
  ItemActionsView._name = 'ItemActionsView';
  ItemActionsView.sNamespace = 'inherit';
  ItemActionsView.sTag = 'itemActions';

  ItemActionsView.prototype._setData = function (params) {
    this.parent._setData.call(this, params);
    this._setRefreshPoint();
  };

  ItemActionsView.prototype._addSubViews = function () {
    var hasSkuData = this.sanityCheckData(this.oData.mvc.sku).objects,
      skuData = hasSkuData && this.oData.mvc.sku,
      personalisable = this.isObject(skuData.attributes, true)
          && skuData.attributes.personalisable === 'Y',
      hasPersonalisationData = this.isObject(skuData.personalisation, true),
      isPersonalised = hasPersonalisationData && skuData.personalisation.isPersonalised;

    if (this._toRenderSizeGuide()) {
      this.oData.aSubViews.push(
        this._compileSubView({ _class: SizeGuideView })
      );
    }

    if (this.oData.mvc.inherit.buyBoxMessage) {
      if (this.oData.mvc.inherit.buyBoxMessage === 'emwbis') {
        if (!this.oData.mvc.flags.isKiosk) {
          this.oData.aSubViews.push(
            this._compileSubView({ _class: RequestStockAlertView })
          );
        }
      } else if (this.oData.mvc.inherit.buyBoxMessage !== 'none') {
        if (!personalisable || (personalisable && hasPersonalisationData && isPersonalised)) {
          this.oData.aSubViews.push(
            this._compileSubView({ _class: AddToBasketView })
          );
        }

        if (personalisable && hasPersonalisationData) {
          this.oData.aSubViews.push(
            this._compileSubView({ _class: PersonaliseView })
          );
        }
      }
    } else {
      this.oData.mvc.flags.disabled = true;
      this.oData.mvc.sellers = {
        buyBoxMessage: 'buy',
        buyButtonLabel: 'Add to basket'
      };

      this.oData.aSubViews.push(
        this._compileSubView({
          _class: AddToBasketView, flags: { required: { data: false } }
        })
      );
    }
  };

  ItemActionsView.prototype._toRenderSizeGuide = function () {
    if (this.isObject(this.oData.mvc.products, true)) {
      if (this.isObject(this.oData.mvc.products.dynamicAttributes, true)
          && this.oData.mvc.products.dynamicAttributes.supplier === 'FF'
          && this.oData.mvc.products.dynamicAttributes.gender) {
        if (this.oData.mvc.products.dynamicAttributes.gender !== 'Unisex') {
          return true;
        }

        if (this.oData.mvc.products.dynamicAttributes.ageSuitability) {
          return true;
        }
      }
    }

    return false;
  };

  ItemActionsView.prototype.refresh = function (params) {
    this.sNamespace = params.sNamespace;
    this.oData.aSubViews = [];

    this.mergeObjects(this.oData.mvc, params.mParamData.mvc, { extend: true });

    this.render({
      sourceOutput: 'inner',
      sOutput: 'inner',
      elTarget: 'self'
    });
  };

  module.exports = ItemActionsView;
});


define('text!templates/views/productRatingsView.html',[],function () { return '<div id="{{sViewId}}" class="{{sViewClass}} {{sClassNames}}">\r\n  <a href="{{mvc.inherit.publicLink}}{{#mvc.inherit.noofRatingsProduced}}#BVRRContainer{{/mvc.inherit.noofRatingsProduced}}">\r\n      <span class="avg-rating rating">\r\n          <span class="screen-reader-text">Rating:</span>\r\n          {{#mvc.inherit.noofRatingsProduced}}\r\n              <span class="stars stars-{{mvc.inherit.custom.numOfStars}} point-{{mvc.inherit.custom.numOfPoints}}">\r\n                {{mvc.inherit.custom.numOfStars}}\r\n                {{#mvc.inherit.custom.numOfPoints}}.{{mvc.inherit.custom.numOfPoints}}{{/mvc.inherit.custom.numOfPoints}} stars\r\n              </span>\r\n          {{/mvc.inherit.noofRatingsProduced}}\r\n          {{^mvc.inherit.noofRatingsProduced}}\r\n              <span class="stars stars-0">No rating</span>\r\n          {{/mvc.inherit.noofRatingsProduced}}\r\n      </span>\r\n      <small class="total-reviews smaller" data-review="{{mvc.inherit.noofRatingsProduced}}">\r\n          {{#mvc.inherit.noofRatingsProduced}}\r\n              ({{mvc.inherit.noofRatingsProduced}})\r\n          {{/mvc.inherit.noofRatingsProduced}}\r\n          {{^mvc.inherit.noofRatingsProduced}}\r\n              (No Reviews)\r\n          {{/mvc.inherit.noofRatingsProduced}}\r\n      </small>\r\n  </a>\r\n</div>\r\n';});

define('modules/pdp/views/ProductTileRatingsView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','text!templates/views/productRatingsView.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    template = require('text!templates/views/productRatingsView.html');

  /**
   * The view class that renders the outfit item view.
   * @param {oConfig} oConfig The configuration for the view.
   * @return {void}
   */
  function ProductTileRatingsView(oConfig) {
    this.sViewName = 'ProductTileRatingsView';
    this.sNamespace = 'inherit';
    this.sTag = 'ratings';
    this.sViewClass = 'product-ratings';
    this.sTemplate = template;
    this.parent.constructor.call(this, oConfig);
  }

  fn.inherit(ProductTileRatingsView, BaseView);
  ProductTileRatingsView._name = 'ProductTileRatingsView';
  ProductTileRatingsView.sNamespace = 'inherit';
  ProductTileRatingsView.sTag = 'ratings';

  ProductTileRatingsView.prototype._setData = function (params) {
    this.parent._setData.call(this, params);
    this.oData.mvc.inherit.custom = this._sanitiseDataForView(this.oData.mvc.inherit.avgRating);
  };

  ProductTileRatingsView.prototype._sanitiseDataForView = function (avgRating) {
    var output = {},
      calculateNumOfStars = null,
      calculateNumOfPoints = null;

    calculateNumOfStars = function (rating) {
      if ((rating >= 4.875) && (rating <= 5)) {
        return 5;
      }
      if ((rating >= 3.875) && (rating < 4.875)) {
        return 4;
      }
      if ((rating >= 2.875) && (rating < 3.875)) {
        return 3;
      }
      if ((rating >= 1.875) && (rating < 2.875)) {
        return 2;
      }
      if ((rating > 0) && (rating < 1.875)) {
        return 1;
      }
      return 0;
    };

    calculateNumOfPoints = function (rating) {
      var points = 0,
        decimalPart = 0;

      if (rating) {
        if ((rating > 0) && (rating < 1.125)) {
          return 0;
        }
        decimalPart = rating % 1;

        if (decimalPart >= 0.125 && decimalPart < 0.375) {
          points = 25;
        }
        if (decimalPart >= 0.375 && decimalPart < 0.625) {
          points = 5;
        }
        if (decimalPart >= 0.625 && decimalPart < 0.875) {
          points = 75;
        }
        if (decimalPart >= 0.875 || decimalPart < 0.125) {
          points = 0;
        }
      }
      return points;
    };

    output.numOfPoints = calculateNumOfPoints(avgRating);
    output.numOfStars = calculateNumOfStars(avgRating);

    return output;
  };

  ProductTileRatingsView.prototype.refresh = function (params) {
    this.sNamespace = params.sNamespace;

    this.render({
      newEvent: true,
      sourceOutput: 'inner',
      sOutput: 'inner',
      elTarget: 'self',
      mParamData: params.mParamData
    });
  };

  module.exports = ProductTileRatingsView;
});


define('text!templates/views/productTileView.html',[],function () { return '<div id="{{sViewId}}" class="product-tile {{sViewClass}} {{props.classNames}}">\r\n  <div class="product-tile-section-one">\r\n    {{#views.ProductTileImageView}}\r\n      {{{render}}}\r\n    {{/views.ProductTileImageView}}\r\n  </div>\r\n  <div class="product-tile-section-two">\r\n    {{#views.ProductTileTitleView}}\r\n      {{{render}}}\r\n    {{/views.ProductTileTitleView}}\r\n    {{#views.ProductPriceView}}\r\n      {{{render}}}\r\n    {{/views.ProductPriceView}}\r\n    {{#views.ProductTileRatingsView}}\r\n      {{{render}}}\r\n    {{/views.ProductTileRatingsView}}\r\n    {{#views.VariantsView}}\r\n      {{{render}}}\r\n    {{/views.VariantsView}}\r\n    {{#views.ItemActionsView}}\r\n      {{{render}}}\r\n    {{/views.ItemActionsView}}\r\n  </div>\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/ProductTileView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','modules/pdp/views/ProductTileTitleView','modules/pdp/views/ProductTileImageView','modules/pdp/views/ProductPriceView','modules/pdp/views/VariantsView','modules/pdp/views/ItemActionsView','modules/pdp/views/ProductTileRatingsView','text!templates/views/productTileView.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    ProductTileTitleView = require('modules/pdp/views/ProductTileTitleView'),
    ProductTileImageView = require('modules/pdp/views/ProductTileImageView'),
    ProductPriceView = require('modules/pdp/views/ProductPriceView'),
    VariantsView = require('modules/pdp/views/VariantsView'),
    ItemActionsView = require('modules/pdp/views/ItemActionsView'),
    ProductTileRatingsView = require('modules/pdp/views/ProductTileRatingsView'),
    template = require('text!templates/views/productTileView.html');

  /**
   * The view class that renders the outfit item product tile.
   * @param {Object} config The configuration for the view.
   * @return {void}
   */
  function ProductTileView(config) {
    this.sViewName = 'ProductTileView';
    this.sNamespace = 'inherit';
    this.sTag = 'recommender';
    this.sViewClass = 'outfit-product-tile';
    this.sTemplate = template;
    this.parent.constructor.call(this, config);
  }

  fn.inherit(ProductTileView, BaseView);

  ProductTileView._name = 'ProductTileView';
  ProductTileView.sNamespace = 'inherit';
  ProductTileView.sTag = 'recommender';

  ProductTileView.prototype._setData = function (args) {
    this.parent._setData.call(this, args);
    this._setRefreshPoint();
    this.oData.mvc.flags.isRecommenderVariant = true;
  };

  ProductTileView.prototype._setProps = function (data) {
    var flags = data.flags,
      CLASS_NAME = 'outfit-product-tile-range';

    return {
      classNames: flags.shopTheRange ? CLASS_NAME : ''
    };
  };

  ProductTileView.prototype._addSubViews = function () {
    var views = {},
      mvcData = this.oData.mvc,
      flags = mvcData.flags,
      sellerData = mvcData.sellers;

    views.ProductTileImageView = this._compileSubView({ _class: ProductTileImageView });
    views.ProductTileTitleView = this._compileSubView({ _class: ProductTileTitleView });

    views.ProductPriceView = this._compileSubView({
      _class: ProductPriceView,
      namespace: flags.bundle && 'sellers',
      state: { showSavings: flags.showPriceSavings || false, showPoints: false }
    });

    if (flags.showRatings) {
      views.ProductTileRatingsView = this._compileSubView({ _class: ProductTileRatingsView });
    }

    if (flags.showVariants) {
      views.VariantsView = this._compileSubView({ _class: VariantsView, ctlr: true });
    }

    if (flags.showItemActions) {
      views.ItemActionsView = this._compileSubView({
        _class: ItemActionsView,
        namespace: fn.isObject(sellerData, { notEmpty: true }) ? 'sellers' : this.sNamespace
      });
    }

    this.oData.views = views;
  };

  ProductTileView.prototype.refresh = function (params) {
    var views = this.oData.views,
      flags = this.oData.mvc.flags;

    if (this.isObject(params.inherit, true)) {
      this.sNamespace = params.inherit.namespace;
      this.oModel = params.inherit.model;
    }

    this.oData.mvc.inherit = null;
    this.mergeObjects(this.oData.mvc, params.mParamData.mvc, { extend: true });

    views.ProductTileImageView.refresh({
      sNamespace: this.sNamespace,
      mParamData: this._compileSubView({
        _class: ProductTileImageView,
        namespace: this.sNamespace,
        returnData: true
      })
    });

    views.ProductTileTitleView.refresh({
      sNamespace: this.sNamespace,
      mParamData: this._compileSubView({
        _class: ProductTileTitleView,
        namespace: this.sNamespace,
        returnData: true
      })
    });

    views.ProductPriceView.refresh({
      sNamespace: 'sellers',
      mParamData: this._compileSubView({
        _class: ProductPriceView,
        namespace: 'sellers',
        returnData: true
      })
    });

    if (flags.showRatings) {
      views.ProductTileRatingsView.refresh({
        sNamespace: this.sNamespace,
        mParamData: this._compileSubView({
          _class: ProductTileRatingsView,
          namespace: this.sNamespace,
          returnData: true
        })
      });
    }

    if (flags.showItemActions) {
      views.ItemActionsView.refresh({
        sNamespace: 'sellers',
        mParamData: this._compileSubView({
          _class: ItemActionsView,
          namespace: 'sellers',
          returnData: true
        })
      });
    }
  };

  module.exports = ProductTileView;
});


define('text!templates/views/bundleView.html',[],function () { return '<div id="{{sViewId}}" class="{{sViewClass}} {{sClassNames}}">\r\n  {{#props.primary}}\r\n    <div class="bundle-primary">\r\n      <div class="primary-info">\r\n        <p>{{tileHeading}}</p>\r\n      </div>\r\n      {{#view}}\r\n        {{{render}}}\r\n      {{/view}}\r\n    </div>\r\n  {{/props.primary}}\r\n  {{#props.recommendations}}\r\n    <div class="bundle-secondary">\r\n      <label for="{{id}}" data-catID="{{catID}}">\r\n        <input type="checkbox" id="{{id}}" class="bundle-checkbox"\r\n            {{#checked}}checked="checked"{{/checked}}>\r\n        <div class="check-box pull-left-all"></div>\r\n        <div class="label">{{checkboxLabel}}</div>\r\n      </label>\r\n      {{#view}}\r\n        {{{render}}}\r\n      {{/view}}\r\n    </div>\r\n  {{/props.recommendations}}\r\n  <div class="bundle-actions-wrapper">\r\n    <div class="bundle-actions">\r\n      <div class="bundle-actions-inner">\r\n        <p class="larger">Bundle price</p>\r\n        <div class="bundle-price">\r\n          <span class="product-price larger" itemprop="price">&pound;{{props.price}}</span>\r\n        </div>\r\n        {{#views.addToBasket}}\r\n          {{{render}}}\r\n        {{/views.addToBasket}}\r\n      </div>\r\n    </div>\r\n  </div>\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/BundleView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','modules/pdp/views/ProductTileView','modules/pdp/views/ProductPriceView','modules/pdp/views/AddToBasketView','text!templates/views/bundleView.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    ProductTileView = require('modules/pdp/views/ProductTileView'),
    ProductPriceView = require('modules/pdp/views/ProductPriceView'),
    AddToBasketView = require('modules/pdp/views/AddToBasketView'),
    template = require('text!templates/views/bundleView.html');

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function BundleView(config) {
    this.sViewName = 'BundleView';
    this.sNamespace = 'inherit';
    this.sTag = 'bundle';
    this.sViewClass = 'bundle-view';
    this.sTemplate = template;

    this.views = {
      classes: {
        ProductTileView: ProductTileView,
        ProductPriceView: ProductPriceView,
        AddToBasketView: AddToBasketView
      }
    };
    this.parent.constructor.call(this, config);
  }

  fn.inherit(BundleView, BaseView);
  BundleView._name = 'BundleView';
  BundleView.sNamespace = 'inherit';
  BundleView.sTag = 'bundle';

  BundleView.prototype._cacheDomElms = function () {
    var $wrapper = null;

    this.parent._cacheDomElms.call(this);
    $wrapper = $(this.oElms.elWrapper);
    this.oElms.$labels = $wrapper.find('div.bundle-secondary label');
    this.oElms.$price = $wrapper.find('div.bundle-price span.product-price');
  };

  BundleView.prototype._setProps = function (data) {
    var primary = {},
      recommendations = {},
      type = '',
      viewModel = data.viewModel;

    if (!this.isObject(viewModel, true)) {
      return {};
    }

    type = viewModel.type;

    primary = data.viewModel.primary;
    primary.view = this._compileSubView({
      _class: this.views.classes.ProductTileView,
      mvcData: fn.mergeObjects(data, primary),
      namespace: type
    });

    recommendations = data.viewModel.recommendations;
    this.forLoop(recommendations, function loopSecondarySkus(i) {
      recommendations[i].view = this._compileSubView({
        _class: this.views.classes.ProductTileView,
        mvcData: fn.mergeObjects(data, recommendations[i]),
        namespace: type
      });
    });

    return {
      primary: primary,
      recommendations: recommendations,
      price: viewModel.price
    };
  };

  BundleView.prototype._addSubViews = function () {
    var addToBasket = this.oData.views.addToBasket,
      data = this.oData.mvc;

    if (this.isObject(addToBasket, true)) {
      return;
    }

    addToBasket = this._compileSubView({
      _class: this.views.classes.AddToBasketView,
      flags: { disabled: data.flags.disableAddToBasket }
    });

    this.oData.views.addToBasket = addToBasket;
  };

  BundleView.prototype.refresh = function (args) {
    var $node = $(this.parseHtml(
        { html: this.render({ mParamData: { mvc: args.data } }), trim: true }
      )),
      $labels = $node.find('div.bundle-secondary label'),
      addToBasket = this.oData.views.addToBasket;

    if (typeof args.activeID === 'string') {
      this.oElms.$labels.filter(
        'label[for="' + args.activeID + '"]'
      )[0].innerHTML = $labels.filter('label[for="' + args.activeID + '"]')[0].innerHTML;
    } else {
      this.forLoop(this.oElms.$labels, function loopCachedLabels(i) {
        this.forLoop($labels, function loopNewLabels(j) {
          if (this.oElms.$labels[i].getAttribute('for') === $labels[j].getAttribute('for')) {
            fn.refreshElement(this.oElms.$labels[i], $labels[j]);
          }
        });
      });
    }

    fn.refreshElement(
      this.oElms.$price[0],
      $node.find('div.bundle-price span.product-price')[0]
    );
    addToBasket.refresh({ data: args.data });
  };

  module.exports = BundleView;
});

define('modules/pdp/controllers/BundleController',['require','exports','module','modules/mvc/fn','modules/pdp/controllers/BaseController','modules/pdp/views/BundleView'],function (require, exports, module) {
  'use strict';


  var fn = require('modules/mvc/fn'),
    BaseController = require('modules/pdp/controllers/BaseController'),
    BundleView = require('modules/pdp/views/BundleView');


  /**
   *
   * @param {Array<Objects>} models
   * @return {void}
   */
  function BundleController(models) {
    var pageController = fn.getValue(window, 'oAppController', 'oPageController');

    this.sNamespace = 'inherit';
    this.sTag = 'bundle';
    this.views = { classes: { BundleView: BundleView } };
    this.parent.constructor.call(this, models);

    if (fn.isObject(pageController) && typeof pageController.setScrollAction === 'function') {
      pageController.setScrollAction({
        callback: this._analyticsTracking,
        once: true,
        scope: this
      });
    }
  }


  fn.inherit(BundleController, BaseController);
  BundleController.modelNames = [
    'formHandler', 'inventoryProduct', 'inventorySKU', 'products', 'sellers', 'sku'
  ];


  /**
   *
   * @param {Object} args
   * @param {JQueryDeferred} args.deferred
   * @param {Object} [args.filterOptions]
   * @param {Object} args.mParamData
   * @param {Object} args.mParamData.mvc
   * @param {Function} [args.mParamData.mvc.destroyRootView]
   * @param {Array<Object>} args.mParamData.mvc.items
   * @return {void}
   */
  BundleController.prototype._collateDataDependancies = function (args) {
    var _this = this,
      _args = args,
      filterOptions = _args.filterOptions || {},
      flags = {},
      mvcData = _args.mParamData.mvc,
      masterDeferred = _args.deferred,
      promise = {},
      rejectDeferred = this._setRejectDeferredMethod(mvcData.destroyRootView, masterDeferred);

    if (!fn.isArray(mvcData.items, { notEmpty: true })) {
      rejectDeferred();
      return;
    }

    flags = mvcData.flags || {};
    filterOptions.type = flags.richRelevance ? 'products' : 'sku';

    if (flags.richRelevance) {
      promise = this._compileSkuData(mvcData);
    } else {
      promise = this._compileProductData(mvcData);
    }

    promise
      .done(function handleCompileDataSuccess(compiledData) {
        fn.mergeObjects(mvcData, compiledData, { extend: true });
        delete mvcData.items;

        _this._collateListingPrices(mvcData)
          .done(function handleCollateListingPricesSuccess(listingPricesResp) {
            fn.mergeObjects(mvcData, listingPricesResp, { extend: true });

            _this._collateInventoryData(mvcData, filterOptions)
              .done(function handleCollateInventoryDataSuccess(inventoryDataResp) {
                if (inventoryDataResp) {
                  mvcData.recommendations = inventoryDataResp;
                }

                mvcData.recommendations = _this._filterItems(mvcData, filterOptions);

                if (!mvcData.recommendations.length) {
                  rejectDeferred();
                }

                mvcData.flags = flags;
                _args.mParamData.mvc = _this._setViewModel(mvcData, filterOptions.type);
                masterDeferred.resolve(_args);
              })
              .fail(function handleCollateInventoryDataFailure() {
                rejectDeferred();
              });
          })
          .fail(function handleCollateListingPricesFailure() {
            rejectDeferred();
          });
      })
      .fail(function handleCompileDataFailure() {
        rejectDeferred();
      });
  };


  /**
   *
   * @param {Object} mvcData
   * @param {Array<Object>} mvcData.items
   * @return {JQueryPromise}
   */
  BundleController.prototype._compileSkuData = function (mvcData) {
    var activeSku = {},
      deferred = $.Deferred(),
      productModel = this.models.products,
      recommendations = [],
      skuModel = this.models.sku;

    fn.loopArray(mvcData.items, function loopItems(i) {
      var item = mvcData.items[i];

      recommendations.push({
        products: item,
        sellers: {},
        sku: productModel.getDefaultSku(item)
      });
    });

    productModel.getDataStores({
      fetch: true,
      value: fn.isObject(mvcData.products) ? mvcData.products.id : mvcData.products
    })
      .done(function handleGetProductDataStoesSuccess() {
        skuModel.getDataStores({
          fetch: true,
          value: [mvcData.sku].concat(recommendations.map(function (rec) {
            return rec.sku.id;
          }))
        })
          .done(function handleGetSkuDataStoresSuccess(skus) {
            activeSku = skus.shift();

            fn.loopArray(recommendations, function loopRecommendations(i) {
              var recommendation = recommendations[i];

              fn.loopArray(skus, function loopSkus(j) {
                var sku = skus[j];

                if (recommendation.sku.id === sku.id) {
                  recommendation.sku = sku;
                  recommendation.sellers = skuModel.getPrimaryListing(sku);
                }
              });
            });

            deferred.resolve({
              recommendations: recommendations,
              sellers: skuModel.getPrimaryListing(activeSku),
              sku: activeSku
            });
          })
          .fail(function handleGetSkuDataStoresFailure() {
            deferred.reject();
          });
      })
      .fail(function handleGetProductDataStoresFailure() {
        deferred.reject();
      });

    return deferred.promise();
  };


  /**
   *
   * @param {Object} mvcData
   * @param {Object} mvcData.items
   * @return {JQueryPromise}
   */
  BundleController.prototype._compileProductData = function (mvcData) {
    var deferred = $.Deferred(),
      recommendations = [],
      productModel = this.models.products,
      skuModel = this.models.sku;

    fn.loopArray(mvcData.items, function loopItems(i) {
      var item = mvcData.items[i];

      recommendations.push({
        products: skuModel.getParentProduct(item),
        sellers: skuModel.getPrimaryListing(item),
        sku: item
      });
    });

    productModel.getDataStores({
      fetch: true,
      value: fn.isObject(mvcData.products) ? mvcData.products.id : mvcData.products
    })
      .done(function handleGetProductDataStoresSuccess(product) {
        skuModel.getDataStores({
          fetch: true,
          value: fn.isObject(mvcData.sku) ? mvcData.sku.id : mvcData.sku
        })
          .done(function handleGetSkuDataStoresSuccess(sku) {
            deferred.resolve({
              products: product,
              recommendations: recommendations,
              sellers: skuModel.getPrimaryListing(sku)
            });
          })
          .fail(function handleGetSkuDataStoresFailure() {
            deferred.reject();
          });
      })
      .fail(function handleGetProductDataStoresFailure() {
        deferred.reject();
      });

    return deferred.promise();
  };


  /**
   *
   * @param {Object} mvcData
   * @param {Object} mvcData.items
   * @return {JQueryPromise}
   */
  BundleController.prototype._collateListingPrices = function (mvcData) {
    var deferred = $.Deferred(),
      recommendations = mvcData.recommendations,
      sellers = mvcData.sellers,
      skuIDs = [mvcData.sku.id],
      skuModel = this.models.sku;

    skuIDs = skuIDs.concat(recommendations.map(function (rec) {
      return rec.sku.id;
    }));
    skuIDs = skuIDs.join();

    skuModel.fetch({
      mSearchValue: skuIDs,
      sModelMethod: 'price',
      createEndpointCallback: function addQueryParams(url) {
        return url + '?format=standard';
      },
      doneCallback: function fetchPricesDoneCallback(resp) {
        var skuPrices = fn.getValue(resp, 'skus');

        if (!fn.isArray(skuPrices, { notEmpty: true })) {
          deferred.reject();
          return;
        }

        fn.loopArray(skuPrices, function loopSkuPrices(i) {
          var listingPrices = [];

          if (!skuPrices[i] || skuPrices[i].error) {
            return;
          }

          listingPrices = skuPrices[i].listings;

          fn.loopArray(listingPrices, function loopListingPrices(j) {
            var listingPrice = listingPrices[j];

            if (listingPrice.id === sellers.id) {
              sellers.prices = listingPrice;
              return;
            }

            fn.loopArray(recommendations, function loopRecommendations(k) {
              var recommendation = recommendations[k];

              if (listingPrice.id === recommendation.sellers.id) {
                recommendation.sellers.prices = listingPrice;
              }
            });
          });
        });

        deferred.resolve({
          recommendations: recommendations,
          sellers: sellers
        });
      }
    });

    return deferred.promise();
  };


  /**
   *
   * @param {Object} mvcData
   * @param {Object} filterOptions
   * @return {JQueryPromise}
   */
  BundleController.prototype._collateInventoryData = function (mvcData, filterOptions) {
    var deferred = $.Deferred(),
      flags = mvcData.flags,
      inventoryModel = {},
      models = this.models,
      recommendations = mvcData.recommendations,
      type = filterOptions.type;

    if (!filterOptions.inventory) {
      deferred.resolve();
      return deferred.promise();
    }

    inventoryModel = flags.richRelevance ? models.inventoryProduct : models.inventorySKU;

    inventoryModel.getDataStores({
      fetch: true,
      value: recommendations.map(function (recommendation) {
        return recommendation[type].id;
      })
    })
      .done(function handleInventoryModelSuccess(inventory) {
        fn.loopArray(recommendations, function loopRecommendations(i) {
          fn.loopArray(inventory, function loopInventory(j) {
            if (recommendations[i][type].id === inventory[j].id) {
              recommendations[i][type].inventory = inventory[j];
            }
          });
        });

        deferred.resolve(recommendations);
      })
      .fail(function handleInventoryModelFailure() {
        deferred.reject();
      });

    return deferred.promise();
  };


  /**
   *
   * @param {Object} mvcData
   * @param {Object} filterOptions
   * @param {Object} [filterOptions.category]
   * @param {Object} [filterOptions.inventory]
   * @param {string} filterOptions.type
   * @return {Array<Object>}
   */
  BundleController.prototype._filterItems = function (mvcData, filterOptions) {
    var recommendations = mvcData.recommendations,
      type = filterOptions.type;

    recommendations = this._defaultFilter(recommendations);

    if (fn.isObject(filterOptions.category, { notEmpty: true })) {
      recommendations = this._filterCategory(recommendations, type, filterOptions.category || {});
    }

    if (fn.isObject(filterOptions.inventory, { notEmpty: true })) {
      recommendations = this._filterInventory(recommendations, type, filterOptions.inventory || {});
    }

    return recommendations;
  };


  /**
   *
   * @param {Array<Object>} recommendations
   * @return {Array<Object>}
   */
  BundleController.prototype._defaultFilter = function (recommendations) {
    var sellerModel = this.models.sellers;

    fn.loopArray(recommendations, function loopRecommendations(i) {
      if (!fn.isObject(sellerModel.getPrices(recommendations[i].sellers), { notEmpty: true })) {
        recommendations.splice(i, 1);
      }
    }, { backward: true });

    return recommendations;
  };


  /**
   *
   * @param {Array<Object>} recommendations
   * @param {string} type
   * @param {Object} options
   * @param {Boolean} [options.unique]
   * @return {Array<Object>}
   */
  BundleController.prototype._filterCategory = function (recommendations, type, options) {
    var _recommendations = recommendations;

    if (options.unique) {
      _recommendations = this._filterUnique(_recommendations, type);
    }

    return _recommendations;
  };


  /**
   *
   * @param {Array<Object>} recommendations
   * @param {string} type
   * @return {Array<Object>}
   */
  BundleController.prototype._filterUnique = function (recommendations, type) {
    var model = this.models[type],
      uniqueIDs = [],
      uniqueRecommendations = [];

    fn.loopArray(recommendations, function loopRecommendations(i) {
      var catID = model.getParentCategory(recommendations[i][type]).id;

      if (uniqueIDs.indexOf(catID) === -1) {
        uniqueIDs.push(catID);
        uniqueRecommendations.push(recommendations[i]);
      }
    });

    return uniqueRecommendations;
  };


  /**
   *
   * @param {Array<Object>} recommendations
   * @param {string} type
   * @param {Object} options
   * @param {boolean} options.available
   * @param {boolean} options.subscribable
   * @return {Array<Object>}
   */
  BundleController.prototype._filterInventory = function (recommendations, type, options) {
    fn.loopArray(recommendations, function loopData(i) {
      if (!recommendations[i][type].inventory.available && options.available) {
        recommendations.splice(i, 1);
      } else if (!recommendations[i][type].inventory.subscribable && options.subscribable) {
        recommendations.splice(i, 1);
      }
    }, { backward: true });

    return recommendations;
  };


  /**
   *
   * @param {Object} mvcData
   * @param {string} type
   * @return {Object}
   */
  BundleController.prototype._setViewModel = function (mvcData, type) {
    return this._setDynamicViewData(this._setStaticViewData(mvcData, type));
  };


  /**
   *
   * @param {Object} mvcData
   * @param {Object} mvcData.flags
   * @param {Object} mvcData.products
   * @param {Array<Object>} mvcData.recommendations
   * @param {Object} mvcData.sku
   * @param {string} type
   * @return {Object}
   */
  BundleController.prototype._setStaticViewData = function (mvcData, type) {
    var _mvcData = mvcData,
      buyButtonLabel = '',
      flags = _mvcData.flags,
      formhandlerModel = this.models.formHandler,
      productModel = this.models.products,
      urlParams = '',
      viewModel = {};

    if (flags.inBasketOverlay) {
      buyButtonLabel = 'Update basket';
      urlParams = '?multipleItems=true&inBasketOverlay=true';
    } else {
      buyButtonLabel = 'Add to basket';
      urlParams = '?multipleItems=true';
    }

    flags.showProductRatings = false;
    flags.hideQuantity = true;

    viewModel = {
      primary: { products: _mvcData.products, sellers: _mvcData.sellers, sku: _mvcData.sku },
      recommendations: _mvcData.recommendations.slice(0, 2),
      type: type
    };

    viewModel.primary.checked = !flags.inBasketOverlay;

    fn.loopArray(viewModel.recommendations, function loopSecondary(i) {
      viewModel.recommendations[i].checked = true;
    });

    _mvcData.viewModel = viewModel;
    _mvcData.sellers = { buyBoxMessage: 'buy', buyButtonLabel: buyButtonLabel };
    _mvcData.formHandler = formhandlerModel.clone({
      component: 'bundle',
      config: [{ key: 'addItemToOrderSuccessURL', value: urlParams, action: 'append' }],
      name: 'addToBasket',
      publicLink: productModel.getPublicLink(_mvcData.products)
    }, { add: true });

    return _mvcData;
  };


  /**
   *
   * @param {Object} mvcData
   * @param {Object} mvcData.flags
   * @param {Object} mvcData.viewModel
   * @return {Object}
   */
  BundleController.prototype._setDynamicViewData = function (mvcData) {
    var _mvcData = mvcData,
      flags = _mvcData.flags,
      model = {},
      price = 0,
      recommendations = [],
      skuModel = this.models.sku,
      skus = [],
      type = '',
      viewModel = _mvcData.viewModel;

    recommendations = viewModel.recommendations;
    type = viewModel.type;
    model = this.models[type];

    if (viewModel.primary.checked) {
      skus.push(viewModel.primary.sku);
    }

    if (viewModel.primary.checked || flags.inBasketOverlay) {
      price += parseFloat(model.getPrice(viewModel.primary.sellers));
    }

    if (flags.inBasketOverlay) {
      viewModel.primary.tileHeading = 'Already in basket';
    } else {
      viewModel.primary.tileHeading = 'Currently viewing';
    }

    fn.loopArray(recommendations, function loopSecondary(i) {
      if (recommendations[i].checked) {
        recommendations[i].checkboxLabel = 'Added to bundle';
        skus.push(recommendations[i].sku);
        price += parseFloat(model.getPrice(recommendations[i].sellers));
      } else {
        recommendations[i].checkboxLabel = 'Add to bundle';
      }

      recommendations[i].id = recommendations[i][type].id;
      recommendations[i].catID = model.getParentCategory(recommendations[i][type]).id;
    });

    viewModel.price = price.toFixed(2);

    _mvcData.formHandler = this._updateFormHandlerModel({
      formHandlerId: _mvcData.formHandler.id,
      updates: {
        catalogRefIds: skus.map(function (sku) {
          return skuModel.getPrimaryListing(sku).id;
        }),
        productId: skuModel.getParentProduct(skus[0]).id || '',
        skuId: fn.getValue(skus[0], 'id') || ''
      }
    });

    return _mvcData;
  };


  /**
   *
   * @param {Object} args
   * @param {String} args.formHandlerID
   * @param {Object} args.updates
   * @return {Object}
   */
  BundleController.prototype._updateFormHandlerModel = function (args) {
    var _args = args,
      formhandlerModel = this.models.formHandler;

    _args.updates.catalogRefIds = _args.updates.catalogRefIds.join();

    fn.loopObject(_args.updates, function loopUpdates(prop) {
      formhandlerModel.update({
        mSearchValue: _args.formHandlerId,
        sUpdateKey: 'oData',
        mUpdateValue: null,
        sUpdatePropKey: prop,
        mUpdatePropValue: _args.updates[prop]
      });
    });

    return formhandlerModel.getDataStores({ value: _args.formHandlerId });
  };


  /**
   *
   * @param {Object} args
   * @param {Object} args.oView
   * @param {JQueryDeferred} _deferred Used for unit tests
   * @return {void}
   */
  BundleController.prototype._bindViewEvents = function (args, _deferred) {
    var view = args.oView;

    $(view.oElms.elWrapper).on(
      'change', 'input.bundle-checkbox',
      { view: view },
      this._handleCheckboxClick.bind(this)
    );

    if (view.sViewName !== 'BundleView') {
      return;
    }

    this._actionInViewport.push({ element: view.oElms.elWrapper, callbackArgs: { view: view } });
    this._checkInViewport(view.sViewId, _deferred);
  };


  /**
   *
   * @param {Object} args
   * @param {Object} args.view
   * @return {void}
   */
  BundleController.prototype._analyticsTracking = function (args) {
    var mvcData = args.view.oData.mvc,
      viewModel = mvcData.viewModel,
      flags = mvcData.flags,
      relationship = '',
      id = '',
      ids = [],
      joinedIDs = '',
      _s = fn.copyObject(window.s);

    relationship = flags.bundle ? 'Frequently Bought Together' : relationship;
    ids.push(viewModel.primary.id);

    fn.loopArray(viewModel.recommendations, function loopSecondarySkus(i) {
      id = viewModel.recommendations[i][viewModel.type].id;
      ids.push(id);
    });

    joinedIDs = ids.join(';;,;');

    if (relationship) {
      _s.linkTrackEvents = 'event3,event32,event45';
      _s.linkTrackVars = 'prop19,eVar45,prop42,eVar59,events,products';
      _s.products = ';' + joinedIDs + ';;';
      _s.prop19 = 'product impressions';
      _s.eVar45 = _s.prop19;
      _s.prop42 = 'pdp - ' + relationship + ' - product impressions';
      _s.eVar59 = _s.prop42;
      _s.events = 'event3,event32,event45';
      if (!window.pageLoadAnalyticsSuccess) {
        $(window).one('pageLoadAnalyticsSuccess',
        function bundleControllerAsyncAnalytics() {
          _s.tl(true, 'o', relationship + ' - product impressions');
        });
      } else {
        _s.tl(true, 'o', relationship + ' - product impressions');
      }
    }
  };


  /**
   *
   * @param {JQueryEvent} event
   * @return {void}
   */
  BundleController.prototype._handleCheckboxClick = function (event) {
    var activeID = event.currentTarget.id,
      counter = 0,
      view = event.data.view,
      mvcData = view.oData.mvc,
      recommendations = mvcData.viewModel.recommendations,
      type = mvcData.viewModel.type;

    fn.loopArray(recommendations, function loopSecondarySkus(i) {
      if (recommendations[i][type].id === activeID) {
        recommendations[i].checked = !recommendations[i].checked;
      }
      counter = recommendations[i].checked ? counter += 1 : counter;
    });

    mvcData.flags.disableAddToBasket = !mvcData.viewModel.primary.checked && counter === 0;
    view.refresh({ data: this._setDynamicViewData(mvcData), activeID: activeID });
  };


  module.exports = BundleController;
});

define('modules/pdp/views/EventMessageView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/product-description/eventMessagingCountDown'
], function ($, fn, BaseView, eventMessagingCountDown) {
  'use strict';

  /**
   * Event messaging view constructor sets view's core data and calls parent constructor.
   * @param {Object} oConfig The configuration to populate the view's dynamic properties.
   * @return {void}
   */
  function EventMessageView(oConfig) {
    this.sViewName = 'EventMessageView';
    this.sNamespace = 'sellers';
    this.sTag = 'events';
    this.sViewClass = 'event-message-wrapper';
    this.sTemplate = $('#buybox-template-event-messaging')[0].innerHTML;
    this.parent.constructor.call(this, oConfig);
    this.initEventMessageManager(this.oData.mvc);
  }

  fn.inherit(EventMessageView, BaseView);

  EventMessageView._name = 'EventMessageView';
  EventMessageView.sNamespace = 'sellers';
  EventMessageView.sTag = 'events';

  EventMessageView.prototype.initEventMessageManager = function (data) {
    var hasCountdown = false;

    if (!this.isObject(data.sellers, true)) {
      return;
    }

    hasCountdown = this.isObject(data.sellers.countdown, true);

    this.eventMessageManager = new eventMessagingCountDown.EventMessagingManager({
      sellerID: data.sellers.sellerId,
      listingId: data.sellers.id,
      events: data.sellers.events || [],
      initCountdown: false,
      countdown: {
        startTime: hasCountdown && data.sellers.countdown.startTime,
        endTime: hasCountdown && data.sellers.countdown.endTime,
        currentTime: window.currentTimeAsync,
        message: hasCountdown && data.sellers.countdown.message
      }
    });
  };

  EventMessageView.prototype._cacheDomElms = function () {
    var EVENT_MESSAGE_CLASS = '.event-message';

    this.parent._cacheDomElms.call(this);
    this.oElms.elMessage = $(this.oElms.elWrapper).find(EVENT_MESSAGE_CLASS);
  };

  EventMessageView.prototype._initDependancies = function () {
    if (this.eventMessageManager) {
      this.eventMessageManager.show(this.oElms.elMessage);
    }
  };

  return EventMessageView;
});


define('text!templates/views/basePanelGroupView.html',[],function () { return '<div id="{{sViewId}}" class="PDP-Version2__component info-panel-group {{sViewClass}} {{sClassNames}}">\r\n  {{#aSubViews}}\r\n    {{{render}}}\r\n  {{/aSubViews}}\r\n  <div class="info-panel-mask-wrapper">\r\n    <div class="info-panel-mask"></div>\r\n  </div>\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/BasePanelGroupView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','text!templates/views/basePanelGroupView.html'],function (require, exports, module) {
  'use strict';


  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    template = require('text!templates/views/basePanelGroupView.html');


  /**
   * The base panel group view that all panel group views inherit from.
   * @param {Object} oConfig The configuration settings for a view.
   * @return {void}
   */
  function BasePanelGroupView(oConfig) {
    var _oConfig = oConfig;

    _oConfig.modelRequired = false;
    this.sNamespace = 'panel';
    this.sPanelType = 'group';
    this.sTemplate = template;
    this.parent.parent.constructor.call(this, _oConfig);

    // parent constructor property overrides
    this.hasData = true;
    this.sOutput = 'append';
  }

  fn.inherit(BasePanelGroupView, BaseView);

  /**
   * Caches the base panel group's mask element.
   * @return {void}
   */
  BasePanelGroupView.prototype._cacheDomElms = function () {
    this.parent.parent._cacheDomElms.call(this);
    this.oElms.elMask = $(this.sSelector).find('.info-panel-mask')[0];
  };

  /**
   * Binds the base events required by all panel groups.
   * @return {void}
   */
  BasePanelGroupView.prototype._bindEvents = function () {
    $(this.oElms.elMask).on(
      'click',
      this._onMaskClick.bind(this)
    );

    $(window).on(
      'panelGroupOpen.' + this.sKeyId,
      this._onPanelGroupOpen.bind(this)
    ).on(
      'panelGroupClosed.' + this.sKeyId,
      this._onPanelGroupClosed.bind(this)
    );
  };

  /**
   * Unbinds the base events required by all panel groups.
   * @return {void}
   */
  BasePanelGroupView.prototype._unbindEvents = function () {
    $(this.oElms.elMask).off('click');
    $(window)
      .off('panelGroupOpen.' + this.sKeyId)
      .off('panelGroupClosed.' + this.sKeyId);
  };


  /**
   * Fires an event to the panels controller to close all open panels with the provided tag.
   * @param {Object} oEvent The event object.
   * @return {void}
   */
  BasePanelGroupView.prototype._onMaskClick = function (oEvent) {
    var _this = this;

    _this.setEvent({
      sName: 'closeOpenPanels',
      sTag: _this.sTag,
      oView: _this,
      oClickEvent: oEvent
    }, false, true);
  };

  /**
   * When a panel group opens, if the tag matches the panel group's tag, then add the active class
   * to panel group's wrapper.
   * @param {Object} oEvent The event object.
   * @return {void}
   */
  BasePanelGroupView.prototype._onPanelGroupOpen = function (oEvent) {
    var IS_ACTIVE = 'is-active';

    if (oEvent.oData.sTag === this.sTag) {
      $(this.oElms.elWrapper).addClass(IS_ACTIVE);
      $(this.oElms.elMask).addClass(IS_ACTIVE);

      if (this._panelGroupOpenHook !== undefined) {
        this._panelGroupOpenHook(oEvent);
      }
    }
  };

  /**
   * When a panel group closes, if the tag matches the panel group's tag, then remove the active
   * class to panel group's wrapper.
   * @param {Object} oEvent The event object.
   * @return {void}
   */
  BasePanelGroupView.prototype._onPanelGroupClosed = function (oEvent) {
    var IS_ACTIVE = 'is-active';

    if (oEvent.oData.sTag === this.sTag) {
      $(this.oElms.elWrapper).removeClass(IS_ACTIVE);
      $(this.oElms.elMask).removeClass(IS_ACTIVE);

      if (this._panelGroupClosedHook !== undefined) {
        this._panelGroupClosedHook(oEvent);
      }
    }
  };

  /**
   * Method removes a view from the DOM and detroys any references to it, i.e. events.
   * @param {Object} oEvent The event object.
   * @return {Object} The view.
   */
  BasePanelGroupView.prototype.destroy = function (oEvent) {
    this.forLoop(this.oData.aSubViews, function (i) {
      this.oData.aSubViews[i].destroy(oEvent);
    });

    this._unbindEvents();
    $('#' + this.sViewId).remove();

    this.setEvent({
      sName: 'destroyPanelGroup',
      tag: this.sTag
    }, false, true);

    return this;
  };


  module.exports = BasePanelGroupView;
});


define('modules/pdp/views/BuyboxPanelGroupView', [
  'modules/mvc/fn',
  'modules/pdp/views/BasePanelGroupView'
], function (fn, BasePanelGroupView) {
  var BuyboxPanelGroupView = function (oConfig) {
    this.hasNoId = true;
    this.oStyles = {
      allDesktops: ['slideIn-left'],
      allDevices: ['slideIn-left', 'fullScreen']
    };
    this.sTag = 'buybox';
    this.sViewName = 'BuyboxPanelGroupView';
    this.sViewClass = 'info-panel-group-buybox';
    this.parent.constructor.call(this, oConfig);
  };

  fn.inherit(BuyboxPanelGroupView, BasePanelGroupView);

  BuyboxPanelGroupView._name = 'BuyboxPanelGroupView';

  return BuyboxPanelGroupView;
});


define('text!templates/views/basePanelView.html',[],function () { return '<div id="{{sViewId}}" class="info-panel {{sViewClass}} {{sClassNames}}" data-mvc-tag="{{tag}}">\r\n  <div class="info-panel-header">\r\n    <h4 class="info-panel-title ellipsed">{{{sTitle}}}</h4>\r\n    <span class="icon larger info-panel-back-icon" data-icon="g"></span>\r\n  </div>\r\n  <div class="info-panel-content-wrapper">\r\n    <h3 class="info-panel-content-title">{{{sTitle}}}</h3>\r\n    <div class="info-panel-content {{sContentClasses}}">\r\n      {{#aSubViews}}\r\n        {{{render}}}\r\n      {{/aSubViews}}\r\n    </div>\r\n  </div>\r\n  <a class="icon info-panel-close-icon" data-icon="y"></a>\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/BasePanelView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','modules/breakpoint','text!templates/views/basePanelView.html'],function (require, exports, module) {
  'use strict';


  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    breakpoint = require('modules/breakpoint'),
    template = require('text!templates/views/basePanelView.html');


  /**
   * The base panel view that all panel views inherit from.
   * @param {Object} oConfig The configuration settings for a view.
   * @return {void}
   */
  function BasePanelView(oConfig) {
    var _oConfig = oConfig;

    _oConfig.modelRequired = false;
    this.sNamespace = 'panel';
    this.isOpen = false;
    this.panelNo = 1;
    this.childPanels = [];
    this.parentPanel = null;
    this.sTemplate = template;
    this.parent.parent.constructor.call(this, _oConfig);

    // parent constructor property overrides
    this.hasData = true;
    this.contentHash = this.hashCode(_oConfig.sOverlayContent);
  }

  fn.inherit(BasePanelView, BaseView);

  /**
   * Caches the base panel's close elements.
   * @return {void}
   */
  BasePanelView.prototype._cacheDomElms = function () {
    var $wrapper = undefined,
      CLOSE_ICONS = '.info-panel-close-icon, .info-panel-close-link, .info-panel-back-icon';

    this.parent.parent._cacheDomElms.call(this);
    $wrapper = $(this.oElms.elWrapper);
    this.oElms.elHeader = $wrapper.find('.info-panel-header')[0];
    this.oElms.elTitle = $wrapper.find('h4.info-panel-title')[0];
    this.oElms.elContentTitle = $wrapper.find('h3.info-panel-content-title')[0];
    this.oElms.elContentWrapper = $wrapper.find('.info-panel-content-wrapper')[0];
    this.oElms.elContent = $wrapper.find('.info-panel-content')[0];
    this.oElms.$Close = $wrapper.find(CLOSE_ICONS);

    if ($wrapper.parent().hasClass('info-panel-group')) {
      this.oElms.elPanelGroup = $wrapper.parent();
    }
  };

  /**
   * Binds the base events required by all panels.
   * @return {void}
   */
  BasePanelView.prototype._bindEvents = function () {
    var INPUT_WITHIN_WRAPPER = 'input:not([type="checkbox"])';

    if (this.oElms.elTrigger) {
      $(this.oElms.elTrigger).on(
        'click',
        this._onTriggerClick.bind(this)
      );
    }

    $(this.oElms.elWrapper).on(
      'focus.movePanelContent-' + this.sKeyId, INPUT_WITHIN_WRAPPER,
      this._onInputFocus.bind(this)
    ).on(
      'blur.movePanelContent-' + this.sKeyId, INPUT_WITHIN_WRAPPER,
      this._onInputBlur.bind(this)
    );

    $(this.oElms.elWrapper).on(
      'click.closeIcons',
      '.info-panel-close-icon, .info-panel-close-link, .info-panel-back-icon',
      this.close.bind(this)
    );

    $(this.oElms.elContentWrapper).on('scroll', window.picturefill);
  };

  /**
   * Unbinds the base events required by all panels.
   * @return {void}
   */
  BasePanelView.prototype._unbindEvents = function () {
    if (this.oElms.elTrigger) {
      $(this.oElms.elTrigger).off('click');
    }

    $(this.oElms.elWrapper)
      .off('focus.movePanelContent-' + this.sKeyId)
      .off('blur.movePanelContent-' + this.sKeyId);

    $(this.oElms.elContentWrapper).off('touchmove scroll');
    $(this.oElms.elWrapper).off('click.closeIcons');
  };

  /**
   * Adds odd and even classes to the panels based on their 'parent' panel. Also adds zIndex
   * one higher than their parent panel.
   * @param {Object} options The optional parametres that change method behaviour.
   * @return {void}
   */
  BasePanelView.prototype._addAttributes = function (options) {
    var _options = options || {},
      panelObj = undefined,
      zIndex = undefined,
      INFO_PANEL = '.info-panel',
      $panelWrapper = _options.wrapper || $(this.oElms.elWrapper),
      $parentPanel = _options.parent || $(this.oElms.elTrigger).closest(INFO_PANEL);

    if ($parentPanel.length > 0) {
      if ($parentPanel.data('mvc-tag') === this.sTag) {
        if ($parentPanel.data('mvc-self')) {
          panelObj = $parentPanel.data('mvc-self');
        } else if (window.oAppController.oPageController.views[$parentPanel.attr('id')]) {
          panelObj = window.oAppController.oPageController.views[$parentPanel.attr('id')];
          $parentPanel.data('mvc-self', panelObj);
          window.oAppController.oPageController.views[$parentPanel.attr('id')] = null;
        }

        this.panelNo = panelObj.panelNo + 1;
        panelObj.childPanels.push(this);
        this.parentPanel = panelObj;
      }

      if (_options.zIndex !== false) {
        zIndex = parseInt($parentPanel.css('z-index'), 10) + 1;
        $panelWrapper.css({ zIndex: zIndex });
      }
    }
  };

  /**
   * Method fired when a user clicks on a trigger element.
   * @param {Object} oEvent The event object.
   * @return {void}
   */
  BasePanelView.prototype._onTriggerClick = function (oEvent) {
    this.toggle(oEvent);
  };

  /**
   * Method decides whether to open or close the panel when a user clicks on the trigger.
   * @param {Object} oEvent The event object.
   * @return {Object} The panel view whose toggle method is being invoked.
   */
  BasePanelView.prototype.toggle = function (oEvent) {
    if (this.isOpen) {
      this.close(oEvent);
    } else {
      this.open(oEvent);
    }
    return this;
  };

  /**
   * Method opens the panel, adds an active class to the trigger and fires a panel open event.
   * @param {Object} oEvent The event object.
   * @return {Object} The panel view whose open method is being invoked.
   */
  BasePanelView.prototype.open = function (oEvent) {
    var IS_ACTIVE = 'is-active',
      IS_OPEN = 'is-open';

    if (oEvent && oEvent.currentTarget && $(oEvent.currentTarget).hasClass('disabled')) {
      return this;
    }

    if (this._openStartHook) {
      this._openStartHook(oEvent);
    }

    $(this.oElms.elWrapper).addClass(IS_OPEN);

    if (this.oElms.elTrigger) {
      $(this.oElms.elTrigger).addClass(IS_ACTIVE);
    }

    this.isOpen = true;

    this.setEvent({
      sName: 'panelOpen',
      sTag: this.sTag,
      oView: this,
      oClickEvent: oEvent
    }, false, true);

    if (this._openEndHook) {
      this._openEndHook(oEvent);
    }

    return this;
  };

  /**
   * Method closes the panel, removes an active class to the trigger and fires a panel close event.
   * @param {Object} oEvent The event object.
   * @return {Object} The panel view whose close method is being invoked.
   */
  BasePanelView.prototype.close = function (oEvent) {
    var _this = this,
      openChildPanel = (function () {
        var openPanels = [];

        _this.forLoop(_this.childPanels, function (i) {
          if (_this.childPanels[i].isOpen) {
            openPanels.push(_this.childPanels[i]);
          }
        });

        return openPanels;
      }()),
      IS_ACTIVE = 'is-active',
      IS_OPEN = 'is-open';

    if (oEvent && oEvent.currentTarget && $(oEvent.currentTarget).hasClass('disabled')) {
      return this;
    }

    if (this._closeStartHook) {
      this._closeStartHook(oEvent);
    }

    if (openChildPanel.length) {
      this.forLoop(openChildPanel, function (i) {
        openChildPanel[i].close(event);
      });
    }

    $(this.oElms.elWrapper).removeClass(IS_OPEN);

    if (this.oElms.elTrigger) {
      $(this.oElms.elTrigger).removeClass(IS_ACTIVE);
    }

    this.isOpen = false;

    this.setEvent({
      sName: 'panelClosed',
      sTag: this.sTag,
      oView: this,
      oClickEvent: oEvent
    }, false, true);

    if (this._closeEndHook) {
      this._closeEndHook(oEvent);
    }

    return this;
  };

  /**
   * Method removes a view from the DOM and detroys any references to it, i.e. events.
   * @param {Object} oEvent The event object.
   * @param {Object} opts Options for the method.
   * @return {void}
   */
  BasePanelView.prototype.destroy = function (oEvent, opts) {
    var _opts = opts || {};

    if (_opts.destroyGroup) {
      this.setEvent({
        sName: 'getPanelGroup',
        tag: this.sTag,
        callback: function (panelGroup) {
          if (panelGroup) {
            panelGroup.destroy();
          }
        }
      }, false, true);

      return this;
    }

    this._unbindEvents();
    $('#' + this.sViewId).remove();

    this.setEvent({
      sName: 'destroyPanel',
      oView: this,
      oClickEvent: oEvent
    }, false, true);

    return this;
  };

  /**
   * Method updates the content of a panel with a string of html/text.
   * @param {String} sContent html/text to add into panel.
   * @return {Object} The view object.
   */
  BasePanelView.prototype.updateContent = function (sContent) {
    $(this.oElms.elContent).html(sContent);
    return this;
  };

  /**
   * Method removes the content of a panel with a string of html/text.
   * @return {Object} The view object.
   */
  BasePanelView.prototype.removeContent = function () {
    this.oElms.elContent.innerHTML = '';
    return this;
  };

  /**
   * Method checks if the viewport is mobile and if scroll is disabled on the body and if an input
   * is not in focus, and if these come back as true then it runs the _moveInputIntoView method.
   * @param {Object} oEvent The event object.
   * @return {void}
   */
  BasePanelView.prototype._onInputFocus = function (oEvent) {
    if (this.isInputInFocus) {
      return;
    }

    if ($('body').hasClass('disableScroll')) {
      if (breakpoint.mobile || breakpoint.hTablet || breakpoint.vTablet) {
        this._toggleHeaderVisibility();
        this._moveInputIntoView(oEvent);
      }
    }

    this.isInputInFocus = true;
  };

  /**
   * Method moves the header and content wrapper up and scrolls the input into view. This is
   * required on devices because when the overlay is open in fullScreen mode, the body scroll is
   * disabled and so the native behaviour does not scroll the input into view.
   * @param {Object} oEvent The event object.
   * @return {void}
   */
  BasePanelView.prototype._moveInputIntoView = function (oEvent) {
    var iScroll = $(oEvent.currentTarget).offset().top - $(this.oElms.elContent).offset().top;

    $(this.oElms.elContentWrapper).animate({
      scrollTop: iScroll
    }, 200);
  };

  /**
   * Method checks if the viewport is mobile and if scroll is disabled on the body and if an input
   * is in focus, come back as true then it runs the _slideDownHeader method.
   * @param {Object} oEvent The event object.
   * @return {void}
   */
  BasePanelView.prototype._onInputBlur = function () {
    if ($('body').hasClass('disableScroll')) {
      if (breakpoint.mobile || breakpoint.hTablet || breakpoint.vTablet) {
        this._toggleHeaderVisibility();
      }
    }

    this.isInputInFocus = false;
  };

  /**
   * Method moves the header and content wrapper up for down. This is required on mobile When
   * in landscape because the screen with keyboard open is not deep enough if the header is not
   * hidden from view.
   * @return {void}
   */
  BasePanelView.prototype._toggleHeaderVisibility = function () {
    if (!this.isInputInFocus) {
      $(this.oElms.elHeader).addClass('panel-header-hidden');
      $(this.oElms.elContentWrapper).addClass('panel-header-hidden');
    } else {
      $(this.oElms.elHeader).removeClass('panel-header-hidden');
      $(this.oElms.elContentWrapper).removeClass('panel-header-hidden');
    }
  };


  module.exports = BasePanelView;
});

define('modules/pdp/views/BuyboxPanelView', [
  'modules/mvc/fn',
  'modules/pdp/views/BasePanelView'
], function (fn, BasePanelView) {
  'use strict';

  /**
   * Initalises a buybox panel view.
   * @param {Object} oConfig Configuration settings for the view.
   * @return {void}
   */
  function BuyboxPanelView(oConfig) {
    this.oStyles = {
      allDesktops: ['slideIn-left'],
      allDevices: ['slideIn-left', 'fullScreen']
    };
    this.sTag = 'buybox';
    this.sViewName = 'BuyboxPanelView';
    this.sViewClass = 'info-panel-buybox';
    this.parent.constructor.call(this, oConfig);
  }

  fn.inherit(BuyboxPanelView, BasePanelView);

  BuyboxPanelView._name = 'BuyboxPanelView';

  BuyboxPanelView.prototype._addAttributes = function () {
    var oddEventClass = '',
      ODD = 'info-panel-odd',
      EVEN = 'info-panel-even',
      CHILD = 'info-panel-child',
      INFO_PANEL = '.info-panel',
      $panelWrapper = $(this.oElms.elWrapper),
      $parentPanel = $(this.oElms.elTrigger).closest(INFO_PANEL);

    this.parent._addAttributes.call(this, {
      wrapper: $panelWrapper,
      parent: $parentPanel,
      zIndex: false
    });

    if ($parentPanel.length > 0) {
      $panelWrapper.addClass(CHILD);
    }

    oddEventClass = this.panelNo % 2 === 0 ? EVEN : ODD;
    $panelWrapper.addClass(oddEventClass)
      .attr('data-panel-no', this.panelNo);
  };

  BuyboxPanelView.prototype._openEndHook = function () {
    var SHOW_EVENT = 'showBuyboxMask',
      DO_WRAPPER = 'delivery-snippet-wrapper',
      CHILD_OPEN_CLASS = 'child-panel-open',
      options = {
        mask: undefined
      };

    if (this.parentPanel) {
      $(this.parentPanel.oElms.elWrapper).addClass(CHILD_OPEN_CLASS);
      return;
    }

    if ($(this.oElms.elTrigger).hasClass(DO_WRAPPER)) {
      options.mask = 'mediaPlayer';
    } else {
      options.mask = 'both';
    }

    this.setEvent({
      sName: SHOW_EVENT,
      options: options
    }, false, true);
  };

  BuyboxPanelView.prototype._closeEndHook = function () {
    var HIDE_EVENT = 'hideBuyboxMask',
      DO_WRAPPER = 'delivery-snippet-wrapper',
      CHILD_OPEN_CLASS = 'child-panel-open',
      options = {
        unmask: undefined
      };

    if (this.parentPanel) {
      $(this.parentPanel.oElms.elWrapper).removeClass(CHILD_OPEN_CLASS);
      return;
    }

    if ($(this.oElms.elTrigger).hasClass(DO_WRAPPER)) {
      options.unmask = 'mediaPlayer';
    } else {
      options.unmask = 'both';
    }

    this.setEvent({
      sName: HIDE_EVENT,
      options: options
    }, false, true);
  };

  return BuyboxPanelView;
});

define('modules/pdp/views/DeliveryDetailsView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView'
], function ($, fn, BaseView) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function DeliveryDetailsView(config) {
    this.sViewName = 'DeliveryDetailsView';
    this.sNamespace = 'deliveryOptions';
    this.sTag = 'details';
    this.sViewClass = 'delivery-details-wrapper';
    this.sTemplate = $('#buybox-template-delivery-details')[0].innerHTML;
    this.parent.constructor.call(this, config);
  }

  fn.inherit(DeliveryDetailsView, BaseView);

  DeliveryDetailsView._name = 'DeliveryDetailsView';
  DeliveryDetailsView.sNamespace = 'deliveryOptions';
  DeliveryDetailsView.sTag = 'details';

  DeliveryDetailsView.prototype._cacheDomElms = function () {
    var $wrapper = null;

    this.parent._cacheDomElms.call(this);
    $wrapper = $(this.oElms.elWrapper);
    this.oElms.deliveryInfoLink = $wrapper.find('.delivery-details-lead-time-advisory a')[0];
    this.oElms.returnsLink = $wrapper.find('.delivery-details-returns-policy a')[0];
  };

  return DeliveryDetailsView;
});


define('text!templates/views/DeliverySnippetView.html',[],function () { return '<div id="{{sViewId}}" class="{{sViewClass}} {{countdownClass}}">\r\n    <div class="countdown-message highlight">\r\n      <span class="countdown-message-text"></span>\r\n    </div>\r\n\r\n    <div class="delivery-options-text" itemprop="availableDeliveryMethod">\r\n      <p class="highlight">\r\n        <strong>\r\n          {{mvc.deliveryOptions.0.free}}\r\n          {{mvc.deliveryOptions.0.name}}\r\n\r\n          {{#mvc.deliveryOptions.0.leadTime}}\r\n            ({{mvc.deliveryOptions.0.leadTime}})\r\n          {{/mvc.deliveryOptions.0.leadTime}}\r\n\r\n          {{^mvc.deliveryOptions.0.free}}\r\n            {{^mvc.deliveryOptions.0.chargeableClickAndCollect}}\r\n              {{#mvc.deliveryOptions.0.charge}}\r\n                &pound;{{mvc.deliveryOptions.0.charge}}\r\n              {{/mvc.deliveryOptions.0.charge}}\r\n            {{/mvc.deliveryOptions.0.chargeableClickAndCollect}}\r\n          {{/mvc.deliveryOptions.0.free}}\r\n        </strong>\r\n      </p>\r\n    </div>\r\n\r\n    {{#mvc.deliveryOptions.0.chargeableClickAndCollect}}\r\n      <p class="click-and-collect-charges smaller">\r\n        <span>FREE for orders of &pound;{{basketThreshold}} or more,</span>\r\n        <span>&pound;{{deliveryCharge}} for orders under &pound;{{basketThreshold}}.</span>\r\n      </p>\r\n    {{/mvc.deliveryOptions.0.chargeableClickAndCollect}}\r\n\r\n    {{#mvc.custom.deliveryOptions.moreOptionsText}}\r\n      <p class="more-delivery-options">\r\n        <span class="more-delivery-options-text">{{mvc.custom.deliveryOptions.moreOptionsText}}</span>\r\n        <a class="more-delivery-options-link hidden-tablet hidden-mobile">See details</a>\r\n      </p>\r\n    {{/mvc.custom.deliveryOptions.moreOptionsText}}\r\n    {{^mvc.deliveryOptions.0.isResiliency}}\r\n    <div class="delivery-snippet-icon-wrapper hidden-kiosk hidden-largeDesktop hidden-desktop">\r\n      <span class="icon highlight larger" data-icon="r"></span>\r\n    </div>\r\n    {{/mvc.deliveryOptions.0.isResiliency}}\r\n    {{{oEvent}}}{{{addViewDataAttr}}}\r\n  </div>';});

define('modules/pdp/views/DeliverySnippetView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/pdp/views/BuyboxPanelGroupView',
  'modules/pdp/views/BuyboxPanelView',
  'modules/pdp/views/DeliveryDetailsView',
  'text!templates/views/DeliverySnippetView.html'
], function (
  $,
  fn,
  BaseView,
  BuyboxPanelGroupView,
  BuyboxPanelView,
  DeliveryDetailsView,
  template
) {
  'use strict';

  /**
   * The view class that renders the delivery options snippet in the buybox.
   * @param {oConfig} oConfig The configuration for the view.
   * @return {void}
   */
  function DeliverySnippetView(oConfig) {
    this.sViewName = 'DeliverySnippetView';
    this.sNamespace = 'deliveryOptions';
    this.sTag = 'snippet';
    this.sViewClass = 'delivery-snippet-wrapper';
    this.sTemplate = template;
    this.parent.constructor.call(this, oConfig);
  }

  fn.inherit(DeliverySnippetView, BaseView);

  DeliverySnippetView._name = 'DeliverySnippetView';
  DeliverySnippetView.sNamespace = 'deliveryOptions';
  DeliverySnippetView.sTag = 'snippet';

  DeliverySnippetView.prototype._setData = function (params) {
    var doLength = 0;

    this.parent._setData.call(this, params);

    if (this.isArray(this.oData.mvc.deliveryOptions, true)) {
      doLength = this.oData.mvc.deliveryOptions.length - 1;
      this.oData.mvc.custom.deliveryOptions = { moreOptionsText: '' };

      if (doLength === 1) {
        this.oData.mvc.custom.deliveryOptions.moreOptionsText = doLength + ' more option';
      } else if (doLength > 1) {
        this.oData.mvc.custom.deliveryOptions.moreOptionsText = doLength + ' more options';
      }
    }
  };

  DeliverySnippetView.prototype._bindEventsPreRender = function () {
    this.bindEvent({
      name: 'disableCountdownClock',
      namespace: this.oData.mvc.sellers.id,
      target: window,
      method: this._onDisableCountdownClock
    });

    this.bindEvent({
      name: 'enableCountdownClock',
      namespace: this.oData.mvc.sellers.id,
      target: window,
      method: this._onEnableCountdownClock
    });
  };

  DeliverySnippetView.prototype._cacheDomElms = function () {
    var COUNTDOWN = '.countdown-message',
      COUNTDOWN_TEXT = '.countdown-message-text',
      OPTION_TEXT = '.delivery-options-text';

    this.parent._cacheDomElms.call(this);
    this.oElms.elOptionText = $(this.oElms.elWrapper).find(OPTION_TEXT)[0];
    this.oElms.elCountdown = $(this.oElms.elWrapper).find(COUNTDOWN)[0];
    this.oElms.elCountdownText = $(this.oElms.elWrapper).find(COUNTDOWN_TEXT)[0];
  };

  DeliverySnippetView.prototype._onDisableCountdownClock = function () {
    this._disableCountdownClock();
  };

  DeliverySnippetView.prototype._onEnableCountdownClock = function (event) {
    if (this.oElms.elCountdownText) {
      this._enableCountdownClock({
        element: this.oElms.elCountdownText,
        countdown: event.oData.countdown,
        clock: event.oData.clock
      });
    } else {
      this._pendingCountdownClock = function (element) {
        this._enableCountdownClock({
          element: element,
          countdown: event.oData.countdown,
          clock: event.oData.clock
        });
      };
    }
  };

  DeliverySnippetView.prototype._enableCountdownClock = function (params) {
    var _this = this,
      hasCountdown = false,
      COUNTDOWN_CLASS = 'with-countdown';

    hasCountdown = params.countdown.show({ element: params.element });

    if (hasCountdown) {
      if ($(params.element).find('time').length) {
        params.clock.init({
          element: $(params.element).find('time')[0],
          onEnd: function () {
            _this._disableCountdownClock();
          }
        });
        $(this.oElms.elWrapper).addClass(COUNTDOWN_CLASS);
      }
    }
  };

  DeliverySnippetView.prototype._disableCountdownClock = function () {
    var COUNTDOWN_CLASS = 'with-countdown';

    $(this.oElms.elWrapper).removeClass(COUNTDOWN_CLASS);
  };

  DeliverySnippetView.prototype._initDependancies = function () {
    this._getEligibleCountdown();
    this._getBuyboxPanelGroup();
  };

  DeliverySnippetView.prototype._getEligibleCountdown = function () {
    var _this = this;

    if (this._pendingCountdownClock) {
      this._pendingCountdownClock(this.oElms.elCountdownText);
      this._pendingCountdownClock = null;
    } else {
      this.setEvent({
        sName: 'getEligibleCountdown',
        sNamespace: this.oData.mvc.sellers.id,
        callback: function (options) {
          _this._enableCountdownClock({
            element: _this.oElms.elCountdownText,
            countdown: options.countdown,
            clock: options.clock
          });
        }
      }, true, true);
    }
  };

  DeliverySnippetView.prototype._getBuyboxPanelGroup = function () {
    var _this = this;

    this.setEvent({
      sName: 'getPanelGroup',
      tag: 'buybox',
      callback: function (panelGroup) {
        if (!panelGroup) {
          _this._createBuyboxPanels();
        } else {
          _this._addBuyboxPanel(panelGroup, {
            output: 'prepend',
            target: panelGroup.oElms.elWrapper,
            render: true
          });
        }
      }
    }, false, true);
  };

  DeliverySnippetView.prototype._createBuyboxPanels = function () {
    var panelGroup = new BuyboxPanelGroupView({
      sTag: 'buybox',
      elTarget: '.buybox-wrapper'
    });

    this._addBuyboxPanel(panelGroup);
    panelGroup.render();
  };

  DeliverySnippetView.prototype._addBuyboxPanel = function (panelGroup, options) {
    var _options = options || {},
      panel = {},
      deliveryOptions = fn.getValue(this, 'oData', 'mvc', 'deliveryOptions') || [];

    if (this._isResiliencyDelivery(deliveryOptions)) {
      return;
    }
    panel = panelGroup.createSubView({
      ViewClass: BuyboxPanelView,
      mParamData: {
        sOutput: _options.output,
        elTarget: _options.target,
        elTrigger: this.oElms.elWrapper,
        oData: {
          sClassNames: 'info-panel-delivery-details',
          sTitle: 'Delivery details',
          aSubViews: [this._compileSubView({ _class: DeliveryDetailsView })]
        },
        iSubViewCount: 1
      }
    });

    if (_options.render) {
      panel.render();
    }
  };

  DeliverySnippetView.prototype._isResiliencyDelivery = function (options) {
    return !fn.isArray(options) || !options.length || options[0].isResiliency;
  };

  return DeliverySnippetView;
});


define('text!templates/views/storeStockCheckView.html',[],function () { return '<div id="{{sViewId}}" class="{{sViewClass}} {{sClassNames}}">\r\n  {{#state.hasStockStatus}}\r\n    <p class="with-margin-btm">\r\n      Local store: <strong class="nearest-store-stock-status {{props.stockStatusClass}}">{{props.nearestStore.stockStatus}}</strong>\r\n    </p>\r\n    <p>\r\n      <strong class="nearest-store-name">{{props.nearestStore.name}}</strong>\r\n    </p>\r\n    {{#props.nearestStore.distance}}\r\n    <p class="nearest-store-distance with-margin-btm">\r\n      <strong>{{props.nearestStore.distance}}</strong> from\r\n      <strong class="nearest-store-lookup">{{props.nearestStore.postCode}}</strong>\r\n    </p>\r\n    {{/props.nearestStore.distance}}\r\n    <a class="change-store-link" data-id="{{props.listingID}}">Change store</a>\r\n  {{/state.hasStockStatus}}\r\n  {{^state.hasStockStatus}}\r\n    <form class="stock-check-form" data-id="{{mvc.sellers.id}}">\r\n      <label for="stock-check-form-postcode" class="stock-check-label text">Check stock in your local store:</label>\r\n      <input id="stock-check-form-postcode" title="Enter town / postcode" placeholder="Enter town / postcode" value="" class="postcode pull-left-all" type="text" autocomplete="off">\r\n      <div class="button-wrapper">\r\n        <input type="submit" class="button secondary" value="Check" />\r\n      </div>\r\n    </form>\r\n    {{#state.isGeolocationAvailable}}\r\n      <a class="current-location-link with-geolocation" data-id="{{mvc.sellers.id}}">Use my current location</a>\r\n    {{/state.isGeolocationAvailable}}\r\n  {{/state.hasStockStatus}}\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>';});

define('modules/pdp/views/StoreStockCheckView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','text!templates/views/storeStockCheckView.html'],function (require, exports, module) {
  'use strict';


  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    template = require('text!templates/views/storeStockCheckView.html');


  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function StoreStockCheckView(config) {
    this.sNamespace = 'stores';
    this.sTag = 'storeStockCheck';
    this.sViewName = 'StoreStockCheckView';
    this.sViewClass = 'store-stock-check-view';
    this.sTemplate = template;
    this.parent.constructor.call(this, config);
  }


  fn.inherit(StoreStockCheckView, BaseView);
  StoreStockCheckView._name = 'StoreStockCheckView';
  StoreStockCheckView.sNamespace = 'stores';
  StoreStockCheckView.sTag = 'storeStockCheck';


  StoreStockCheckView.prototype._cacheDomElms = function () {
    var $wrapper = null;

    this.parent._cacheDomElms.call(this);

    $wrapper = $(this.oElms.elWrapper);

    this.oElms.elForm = $wrapper.find('form.stock-check-form')[0];
    this.oElms.elCheckBtn = $wrapper.find('input.button')[0];
    this.oElms.elPostcodeInput = $wrapper.find('input.postcode')[0];
    this.oElms.elChangeStore = $wrapper.find('a.change-store-link')[0];
    this.oElms.elCurrentLocationLink = $wrapper.find('a.current-location-link')[0];
  };


  StoreStockCheckView.prototype._setProps = function (data) {
    var stores = data.stores,
      hasStores = null,
      hasSessionData = null;

    if (!fn.isObject(stores)) {
      return {};
    }

    hasStores = fn.isObject(stores.nearestStore, { notEmpty: true });
    hasSessionData = fn.isObject(stores.sessionStoreData);

    if (!hasStores && hasSessionData) {
      stores.sessionStoreData.stockStatus = 'Out of stock';
    }

    return {
      nearestStore: hasStores ? stores.nearestStore : stores.sessionStoreData,
      stockStatusClass: hasStores ? stores.nearestStore.stockStatus.toLowerCase().split(' ').join('-') : 'out-of-stock',
      listingID: data.sellers.id
    };
  };


  StoreStockCheckView.prototype._setStates = function (data) {
    var stores = data.stores,
      isInStockOnly = typeof this.oData.state.isInStockOnly === 'boolean'
          ? this.oData.state.isInStockOnly : true,
      isNearestStoreAvailable = fn.isObject(stores)
          && fn.isObject(stores.nearestStore, { notEmpty: true }),
      isSessionStoreAvailable = fn.isObject(stores) && fn.isObject(stores.sessionStoreData);

    return {
      isInStockOnly: isInStockOnly,
      isNearestStoreAvailable: isNearestStoreAvailable,
      isSessionStoreAvailable: isSessionStoreAvailable,
      hasStockStatus: isNearestStoreAvailable || isSessionStoreAvailable,
      isGeolocationAvailable: fn.isGeolocationAvailable() && !data.flags.isKiosk
    };
  };


  StoreStockCheckView.prototype.refresh = function (storesData) {
    var mvcData = this.oData.mvc;

    mvcData.stores = storesData;

    this.render({
      sourceOutput: 'inner',
      sOutput: 'inner',
      elTarget: 'self',
      mParamData: { mvc: mvcData }
    });
  };


  module.exports = StoreStockCheckView;
});

define('modules/pdp/views/PromotionsOfferView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView'
], function ($, fn, BaseView) {
  'use strict';

  /**
   * The view class that renders the promotions.
   * @param {oConfig} oConfig The configuration for the view.
   * @return {void}
   */
  function PromotionsOfferView(oConfig) {
    this.sViewName = 'PromotionsOfferView';
    this.sNamespace = 'promotions';
    this.sTag = 'offer';
    this.sViewClass = 'promotions-offer';
    this.sTemplate = $('#promotions-offer-template')[0].innerHTML;
    this.parent.constructor.call(this, oConfig);
  }

  fn.inherit(PromotionsOfferView, BaseView);

  PromotionsOfferView._name = 'PromotionsOfferView';
  PromotionsOfferView.sNamespace = 'promotions';
  PromotionsOfferView.sTag = 'offer';

  PromotionsOfferView.prototype._setData = function () {
    this.oData.sToggleClass = (this.oData.mvc.promotions.description !== ''
        || this.oData.mvc.promotions.linkSaveURL !== ''
        || this.oData.mvc.promotions.customerInstructions !== '')
            ? 'fnToggleDescription'
            : '';
  };

  PromotionsOfferView.prototype.refresh = function (params) {
    this.render({
      sourceOutput: 'inner',
      sOutput: 'inner',
      elTarget: 'self',
      mParamData: params.mParamData
    });
  };

  return PromotionsOfferView;
});

define('modules/pdp/views/PromotionsView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/pdp/views/PromotionsOfferView',
  'modules/toggle-expand-collapse/common'
], function ($, fn, BaseView, PromotionsOfferView, ToggleExpandCollapse) {
  'use strict';

  /**
   * The view class that renders the promotions.
   * @param {oConfig} oConfig The configuration for the view.
   * @return {void}
   */
  function PromotionsView(oConfig) {
    this.sViewName = 'PromotionsView';
    this.sNamespace = 'promotions';
    this.sTag = oConfig.sTag || '_default';
    this.sViewClass = oConfig.sViewClass || 'buybox-promotions-wrapper';
    this.sTemplate = oConfig.sTemplate
        ? $(oConfig.sTemplate)[0].innerHTML
        : $('#promotions-view-template')[0].innerHTML;
    this.parent.constructor.call(this, oConfig);
  }


  fn.inherit(PromotionsView, BaseView);
  PromotionsView._name = 'PromotionsView';
  PromotionsView.sNamespace = 'promotions';


  PromotionsView.prototype._cacheDomElms = function () {
    var $wrapper = null;

    this.parent._cacheDomElms.call(this);
    $wrapper = $(this.oElms.elWrapper);

    this.oElms.title = $wrapper.find('.block-title') || null;
    this.oElms.containerTop = $wrapper.find('.special-offer-container-top');
    this.oElms.elPromoLink = $wrapper.find('.offer-cta a')[0];
  };


  PromotionsView.prototype._setData = function (args) {
    var counter = 1;

    this.parent._setData.call(this, args);

    this.oData.fnOddEvenClass = function () {
      var oddEvenClass = counter % 2 === 0 ? 'even' : 'odd';

      counter += 1;
      return oddEvenClass;
    };

    if (!fn.isArray(this.oData.mvc.promotions)) {
      this.oData.mvc.promotions = [];
    }

    this.oData.promoCount = this.oData.mvc.promotions.length;
    this.oData.title = this.oData.promoCount === 1
        ? this.oData.promoCount + ' Special offer'
        : this.oData.promoCount + ' Special offers';
  };


  PromotionsView.prototype._addSubViews = function () {
    this.forLoop(this.oData.mvc.promotions, function (i) {
      this.oData.aSubViews.push(
        this._compileSubView({ _class: PromotionsOfferView, range: i })
      );
    });
  };


  PromotionsView.prototype._initDependancies = function () {
    if (this.iSubViewCount > 1) {
      if (this.oData.mvc.flags.toEqualiseHeights) {
        $(this.oElms.containerTop)
          .removeAttr('style')
          .equaliseHeights();
      }

      this.oToggleExpandCollapse = new ToggleExpandCollapse({
        sToggleContainer: this.oElms.elWrapper,
        sToggleElementParent: '.fnToggleDescription',
        sToggleTriggerElement: '.special-offer-container-top',
        bAccordionEnabled: true
      });
      this.oToggleExpandCollapse.init();
    }
  };


  PromotionsView.prototype.refresh = function (params) {
    var _params = params;

    this.oData.aSubViews = [];

    if (this.oData.mvc.flags.toEqualiseHeights) {
      _params.mParamData.mvc.flags = { toEqualiseHeights: true };
    }

    this.render({
      sourceOutput: 'inner',
      sOutput: 'inner',
      elTarget: 'self',
      mParamData: _params.mParamData
    });

    this._cacheDomElms();

    if (this.oData.mvc.flags.toEqualiseHeights) {
      $(this.oElms.containerTop)
        .removeAttr('style')
        .equaliseHeights();
    }
  };

  return PromotionsView;
});

define('modules/pdp/views/GiftMessageView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView'
], function ($, fn, BaseView) {
  'use strict';

  /**
   * The view class that renders the gift message.
   * @param {oConfig} oConfig The configuration for the view.
   * @return {void}
   */
  function GiftMessageView(oConfig) {
    this.sViewName = 'GiftMessageView';
    this.sNamespace = 'products';
    this.sTag = 'giftMessage';
    this.sViewClass = 'gift-message-view';
    this.sTemplate = $('#gift-message-view-template')[0].innerHTML;
    this.parent.constructor.call(this, oConfig);
  }

  fn.inherit(GiftMessageView, BaseView);

  GiftMessageView._name = 'GiftMessageView';
  GiftMessageView.sNamespace = 'product';

  return GiftMessageView;
});

define('modules/pdp/views/BuyboxContentView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/pdp/views/ProductPriceView',
  'modules/pdp/views/VariantsView',
  'modules/pdp/views/ItemActionsView',
  'modules/pdp/views/EventMessageView',
  'modules/pdp/views/DeliverySnippetView',
  'modules/pdp/views/StoreStockCheckView',
  'modules/pdp/views/PromotionsView',
  'modules/pdp/views/GiftMessageView'
], function (
  $,
  fn,
  BaseView,
  ProductPriceView,
  VariantsView,
  ItemActionsView,
  EventMessageView,
  DeliverySnippetView,
  StoreStockCheckView,
  PromotionsView,
  GiftMessageView
) {
  'use strict';

  /**
   *
   * @param {Object} oConfig
   * @return {void}
   */
  function BuyboxContentView(oConfig) {
    this.sNamespace = 'sellers';
    this.sTag = 'buyboxContent';
    this.sViewName = 'BuyboxContentView';
    this.sViewClass = 'buybox-content-view';
    this.sTemplate = $('#buybox-template-buybox-content')[0].innerHTML;
    this.views = {
      classes: {
        ProductPriceView: ProductPriceView,
        VariantsView: VariantsView,
        ItemActionsView: ItemActionsView,
        EventMessageView: EventMessageView,
        DeliverySnippetView: DeliverySnippetView,
        StoreStockCheckView: StoreStockCheckView,
        PromotionsView: PromotionsView,
        GiftMessageView: GiftMessageView
      }
    };
    this.parent.constructor.call(this, oConfig);
  }

  fn.inherit(BuyboxContentView, BaseView);

  BuyboxContentView._name = 'BuyboxContentView';
  BuyboxContentView.sNamespace = 'sellers';
  BuyboxContentView.sTag = 'buyboxContent';

  BuyboxContentView.prototype._cacheDomElms = function () {
    this.parent._cacheDomElms.call(this);
    this.oElms.partnerInfoIcon = $(this.oElms.elWrapper).find('.partner-info-icon')[0] || null;
    this.oElms.addOnItemIcon = $(this.oElms.elWrapper).find('.add-on-item')[0] || null;
  };

  BuyboxContentView.prototype._bindEvents = function () {
    if (this.oElms.partnerInfoIcon) {
      $(this.oElms.partnerInfoIcon).on(
        'click',
        this._openPartnerInfoTooltip.bind(this)
      );
    }
    if (this.oData.state.hasAddOnItem) {
      $(this.oElms.addOnItemIcon).on(
        'click',
        this._openAddOnItemInfoTooltip.bind(this)
      );
    }
  };

  BuyboxContentView.prototype._setData = function (args) {
    var cacheCow = {};

    this.parent._setData.call(this, args);

    if (this.toRenderProductPrice({ cacheCow: cacheCow })) {
      this.oData.views = {
        ProductPriceView: this._compileSubView({
          _class: this.views.classes.ProductPriceView,
          namespace: cacheCow.hasSellerPrices ? 'sellers' : 'products',
          className: 'with-large-price with-saving-inline',
          state: { showSavings: true, showPoints: true }
        })
      };
    }
  };

  BuyboxContentView.prototype.toRenderProductPrice = function (args) {
    var _args = args,
      hasCacheCow = this.isObject(_args.cacheCow),
      isFF = this.oData.mvc.flags.isFF,
      isSkuSelected = this.oData.mvc.flags.isSkuSelected,
      hasSeller = this.isObject(this.oData.mvc.sellers, true),
      hasSellerPrices = hasSeller && this.isObject(this.oData.mvc.sellers.prices, true),
      hasProduct = this.isObject(this.oData.mvc.products, true),
      hasProductPrices = hasProduct && this.isObject(this.oData.mvc.products.prices, true);

    if ((isSkuSelected || !isFF) && hasSeller && hasSellerPrices) {
      if (hasCacheCow) {
        _args.cacheCow.hasSellerPrices = hasSellerPrices;
      }
      return true;
    }

    if (hasProduct && hasProductPrices) {
      if (hasCacheCow) {
        _args.cacheCow.hasProductPrices = hasProductPrices;
      }
      return true;
    }

    return false;
  };

  BuyboxContentView.prototype._setProps = function (data) {
    var flags = data.flags || {},
      productData = data.products || {},
      sellerData = data.sellers || {},
      skuData = data.sku || {},
      hasPrices = this.isObject(productData, true) && this.isObject(productData.prices, true)
          && !productData.prices.error,
      hasSellerData = this.isObject(data.sellers, true),
      isSkuSelected = flags.isSkuSelected;

    return {
      stockMessageText: hasSellerData && sellerData.stockMessaging.messageText,
      stockSchemaHref: hasSellerData && sellerData.stockMessaging.schemaHref,
      stockMessageClass: hasSellerData && sellerData.stockMessaging.messageClass,
      name: hasSellerData && sellerData.name,
      staticImagePath: hasSellerData && sellerData.staticImagePath,
      clubcardPoints: (!isSkuSelected && hasPrices && productData.prices.clubcardPoints)
          || (hasSellerData && sellerData.prices.clubcardPoints),
      hookLogic: data.hooklogic,
      releaseDate: skuData.commercialReleaseDateFormatted,
      minimumAge: productData.minimumAgeRequired
    };
  };

  BuyboxContentView.prototype._setStates = function (data) {
    var flags = data.flags || {},
      productData = data.products || {},
      sellerData = data.sellers || {},
      skuData = data.sku || {},
      hasPrices = this.isObject(productData, true) && this.isObject(productData.prices, true)
          && !productData.prices.error,
      hasSellerData = this.isObject(data.sellers, true),
      isSkuSelected = flags.isSkuSelected;

    return {
      isPartner: hasSellerData && sellerData.name.length > 0 && sellerData.name !== 'Tesco',
      hasFromPrice: !isSkuSelected && hasPrices && !!productData.prices.fromPrice,
      hasSeller: hasSellerData,
      noListings: !hasSellerData && !hasPrices,
      hasStockMessage: hasSellerData && !!sellerData.stockMessaging.messageText,
      hasClubcardPoints: (!isSkuSelected && hasPrices && !!productData.prices.clubcardPoints)
          || (hasSellerData && !!sellerData.prices.clubcardPoints),
      isBoost: hasSellerData && sellerData.isBCVE,
      hasHookLogic: !!data.hooklogic,
      hasReleaseDate: !!skuData.commercialReleaseDateFormatted,
      hasMinimumAge: !!productData.minimumAgeRequired,
      hasAddOnItem: !!sellerData.addOnMessage
    };
  };

  BuyboxContentView.prototype._addSubViews = function () {
    if (this.oData.mvc.flags.isPrimarySeller) {
      this.oData.aSubViews.push(
        this._compileSubView({
          _class: this.views.classes.VariantsView,
          ctlr: true
        })
      );
    }

    this.oData.aSubViews.push(
      this._compileSubView({ _class: this.views.classes.ItemActionsView })
    );

    if (this.oData.mvc.products.giftMessagingEnabled) {
      this.oData.aSubViews.push(
        this._compileSubView({ _class: this.views.classes.GiftMessageView })
      );
    }

    if (this.isObject(this.oData.mvc.sellers, true)) {
      this.oData.aSubViews.push(
        this._compileSubView({ _class: this.views.classes.EventMessageView, ctlr: true })
      );

      this.oData.aSubViews.push(
        this._compileSubView({ _class: this.views.classes.DeliverySnippetView, ctlr: true })
      );

      if (!this.oData.mvc.flags.isKiosk && this.oData.mvc.sellers.enableStockServiceCallPdpV2
        && this.oData.mvc.sku.rangedInStore && this.oData.mvc.flags.isSkuSelected
        && this.oData.mvc.sellers.buyBoxMessage.toLowerCase().indexOf('preorder') === -1) {
        this.oData.aSubViews.push(
          this._compileSubView({ _class: this.views.classes.StoreStockCheckView, ctlr: true })
        );
      }

      if (!this.oData.mvc.flags.isPrimarySeller
          && this.isArray(this.oData.mvc.sellers.promotions, true)) {
        this.oData.aSubViews.push(
          this._compileSubView({ _class: this.views.classes.PromotionsView })
        );
      }
    }
  };

  BuyboxContentView.prototype._openPartnerInfoTooltip = function () {
    var name = this.oData.mvc.sellers.name,
      partnerUrl = this.oData.mvc.sellers.partnerUrl,
      message = 'We\'ve carefully chosen all our Tesco Partners to give you even more '
          + 'choice. Read more about <a href="' + partnerUrl + '">' + name + '</a>.';

    this.createTooltip({
      sTooltopMessage: message,
      elTrigger: this.oElms.partnerInfoIcon
    });
  };

  BuyboxContentView.prototype._openAddOnItemInfoTooltip = function () {
    var addOnItemMsg = this.oData.mvc.sellers.addOnMessage;

    this.createTooltip({
      sTooltopMessage: addOnItemMsg,
      elTrigger: this.oElms.addOnItemIcon
    });
  };

  return BuyboxContentView;
});

define('modules/pdp/views/PrimarySellerView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/pdp/views/BuyboxContentView'
], function ($, fn, BaseView, BuyboxContentView) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function PrimarySellerView(config) {
    this.sNamespace = 'sellers';
    this.sTag = 'buybox';
    this.sViewName = 'PrimarySellerView';
    this.sViewClass = 'primary-seller-view';
    this.sTemplate = $('#primary-seller-view-template')[0].innerHTML;
    this.views = {
      classes: {
        BuyboxContentView: BuyboxContentView
      }
    };
    this.parent.constructor.call(this, config);
  }

  fn.inherit(PrimarySellerView, BaseView);
  PrimarySellerView._name = 'PrimarySellerView';
  PrimarySellerView.sNamespace = 'sellers';
  PrimarySellerView.sTag = 'buybox';

  PrimarySellerView.prototype._setData = function (params) {
    this.parent._setData.call(this, params);
    this.oData.mvc.flags.isPrimarySeller = true;
  };

  PrimarySellerView.prototype._addSubViews = function () {
    this.oData.aSubViews.push(
      this._compileSubView({ _class: BuyboxContentView })
    );
  };

  return PrimarySellerView;
});

define('modules/pdp/views/SellerSummaryView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/tesco.analytics'
], function ($, fn, BaseView, analytics) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function SellerSummaryView(config) {
    this.sNamespace = 'sellers';
    this.sTag = 'sellerSummaries';
    this.sViewName = 'SellerSummaryView';
    this.sViewClass = 'seller-summary-view';
    this.sTemplate = $('#seller-summary-view-template')[0].innerHTML;
    this.views = {
      classes: {
        SellerSummaryView: SellerSummaryView
      }
    };
    this.parent.constructor.call(this, config);
  }

  fn.inherit(SellerSummaryView, BaseView);
  SellerSummaryView._name = 'SellerSummaryView';
  SellerSummaryView.sNamespace = 'sellers';
  SellerSummaryView.sTag = 'sellerSummaries';

  SellerSummaryView.prototype._bindEvents = function () {
    $(this.oElms.elWrapper).on(
      'click.analyticsTracking',
      this._analyticsTracking.bind(this)
    );
  };

  SellerSummaryView.prototype._setStates = function (data) {
    return {
      hasAddOnItem: !!data.sellers.addOnMessage
    };
  };

  SellerSummaryView.prototype._analyticsTracking = function (oEvent) {
    var webAnalytics = {},
      data = [];

    if (!oEvent.currentTarget.className.match(/is-active/)) {
      webAnalytics = new analytics.WebMetrics();

      data.push({
        eVar45: 'sold by ' + this.oData.mvc.sellers.name,
        prop19: 'sold by ' + this.oData.mvc.sellers.name,
        eVar59: 'pdp - sidebar right - '
            + this.oData.mvc.sellers.name + ' - p' + this.oData.mvc.sellers.custom.position,
        prop42: 'pdp - sidebar right - '
            + this.oData.mvc.sellers.name + ' - p' + this.oData.mvc.sellers.custom.position,
        events: 'event45'
      });

      webAnalytics.submit(data);
    }
  };

  return SellerSummaryView;
});

define('modules/pdp/views/SellerSummariesView', [
  'domlib',
  'mustache',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/pdp/views/SellerSummaryView',
  'modules/pdp/views/BuyboxContentView',
  'modules/pdp/views/BuyboxPanelGroupView',
  'modules/pdp/views/BuyboxPanelView'
], function (
  $,
  mustache,
  fn,
  BaseView,
  SellerSummaryView,
  BuyboxContentView,
  BuyboxPanelGroupView,
  BuyboxPanelView
) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function SellerSummariesView(config) {
    this.sNamespace = 'sellers';
    this.sTag = 'buybox';
    this.sViewName = 'SellerSummariesView';
    this.sViewClass = 'seller-summaries-view';
    this.sTemplate = $('#seller-summaries-view-template')[0].innerHTML;
    this.views = {
      classes: {
        SellerSummaryView: SellerSummaryView
      }
    };
    this.parent.constructor.call(this, config);
  }

  fn.inherit(SellerSummariesView, BaseView);
  SellerSummariesView._name = 'SellerSummariesView';
  SellerSummariesView.sNamespace = 'sellers';
  SellerSummariesView.sTag = 'buybox';

  SellerSummariesView.prototype._addSubViews = function () {
    var setPosition = function (i) {
      if (!this.oData.mvc.sellers[i].custom) {
        this.oData.mvc.sellers[i].custom = {};
      }
      this.oData.mvc.sellers[i].custom.position = i + 1;
    };

    this.forLoop(this.oData.mvc.sellers, function (i) {
      setPosition.call(this, i);

      this.oData.aSubViews.push(
        this._compileSubView({ _class: SellerSummaryView, range: i })
      );
      this.iSubViewCount += 1;
    });
  };

  SellerSummariesView.prototype.refresh = function (params) {
    var _params = params,
      setPosition = function (i) {
        if (!this.oData.mvc.sellers[i].custom) {
          this.oData.mvc.sellers[i].custom = {};
        }
        this.oData.mvc.sellers[i].custom.position = i + 1;
      };

    this.oData.mvc = _params.mParamData.mvc;

    this.forLoop(this.oData.aSubViews, function (i) {
      setPosition.call(this, i);

      this.oData.aSubViews[i].render({
        sourceOutput: 'inner',
        sOutput: 'inner',
        elTarget: 'self',
        mParamData: this._compileSubView({
          _class: SellerSummaryView,
          range: i,
          returnData: true
        })
      });
    });
  };

  SellerSummariesView.prototype._initDependancies = function () {
    if (this.isArray(this.oData.aSubViews, true)) {
      this._getBuyboxPanelGroup();
    }
  };

  SellerSummariesView.prototype._getBuyboxPanelGroup = function () {
    var _this = this;

    this.setEvent({
      sName: 'getPanelGroup',
      tag: 'buybox',
      callback: function (panelGroup) {
        if (!panelGroup) {
          _this._createBuyboxPanels();
        } else {
          _this._addBuyboxPanels(panelGroup, {
            output: 'prepend',
            target: panelGroup.oElms.elWrapper,
            render: true
          });
        }
      }
    }, false, true);
  };

  SellerSummariesView.prototype._createBuyboxPanels = function () {
    var panelGroup = new BuyboxPanelGroupView({
      sTag: 'buybox',
      elTarget: '.buybox-wrapper'
    });

    this._addBuyboxPanels(panelGroup);
    panelGroup.render();
  };

  SellerSummariesView.prototype._addBuyboxPanels = function (panelGroup, options) {
    var _options = options || {},
      buyboxContentView = {},
      panel = {};

    this.forLoop(this.oData.aSubViews, function (i) {
      buyboxContentView = this._compileSubView({
        _class: BuyboxContentView,
        index: this.oData.aSubViews[i].oData.mvc.sellers
      });

      panel = panelGroup.createSubView({
        ViewClass: BuyboxPanelView,
        mParamData: {
          sOutput: _options.output,
          elTarget: _options.target,
          elTrigger: this.oData.aSubViews[i].sSelector,
          oData: {
            sClassNames: 'info-panel-secondary-buybox',
            sTitle: mustache.render(
              'Buy from <strong>{{name}}</strong>',
              buyboxContentView.oData.mvc.sellers
            ),
            aSubViews: [
              buyboxContentView
            ]
          },
          iSubViewCount: 1
        }
      });

      if (_options.render) {
        panel.render();
      }
    });
  };

  return SellerSummariesView;
});

define('modules/pdp/views/WishlistsView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/custom-dropdown/oo-dropdown'
], function ($, fn, BaseView, customDropdown) {
  'use strict';

  /**
   * Wishlists view constructor sets view's core data and calls parent constructor.
   * @param {Object} oConfig The configuration to populate the view's dynamic properties.
   * @return {void}
   */
  function WishlistsView(oConfig) {
    this.sViewName = 'WishlistsView';
    this.sNamespace = 'wishlists';
    this.sTag = 'wishlists';
    this.sViewClass = 'wishlists-wrapper';
    this.sTemplate = $('#dropdown-wishlists-view-template')[0].innerHTML;
    this.parent.constructor.call(this, oConfig);
  }

  fn.inherit(WishlistsView, BaseView);

  WishlistsView._name = 'WishlistsView';
  WishlistsView.sNamespace = 'wishlists';
  WishlistsView.sTag = '_default';

  WishlistsView.prototype._initDependancies = function () {
    var $Selector = $(this.sSelector),
      oOptions = {
        $container: $(this.oElms.elWrapper),
        defaultNativeWidth: true,
        additionalText: this.oData.mvc.wishlists.defaultWishlistTextValue
      };

    this.oElms.$Select = $Selector.find('select');
    if (this.oElms.$Select.length > 0) {
      customDropdown.init(this.oElms.$Select, oOptions);
    }
  };

  return WishlistsView;
});

define('modules/pdp/views/BuyboxView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/pdp/views/PrimarySellerView',
  'modules/pdp/views/SellerSummariesView',
  'modules/pdp/views/WishlistsView'
], function (
  $,
  fn,
  BaseView,
  PrimarySellerView,
  SellerSummariesView,
  WishlistsView
) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function BuyboxView(config) {
    this.sNamespace = 'sku';
    this.sTag = 'buybox';
    this.sViewName = 'BuyboxView';
    this.sViewClass = 'buybox-view';
    this.sTemplate = $('#buybox-view-template')[0].innerHTML;
    this.views = {
      classes: {
        PrimarySellerView: PrimarySellerView,
        SellerSummariesView: SellerSummariesView
      }
    };
    this.parent.constructor.call(this, config);
  }

  fn.inherit(BuyboxView, BaseView);
  BuyboxView._name = 'BuyboxView';
  BuyboxView.sNamespace = 'sku';
  BuyboxView.sTag = 'buybox';

  BuyboxView.prototype._setData = function (params) {
    this.parent._setData.call(this, params);
    this._setRefreshPoint();
  };

  BuyboxView.prototype._addSubViews = function () {
    this.oData.aSubViews.push(
      this._compileSubView({
        _class: PrimarySellerView,
        data: this.oModel.getPrimarySeller(this.oData.mvc.sku.id),
        force: true
      })
    );

    this.oData.aSubViews.push(
      this._compileSubView({
        _class: SellerSummariesView,
        data: this.oModel.getSecondarySellers(this.oData.mvc.sku.id),
        ctlr: true
      })
    );

    if (!this.oData.mvc.flags.isKiosk) {
      this.oData.aWishlistsView = this.oData.aWishlistsView === undefined
          ? [] : this.oData.aWishlistsView;
      this.oData.aWishlistsView.push(
        this._compileSubView({
          _class: WishlistsView,
          ctlr: true
        })
      );
    }
  };

  BuyboxView.prototype._cacheDomElms = function () {
    var $Selector = $(this.sSelector),
      $WhyPartnersLink = $Selector.find('.why-sellers-wrapper > a');

    this.parent._cacheDomElms.call(this);
    this.oElms.elBuyboxWrapper = $Selector.closest('.buybox-wrapper')[0];
    this.oElms.elWhyPartnersLink = $WhyPartnersLink.length > 0
        ? $WhyPartnersLink[0]
        : null;
  };

  BuyboxView.prototype._bindEvents = function () {
    var _oData = { sTag: 'buybox', parentClose: true },
      MASKS = '.buybox-mask-media-player, .buybox-mask-buybox-content';

    this.bindEvent({
      name: 'showBuyboxMask',
      target: window,
      method: this._showMask
    });

    this.bindEvent({
      name: 'hideBuyboxMask',
      target: window,
      method: this._hideMask
    });

    $(MASKS).on('click', function closeBuyBoxPanel() {
      fn.createEvent({
        name: 'closeOpenPanels',
        propName: 'oData',
        data: _oData
      }).fire();
    });

    $(this.oElms.elWhyPartnersLink).on(
      'click',
      this._onWhyPartnersLinkClick.bind(this)
    );
  };

  BuyboxView.prototype._showMask = function (oEvent) {
    var WITH_LOADER = 'with-bkg-loader',
      IS_ACTIVE = 'is-active',
      MEDIA_PLAYER_MASK = '.buybox-mask-media-player',
      BUYBOX_PLAYER_MASK = '.buybox-mask-buybox-content',
      maskOptions = oEvent.oData.options,
      maskSelectors = '';

    if (maskOptions.mask === 'mediaPlayer') {
      maskSelectors = MEDIA_PLAYER_MASK;
    } else if (maskOptions.mask === 'buybox') {
      maskSelectors = BUYBOX_PLAYER_MASK;
    } else {
      maskSelectors = MEDIA_PLAYER_MASK + ', ' + BUYBOX_PLAYER_MASK;
    }

    $(maskSelectors).addClass(IS_ACTIVE);

    if (maskOptions.loader) {
      $(maskSelectors).addClass(WITH_LOADER);
    }
  };

  BuyboxView.prototype._hideMask = function (oEvent) {
    var WITH_LOADER = 'with-bkg-loader',
      IS_ACTIVE = 'is-active',
      MEDIA_PLAYER_MASK = '.buybox-mask-media-player',
      BUYBOX_PLAYER_MASK = '.buybox-mask-buybox-content',
      maskOptions = oEvent.oData.options,
      maskSelectors = '';

    if (maskOptions.unmask === 'mediaPlayer') {
      maskSelectors = MEDIA_PLAYER_MASK;
    } else if (maskOptions.unmask === 'buybox') {
      maskSelectors = BUYBOX_PLAYER_MASK;
    } else {
      maskSelectors = MEDIA_PLAYER_MASK + ', ' + BUYBOX_PLAYER_MASK;
    }

    if (maskOptions.loader) {
      $(maskSelectors).removeClass(WITH_LOADER);
    }

    $(maskSelectors).removeClass(IS_ACTIVE);
  };

  /**
   * Click event handler for the WhyPartners link, which creates/opens an overlay.
   * @param {Object} oEvent The jquery event object.
   * @return {void}
   */
  BuyboxView.prototype._onWhyPartnersLinkClick = function (oEvent) {
    this.compileAndRenderOverlay({
      sTag: 'whyPartners',
      sClassNames: 'why-partners-overlay small-lightbox',
      elTrigger: oEvent.currentTarget,
      sProp: 'text'
    }, oEvent);
  };

  return BuyboxView;
});

define('modules/pdp/data-stores/Category',['require','exports','module'],function (require, exports, module) {
  'use strict';

  /**
   *
   * @param {Object} data
   * @return {void}
   */
  module.exports = function Category(data) {
    this.id = data.id || null;
    this.links = data.links || null;
  };
});

define('modules/pdp/models/CategoryModel',['require','exports','module','modules/mvc/fn','modules/pdp/data-stores/Category','modules/pdp/models/BaseModel'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn');
  var Category = require('modules/pdp/data-stores/Category');
  var BaseModel = require('modules/pdp/models/BaseModel');

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  var CategoryModel = function CategoryModel(config) {
    this.DataStoreClass = Category;
    this.sNamespace = 'categories';
    this.parent.constructor.call(this, config);
  };

  fn.inherit(CategoryModel, BaseModel);

  CategoryModel.prototype.dataHandler = function (res) {
    if (!fn.isArray(res, { notEmpty: true }) && !fn.isObject(res, { notEmpty: true })) return;
    this.add(res);
  };

  module.exports = CategoryModel;
});

define('modules/pdp/controllers/DeliveryOptionsController', [
  'modules/mvc/fn',
  'modules/pdp/controllers/BaseController',
  'modules/pdp/views/DeliverySnippetView',
  'modules/pdp/views/DeliveryDetailsView'
], function (fn, BaseController, DeliverySnippetView, DeliveryDetailsView) {
  'use strict';


  var LEAD_TIME_ADVISORY = 'pdp-show-delivery-times-and-cost-text',
    SELLER_LEAD_TIME_ADVISORY = 'pdp-seller-show-delivery-times-and-cost-text',
    DBT_LEAD_TIME_ADVISORY = 'pdp-dbt-show-delivery-times-and-cost-text',
    NEXT_DAY_TERMS = 'pdp-click-and-collect-text',
    SELLER_NEXT_DAY_TERMS = 'pdp-seller-click-and-collect-text',
    RETURNS_POLICY = 'pdp-return-policy-text',
    DBT_RETURNS_POLICY = 'pdp-dbt-return-policy-text',
    DELIVERY_INFO_INTRO = 'deliveryinformation_introtext',
    DELIVERY_INFO_CONTENT = 'deliveryinformation_responsive',
    RETURNS_INTRO = 'returnspolicy_introtext_html',
    RETURNS_CONTENT = 'returnspolicy_responsive_html',
    DIGITAL_TEXT = 'pdp-digital-delivery-info-text',
    DIGITAL_CANCEL_TEXT = 'pdp-cancellation-policy-text-digital-delivery';

  /**
   *
   * @param {Array<Objects>} models
   * @return {void}
   */
  function DeliveryOptionsController(models) {
    this.sNamespace = 'deliveryOptions';
    this.sTag = '_default';
    this.views = {
      classes: {
        DeliverySnippetView: DeliverySnippetView,
        DeliveryDetailsView: DeliveryDetailsView
      }
    };
    this.cachedAssetData = null;
    this.parent.constructor.call(this, models);
  }


  fn.inherit(DeliveryOptionsController, BaseController);
  DeliveryOptionsController.modelNames = ['assets', 'sellers', 'deliveryOptions'];


  DeliveryOptionsController.prototype._bindViewEvents = function (data) {
    if (data.oView.sViewName === 'DeliveryDetailsView') {
      if (data.oView.oElms.deliveryInfoLink) {
        $(data.oView.oElms.deliveryInfoLink).on(
          'click',
          { view: data.oView },
          this._handleLinkClick.bind(this)
        );
      }

      if (data.oView.oElms.returnsLink) {
        $(data.oView.oElms.returnsLink).on(
          'click',
          { view: data.oView },
          this._handleLinkClick.bind(this)
        );
      }
    }
  };


  DeliveryOptionsController.prototype._handleLinkClick = function (event) {
    if (event.data.view.oData.mvc.flags.isKiosk) {
      event.preventDefault();
    }
    // This has been commented out because we are not going to use this feature at the moment.
    // However, if we ever want to display the information in an overlay rather than
    // redirecting to a different page, all that needs to be done is uncomment the method
    // below. - Dylan Aubrey (so24) 16/6/2016
    // this._compileOverlayContent(event);
  };


  DeliveryOptionsController.prototype._compileOverlayContent = function (event) {
    var assetData = {},
      cachedAssetData = {},
      isDelivery = event.currentTarget === event.data.view.oElms.deliveryInfoLink;

    /**
     *
     * @param {Object} data
     * @return {Object}
     */
    function structureData(data) {
      var delivery = { intro: '', content: '' },
        returns = { intro: '', content: '' };

      fn.loopArray(data, function loopData(i) {
        switch (data[i].lookupName) {
          case DELIVERY_INFO_INTRO:
            delivery.intro = data[i].text;
            break;
          case DELIVERY_INFO_CONTENT:
            delivery.content = data[i].text;
            break;
          case RETURNS_INTRO:
            returns.intro = data[i].text;
            break;
          case RETURNS_CONTENT:
            returns.content = data[i].text;
            break;
          // no default
        }
      });

      return {
        delivery: delivery.intro + delivery.content,
        returns: returns.intro + returns.content
      };
    }

    if (!cachedAssetData) {
      assetData = this.models.assets.get({
        noFetch: true,
        sSearchKey: 'lookupName',
        mSearchValue: [
          DELIVERY_INFO_INTRO,
          DELIVERY_INFO_CONTENT,
          RETURNS_INTRO,
          RETURNS_CONTENT
        ]
      });

      if (this.sanityCheckData(assetData).objects) {
        cachedAssetData = structureData(assetData);
      }
    }

    if (cachedAssetData) {
      this.renderOverlay({
        sTag: isDelivery ? 'deliveryInfo' : 'returnsPolicy',
        sClassNames: isDelivery ? 'delivery-info with-header' : 'returns-policy with-header',
        sTitle: isDelivery ? 'Delivery information' : 'Returns and refunds policy',
        sOverlayContent: isDelivery ? cachedAssetData.delivery : cachedAssetData.returns,
        toDestroyOnClose: true
      });
    }
  };


  DeliveryOptionsController.prototype._collateDataDependancies = function (params) {
    var deferred = params.deferred,
      deliveryOptions = params.mParamData.mvc.deliveryOptions,
      dataFlags = this.sanityCheckData(deliveryOptions);

    if (dataFlags.objects) {
      this._queryAssetModel(params, deferred);
      return;
    }

    if (dataFlags.ids) {
      this._queryDeliveryOptionsModel(params, deferred);
      return;
    }

    this._querySellerModel(params, deferred);
  };


  DeliveryOptionsController.prototype._querySellerModel = function (params, deferred) {
    var _this = this,
      _params = params,
      checkAndAdd = null,
      mvcData = _params.mParamData.mvc,
      observeAndNotify = null,
      sellerModel = this.models.sellers;

    checkAndAdd = function checkAddSellerData(data) {
      if (!_this.sanityCheckData(data).ids) {
        observeAndNotify();
      } else {
        _params.mParamData.mvc.deliveryOptions = data;
        _this._queryDeliveryOptionsModel(_params, deferred);
      }
    };

    observeAndNotify = function observeNotifySellerData() {
      sellerModel.observe({
        action: 'add',
        callback: function observeAndNotifyCallback(resp) {
          checkAndAdd(resp.data.observe.deliveryOptions);
        },
        once: true,
        propKey: 'deliveryOptions',
        searchValue: mvcData.sellers.id
      });
    };

    checkAndAdd(sellerModel.get({
      noFetch: true,
      mSearchValue: mvcData.sellers.id,
      sPropKey: 'deliveryOptions'
    }));
  };


  DeliveryOptionsController.prototype._queryDeliveryOptionsModel = function (params, deferred) {
    var _this = this,
      _params = params,
      checkAndAdd = null,
      doModel = this.models.deliveryOptions,
      mvcData = _params.mParamData.mvc,
      observeAndNotify = null;

    checkAndAdd = function checkAddDeliveryOptionsData(data) {
      if (!_this.sanityCheckData(data).objects) {
        observeAndNotify();
      } else {
        _params.mParamData.mvc.deliveryOptions = data;
        _this._queryAssetModel(_params, deferred);
      }
    };

    observeAndNotify = function observeNotifyDeliveryOptionsData() {
      doModel.observe({
        action: 'add',
        callback: function observeAndNotifyCallback(resp) {
          checkAndAdd(resp.data.observe);
        },
        once: true,
        searchValue: mvcData.deliveryOptions
      });
    };

    checkAndAdd(doModel.get({ mSearchValue: mvcData.deliveryOptions, noFetch: true }));
  };


  DeliveryOptionsController.prototype._queryAssetModel = function (params, deferred) {
    var _params = params,
      assetData = {},
      assetModel = this.models.assets,
      mvcData = _params.mParamData.mvc;

    if (!mvcData.assets) {
      mvcData.assets = {};
    }

    if (!this.cachedAssetData) {
      assetData = assetModel.get({
        noFetch: true,
        sSearchKey: 'lookupName',
        mSearchValue: [
          LEAD_TIME_ADVISORY,
          SELLER_LEAD_TIME_ADVISORY,
          DBT_LEAD_TIME_ADVISORY,
          NEXT_DAY_TERMS,
          SELLER_NEXT_DAY_TERMS,
          RETURNS_POLICY,
          DBT_RETURNS_POLICY,
          DIGITAL_TEXT,
          DIGITAL_CANCEL_TEXT
        ]
      });

      if (this.sanityCheckData(assetData).objects) {
        this.cachedAssetData = this._structureAssetData(assetData);
      }
    }

    if (this.cachedAssetData) {
      mvcData.assets.deliveryOptions = this._filterAssetData(_params);
      _params.mParamData.mvc = mvcData;
      deferred.resolve(_params);
    }
  };


  DeliveryOptionsController.prototype._structureAssetData = function (assetData) {
    var structuredAssetData = {
      leadTime: {
        tesco: undefined,
        sellers: undefined,
        dbt: undefined,
        digital: undefined
      },
      nextDayTerms: {
        tesco: undefined,
        sellers: undefined
      },
      returns: {
        tesco: undefined,
        dbt: undefined,
        digital: undefined
      }
    };

    fn.loopArray(assetData, function (i) {
      switch (assetData[i].lookupName) {
        case LEAD_TIME_ADVISORY:
          structuredAssetData.leadTime.tesco = assetData[i].text;
          break;
        case SELLER_LEAD_TIME_ADVISORY:
          structuredAssetData.leadTime.sellers = assetData[i].text;
          break;
        case DBT_LEAD_TIME_ADVISORY:
          structuredAssetData.leadTime.dbt = assetData[i].text;
          break;
        case NEXT_DAY_TERMS:
          structuredAssetData.nextDayTerms.tesco = assetData[i].text;
          break;
        case SELLER_NEXT_DAY_TERMS:
          structuredAssetData.nextDayTerms.sellers = assetData[i].text;
          break;
        case RETURNS_POLICY:
          structuredAssetData.returns.tesco = assetData[i].text;
          break;
        case DBT_RETURNS_POLICY:
          structuredAssetData.returns.dbt = assetData[i].text;
          break;
        case DIGITAL_TEXT:
          structuredAssetData.leadTime.digital = assetData[i].text;
          break;
        case DIGITAL_CANCEL_TEXT:
          structuredAssetData.returns.digital = assetData[i].text;
          break;
        // no default
      }
    });

    return structuredAssetData;
  };


  DeliveryOptionsController.prototype._filterAssetData = function (params) {
    var filteredAssetData = { leadTime: undefined, nextDayTerms: undefined, returns: undefined },
      mvcData = params.mParamData.mvc,
      deliveryData = mvcData.deliveryOptions,
      hasNextDay = this.models.deliveryOptions.hasNextDayDelivery(deliveryData),
      sellerData = mvcData.sellers,
      isDigitalSku = fn.getValue(mvcData, 'sku', 'isDigitalSku');

    if (sellerData.sellerId === '1000001') {
      if (isDigitalSku) {
        filteredAssetData.leadTime = this.cachedAssetData.leadTime.digital;
        filteredAssetData.returns = this.cachedAssetData.returns.digital;
      } else {
        filteredAssetData.leadTime = this.cachedAssetData.leadTime.tesco;
        filteredAssetData.returns = this.cachedAssetData.returns.tesco;
      }

      if (hasNextDay && !isDigitalSku) {
        filteredAssetData.nextDayTerms = this.cachedAssetData.nextDayTerms.tesco;
      }
    } else {
      filteredAssetData.leadTime = this.cachedAssetData.leadTime.sellers;

      if (hasNextDay) {
        filteredAssetData.nextDayTerms = this.cachedAssetData.nextDayTerms.sellers;
      }
    }

    return filteredAssetData;
  };


  return DeliveryOptionsController;
});

define('modules/pdp/data-stores/DeliveryOption', [], function () {
  'use strict';

  /**
   *
   * @param {Object} data
   * @return {void}
   */
  function DeliveryOption(data) {
    this.id = data.id || null;
    this.type = data.type || null;
    this.name = data.name || null;
    this.charge = data.charge || null;
    this.leadTime = data.leadTime || null;
    this.message = data.message || null;
    this.chargeableClickAndCollect = data.chargeableClickAndCollect || null;
    this.isScheduled = data.isScheduled || null;
    this.isResiliency = data.isResiliency || false;
  }

  return DeliveryOption;
});

define('modules/pdp/models/DeliveryOptionsModel', [
  'modules/mvc/fn',
  'modules/pdp/data-stores/DeliveryOption',
  'modules/pdp/models/BaseModel'
], function (fn, DeliveryOption, BaseModel) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function DeliveryOptionsModel(config) {
    this.DataStoreClass = DeliveryOption;
    this.sNamespace = 'deliveryOptions';
    this.sParentNamespace = 'sellers';
    this.parent.constructor.call(this, config);
  }


  fn.inherit(DeliveryOptionsModel, BaseModel);


  DeliveryOptionsModel.prototype.get = function (args) {
    var output = this.parent.get.call(this, args);

    if (this.sanityCheckData(output).objects) {
      output = this._enrichData(output);
    }
    return output;
  };


  DeliveryOptionsModel.prototype._enrichData = function (data) {
    var _data = data,
      isArray = true;

    if (!fn.isArray(data)) {
      _data = [data];
      isArray = false;
    }

    fn.loopArray(_data, function loopData(i) {
      _data[i].flags = {};

      if (_data[i].charge === 'FREE' && (_data[i].type !== 'storeCollect'
          || !_data[i].chargeableClickAndCollect)) {
        _data[i].free = _data[i].charge;
      }
    });

    return isArray ? _data : _data[0];
  };


  DeliveryOptionsModel.prototype.hasNextDayDelivery = function (data) {
    var deliveryData = this.resolveDataArg(data),
      hasNextDay = false;

    if (fn.isArray(deliveryData, { notEmpty: true })) {
      fn.loopArray(deliveryData, function loopDeliveryData(i) {
        if (deliveryData[i].leadTime === 'next day*') {
          hasNextDay = true;
        }
      });
    } else if (fn.isObject(deliveryData, { notEmpty: true })) {
      hasNextDay = deliveryData.leadTime === 'next day*';
    }

    return hasNextDay;
  };


  return DeliveryOptionsModel;
});

define('modules/pdp/data-stores/FormHandler', [], function () {
  'use strict';

  /**
   * Structured data object for form handlers.
   * @param {Object} data Data to be added into the structured data object.
   * @return {void}
   */
  function FormHandler(data) {
    /**
     * ATG limition means we cannot use the form ID as the unique key for the form on the
     * frontend, so instead we are using the name form attribute and assigning that to the id.
     */
    this.id = data.name || null;
    this.name = data.id || null;
    this.method = data.method || null;
    this.action = data.action || null;
    this.oData = data.oData || {};
  }

  return FormHandler;
});

define('modules/pdp/models/FormHandlerModel',['require','exports','module','modules/mvc/fn','modules/pdp/data-stores/FormHandler','modules/pdp/models/BaseModel'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    FormHandler = require('modules/pdp/data-stores/FormHandler'),
    BaseModel = require('modules/pdp/models/BaseModel');

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function FormHandlerModel(config) {
    this.parent.constructor.call(this, config);
    this.DataStoreClass = FormHandler;
    this.sNamespace = 'formHandler';
    this._inputRegex = function (prop) {
      return new RegExp('^(?!_D:).*(' + prop + ')$');
    };
    this._setFormTemplates();
  }

  fn.inherit(FormHandlerModel, BaseModel);

  /**
   *
   * @param {Element} form
   * @return {Object}
   */
  FormHandlerModel.prototype._getAttrKeyValues = function (form) {
    var data = {};

    fn.loopArray(form.attributes, function (i) {
      data[form.attributes[i].name] = form.attributes[i].value;
    });

    return data;
  };

  /**
   *
   * @param {string} name
   * @param {string} publicLink
   * @return {Object}
   */
  FormHandlerModel.prototype._getFormTemplate = function (name, publicLink) {
    var clone = this.formTemplates[name];

    clone.action = this._replacePlaceholder(clone.action, 'publicLink', publicLink);
    return clone;
  };

  /**
   *
   * @param {string} key
   * @return {string|null}
   */
  FormHandlerModel.prototype.getInputKeySuffix = function (key) {
    var match = key.match(/^(?!_D:).*\.(.*)$/);

    if (!match) return null;
    return match[1];
  };

  /**
   *
   * @param {Element} $inputs
   * @return {Object}
   */
  FormHandlerModel.prototype._getInputKeyValues = function ($inputs) {
    var data = {};

    fn.loopArray($inputs, function (i) {
      data[$inputs[i].name] = $inputs[i].value;
    });

    return data;
  };

  /**
   *
   * @param {string} target
   * @param {string} placeholder
   * @param {string} value
   * @return {string}
   */
  FormHandlerModel.prototype._replacePlaceholder = function (target, placeholder, value) {
    var regex = new RegExp('{' + placeholder + '}');

    return target.replace(regex, value);
  };

  /**
   *
   * @return {void}
   */
  FormHandlerModel.prototype._setFormTemplates = function () {
    this.formTemplates = {
      addToBasket: {
        id: 'addToBasket',
        name: '',
        method: 'post',
        action: '{publicLink}?_DARGS=/blocks/catalog/productdetailv2/multipleAddToBasketForms.jsp',
        oData: {
          _dyncharset: 'UTF-8',
          '': '-421045239635327304',
          '/atg/commerce/order/purchase/CartModifierFormHandler.catalogRefIds': '',
          '_D:/atg/commerce/order/purchase/CartModifierFormHandler.catalogRefIds': ' ',
          '/atg/commerce/order/purchase/CartModifierFormHandler.productId': '',
          '_D:/atg/commerce/order/purchase/CartModifierFormHandler.productId': ' ',
          '/atg/commerce/order/purchase/CartModifierFormHandler.skuId': '',
          '_D:/atg/commerce/order/purchase/CartModifierFormHandler.skuId': ' ',
          '/atg/commerce/order/purchase/CartModifierFormHandler.personalisedGUID': '',
          '_D:/atg/commerce/order/purchase/CartModifierFormHandler.personalisedGUID': ' ',
          '/atg/commerce/order/purchase/CartModifierFormHandler.personalisedImageURL': '',
          '_D:/atg/commerce/order/purchase/CartModifierFormHandler.personalisedImageURL': ' ',
          '/atg/commerce/order/purchase/CartModifierFormHandler.addItemToOrderSuccessURL': '/direct/blocks/catalog/productdetailv2/addToBasketResponse.jsp',
          '_D:/atg/commerce/order/purchase/CartModifierFormHandler.addItemToOrderSuccessURL': ' ',
          '/atg/commerce/order/purchase/CartModifierFormHandler.addItemToOrderErrorURL': '/direct/blocks/catalog/productdetailv2/addToBasketResponse.jsp',
          '_D:/atg/commerce/order/purchase/CartModifierFormHandler.addItemToOrderErrorURL': ' ',
          '/atg/commerce/order/purchase/CartModifierFormHandler.quantity': '1',
          '_D:/atg/commerce/order/purchase/CartModifierFormHandler.quantity': ' ',
          '/atg/commerce/order/purchase/CartModifierFormHandler.schoolId': '',
          '_D:/atg/commerce/order/purchase/CartModifierFormHandler.schoolId': ' ',
          '/atg/commerce/order/purchase/CartModifierFormHandler.schoolName': '',
          '_D:/atg/commerce/order/purchase/CartModifierFormHandler.schoolName': ' ',
          '/atg/commerce/order/purchase/CartModifierFormHandler.schoolLogoRef': '',
          '_D:/atg/commerce/order/purchase/CartModifierFormHandler.schoolLogoRef': ' ',
          '/atg/commerce/order/purchase/CartModifierFormHandler.addProductAndServices': 'submit',
          '_D:/atg/commerce/order/purchase/CartModifierFormHandler.addProductAndServices': ' ',
          _DARGS: '/blocks/catalog/productdetailv2/multipleAddToBasketForms.jsp'
        }
      }
    };
  };

  /**
   *
   * @param {Object} args
   * @return {string}
   */
  FormHandlerModel.prototype._updateRegexHook = function (args) {
    var property = '';

    fn.loopObject.call(this, args.oData, function loopData(prop) {
      if (prop.match(this._inputRegex(args.sProp))) {
        property = prop;
      }
    });

    return property;
  };

  /**
   *
   * @param {string} data
   * @return {Object}
   */
  FormHandlerModel.prototype.add = function (data) {
    var _data = data;

    if (typeof _data === 'string') {
      _data = this.serialize(_data);
    }

    return this.parent.add.call(this, _data);
  };

  /**
   *
   * @param {Object} args
   * @param {Object} options
   * @return {Object}
   */
  FormHandlerModel.prototype.clone = function (args, options) {
    var _args = args || {},
      _options = options || {},
      clone = null,
      component = _args.component,
      config = _args.config,
      inputs = {},
      name = _args.name,
      publicLink = _args.publicLink;

    if (typeof name !== 'string' && typeof component !== 'string'
        && typeof publicLink !== 'string') {
      return null;
    }

    clone = this._getFormTemplate(name, publicLink);

    if (!fn.isObject(clone, { notEmpty: true })) {
      return null;
    }

    inputs = clone.oData;

    fn.loopArray.call(this, config, function loopData(i) {
      if (fn.isObject(config[i]) && typeof config[i].key === 'string'
          && (config[i].value === undefined || typeof config[i].value === 'string')) {
        inputs = this.setInputValue(inputs, config[i].key, config[i].value, config[i].action);
      }
    }, { check: true });

    // Below swaps id and name values because they are returned the wrong way round in the
    // formhandler and swapped back when the form is added to the model. This is because of the
    // way ATG uses id for forms (generic per form type) and the way the frontend uses id (unique).
    // -- Dylan Aubrey (so24) 06/09/2016
    clone.name = component + '-' + this.createUniqueId();
    clone.oData = inputs;

    if (_options.add) {
      return this.add(clone);
    }

    return clone;
  };

  /**
   *
   * @param {Object} inputs
   * @param {string} suffix
   * @return {string}
   */
  FormHandlerModel.prototype.getInputValue = function (inputs, suffix) {
    var inputValue = '';

    fn.loopObject.call(this, inputs, function loopInputs(name) {
      if (name.match(this._inputRegex(suffix))) {
        inputValue = inputs[name];
      }
    });

    return inputValue;
  };

  /**
   *
   * @param {Element|string} value
   * @return {Object}
   */
  FormHandlerModel.prototype.serialize = function (value) {
    var data = null,
      form = typeof value === 'string' ? $(value)[0] : value,
      $inputs = $(form).find('input');

    data = this._getAttrKeyValues(form);
    data.oData = {};
    fn.mergeObjects(data.oData, this._getInputKeyValues($inputs), { extend: true });
    return data;
  };

  /**
   *
   * @param {Object} inputs
   * @param {string} suffix
   * @param {string} value
   * @param {string} action
   * @return {Object}
   */
  FormHandlerModel.prototype.setInputValue = function (inputs, suffix, value, action) {
    var _inputs = inputs;

    fn.loopObject.call(this, _inputs, function loopInputs(name) {
      if (name.match(this._inputRegex(suffix))) {
        if (action === 'append') {
          _inputs[name] += value;
        } else {
          _inputs[name] = value || '';
        }
      }
    });

    return _inputs;
  };

  module.exports = FormHandlerModel;
});


define('text!templates/views/inlineContentView.html',[],function () { return '<div id="{{sViewId}}" class="{{sViewClass}} {{sClassNames}} block-wrapper with-indents">\r\n  <div class="block">\r\n    <h2 class="block-title uppercase">{{{props.title}}}</h2>\r\n    <div class="block-content">\r\n      {{#state.hasCmsContent}}\r\n        <div id="cms-content">{{{props.cmsContent}}}</div>\r\n      {{/state.hasCmsContent}}\r\n      {{#state.hasExternalScript}}\r\n        <div id="flix-inpage"></div>\r\n        <div id="inline-content"></div>\r\n        {{#props.externalScript}}\r\n          {{{props.externalScript}}}\r\n        {{/props.externalScript}}\r\n      {{/state.hasExternalScript}}\r\n    </div>\r\n  </div>\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/InlineContentView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/show-more/ShowMore',
  'text!templates/views/inlineContentView.html'
], function ($, fn, BaseView, ShowMore, template) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function InlineContentView(config) {
    this.sViewName = 'InlineContentView';
    this.sNamespace = 'sku';
    this.sTag = 'inlineContent';
    this.sViewClass = 'inline-content-view';
    this.sTemplate = template;
    this.parent.constructor.call(this, config);
  }


  fn.inherit(InlineContentView, BaseView);
  InlineContentView._name = 'InlineContentView';
  InlineContentView.sNamespace = 'sku';
  InlineContentView.sTag = 'inlineContent';


  /**
   *
   * @param {Object} data
   * @param {Object} data.viewModel
   * @return {Object}
   */
  InlineContentView.prototype._setProps = function (data) {
    var viewModel = data.viewModel,
      externalScript = viewModel.externalScript;

    if (!fn.isObject(viewModel, { notEmpty: true })) {
      return {};
    }

    return {
      cmsContent: viewModel.cmsContent,
      externalScript: externalScript && '<script type="text/javascript" src="'
          + externalScript + '"></script>',
      title: viewModel.title
    };
  };


  /**
   *
   * @param {Object} data
   * @param {Object} data.viewModel
   * @return {Object}
   */
  InlineContentView.prototype._setStates = function (data) {
    var viewModel = data.viewModel;

    if (!fn.isObject(viewModel, { notEmpty: true })) {
      return {};
    }

    return {
      hasCmsContent: !!viewModel.cmsContent,
      hasExternalScript: viewModel.hasExternalScript
    };
  };


  /**
   *
   * @return {void}
   */
  InlineContentView.prototype._initDependancies = function () {
    var mvcData = this.oData.mvc,
      renderSource = mvcData.viewModel.renderSource,
      skuID = mvcData.sku.id,
      showMore = {},
      _this = this;

    if (renderSource === 'webcollage'
        && typeof fn.getValue(window.Webcollage, 'loadContent') === 'function') {
      window.Webcollage.loadContent('tescodirect-uk', skuID);
    }

    setTimeout(function () {
      showMore = new ShowMore({
        height: 700,
        selector: _this.oElms.elWrapper,
        subtreeListener: true
      });

      window.picturefill();
      showMore.fnInit();
    }, 100);
  };


  return InlineContentView;
});

define('modules/pdp/controllers/InlineContentController', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/controllers/BaseController',
  'modules/pdp/views/InlineContentView'
], function ($, fn, BaseController, InlineContentView) {
  'use strict';

  /**
   *
   * @param {Array<Object>} models
   * @return {void}
   */
  function InlineContentController(models) {
    this.sNamespace = 'sku';
    this.sTag = 'inlineContent';
    this.views = { classes: { InlineContentView: InlineContentView } };
    this.parent.constructor.call(this, models);
  }


  fn.inherit(InlineContentController, BaseController);
  InlineContentController.modelNames = ['sku'];


  /**
   *
   * @param {Object} args
   * @param {JQueryDeferred} args.deferred
   * @param {Object} args.mParamData
   * @param {Object} args.mParamData.mvc
   * @return {void}
   */
  InlineContentController.prototype._collateDataDependancies = function (args) {
    var _args = args,
      inlineMedia = {},
      masterDeferred = _args.deferred,
      mvcData = fn.getValue(_args, 'mParamData', 'mvc'),
      renderSource = '',
      skuData = null,
      skuModel = this.models.sku,
      viewModel = null;

    /**
     *
     * @param {Object} vm
     * @return {void}
     */
    function setDataAndResolve(vm) {
      _args.mParamData.mvc.viewModel = vm;
      masterDeferred.resolve(_args);
    }

    if (!fn.isObject(mvcData, { notEmpty: true })) {
      masterDeferred.reject();
      return;
    }

    skuData = mvcData.sku;
    viewModel = mvcData.viewModel;

    if (!fn.checkData(skuData) || !fn.isObject(viewModel, { notEmpty: true })) {
      masterDeferred.reject();
      return;
    }

    inlineMedia = skuModel.getSkuMedia(skuData, 'mediaType', 'Inline')[0] || {};

    if (!inlineMedia.src || !inlineMedia.renderSource) {
      masterDeferred.reject();
      return;
    }

    renderSource = inlineMedia.src.indexOf('webcollage') !== -1
        ? 'webcollage' : inlineMedia.renderSource;
    viewModel.renderSource = renderSource;

    if (renderSource === 'CMS' || renderSource === 'webcollage') {
      this._fetchContent(inlineMedia.src, renderSource === 'CMS' ? 'html' : 'script')
        .done(function handleFetchSuccess(content) {
          if (renderSource === 'CMS') {
            if (!content) {
              masterDeferred.reject();
            }
            viewModel.cmsContent = content;
          } else {
            viewModel.hasExternalScript = true;
          }

          setDataAndResolve(viewModel);
        })
        .fail(function handleFetchFailure() {
          masterDeferred.reject();
        });
    } else {
      viewModel.hasExternalScript = !!inlineMedia.src;
      viewModel.externalScript = inlineMedia.src;
      setDataAndResolve(viewModel);
    }
  };


  /**
   *
   * @param {String} url
   * @param {String} dataType
   * @return {JQueryPromise}
   */
  InlineContentController.prototype._fetchContent = function (url, dataType) {
    var deferred = $.Deferred();

    /**
     *
     * @param {Object} jqXHR
     * @param {Object} settings
     * @param {string} settings.url
     * @return {void}
     */
    function addURL(jqXHR, settings) {
      var _settings = settings;

      _settings.url = url;
    }

    $.ajax({ beforeSend: addURL, crossDomain: true, dataType: dataType })
      .done(function contentFetchSuccess(content) {
        deferred.resolve(content);
      })
      .fail(function cmsContentFetchFailure(errorResp) {
        deferred.reject(errorResp);
      });

    return deferred.promise();
  };


  return InlineContentController;
});

define('modules/pdp/data-stores/Inventory', [], function () {
  'use strict';

  var Inventory = function (data) {
    this.id = data.id || null;
    this.availability = data.availability || null;
    this.available = data.available || false;
    this.subscribable = data.subscribable || false;
    this.skus = data.skus || null;
    this.listings = data.listings || null;
  };

  return Inventory;
});

define('modules/pdp/models/InventoryProductModel', [
  'modules/mvc/fn',
  'modules/pdp/data-stores/Inventory',
  'modules/pdp/models/BaseModel'
], function (fn, InventoryDS, BaseModel) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function InventoryProductModel(config) {
    this.DataStoreClass = InventoryDS;
    this.sNamespace = 'inventoryProduct';
    this.parent.constructor.call(this, config);
  }

  fn.inherit(InventoryProductModel, BaseModel);

  InventoryProductModel.prototype.createEndpoint = function (args) {
    var endpoints = [],
      endpoint = null,
      url = '';

    endpoint = this.oDataEndpointMap.getEndpoint(this.sNamespace);

    if (endpoint && args.values.length) {
      url = endpoint.action.fetch.href;
      url += args.values.join(',');
      url += '?format=standard';

      if (typeof args.createEndpointCallback === 'function') {
        url = args.createEndpointCallback(url);
      }

      endpoints.push(url);
    }

    return endpoints;
  };

  InventoryProductModel.prototype.dataHandler = function (oResponse) {
    if (oResponse.products.length > 0) {
      this.add(oResponse.products);
    }
  };

  return InventoryProductModel;
});

define('modules/pdp/models/InventorySKUModel', [
  'modules/mvc/fn',
  'modules/pdp/data-stores/Inventory',
  'modules/pdp/models/BaseModel'
], function (fn, InventoryDS, BaseModel) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function InventorySKUModel(config) {
    this.DataStoreClass = InventoryDS;
    this.sNamespace = 'inventorySKU';
    this.parent.constructor.call(this, config);
  }

  fn.inherit(InventorySKUModel, BaseModel);

  InventorySKUModel.prototype.createEndpoint = function (args) {
    var endpoints = [],
      endpoint = null,
      url = '';

    endpoint = this.oDataEndpointMap.getEndpoint(this.sNamespace);

    if (endpoint && args.values.length) {
      url = endpoint.action.fetch.href;
      url += args.values.join(',');
      url += '?format=standard';

      if (typeof args.createEndpointCallback === 'function') {
        url = args.createEndpointCallback(url);
      }

      endpoints.push(url);
    }

    return endpoints;
  };

  InventorySKUModel.prototype.dataHandler = function (oResponse) {
    if (oResponse.skus.length > 0) {
      this.add(oResponse.skus);
    }
  };

  return InventorySKUModel;
});

define('modules/pdp/data-stores/InventoryStore', [], function () {
  'use strict';

  /**
   * The data object for the inventory store / stock availability.
   * @param {Object} data The properties to map into the inventory store data object.
   * @return {void}
   */
  function InventoryStore(data) {
    this.available = data.available;
    this.id = data.id || null;
    this.location = data.location || null;
    this.productReference = data.productReference || null;
    this.stock_status = data.stock_status || null;
    this.stockStatusMessage = data.stockStatusMessage || null;
  }

  return InventoryStore;
});

define('modules/pdp/models/InventoryStoreModel', [
  'modules/mvc/fn',
  'modules/pdp/data-stores/InventoryStore',
  'modules/pdp/models/BaseModel'
], function (fn, InventoryStore, BaseModel) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function InventoryStoreModel(config) {
    this.DataStoreClass = InventoryStore;
    this.sNamespace = 'inventoryStore';
    this.parent.constructor.call(this, config);
  }

  fn.inherit(InventoryStoreModel, BaseModel);

  InventoryStoreModel.prototype.createEndpoint = function (args) {
    var values = args.values,
      endpoints = [],
      endpoint = null,
      url = '',
      storeIds = '',
      listingId = '';

    endpoint = this.oDataEndpointMap.getEndpoint(this.sNamespace);

    if (endpoint && args.values.length) {
      url = endpoint.action.fetch.href;
      storeIds = values[0];
      listingId = values[1];
      url = url.replace(/({STOREIDS})/, storeIds).replace(/({LISTINGID})/, listingId);
      endpoints.push(url);
    }

    return endpoints;
  };

  InventoryStoreModel.prototype.dataHandler = function (data) {
    var oData = data,
      i = 0,
      aAvailabilities = [],
      sStockStatus = '';

    if (oData.availabilities.length > 0) {
      for (i; i < oData.availabilities.length; i += 1) {
        if (!oData.availabilities[i].error) {
          sStockStatus = oData.availabilities[i].stock_status;
          oData.availabilities[i].id = oData.availabilities[i].location.id;
          oData.availabilities[i].stockStatusMessage = sStockStatus.substring(0, 1) + sStockStatus.substring(1).toLowerCase().replace(/_/gi, ' ');
          aAvailabilities.push(oData.availabilities[i]);
        }
      }
      this.add(aAvailabilities);
    }
  };

  return InventoryStoreModel;
});

define('modules/pdp/controllers/ItemActionsController', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/controllers/BaseController',
  'modules/pdp/views/ItemActionsView'
], function ($, fn, BaseController, ItemActionsView) {
  /**
   * Controller to manage item action views.
   * @param {Object} model The form handler model.
   * @param {Object} view The personalise view.
   * @return {void}
   */
  function ItemActionsController() {
    this.sNamespace = 'inherit';
    this.sTag = 'itemActions';
    this.views = {
      classes: {
        ItemActionsView: ItemActionsView
      }
    };
    this.parent.constructor.call(this);
  }

  fn.inherit(ItemActionsController, BaseController);

  ItemActionsController.prototype._bindEvents = function () {
    $(window).on(
      'disableItemActions',
      this._handleDisableItemActions.bind(this)
    ).on(
      'enableItemActions',
      this._handleEnableItemActions.bind(this)
    );
  };

  ItemActionsController.prototype._handleDisableItemActions = function (event) {
    var view = this._getItemActionsView(event.oData.listingId);

    if (!view || !document.getElementById(view.sViewId)) {
      this._pendingActions.push(function pendingDisableItemActions() {
        var v = this._getItemActionsView(event.oData.listingId);

        if (v) {
          this._disableItemActions(v);
          return true;
        }
        return false;
      });
    } else {
      this._disableItemActions(view);
    }
  };

  ItemActionsController.prototype._disableItemActions = function (view) {
    this.forLoop(view.oData.aSubViews, function loopSubviews(i) {
      if (view.oData.aSubViews[i].disable) {
        view.oData.aSubViews[i].disable();
      }
    });
  };

  ItemActionsController.prototype._handleEnableItemActions = function (event) {
    var view = this._getItemActionsView(event.oData.listingId);

    if (!view || !document.getElementById(view.sViewId)) {
      this._pendingActions.push(function pendingEnableItemActions() {
        var v = this._getItemActionsView(event.oData.listingId);

        if (v) {
          this._enableItemActions(v);
          return true;
        }
        return false;
      });
    } else {
      this._enableItemActions(view);
    }
  };

  ItemActionsController.prototype._enableItemActions = function (view) {
    this.forLoop(view.oData.aSubViews, function loopSubviews(i) {
      if (view.oData.aSubViews[i].enable) {
        view.oData.aSubViews[i].enable();
      }
    });
  };

  ItemActionsController.prototype._getItemActionsView = function (listingId) {
    return this._getStoredView('ItemActionsView', function getItemActionsView(v) {
      var data = v.oData.mvc;

      if (this.isObject(data.sellers) && data.sellers.id === listingId) {
        return v;
      }
      return null;
    });
  };

  return ItemActionsController;
});

define('modules/pdp/views/KioskProductPageTitleView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView'
], function ($, fn, BaseView) {
  'use strict';

  var KioskProductPageTitleView = function (oConfig) {
    this.sViewName = 'KioskProductPageTitleView';
    this.sNamespace = 'products';
    this.sViewClass = 'product-page-title';
    this.sTemplate = $('#kiosk-product-page-title-template')[0].innerHTML;
    this.parent.constructor.call(this, oConfig);
  };

  fn.inherit(KioskProductPageTitleView, BaseView);

  KioskProductPageTitleView._name = 'KioskProductPageTitleView';
  KioskProductPageTitleView.sNamespace = 'products';

  KioskProductPageTitleView.prototype._setData = function (mViewData) {
    this.parent._setData.call(this, mViewData);

    this.oData.mvc.vm.sFFlogoClass = this.oModel.isFFBranded(mViewData.id)
        ? 'icon-FFlogo' : '';
    this.oData.mvc.vm.bOnlineExclusive = mViewData.dynamicAttributes
        && mViewData.dynamicAttributes.online_exclusive === 'Y';
    this.oData.mvc.vm.sGlobalStaticAssetsPath = window.globalStaticAssetsPath;

    this.oData.mvc.vm.title = this.oModel.isFF(mViewData.id)
        ? this.oData.mvc.products.displayName : this.oData.mvc.sku.displayName;
  };

  KioskProductPageTitleView.prototype._cacheDomElms = function () {
    this.parent._cacheDomElms.call(this);
    this.oElms.elRatingMask = $('.' + this.sViewClass + ' .rating-mask') || null;
  };

  KioskProductPageTitleView.prototype._bindEvents = function () {
    if (this.oElms.elRatingMask) {
      $(this.oElms.elRatingMask).on(
        'click',
        this._onRatingMaskClick.bind(this)
      );
    }
  };

  KioskProductPageTitleView.prototype._onRatingMaskClick = function () {
    var eTriggerKioskTab = $.Event('triggerKioskTab', { sViewName: 'KioskProductReviewsView' });

    $(window).trigger(eTriggerKioskTab);
  };

  return KioskProductPageTitleView;
});

define('modules/pdp/views/ProductSpecView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/jargon-buster/common',
  'modules/show-more/ShowMore'
], function ($, fn, BaseView, jargonBuster, ShowMore) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @param {String} config.sTemplate
   * @return {void}
   */
  function ProductSpecView(config) {
    this.sViewName = 'ProductSpecView';
    this.sNamespace = 'sku';
    this.sViewClass = 'product-spec-block';
    this.sTemplate = config.sTemplate
        ? $(config.sTemplate)[0].innerHTML
        : $('#product-spec-template')[0].innerHTML;
    this.parent.constructor.call(this, config);
  }

  fn.inherit(ProductSpecView, BaseView);

  ProductSpecView._name = 'ProductSpecView';
  ProductSpecView.sNamespace = 'sku';

  ProductSpecView.prototype._initDependancies = function () {
    var oShowMore = null,
      _this = this;

    if (this.oData.mvc.custom !== undefined) {
      if (this.oData.mvc.flags.inPanel) {
        return;
      }
    }

    jargonBuster.init();

    if (this.oData.mvc.products.dynamicAttributes.supplier !== 'FF') {
      setTimeout(function () {
        oShowMore = new ShowMore({
          selector: _this.oElms.elTarget,
          height: 600,
          label: 'specs'
        });
        oShowMore.fnInit();
      }, 100);
    }
  };

  ProductSpecView.prototype._setData = function (params) {
    var data = [];
    this.parent._setData.call(this, params);

    this.oData.mvc.vm.sku = {};

     fn.loopObject(params.specification, function loopSpec(prop) {
      data.push({
        groupName: prop,
        groupAttributes: params.specification[prop]
      });
    });

     this.oData.mvc.vm.sku.specification = data;
  };

  return ProductSpecView;
});

define('modules/pdp/views/ProductCLPView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView'
], function (
  $,
  fn,
  BaseView
) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function ProductCLPView(config) {
    this.sViewName = 'ProductCLPView';
    this.sNamespace = 'products';
    this.sTag = 'productCLP';
    this.sViewClass = 'product-clp-view';
    this.sTemplate = $('#product-clp-view-template')[0].innerHTML;
    this.parent.constructor.call(this, config);
  }

  fn.inherit(ProductCLPView, BaseView);
  ProductCLPView._name = 'ProductCLPView';
  ProductCLPView.sNamespace = 'products';
  ProductCLPView.sTag = 'productCLP';

  ProductCLPView.prototype._setProps = function (mvcData) {
    var productData = mvcData.products;

    if (!this.isObject(productData, true)) {
      return null;
    }

    return {
      pictographs: this.isArray(productData.classifactionLabelingPackaging, true)
          ? productData.classifactionLabelingPackaging : [],
      statement: this.isObject(productData.dynamicAttributes, true)
          ? productData.dynamicAttributes.clpStatement : null,
      classes: !this.oData.mvc.flags.isKiosk ? 'block-wrapper with-indents' : ''
    };
  };

  ProductCLPView.prototype._setStates = function (mvcData) {
    var productData = mvcData.products;

    if (!this.isObject(productData, true)) {
      return null;
    }

    return {
      hasProductWarnings: (this.isArray(productData.classifactionLabelingPackaging, true))
          || (this.isObject(productData.dynamicAttributes, true)
          && !!productData.dynamicAttributes.clpStatement)
    };
  };

  return ProductCLPView;
});

define('modules/pdp/views/KioskProductDetailsView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/pdp/views/ProductSpecView',
  'modules/tesco.utils',
  'modules/pdp/views/ProductCLPView'
], function ($, fn, BaseView, ProductSpecView, tescoUtils, ProductCLPView) {
  'use strict';

  var KioskProductDetailsView = function (oConfig) {
    this.sViewName = 'ProductDetailsView';
    this.sNamespace = 'products';
    this.sTag = '_default';
    this.sViewClass = 'product-details';
    this.sTemplate = $('#kiosk-product-details-template')[0].innerHTML;
    this.parent.constructor.call(this, oConfig);
  };

  fn.inherit(KioskProductDetailsView, BaseView);

  KioskProductDetailsView._name = 'ProductDetailsView';
  KioskProductDetailsView.sNamespace = 'products';

  KioskProductDetailsView.prototype._setData = function (args) {
    this.parent._setData.call(this, args);
    this.oData.mvc.vm.bFFBrandProduct = this.oModel.isFFBranded(this.oData.mvc.products.id);

    if (this.oData.mvc.products.dynamicAttributes
        && this.oData.mvc.products.dynamicAttributes.onlineExclusive === 'Y') {
      this.oData.mvc.vm.bOnlineExclusive = true;
    }
  };

  KioskProductDetailsView.prototype._addSubViews = function () {
    var productDetails = [];

    if (this.oModel.isFF(this.oData.mvc.products.id)) {
      productDetails.push(this._compileSubView({
        _class: ProductSpecView,
        template: '#product-spec-enclosed-template',
        ctlr: true
      }));
      productDetails.push(this._compileSubView({ _class: ProductCLPView, ctlr: true }));
      this.oData.views.productDetails = productDetails;
    }
  };

  KioskProductDetailsView.prototype._setStates = function (data) {
    var skuData = data.sku,
      productData = data.products,
      personalisable = false;

    if (this.isObject(skuData, true)
        && this.isObject(skuData.attributes, true)
        && skuData.attributes.personalisable === 'Y') {
      personalisable = true;
    }

    return {
      alreadyInBasket: personalisable && !!tescoUtils.getQueryStringParam('alreadyInBasket'),
      hasUES: this.isObject(productData.ues, true)
    };
  };

  return KioskProductDetailsView;
});

define('modules/pdp/views/ProductMediaViewerStaticImageView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView'
], function ($, fn, BaseView) {
  'use strict';

  var ProductMediaViewerStaticImageView = function (oConfig) {
    this.sViewName = 'ProductMediaViewerStaticImageView';
    this.sNamespace = 'sku';
    this.sTag = '_default';
    this.sViewClass = 'product-media-viewer-static-image';
    this.sTemplate = $('#product-media-viewer-static-image-template')[0].innerHTML;
    this.parent.constructor.call(this, oConfig);
  };

  fn.inherit(ProductMediaViewerStaticImageView, BaseView);
  ProductMediaViewerStaticImageView._name = 'ProductMediaViewerStaticImageView';
  ProductMediaViewerStaticImageView.sNamespace = 'sku';

  ProductMediaViewerStaticImageView.prototype._setData = function (mViewData) {
    this.parent._setData.call(this, mViewData);
    this.oData.mvc.sku.mediaAssets.defaultImage.src = this._sanitiseDataForView();
  };

  ProductMediaViewerStaticImageView.prototype._sanitiseDataForView = function () {
    var PRESET_PLACEHOLDER = '[preset]',
      sUpdatedPreset = 'Portrait-XL',
      oDefaultImage = this.oData.mvc.sku.mediaAssets.defaultImage;

    if (this.oData.mvc.flags.isKiosk) {
      if (this._checkForMissingImage(oDefaultImage.src) || this.oData.mvc.sku.bookDetails) {
        sUpdatedPreset = 'Detail';
      } else {
        PRESET_PLACEHOLDER = this._setKioskStaticImagePreset(oDefaultImage.src);
        sUpdatedPreset = '';
      }
    }

    return oDefaultImage.src.replace(PRESET_PLACEHOLDER, sUpdatedPreset);
  };

  ProductMediaViewerStaticImageView.prototype._checkForMissingImage = function (sImageURL) {
    return !!sImageURL.match('Default_image_unavailable');
  };

  ProductMediaViewerStaticImageView.prototype._setKioskStaticImagePreset = function (sImageURL) {
    var PRESET_PLACEHOLDER_WITH_UNDERSCORE = '_[preset]',
      PRESET_PLACEHOLDER = '[preset]',
      sStaticImagePreset = 'Detail';

    if (sImageURL.match(PRESET_PLACEHOLDER)) {
      sStaticImagePreset = PRESET_PLACEHOLDER;
    } else
    if (sImageURL.src.match(PRESET_PLACEHOLDER_WITH_UNDERSCORE)) {
      sStaticImagePreset = PRESET_PLACEHOLDER_WITH_UNDERSCORE;
    }

    return sStaticImagePreset;
  };

  return ProductMediaViewerStaticImageView;
});

define('modules/pdp/views/ProductPingView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView'
], function ($, fn, BaseView) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function ProductPingView(config) {
    this.sViewName = 'ProductPingView';
    this.sNamespace = 'sku';
    this.sTag = 'ping';
    this.sViewClass = 'product-ping';
    this.sTemplate = $('#product-ping-template')[0].innerHTML;
    this.parent.constructor.call(this, config);
  }


  fn.inherit(ProductPingView, BaseView);
  ProductPingView._name = 'ProductPingView';
  ProductPingView.sNamespace = 'sku';
  ProductPingView.sTag = 'ping';


  ProductPingView.prototype._setProps = function (data) {
    var skuData = data.sku,
      ping = fn.getValue(skuData, 'mediaAssets', 'pings', 0);

    if (!fn.isObject(ping, { notEmpty: true })) {
      return {};
    }

    return {
      mediaType: ping.mediaType,
      srcSmall: this._populateImageTemplate(ping.src, 'small'),
      srcLarge: this._populateImageTemplate(ping.src, 'large')
    };
  };


  ProductPingView.prototype._populateImageTemplate = function (src, type) {
    var PLACEHOLDER = '$[preset]$',
      PRESET_LARGE = 'lg',
      PRESET_SMALL = 'sm',
      preset = '',
      _src = src || '';

    if (type === 'large') {
      preset = PRESET_LARGE;
    } else if (type === 'small') {
      preset = PRESET_SMALL;
    }

    return _src.replace(PLACEHOLDER, preset);
  };


  ProductPingView.prototype._initDependancies = function () {
    window.picturefill();
  };


  return ProductPingView;
});

define('modules/pdp/views/ProductMediaViewerView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/pdp/views/ProductMediaViewerStaticImageView',
  'modules/pdp/views/ProductPingView'
], function (
  $,
  fn,
  BaseView,
  ProductMediaViewerStaticImageView,
  ProductPingView
) {
  var ProductMediaViewerView = function (oConfig) {
    this.sViewName = 'ProductMediaViewerView';
    this.sNamespace = 'sku';
    this.sTag = '_default';
    this.sViewClass = 'product-media-viewer';
    this.sTemplate = $('#product-media-viewer-template')[0].innerHTML;
    this.parent.constructor.call(this, oConfig);
  };

  fn.inherit(ProductMediaViewerView, BaseView);

  ProductMediaViewerView.sNamespace = 'sku';

  ProductMediaViewerView.prototype._setData = function (mViewData) {
    this.parent._setData.call(this, mViewData);

    this.oData.oProductMediaViewerStaticImageView = this._compileSubView({
      _class: ProductMediaViewerStaticImageView
    });

    this.oData.oProductPingView = this._compileSubView({
      _class: ProductPingView
    });
  };

  return ProductMediaViewerView;
});

define('modules/pdp/media-viewer/config', ['domlib'], function ($) {
  'use strict';

  var oConfig = {};

  oConfig.sDOM_SELECTORS = {
    container: '#media-viewer-container',

    mvStaticImage: '.static-product-image',
    mvStaticImageElement: '#scene7-placeholder',

    wrapper: '#media-viewer-wrapper',

    pings: '.media-viewer--pings',
    mvProductPing: 'div.product-ping',

    mvCarouselNav: 'div.media-viewer--carousel-nav',
    mvImageViewerCarouselItemPrevNext: '.btn-s7-carousel',
    mvImageViewerCarouselItemPrev: '.btn-s7-prev:not(.btn-s7-carousel-fade-out)',
    mvImageViewerCarouselItemNext: '.btn-s7-next:not(.btn-s7-carousel-fade-out)',

    mvMain: '#media-viewer--main',
    mv: '#media-viewer',
    mvInner: '#media-viewer-inner',
    s7containerPlaceholder: '#mediaViewerScene7Container',
    s7container: '#s7container',
    mvImageViewerCarousel: '.image-viewer-carousel',
    mvImageViewerCarouselItem: '.image-viewer-carousel li',

    s7containerMask: '#s7container-mask',

    sidebar: '#media-viewer--sidebar',
    mvMediaThumbnails: '.mv-thumbnail-container',
    mvCarousel: '.mv-thumbnail-carousel',
    mvCarouselItem: '.mv-thumbnail-carousel li',
    mvCounter: '#mv-carousel-index',

    mvDots: '.media-viewer-markers',
    mvDotsItem: '.media-viewer-markers li',
    mvMediaDots: '#mv-dotMarker-innerWrapper',

    videoContainer: 'div.videoContainer',
    videoControlsWrapper: '.video-controls',
    currentVideo: '.videoPosition video',
    featureButton: '#fnFeatureButton',

    mvOverlayContent: '#mv-overlay-content',

    zoomIcon: '.icon-zoom',

    templates: {
      thumbnails: '#media-viewer-thumbnails-template',
      imageViewer: '#image-viewer-carousel-template',
      imageViewerDots: '#image-viewer-dots-template',
      playButton: '<div class="btn-feature-media highlight" id="fnFeatureButton"><span class="icon icon-play"></span> View catwalk</div>',
      spinButton: '<div class="btn-feature-media highlight" id="fnFeatureButton"><span class="icon icon-spin"></span> View 360</div>',
      ping: '#product-ping-template',
      staticImageLandscape: '#landscape-static-image-viewer-carousel-template',
      staticImagePortrait: '#portrait-static-image-viewer-carousel-template'
    }
  };

  oConfig.oDomElements = {
    $window: $(window),
    $container: null,
    $wrapper: null,
    $sidebar: null,
    $mv: null,
    $s7containerPlaceholder: null,
    $s7container: null,
    $mvMediaDots: null,
    $pings: null,
    $s7containerMask: null,
    $featureButton: null,
    $mvStaticImageElement: null
  };

  oConfig.oSettings = {
    sOrientation: '',
    oDimensions: {
      portrait: {
        oThumbnails: {
          DEFAULT_WIDTH: 73,
          WIDTH: 73,
          DEFAULT_HEIGHT: 104,
          HEIGHT: 116
        },
        oDots: {
          WIDTH: 10,
          HEIGHT: 10
        },
        oKiosk: {
          MEDIA_VIEWER: {
            WIDTH: 730,
            HEIGHT: 740
          }
        }
      },
      landscape: {
        oThumbnails: {
          DEFAULT_WIDTH: 90,
          WIDTH: 100,
          DEFAULT_HEIGHT: 90,
          HEIGHT: 92
        },
        oDots: {
          WIDTH: 10,
          HEIGHT: 10
        }
      }
    },
    bDisableScene7: window.isKiosk()
  };

  return oConfig;
});

define('modules/pdp/media-viewer/arrowsHandler', [
  'domlib',
  'modules/breakpoint',
  'modules/pdp/media-viewer/config'
], function ($, breakpoint, config) {
  'use strict';

  var arrowsHandler = null,
    _imageViewerThumbArrows = null,
    _bindVideoViewEvents = null,
    _fnArrowVisibilityHandler = null;

  _imageViewerThumbArrows = function imageViewerThumbArrows(oMediaThumbnails, oMedia) {
    var iVisibleThumbnails = 0,
      iThumbnailTotal = 0;

    if (typeof oMediaThumbnails === 'object' && typeof oMedia === 'object') {
      if (oMediaThumbnails.options.vertical) {
        iVisibleThumbnails = 3;
      } else if (breakpoint.kiosk) {
        iVisibleThumbnails = 7;
      } else {
        iVisibleThumbnails = breakpoint.largeDesktop ? 8 : 5;
      }

      iThumbnailTotal = iVisibleThumbnails - 1;

      if (oMedia.getCollectionLength() > 0) {
        if (oMediaThumbnails.options.itemSelector) {
          $(oMediaThumbnails.options.itemSelector).first().addClass('active');
        }
      }

      if (oMedia.getCollectionLength() > iThumbnailTotal) {
        $(oMediaThumbnails.options.nextClass, oMediaThumbnails.$element)
          .parent()
          .removeClass('disabled');
      }
    }
  };

  _bindVideoViewEvents = function bindVideoViewEvents() {
    config.oDomElements.$s7containerPlaceholder
      .off('BasicVideoPlayer.play', config.sDOM_SELECTORS.videoContainer)
      .on('BasicVideoPlayer.play', config.sDOM_SELECTORS.videoContainer, function () {
        _fnArrowVisibilityHandler(false);
      })
      .off('BasicVideoPlayer.pause', config.sDOM_SELECTORS.videoContainer)
      .on('BasicVideoPlayer.pause', config.sDOM_SELECTORS.videoContainer, function () {
        _fnArrowVisibilityHandler(true);
      });

    $('video#s7HTML5VideoPlayer').on('ended', function () {
      _fnArrowVisibilityHandler(true);
    });
  };

  _fnArrowVisibilityHandler = function fnArrowVisibilityHandler(bForceState) {
    if (bForceState) {
      $(config.sDOM_SELECTORS.mvImageViewerCarouselItemPrevNext).show();
    } else {
      $(config.sDOM_SELECTORS.mvImageViewerCarouselItemPrevNext).hide();
    }
  };

  arrowsHandler = {
    imageViewerThumbArrows: _imageViewerThumbArrows,
    bindVideoViewEvents: _bindVideoViewEvents,
    toggleArrowVisibility: _fnArrowVisibilityHandler
  };

  return arrowsHandler;
});

/*jslint plusplus: true */
define('modules/media-asset-manager/common', [], function () {
    'use strict';

    var MediaAssetManager,
        MediaAsset;

    MediaAssetManager = function MediaAssetManager() {
        this.aMediaCollection = [];
    };

    MediaAssetManager.prototype.addMedia = function addMedia(mMediaSet, sMediaType, position, mediaAssetProps) {
        var i, mediaAssetSet = [], oTempMediaAsset, tempSetStart, tempSetEnd, index, iMediaSetLength, aMediaSet;

        if ((mMediaSet === "" || mMediaSet === undefined) || !sMediaType) {
            return;
        }

        if (!Array.isArray(mMediaSet)) {
            aMediaSet = mMediaSet.split(',');
        } else {
            aMediaSet = mMediaSet;
        }

        iMediaSetLength = aMediaSet.length;

        if (iMediaSetLength > 0) {
            for (i = 0; i < iMediaSetLength; i++) {
                oTempMediaAsset = new MediaAsset(aMediaSet[i], sMediaType, i, mediaAssetProps);
                mediaAssetSet.push(oTempMediaAsset);
            }

            if (!position || position === 'append') {
                this.aMediaCollection = this.aMediaCollection.concat(mediaAssetSet);
            } else if (position === 'prepend') {
                this.aMediaCollection = mediaAssetSet.concat(this.aMediaCollection);
            } else if (typeof position === 'number') {
                index = position - 1;
                tempSetStart = this.aMediaCollection.slice(0, index);
                tempSetEnd = this.aMediaCollection.slice(index, this.aMediaCollection.length);
                this.aMediaCollection = tempSetStart.concat(mediaAssetSet, tempSetEnd);
            }
        }
    };

    MediaAssetManager.prototype.removeMedia = function (args) {
        if (typeof args.mediaAsset === 'function') {
            args.mediaAsset(this.aMediaCollection);
        }
    };

    MediaAssetManager.prototype.getCollectionLength = function getCollectionLength() {
        return this.aMediaCollection.length;
    };

    MediaAssetManager.prototype.getMediaByIndex = function getMediaByIndex(iIndex) {
        if (typeof iIndex !== 'number') {
            throw new Error('The "getMediaByIndex" method arguments MUST NOT be undefined and MUST be a number');
        }
        if (Array.isArray(this.aMediaCollection) && this.getCollectionLength() > 0) {
            return this.aMediaCollection[iIndex];
        }
    };

    MediaAssetManager.prototype.addToCollection = function addToCollection(iIndex, property, value) {
        if (this.getCollectionLength() > 0 && this.aMediaCollection[iIndex]) {
            this.aMediaCollection[iIndex][property] = value;
        }
    };

    MediaAssetManager.prototype.getMediaType = function getMediaType(iIndex) {
        return this.aMediaCollection[iIndex].mediaType;
    };

    MediaAsset = function MediaAsset(sMediaSrc, sMediaType, iMediaSetIndex, mediaAssetProps) {
        this.mediaSrc = sMediaSrc || null;
        this.mediaType = sMediaType || null;
        this.mediaSetIndex = iMediaSetIndex;

        if (mediaAssetProps && typeof mediaAssetProps === 'object' && !Array.isArray(mediaAssetProps)) {
            $.extend(true, this, mediaAssetProps);
        }
    };

    return MediaAssetManager;
});

define('modules/pdp/views/OverlayPanelGroupView', [
  'modules/mvc/fn',
  'modules/pdp/views/BasePanelGroupView'
], function (fn, BasePanelGroupView) {
  'use strict';

  /**
   * Use for all generic overlays.
   * @param {Object} oConfig The configuration for the view.
   * @return {void}
   */
  function OverlayPanelGroupView(oConfig) {
    this.sTag = oConfig.sTag || null;
    this.sPanelType = 'group';
    this.sViewClass = 'info-panel-group-overlay';
    this.parent.constructor.call(this, oConfig);
  }

  fn.inherit(OverlayPanelGroupView, BasePanelGroupView);

  return OverlayPanelGroupView;
});

define('modules/pdp/views/OverlayPanelView', [
  'modules/mvc/fn',
  'modules/pdp/views/BasePanelView'
], function (fn, BasePanelView) {
  'use strict';

  /**
   * Use for all generic overlays.
   * @param {Object} oConfig The configuration for the view.
   * @return {void}
   */
  function OverlayPanelView(oConfig) {
    this.sTag = oConfig.sTag || null;
    this.sViewClass = 'info-panel-overlay';
    this.parent.constructor.call(this, oConfig);
  }

  fn.inherit(OverlayPanelView, BasePanelView);

  return OverlayPanelView;
});

define('modules/pdp/media-viewer/overlay', [
  'modules/pdp/media-viewer/config',
  'modules/pdp/views/OverlayPanelGroupView',
  'modules/pdp/views/OverlayPanelView',
  'modules/breakpoint'
], function (
  config,
  OverlayPanelGroupView,
  OverlayPanelView,
  breakpoint
) {
  'use strict';

  var mediaViewerOverlay = {},
    oOverlayPanelGroup = {},
    oOverlayPanel = {};

  /**
   *
   * @return {void}
   */
  function fnShowOverlay() {
    config.oDomElements.$wrapper.detach();
    $(config.sDOM_SELECTORS.mvOverlayContent).append(config.oDomElements.$wrapper);
    $('#mv-overlay-content #s7container').hide();
    oOverlayPanel.open();
    oOverlayPanel.isOpen = true;
    config.oDomElements.$container.trigger('MediaViewer.showOverlay');
  }

  /**
   *
   * @return {void}
   */
  function fnCloseOverlay() {
    config.oDomElements.$wrapper.detach();
    config.oDomElements.$wrapper.insertAfter(config.sDOM_SELECTORS.mvStaticImage);
    oOverlayPanel.isOpen = false;
    config.oDomElements.$container.trigger('MediaViewer.closeOverlay');
  }

  /**
   *
   * @return {void}
   */
  function fnRenderOverlay() {
    var oParamData = {};

    if (!breakpoint.desktop && !breakpoint.largeDesktop) {
      return;
    }

    oParamData = {
      oStyles: {
        allDesktops: ['fullBleed', 'fullScreen'],
        allDevices: ['fullBleed', 'fullScreen']
      },
      oData: {
        sClassNames: config.oSettings.sOrientation === 'portrait'
            ? 'media-viewer--portrait' : 'media-viewer--landscape'
      },
      elTarget: $('body')[0]
    };

    oOverlayPanelGroup = new OverlayPanelGroupView({
      oStyles: oParamData.oStyles,
      sTag: null,
      sViewName: 'OverlayPanelGroupView',
      oData: {
        sClassNames: oParamData.oData.sClassNames
      },
      elTarget: oParamData.elTarget
    });

    oOverlayPanelGroup._panelGroupClosedHook = function (oEvent) {
      fnCloseOverlay();
      this.destroy(oEvent);
    };

    oOverlayPanel = oOverlayPanelGroup.createSubView({
      ViewClass: OverlayPanelView,
      mParamData: {
        sViewName: 'OverlayPanelView',
        oStyles: oParamData.oStyles,
        elTrigger: null,
        oData: {
          sClassNames: oParamData.oData.sClassNames,
          sTitle: null,
          aSubViews: [{ render: '<div id="mv-overlay-content"></div>' }]
        },
        iSubViewCount: 1
      }
    });

    oOverlayPanel.isOpen = false;
    oOverlayPanelGroup.render();

    fnShowOverlay();
  }

  mediaViewerOverlay = {
    render: fnRenderOverlay,
    show: fnShowOverlay,
    close: fnCloseOverlay
  };

  return mediaViewerOverlay;
});

define('modules/pdp/media-viewer/analytics', [
  'modules/tesco.analytics',
  'modules/device-specifications/common',
  'modules/pdp/media-viewer/config'
], function (
  analytics,
  deviceSpecifications,
  config
) {
  'use strict';

  var mediaViewerAnalytics = {},
    oAnalyticsVars = {};

  mediaViewerAnalytics.analyticsThumbClick = function (analyticThumbIndex) {
    var imagePathFull = null,
      imagePathTruncate = null,
      imageIdentity = null,
      _oWebAnalytics = new analytics.WebMetrics();

    imagePathFull = $(config.sDOM_SELECTORS.mvCarousel).find('.active img').attr('src');

    if (imagePathFull === undefined || imagePathFull === null) {
      imagePathFull = $(config.sDOM_SELECTORS.mvCarousel).find('.active span').attr('class');
    }

    imagePathTruncate = imagePathFull.split('?')[0];
    imageIdentity = imagePathTruncate.substring(
      imagePathTruncate.lastIndexOf('/') + 1, imagePathTruncate.length
    );

    _oWebAnalytics.submit([{
      prop19: 'carousel items container - ' + imageIdentity,
      eVar45: 'carousel items container - ' + imageIdentity,
      prop42: 'pdp - carousel items container - p' + analyticThumbIndex,
      eVar59: 'pdp - carousel items container - p' + analyticThumbIndex,
      events: 'event45'
    }]);
  };

  mediaViewerAnalytics.setOmnitureDefaults = function setOmnitureDefaults() {
    var sBreadCrumbText = [],
      sText = '';

    $('li a', $('#breadcrumb')).each(function () {
      sText = $.trim($(this).text());
      sBreadCrumbText.push(sText);
    });

    if (sBreadCrumbText[1]) {
      oAnalyticsVars.prop1 = sBreadCrumbText[1];
    }

    if (sBreadCrumbText[2]) {
      oAnalyticsVars.prop2 = sBreadCrumbText[2];
    }

    if (sBreadCrumbText[3]) {
      oAnalyticsVars.prop3 = sBreadCrumbText[3];
    }

    sBreadCrumbText.length = 0;

    oAnalyticsVars.eVar56 = deviceSpecifications.os;
    oAnalyticsVars.prop23 = deviceSpecifications.os;

    if (window.refEvar22) {
      oAnalyticsVars.eVar22 = window.refEvar22;
    }

    if (window.refEvar24) {
      oAnalyticsVars.eVar24 = window.refEvar24;
    }
  };

  return mediaViewerAnalytics;
});

define('modules/pdp/media-viewer/common', [
  'domlib',
  'modules/mvc/fn',
  'modules/breakpoint',
  'modules/common',
  'modules/media-player/common',
  'modules/pdp/media-viewer/arrowsHandler',
  'modules/pdp/media-viewer/config',
  'modules/media-asset-manager/common',
  'modules/media-matrix/common',
  'mustache',
  'modules/pdp/media-viewer/overlay',
  'modules/pdp/media-viewer/analytics',
  'modules/responsive-carousel/responsive-carousel'
], function (
  $,
  fn,
  breakpoint,
  common,
  mediaPlayer,
  arrowsHandler,
  config,
  MediaAssetManager,
  mediaMatrix,
  mustache,
  mediaViewerOverlay,
  mediaViewerAnalytics
) {
  'use strict';

  var _config = config,
    _mediaPlayer = mediaPlayer,
    sImageViewer = 'prodZoomView',
    sCurrentSkuId = '',
    s7container = null,
    s7params = null,
    spinViewScrubber = null,
    aImageSet = [],
    ImageViewer = null,
    SpinViewer = null,
    MediaSet = null,
    _resizeMediaComponent = null,
    _initScene7PageScrubber = null,
    _initScene7AutoSpinView = null,
    _showSpinViewer = null,
    _setMediaAsset = null,
    _initThumbnailsCarousel = null,
    _initMediaCarousel = null,
    _blockZoomedImageViewerSwiping = null,
    _configureScene7Params = null,
    _initScene7Container = null,
    _initScene7MediaSet = null,
    _initScene7Dependencies = null,
    _setScene7ImageMode = null,
    _fallbackToStaticImage = null,
    _fnDefaultImageSanitisation = null,
    _updateMediaViewerCounter = null,
    _imageViewerAfterMoveHandler = null,
    _thumbnailHandler = null,
    _triggerThumnailCarousel = null,
    oMediaThumbnails = null,
    oImageViewerCarousel = null,
    _zoomViewImageViewerCarouselEvents = null,
    iActiveImage = null,
    iIsZoomedIn = false,
    _createMediaCollection = null,
    oMedia = null,
    iMediaCollectionLength = 0,
    videoViewVisible = false,
    _processMedia = null,
    _bindEvents = null,
    bEventsBound = false,
    _showCustomImage = null,
    _initImageViewerDots = null,
    _dotsClickHandler = null,
    _triggerDotsHandling = null,
    oMediaDots = null,
    _showScene7 = null,
    _setDefaultAsset = null,
    _init = null,
    pdpScene7 = null,
    _fnCacheDOMElements = null,
    _overrideScene7WindowDetect = null,
    _ON_SDK_READY = null,
    _initScene7ParameterManager = null,
    _ON_NOTF_SET_PARSED = null,
    _fnAfterShowOverlay = null,
    _fnAfterCloseOverlay = null,
    _fnSetOrientationMode = null,
    _ON_WINDOW_RESIZE = null,
    _ON_NOTF_SLIDER_MOVE = null,
    _initScene7SpinView = null,
    _initScene7ImageView = null,
    _fnResizeMediaCarouselItems = null,
    _initFeatureMediaButton = null,
    bOverlayIsOpen = false,
    bOverlayResizedToScreenHeight = false,
    spinViewVisible = false,
    iActiveIndex = 0,
    _onBreakpointChange = null,
    _fnUpdatePing = null,
    bKioskResizeExecuted = false,
    _resizeKioskImageViewer = null,
    _ON_ASSET_CHANGED = null,
    _fnMoveCarousel = null,
    iCurrentMediaIndex = 0,
    _fnIsBookProduct = null,
    _fnApplyCMSImageClassToContainer = null,
    _handleMediaViewerUpdate = null,
    _addMediaAsset = null,
    _removeMediaAsset = null,
    featureMediaType = null,
    featureMediaIndex = null,
    scene7AutoSpinEnabled = true,
    scene7AutoIntervalId = null,
    _scene7AutoSpinStop = null,
    _setThumbnailClicked = null,
    _thumbnailClicked = null;

  _overrideScene7WindowDetect = function overrideScene7WindowDetect() {
    s7sdk.Window.monitorSize = function () {
      s7sdk.browser.screensize = s7sdk.browser.detectScreen();
      if (Math.abs(s7sdk.Window.currentSize.h - s7sdk.browser.screensize.h) > 100) {
        if (s7sdk.Window.currentSize.w !== s7sdk.browser.screensize.w
            || s7sdk.Window.currentSize.h !== s7sdk.browser.screensize.h) {
          s7sdk.Window.currentSize = s7sdk.browser.screensize;
          s7sdk.Window.sendNotifications();
        }
      }
      if ((new Date()).getTime() > s7sdk.Window.monitorSizeTimeout) {
        window.clearInterval(s7sdk.Window.monitorSizeTimer);
        s7sdk.Window.monitorSizeTimer = null;
      }
    };
  };

  _showScene7 = function showScene7() {
    if ($(_config.sDOM_SELECTORS.wrapper).length) {
      $(_config.sDOM_SELECTORS.wrapper).show();
    }
    $(_config.sDOM_SELECTORS.mvStaticImage).addClass('scene7-enabled');
  };

  _init = function init(mediaAssets) {
    if ($(_config.sDOM_SELECTORS.container).length
        && $(_config.sDOM_SELECTORS.mvStaticImage).hasClass('scene7-enabled')) {
      _fnCacheDOMElements();

      try {
        if (mediaAssets) {
          if (window.isKiosk()) {
            bKioskResizeExecuted = false;
            oMediaThumbnails = null;
            oImageViewerCarousel = null;
          }

          _fnUpdatePing(
            mediaAssets.pings,
            _config.sDOM_SELECTORS.templates.ping,
            _config.oDomElements.$pings
          );

          if (mediaAssets.defaultImage && mediaAssets.defaultImage.defaultImage) {
            _fnDefaultImageSanitisation(mediaAssets.defaultImage);
          }

          if (mediaAssets.skuMedia && mediaAssets.skuMedia.length && fn.getValue(mediaAssets, 'skuMedia', 0, 'renderSource') !== 'CMS') {
            _processMedia(mediaAssets.skuMedia);
          } else {
            _fallbackToStaticImage();
            return;
          }
        }

        _bindEvents();
        _fnSetOrientationMode();
        mediaMatrix.init();
        _createMediaCollection();

        if (_config.oSettings.bDisableScene7) {
          _initThumbnailsCarousel();
          _initMediaCarousel();
        } else {
          _setScene7ImageMode();
          _initScene7Dependencies();
          _initScene7ParameterManager();
          mediaViewerAnalytics.setOmnitureDefaults();
        }

        _setDefaultAsset();
        _mediaPlayer.bMediaViewer = true;
      } catch (err) {
        _fallbackToStaticImage();
      }
    }
  };

  _fnCacheDOMElements = function fnCacheDOMElements() {
    _config.oDomElements.$container = $(_config.sDOM_SELECTORS.container);
    _config.oDomElements.$wrapper = $(_config.sDOM_SELECTORS.wrapper);
    _config.oDomElements.$sidebar = $(_config.sDOM_SELECTORS.sidebar);
    _config.oDomElements.$mv = $(_config.sDOM_SELECTORS.mv);
    _config.oDomElements.$s7containerPlaceholder = $(_config.sDOM_SELECTORS.s7containerPlaceholder);
    _config.oDomElements.$mvMediaDots = $(_config.sDOM_SELECTORS.mvMediaDots);
    _config.oDomElements.$pings = $(_config.sDOM_SELECTORS.pings);
    _config.oDomElements.$s7containerMask = $(_config.sDOM_SELECTORS.s7containerMask);
    _config.oDomElements.$mvStaticImageElement = $(_config.sDOM_SELECTORS.mvStaticImageElement);
    _config.oDomElements.$zoomIcon = $(_config.sDOM_SELECTORS.zoomIcon);
  };

  _bindEvents = function bindEvents() {
    if (!bEventsBound) {
      $(window)
        .on('MediaViewer.showScene7', _showScene7)
        .on('MediaViewer.showCustomImage', _showCustomImage)
        .on('MediaViewer.triggerResize', _resizeMediaComponent)
        .on('MediaViewer.update', _handleMediaViewerUpdate)
        .on('breakpointChange', _onBreakpointChange)
        .off('exitFullscreen')
        .on('exitFullscreen', function () {
          arrowsHandler.toggleArrowVisibility(true);
        });

      if (!common.isTouch() && !window.isKiosk()) {
        _config.oDomElements.$s7containerPlaceholder.on('click', '#prodZoomView', mediaViewerOverlay.render);
        _config.oDomElements.$zoomIcon.on('click', mediaViewerOverlay.render);
      }

      _config.oDomElements.$container.on('MediaViewer.showOverlay', _fnAfterShowOverlay);
      _config.oDomElements.$container.on('MediaViewer.closeOverlay', _fnAfterCloseOverlay);

      bEventsBound = true;
    }
  };

  _fnSetOrientationMode = function fnSetOrientationMode() {
    _config.oSettings.sOrientation = $('.main-content-wrapper').hasClass('media-viewer--portrait')
        ? 'portrait' : 'landscape';
  };

  _setScene7ImageMode = function setScene7ImageMode() {
    pdpScene7.scene7ImageMode = common.isTouch() || window.isKiosk()
        ? 'zoomViewer' : 'flyoutViewer';
  };

  _setDefaultAsset = function setDefaultAsset(sAssetName) {
    var _sAssetName = sAssetName;

    if (MediaSet) {
      if (_sAssetName === undefined) {
        _sAssetName = pdpScene7.s7ImageSet.split(',')[0];
      }
      MediaSet.setAsset(_sAssetName);
    }
  };

  _fnDefaultImageSanitisation = function fnDefaultImageSanitisation(oDefaultImage) {
    var PRESET_PLACEHOLDER = '[preset]',
      sImageSize = oDefaultImage.renderSource === 'Missing' ? '250x250' : 'Detail',
      sUpdatedImageSrc = null,
      sImageSrc = oDefaultImage.src,
      bMatchResultWithMissingImage = sImageSrc.match(/preset/g);

    if (window.isKiosk()) {
      return;
    }

    if (bMatchResultWithMissingImage) {
      sUpdatedImageSrc = sImageSrc.replace(PRESET_PLACEHOLDER, sImageSize);
    }

    _config.oDomElements.$mvStaticImageElement[0].src = sUpdatedImageSrc || sImageSrc;
  };

  _fnIsBookProduct = function fnIsBookProduct() {
    var bIsBookProduct = false,
      activeSku = window.oAppController && window.oAppController.oPageController
          ? window.oAppController.oPageController.getActiveSku() : {},
      aSkuLinks = activeSku.links,
      i = 0;

    for (; i < aSkuLinks.length; i += 1) {
      if (aSkuLinks[i].type === 'booksSku') {
        bIsBookProduct = true;
      }
    }
    return bIsBookProduct;
  };

  _fnApplyCMSImageClassToContainer = function fnApplyCMSImageClassToContainer() {
    $(_config.sDOM_SELECTORS.mvStaticImage).addClass('cms-static-image');
  };

  _fallbackToStaticImage = function fallbackToStaticImage() {
    if (_fnIsBookProduct()) {
      _fnApplyCMSImageClassToContainer();
    }
    _config.oDomElements.$wrapper.hide();
    $(_config.sDOM_SELECTORS.mvStaticImage).removeClass('scene7-enabled');
  };

  _triggerThumnailCarousel = function triggerThumnailCarousel(iCarouselIndex) {
    var oTriggerData = {
      cancelCallback: true
    };

    if (oMediaThumbnails !== null) {
      $(oMediaThumbnails.options.itemSelector).eq(iCarouselIndex).trigger('click', oTriggerData);
    }
  };

  _triggerDotsHandling = function triggerDotsHandling(iCarouselIndex) {
    var oTriggerData = {
      cancelCallback: true
    };

    if (oMediaDots !== null) {
      $(oMediaDots.options.itemSelector).eq(iCarouselIndex).trigger('click', oTriggerData);
    }
  };

  _imageViewerAfterMoveHandler = function imageViewerAfterMoveHandler(iMoveBy) {
    var iPositiveMoveBy = 0,
      iFrom = 0;

    if (iMoveBy !== undefined) {
      iPositiveMoveBy = Math.abs(iMoveBy);
      iFrom = iPositiveMoveBy + 1;

      _updateMediaViewerCounter(iFrom, oMedia.getCollectionLength());
      _setMediaAsset(iPositiveMoveBy);
      _triggerThumnailCarousel(iPositiveMoveBy);
      _triggerDotsHandling(iPositiveMoveBy);

      iActiveIndex = iPositiveMoveBy;
    }
  };

  _setThumbnailClicked = function setThumbnailClicked(value) {
    _thumbnailClicked = value;
  };

  _thumbnailHandler = function thumbnailHandler(oEvent) {
    var iIndex = 0,
      iMoveBy = 0,
      analyticThumbIndex = 0;

    if (oMediaThumbnails !== null && oEvent !== undefined) {
      iIndex = oEvent.data && oEvent.data.iCurrentIndex
          ? oEvent.data.iCurrentIndex : $(oEvent.currentTarget).index();
      analyticThumbIndex = iIndex + 1;

      mediaViewerAnalytics.analyticsThumbClick(analyticThumbIndex);
      iMoveBy = -1 * iIndex;
      _setThumbnailClicked(true);
      oImageViewerCarousel.move(iMoveBy);
    }
  };

  _dotsClickHandler = function dotsClickHandler(oEvent) {
    var iIndex = 0,
      iMoveBy = 0;

    if (oMediaDots !== null && oEvent !== undefined) {
      iIndex = $(oEvent.currentTarget).index();
      iMoveBy = -1 * iIndex;
      oImageViewerCarousel.move(iMoveBy);
    }
  };

  _initImageViewerDots = function initImageViewerDots() {
    var $mediaDots = $(_config.sDOM_SELECTORS.mvMediaDots),
      sImageViewerDotsMarkup = '';

    if (oMedia.aMediaCollection.length > 1) {
      sImageViewerDotsMarkup = mustache.render(
        $(_config.sDOM_SELECTORS.templates.imageViewerDots).html(), oMedia.aMediaCollection
      );

      $(_config.sDOM_SELECTORS.mvDots, $mediaDots).html(sImageViewerDotsMarkup);

      if (oMediaDots === null) {
        _config.oDomElements.$mvMediaDots.carousel({
          itemSelector: _config.sDOM_SELECTORS.mvDotsItem,
          wrapperClass: _config.sDOM_SELECTORS.mvDots,
          itemWidth: _config.oSettings.oDimensions[_config.oSettings.sOrientation].oDots.WIDTH,
          centraliseThumbnails: {
            enabled: true,
            itemSelectorActive: 'active',
            clickActionCallback: function (oEvent) {
              _dotsClickHandler(oEvent);
              iIsZoomedIn = false;
            }
          },
          stopOnLastItem: true,
          vertical: false,
          enablePeep: false,
          itemHeight: _config.oSettings.oDimensions[_config.oSettings.sOrientation].oDots.HEIGHT
        });
        oMediaDots = $mediaDots.data('carousel');
      } else {
        oMediaDots.reset();
        oMediaDots.adjust();
      }

      if (oMediaDots.options.itemSelector) {
        $(oMediaDots.options.itemSelector).first().addClass('active');
      }
    }
  };

  _initMediaCarousel = function initMediaCarousel(oEvent) {
    var sImageViewerMarkup = '',
      sImageTemplateSelector = _config.oSettings.bDisableScene7
          ? _config.sDOM_SELECTORS.templates.staticImageLandscape
          : _config.sDOM_SELECTORS.templates.imageViewer;

    if (_config.oSettings.sOrientation === 'portrait' && _config.oSettings.bDisableScene7) {
      sImageTemplateSelector = _config.sDOM_SELECTORS.templates.staticImagePortrait;
    }

    aImageSet = _config.oSettings.bDisableScene7
        ? oMedia.aMediaCollection : oEvent.s7event.asset.items;

    sImageViewerMarkup = mustache.render($(sImageTemplateSelector).html(), oMedia.aMediaCollection);

    if (_config.oSettings.bDisableScene7) {
      $(_config.sDOM_SELECTORS.s7containerPlaceholder).html(sImageViewerMarkup);
    } else {
      _config.oDomElements.$s7container.html(sImageViewerMarkup);
    }

    if (oImageViewerCarousel === null) {
      _config.oDomElements.$wrapper.carousel({
        itemSelector: _config.sDOM_SELECTORS.mvImageViewerCarouselItem,
        wrapperClass: _config.sDOM_SELECTORS.mvImageViewerCarousel,
        prevClass: _config.sDOM_SELECTORS.mvImageViewerCarouselItemPrev,
        nextClass: _config.sDOM_SELECTORS.mvImageViewerCarouselItemNext,
        all: false,
        enableAutoHideArrows: false,
        continuousLoop: true,
        setActive: true,
        itemWidth: function calcItemWidth() {
          return _config.oDomElements.$s7containerPlaceholder.outerWidth(true);
        },
        afterMove: function (iMoveBy) {
          _imageViewerAfterMoveHandler(iMoveBy);
          iIsZoomedIn = false;
        }
      });
      oImageViewerCarousel = _config.oDomElements.$wrapper.data('carousel');
    } else {
      oImageViewerCarousel.reset();
      oImageViewerCarousel.adjust();
    }

    _updateMediaViewerCounter(1, oMedia.getCollectionLength());
    if (!_config.oSettings.bDisableScene7) {
      _initScene7ImageView();
    } else {
      arrowsHandler.toggleArrowVisibility(oMedia.aMediaCollection.length > 1);
    }
  };

  _initThumbnailsCarousel = function initThumbnailsCarousel(args) {
    var argsCopy = args || {},
      dimensions = _config.oSettings.oDimensions,
      orientation = _config.oSettings.sOrientation,
      $mediaThumbnails = $(_config.sDOM_SELECTORS.mvMediaThumbnails),
      sRenderedThumbnailsMarkup = '',
      oViewData = {
        aMedia: oMedia.aMediaCollection,
        oImageDimensions: {
          width: dimensions[orientation].oThumbnails.DEFAULT_WIDTH,
          height: dimensions[orientation].oThumbnails.DEFAULT_HEIGHT
        }
      };

    if (typeof argsCopy.filterDataCallback === 'function') {
      oViewData = argsCopy.filterDataCallback(oViewData);
    }

    if (oMedia.aMediaCollection.length > 1) {
      sRenderedThumbnailsMarkup = mustache.render(
        $(_config.sDOM_SELECTORS.templates.thumbnails).html(), oViewData
      );

      $(_config.sDOM_SELECTORS.mvCarousel, $mediaThumbnails).html(sRenderedThumbnailsMarkup);

      if (oMediaThumbnails === null) {
        $mediaThumbnails.carousel({
          itemSelector: _config.sDOM_SELECTORS.mvCarouselItem,
          wrapperClass: _config.sDOM_SELECTORS.mvCarousel,
          itemWidth: dimensions[orientation].oThumbnails.WIDTH,
          centraliseThumbnails: {
            enabled: true,
            itemSelectorActive: 'active',
            clickActionCallback: function (oEvent) {
              _thumbnailHandler(oEvent);
              iIsZoomedIn = false;
            }
          },
          stopOnLastItem: true,
          vertical: orientation === 'portrait',
          enablePeep: false,
          itemHeight: dimensions[orientation].oThumbnails.HEIGHT,
          bHideNextPreviousIfAllItemsVisible: true,
          bSetResponsiveEvents: true
        });
        oMediaThumbnails = $mediaThumbnails.data('carousel');
      } else {
        oMediaThumbnails.reset();
        oMediaThumbnails.adjust();
      }

      arrowsHandler.imageViewerThumbArrows(oMediaThumbnails, oMedia);
    }

    if (typeof argsCopy.addMediaAssetCallback === 'function') {
      argsCopy.addMediaAssetCallback($mediaThumbnails);
    }
  };

  _createMediaCollection = function createMediaCollection() {
    var i = 0,
      j = 0,
      aDecodedMediaCollection = null,
      aDecodedMediaCollectionLength = null,
      mvcPage = fn.getValue(window, 'oAppController', 'oPageController'),
      activeProduct = mvcPage.getActiveProduct(),
      productModel = mvcPage.getModule('model', 'products'),
      isFF = productModel.isFF(activeProduct);

    oMedia = new MediaAssetManager();

    oMedia.addMedia(pdpScene7.s7ImageSet, 'image');

    if (!window.isKiosk()) {
      oMedia.addMedia(pdpScene7.s7SpinSet, 'spin');

      if (!isFF) {
        oMedia.addMedia(pdpScene7.s7VideoSet, 'video', 2);
      } else {
        oMedia.addMedia(pdpScene7.s7VideoSet, 'video');
      }
    }

    iMediaCollectionLength = oMedia.getCollectionLength();

    if (iMediaCollectionLength === 0) {
      throw new Error('MediaAssetManager: no media in collection');
    }

    if (iMediaCollectionLength > 0) {
      aDecodedMediaCollection = mediaMatrix.processMediaCollection(oMedia.aMediaCollection);
      aDecodedMediaCollectionLength = aDecodedMediaCollection.length;

      if (aDecodedMediaCollectionLength > 0) {
        for (i; i < aDecodedMediaCollectionLength; i += 1) {
          if (aDecodedMediaCollection[i].playerType !== null) {
            oMedia.addToCollection(i, 'playerType', aDecodedMediaCollection[i].playerType);
          }
          if (aDecodedMediaCollection[i].fileType !== null) {
            oMedia.addToCollection(i, 'fileType', aDecodedMediaCollection[i].fileType);
          }
        }
      }

      for (j; j < iMediaCollectionLength; j += 1) {
        if (oMedia.getMediaType(j) === 'image') {
          oMedia.addToCollection(j, 'isImage', true);
          oMedia.aMediaCollection[j].mediaSrc = pdpScene7.s7ServerUrl
              + oMedia.aMediaCollection[j].mediaSrc;
        }
        if (oMedia.getMediaType(j) === 'spin') {
          oMedia.addToCollection(j, 'isSpin', true);
          featureMediaType = 'spin';
          featureMediaIndex = j;
        }
        if (oMedia.getMediaType(j) === 'video') {
          oMedia.addToCollection(j, 'isVideo', true);
          featureMediaType = 'video';
          featureMediaIndex = j;
        }
      }
      if (isFF && featureMediaIndex !== null) {
        oMedia.iFeatureMediaIndex = featureMediaIndex;
      }
    }
  };

  _processMedia = function processMedia(aMedia) {
    var i = 0,
      iMediaLength = aMedia.length,
      aImages = [],
      aVideos = [],
      aSpins = [],
      regExpr = /(.*\/\/tesco.scene7.com\/is\/image\/)|(\?\$\[preset]\$)/g;

    for (i; i < iMediaLength; i += 1) {
      if (aMedia[i].mediaType === 'Large') {
        aImages.push(aMedia[i].src.replace(regExpr, ''));
      }
      if (aMedia[i].mediaType === 'Video') {
        aVideos.push(aMedia[i].src);
      }
      if (aMedia[i].mediaType === 'Spinset') {
        aSpins.push(aMedia[i].src.replace(regExpr, ''));
      }
    }

    pdpScene7.s7ImageSet = aImages.toString();
    pdpScene7.s7SpinSet = aSpins.toString();
    pdpScene7.s7VideoSet = aVideos;
  };

  _onBreakpointChange = function onBreakpointChange(oEvent) {
    if (oMediaThumbnails === undefined && (oEvent.newViewport === 'htablet'
        || oEvent.newViewport === 'desktop' || oEvent.newViewport === 'largedesktop')) {
      _initThumbnailsCarousel();
      _triggerThumnailCarousel(iActiveIndex);
    }
  };

  _showCustomImage = function showCustomImage(oEvent) {
    if (oEvent.oData) {
      $(_config.sDOM_SELECTORS.mvStaticImageElement).prop('src', oEvent.oData.src);
      _fallbackToStaticImage();
    }
  };

  _fnAfterCloseOverlay = function fnAfterCloseOverlay() {
    bOverlayIsOpen = false;
    _resizeMediaComponent();

    if (oImageViewerCarousel) {
      oImageViewerCarousel.adjust({
        calcScroll: true
      });
    }

    bOverlayResizedToScreenHeight = false;

    if (oMedia.getMediaType(iCurrentMediaIndex) === 'image') {
      _config.oDomElements.$s7containerMask.hide();
    }
  };

  _fnAfterShowOverlay = function fnAfterShowOverlay() {
    _resizeMediaComponent();

    if (oImageViewerCarousel) {
      oImageViewerCarousel.adjust({
        calcScroll: true
      });
    }

    window.setTimeout(function () {
      $('#mv-overlay-content #s7container').show();
    }, 500);

    if (oMedia.getMediaType(iCurrentMediaIndex) === 'image') {
      _config.oDomElements.$s7containerMask.show();
    }

    bOverlayIsOpen = true;

    if (oMedia.getMediaType(iCurrentMediaIndex) === 'image') {
      if (_config.oSettings.sOrientation === 'landscape') {
        _resizeMediaComponent(undefined, $(window).height());
        bOverlayResizedToScreenHeight = true;
      }
    }
  };

  _ON_ASSET_CHANGED = function ON_ASSET_CHANGED() {
    if (spinViewScrubber) {
      spinViewScrubber.setCurrentFrameIndex(SpinViewer.getCurrentFrameIndex());
      if (scene7AutoSpinEnabled) {
        _initScene7AutoSpinView();
      }
    }
  };

  _ON_NOTF_SLIDER_MOVE = function ON_NOTF_SLIDER_MOVE() {
    SpinViewer.setCurrentFrameIndex(spinViewScrubber.getCurrentFrameIndex());
    iIsZoomedIn = false;
  };

  _ON_NOTF_SET_PARSED = function ON_NOTF_SET_PARSED(event) {
    if (window.isKiosk() || breakpoint.largeDesktop || breakpoint.desktop || breakpoint.hTablet) {
      _initThumbnailsCarousel(event);
    }

    if (!window.isKiosk()) {
      _initImageViewerDots(event);
    }

    _initMediaCarousel(event);

    if (!window.isKiosk()) {
      _initFeatureMediaButton();
    }

    MediaSet.removeEventListener(s7sdk.AssetEvent.NOTF_SET_PARSED, _ON_NOTF_SET_PARSED);
  };

  _ON_WINDOW_RESIZE = function ON_WINDOW_RESIZE() {
    window.setTimeout(_resizeMediaComponent, 500);
  };

  _ON_SDK_READY = function ON_SDK_READY() {
    _config.oDomElements.$wrapper.toggleClass('single-item', iMediaCollectionLength === 1);
    pdpScene7.overrideScene7WindowDetect();
    _configureScene7Params();
    _initScene7Container();
    _initScene7MediaSet();
    arrowsHandler.toggleArrowVisibility(iMediaCollectionLength > 1);
  };

  _initScene7PageScrubber = function initScene7PageScrubber() {
    spinViewScrubber = new s7sdk.set.PageScrubber('s7container', s7params, 's7Scrubber');
    spinViewScrubber.setAsset(pdpScene7.s7SpinSet);
    spinViewScrubber.addEventListener(
      s7sdk.event.SliderEvent.NOTF_SLIDER_MOVE, _ON_NOTF_SLIDER_MOVE, false
    );
  };

  _initScene7SpinView = function initScene7SpinView() {
    SpinViewer = new s7sdk.set.SpinView('s7container', s7params, 'prodSpinView');
    SpinViewer.addEventListener(s7sdk.event.AssetEvent.ASSET_CHANGED, _ON_ASSET_CHANGED, false);
  };

  _initScene7AutoSpinView = function initScene7AutoSpinView() {
    var fLength = SpinViewer.getFramesLength() - 1,
      i = 0;

    scene7AutoSpinEnabled = false;

    if (scene7AutoIntervalId) {
      _scene7AutoSpinStop();
    }

    scene7AutoIntervalId = setInterval(function () {
      if (i === fLength) {
        SpinViewer.setCurrentFrameIndex(0);
        _scene7AutoSpinStop();
        i = 0;
      } else {
        SpinViewer.setCurrentFrameIndex(i += 1);
      }
    }, 150);
    _scene7AutoSpinStop = function scene7AutoSpinStop() {
      clearInterval(scene7AutoIntervalId);
      $('.s7dragbutton').css('left', '0');
    };
    $('.s7dragbutton').one('mousedown', function () {
      _scene7AutoSpinStop();
    });
  };

  _initScene7ImageView = function initScene7ImageView() {
    if (pdpScene7.scene7ImageMode === 'zoomViewer') {
      ImageViewer = new s7sdk.ZoomView('s7container', s7params, sImageViewer);
      _blockZoomedImageViewerSwiping();
      _zoomViewImageViewerCarouselEvents();

      ImageViewer.addEventListener(s7sdk.event.AssetEvent.ASSET_CHANGED, function () {
        if (window.isKiosk()) {
          _resizeKioskImageViewer();
        }
      });
    } else {
      ImageViewer = new s7sdk.FlyoutZoomView('s7container', s7params, sImageViewer);
    }

    ImageViewer.setItem(aImageSet[0]);
    oImageViewerCarousel.$itemsWrapper.addClass('image-viewer-carousel');
    _config.oDomElements.$mv.addClass('zoomVisible');
  };

  _initScene7MediaSet = function initScene7MediaSet() {
    MediaSet = new s7sdk.MediaSet(null, s7params, null);
    MediaSet.addEventListener(s7sdk.AssetEvent.NOTF_SET_PARSED, _ON_NOTF_SET_PARSED, false);
  };

  _initScene7Container = function initScene7Container() {
    s7container = new s7sdk.Container('mediaViewerScene7Container', s7params, 's7container');
    s7container.addEventListener(s7sdk.ResizeEvent.WINDOW_RESIZE, _ON_WINDOW_RESIZE, false);

    _config.oDomElements.$s7container = $(_config.sDOM_SELECTORS.s7container);
  };

  _configureScene7Params = function configureScene7Params() {
    s7params.push('serverurl', pdpScene7.s7ServerUrl);

    if (pdpScene7.s7ImageSet !== undefined) {
      s7params.push('MediaSet.asset', pdpScene7.s7ImageSet);

      if (pdpScene7.scene7ImageMode === 'zoomViewer') {
        s7params.push('ZoomView.zoomstep', '0, 1');
        s7params.push('ZoomView.iconeffect', '1, 1, 0.3, 5');
        s7params.push('ZoomView.transition', '0.25, 3');
        s7params.push('ZoomView.singleclick', 'none');
        s7params.push('ZoomView.swipe', '0');
        if (window.isKiosk() || !common.cssTransitionsSupported()) {
          s7params.push('ZoomView.doubleclick', 'none');
        } else {
          s7params.push('ZoomView.doubleclick', 'zoomReset');
        }
        s7params.push('ZoomView.iscommand', 'op_sharpen=1');
      } else {
        s7params.push('FlyoutZoomView.fill', '#ffffff,1');
        s7params.push('FlyoutZoomView.imagereload', '1,breakpoint,300;600;1200;1790');
        s7params.push('FlyoutZoomView.zoomfactor', '3.0,-1,1');
        s7params.push('FlyoutZoomView.overlay', '0');
        s7params.push('FlyoutZoomView.flyouttransition', 'none,1,0,1,0');
        s7params.push('FlyoutZoomView.highlightmode', 'cursor,1,free');
        s7params.push('FlyoutZoomView.iscommand', 'op_sharpen=1');
        s7params.push('FlyoutZoomView.tip', '4,1,0.3');
      }
    } else {
      _fallbackToStaticImage();
      return;
    }

    if (pdpScene7.s7SpinSet !== undefined) {
      s7params.push('SpinView.asset', pdpScene7.s7SpinSet);
      s7params.push('SpinView.zoomstep', '0,1');
      s7params.push('SpinView.transition', '0.1, 0');
      s7params.push('SpinView.doubleclick', 'none');
      if (breakpoint.mobile) {
        s7params.push('SpinView.iconeffect', '0');
      }
    }
  };

  _initScene7ParameterManager = function initScene7ParameterManager() {
    s7params = new s7sdk.ParameterManager(null, null);
    s7params.addEventListener(s7sdk.Event.SDK_READY, _ON_SDK_READY, false);
    s7params.init();
  };

  _initScene7Dependencies = function initScene7Dependencies() {
    var scene7LibSelector = pdpScene7.scene7ImageMode === 'zoomViewer' ? 'ZoomView' : 'FlyoutZoomView';

    s7sdk.Util.lib.include('s7sdk.common.Container');
    s7sdk.Util.lib.include('s7sdk.set.PageScrubber');
    s7sdk.Util.lib.include('s7sdk.set.MediaSet');
    s7sdk.Util.lib.include('s7sdk.set.SpinView');
    s7sdk.Util.lib.include('s7sdk.image.' + scene7LibSelector);
  };


  _resizeMediaComponent = function resizeMediaComponent(iWidth, iHeight) {
    var iScene7ContainerWidth = iWidth || _config.oDomElements.$s7containerPlaceholder.width(),
      iScene7ContainerHeight = iHeight || _config.oDomElements.$s7containerPlaceholder.height();

    if (iScene7ContainerHeight === 0) {
      iScene7ContainerHeight = $('#prodZoomView').height();
    }

    if (bOverlayIsOpen && _config.oSettings.sOrientation === 'portrait'
        && (videoViewVisible || spinViewVisible)) {
      if (breakpoint.mobile || breakpoint.vTablet || breakpoint.hTablet) {
        iScene7ContainerHeight = $(window).height() - _config.oDomElements.$mvMediaDots.height();
      } else {
        iScene7ContainerHeight = $(window).height();
      }
    }

    if (bOverlayIsOpen && _config.oSettings.sOrientation === 'landscape') {
      iScene7ContainerHeight = $(window).height() - _config.oDomElements.$sidebar.outerHeight();
    }

    if (window.isKiosk() && _config.oSettings.sOrientation === 'portrait') {
      iScene7ContainerWidth = _config.oSettings.oDimensions.portrait.oKiosk.MEDIA_VIEWER.WIDTH;
      iScene7ContainerHeight = _config.oSettings.oDimensions.portrait.oKiosk.MEDIA_VIEWER.HEIGHT;
    }

    s7container.resize(iScene7ContainerWidth, iScene7ContainerHeight);

    if (ImageViewer) {
      ImageViewer.resize(iScene7ContainerWidth, iScene7ContainerHeight);
    }
    if (SpinViewer) {
      SpinViewer.resize(iScene7ContainerWidth, iScene7ContainerHeight);
    }
    if (videoViewVisible) {
      if ($('span.icon-play-lg').length < 1) {
        _mediaPlayer.pauseCurrentVideo(true);
        arrowsHandler.toggleArrowVisibility(true);
      }
    }

    _fnResizeMediaCarouselItems(iScene7ContainerWidth, iScene7ContainerHeight);

    if (oImageViewerCarousel) {
      oImageViewerCarousel.adjust();
    }

    if (oMediaThumbnails) {
      oMediaThumbnails.adjust();
    }
  };

  _fnResizeMediaCarouselItems = function fnResizeMediaCarouselItems(iWidth, iHeight) {
    $(_config.sDOM_SELECTORS.mvImageViewerCarouselItem, _config.oDomElements.$s7container)
      .width(iWidth)
      .height(iHeight);
  };

  _showSpinViewer = function showSpinViewer() {
    var oSku = window.oAppController.oPageController.getActiveSku() || null,
      sSkuId = '';

    if (oSku) {
      sSkuId = oSku.id;
      videoViewVisible = false;
      if (SpinViewer === null || sCurrentSkuId !== sSkuId) {
        sCurrentSkuId = sSkuId;
        _initScene7SpinView();
        _initScene7PageScrubber();
      } else {
        scene7AutoSpinEnabled = true;
        _initScene7AutoSpinView();
      }
    }
  };

  _setMediaAsset = function setMediaAsset(index) {
    var oMediaData = {};

    _mediaPlayer.pauseCurrentVideo();

    if (oMedia.aMediaCollection[index] !== undefined && oMedia.getMediaType(index) !== undefined) {
      iCurrentMediaIndex = index;
      _config.oDomElements.$pings.show();

      switch (oMedia.getMediaType(index)) {
        case 'image':
          videoViewVisible = false;
          spinViewVisible = false;
          if (!_config.oSettings.bDisableScene7) {
            ImageViewer.setItem(aImageSet[oMedia.aMediaCollection[index].mediaSetIndex]);
          }
          _config.oDomElements.$mv.removeClass().addClass('zoomVisible');
          if (bOverlayIsOpen && bOverlayResizedToScreenHeight && _config.oSettings.sOrientation === 'portrait') {
            _resizeMediaComponent();
            bOverlayResizedToScreenHeight = false;
          }

          if (!bOverlayIsOpen) {
            _config.oDomElements.$s7containerMask.hide();
          }
          break;
        case 'video':
          videoViewVisible = true;
          spinViewVisible = false;
          if (bOverlayIsOpen && !bOverlayResizedToScreenHeight) {
            _resizeMediaComponent(undefined, $(window).height());
            bOverlayResizedToScreenHeight = true;
          }
          _config.oDomElements.$mv.removeClass().addClass('videoVisible');
          _config.oDomElements.$pings.hide();
          if (oMedia && oMedia.iFeatureMediaIndex && oMedia.iFeatureMediaIndex === index) {
            _config.oDomElements.$mv.addClass('featureMediaVisible');
          }
          oMediaData = oMedia.getMediaByIndex(index);
          _mediaPlayer.videoUpdate(index, oMediaData);
          _config.oDomElements.$s7containerMask.hide();

          arrowsHandler.bindVideoViewEvents();
          if (_thumbnailClicked) {
            _mediaPlayer.playCurrentVideo();
          }
          break;
        case 'spin':
          videoViewVisible = false;
          spinViewVisible = true;
          _config.oDomElements.$mv.removeClass().addClass('spinVisible');
          if (bOverlayIsOpen && !bOverlayResizedToScreenHeight) {
            _resizeMediaComponent(undefined, $(window).height());
            bOverlayResizedToScreenHeight = true;
          }
          _showSpinViewer();
          _config.oDomElements.$s7containerMask.show();
          break;
        case 'static':
          videoViewVisible = false;
          spinViewVisible = false;
          _config.oDomElements.$mv.removeClass().addClass('staticVisible');
          break;
        default:
          // no default
      }

      if (!_thumbnailClicked && iMediaCollectionLength > 1) {
        arrowsHandler.toggleArrowVisibility(true);
      }
      _setThumbnailClicked(false);
    }
  };

  _updateMediaViewerCounter = function updateMediaViewerCounter(from, to) {
    if (iActiveImage === undefined || from <= to) {
      iActiveImage = from;
      $(_config.sDOM_SELECTORS.mvCounter).addClass('show').text(from + '/' + to);
    }
  };

  _fnMoveCarousel = function fnMoveCarousel(oEvent) {
    if (!iIsZoomedIn) {
      if (oEvent.type === 'swipeLeft') {
        oImageViewerCarousel.moveRight();
      } else {
        oImageViewerCarousel.moveLeft();
      }
    }
  };

  _zoomViewImageViewerCarouselEvents = function zoomViewImageViewerCarouselEvents() {
    var sSelectors = '#' + sImageViewer + ', #prodVideoView';

    _config.oDomElements.$s7containerPlaceholder.on(
      'swipeLeft swipeRight', sSelectors, _fnMoveCarousel
    );
    _config.oDomElements.$s7containerMask.on('swipeLeft swipeRight', _fnMoveCarousel);
  };

  _blockZoomedImageViewerSwiping = function blockZoomedImageViewerSwiping() {
    ImageViewer.addEventListener(s7sdk.event.UserEvent.NOTF_USER_EVENT, function (event) {
      if (event.s7event.trackEvent === 'ZOOM' && !iIsZoomedIn) {
        iIsZoomedIn = true;
      } else if (event.s7event.trackEvent === 'PAN' && iIsZoomedIn) {
        iIsZoomedIn = true;
      } else {
        iIsZoomedIn = false;
      }
    }, false);
  };

  _initFeatureMediaButton = function initFeatureMediaButton() {
    if (oMedia && oMedia.iFeatureMediaIndex) {
      if (_config.oDomElements.$featureButton !== null) {
        _config.oDomElements.$featureButton
          .off('click', _thumbnailHandler)
          .on('click', {
            iCurrentIndex: oMedia.iFeatureMediaIndex
          }, _thumbnailHandler);
      } else {
        if (featureMediaType === 'spin') {
          _config.oDomElements.$sidebar.append(_config.sDOM_SELECTORS.templates.spinButton);
        } else {
          _config.oDomElements.$sidebar.append(_config.sDOM_SELECTORS.templates.playButton);
        }
        _config.oDomElements.$featureButton = $(_config.sDOM_SELECTORS.featureButton);
        _config.oDomElements.$featureButton.on('click', {
          iCurrentIndex: oMedia.iFeatureMediaIndex
        }, _thumbnailHandler);
      }
    } else if ($(_config.sDOM_SELECTORS.featureButton).length > 0) {
      _config.oDomElements.$featureButton.remove();
      _config.oDomElements.$featureButton = null;
    }
  };


  /**
   *
   * @param {Object} ping
   * @param {String} ping.mediaType
   * @param {String} ping.src
   * @param {String} tmplSelector
   * @param {JQueryObject} target
   * @return {String}
   */
  _fnUpdatePing = function fnUpdatePing(ping, tmplSelector, target) {
    var _ping = {},
      _target = target,
      data = {},
      markup = '',
      pageController = window.oAppController.oPageController,
      activeSku = pageController.getActiveSku(),
      skuModel = pageController.getModule('model', 'sku', '_default'),
      template = $(tmplSelector)[0].innerHTML,
      PRESET_PLACEHOLDER = '$[preset]$';

    if (!fn.isArray(ping, { notEmpty: true })) {
      _target[0].innerHTML = '';
      return null;
    }

    if (skuModel.getListings(activeSku).length > 1) {
      _target[0].innerHTML = '';
      return null;
    }

    _ping = ping[0];

    _ping.src = _ping.src
    || 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==';

    data.sViewId = 'product-ping-1234';
    data.sViewClass = 'product-ping';
    data.props = {
      mediaType: _ping.mediaType,
      srcSmall: _ping.src.replace(PRESET_PLACEHOLDER, 'sm'),
      srcLarge: _ping.src.replace(PRESET_PLACEHOLDER, 'lg')
    };

    markup = mustache.render(template, data);
    target.html(markup);

    window.picturefill();
    return markup;
  };


  _resizeKioskImageViewer = function resizeKioskImageViewer() {
    if (!bKioskResizeExecuted) {
      bKioskResizeExecuted = true;
      _resizeMediaComponent();
    }
  };

  _handleMediaViewerUpdate = function handleMediaViewerUpdate(event) {
    var update = event.customData;

    if (update.type === 'add') {
      _addMediaAsset(update);
    } else if (update.type === 'remove') {
      _removeMediaAsset(update);
    }
  };

  _addMediaAsset = function addMediaAsset(args) {
    var _args = args || {},
      items = _args.items || {},
      images = _args.images || {},
      callbacks = _args.callbacks || {},
      timestamp = new Date().getTime(),
      dotClassNames = '';

    if (!items || !images) {
      return;
    }

    if (typeof images.main !== 'string' || typeof _args.mediaType !== 'string') {
      return;
    }

    if (typeof items.main !== 'string' && typeof items.thumb !== 'string') {
      return;
    }

    oMedia.addMedia([images.main], _args.mediaType, _args.position, {
      isStatic: true,
      classNames: _args.classNames,
      timestamp: timestamp
    });

    if (oMedia.getCollectionLength() === 2) {
      _config.oDomElements.$wrapper.removeClass('single-item');
    }

    items.main = $(items.main).attr('data-timestamp', timestamp)[0].outerHTML;

    if (oImageViewerCarousel) {
      oImageViewerCarousel.add({
        position: args.position,
        callback: callbacks.main,
        item: items.main
      });

      if (oImageViewerCarousel.totalCarouselItems > 1) {
        arrowsHandler.toggleArrowVisibility(true);
      }
    }

    items.thumb = $(items.thumb).attr('data-timestamp', timestamp)[0].outerHTML;

    if (oMediaThumbnails) {
      oMediaThumbnails.add({
        position: args.position,
        callback: callbacks.thumb,
        item: items.thumb
      });
      arrowsHandler.imageViewerThumbArrows(oMediaThumbnails, oMedia);
    } else {
      _initThumbnailsCarousel({
        filterDataCallback: function filterDataCallback(viewData) {
          var i = 0,
            viewDataCopy = $.extend({}, viewData),
            media = viewDataCopy.aMedia;

          for (i = 0; i < media.length; i += 1) {
            if (media[i].hasOwnProperty('timestamp') && media[i].timestamp === timestamp) {
              media[i].mediaSrc = images.thumb;
            }
          }

          return viewDataCopy;
        },
        addMediaAssetCallback: function addMediaAssetCallback($mediaThumbnails) {
          var $addedItem = $mediaThumbnails.find('[data-timestamp="' + timestamp + '"]');

          if (typeof callbacks.thumb === 'function' && $addedItem.length > 0) {
            callbacks.thumb($addedItem);
          }
        }
      });
    }

    if (breakpoint.currentViewport === 'kiosk' || breakpoint.currentViewport === 'largedesktop'
        || breakpoint.currentViewport === 'desktop' || breakpoint.currentViewport === 'htablet') {
      $(oMediaThumbnails.options.itemSelector).filter(function () {
        if ($(this).data('timestamp') === timestamp) {
          return $(this);
        }
        return undefined;
      }).trigger('click');
    }

    if (_args.mediaType === 'image' || _args.mediaType === 'static') {
      dotClassNames = 'icon-dual-dot';
    } else if (_args.mediaType === 'video') {
      dotClassNames = 'icon-play';
    } else if (_args.mediaType === 'spin') {
      dotClassNames = 'icon-spin';
    }

    if (oMediaDots) {
      oMediaDots.add({
        position: args.position,
        item: '<li class="icon ' + dotClassNames + ' ' + _args.classNames
            + '" data-timestamp="' + timestamp + '"></li>'
      });
    } else if (breakpoint.currentViewport !== 'kiosk') {
      _initImageViewerDots();
    }

    if (breakpoint.currentViewport === 'vtablet' || breakpoint.currentViewport === 'mobile') {
      $(oMediaDots.options.itemSelector).filter(function () {
        if ($(this).data('timestamp') === timestamp) {
          return $(this);
        }
        return undefined;
      }).trigger('click');
    }
  };

  _removeMediaAsset = function removeMediaAsset(args) {
    var _args = args || {};

    oMedia.removeMedia({
      mediaAsset: _args.mediaAsset
    });

    if (oMedia.getCollectionLength() === 1) {
      _config.oDomElements.$wrapper.addClass('single-item');
    }

    if (oImageViewerCarousel) {
      oImageViewerCarousel.remove({
        position: _args.position
      });

      if (oImageViewerCarousel.totalCarouselItems === 1) {
        arrowsHandler.toggleArrowVisibility(false);
      }
    }

    if (oMediaThumbnails) {
      oMediaThumbnails.remove({
        position: _args.position
      });

      if (breakpoint.currentViewport === 'kiosk' || breakpoint.currentViewport === 'largedesktop'
          || breakpoint.currentViewport === 'desktop' || breakpoint.currentViewport === 'htablet') {
        $(oMediaThumbnails.options.itemSelector).first().trigger('click');
      }

      if (oMediaThumbnails.totalCarouselItems === 1) {
        oMediaThumbnails.destroy();
        oMediaThumbnails = null;
      } else {
        arrowsHandler.imageViewerThumbArrows(oMediaThumbnails, oMedia);
      }
    }

    if (oMediaDots) {
      oMediaDots.remove({
        position: _args.position
      });

      if (breakpoint.currentViewport === 'vtablet' || breakpoint.currentViewport === 'mobile') {
        $(oMediaDots.options.itemSelector).first().trigger('click');
      }

      if (oMediaDots.totalCarouselItems === 1) {
        oMediaDots.destroy();
        oMediaDots = null;
      }
    }
  };

  /***********************************************************************************************
   * Global vars
   */
  pdpScene7 = {
    s7ServerUrl: '//tesco.scene7.com/is/image/',
    s7ImageSet: null,
    s7SpinSet: null,
    s7VideoSet: null,
    s7ZoomMouseEnter: null,
    s7ZoomMouseExit: null,
    scene7ImageMode: 'flyoutViewer',
    overrideScene7WindowDetect: _overrideScene7WindowDetect,
    showScene7: _showScene7,
    init: _init,
    updatePing: _fnUpdatePing
  };


  return pdpScene7;
});

define('modules/pdp/views/ServicesBannerView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView'
], function ($, fn, BaseView) {
  'use strict';

  /**
   * Services banner view constructor sets view's core data and calls parent constructor.
   * @param {Object} config The configuration to populate the view's dynamic properties.
   * @return {void}
   */
  function ServicesBannerView(config) {
    var template = config.sTemplate || '#services-banner-template',
      $templateScript = $(template);

    this.sViewName = 'ServicesBannerView';
    this.sTag = 'banner';
    this.sNamespace = 'services';
    this.sViewClass = 'services-banner-view';
    this.sTemplate = $templateScript.length > 0 ? $templateScript[0].innerHTML : '';
    this.parent.constructor.call(this, config);
  }

  fn.inherit(ServicesBannerView, BaseView);

  ServicesBannerView._name = 'ServicesBannerView';
  ServicesBannerView.sNamespace = 'services';
  ServicesBannerView.sTag = 'banner';

  ServicesBannerView.prototype._setProps = function (data) {
    var servicesData = data.services;

    return {
      name: servicesData.name,
      price: servicesData.price
    };
  };

  ServicesBannerView.prototype._setStates = function (data) {
    return {
      hasTooltip: !!data.services.tooltipMessage
    };
  };

  return ServicesBannerView;
});

define('modules/pdp/views/ServicesBannerGroupView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/pdp/views/ServicesBannerView'
], function ($, fn, BaseView, ServicesBannerView) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function ServicesBannerGroupView(config) {
    var template = config.sTemplate || '#services-banner-group-template',
      $templateScript = $(template);

    this.sViewName = 'ServicesBannerGroupView';
    this.sTag = 'banner';
    this.sNamespace = 'services';
    this.sViewClass = 'services-banner-group';
    this.sTemplate = $templateScript.length > 0 ? $templateScript[0].innerHTML : '';
    this.parent.constructor.call(this, config);
  }

  fn.inherit(ServicesBannerGroupView, BaseView);

  ServicesBannerGroupView._name = 'ServicesBannerGroupView';
  ServicesBannerGroupView.sNamespace = 'services';
  ServicesBannerGroupView.sTag = 'banner';

  ServicesBannerGroupView.prototype._setData = function () {
    var servicesData = this.oData.mvc.services;

    this.oData.mvc.flags.multipleServices = fn.isArray(servicesData) && servicesData.length > 1;
  };

  ServicesBannerGroupView.prototype._setProps = function (data) {
    var DOUBLE_CLASSES = 'functional-banner-double center-children-vertically',
      SINGLE_CLASSES = 'functional-banner-single';

    return {
      classNames: fn.isArray(data.services) && data.services.length > 1
          ? DOUBLE_CLASSES : SINGLE_CLASSES
    };
  };

  ServicesBannerGroupView.prototype._setStates = function (data) {
    return {
      multipleServices: fn.isArray(data.services) && data.services.length > 1
    };
  };

  ServicesBannerGroupView.prototype._addSubViews = function () {
    var servicesData = this.oData.mvc.services,
      servicesBannerViews = [];

    fn.loopArray.call(this, servicesData, function loopServicesData(i) {
      servicesBannerViews.push(this._compileSubView({
        _class: ServicesBannerView,
        data: servicesData[i]
      }));

      if (i === 1) {
        return false;
      }
      return undefined;
    }, { check: true });

    this.oData.views.ServicesBannerView = servicesBannerViews;
  };

  ServicesBannerGroupView.prototype._initDependancies = function () {
    if (this.oData.mvc.flags.isKiosk) {
      this._updateMediaViewerContainer();
    }
  };

  ServicesBannerGroupView.prototype._updateMediaViewerContainer = function () {
    var MAIN_CONTENT = '.main-content-wrapper',
      SERVICES_CLASS = 'services-available',
      $mainContent = $(MAIN_CONTENT);

    if ($mainContent.length > 0 && this.oData.mvc.services.length > 0) {
      $mainContent.addClass(SERVICES_CLASS);
    }
  };

  return ServicesBannerGroupView;
});

define('modules/mvc/ev',['require','exports','module','modules/mvc/fn'],function (require, exports, module) {
  'use strict';


  var ev = {},
    fn = require('modules/mvc/fn');


  /**
   *
   * @param {Object} data
   * @param {Object} [opts]
   * @return {void}
   */
  ev.renderView = function (data, opts) {
    var args = {},
      _opts = opts || {};

    args.name = 'render';
    args.data = data;
    args.propName = 'oData';

    if (!_opts.timeout) {
      fn.createEvent(args).fire();
      return;
    }

    setTimeout(function () {
      fn.createEvent(args).fire();
    }, _opts.timeout);
  };


  module.exports = ev;
});

define('modules/pdp/views/ProductPageTabPanelGroupView', [
  'modules/mvc/fn',
  'modules/pdp/views/BasePanelGroupView'
], function (fn, BasePanelGroupView) {
  var ProductPageTabPanelGroupView = function (oConfig) {
    this.hasNoId = true;
    this.oStyles = {
      kiosk: ['slideOut-up']
    };
    this.sTag = 'tabs';
    this.sViewName = 'ProductPageTabPanelGroupView';
    this.sViewClass = 'info-panel-group-tabs';
    this.parent.constructor.call(this, oConfig);
  };

  fn.inherit(ProductPageTabPanelGroupView, BasePanelGroupView);

  ProductPageTabPanelGroupView._name = 'ProductPageTabPanelGroupView';

  return ProductPageTabPanelGroupView;
});

define('modules/pdp/views/ProductPageTabPanelView', [
  'modules/mvc/fn',
  'modules/pdp/views/BasePanelView'
], function (fn, BasePanelView) {
  var ProductPageTabPanelView = function (oConfig) {
    this.oStyles = {
      kiosk: ['slideOut-up']
    };
    this.sTag = 'tabs';
    this.sViewName = 'ProductPageTabPanelView';
    this.sViewClass = 'info-panel-tabs';
    this.parent.constructor.call(this, oConfig);
  };

  fn.inherit(ProductPageTabPanelView, BasePanelView);

  ProductPageTabPanelView._name = 'ProductPageTabPanelView';

  ProductPageTabPanelView.prototype._openStartHook = function () {
    $(this.oElms.elWrapper).css('z-index', '1');
  };

  ProductPageTabPanelView.prototype._closeEndHook = function () {
    var IS_ACTIVE = 'is-active';

    if ($(this.oElms.elPanelGroup).hasClass(IS_ACTIVE)) {
      $(this.oElms.elWrapper).css('z-index', '');
    } else {
      this.triggerOnTransitionEnd(function () {
        $(this.oElms.elWrapper).css('z-index', '');
      }, { target: this.oElms.elWrapper, propertyName: 'top' });
    }
  };

  return ProductPageTabPanelView;
});

define('modules/pdp/views/KioskProductSpecView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/pdp/views/ProductSpecView',
  'modules/pdp/views/ProductCLPView'
], function (
  $,
  fn,
  BaseView,
  ProductSpecView,
  ProductCLPView
) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function KioskProductSpecView(config) {
    this.sViewName = 'KioskProductSpecView';
    this.sNamespace = 'sku';
    this.sTag = 'kioskProductSpec';
    this.sViewClass = 'kiosk-product-spec-view';
    this.sTemplate = $('#kiosk-product-spec-view-template')[0].innerHTML;
    this.parent.constructor.call(this, config);
  }

  fn.inherit(KioskProductSpecView, BaseView);
  KioskProductSpecView._name = 'KioskProductSpecView';
  KioskProductSpecView.sNamespace = 'sku';
  KioskProductSpecView.sTag = 'kioskProductSpec';

  KioskProductSpecView.prototype._addSubViews = function () {
    var productSpec = [];

    productSpec.push(this._compileSubView({ _class: ProductSpecView, ctlr: true }));
    productSpec.push(this._compileSubView({ _class: ProductCLPView, ctlr: true }));
    this.oData.views.productSpec = productSpec;
  };

  return KioskProductSpecView;
});

define('modules/pdp/views/KioskProductReviewsView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView'
], function ($, fn, BaseView) {
  'use strict';

  var KioskProductReviewsView = function (oConfig) {
    this.sViewName = 'KioskProductReviewsView';
    this.sNamespace = 'sku';
    this.sViewClass = 'product-page-reviews';
    this.sTemplate = $('#kiosk-product-page-reviews-template')[0].innerHTML;
    this.sStaleDOMReviewsSelector = '#BVRRContainer';
    this.parent.constructor.call(this, oConfig);
  };

  fn.inherit(KioskProductReviewsView, BaseView);

  KioskProductReviewsView._name = 'KioskProductReviewsView';
  KioskProductReviewsView.sNamespace = 'sku';

  KioskProductReviewsView.prototype._setData = function () {
    this._removeExistingReviewsDOMHook();
  };

  KioskProductReviewsView.prototype._removeExistingReviewsDOMHook = function () {
    $(this.sStaleDOMReviewsSelector).remove();
  };

  return KioskProductReviewsView;
});

define('modules/pdp/views/ProductSynopsisView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView'
], function ($, fn, BaseView) {
  var ProductSynopsisView = function (oConfig) {
    this.sViewName = 'ProductSynopsisView';
    this.sNamespace = 'sku';
    this.sTag = '_default';
    this.sViewClass = 'product-synopsis';
    this.sTemplate = $('#product-synopsis-template')[0].innerHTML;
    this.parent.constructor.call(this, oConfig);
  };

  fn.inherit(ProductSynopsisView, BaseView);

  ProductSynopsisView._name = 'ProductSynopsisView';
  ProductSynopsisView.sNamespace = 'sku';

  ProductSynopsisView.prototype._setData = function (mViewData) {
    this.parent._setData.call(this, mViewData);
  };

  return ProductSynopsisView;
});

define('modules/pdp/views/AuthorBiographyView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/show-more/ShowMore'
], function ($, fn, BaseView, ShowMore) {
  'use strict';

  /**
   * The view class that renders the author biography.
   * @param {Object} config The configuration for the view.
   * @return {void}
   */
  function AuthorBiographyView(config) {
    var template = config.sTemplate || '#author-biography-view-template',
      $tmplScript = $(template);

    this.sViewName = 'AuthorBiographyView';
    this.sNamespace = 'sku';
    this.sTag = 'authorBiography';
    this.sViewClass = 'author-biography-view';
    this.sTemplate = $tmplScript.length > 0 ? $tmplScript[0].innerHTML : '';
    this.parent.constructor.call(this, config);
  }

  fn.inherit(AuthorBiographyView, BaseView);

  AuthorBiographyView._name = 'AuthorBiographyView';
  AuthorBiographyView.sNamespace = 'sku';
  AuthorBiographyView.sTag = 'authorBiography';

  AuthorBiographyView.prototype._setProps = function (data) {
    var bookDetails = {};

    if (fn.isObject(data.sku) && fn.isObject(data.sku.bookDetails)) {
      bookDetails = data.sku.bookDetails;
    }

    return {
      authorBiography: bookDetails.authorBiography
    };
  };

  AuthorBiographyView.prototype._cacheDomElms = function () {
    var $wrapper = null;

    this.parent._cacheDomElms.call(this);
    $wrapper = $(this.oElms.elWrapper);
    this.oElms.biographyContent = $wrapper.find('div.block-content')[0];
  };

  AuthorBiographyView.prototype._initDependancies = function () {
    var _this = this;

    if (this.oData.mvc.flags.onProductPage) {
      setTimeout(function () {
        _this.showMore = new ShowMore({
          selector: _this.oElms.elWrapper,
          height: 400
        });

        _this.showMore.fnInit();
      }, 100);
    }
  };

  AuthorBiographyView.prototype.refresh = function (args) {
    var data = args.mParamData.mvc,
      $node = $(this.parseHtml(
        { html: this.render({ mParamData: { mvc: data } }), trim: true }
      ));

    fn.refreshElement(
      this.oElms.biographyContent,
      $node.find('div.block-content')[0]
    );

    if (this.showMore) {
      this.showMore.toggleInit();
    }
  };

  return AuthorBiographyView;
});


define('text!templates/views/kioskTabs.html',[],function () { return '<div id="{{sViewId}}" class="{{sViewClass}} {{sClassNames}}">\r\n  <ul class="kiosk-tabs-nav">\r\n    <li class="disabled"><a class="previous icon" data-icon="g"></a></li>\r\n    <li><a class="next icon" data-icon="r"></a></li>\r\n  </ul>\r\n  <div class="kiosk-tabs-items-wrapper">\r\n    <ul class="kiosk-tabs-items">\r\n        <li><a id="tab-overview" class="js-tab-overview tab-home is-active">Product overview</a></li>\r\n        {{#state.hasPromos}}\r\n            <li><a id="tab-PromotionsView" class="js-tab-PromotionsView kiosk-tab special-highlight">{{props.promoLabel}}</a></li>\r\n        {{/state.hasPromos}}\r\n        {{#state.hasDetails}}\r\n            <li><a id="tab-ProductDetailsView" class="js-tab-ProductDetailsView kiosk-tab">Product details</a></li>\r\n        {{/state.hasDetails}}\r\n        {{#state.hasSynopsis}}\r\n            <li><a id="tab-ProductSynopsisView" class="js-tab-ProductSynopsisView kiosk-tab">Synopsis</a></li>\r\n        {{/state.hasSynopsis}}\r\n        {{#state.hasBiography}}\r\n          <li><a id="tab-AuthorBiographyView" class="js-tab-AuthorBiographyView kiosk-tab">Author\'s biography</a></li>\r\n        {{/state.hasBiography}}\r\n        {{#state.hasSpecs}}\r\n          <li><a id="tab-KioskProductSpecView" class="js-tab-KioskProductSpecView kiosk-tab">Product specifications</a></li>\r\n        {{/state.hasSpecs}}\r\n        {{#state.hasReviews}}\r\n          <li><a id="tab-KioskProductReviewsView" class="js-tab-KioskProductReviewsView kiosk-tab">Reviews</a></li>\r\n        {{/state.hasReviews}}\r\n        {{#state.hasAccessories}}\r\n          <li><a id="tab-Accessories" class="js-tab-Accessories kiosk-tab">Accessories</a></li>\r\n        {{/state.hasAccessories}}\r\n        {{#state.hasBundle}}\r\n          <li><a id="tab-Bundle" class="js-tab-Bundle kiosk-tab">Often bought togther</a></li>\r\n        {{/state.hasBundle}}\r\n        {{#state.hasShopTheRange}}\r\n          <li><a id="tab-ShopTheRange" class="js-tab-ShopTheRange kiosk-tab">Shop the range</a></li>\r\n        {{/state.hasShopTheRange}}\r\n        {{#state.hasCompleteTheLook}}\r\n          <li><a id="tab-CompleteTheLook" class="js-tab-CompleteTheLook kiosk-tab">Complete the look</a></li>\r\n        {{/state.hasCompleteTheLook}}\r\n        {{#state.hasOutfitBuilder}}\r\n          <li><a id="tab-OutfitBuilder" class="js-tab-OutfitBuilder kiosk-tab">Matching items</a></li>\r\n        {{/state.hasOutfitBuilder}}\r\n    </ul>\r\n  </div>\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/kiosk-tabs/index',['require','exports','module','modules/mvc/fn','modules/mvc/ev','modules/pdp/views/BaseView','modules/pdp/views/ProductPageTabPanelGroupView','modules/pdp/views/ProductPageTabPanelView','modules/pdp/views/KioskProductDetailsView','modules/pdp/views/KioskProductSpecView','modules/pdp/views/KioskProductReviewsView','modules/pdp/views/ProductSynopsisView','modules/pdp/views/AuthorBiographyView','text!templates/views/kioskTabs.html','text!templates/views/relatedItemsViewWithTitle.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    ev = require('modules/mvc/ev'),
    BaseView = require('modules/pdp/views/BaseView'),
    ProductPageTabPanelGroupView = require('modules/pdp/views/ProductPageTabPanelGroupView'),
    ProductPageTabPanelView = require('modules/pdp/views/ProductPageTabPanelView'),
    KioskProductDetailsView = require('modules/pdp/views/KioskProductDetailsView'),
    KioskProductSpecView = require('modules/pdp/views/KioskProductSpecView'),
    KioskProductReviewsView = require('modules/pdp/views/KioskProductReviewsView'),
    ProductSynopsisView = require('modules/pdp/views/ProductSynopsisView'),
    AuthorBiographyView = require('modules/pdp/views/AuthorBiographyView'),
    template = require('text!templates/views/kioskTabs.html'),
    relatedItemsViewWithTitleTmpl = require('text!templates/views/relatedItemsViewWithTitle.html');

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function KioskTabsView(config) {
    this.sViewName = 'KioskTabsView';
    this.sNamespace = 'links';
    this.sTag = 'tabs';
    this.sViewClass = 'kiosk-tabs';
    this.sTemplate = template;
    this.parent.constructor.call(this, config);
  }

  fn.inherit(KioskTabsView, BaseView);
  KioskTabsView._name = 'KioskTabsView';
  KioskTabsView.sNamespace = 'links';
  KioskTabsView.sTag = 'tabs';

  /**
   *
   * @param {Object} data
   * @return {Object}
   */
  KioskTabsView.prototype._setProps = function (data) {
    var flags = data.flags.tabs,
      sellerData = data.sellers,
      promoLabel = '',
      promosLength = flags.hasPromos ? sellerData.promotions.length : 0,
      tabCount = 0;

    if (promosLength === 1) {
      promoLabel = promosLength + ' Special offer';
    } else if (promosLength > 1) {
      promoLabel = promosLength + ' Special offers';
    }

    Object.keys(flags).forEach(function (key) {
      if (flags[key]) tabCount += 1;
    });

    return {
      promoLabel: promoLabel,
      tabCount: tabCount
    };
  };

  /**
   *
   * @param {Object} data
   * @return {Object}
   */
  KioskTabsView.prototype._setStates = function (data) {
    var flags = data.flags.tabs;

    return {
      hasAccessories: flags.hasAccessories,
      hasBiography: flags.hasBiography,
      hasBundle: flags.hasBundle,
      hasCompleteTheLook: flags.hasCompleteTheLook,
      hasDetails: flags.hasDetails,
      hasOutfitBuilder: flags.hasOutfitBuilder,
      hasPromos: flags.hasPromos,
      hasReviews: flags.hasReviews,
      hasShopTheRange: flags.hasShopTheRange,
      hasSpecs: flags.hasSpecs,
      hasSynopsis: flags.hasSynopsis
    };
  };

  /**
   *
   * @return {void}
   */
  KioskTabsView.prototype._cacheDomElms = function () {
    var $wrapper = null;

    this.parent._cacheDomElms.call(this);
    $wrapper = $(this.oElms.elWrapper);
    this.oElms.tabOverview = $wrapper.find('.js-tab-overview')[0];
  };

  /**
   *
   * @return {void}
   */
  KioskTabsView.prototype._initDependancies = function () {
    this._createTabsCarousel();
    this._createTabPanelGroup();
  };

  /**
   *
   * @return {void}
   */
  KioskTabsView.prototype._createTabsCarousel = function () {
    var $wrapper = $(this.oElms.elWrapper);

    if (this.oData.props.tabCount > 5) {
      $wrapper.addClass('in-carousel');
    }

    $(this.oElms.elWrapper).carousel({
      itemSelector: '.kiosk-tabs-items > li',
      bHideNextPreviousIfAllItemsVisible: true,
      centraliseThumbnails: { enabled: true }
    });
  };

  /**
   *
   * @return {void}
   */
  KioskTabsView.prototype._createTabPanelGroup = function () {
    var mvcData = this.oData.mvc,
      flags = this.oData.mvc.flags.tabs,
      panelGroup = {},
      tabViews = [];

    if (flags.hasAccessories) {
      tabViews.push(this._renderAccessories(mvcData));
    }

    if (flags.hasBiography) {
      tabViews.push(this._compileSubView({ _class: AuthorBiographyView }));
    }

    if (flags.hasBundle) {
      tabViews.push(this._renderBundle(mvcData));
    }

    if (flags.hasCompleteTheLook) {
      tabViews.push(this._renderCompleteTheLook(mvcData));
    }

    if (flags.hasDetails) {
      tabViews.push(this._compileSubView({ _class: KioskProductDetailsView }));
    }

    if (flags.hasOutfitBuilder) {
      tabViews.push(this._renderOutfitBuilder(mvcData));
    }

    if (flags.hasPromos) {
      tabViews.push(this._renderPromotions(mvcData));
    }

    if (flags.hasReviews) {
      tabViews.push(this._compileSubView({ _class: KioskProductReviewsView }));
    }

    if (flags.hasShopTheRange) {
      tabViews.push(this._renderShopTheRange(mvcData));
    }

    if (flags.hasSpecs) {
      tabViews.push(this._compileSubView({ _class: KioskProductSpecView }));
    }

    if (flags.hasSynopsis) {
      tabViews.push(this._compileSubView({ _class: ProductSynopsisView }));
    }

    panelGroup = new ProductPageTabPanelGroupView({ sTag: 'tabs', elTarget: $('body')[0] });

    fn.loopArray(tabViews, function (i) {
      panelGroup.createSubView({
        ViewClass: ProductPageTabPanelView,
        mParamData: {
          elTrigger: '.js-tab-' + tabViews[i].sViewName,
          oData: {
            sClassName: 'info-panel-tabs',
            aSubViews: [tabViews[i]]
          },
          iSubViewCount: tabViews.length
        }
      });
    });

    panelGroup.render();
  };

  /**
   *
   * @param {Object} mvcData
   * @return {Object}
   */
  KioskTabsView.prototype._renderAccessories = function (mvcData) {
    ev.renderView({
      sNamespace: 'sku',
      sTag: 'links',
      sViewName: 'RelatedSKUView',
      elTarget: '.js-accessories-tab-placeholder',
      sOutput: 'outer',
      mParamData: {
        flags: {
          accessories: true,
          carousel: true,
          inPanel: mvcData.flags.inPanel,
          isFF: mvcData.flags.isFF,
          isKiosk: mvcData.flags.isKiosk,
          showRatings: true
        },
        id: mvcData.sku.id,
        relatedItemHeading: 'Popular accessories',
        relationshipType: 'accessories',
        processHyperMediaType: 'sku',
        processHyperMedia: true,
        subView: { ctlr: true, name: 'CarouselItemsView' }
      }
    }, { timeout: 10 });

    return {
      render: '<div class="js-accessories-tab-placeholder"></div>', sViewName: 'Accessories'
    };
  };

  /**
   *
   * @param {Object} mvcData
   * @return {Object}
   */
  KioskTabsView.prototype._renderBundle = function (mvcData) {
    ev.renderView({
      sNamespace: 'sku',
      sTag: 'links',
      sViewName: 'RelatedSKUView',
      elTarget: '.js-bundle-tab-placeholder',
      sOutput: 'outer',
      sTemplate: relatedItemsViewWithTitleTmpl,
      mParamData: {
        flags: {
          bundle: true,
          inPanel: mvcData.flags.inPanel,
          isFF: mvcData.flags.isFF,
          isKiosk: mvcData.flags.isKiosk
        },
        id: mvcData.sku.id,
        relatedItemHeading: 'Often bought together',
        relationshipType: 'accessories',
        processHyperMediaType: 'sku',
        processHyperMedia: true,
        subView: {
          ctlr: true,
          filterOptions: {
            category: {
              unique: true
            },
            inventory: {
              available: true
            }
          },
          name: 'BundleView'
        }
      }
    }, { timeout: 10 });

    return {
      render: '<div class="js-bundle-tab-placeholder"></div>', sViewName: 'Bundle'
    };
  };

  /**
   *
   * @param {Object} mvcData
   * @return {Object}
   */
  KioskTabsView.prototype._renderCompleteTheLook = function (mvcData) {
    ev.renderView({
      sNamespace: 'products',
      sTag: 'links',
      sViewName: 'RelatedProductView',
      elTarget: '.js-ctl-tab-placeholder',
      sOutput: 'outer',
      mParamData: {
        flags: {
          carousel: true,
          completeTheLook: true,
          inPanel: mvcData.flags.inPanel,
          isFF: mvcData.flags.isFF,
          isKiosk: mvcData.flags.isKiosk
        },
        id: mvcData.products.id,
        relatedItemHeading: 'Complete the look',
        relationshipType: 'completeTheLook',
        processHyperMediaType: 'product',
        relationshipLookup: false,
        subView: { ctlr: true, name: 'CarouselItemsView' }
      }
    }, { timeout: 10 });

    return {
      render: '<div class="js-ctl-tab-placeholder"></div>', sViewName: 'CompleteTheLook'
    };
  };

  /**
   *
   * @param {Object} mvcData
   * @return {Object}
   */
  KioskTabsView.prototype._renderOutfitBuilder = function (mvcData) {
    ev.renderView({
      sNamespace: 'products',
      sTag: 'links',
      sViewName: 'RelatedProductView',
      elTarget: '.js-outfit-tab-placeholder',
      sOutput: 'outer',
      sTemplate: relatedItemsViewWithTitleTmpl,
      mParamData: {
        flags: {
          grid: true,
          hidePrimaryVariant: true,
          inPanel: mvcData.flags.inPanel,
          isFF: mvcData.flags.isFF,
          isKiosk: mvcData.flags.isKiosk,
          outfitBuilder: true,
          showItemActions: true,
          showVariants: true
        },
        id: mvcData.products.id,
        relatedItemHeading: 'Matching items',
        relationshipType: 'outFit',
        processHyperMediaType: 'product',
        relationshipLookup: false,
        subView: { ctlr: true, name: 'OutfitItemsView' }
      }
    }, { timeout: 10 });

    return {
      render: '<div class="js-outfit-tab-placeholder"></div>', sViewName: 'OutfitBuilder'
    };
  };

  /**
   *
   * @param {Object} mvcData
   * @return {Object}
   */
  KioskTabsView.prototype._renderPromotions = function (mvcData) {
    mvcData.flags.toEqualiseHeights = true;

    ev.renderView({
      sNamespace: 'promotions',
      sTag: 'productPage',
      sViewName: 'PromotionsView',
      elTarget: '.js-promo-tab-placeholder',
      sOutput: 'outer',
      sTemplate: '#promotions-view-with-title-template',
      mParamData: { mvc: mvcData }
    }, { timeout: 10 });

    return {
      render: '<div class="js-promo-tab-placeholder"></div>', sViewName: 'PromotionsView'
    };
  };

  /**
   *
   * @param {Object} mvcData
   * @return {Object}
   */
  KioskTabsView.prototype._renderShopTheRange = function (mvcData) {
    ev.renderView({
      elTarget: '.js-range-tab-placeholder',
      mParamData: {
        flags: {
          grid: true,
          inPanel: mvcData.flags.inPanel,
          isFF: mvcData.flags.isFF,
          isKiosk: mvcData.flags.isKiosk,
          shopTheRange: true,
          showItemActions: true,
          showRatings: true
        },
        id: mvcData.sku.id,
        processHyperMedia: true,
        processHyperMediaType: 'sku',
        relatedItemHeading: 'Shop the range',
        relationshipType: 'range',
        subView: {
          ctlr: true,
          filterOptions: { inventory: { available: true } },
          name: 'OutfitItemsView'
        }
      },
      sNamespace: 'sku',
      sOutput: 'outer',
      sTag: 'links',
      sTemplate: relatedItemsViewWithTitleTmpl,
      sViewName: 'RelatedSKUView'
    }, { timeout: 10 });

    return {
      render: '<div class="js-range-tab-placeholder"></div>', sViewName: 'ShopTheRange'
    };
  };

  /**
   *
   * @return {void}
   */
  KioskTabsView.prototype._bindEvents = function () {
    $(this.oElms.tabOverview).on(
      'click',
      this._onOverviewTabClick.bind(this)
    );

    $(window)
      .on('panelGroupOpen', this._setOverlayActiveState.bind(this))
      .on('panelGroupClosed', this._unsetOverlayActiveState.bind(this))
      .on('triggerKioskTab', this._triggerKioskTab.bind(this));
  };

  /**
   *
   * @param {JQueryEvent} e
   * @return {void}
   */
  KioskTabsView.prototype._onOverviewTabClick = function (e) {
    fn.createEvent({
      name: 'closeOpenPanels',
      propName: 'oData',
      data: { oClickEvent: e, oView: this, sTag: this.sTag }
    }).fire();
  };

  /**
   *
   * @param {JQueryEvent} e
   * @return {void}
   */
  KioskTabsView.prototype._setOverlayActiveState = function (e) {
    var IS_ACTIVE = 'is-active';

    if (e.oData.sTag === this.sTag) {
      $(this.oElms.tabOverview).removeClass(IS_ACTIVE);
    }
  };

  /**
   *
   * @param {JQueryEvent} e
   * @return {void}
   */
  KioskTabsView.prototype._unsetOverlayActiveState = function (e) {
    var IS_ACTIVE = 'is-active';

    if (e.oData.sTag === this.sTag) {
      $(this.oElms.tabOverview).addClass(IS_ACTIVE);
    }
  };

  /**
   *
   * @param {JQueryEvent} e
   * @return {void}
   */
  KioskTabsView.prototype._triggerKioskTab = function (e) {
    if (e.sViewName) {
      $('.js-tab-' + e.sViewName).trigger('click');
    }
  };

  module.exports = KioskTabsView;
});

define('modules/pdp/views/KioskProductPageView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/pdp/views/KioskProductPageTitleView',
  'modules/pdp/views/KioskProductDetailsView',
  'modules/pdp/views/ProductMediaViewerView',
  'modules/pdp/media-viewer/common',
  'modules/pdp/views/BuyboxView',
  'modules/pdp/views/ServicesBannerGroupView',
  'modules/pdp/views/kiosk-tabs/index'
], function (
  $,
  fn,
  BaseView,
  KioskProductPageTitleView,
  KioskProductDetailsView,
  ProductMediaViewerView,
  mediaViewer,
  BuyboxView,
  ServicesBannerGroupView,
  KioskTabs
) {
  'use strict';

  var KioskProductPageView = function (oConfig) {
    this.sViewName = 'KioskProductPageView';
    this.sNamespace = 'sku';
    this.sTag = 'kioskPage';
    this.sViewClass = 'content-container';
    this.sTemplate = $('#kiosk-product-page-template')[0].innerHTML;
    this.sMainContentWrapperSelector = '.main-content-wrapper';
    this.sStaticWrapperSelector = '.static-product-image';
    this.parent.constructor.call(this, oConfig);
  };

  fn.inherit(KioskProductPageView, BaseView);
  KioskProductPageView._name = 'KioskProductPageView';
  KioskProductPageView.sNamespace = 'sku';

  KioskProductPageView.prototype._setData = function () {
    if (this.oData.mvc.custom === undefined) {
      this.oData.mvc.custom = {};
    }

    this.oData.mvc.flags.isKiosk = window.isKiosk();

    this._setPreloadedElements();

    this.oData.oProductPageTitleView = this._compileSubView({
      _class: KioskProductPageTitleView
    });

    this.oData.oProductDetailsView = this._compileSubView({
      _class: KioskProductDetailsView
    });

    this.oData.oProductMediaViewerView = this._compileSubView({
      _class: ProductMediaViewerView
    });

    this.oData.oBuyboxView = this._compileSubView({
      _class: BuyboxView,
      ctlr: true
    });

    this.oData.oServicesBannerGroupView = this._compileSubView({
      _class: ServicesBannerGroupView,
      ctlr: true
    });

    this.oData.oKioskTabs = this._compileSubView({
      _class: KioskTabs,
      ctlr: true
    });
  };

  KioskProductPageView.prototype._initDependancies = function () {
    var _this = this,
      eScene7 = new $.Event('scene7.init');

    eScene7.oData = this.oData.mvc.sku;
    this._setMediaViewerOrientation();

    $(window).trigger(eScene7);

    if (this.oData.mvc.sku.noofRatingsProduced === null) {
      $(window).on('bazaarVoiceLoaded', function () {
        _this._disableBazaarVoiceReviews();
      });
    }
  };

  KioskProductPageView.prototype._disableBazaarVoiceReviews = function () {
    $('#BVRRSummaryContainer, #BVRRSummaryContainer a.bv-rating-stars-container')
      .unbind('click')
      .on('click', function (event) {
        event.preventDefault();
        event.stopImmediatePropagation();
      });
  };

  KioskProductPageView.prototype._setMediaViewerOrientation = function () {
    if ($(this.sMainContentWrapperSelector).length) {
      $(this.sMainContentWrapperSelector).addClass(
        'media-viewer--' + this.oData.mvc.custom.mediaViewer.sOrientation
      );
    }
  };

  KioskProductPageView.prototype._getPreloadedMediaViewerOrientation = function () {
    var sOrientation = 'landscape'; // default to landscape media orientation

    if ($(this.sMainContentWrapperSelector).length) {
      sOrientation = $(this.sMainContentWrapperSelector).hasClass('media-viewer--portrait')
        ? 'portrait'
        : 'landscape';
    }
    this.oData.mvc.custom.mediaViewer = {};
    this.oData.mvc.custom.mediaViewer.sOrientation = sOrientation;
  };

  KioskProductPageView.prototype._getPreloadedMediaViewerType = function () {
    var sScene7Enabled = null;

    sScene7Enabled = $(this.sStaticWrapperSelector).hasClass('scene7-enabled')
      ? 'scene7-enabled'
      : '';
    this.oData.mvc.custom.mediaViewer.sScene7Enabled = sScene7Enabled;
  };

  KioskProductPageView.prototype._setPreloadedElements = function () {
    this._getPreloadedMediaViewerOrientation();
    this._getPreloadedMediaViewerType();
  };

  return KioskProductPageView;
});

define('modules/pdp/controllers/kiosk-tabs/index',['require','exports','module','modules/mvc/fn','modules/pdp/controllers/BaseController','modules/pdp/views/kiosk-tabs/index'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseController = require('modules/pdp/controllers/BaseController'),
    KioskTabsView = require('modules/pdp/views/kiosk-tabs/index');

  /**
   *
   * @param {Array<Objects>} models
   * @return {void}
   */
  function KioskTabsController(models) {
    this.sNamespace = 'links';
    this.sTag = 'tabs';
    this.views = { classes: { KioskTabsView: KioskTabsView } };
    this.parent.constructor.call(this, models);
  }

  fn.inherit(KioskTabsController, BaseController);
  KioskTabsController.modelNames = ['inventorySKU', 'links', 'products', 'sellers', 'sku'];

  /**
   *
   * @param {Object} args
   * @param {JQueryDeferred} args.deferred
   * @param {Object} args.mParamData
   * @param {Object} args.mParamData.mvc
   * @return {void}
   */
  KioskTabsController.prototype._collateDataDependancies = function (args) {
    var deferred = args.deferred,
      mvcData = args.mParamData.mvc,
      flags = mvcData.flags || {},
      productData = mvcData.products,
      productModel = this.models.products,
      promises = [],
      skuData = mvcData.sku,
      skuModel = this.models.sku;

    flags.isFF = typeof flags.isFF === 'boolean' ? flags.isFF : productModel.isFF(productData);
    flags.inPanel = true;

    flags.tabs = {
      hasAccessories: false,
      hasBiography: !!skuModel.getBookDetails(skuData).authorBiography,
      hasBundle: false,
      hasCompleteTheLook: !!productModel.getLinks(
        { value: 'completeTheLook', data: productData }
      ).length,
      hasDetails: !!skuData.longDescription || !!skuData.bookDetails || (flags.isFF
        && (!!skuData.miniDescription || !!skuData.specification)),
      hasOutfitBuilder: !!productModel.getLinks({ value: 'outFit', data: productData }).length,
      hasReviews: !!skuData.noofRatingsProduced,
      hasShopTheRange: false,
      hasSpecs: !!skuData.specification && !flags.isFF,
      hasSynopsis: !!skuData.skuSynopsis
    };

    promises = promises.concat(this._hasRecommenders(mvcData));
    promises.push(this._hasPromos(mvcData));

    $.when
      .apply($, promises)
      .done(function () {
        deferred.resolve(args);
      });
  };

  /**
   *
   * @param {Object} mvcData
   * @return {Array<JQueryPromise>}
   */
  KioskTabsController.prototype._hasRecommenders = function (mvcData) {
    var _this = this,
      relationships = ['accessories', 'range'],
      promises = [];

    relationships.forEach(function loopRelationships(rel) {
      promises.push(_this._hasRecommender(rel, mvcData));
    });

    return promises;
  };

  /**
   *
   * @param {string} rel
   * @param {Object} mvcData
   * @return {JQueryPromise}
   */
  KioskTabsController.prototype._hasRecommender = function (rel, mvcData) {
    var deferred = $.Deferred(),
      flags = mvcData.flags.tabs,
      relatedModel = this.models.links,
      skuData = mvcData.sku,
      invSkuModel = this.models.inventorySKU;

    relatedModel.fetch({
      mSearchValue: skuData.id,
      sModelMethod: 'relationships',
      hrefData: { relationship: rel },
      doneCallback: function (data) {
        if (!data.links.length) {
          deferred.resolve();
          return;
        }

        invSkuModel.getDataStores({
          fetch: true,
          value: data.links.map(function (link) {
            return link.id;
          })
        })
          .done(function (inv) {
            var avail = inv.filter(function (value) {
              return !!value.available;
            });

            if (avail.length) {
              if (rel === 'accessories') {
                flags.hasAccessories = true;
                flags.hasBundle = true;
              } else if (rel === 'range') {
                flags.hasShopTheRange = true;
              }
            }

            deferred.resolve();
          });
      }
    });

    return deferred.promise();
  };

  /**
   *
   * @param {Object} mvcData
   * @return {JQueryPromise}
   */
  KioskTabsController.prototype._hasPromos = function (mvcData) {
    var check = null,
      deferred = $.Deferred(),
      flags = mvcData.flags.tabs,
      listingID = '',
      observe = null,
      sellerModel = this.models.sellers,
      skuModel = this.models.sku;

    listingID = skuModel.getPrimaryListing(mvcData.sku).id;

    check = function checkSellerData(data) {
      if (!fn.checkData(data, ['id', 'name'])) {
        observe();
      } else {
        mvcData.sellers = data;
        flags.hasPromos = fn.isArray(data.promotions, { notEmpty: true });
        deferred.resolve();
      }
    };

    observe = function observeSellerData() {
      sellerModel.observe({
        action: 'add',
        callback: function observeCallback(resp) {
          check(resp.data.observe);
        },
        once: true,
        searchValue: listingID
      });
    };

    check(sellerModel.getDataStores({ value: listingID, noFetch: true }));
    return deferred.promise();
  };

  module.exports = KioskTabsController;
});

define('modules/pdp/controllers/utils/tile-data/index',['require','exports','module','modules/mvc/fn'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn');

  /**
   *
   * @private
   * @type {Object}
   */
  var _models;

  /**
   *
   * @param {Object} skuData
   * @param {string} name
   * @return {Object}
   */
  var cloneFormhandler = function cloneFormhandler(skuData, name) {
    var productID = _models.sku.getParentProduct(skuData).id;

    // TODO: Need to add promoID if it is passed in

    return _models.formHandler.clone({
      component: name,
      config: [{
        key: 'catalogRefIds',
        value: _models.sku.getPrimaryListing(skuData).id
      }, {
        key: 'productId',
        value: productID
      }, {
        key: 'skuId',
        value: skuData.id
      }],
      name: 'addToBasket',
      publicLink: _models.products.getPublicLink(productID)
    }, { add: true });
  };

  /**
   *
   * @param {Object} data
   * @param {string} namespace
   * @param {string} tag
   * @return {Object}
   */
  var collateWithAddToBasket = function collateWithItemActions(data, namespace, tag) {
    var obj = {};
    obj[namespace] = data;
    obj.formHandler = cloneFormhandler(data, tag);
    obj.sellers = { buyBoxMessage: 'buy', buyButtonLabel: 'Add to basket' };
    return obj;
  };

  /**
   *
   * @param {Object} data
   * @param {string} namespace
   * @return {Object}
   */
  var collateDefault = function collateDefault(data, namespace) {
    var obj = {};
    obj[namespace] = data;
    return obj;
  };

  /**
   *
   * @param {Array<Object>} data
   * @param {string} namespace
   * @param {string} tag
   * @param {Object} flags
   * @param {Object} models
   * @return {Array<Object>}
   */
  var collateData = function collateData(data, namespace, tag, flags, models) {
    _models = models;
    var collate;
    var collated = [];

    if (namespace === 'sku' && flags.showItemActions) {
      collate = collateWithAddToBasket;
    } else {
      collate = collateDefault;
    }

    fn.loopArray(data, function loopItems(i) {
      collated.push(collate(data[i], namespace, tag));
    });

    return collated;
  };

  module.exports = {
    collateData: collateData
  };
});

define('modules/pdp/controllers/utils/filtering/index',['require','exports','module','modules/mvc/fn'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn');

  /**
   *
   * @private
   * @type {Object}
   */
  var _models;

  /**
   *
   * @param {Array<Object>} data
   * @param {string} namespace
   * @return {Array<Object>}
   */
  var defaultFilter = function defaultFilter(data, namespace) {
    var filtered = [];

    fn.loopArray(data, function loopItems(i) {
      if (fn.isObject(_models[namespace].getPrices(data[i]), { notEmpty: true })) {
        filtered.push(data[i]);
      }
    }, { backward: true });

    return filtered;
  };

  /**
   *
   * @param {Array<Object>} data
   * @param {string} namespace
   * @param {Object} filters
   * @param {JQueryDeferred} deferred
   * @return {Promise}
   */
  var fetchInventory = function fetchInventory(data, namespace, filters, deferred) {
    var model = namespace === 'products' ? _models.inventoryProduct : _models.inventorySKU;

    if (!filters) {
      deferred.resolve(data);
      return null;
    }

    var ids = data.map(function (obj) {
      return obj.id;
    });

    return model.getDataStores({ value: ids, fetch: true });
  };

  /**
   *
   * @param {Array<Object>} data
   * @param {Array<Object>} inventory
   * @param {Object} filters
   * @return {void}
   */
  var filterInventory = function filterInventory(data, inventory, filters) {
    var _filters = filters || {};
    var matchFound = false;

    fn.loopArray(data, function (i) {
      matchFound = false;

      fn.loopArray(inventory, function (j) {
        if (fn.isObject(data[i], { notEmpty: true })) {
          if (data[i].id === inventory[j].id) {
            matchFound = true;

            if (_filters.available && !inventory[j].available) {
              data.splice(i, 1);
            } else if (_filters.subscribable && !inventory[j].subscribable) {
              data.splice(i, 1);
            }
          }
        }
      });

      if (!matchFound) {
        data.splice(i, 1);
      }
    }, { backward: true });
  };

  /**
   *
   * @param {Array<Object>} data
   * @param {string} namespace
   * @param {Object} filters
   * @return {Promise}
   */
  var fetchAndFilterInventory = function fetchAndFilterInventory(data, namespace, filters) {
    var deferred = $.Deferred();
    var promise = fetchInventory(data, namespace, filters, deferred);

    if (promise) {
      promise
        .done(function (inventory) {
          if (!fn.isArray(inventory, { notEmpty: true })) {
            deferred.reject();
            return;
          }

          filterInventory(data, inventory, filters);

          if (!data.length) {
            deferred.reject();
            return;
          }

          deferred.resolve(data);
        })
        .fail(function () {
          deferred.reject();
        });
    }

    return deferred.promise();
  };

  /**
   *
   * @param {Array<Object>} data
   * @param {string} namespace
   * @param {Object} filters
   * @param {Object} models
   * @return {Promise}
   */
  var filterItems = function filterItems(data, namespace, filters, models) {
    _models = models;
    var filteredData = defaultFilter(data, namespace);
    var deferred = $.Deferred();

    fetchAndFilterInventory(filteredData, namespace, filters.inventory)
      .done(function (inventoryFilteredData) {
        deferred.resolve(inventoryFilteredData);
      })
      .fail(function () {
        deferred.reject();
      });

    return deferred.promise();
  };


  module.exports = {
    filterItems: filterItems
  };
});


define('text!templates/views/carouselItemView.html',[],function () { return '<div id="{{sViewId}}" class="{{sViewClass}} {{sClassNames}}">\r\n  {{#views.ProductTileView}}\r\n    {{{render}}}\r\n  {{/views.ProductTileView}}\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/CarouselItemView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','modules/pdp/views/ProductTileView','text!templates/views/carouselItemView.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    ProductTileView = require('modules/pdp/views/ProductTileView'),
    template = require('text!templates/views/carouselItemView.html');

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function CarouselItemView(config) {
    this.sViewName = 'CarouselItemView';
    this.sNamespace = 'inherit';
    this.sTag = 'recommender';
    this.sViewClass = 'carousel-item';
    this.sTemplate = template;
    this.parent.constructor.call(this, config);
  }

  fn.inherit(CarouselItemView, BaseView);
  CarouselItemView._name = CarouselItemView;
  CarouselItemView.sNamespace = 'inherit';
  CarouselItemView.sTag = 'recommender';

  CarouselItemView.prototype._setData = function () {
    var viewModel = this.oData.mvc[this.sNamespace];

    delete this.oData.mvc.viewModel;

    fn.loopObject.call(this, viewModel, function loopViewModel(prop) {
      this.oData.mvc[prop] = viewModel[prop];
    });
  };

  CarouselItemView.prototype._addSubViews = function () {
    this.oData.views.ProductTileView = this._compileSubView({
      _class: ProductTileView
    });
  };

  module.exports = CarouselItemView;
});

define('modules/pdp/controllers/CarouselController', [], function () {
  'use strict';

  var CarouselController = {},
    _initCarousel = {};

  CarouselController = function ($container) {
    var sCarouselSelector = '.carousel-fullwidth';

    this.$carousel = $container.find(sCarouselSelector);
    _initCarousel(this);
  };

  _initCarousel = function initCarousel(self) {
    var oOptions = {
      itemSelector: '.carousel-items-list > li',
      bIncludePagination: true,
      oPaginationOptions: {
        sHeaderSelector: '.cfw-header',
        sPaginationClass: 'cfw-navigation',
        sPageSelector: '.nav-dot',
        sPageClass: 'nav-dot',
        sSelectedPageClass: 'isSelected',
        sPageButtonClass: 'dot-action',
        breakpointsToAvoidMovingPastLastItem: {
          mobile: {
            paddingToRightOfCarousel: 10
          },
          vTablet: {
            paddingToRightOfCarousel: 0
          }
        }
      },
      elasticBounceOnEmptySwipe: true,
      wiggleStartupCeremony: true,
      bHideNextPreviousIfAllItemsVisible: true,
      bFitsItemWidthsAndPaddingForNumberOfItemsMinusOne: true
    };

    self.$carousel.carousel(oOptions);
  };

  return CarouselController;
});


define('text!templates/views/carouselItemsView.html',[],function () { return '<div id="{{sViewId}}" class="{{sViewClass}} {{sClassNames}}">\r\n  <ul class="carousel-items-list">\r\n    {{#views.CarouselItemView}}\r\n      <li>{{{render}}}</li>\r\n    {{/views.CarouselItemView}}\r\n  </ul>\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/CarouselItemsView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','modules/pdp/views/CarouselItemView','modules/pdp/controllers/CarouselController','text!templates/views/carouselItemsView.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    CarouselItemView = require('modules/pdp/views/CarouselItemView'),
    CarouselController = require('modules/pdp/controllers/CarouselController'),
    template = require('text!templates/views/carouselItemsView.html');

  /**
   *
   * @param {config} config
   * @return {void}
   */
  function CarouselItemsView(config) {
    this.sViewName = 'CarouselItemsView';
    this.sNamespace = 'inherit';
    this.sTag = 'recommender';
    this.sViewClass = 'carousel-items';
    this.sTemplate = template;
    this.itemCounter = 1;
    this.parent.constructor.call(this, config);
  }

  fn.inherit(CarouselItemsView, BaseView);

  CarouselItemsView._name = 'CarouselItemsView';
  CarouselItemsView.sNamespace = 'inherit';
  CarouselItemsView.sTag = 'recommender';

  CarouselItemsView.prototype._setData = function (args) {
    this.parent._setData.call(this, args);
    delete this.oData.mvc.items;
  };

  CarouselItemsView.prototype._addSubViews = function () {
    var viewModel = this.oData.mvc.viewModel,
      carouselItemView = [];

    this.forLoop(viewModel, function (i) {
      carouselItemView.push(this._compileSubView({ _class: CarouselItemView, data: viewModel[i] }));
    });

    this.oData.views.CarouselItemView = carouselItemView;
  };

  CarouselItemsView.prototype._initDependancies = function () {
    var mvcData = this.oData.mvc,
      rootViewSelector = '',
      _this = this;

    if (mvcData.flags.carousel && fn.getValue(mvcData, 'info', 'rootViewId')) {
      rootViewSelector = '#' + mvcData.info.rootViewId;
      setTimeout(function () {
        _this.carousel = new CarouselController($(rootViewSelector));
      }, 10);
    }
  };

  module.exports = CarouselItemsView;
});


define('text!templates/views/linksave/carousel/index.html',[],function () { return '<div id="{{sViewId}}" class="block-wrapper with-indents">\r\n  <div class="carousel-fullwidth block">\r\n      <header class="cfw-header">\r\n          <h2 class="block-title cfw-title"><strong> Bundle Offer:</strong> <span>{{{props.title}}}</span> </h2>\r\n          <div class="product-carousel-nav-wrapper">\r\n            <ul class="product-carousel-nav {{props.customNavigationClass}}">\r\n                <li class="disabled">\r\n                    <a href="#" class="previous">\r\n                        <span class="label">Previous</span>\r\n                        <span aria-hidden="true" class="icon"></span>\r\n                    </a>\r\n                </li>\r\n                <li>\r\n                    <a href="#" class="next">\r\n                        <span class="label">Next</span>\r\n                        <span aria-hidden="true" class="icon"></span>\r\n                    </a>\r\n                </li>\r\n            </ul>\r\n          </div>\r\n      </header>\r\n    {{#views.carouselItems}}\r\n      {{{render}}}\r\n    {{/views.carouselItems}}\r\n    {{^state.displayBucketLink}}\r\n      <span class="bucket-link">\r\n        <a href="{{{props.bucketLink}}}">See all {{{props.bucketSkuCount}}} items in this offer </a>\r\n      </span>\r\n    {{/state.displayBucketLink}}\r\n  </div>\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/linksave/carousel/index',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','modules/pdp/views/CarouselItemsView','text!templates/views/linksave/carousel/index.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn');
  var BaseView = require('modules/pdp/views/BaseView');
  var CarouselItemsView = require('modules/pdp/views/CarouselItemsView');
  var template = require('text!templates/views/linksave/carousel/index.html');

  /**
   *
   * @constructor
   * @param {config} config
   * @return {void}
   */
  var LinksaveCarouselView = function LinksaveCarouselView(config) {
    this.sViewName = 'LinksaveCarouselView';
    this.sNamespace = 'promotions';
    this.sTag = 'linksave';
    this.sViewClass = 'linksave-carousel';
    this.sTemplate = template;

    this.views = { classes: {
      CarouselItemsView: CarouselItemsView
    } };

    this.parent.constructor.call(this, config);
  };

  fn.inherit(LinksaveCarouselView, BaseView);
  LinksaveCarouselView._name = 'LinksaveCarouselView';
  LinksaveCarouselView.sNamespace = 'promotions';
  LinksaveCarouselView.sTag = 'linksave';

  LinksaveCarouselView.prototype._setData = function () {
    this.oData.mvc.info = {
      rootViewId: this.sViewId
    };
  };
  /**
   *
   * @param {Object} data
   * @return {Object}
   */
  LinksaveCarouselView.prototype._setProps = function (data) {
    return {
      bucketLink: data.promotion.publicLink + '?bucketId=' + data.bucketGroup.id,
      title: data.promotion.displayName,
      customNavigationClass: data.viewModel.length > 3 ? 'narrowerNavigationButtons' : '',
      bucketSkuCount: data.viewModel.length
    };
  };

  /**
   *
   * @param {Object} data
   * @return {Object}
   */
  LinksaveCarouselView.prototype._setStates = function (data) {
    return {
      displayBucketLink: data.viewModel.length < 4
    };
  };

  /**
   *
   * @return {void}
   */
  LinksaveCarouselView.prototype._addSubViews = function () {
    var namespace = 'sku';

    this.oData.views.carouselItems = this._compileSubView({
      _class: this.views.classes.CarouselItemsView,
      namespace: namespace
    });
  };

  module.exports = LinksaveCarouselView;
});

define('modules/pdp/controllers/linksave/index',['require','exports','module','modules/mvc/fn','modules/pdp/controllers/BaseController','modules/pdp/controllers/utils/tile-data/index','modules/pdp/controllers/utils/filtering/index','modules/pdp/views/linksave/carousel/index'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn');
  var BaseController = require('modules/pdp/controllers/BaseController');
  var tileData = require('modules/pdp/controllers/utils/tile-data/index');
  var filtering = require('modules/pdp/controllers/utils/filtering/index');
  var LinksaveCarouselView = require('modules/pdp/views/linksave/carousel/index');

  /**
   *
   * @constructor
   * @param {Array<Object>} models
   * @return {void}
   */
  var LinksaveController = function LinksaveController(models) {
    this.sNamespace = 'promotions';
    this.sTag = 'linksave';
    this._cache = {};

    this.views = { classes: {
      LinksaveCarouselView: LinksaveCarouselView
    } };

    this.parent.constructor.call(this, models);
  };

  fn.inherit(LinksaveController, BaseController);

  LinksaveController.modelNames = [
    'bucketGroup',
    'formHandler',
    'inventoryProduct',
    'inventorySKU',
    'marketingSku',
    'products',
    'promotions',
    'sku',
    'categories'
  ];

    LinksaveController.prototype.checkBucketSeq = function (prevBucket,curBucket) {
  
    if (curBucket === 'bucketZ') {
        fn.setSessionData('promoID','');
        fn.setSessionData('prevbucketType','');
    }


    if (curBucket === 'bucketX' || (prevBucket === 'bucketX' && curBucket === 'bucketY') || (prevBucket === 'bucketY' && curBucket === 'bucketZ')){
      return true;
    }

    return false;
  }
  /**
   *
   * @private
   * @param {Object} args
   * @return {void}
   */
  LinksaveController.prototype._collateDataDependancies = function (args) {
    var deferred = args.deferred;
    var cacheEntry = this._getCacheEntry(args);

    if (cacheEntry) {
      if (cacheEntry.resolve) deferred.resolve(cacheEntry.data);
      if (cacheEntry.reject) deferred.reject();
      return;
    }

    var mvcData = args.mParamData.mvc;
    var info = mvcData.info;
    var promotion = info.promotion;
    var namespace = 'sku';
    var _this = this;
    var prevPromoID = fn.getSessionData('promoID');
    var prevBucketType = fn.getSessionData('prevbucketType');

    this._getPromotion(promotion.id, info.sku.id)
      .done(function (promoData, bucketType) {
        promotion.bucketType = promotion.bucketType || bucketType;

        if (window.location.href.indexOf('.promo') !== -1 || window.location.href.indexOf('promoId') !== -1 ) {

          fn.setSessionData('promoID',promotion.id);
          fn.setSessionData('prevbucketType',promotion.bucketType);

          if (!_this.checkBucketSeq(prevBucketType,promotion.bucketType)){
            _this._cacheAndReject(args, deferred);
                      return;
          }
        
        }
        else {
          fn.setSessionData('promoID','');
          fn.setSessionData('prevbucketType','');
        }

        if (_this._isLastBucket(promotion.bucketType, promoData.bucketCount)) {
          _this._cacheAndReject(args, deferred);
          return;
        }

        var nextBucketType = _this._getNextBucketType(promotion.bucketType);
        var promoModel = _this.models.promotions;
        var bucketLink = promoModel.getLinks({ value: nextBucketType, data: promoData });

        if (!fn.getValue(bucketLink[0], 'id')) {
          _this._cacheAndReject(args, deferred);
          return;
        }

        var bucketGroupModel = _this.models.bucketGroup;

        bucketGroupModel.getDataStores({ value: bucketLink[0].id, fetch: true })
          .done(function (bucketData) {
            var dataLinks = bucketGroupModel.getLinks({ value: 'contains', data: bucketData });
            bucketData.isLastBucket = _this._isLastBucket(nextBucketType);

            _this._getSkuLinks(dataLinks)
              .done(function (skuLinks) {
                if (!skuLinks.length) {
                  _this._cacheAndReject(args, deferred);
                  return;
                }

                var skuIDs = skuLinks.map(function (obj) {
                  return obj.id;
                });

                var skuModel = _this.models.sku;

                skuModel.getDataStores({ value: skuIDs, fetch: true })
                .done(function (skuData) {
                  if (!fn.isArray(skuData, { notEmpty: true })) {
                    _this._cacheAndReject(args, deferred);
                    return;
                  }

                  _this._filterItems(skuData, namespace, mvcData.filters)
                    .done(function (filteredData) {
                      if (!fn.isArray(filteredData, { notEmpty: true })) {
                        _this._cacheAndReject(args, deferred);
                        return;
                      }

                      var viewData = _this._collateViewData(
                        promoData, bucketData, filteredData, namespace,
                        mvcData.flags
                      );

                      _this._cacheAndResolve(args, viewData, deferred);
                    })
                    .fail(function () {
                      _this._cacheAndReject(args, deferred);
                    });
                })
                .fail(function () {
                  _this._cacheAndReject(args, deferred);
                });
              })
              .fail(function () {
                deferred.reject();
              });
          })
          .fail(function () {
            _this._cacheAndReject(args, deferred);
          });
      })
      .fail(function () {
        _this._cacheAndReject(args, deferred);
      });
  };

  /**
   *
   * @private
   * @param {Object} args
   * @param {JQueryDeferred} deferred
   * @return {void}
   */
  LinksaveController.prototype._cacheAndReject = function (args, deferred) {
    this._setCacheEntry(args, { reject: true });
    deferred.reject();
  };

  /**
   *
   * @private
   * @param {Object} args
   * @param {Object} data
   * @param {JQueryDeferred} deferred
   * @return {void}
   */
  LinksaveController.prototype._cacheAndResolve = function (args, data, deferred) {
    fn.mergeObjects(args.mParamData.mvc, data, { extend: true });
    this._setCacheEntry(args, { resolve: true });
    deferred.resolve(args);
  };

  /**
   *
   * @private
   * @param {Object} promoData
   * @param {Object} bucketData
   * @param {Array<Object>} filteredData
   * @param {string} namespace
   * @param {Object} flags
   * @param {string} nextBucketType
   * @return {Promise}
   */
  LinksaveController.prototype._collateViewData = function (
    promoData, bucketData, filteredData, namespace, flags) {
    var collatedData = tileData.collateData(filteredData, namespace, 'linksave', flags, this.models);

    return {
      bucketGroup: bucketData,
      products: {},
      promotion: promoData,
      sku: {},
      viewModel: collatedData
    };
  };

  /**
   *
   * @private
   * @param {any} data
   * @param {string} namespace
   * @param {Object} filters
   * @return {Promise}
   */
  LinksaveController.prototype._filterItems = function (data, namespace, filters) {
    return filtering.filterItems(data, namespace, filters, this.models);
  };

  /**
   *
   * @private
   * @param {Object} args
   * @return {Object}
   */
  LinksaveController.prototype._getCacheEntry = function (args) {
    return this._cache[fn.hashValue(args)] || null;
  };

  /**
 *
 * @private
 * @param {string} categoryIDs
 * @param {string} skuLinks
 * @return {JQueryPromise}
 */
  LinksaveController.prototype._getCategorySkuLinks = function (categoryIDs) {
    var deferred = $.Deferred();
    var _this = this;
    var categoryModel = this.models.categories;

    categoryModel.getDataStores({ value: categoryIDs, fetch: true })
      .done(function (categoryData) {
        if (!fn.isArray(categoryData, { notEmpty: true })) {
          deferred.reject();
          return;
        }

        var productLinks = categoryModel.getLinks({ value: 'contains', data: categoryData });

        var productIDs = productLinks.map(function (obj) {
          return obj.id;
        });

        _this._getProductSkuLinks(productIDs)
          .done(function (productData) {
            if (!fn.isArray(productData, { notEmpty: true })) {
              deferred.reject();
              return;
            }

            deferred.resolve(productData);
          })
          .fail(function () {
            deferred.reject();
          });
      })
      .fail(function () {
        deferred.reject();
      });

    return deferred.promise();
  };

  /**
   *
   * @private
   * @param {string} promoID
   * @param {string} skuID
   * @return {JQueryPromise}
   */
  LinksaveController.prototype._getMarketing = function (promoID, skuID) {
    var deferred = $.Deferred();

    if (promoID) {
      deferred.resolve(promoID);
      return deferred.promise();
    }

    var model = this.models.marketingSku;

    model.getDataStores({ value: skuID, fetch: true })
      .done(function (data) {
        if (!fn.isObject(data, { notEmpty: true })) {
          deferred.reject();
          return;
        }

        var promoItems = fn.getValue(data, '_links', 'promotions', 'items');

        if (!promoItems || !promoItems.length) {
          deferred.reject();
          return;
        }

        var linkSaveItems = promoItems.filter(function (obj) {
          return obj.kind === 'linkSave';
        });

        if (!linkSaveItems.length) {
          deferred.reject();
          return;
        }

        var _promoID = fn.getURLQueryString('promoid');

        var linkSaveItem = null;

        if (_promoID) {
          fn.loopArray(linkSaveItems, function loopItems(i) {
            if (fn.isObject(linkSaveItems[i], { notEmpty: true })) {
              if (_promoID === linkSaveItems[i].id) {
                linkSaveItem = linkSaveItems[i];
              }
            }
          });

          if (linkSaveItem) {
            deferred.resolve(linkSaveItem.id, linkSaveItem.bucketType);
            return;
          }
        }

        if (!fn.getValue(linkSaveItems[0], 'id')) {
          deferred.reject();
          return;
        }

        deferred.resolve(linkSaveItems[0].id, linkSaveItems[0].bucketType);
      })
      .fail(function () {
        deferred.reject();
      });

    return deferred.promise();
  };

  /**
 *
 * @private
 * @param {string} currentBucketType
 * @return {string}
 */
  LinksaveController.prototype._getNextBucketType = function (currentBucketType) {
    if (currentBucketType === 'bucketX') return 'bucketY';
    return 'bucketZ';
  };

  /**
   *
   * @private
   * @param {string} productIDs
   * @param {string} skuLinks
   * @return {JQueryPromise}
   */
  LinksaveController.prototype._getProductSkuLinks = function (productIDs) {
    var deferred = $.Deferred();
    var productModel = this.models.products;

    productModel.getDataStores({ value: productIDs, fetch: true })
      .done(function (data) {
        if (!fn.isArray(data, { notEmpty: true })) {
          deferred.reject();
          return;
        }

        var skuLinks = productModel.getLinks({ value: 'childSku', data: data });
        deferred.resolve(skuLinks);
      })
      .fail(function () {
        deferred.reject();
      });

    return deferred.promise();
  };

  /**
   *
   * @private
   * @param {string} promoID
   * @param {string} skuID
   * @return {JQueryPromise}
   */
  LinksaveController.prototype._getPromotion = function (promoID, skuID) {
    var deferred = $.Deferred();
    var _this = this;

    this._getMarketing(promoID, skuID)
      .done(function (_promoID, bucketType) {
        var model = _this.models.promotions;

        model.getDataStores({ value: _promoID, forceFetch: true })
          .done(function (data) {
            if (!fn.isObject(data, { notEmpty: true })) {
              deferred.reject();
              return;
            }

            deferred.resolve(data, bucketType);
          })
          .fail(function () {
            deferred.reject();
          });
      })
      .fail(function () {
        deferred.reject();
      });

    return deferred.promise();
  };

  /**
   *
   * @private
   * @param {string} dataLinks
   * @param {string} skuID
   * @return {JQueryPromise}
   */
  LinksaveController.prototype._getSkuLinks = function (dataLinks) {
    /* This method is currently based on the assumption that bucket contains either sku,product
     or category ,need to refractor this method if bucket contains a combination  sku,product
     and category in future */
    var deferred = $.Deferred();

    if (fn.isArray(dataLinks, { notEmpty: true })) {
      var dataLinkType = fn.getValue(dataLinks[0], 'type');

      if (dataLinkType === 'sku') {
        deferred.resolve(dataLinks);
        return deferred.promise();
      }

      var dataLinkIDs = dataLinks.map(function (obj) {
        return obj.id;
      });

      var skuLinkPromise = dataLinkType === 'product' ? this._getProductSkuLinks(dataLinkIDs)
       : this._getCategorySkuLinks(dataLinkIDs);

      skuLinkPromise
        .done(function (data) {
          deferred.resolve(data);
        })
        .fail(function () {
          deferred.reject();
        });
    } else {
      deferred.reject();
    }

    return deferred.promise();
  };

  /**
   *
   * @private
   * @param {string} bucketName
   * @param {string} count
   * @return {boolean}
   */
  LinksaveController.prototype._isLastBucket = function (bucketName, count) {
    return (count === 2 && bucketName === 'bucketY') || (count === 3 && bucketName === 'bucketZ');
  };

  /**
   *
   * @private
   * @param {Object} args
   * @param {Object} data
   * @return {void}
   */
  LinksaveController.prototype._setCacheEntry = function (args, data) {
    this._cache[fn.hashValue(args)] = data;
  };

  module.exports = LinksaveController;
});

define('modules/pdp/data-stores/marketing/sku/index',['require','exports','module'],function (require, exports, module) {
  'use strict';

  /**
   *
   * @param {Object} data
   * @return {void}
   */
  module.exports = function MarketingSku(data) {
    this.id = data.id || null;
    this.pings = data.pings || null;
    this.promotions = data.promotions || null;
    this._links = data._links || null;
  };
});

define('modules/pdp/models/marketing/sku/index',['require','exports','module','modules/mvc/fn','modules/pdp/data-stores/marketing/sku/index','modules/pdp/models/BaseModel'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn');
  var MarketingSku = require('modules/pdp/data-stores/marketing/sku/index');
  var BaseModel = require('modules/pdp/models/BaseModel');

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  var MarketingSkuModel = function MarketingSkuModel(config) {
    this.DataStoreClass = MarketingSku;
    this.sNamespace = 'marketingSku';
    this.parent.constructor.call(this, config);
  };

  fn.inherit(MarketingSkuModel, BaseModel);

  MarketingSkuModel.prototype.dataHandler = function (res) {
    if (!fn.isObject(res, { notEmpty: true })) return;
    this.add(res);
  };

  module.exports = MarketingSkuModel;
});

define('modules/pdp/controllers/PanelController', [
  'domlib',
  'modules/mvc/fn',
  'modules/breakpoint',
  'modules/pdp/controllers/BaseController'
], function ($, fn, breakpoint, BaseController) {
  'use strict';

  /**
   *
   * @return {void}
   */
  function PanelController() {
    this.sNamespace = 'panel';
    this.sTag = '_default';
    this.isPanelOpen = false;
    this.isPanelOpening = false;
    this.panelGroups = {};
    this.oOpenPanels = {};
    this.parent.constructor.call(this);
  }

  fn.inherit(PanelController, BaseController);

  /**
   * Method binds all events related to panels opening and closing.
   * @return {void}
   */
  PanelController.prototype._bindEvents = function () {
    $(window)
      .on('panelOpen', this._onPanelOpen.bind(this))
      .on('panelClosed', this._onPanelClosed.bind(this))
      .on('closeOpenPanels', this._onCloseOpenPanels.bind(this))
      .on('getPanelGroup', this._onGetPanelGroup.bind(this))
      .on('destroyPanelGroup', this._onDestroyPanelGroup.bind(this))
      .on('breakpointChange.panelController', this._onBreakpointChange.bind(this)
    );
  };

  /**
   * Stores a reference to the open panel, fires an event if it's the first panel in the group
   * to open, and runs some post open methods.
   * @param {Object} oEvent The event object that includes the panel that has opened.
   * @return {void}
   */
  PanelController.prototype._onPanelOpen = function (oEvent) {
    var openPanel = this.oOpenPanels[oEvent.oData.sTag],
      openingPanel = oEvent.oData.oView,
      findChildPanel = function (childPanels, panel) {
        return this.forLoop(childPanels, function (i) {
          if (childPanels[i].id === panel.id) {
            return true;
          }
          return undefined;
        }) || false;
      };

    this.isPanelOpening = true;

    /**
     * Checks if a panel from the same group is already open, and if it is, and it does not have
     * the same id as the panel that is opening, closes the open panel.
     */
    if (openPanel) {
      if (openPanel.id !== openingPanel.id) {
        if (!openPanel.childPanels.length
            || (openPanel.childPanels.length
                && !findChildPanel.call(this, openPanel.childPanels, openingPanel))) {
          openPanel.close();
        }
      }
    } else {
      // Fires event to say a panel group is open.
      this.setEvent({
        sName: 'panelGroupOpen',
        sTag: oEvent.oData.sTag,
        oView: openingPanel,
        oClickEvent: oEvent.oData.oClickEvent
      }, false, true);

      this.panelsOpenHook(oEvent);
    }

    this.isPanelOpen = true;

    // Adds the open panel to the openPanels object.
    this.oOpenPanels[oEvent.oData.sTag] = openingPanel;

    this.isPanelOpening = false;
  };

  /**
   * Stores a reference to the closed panel, fires an event if it's the last panel in the group
   * to close, and runs some post close methods.
   * @param {Object} oEvent The event object that includes the panel that has opened.
   * @return {void}
   */
  PanelController.prototype._onPanelClosed = function (oEvent) {
    var isOpen = false;

    if (!this.isPanelOpening) {
      if (this.oOpenPanels[oEvent.oData.sTag].parentPanel) {
        this.oOpenPanels[oEvent.oData.sTag] = this.oOpenPanels[oEvent.oData.sTag].parentPanel;
      } else {
        this.oOpenPanels[oEvent.oData.sTag] = null;
      }

      /**
       * Check to see if any other panel groups are open as this will impact the behaviour of
       * some elements on the page such as the masthead and body scroll.
       */
      this.forInLoop(this.oOpenPanels, function (sProp) {
        if (this.oOpenPanels[sProp] !== null) {
          isOpen = true;
        }
      });

      this.isPanelOpen = isOpen;

      if (!this.oOpenPanels[oEvent.oData.sTag]) {
        // Fires event to say a panel group is closed.
        this.setEvent({
          sName: 'panelGroupClosed',
          sTag: oEvent.oData.sTag,
          oView: oEvent.oData.oView,
          oClickEvent: oEvent.oData.oClickEvent
        }, false, true);

        this.panelsClosedHook(oEvent);
      }
    }
  };

  /**
   * Runs some post panel open methods.
   * @param {Object} oEvent The event object that includes the panel that has opened.
   * @return {void}
   */
  PanelController.prototype.panelsOpenHook = function (oEvent) {
    var oView = oEvent.oData.oView;

    /**
     * On desktop and largeDesktop, we need to disable the document scroll if the class of
     * fullScreen is found.
     */
    if (breakpoint.desktop || breakpoint.largeDesktop) {
      if (this.isArray(oView.oStyles[breakpoint.currentViewport], true)
          && oView.oStyles[breakpoint.currentViewport].indexOf('fullScreen') !== -1
          && !this._isOpenPanelStyle('fullScreen', breakpoint.currentViewport)) {
        $(window).trigger('documentScrollDisable');
      }
      /**
       * On lower viewports, when we usually use a sliding panel, we also need to slide the
       * masthead up out of view.
       */
    } else if (this.isArray(oView.oStyles[breakpoint.currentViewport], true)
        && oView.oStyles[breakpoint.currentViewport].indexOf('fullScreen') !== -1
        && !this._isOpenPanelStyle('fullScreen', breakpoint.currentViewport)) {
      $(window)
        .trigger('mastheadSlideUp')
        .trigger('documentScrollDisable');
    }
  };

  /**
   * Runs some post panel close methods.
   * @param {Object} oEvent The event object that includes the panel that has closed.
   * @return {void}
   */
  PanelController.prototype.panelsClosedHook = function (oEvent) {
    var oView = oEvent.oData.oView;

    /**
     * On desktop and largeDesktop, we need to enable the document scroll if the class of
     * fullScreen is found.
     */
    if (breakpoint.desktop || breakpoint.largeDesktop) {
      if (this.isArray(oView.oStyles[breakpoint.currentViewport], true)
          && oView.oStyles[breakpoint.currentViewport].indexOf('fullScreen') !== -1) {
        if (!this._isOpenPanelStyle('fullScreen', breakpoint.currentViewport)) {
          $(window).trigger('documentScrollEnable');
        }
      }
      /**
       * On lower viewports, when we usually use a sliding panel, we also need to slide the
       * masthead down into view.
       */
    } else if (this.isArray(oView.oStyles[breakpoint.currentViewport], true)
        && oView.oStyles[breakpoint.currentViewport].indexOf('fullScreen') !== -1) {
      if (!this._isOpenPanelStyle('fullScreen', breakpoint.currentViewport)) {
        $(window)
          .trigger('documentScrollEnable')
          .trigger('mastheadSlideDown');
      }
    }
  };

  /**
   * Method runs when a module triggers the closeOpenPanels event with the tag of a panel.
   * @param {Object} oEvent The event object that includes the tag of the panel to close.
   * @return {void}
   */
  PanelController.prototype._onCloseOpenPanels = function (oEvent) {
    if (this.oOpenPanels[oEvent.oData.sTag]) {
      if (oEvent.oData.parentClose && this.oOpenPanels[oEvent.oData.sTag].parentPanel !== null) {
        this.oOpenPanels[oEvent.oData.sTag].parentPanel.close();
      } else {
        this.oOpenPanels[oEvent.oData.sTag].close();
      }
    }
  };

  /**
   * On breakpointChange there are methods that may need to run based on the classes on an open
   * panel.
   * @param {Object} oEvent The breakpointChange event object.
   * @return {Object} The event object.
   */
  PanelController.prototype._onBreakpointChange = function (oEvent) {
    // If moving between two desktop viewports no changes required.
    if ((oEvent.newViewport === 'largedesktop' || oEvent.newViewport === 'desktop')
        && (oEvent.oldViewport === 'largedesktop' || oEvent.oldViewport === 'desktop')) {
      return false;
    }

    // If moving between two device viewports no changes required.
    if ((oEvent.newViewport === 'mobile' || oEvent.newViewport === 'vtablet'
        || oEvent.newViewport === 'htablet') && (oEvent.oldViewport === 'mobile'
        || oEvent.oldViewport === 'vtablet' || oEvent.oldViewport === 'htablet')) {
      return false;
    }

    /**
     * If new viewport is desktop (old device) and a panel is open and has fullScreen as a class
     * in the old viewport, then slide down masthead, but only enable document scroll if the new
     * viewport does not have fullScreen has a class.
     */
    if (oEvent.newViewport === 'largedesktop' || oEvent.newViewport === 'desktop') {
      if (this.isPanelOpen && this._isOpenPanelStyle('fullScreen', oEvent.oldViewport)) {
        if (this._isOpenPanelStyle('fullScreen', oEvent.newViewport)) {
          $(window).trigger('mastheadSlideDown');
        } else {
          $(window).trigger('mastheadSlideDown')
            .trigger('documentScrollEnable');
        }
      } else if (this._isOpenPanelStyle('fullScreen', oEvent.newViewport)) {
        $(window).trigger('documentScrollDisable');
      }
      /**
       * If the new viewport is device (old desktop) and a panel is open and has fullScreen as a
       * class in the old viewport, then slide up the masthead if the new viewport has
       * fullScreen as a class, and only enable document scroll is the new viewport does not have
       * fullscreen as a class.
       */
    } else if (oEvent.newViewport === 'mobile' || oEvent.newViewport === 'vtablet'
        || oEvent.newViewport === 'htablet') {
      if (this.isPanelOpen && this._isOpenPanelStyle('fullScreen', oEvent.oldViewport)) {
        if (this._isOpenPanelStyle('fullScreen', oEvent.newViewport)) {
          $(window).trigger('mastheadSlideUp');
        } else {
          $(window).trigger('documentScrollEnable');
        }
      } else if (this._isOpenPanelStyle('fullScreen', oEvent.newViewport)) {
        $(window)
          .trigger('mastheadSlideUp')
          .trigger('documentScrollDisable');
      }
    }

    return oEvent;
  };

  /**
   * Iterates through every open panel and checks each for a class name on a specified viewport.
   * @param {String} sSearchValue The class name to search for.
   * @param {String} sViewport The viewport to search within.
   * @return {Boolean} Whether search value is present.
   */
  PanelController.prototype._isOpenPanelStyle = function (sSearchValue, sViewport) {
    var bOutput = false;

    this.forInLoop(this.oOpenPanels, function (sProp) {
      if (this.isObject(this.oOpenPanels[sProp])) {
        if (this.oOpenPanels[sProp]._hasStyle(sSearchValue, sViewport)) {
          bOutput = true;
        }
      }
    });

    return bOutput;
  };

  PanelController.prototype.postRenderHook = function (oData) {
    this.parent.postRenderHook.call(this, oData);
    if (oData.oView.sPanelType === 'group') {
      this._storePanelGroup(oData.oView);
    }
  };

  /**
   * Stores a reference to every panel group for future use.
   * @param {Object} oView The panel group object.
   * @return {void}
   */
  PanelController.prototype._storePanelGroup = function (oView) {
    this.panelGroups[oView.sTag] = oView;
  };

  /**
   * Gets a panel group from the panelGroups property based on the group's tag property.
   * If the event object includes a callback property, then the method will execute the
   * callback and pass the panel group into it.
   * @param {Object} oEvent The jQuery event object.
   * @return {Object} The requested panel group.
   */
  PanelController.prototype._onGetPanelGroup = function (oEvent) {
    var panelGroup = this.panelGroups[oEvent.oData.tag];

    if (oEvent.oData.callback) {
      oEvent.oData.callback(panelGroup);
    }

    return panelGroup;
  };

  /**
   * Destroys any reference to the panel group when the destroyPanelGroup event fires.
   * @param {Object} oEvent The jQuery event object.
   * @return {void}
   */
  PanelController.prototype._onDestroyPanelGroup = function (oEvent) {
    if (this.panelGroups[oEvent.oData.tag]) {
      this.panelGroups[oEvent.oData.tag] = null;
    }
  };

  return PanelController;
});

define('modules/pdp/controllers/PersonaliseController', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/controllers/BaseController',
  'modules/pdp/views/PersonaliseView'
], function ($, fn, BaseController, PersonaliseView) {
  'use strict';

  /**
   *
   * @param {Object} model The form handler model.
   * @return {void}
   */
  function PersonaliseController(model) {
    this.sNamespace = 'sku';
    this.sTag = 'personalise';
    this.views = {
      classes: {
        PersonaliseView: PersonaliseView
      }
    };
    this.parent.constructor.call(this, model);
    this.dataCache = {};
  }

  fn.inherit(PersonaliseController, BaseController);

  PersonaliseController.prototype._bindEvents = function () {
    var _this = this;

    $(window).on('resetPersonalisation', function handlePersonalisationReset(event) {
      var skuId = event.oData.skuId;

      _this._getStoredView('PersonaliseView', function (view) {
        var skuData = view.oData.mvc.sku;

        if (_this.sanityCheckData(skuData).objects) {
          if (skuData.id === skuId) {
            _this._resetPersonalisation({ view: view });
          }
        }
      });
    });
  };

  PersonaliseController.prototype.postRenderHook = function (args) {
    var data = args.oView.oData.mvc;

    if ($('.main-content-wrapper').hasClass('media-viewer--portrait')) {
      data.flags.isPortrait = true;
    }

    this.parent.postRenderHook.call(this, args);
  };

  PersonaliseController.prototype._bindViewEvents = function (args) {
    var _this = this,
      PERSONALISE_BTN = '.personalise-button',
      PERSONALISE_LINK = '.edit-personalise-link',
      elements = args.oView.oElms;

    if (elements.personaliseBtn) {
      $(elements.elWrapper).on(
        'click', PERSONALISE_BTN, { view: args.oView }, this._handlePersonalise.bind(this)
      );
    }

    if (elements.editLink) {
      $(elements.elWrapper).on(
        'click', PERSONALISE_LINK, { view: args.oView }, this._handleEdit.bind(this)
      );
    }

    if (!this.getTargetEvents(window, 'panelClosed', 'deletePreviewGuid')) {
      $(window).on('panelClosed.deletePreviewGuid', function deletePreviewGuid(event) {
        if (event.oData.sTag === 'personalise') {
          $.fn.EmaginationJS('Reset', { bPreventInitialisation: true, keepCookie: false });

          if (_this.isObject(_this._activePanel.personalisePreview, true)) {
            _this._activePanel.personalisePreview.destroy(event, { destroyGroup: true });
          }
        }
      });
    }
  };

  PersonaliseController.prototype._handlePersonalise = function (event) {
    var dc = this.dataCache = {},
      skuId = event.data.view.oData.mvc.sku.id;

    $(event.currentTarget).addClass('submitting');

    dc.isEditMode = false;
    this._activeView = event.data.view;
    dc.personalisation = event.data.view.oData.mvc.sku.personalisation;

    this._renderPersonaliseOverlay({
      skuId: skuId,
      view: event.data.view
    });

    $(event.currentTarget).removeClass('submitting');
  };

  PersonaliseController.prototype._handleEdit = function (event) {
    var _this = this,
      dc = this.dataCache,
      guid = '',
      skuId = event.data.view.oData.mvc.sku.id,
      customData = event.customData || {};

    dc.isEditMode = true;
    this._activeView = event.data.view;
    guid = dc.personalisation.guid;

    if (typeof guid !== 'string') {
      this.renderNotification();
    }

    $(event.currentTarget).addClass('loading');

    $.fn.EmaginationJS('ClonePreview', guid, skuId, function handleClone(data) {
      _this._renderPersonaliseOverlay({
        guid: typeof data.guid === 'string' ? data.guid : guid,
        skuId: skuId,
        view: event.data.view,
        currentTarget: event.currentTarget,
        overlayRenderedCallback: customData.overlayRenderedCallback
      });
    });
  };

  PersonaliseController.prototype._renderPersonaliseOverlay = function (args) {
    var _this = this,
      dc = this.dataCache;

    this.renderOverlay({
      sTag: 'personalise',
      sClassNames: 'personalise-overlay',
      oStyles: {
        allDesktops: ['lightbox', 'fullScreen'],
        allDevices: ['slideIn-left', 'fullScreen']
      },
      sTitle: 'Personalise',
      sOverlayContent: '<div class="emagination-wrapper"></div>',
      toDestroyOnClose: true,
      callback: function overlayRenderedCallback() {
        var EMAGINATION_SELECTOR = '.emagination-wrapper';

        if (typeof args.overlayRenderedCallback === 'function') {
          args.overlayRenderedCallback();
        }

        if (dc.isEditMode) {
          $(args.currentTarget).removeClass('loading');
        }

        $(EMAGINATION_SELECTOR).EmaginationJS({
          APIUrl: dc.personalisation.APIUrl,
          AuthCode: dc.personalisation.authCode,
          PreviewGuid: args.guid,
          ImageQuality: 75,
          ImageFormat: 'JPEG',
          ProductName: args.skuId,
          onReady: function (opts) {
            dc = _this.dataCache;
            dc.guid = $(opts.elements.PreviewGuidInput).val();
            dc.emagination = opts;
            dc.layerUpdated = true;

            if (dc.isEditMode) {
              $(dc.emagination.elements.ResetButton).removeClass('disabled');
            }

            $(dc.emagination.elements.PreviewButton)
              .off()
              .on('click.personalisationPreview', _this._handleImagePreview.bind(_this));

            $(dc.emagination.elements.ResetButton)
              .off()
              .on(
                'click.personalisationReset', { view: args.view },
                _this._handlePersonalisationReset.bind(_this)
              );

            $(dc.emagination.elements.SaveButton).on(
              'click.personalisationSave', { view: args.view },
              _this._handlePersonalisationSave.bind(_this)
            );
          },
          onLayerUpdating: function () {
            $.fn.EmaginationJS('setState', { updating: true });
            $(dc.emagination.elements.PreviewButton).addClass('disabled');
            $(dc.emagination.elements.ControlsBackButton).addClass('disabled');
          },
          onLayerUpdated: function (opts) {
            $.fn.EmaginationJS('setState', { updating: false });
            $(dc.emagination.elements.PreviewButton).removeClass('disabled');
            $(dc.emagination.elements.ControlsBackButton).removeClass('disabled');
            dc.emagination = opts;
            dc.layerUpdated = true;

            if (dc.isEditMode) {
              $(dc.emagination.elements.SaveButton).removeAttr('disabled');
            }
          },
          onTextLayersUpdated: function (opts) {
            dc.emagination = opts;
            $(dc.emagination.elements.SaveButton).removeAttr('disabled');
          },
          onError: function () {
            _this.renderNotification({ callback: function errorCallback() {
              $.fn.EmaginationJS('Reset', { bPreventInitialisation: true, keepCookie: false });
            } });
          },
          onFatalError: function () {
            _this.renderNotification({ callback: function errorCallback() {
              $.fn.EmaginationJS('Reset', { bPreventInitialisation: true, keepCookie: false });
            } });
          },
          onDropZone: function (opts) {
            dc.emagination = opts;

            return {
              scope: _this,
              render: function renderCallback(content) {
                this.renderOverlay({
                  sTag: 'personaliseCropper',
                  sClassNames: 'personalise-cropper-overlay',
                  oStyles: {
                    allDesktops: ['fullBleed', 'fullScreen'],
                    allDevices: ['fullBleed', 'fullScreen']
                  },
                  sOverlayContent: '<div class="emagination-cropper-wrapper"></div>',
                  toDestroyOnClose: true,
                  callback: function cropperOverlayRenderedCallback() {
                    var CONTENT_DIV = '.personalise-cropper-overlay .info-panel-content',
                      LOADER_CLASS = 'with-loader';

                    $(CONTENT_DIV).addClass(LOADER_CLASS);
                    $('.emagination-cropper-wrapper').html(content);
                    $('.EmaginationJS-PhotoCrop').one('load', function hidePreviewLoader() {
                      $(CONTENT_DIV).removeClass(LOADER_CLASS);
                    });
                    $('.personalise-cropper-overlay .info-panel-close-icon').on(
                      'click',
                      function handleCloseIconClick() {
                        $(dc.emagination.elements.Dropzone).removeAttr('disabled');
                      }
                    );
                  }
                });
              },
              close: function closeCallback() {
                this._activePanel.personaliseCropper.close();
              }
            };
          }
        });
      }
    });
  };

  PersonaliseController.prototype._handleImagePreview = function (event) {
    var _this = this,
      dc = this.dataCache,
      CONTENT_DIV = '.personalise-preview-overlay .info-panel-content',
      PREVIEW_IMG = '.emagination-preview',
      LOADER_CLASS = 'with-loader';

    /**
     * Adds loader to content div and bind remove event to image.
     * @return {void}
     */
    function addRemoveLoader() {
      $(CONTENT_DIV).addClass(LOADER_CLASS);
      $(PREVIEW_IMG).one('load', function hidePreviewLoader() {
        $(CONTENT_DIV).removeClass(LOADER_CLASS);
      });
    }

    if ((!dc.layerUpdated || event.currentTarget) && $(event.currentTarget).hasClass('disabled')) {
      return;
    }

    if (this.isObject(this._activePanel.personalisePreview, true)) {
      this._activePanel.personalisePreview.removeContent();
    }

    this._getPreviewImages({
      endpoint: 'GetPreviewImage',
      templatename: dc.emagination.elements.Canvases.filter(':visible').attr('data-set-name'),
      callback: function handleGetPreviewImage(data) {
        dc.layerUpdated = false;

        if (!data.objResult) {
          return;
        }

        _this.renderOverlay({
          sTag: 'personalisePreview',
          sClassNames: 'personalise-preview-overlay',
          oStyles: {
            allDesktops: ['fullBleed', 'fullScreen'],
            allDevices: ['fullBleed', 'fullScreen']
          },
          elTrigger: dc.emagination.elements.PreviewButton,
          sOverlayContent: '<div class="emagination-preview-wrapper">'
              + '<img class="emagination-preview" src="' + data.objResult + '"></div>',
          updateActive: true,
          callback: function overlayRenderedCallback() {
            addRemoveLoader();
          }
        });
      }
    });
  };

  PersonaliseController.prototype._getPreviewImages = function (opts) {
    var _opts = opts || {},
      dc = this.dataCache;

    $.ajax({
      url: dc.personalisation.APIUrl + '/' + _opts.endpoint,
      method: 'POST',
      dataType: 'jsonp',
      data: {
        authcode: dc.personalisation.authCode,
        guid: dc.guid,
        templatename: _opts.templatename,
        imagewidth: _opts.imagewidth || window.currentDocumentWidth,
        previewwatermark: dc.emagination.settings.UseWatermark,
        imagequality: dc.emagination.settings.ImageQuality,
        imagetype: dc.emagination.settings.ImageFormat,
        aspect: _opts.aspect
      }
    }).done(_opts.callback);
  };

  PersonaliseController.prototype._handlePersonalisationSave = function (event) {
    var _this = this,
      dc = this.dataCache,
      viewData = event.data.view.oData.mvc,
      skuId = viewData.sku.id,
      isPortrait = viewData.flags.isPortrait,
      formHandlerId = viewData.sellers.formHandler;

    $(event.currentTarget).addClass('submitting');

    this._getPreviewImages({
      endpoint: 'GetPreviewImages',
      imagewidth: '120',
      aspect: isPortrait ? '3:4' : '4:3',
      callback: function handleGetImages(data) {
        var url = '';

        if (!data.objResult || !_this.isArray(data.objResult, true)) {
          return;
        }

        url = data.objResult[0];
        dc.personalisation.imageURL = url.replace(/(width%3d)(\d{3})/, '$1{width}');
        dc.personalisation.guid = dc.guid;
        dc.personalisation.isPersonalised = true;
        dc.isPortrait = isPortrait;

        _this._addMediaViewerImage();

        _this.oModel.update({
          mSearchValue: skuId,
          sUpdateKey: 'personalisation',
          mUpdateValue: dc.personalisation
        });

        _this.queryModel({
          sNamespace: 'formHandler'
        }).done(function handleQueryModel(model) {
          var refreshPoints = [],
            refreshView = '';

          if (!model) {
            return;
          }

          refreshPoints = event.data.view.oData.mvc.refreshPoints;

          model.update({
            mSearchValue: formHandlerId,
            sUpdateKey: 'oData',
            mUpdateValue: null,
            sUpdatePropKey: 'personalisedGUID',
            mUpdatePropValue: dc.personalisation.guid
          });

          model.update({
            mSearchValue: formHandlerId,
            sUpdateKey: 'oData',
            mUpdateValue: null,
            sUpdatePropKey: 'personalisedImageURL',
            mUpdatePropValue: dc.personalisation.imageURL.replace(
              '{width}', isPortrait ? '90' : '120'
            )
          });

          _this.forLoop(refreshPoints, function loopRefreshPoints(i) {
            if (refreshPoints[i].viewName === 'ItemActionsView') {
              refreshView = refreshPoints[i];
              return true;
            }
            return undefined;
          });

          _this.setEvent({
            sName: 'refresh',
            sNamespace: refreshView.namespace,
            sTag: refreshView.tag,
            sViewName: refreshView.viewName,
            getView: function getView(view) {
              if (view.sViewId === refreshView.viewId) {
                return true;
              }
              return false;
            },
            mParamData: {
              mvc: { sku: _this.oModel.get({ mSearchValue: skuId }) }
            }
          }, false, true);

          _this._activePanel.personalise.close();

          $(event.currentTarget).removeClass('submitting');
        });
      }
    });
  };

  PersonaliseController.prototype._addMediaViewerImage = function () {
    var _this = this,
      dc = this.dataCache,
      updateEvent = new $.Event('MediaViewer.update'),
      guid = dc.personalisation.guid,
      mainImage = dc.personalisation.imageURL.replace('{width}', dc.isPortrait ? '750' : '1000'),
      thumbImage = dc.personalisation.imageURL.replace('{width}', dc.isPortrait ? '90' : '120');

    if (dc.isEditMode) {
      if (dc.$mainAddedItem && dc.$mainAddedItem.length > 0) {
        dc.$mainAddedItem.find('img').attr('src', mainImage);
      }

      if (dc.$thumbAddedItem && dc.$thumbAddedItem.length > 0) {
        dc.$thumbAddedItem.find('img').attr('src', thumbImage);
      }

      return;
    }

    updateEvent.customData = {
      type: 'add',
      mediaType: 'static',
      isType: { key: 'isStatic', value: true },
      position: 'append',
      items: {
        main: '<li class="static-img"><img src="' + mainImage + '" data-guid="' + guid + '"></li>',
        thumb: '<li class="static-img"><span class="mv-thumbnail"><img src="'
            + thumbImage + '" data-guid="' + guid + '"></li>'
      },
      images: { main: mainImage, thumb: thumbImage },
      classNames: 'static-img',
      callbacks: {
        main: function mainAddMediaCallback($addedItem) {
          dc.$mainAddedItem = $addedItem;

          $($addedItem).on('click', { view: _this._activeView }, function (event) {
            var _event = event;

            _event.customData = {
              overlayRenderedCallback: function () {
                $(_event.currentTarget).removeClass('with-bkg-loader');
              }
            };

            $(_event.currentTarget).addClass('with-bkg-loader');
            _this._handleEdit(_event);
          });
        },
        thumb: function thumbAddMediaCallback($addedItem) {
          dc.$thumbAddedItem = $addedItem;
        }
      }
    };

    $(window).trigger(updateEvent);
  };

  PersonaliseController.prototype._handlePersonalisationReset = function (event) {
    $.fn.EmaginationJS('Reset');
    this._resetPersonalisation({ view: event.data.view });
  };

  PersonaliseController.prototype._resetPersonalisation = function (args) {
    var _this = this,
      dc = {},
      skuId = args.view.oData.mvc.sku.id,
      personalisation = args.view.oData.mvc.sku.personalisation,
      formHandlerId = args.view.oData.mvc.sellers.formHandler;

    this._removeMediaViewerImage();

    dc = this.dataCache = {
      personalisation: {
        APIUrl: personalisation.APIUrl,
        authCode: personalisation.authCode,
        imageURL: null,
        guid: null,
        isPersonalised: false
      },
      isEditMode: false
    };

    this.oModel.update({
      mSearchValue: skuId,
      sUpdateKey: 'personalisation',
      mUpdateValue: dc.personalisation
    });

    this.queryModel({
      sNamespace: 'formHandler'
    }).done(function handleQueryModel(model) {
      var refreshPoints = [],
        refreshView = '';

      if (!model) {
        return;
      }

      refreshPoints = args.view.oData.mvc.refreshPoints;

      model.update({
        mSearchValue: formHandlerId,
        sUpdateKey: 'oData',
        mUpdateValue: null,
        sUpdatePropKey: 'personalisedGUID',
        mUpdatePropValue: ''
      });

      model.update({
        mSearchValue: formHandlerId,
        sUpdateKey: 'oData',
        mUpdateValue: null,
        sUpdatePropKey: 'personalisedImageURL',
        mUpdatePropValue: ''
      });

      _this.forLoop(refreshPoints, function loopRefreshPoints(i) {
        if (refreshPoints[i].viewName === 'ItemActionsView') {
          refreshView = refreshPoints[i];
          return true;
        }
        return undefined;
      });

      _this.setEvent({
        sName: 'refresh',
        sNamespace: refreshView.namespace,
        sViewName: refreshView.viewName,
        sTag: refreshView.tag,
        getView: function getView(view) {
          if (view.sViewId === refreshView.viewId) {
            return true;
          }
          return false;
        },
        mParamData: {
          mvc: { sku: _this.oModel.get({ mSearchValue: skuId }) }
        }
      }, false, true);
    });
  };

  PersonaliseController.prototype._removeMediaViewerImage = function () {
    var _this = this,
      dc = this.dataCache,
      updateEvent = new $.Event('MediaViewer.update'),
      timestamp = 0;

    if (!dc.hasOwnProperty('$mainAddedItem') && !dc.hasOwnProperty('$thumbAddedItem')) {
      return;
    }

    timestamp = dc.$mainAddedItem.data('timestamp');

    updateEvent.customData = {
      type: 'remove',
      position: function positionCallback($itemList) {
        var $items = $itemList.children();

        return _this.forLoop($items, function loopItemList(i) {
          if ($($items[i]).data('timestamp') === timestamp) {
            return $items[i];
          }
          return undefined;
        });
      },
      mediaAsset: function removeMediaAsset(mediaAssets) {
        _this.forLoop(mediaAssets, function loopMediaAssets(i) {
          if (mediaAssets[i].timestamp === timestamp) {
            mediaAssets.splice(i, 1);
          }
        });
      }
    };

    $(window).trigger(updateEvent);
  };

  return PersonaliseController;
});

define('modules/pdp/views/PriceCheckView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/show-more/ShowMore'
], function ($, fn, BaseView, ShowMore) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function PriceCheckView(config) {
    this.sViewName = 'PriceCheckView';
    this.sNamespace = 'sku';
    this.sTag = 'competitors';
    this.sViewClass = 'price-check-view';
    this.sTemplate = $('#price-check-view-template')[0].innerHTML;
    this.parent.constructor.call(this, config);
  }

  fn.inherit(PriceCheckView, BaseView);

  PriceCheckView._name = 'PriceCheckView';
  PriceCheckView.sNamespace = 'sku';
  PriceCheckView.sTag = 'competitors';

  PriceCheckView.prototype._setProps = function (data) {
    return {
      competitors: data.sku.competitors
    };
  };

  PriceCheckView.prototype._cacheDomElms = function () {
    var $wrapper = null;

    this.parent._cacheDomElms.call(this);
    $wrapper = $(this.oElms.elWrapper);
    this.oElms.competitors = $wrapper.find('div.price-check-competitors')[0];
  };

  PriceCheckView.prototype._initDependancies = function () {
    var _this = this;

    setTimeout(function () {
      _this.showMore = new ShowMore({
        selector: _this.oElms.elWrapper,
        height: 400
      });

      _this.showMore.fnInit();
    }, 100);
  };

  PriceCheckView.prototype.refresh = function (args) {
    var _args = args,
      data = args.mParamData.mvc,
      $node = null;

    if ($(this.sViewId).length === 0 && this.isObject(_args.render, true)) {
      $.extend(_args, _args.render);
      delete _args.render;

      _args.newEvent = true;
      this.render(args);
      return;
    }

    $node = $(this.parseHtml(
      { html: this.render({ mParamData: { mvc: data }, sOutput: 'none' }), trim: true }
    ));

    fn.refreshElement(
      this.oElms.competitors,
      $node.find('div.price-check-competitors')[0]
    );

    this._cacheDomElms();

    if (this.showMore) {
      this.showMore.toggleInit();
    }
  };

  return PriceCheckView;
});

define('modules/pdp/controllers/PriceCheckController', [
  'modules/mvc/fn',
  'modules/pdp/controllers/BaseController',
  'modules/pdp/views/PriceCheckView',
  'modules/tesco.analytics'
], function (fn, BaseController, PriceCheckView, analytics) {
  'use strict';

  /**
   *
   * @param {Array<Objects>} models
   * @return {void}
   */
  function PriceCheckController(models) {
    this.sNamespace = 'sku';
    this.sTag = 'competitors';
    this.views = {
      classes: {
        PriceCheckView: PriceCheckView
      }
    };
    this.flags = { viewRendered: false };
    this.parent.constructor.call(this, models);
  }


  fn.inherit(PriceCheckController, BaseController);
  PriceCheckController.modelNames = ['inventorySKU', 'sellers', 'sku'];


  PriceCheckController.prototype._collateDataDependancies = function (args) {
    var _this = this,
      _args = args,
      sellerModel = this.models.sellers,
      skuModel = this.models.sku,
      mvcData = args.mParamData.mvc,
      skuData = mvcData.sku,
      masterDeferred = args.deferred,
      mvcPage = fn.getValue(window.oAppController, 'oPageController');

    if (!mvcPage || !mvcPage.getSelectedSku().id) {
      this.rejectAndDestroy(masterDeferred);
      return;
    }

    if (sellerModel.getName(skuModel.getPrimaryListing(skuData).id) !== 'Tesco') {
      this.rejectAndDestroy(masterDeferred);
      return;
    }

    if (skuModel.getCompetitors(skuData).length > 0) {
      _this.flags.viewRendered = true;
      masterDeferred.resolve(_args);
      return;
    }

    skuModel.fetch({
      mSearchValue: skuData.id,
      sModelMethod: 'competitors',
      doneCallback: function (respData) {
        if (!fn.isObject(respData) || !fn.isArray(respData.skus, { notEmpty: true })) {
          _this.rejectAndDestroy(masterDeferred);
          return;
        }

        if (!fn.isObject(respData.skus[0])
            || !fn.isArray(respData.skus[0].competitors, { notEmpty: true })) {
          _this.rejectAndDestroy(masterDeferred);
          return;
        }

        skuData = skuModel.update({
          mSearchValue: skuData.id,
          sUpdateKey: 'competitors',
          mUpdateValue: respData.skus[0].competitors
        });

        if (!fn.isObject(skuData, { notEmpty: true })) {
          _this.rejectAndDestroy(masterDeferred);
          return;
        }

        _this.flags.viewRendered = true;
        _args.mParamData.mvc.sku = skuData;
        masterDeferred.resolve(_args);

        _this._analyticsTracking(respData.skus[0].competitors);
      }
    });
  };

  PriceCheckController.prototype._analyticsTracking = function (analyticsResponse) {
    var oWebAnalytics = null,
      v = [],
      competitorName = [],
      competitorPrice = [],
      competitorInfo = '',
      finalCompetitorList = [],
      competitorDetails = '';

    if (this.isArray(analyticsResponse, true)) {
      this.forLoop(analyticsResponse, function (i) {
        if (this.isObject(analyticsResponse[i], true)) {
          competitorName[i] = analyticsResponse[i].competitorName;
          competitorPrice[i] = analyticsResponse[i].competitorPrice;
          competitorInfo = competitorName[i] + '-' + competitorPrice[i];
          finalCompetitorList.push(competitorInfo);
        }
      });
      competitorDetails = finalCompetitorList.toString();
    }

    v = [{
      prop51: competitorDetails,
      contextData: {
        content_module_impression: 1,
        content_module_name: 'Price Checker'
      }
    }];

    oWebAnalytics = new analytics.WebMetrics();
    if (!window.pageLoadAnalyticsSuccess) {
      $(window).one('pageLoadAnalyticsSuccess',
      function priceCheckControllerAsyncAnalytics() {
        oWebAnalytics.submit(v);
      });
    } else {
      oWebAnalytics.submit(v);
    }
  };

  PriceCheckController.prototype.rejectAndDestroy = function (deferred) {
    var renderedView = {};

    if (this.flags.viewRendered) {
      renderedView = this._getStoredView('PriceCheckView', function (view) {
        if (view.sTag === 'competitors') {
          return true;
        }
        return false;
      });

      if (fn.isObject(renderedView, { notEmpty: true })) {
        renderedView.destroy();
      }

      this.flags.viewRendered = false;
    }
    deferred.reject();
  };

  return PriceCheckController;
});


define('text!templates/views/outfitItemView.html',[],function () { return '<div id="{{sViewId}}" class="{{sViewClass}}">\r\n  {{#views.ProductTileView}}\r\n    {{{render}}}\r\n  {{/views.ProductTileView}}\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/OutfitItemView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','modules/pdp/views/ProductTileView','text!templates/views/outfitItemView.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    ProductTileView = require('modules/pdp/views/ProductTileView'),
    template = require('text!templates/views/outfitItemView.html');

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function OutfitItemView(config) {
    this.sViewName = 'OutfitItemView';
    this.sNamespace = 'inherit';
    this.sTag = 'recommender';
    this.sViewClass = 'outfit-item';
    this.sTemplate = template;
    this.parent.constructor.call(this, config);
  }

  fn.inherit(OutfitItemView, BaseView);
  OutfitItemView._name = 'OutfitItemView';
  OutfitItemView.sNamespace = 'inherit';
  OutfitItemView.sTag = 'recommender';

  OutfitItemView.prototype._setData = function () {
    var viewModel = this.oData.mvc[this.sNamespace];

    delete this.oData.mvc.viewModel;

    fn.loopObject.call(this, viewModel, function loopViewModel(prop) {
      this.oData.mvc[prop] = viewModel[prop];
    });
  };

  OutfitItemView.prototype._addSubViews = function () {
    this.oData.views.ProductTileView = this._compileSubView({
      _class: ProductTileView
    });
  };

  module.exports = OutfitItemView;
});


define('text!templates/views/outfitItemsView.html',[],function () { return '<div id="{{sViewId}}" class="{{sViewClass}}">\r\n  <ul class="outfit-items-list">\r\n    {{#views.OutfitItemView}}\r\n      <li class="{{props.oddEvenClass}}">{{{render}}}</li>\r\n    {{/views.OutfitItemView}}\r\n  </ul>\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/OutfitItemsView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','modules/pdp/views/OutfitItemView','modules/show-more/ShowMore','text!templates/views/outfitItemsView.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    OutfitItemView = require('modules/pdp/views/OutfitItemView'),
    ShowMore = require('modules/show-more/ShowMore'),
    template = require('text!templates/views/outfitItemsView.html');

  /**
   * The view class that renders the outfit items view.
   * @param {Object} config The configuration for the view.
   * @return {void}
   */
  function OutfitItemsView(config) {
    this.sViewName = 'OutfitItemsView';
    this.sNamespace = 'inherit';
    this.sTag = 'recommender';
    this.sViewClass = 'outfit-items';
    this.sTemplate = template;
    this.itemCounter = 1;
    this.parent.constructor.call(this, config);
  }

  fn.inherit(OutfitItemsView, BaseView);
  OutfitItemsView._name = 'OutfitItemsView';
  OutfitItemsView.sNamespace = 'inherit';
  OutfitItemsView.sTag = 'recommender';

  OutfitItemsView.prototype._setData = function (args) {
    this.parent._setData.call(this, args);
    delete this.oData.mvc.items;
  };

  OutfitItemsView.prototype._setProps = function () {
    var _this = this;

    return {
      oddEvenClass: function () {
        var oddEvenClass = _this.itemCounter % 2 === 0 ? 'even' : 'odd';

        _this.itemCounter += 1;
        return oddEvenClass;
      }
    };
  };

  OutfitItemsView.prototype._addSubViews = function () {
    var viewModel = this.oData.mvc.viewModel,
      outfitItemView = [];

    this.forLoop(viewModel, function (i) {
      outfitItemView.push(this._compileSubView({ _class: OutfitItemView, data: viewModel[i] }));
    });

    this.oData.views.OutfitItemView = outfitItemView;
  };

  OutfitItemsView.prototype._initDependancies = function () {
    var _this = this,
      flags = this.oData.mvc.flags;

    if (!flags.useShowMore) {
      return;
    }

    setTimeout(function () {
      var showMore = new ShowMore({
        selector: _this.oElms.elWrapper,
        height: 500
      });

      showMore.fnInit();
    }, 100);
  };

  module.exports = OutfitItemsView;
});


define('text!templates/views/relatedItemsCarouselView.html',[],function () { return '{{#mViewData.items.length}}\r\n  <div id="{{sViewId}}" class="block-wrapper with-indents {{mViewData.relationshipType}}">\r\n    <div class="carousel-fullwidth block">\r\n        <header class="cfw-header">\r\n            <h2 class="block-title uppercase cfw-title">{{{mViewData.relatedItemHeading}}}</h2>\r\n            <div class="product-carousel-nav-wrapper">\r\n              <ul class="product-carousel-nav {{mViewData.carousel.customNavigationClass}}">\r\n                  <li class="disabled">\r\n                      <a href="#" class="previous">\r\n                          <span class="label">Previous</span>\r\n                          <span aria-hidden="true" class="icon"></span>\r\n                      </a>\r\n                  </li>\r\n                  <li>\r\n                      <a href="#" class="next">\r\n                          <span class="label">Next</span>\r\n                          <span aria-hidden="true" class="icon"></span>\r\n                      </a>\r\n                  </li>\r\n              </ul>\r\n            </div>\r\n        </header>\r\n        {{#aSubViews}}\r\n          {{{render}}}\r\n        {{/aSubViews}}\r\n    </div>\r\n    {{{oEvent}}}{{{addViewDataAttr}}}\r\n  </div>\r\n{{/mViewData.items.length}}\r\n';});

define('modules/pdp/views/RelatedProductView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','modules/pdp/views/CarouselItemsView','modules/pdp/views/OutfitItemsView','modules/pdp/views/BundleView','text!templates/views/relatedItemsCarouselView.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    CarouselItemsView = require('modules/pdp/views/CarouselItemsView'),
    OutfitItemsView = require('modules/pdp/views/OutfitItemsView'),
    BundleView = require('modules/pdp/views/BundleView'),
    template = require('text!templates/views/relatedItemsCarouselView.html');

  /**
   * The view class that renders the related products.
   * @param {oConfig} oConfig The configuration for the view.
   * @return {void}
   */
  function RelatedProductView(oConfig) {
    this.sViewName = 'RelatedProductView';
    this.sNamespace = 'products';
    this.sTag = 'links';
    this.sViewClass = oConfig.sViewClass || 'related-product-view';
    this.sTemplate = oConfig.sTemplate || template;
    this.parent.constructor.call(this, oConfig);

    this.views = {
      classes: {
        BundleView: BundleView,
        CarouselItemsView: CarouselItemsView,
        OutfitItemsView: OutfitItemsView
      }
    };
  }

  fn.inherit(RelatedProductView, BaseView);
  RelatedProductView._name = 'RelatedProductView';
  RelatedProductView.sNamespace = 'products';
  RelatedProductView.sTag = 'links';

  RelatedProductView.prototype._setData = function (params) {
    var _this = this;

    this.parent._setData.call(this, params);

    this.oData.mvc = {
      products: this.mParamData.id,
      sku: this.mParamData.sku,
      items: this.mParamData.items,
      flags: this.mParamData.flags || {},
      info: { rootViewId: this.sViewId },
      destroyRootView: function () {
        _this.setEvent({
          sName: 'destroyView',
          sNamespace: _this.sNamespace,
          sTag: _this.sTag,
          sViewName: _this.sViewName,
          getView: function getView(view) {
            if (view.sViewId === _this.sViewId) {
              return true;
            }
            return false;
          }
        }, false, true);
      }
    };

    if (this.mParamData.info && this.mParamData.info.rrPlacement) {
      this.oData.mvc.info = this.oData.mvc.info || {};
      this.oData.mvc.info.rrPlacement = this.mParamData.info.rrPlacement;
    }

    this.flags.isCarousel = !!fn.getValue(this.mParamData, 'carousel', 'show');
    this.flags.hasSubView = !!this.isObject(this.mParamData.subView, true);
    this.oData.mvc.info.relationship = this.mParamData.relationshipType;

    if (this.oData.mvc.info.relationship === 'completeTheLook') {
      this.oData.mvc.flags.showProductRatings = false;
    }
  };

  RelatedProductView.prototype._addSubViews = function () {
    var subviewData = this.mParamData.subView;

    if (this.flags.hasSubView) {
      this.oData.aSubViews.push(
        this._compileSubView({
          _class: this.views.classes[subviewData.name],
          ctlr: subviewData.ctlr,
          filterOptions: subviewData.filterOptions
        })
      );
    } else if (this.flags.isCarousel) {
      this.oData.aSubViews.push(
        this._compileSubView({
          _class: CarouselItemsView,
          data: this.oData.mvc.items
        })
      );
    }
  };

  module.exports = RelatedProductView;
});

define('modules/pdp/controllers/ProductController', [
  'modules/mvc/fn',
  'modules/pdp/controllers/BaseController',
  'modules/pdp/views/VariantsView',
  'modules/pdp/views/RelatedProductView',
  'modules/pdp/views/ProductCLPView'
], function (fn, BaseController, VariantsView, RelatedProductView, ProductCLPView) {
  'use strict';

  /**
   * Controller for managing all interaction between the product model and product-level views.
   * @param {Object} oModel The product model.
   * @param {Object} oView A view object.
   * @return {void}
   */
  function ProductController(oModel, oView) {
    this.sNamespace = 'products';
    this.sTag = '_default';
    this.views = {
      classes: {
        VariantsView: VariantsView,
        RelatedProductView: RelatedProductView,
        ProductCLPView: ProductCLPView
      }
    };
    this.parent.constructor.call(this, oModel, oView);
  }

  fn.inherit(ProductController, BaseController);

  return ProductController;
});

define('modules/pdp/data-stores/Product', [], function () {
  'use strict';

  /**
   *
   * @param {Object} data
   * @return {void}
   */
  function Product(data) {
    this.avgRating = data.avgRating || null;
    this.brand = data.brand || null;
    this.ancestorCategories = data.ancestorCategories || null;
    this.classifactionLabelingPackaging = data.classifactionLabelingPackaging || null;
    this.displayName = data.displayName || null;
    this.dynamicAttributes = data.dynamicAttributes || {};
    this.giftMessagingEnabled = data.giftMessagingEnabled || false;
    this.id = data.id || null;
    this.links = data.links || null;
    this.longDescription = data.longDescription || null;
    this.mediaAssets = data.mediaAssets || null;
    this.minimumAgeRequired = data.minimumAgeRequired || null;
    this.noofRatingsProduced = data.noofRatingsProduced || null;
    this.optionsInfo = data.optionsInfo || null;
    this.prices = data.prices || {};
    this.publicLink = data.publicLink || null;
    this.rrLink = data.rrLink || null;
    this.ues = data.ues || null;
    this.userActionable = data.userActionable || false;
  }

  return Product;
});

define('modules/pdp/models/ProductModel', [
  'modules/mvc/fn',
  'modules/pdp/data-stores/Product',
  'modules/pdp/models/BaseModel'
], function (fn, Product, BaseModel) {
  'use strict';


  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function ProductModel(config) {
    this.DataStoreClass = Product;
    this.sNamespace = 'products';
    this.parent.constructor.call(this, config);
  }


  fn.inherit(ProductModel, BaseModel);


  ProductModel.prototype.getMediaAssets = function (data) {
    var productData = this.resolveDataArg(data);

    if (!fn.isObject(productData, { notEmpty: true })
        || !fn.isObject(productData.mediaAssets, { notEmpty: true })) {
      return {};
    }

    return productData.mediaAssets;
  };


  ProductModel.prototype.getDefaultImage = function (data) {
    var mediaAssets = this.getMediaAssets(data);

    if (!fn.isObject(mediaAssets, { notEmpty: true })
        || !fn.isObject(mediaAssets.defaultSku, { notEmpty: true })
        || !fn.isObject(mediaAssets.defaultSku.defaultImage, { notEmpty: true })) {
      return {};
    }

    return mediaAssets.defaultSku.defaultImage;
  };


  ProductModel.prototype.getPrices = function (data) {
    var productData = this.resolveDataArg(data);

    if (!this.isObject(productData, true) || !this.isObject(productData.prices, true)) {
      return {};
    }

    return productData.prices;
  };


  ProductModel.prototype.getPrice = function (data) {
    var prices = this.getPrices(data);

    if (!this.isObject(prices, true)) {
      return '';
    }

    return prices.fromPrice || prices.price || '';
  };


  ProductModel.prototype.getPublicLink = function (data) {
    var productData = this.resolveDataArg(data);

    if (!this.isObject(productData, true) || typeof productData.publicLink !== 'string') {
      return '';
    }

    return productData.publicLink || '';
  };


  ProductModel.prototype.getBrand = function (data) {
    var productData = this.resolveDataArg(data);

    if (!this.isObject(productData, true) || typeof productData.brand !== 'string') {
      return '';
    }

    return productData.brand || '';
  };


  ProductModel.prototype.getGender = function (data) {
    var productData = this.resolveDataArg(data);

    if (!this.isObject(productData, true) || !this.isObject(productData.dynamicAttributes, true)) {
      return '';
    }

    return productData.dynamicAttributes.gender || '';
  };


  ProductModel.prototype.isFF = function (data) {
    var productData = this.resolveDataArg(data);

    if (!this.isObject(productData, true) || !this.isObject(productData.dynamicAttributes, true)
        || productData.dynamicAttributes.supplier !== 'FF') {
      return false;
    }

    return true;
  };


  ProductModel.prototype.isFFBranded = function (data) {
    return this.getBrand(data).startsWith('F&F') || false;
  };


  /**
   *
   * @param {Object|String} data
   * @return {Object}
   */
  ProductModel.prototype.getDefaultSku = function (data) {
    var links = this.getLinks({ value: 'defaultSku', data: data });

    if (!fn.isArray(links, { notEmpty: true })) {
      return {};
    }

    return links[0];
  };


  /**
   *
   * @param {Object|string} data
   * @return {Array<Object>}
   */
  ProductModel.prototype.getCategories = function (data) {
    var productData = this.resolveDataArg(data);

    if (!fn.isObject(productData) || !fn.isArray(productData.ancestorCategories)) {
      return [];
    }

    return productData.ancestorCategories;
  };


  /**
   *
   * @param {Object|string} data
   * @return {Object}
   */
  ProductModel.prototype.getParentCategory = function (data) {
    var categories = this.getCategories(data);

    if (!categories.length) {
      return {};
    }

    return categories[0];
  };


  /**
   *
   * @param {Object|string} data
   * @return {Object}
   */
  ProductModel.prototype.isProductVariant = function (data) {
    var selfLink = this.getSelfLink(data);

    return fn.isObject(selfLink, { notEmpty: true }) && selfLink.hasOwnProperty('options');
  };


  /**
   *
   * @param {Object|string} data
   * @param {string} type
   * @return {Object}
   */
  ProductModel.prototype.getOptionsInfo = function (data, type) {
    var optionInfo = {},
      optionsInfo = [],
      productData = this.resolveDataArg(data);

    if (!fn.isObject(productData, { notEmpty: true })
        || !fn.isArray(productData.optionsInfo, { notEmpty: true })) {
      return !type ? [] : {};
    }

    optionsInfo = productData.optionsInfo;

    if (!type) {
      return optionsInfo;
    }

    fn.loopArray(optionsInfo, function loopOptionsInfo(i) {
      if (optionsInfo[i].type === type) {
        optionInfo = optionsInfo[i];
      }
    });

    return optionInfo;
  };


  /**
   *
   * @param {Array<Object>|Object} data
   * @return {Array<Object>}
   */
  ProductModel.prototype._checkDataStores = function (data) {
    var _data = undefined,
      missingData = [];

    if (!data) {
      return [];
    }

    _data = fn.isArray(data) ? data : [data];

    fn.loopArray(_data, function loopDataStores(i) {
      if (!fn.checkData(_data[i], 'links')) {
        if (fn.isObject(_data[i]) && typeof _data[i].id === 'string') {
          missingData.push(_data[i].id);
        }
      }
    });

    return missingData;
  };


  return ProductModel;
});

define('modules/pdp/controllers/PromotionsController',['require','exports','module','modules/mvc/fn','modules/pdp/controllers/BaseController','modules/pdp/views/PromotionsView','modules/tesco.analytics'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn');
  var BaseController = require('modules/pdp/controllers/BaseController');
  var PromotionsView = require('modules/pdp/views/PromotionsView');
  var analytics = require('modules/tesco.analytics');

  /**
   *
   * @param {Array<Object>} models
   * @return {void}
   */
  var PromotionsController = function PromotionsController(models) {
    this.sNamespace = 'promotions';
    this.sTag = '_default';

    this.views = { classes: {
      PromotionsView: PromotionsView
    } };

    this.parent.constructor.call(this, models);
  };

  fn.inherit(PromotionsController, BaseController);
  PromotionsController.modelNames = ['promotions', 'sellers', 'sku'];

  /**
   *
   * @private
   * @param {Object} args
   * @param {string} args.sViewName
   * @param {string} args.sTag
   * @return {boolean}
   */
  PromotionsController.prototype._collateDataConditional = function (args) {
    return args.sViewName === 'PromotionsView' && args.sTag === 'productPage';
  };

  /**
   *
   * @private
   * @param {Object} args
   * @return {void}
   */
  PromotionsController.prototype._collateDataDependancies = function (args) {
    this._collateProductPageDependancies(args);
  };

  /**
   *
   * @private
   * @param {Object} args
   * @param {JQueryDeferred} args.deferred
   * @param {Object} args.mParamData
   * @return {void}
   */
  PromotionsController.prototype._collateProductPageDependancies = function (args) {
    var _this = this,
      masterDeferred = args.deferred,
      mvcData = args.mParamData.mvc,
      sellerModel = this.models.sellers;

    this._querySellerModel(args)
      .done(function handleQuerySellerModelSuccess(sellerData) {
        mvcData.sellers = sellerData;

        if (!mvcData.sellers.length || !sellerModel.getPromotions(mvcData.sellers[0]).length) {
          masterDeferred.resolve(args);
        } else {
          _this._queryPromotionsModel(args)
            .done(function handleQueryPromotionsModelSuccess(promoData) {
              mvcData.promotions = promoData;
              masterDeferred.resolve(args);
            });
        }
      });
  };

  /**
   *
   * @private
   * @param {Object} args
   * @param {Object} args.mParamData
   * @return {JQueryPromise}
   */
  PromotionsController.prototype._querySellerModel = function (args) {
    var check = null,
      deferred = $.Deferred(),
      listingIDs = [],
      listingLinks = [],
      mvcData = args.mParamData.mvc,
      observe = null,
      sellerModel = this.models.sellers,
      skuModel = this.models.sku;

    listingLinks = skuModel.getListings(mvcData.sku);

    if (!listingLinks.length) {
      deferred.resolve([]);
    }

    listingIDs = listingLinks.map(function (link) {
      return link.id;
    });

    check = function checkSellerData(data) {
      if (!fn.checkData(data, ['id', 'name'])) {
        observe();
      } else {
        deferred.resolve(data);
      }
    };

    observe = function observeSellerData() {
      sellerModel.observe({
        action: 'add',
        callback: function observeCallback(resp) {
          check(resp.data.observe);
        },
        once: true,
        searchValue: listingIDs
      });
    };

    check(sellerModel.getDataStores({ value: listingIDs, noFetch: true }));

    return deferred.promise();
  };

  /**
   *
   * @private
   * @param {Object} args
   * @param {Object} args.mParamData
   * @return {JQueryPromise}
   */
  PromotionsController.prototype._queryPromotionsModel = function (args) {
    var check = null,
      deferred = $.Deferred(),
      mvcData = args.mParamData.mvc,
      observe = null,
      promoIDs = [],
      promotionsModel = this.models.promotions,
      sellerModel = this.models.sellers;

    promoIDs = sellerModel.getPromotions(mvcData.sellers[0]);

    check = function checkPromoData(data) {
      if (!fn.checkData(data, ['id', 'displayName'])) {
        observe();
      } else {
        deferred.resolve(data);
      }
    };

    observe = function observePromoData() {
      promotionsModel.observe({
        action: 'add',
        callback: function observeCallback(resp) {
          check(resp.data.observe);
        },
        once: true,
        searchValue: promoIDs
      });
    };

    check(promotionsModel.getDataStores({ value: promoIDs, noFetch: true }));

    return deferred.promise();
  };

  /**
   *
   * @private
   * @param {Object} data
   * @return {void}
   */
  PromotionsController.prototype._bindViewEvents = function (data) {
    $(data.oView.oElms.elPromoLink).on(
      'click',
      { view: data.oView },
      this._analyticsTracking.bind(this)
    );
  };

  /**
   *
   * @private
   * @return {void}
   */
  PromotionsController.prototype._analyticsTracking = function () {
    var webAnalytics = new analytics.WebMetrics(),
      v = [{
        prop19: 'see other products',
        eVar45: 'see other products',
        prop42: 'pdp - special offers - other products',
        eVar59: 'pdp - special offers - other products',
        events: 'event45'
      }];

    webAnalytics.submit(v);
  };

  module.exports = PromotionsController;
});

define('modules/pdp/data-stores/Promotion',['require','exports','module'],function (require, exports, module) {
  'use strict';

  /**
   *
   * @param {Object} data
   * @return {void}
   */
  module.exports = function Promotion(data) {
    this.publicLink = data.publicLink || null;
    this.bucketCount = data.bucketCount || null;
    this.customerInstruction = data.customerInstruction || null;
    this.description = data.description || null;
    this.displayName = data.displayName || null;
    this.id = data.id || null;
    this.linkSaveURL = data.linkSaveURL || null;
    this.links = data.links;
    this.promoTermsCond = data.promoTermsCond || null;
    this.type = data.type || null;
    this.voucherCode = data.voucherCode || null;
  };
});

define('modules/pdp/models/PromotionsModel',['require','exports','module','modules/mvc/fn','modules/pdp/data-stores/Promotion','modules/pdp/models/BaseModel'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn');
  var Promotion = require('modules/pdp/data-stores/Promotion');
  var BaseModel = require('modules/pdp/models/BaseModel');

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  var PromotionsModel = function PromotionsModel(config) {
    this.DataStoreClass = Promotion;
    this.sNamespace = 'promotions';
    this.parent.constructor.call(this, config);
  };

  fn.inherit(PromotionsModel, BaseModel);

  PromotionsModel.prototype.dataHandler = function (res) {
    if (!fn.isArray(res, { notEmpty: true }) && !fn.isObject(res, { notEmpty: true })) return;
    this.add(res);
  };

  module.exports = PromotionsModel;
});

define('modules/pdp/controllers/RecommendersController', [
  'modules/mvc/fn',
  'modules/pdp/controllers/BaseController',
  'modules/pdp/views/OutfitItemsView',
  'modules/pdp/views/CarouselItemsView'
], function (fn, BaseController, OutfitItemsView, CarouselItemsView) {
  'use strict';

  /**
   *
   * @param {Array<Objects>} models
   * @return {void}
   */
  function RecommendersController(models) {
    var pageController = fn.getValue(window, 'oAppController', 'oPageController');

    this.sNamespace = 'inherit';
    this.sTag = 'recommender';
    this.views = { classes: {
      OutfitItemsView: OutfitItemsView,
      CarouselItemsView: CarouselItemsView
    } };

    this.parent.constructor.call(this, models);

    if (fn.isObject(pageController) && typeof pageController.setScrollAction === 'function') {
      pageController.setScrollAction({
        callback: this._analyticsTracking,
        once: true,
        scope: this
      });
    }
  }


  fn.inherit(RecommendersController, BaseController);
  RecommendersController.modelNames = [
    'products', 'sku', 'formHandler', 'inventorySKU', 'inventoryProduct'
  ];


  RecommendersController.prototype._collateDataDependancies = function (params) {
    var _this = this,
      _params = params,
      data = _params.mParamData.mvc,
      filterOptions = _params.filterOptions || {},
      masterDeferred = _params.deferred,
      namespace = _params.sNamespace;

    if (typeof data.destroyRootView !== 'function') {
      data.destroyRootView = function () {};
    }

    /**
     *
     * @return {void}
     */
    function destroyAndReject() {
      data.destroyRootView();
      masterDeferred.reject();
    }

    if (!fn.isArray(data.items) || data.items.length === 0) {
      destroyAndReject();
      return;
    }

    data.flags = this.isObject(data.flags) ? data.flags : {};

    this._filterItems(data.items, namespace, filterOptions)
      .fail(function hanldFilterItemsFailure() {
        destroyAndReject();
      })
      .done(function handleFilterItemsSuccess(filteredItems) {
        if (!fn.isArray(filteredItems, { notEmpty: true })) {
          destroyAndReject();
          return;
        }

        _this._collateViewModelData(filteredItems, namespace, data.flags)
          .done(function handleCollateViewModelDataSuccess(viewModel) {
            data.viewModel = viewModel;
            _params.mParamData.mvc = data;
            masterDeferred.resolve(_params);
          })
          .fail(function handleCollateViewModelDataFailure() {
            destroyAndReject();
          });
      });
  };


  RecommendersController.prototype._filterItems = function (items, namespace, opts) {
    var filterDeferred = $.Deferred(),
      filteredItems = this._defaultFilter(items, namespace);

    this._fetchAndFilterInventory(filteredItems, namespace, opts.inventory)
      .fail(function handleInventoryFailure() {
        filterDeferred.reject();
      })
      .done(function handleInventorySuccess(inventoryFilteredItems) {
        filterDeferred.resolve(inventoryFilteredItems);
      });

    return filterDeferred.promise();
  };


  /**
   * The default filter checks for the presence of a prices object on a product/sku.
   * If a product/sku does not have a prices object then it means the product/sku does not
   * have any listings and so there is no point in rendering it out.
   *
   * @param {Array<Object>} items
   * @param {String} namespace
   * @return {Array<Object>}
   */
  RecommendersController.prototype._defaultFilter = function (items, namespace) {
    fn.loopArray.call(this, items, function loopItems(i) {
      if (!fn.isObject(this.models[namespace].getPrices(items[i]), { notEmpty: true })) {
        items.splice(i, 1);
      }
    }, { backward: true });

    return items;
  };


  RecommendersController.prototype._fetchAndFilterInventory = function (items, namespace, opts) {
    var _this = this,
      inventoryFetchPromise = null,
      inventoryDeferred = $.Deferred(),
      filteredItems = [];

    inventoryFetchPromise = this._fetchInventory(items, namespace, opts, inventoryDeferred);

    if (inventoryFetchPromise) {
      inventoryFetchPromise
        .fail(function handleInventoryFetchFailure() {
          inventoryDeferred.reject();
        }).done(function handleInventoryFetchSuccess(inventory) {
          if (!fn.isArray(inventory, { notEmpty: true })) {
            inventoryDeferred.reject();
            return;
          }
          filteredItems = _this._filterInventory(items, inventory, opts);
          inventoryDeferred.resolve(filteredItems);
        });
    }

    return inventoryDeferred.promise();
  };


  RecommendersController.prototype._fetchInventory = function (items, namespace, opts, deferred) {
    var inventoryModel = namespace === 'products'
        ? this.models.inventoryProduct : this.models.inventorySKU;

    if (!opts) {
      deferred.resolve(items);
      return null;
    }

    return inventoryModel.promise({
      mSearchValue: items.map(function loopItems(item) {
        return item.id;
      })
    });
  };


  RecommendersController.prototype._filterInventory = function (items, inventory, opts) {
    var _opts = opts || {},
      matchFound = false;

    fn.loopArray(items, function loopItems(i) {
      matchFound = false;

      fn.loopArray(inventory, function loopInventory(j) {
        if (fn.isObject(items[i], { notEmpty: true })) {
          if (items[i].id === inventory[j].id) {
            matchFound = true;

            if (_opts.available && !inventory[j].available) {
              items.splice(i, 1);
            } else if (_opts.subscribable && !inventory[j].subscribable) {
              items.splice(i, 1);
            }
          }
        }
      });

      if (!matchFound) {
        items.splice(i, 1);
      }
    }, { backward: true });

    return items;
  };


  RecommendersController.prototype._collateViewModelData = function (items, namespace, flags) {
    var deferred = $.Deferred();

    this._createViewModel(items, namespace, flags, deferred);
    return deferred.promise();
  };


  RecommendersController.prototype._createViewModel = function (items, namespace, flags, deferred) {
    var create = this._createDefaultViewModel,
      viewModel = [];

    if (flags.shopTheRange) {
      create = this._createRangeViewModel;
    }

    fn.loopArray.call(this, items, function loopItems(i) {
      viewModel.push(create.call(this, items[i], namespace));
    });

    deferred.resolve(viewModel);
  };


  RecommendersController.prototype._createDefaultViewModel = function (item, namespace) {
    var obj = {};

    obj[namespace] = item;
    return obj;
  };


  RecommendersController.prototype._createRangeViewModel = function (item, namespace) {
    var obj = {};

    obj[namespace] = item;
    obj.formHandler = this._cloneFormhandler(item, 'range');
    obj.sellers = { buyBoxMessage: 'buy', buyButtonLabel: 'Add to basket' };

    return obj;
  };


  RecommendersController.prototype._cloneFormhandler = function (skuData, component) {
    var models = this.models,
      productID = models.sku.getParentProduct(skuData).id;

    return models.formHandler.clone({
      component: component,
      config: [{
        key: 'catalogRefIds',
        value: models.sku.getPrimaryListing(skuData).id
      }, {
        key: 'productId',
        value: productID
      }, {
        key: 'skuId',
        value: skuData.id
      }],
      name: 'addToBasket',
      publicLink: models.products.getPublicLink(productID)
    }, { add: true });
  };


  /**
   *
   * @param {Object} args
   * @param {Object} args.oView
   * @param {JQueryDeferred} _deferred Used for unit tests
   * @return {void}
   */
  RecommendersController.prototype._bindViewEvents = function (args, _deferred) {
    var view = args.oView,
      flags = view.oData.mvc.flags || {};

    if (view.sViewName !== 'OutfitItemsView' && view.sViewName !== 'CarouselItemsView') {
      return;
    }

    if (flags.completeTheLook || flags.outfitBuilder || flags.shopTheRange) {
      this._actionInViewport.push({ element: view.oElms.elWrapper, callbackArgs: { view: view } });
      this._checkInViewport(view.sViewId, _deferred);
    }
  };


  /**
   *
   * @param {Object} args
   * @param {Object} args.view
   * @return {void}
   */
  RecommendersController.prototype._analyticsTracking = function (args) {
    var mvcData = args.view.oData.mvc,
      viewModel = mvcData.viewModel,
      flags = mvcData.flags,
      relationship = '',
      id = '',
      ids = [],
      joinedIDs = '',
      _s = fn.copyObject(window.s);

    relationship = flags.completeTheLook ? 'Complete the Look' : relationship;
    relationship = flags.outfitBuilder ? 'Outfit Block' : relationship;
    relationship = flags.shopTheRange ? 'Shop The Range' : relationship;
    relationship = flags.bundle ? 'Frequently Bought Together' : relationship;

    if (fn.isArray(viewModel, { notEmpty: true })) {
      fn.loopArray(viewModel, function (i) {
        if (fn.isObject(viewModel[i], { notEmpty: true })) {
          if (viewModel[i].hasOwnProperty('products')) {
            id = viewModel[i].products.id;
          } else if (viewModel[i].hasOwnProperty('sku')) {
            id = viewModel[i].sku.id;
          }
          ids.push(id);
        }
      });

      joinedIDs = ids.join(';;,;');
    }

    if (relationship) {
      _s.linkTrackEvents = 'event3,event32,event45';
      _s.linkTrackVars = 'prop19,eVar45,prop42,eVar59,events,products';
      _s.products = ';' + joinedIDs + ';;';
      _s.prop19 = 'product impressions';
      _s.eVar45 = _s.prop19;
      _s.prop42 = 'pdp - ' + relationship + ' - product impressions';
      _s.eVar59 = _s.prop42;
      _s.events = 'event3,event32,event45';
      if (!window.pageLoadAnalyticsSuccess) {
        $(window).one('pageLoadAnalyticsSuccess',
        function bundleControllerAsyncAnalytics() {
          _s.tl(true, 'o', relationship + ' - product impressions');
        });
      } else {
        _s.tl(true, 'o', relationship + ' - product impressions');
      }
    }
  };


  return RecommendersController;
});

/* jslint */
/* globals console,define,require,window */
define('modules/pdp/data-stores/RelatedItem', [], function () {
  'use strict';

  var RelatedItem = function RelatedItem(oData) {
    this.links = oData.links || null;
  };

  return RelatedItem;
});

define('modules/pdp/models/RelatedItemsModel', [
  'modules/mvc/fn',
  'modules/pdp/data-stores/RelatedItem',
  'modules/pdp/models/BaseModel'
], function (fn, RelatedItem, BaseModel) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function RelatedItemsModel(config) {
    this.DataStoreClass = RelatedItem;
    this.sNamespace = 'links';
    this.parent.constructor.call(this, config);
  }

  fn.inherit(RelatedItemsModel, BaseModel);
  return RelatedItemsModel;
});

define('modules/pdp/controllers/RelatedItemsController', [
  'modules/mvc/fn',
  'modules/pdp/controllers/BaseController',
  'modules/pdp/controllers/CarouselController',
  'modules/pdp/models/RelatedItemsModel'
], function (fn, BaseController, CarouselController, RelatedItemsModel) {
  var RelatedItemsController = null,
    addRelationshipToModel = null,
    proxyRenderView = null;

  addRelationshipToModel = function (sID, oResponse) {
    var oEvent = new $.Event('addData'),
      oUpdatedResponse = oResponse;

    oUpdatedResponse.id = sID;
    oEvent.namespace = 'products';

    oEvent.oData = {
      mAddData: oUpdatedResponse
    };
    $(window).trigger(oEvent);
  };

  proxyRenderView = function (args) {
    var _this = this,
      view = {};

    if (!fn.isArray(args.mParamData.items, { notEmpty: true })) {
      return;
    }

    view = this.createView(args);

    if (!view) {
      return;
    }

    setTimeout(function proxyRenderViewInt() {
      view.render();

      if (fn.getValue(args.mParamData, 'carousel', 'show')) {
        _this.initCarousel(view);
      }
    }, 4);
  };

  RelatedItemsController = function (oModel, oView) {
    this.parent.parent.constructor.call(this, oModel, oView);
    this.oRelatedItemsModel = new RelatedItemsModel();
    this.relationshipType = '';
  };

  fn.inherit(RelatedItemsController, BaseController);

  RelatedItemsController.prototype.renderView = function (oParams) {
    var aRequestedDataItems = [],
      bRelationshipLookup = true;

    if (oParams.mParamData.relationshipLookup !== undefined) {
      bRelationshipLookup = oParams.mParamData.relationshipLookup;
    }

    if (oParams.mParamData.items) {
      proxyRenderView.call(this, oParams);
    } else if (oParams.mParamData.lookupIDs) {
      aRequestedDataItems = this.processIDs(oParams.mParamData.lookupIDs);
      this.initFromIDs(aRequestedDataItems, oParams);
    } else if (oParams.mParamData.id && oParams.mParamData.relationshipType) {
      aRequestedDataItems = this.oModel.getLinks(
        oParams.mParamData.relationshipType,
        oParams.mParamData.id
      );
      aRequestedDataItems = this.processIDs(aRequestedDataItems);
      if (aRequestedDataItems.length > 0) {
        this.initFromIDs(aRequestedDataItems, oParams);
      } else if (bRelationshipLookup) {
        this.initFromRelationshipLookup(oParams);
      }
    }

    return true;
  };

  RelatedItemsController.prototype.processIDs = function processIDs(oData) {
    var i = 0,
      aDataItems = [];

    if (oData.links) {
      for (i = 0; i < oData.links.length; i += 1) {
        aDataItems.push(oData.links[i].id);
      }
    } else if (Array.isArray(oData)) {
      for (i = 0; i < oData.length; i += 1) {
        if (oData[i].id !== undefined) {
          aDataItems.push(oData[i].id);
        } else {
          aDataItems.push(oData[i]);
        }
      }
    }
    return aDataItems;
  };

  RelatedItemsController.prototype.initFromIDs = function initFromIDs(aDataItems, oParams) {
    var oData = {},
      _this = this,
      oUpdateParams = oParams,
      listLength = 0,
      carouselArray = [],
      i = 0;

    oData.sNamespace = oParams.sNamespace;
    oData.oGetParams = {
      sSearchKey: 'id',
      mSearchValue: aDataItems
    };
    this._getDataFromModel(oData, function renderMyView(oReturnedParams) {
      if (oParams.mParamData.relationshipType !== undefined) {
        listLength = oReturnedParams.mPromiseData.length;
        if (oParams.mParamData.relationshipType.toLowerCase() === 'completethelook'
            || oParams.mParamData.relationshipType.toLowerCase() === 'outfit') {
          for (i = 0; i < listLength; i += 1) {
            if (oReturnedParams.mPromiseData[i].userActionable) {
              carouselArray.push(oReturnedParams.mPromiseData[i]);
            }
          }
        } else {
          carouselArray = oReturnedParams.mPromiseData;
        }
      } else {
        carouselArray = oReturnedParams.mPromiseData;
      }
      oUpdateParams.mParamData.items = carouselArray;
      proxyRenderView.call(_this, oUpdateParams);
    });
  };

  RelatedItemsController.prototype.initFromDataItems = function (aDataItems) {
    var i = 0;

    if (aDataItems) {
      for (i = 0; i < aDataItems.length; i += 1) {
        if (aDataItems[i] instanceof this.Model) {
          this._aDataItems.push(aDataItems[i]);
        }
      }
      this.renderDataItems();
    }
  };

  RelatedItemsController.prototype.initFromRelationshipType = function (id, rel) {
    this.initFromLinksObject(this.Model.getLinks(rel, id));
  };

  RelatedItemsController.prototype.initFromRelationshipLookup = function (oParams) {
    var _this = this,
      oDataParams = {},
      oRelatedItemsPromise = {},
      bRelatedItemAddedToModel = false;

    this.oRelatedItemsModel.sNamespace = oParams.sNamespace;

    oDataParams = {
      sSearchKey: 'id',
      mSearchValue: oParams.mParamData.id,
      sModelMethod: 'relationships',
      hrefData: { relationship: oParams.mParamData.relationshipType },
      processHyperMedia: oParams.mParamData.processHyperMedia,
      processHyperMediaType: oParams.mParamData.processHyperMediaType,
      doneCallback: function (oResponse) {
        var aDataItems = [];

        aDataItems = _this.processIDs(oResponse);
        _this.initFromIDs(aDataItems, oParams);
      },
      progressCallback: function (sLookupID, oData) {
        if (!bRelatedItemAddedToModel) {
          addRelationshipToModel(sLookupID, oData);
          bRelatedItemAddedToModel = true;
        }
      }
    };

    oRelatedItemsPromise = this.oRelatedItemsModel.promise(oDataParams);

    $.when.call($, oRelatedItemsPromise)
      .fail(function (sError) {
        throw new Error(sError);
      });
  };

  RelatedItemsController.prototype.requestDataFromModelAndProcess = function () {
    var oRequestEvent = {},
      _this = this,
      sEPOC = new Date().getTime().toString(),
      sEventNamespace = this.relationshipType + this.ModelType + sEPOC;

    oRequestEvent = new $.Event('dataRequest');
    oRequestEvent.namespace = this.ModelType;
    oRequestEvent.sRespNamespace = sEventNamespace;
    oRequestEvent.oData = {
      oGetParams: {
        sSearchKey: 'id',
        mSearchValue: this._aRequestedDataItems
      }
    };

    $(window).one('dataResponse.' + sEventNamespace, function handleDataResponse(oEvent) {
      _this._aDataItems = _this._aDataItems.concat(oEvent.oData.mRespData);
      if (_this.hasSuccessfullyReturnedRequestedSkuList()) {
        _this.renderDataItems();
      }
    });

    $(window).trigger(oRequestEvent);
  };

  RelatedItemsController.prototype.initCarousel = function (oView) {
    var $container = $(oView.sSelector);

    $container.removeClass('displayNone');
    this.carouselController = new CarouselController($container);
  };

  return RelatedItemsController;
});

define('modules/pdp/controllers/RelatedProductController', [
  'modules/mvc/fn',
  'modules/pdp/controllers/RelatedItemsController',
  'modules/pdp/views/RelatedProductView'
], function (fn, RelatedItemsController, RelatedProductView) {
  'use strict';

  /**
   * Controller for managing all interaction between the product model and related
   * product-level views.
   * @param {Object} oModel The product model.
   * @param {Object} oView A view object.
   * @return {void}
   */
  function RelatedProductController(oModel, oView) {
    this.sNamespace = 'products';
    this.sTag = 'links';
    this.views = {
      classes: {
        RelatedProductView: RelatedProductView
      }
    };
    this.parent.constructor.call(this, oModel, oView);
  }

  fn.inherit(RelatedProductController, RelatedItemsController);

  return RelatedProductController;
});

define('modules/pdp/views/RelatedSKUView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BaseView','modules/pdp/views/CarouselItemsView','modules/pdp/views/BundleView','modules/pdp/views/OutfitItemsView','text!templates/views/relatedItemsCarouselView.html'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BaseView = require('modules/pdp/views/BaseView'),
    CarouselItemsView = require('modules/pdp/views/CarouselItemsView'),
    BundleView = require('modules/pdp/views/BundleView'),
    OutfitItemsView = require('modules/pdp/views/OutfitItemsView'),
    template = require('text!templates/views/relatedItemsCarouselView.html');

  /**
   * The view class that renders the related products.
   * @param {oConfig} config The configuration for the view.
   * @return {void}
   */
  function RelatedSKUView(config) {
    this.sViewName = 'RelatedSKUView';
    this.sNamespace = 'sku';
    this.sTag = 'links';
    this.sViewClass = config.sViewClass || 'related-sku-view';
    this.sTemplate = config.sTemplate || template;
    this.parent.constructor.call(this, config);

    this.views = {
      classes: {
        BundleView: BundleView,
        CarouselItemsView: CarouselItemsView,
        OutfitItemsView: OutfitItemsView
      }
    };
  }

  fn.inherit(RelatedSKUView, BaseView);
  RelatedSKUView._name = 'RelatedSKUView';
  RelatedSKUView.sNamespace = 'sku';
  RelatedSKUView.sTag = 'links';

  RelatedSKUView.prototype._setData = function (params) {
    var _this = this;

    this.parent._setData.call(this, params);
    this.flags.isCarousel = !!fn.getValue(this.mParamData, 'carousel', 'show');
    this.flags.hasSubView = !!this.isObject(this.mParamData.subView, true);
    this.oData.mvc = {};
    this.oData.mvc.products = this.mParamData.products;
    this.oData.mvc.sku = this.mParamData.id;
    this.oData.mvc.items = this.mParamData.items;
    this.oData.mvc.flags = this.mParamData.flags || {};
    this.oData.mvc.info = { rootViewId: this.sViewId };

    this.oData.mvc.destroyRootView = function () {
      _this.setEvent({
        sName: 'destroyView',
        sNamespace: _this.sNamespace,
        sTag: _this.sTag,
        sViewName: _this.sViewName,
        getView: function getView(view) {
          if (view.sViewId === _this.sViewId) {
            return true;
          }
          return false;
        }
      }, false, true);
    };
  };

  RelatedSKUView.prototype._addSubViews = function () {
    var subviewData = this.mParamData.subView;

    if (this.flags.hasSubView) {
      this.oData.aSubViews.push(
        this._compileSubView({
          _class: this.views.classes[subviewData.name],
          ctlr: subviewData.ctlr,
          filterOptions: subviewData.filterOptions
        })
      );
    } else if (this.flags.isCarousel) {
      this.oData.aSubViews.push(
        this._compileSubView({
          _class: CarouselItemsView,
          data: this.oData.mvc.items
        })
      );
    }
  };

  module.exports = RelatedSKUView;
});

define('modules/pdp/controllers/RelatedSKUController', [
  'modules/mvc/fn',
  'modules/pdp/controllers/RelatedItemsController',
  'modules/pdp/views/RelatedSKUView'
], function (fn, RelatedItemsController, RelatedSKUView) {
  'use strict';

  /**
   * Controller for managing all interaction between the sku model and related sku-level views.
   * @param {Object} oModel The sku model.
   * @param {Object} oView A view object.
   * @return {void}
   */
  function RelatedSKUController(oModel, oView) {
    this.sNamespace = 'sku';
    this.sTag = 'links';
    this.views = {
      classes: {
        RelatedSKUView: RelatedSKUView
      }
    };
    this.parent.constructor.call(this, oModel, oView);
  }

  fn.inherit(RelatedSKUController, RelatedItemsController);

  return RelatedSKUController;
});

define('modules/pdp/controllers/RequestStockAlertController', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/controllers/FormHandlerController',
  'modules/pdp/views/RequestStockAlertView'
], function ($, fn, FormHandlerController, RequestStockAlertView) {
  'use strict';

  var RequestStockAlertController = function (oModel) {
    this.sTag = 'requestStockAlert';
    this.oTooltipStyles = {
      kiosk: ['tooltip-left'],
      allDesktops: ['tooltip-left'],
      allDevices: ['tooltip-bottom']
    };
    this.views = {
      classes: {
        RequestStockAlertView: RequestStockAlertView
      }
    };
    this.parent.constructor.call(this, oModel);
  };

  fn.inherit(RequestStockAlertController, FormHandlerController);

  RequestStockAlertController.prototype._bindViewEvents = function (oData) {
    $(oData.oView.oElms.elSubmitBtn).on(
      'click',
      { oView: oData.oView },
      this._onRequestAlert.bind(this)
    );
  };

  RequestStockAlertController.prototype._onRequestAlert = function (oEvent) {
    var oView = oEvent.data.oView;

    $(oView.oElms.elSubmitBtn).addClass('submitting');

    this._activeView = oView;
    this.oModel.send({
      oPromise: {
        sSearchKey: $(oView.oElms.elSubmitBtn).data('mvc-key'),
        mSearchValue: $(oView.oElms.elSubmitBtn).data('mvc-value')
      },
      fnDoneCallback: this._onRequestAlertSuccess.bind(this),
      fnFailCallback: this._onRequestAlertFailure.bind(this)
    });
  };

  RequestStockAlertController.prototype._onRequestAlertSuccess = function (mRespData) {
    if (mRespData.hasOwnProperty('success')) {
      this.setEvent({
        sName: 'requestStockAlertSuccess',
        oRespData: mRespData
      }, false, true);

      this._showAlertSuccessBox();
    } else {
      this.setEvent({
        sName: 'requestStockAlertFailure',
        oRespData: mRespData
      }, false, true);

      if (mRespData.failure.redirectUrl) {
        window.location.href = mRespData.failure.redirectUrl;
      } else {
        this.createTooltip({
          sTooltopMessage: mRespData.failure.message,
          elTrigger: this._activeView.oElms.elSubmitBtn,
          sType: 'error'
        });
      }
    }

    $(this._activeView.oElms.elSubmitBtn).removeClass('submitting');
  };

  RequestStockAlertController.prototype._onRequestAlertFailure = function (sErrorMsg, oJqXHR) {
    this.setEvent({
      sName: 'requestStockAlertFailure',
      oRespData: oJqXHR
    }, false, true);

    this.createTooltip({
      sTooltopMessage: sErrorMsg,
      elTrigger: this._activeView.oElms.elSubmitBtn,
      sType: 'error'
    });

    $(this._activeView.oElms.elSubmitBtn).removeClass('submitting');
  };

  RequestStockAlertController.prototype._showAlertSuccessBox = function () {
    var STOCK_ALERT_SET = 'stock-alert-set';

    $(this._activeView.oElms.elWrapper).addClass(STOCK_ALERT_SET);
  };

  return RequestStockAlertController;
});

define('modules/pdp/controllers/SellerController', [
  'modules/mvc/fn',
  'modules/pdp/controllers/BaseController',
  'modules/pdp/views/SellerSummariesView',
  'modules/pdp/views/EventMessageView'
], function (fn, BaseController, SellerSummariesView, EventMessageView) {
  'use strict';

  /**
   *
   * @param {Object} model
   * @return {void}
   */
  function SellerController(model) {
    this.sNamespace = 'sellers';
    this.sTag = '_default';
    this.views = {
      classes: {
        SellerSummariesView: SellerSummariesView,
        EventMessageView: EventMessageView
      }
    };
    this.parent.constructor.call(this, model);
  }

  fn.inherit(SellerController, BaseController);

  SellerController.prototype._collateDataConditional = function (args) {
    if (args.sViewName === 'SellerSummariesView') {
      return true;
    }

    if (args.sViewName === 'EventMessageView' && !args.mParamData.mvc.sellers.events) {
      return true;
    }

    return false;
  };

  SellerController.prototype._collateDataDependancies = function (args) {
    if (args.sViewName === 'SellerSummariesView') {
      return this._collateSellerSummariesDependancies(args);
    } else if (args.sViewName === 'EventMessageView') {
      return this._collateEventMessageDependancies(args);
    }

    return undefined;
  };

  SellerController.prototype._collateSellerSummariesDependancies = function (args) {
    var _this = this,
      _args = args,
      oView = undefined,
      deferred = _args.deferred,
      sellerIds = [],
      getView = undefined,
      checkDeliveryCodes = undefined,
      observeResolveDeliveryCodes = undefined,
      checkAddDeliveryOptions = undefined,
      observeResolveDeliveryOptions = undefined;

    getView = function (view) {
      if (view.sViewName === 'SellerSummariesView') {
        return true;
      }
      return false;
    };

    checkDeliveryCodes = function (sellers) {
      var ids = [];

      /**
       * Check if any of the sellers are missing delivery options.
       */
      if (_this.isArray(sellers)) {
        _this.forLoop(sellers, function (i) {
          if (!sellers[i].deliveryOptions
              || (Array.isArray(sellers[i].deliveryOptions)
                  && !sellers[i].deliveryOptions.length)) {
            ids.push(sellers[i].id);
          }
        });

        return ids;
      }

      return undefined;
    };

    observeResolveDeliveryCodes = function (params, ids) {
      var _params = params;

      _this.oModel.observe({
        searchKey: 'id',
        searchValue: ids,
        propKey: 'deliveryOptions',
        action: 'add',
        once: true,
        callback: function (resp) {
          var respSellerIds = checkDeliveryCodes(resp.data.observe);

          if (respSellerIds.length) {
            observeResolveDeliveryCodes(_params, respSellerIds);
          } else {
            _this.queryModel({
              sNamespace: 'deliveryOptions'
            }).done(function (doModel) {
              var optionIds = checkAddDeliveryOptions(_params, doModel);

              if (optionIds.length) {
                observeResolveDeliveryOptions(_params, doModel, optionIds);
              } else {
                _params.toRefresh = true;
                _params.getView = getView;
                deferred.resolve(_params);
              }
            });
          }
        }
      });
    };

    checkAddDeliveryOptions = function (params, model) {
      var _params = params,
        primaryOption = undefined,
        option = {},
        ids = [],
        uniqueIds = [];

      _this.forLoop(_params.mParamData.mvc.sellers, function (i) {
        primaryOption = _this.oModel.getPrimaryDeliveryOption(
          _params.mParamData.mvc.sellers[i].id
        );

        option = model.get({
          sSearchKey: 'id',
          mSearchValue: primaryOption,
          noFetch: true
        });

        if (!option || $.isEmptyObject(option)) {
          ids.push(primaryOption);
        }

        _params.mParamData.mvc.sellers[i].custom = { deliveryOptions: option };
      });

      _this.forLoop(ids, function (i) {
        if (ids.indexOf(ids[i]) === i) {
          uniqueIds.push(ids[i]);
        }
      });

      return uniqueIds;
    };

    observeResolveDeliveryOptions = function (params, model, ids) {
      var _params = params;

      model.observe({
        searchKey: 'id',
        searchValue: ids,
        action: 'add',
        once: true,
        callback: function () {
          var optionIds = checkAddDeliveryOptions(_params, model);

          if (optionIds.length) {
            observeResolveDeliveryOptions(_params, model, optionIds);
          } else {
            /**
             * NOTE: this is a hack to get view refreshing working, we need to look at
             * this going forward.
             */
            _params.toRefresh = true;
            _params.getView = getView;
            deferred.resolve(_params);
          }
        }
      });
    };

    sellerIds = checkDeliveryCodes(_args.mParamData.mvc.sellers);

    if (sellerIds.length) {
      observeResolveDeliveryCodes(_args, sellerIds);
    } else {
      _this.queryModel({
        sNamespace: 'deliveryOptions'
      }).done(function (doModel) {
        var optionIds = checkAddDeliveryOptions(_args, doModel);

        if (optionIds.length) {
          observeResolveDeliveryOptions(_args, doModel, optionIds);
        } else {
          _args.toRefresh = true;
          _args.getView = getView;
          deferred.resolve(_args);
        }
      });
    }

    oView = this.createView(_args);

    if (oView) {
      oView.render();
    }
  };

  SellerController.prototype._collateEventMessageDependancies = function (args) {
    var _args = args,
      deferred = _args.deferred;

    this.oModel.observe({
      searchKey: 'id',
      searchValue: _args.mParamData.mvc.sellers.id,
      propKey: 'events',
      action: 'add',
      once: true,
      callback: function (resp) {
        _args.mParamData.mvc.sellers = resp.data.observe;
        deferred.resolve(_args);
      }
    });
  };

  return SellerController;
});

define('modules/pdp/data-stores/Seller', [], function () {
  'use strict';

  /**
   * The data object for the seller, including all the properties a seller has.
   * @param {Object} data The properties to map into the seller data object.
   * @return {void}
   */
  function Seller(data) {
    this.buyBoxMessage = data.buyBoxMessage || null;
    this.buyBoxState = data.buyBoxState || null;
    this.buyButtonLabel = data.buyButtonLabel || null;
    this.maxQuantity = data.maxQuantity || null;
    this.formHandler = data.formHandler || null;
    this.isBCVE = data.isBCVE || null;
    this.id = data.id || null;
    this.name = data.name || null;
    this.prices = data.prices || null;
    this.services = data.services || null;
    this.promotions = data.promotions || null;
    this.deliveryOptions = data.deliveryOptions || null;
    this.events = data.events || null;
    this.countdown = data.countdown || null;
    this.sellerId = data.sellerId || null;
    this.showBuyBox = data.showBuyBox || null;
    this.staticImagePath = data.staticImagePath || null;
    this.stockMessaging = data.stockMessaging || null;
    this.enableStockServiceCallPdpV2 = data.enableStockServiceCallPdpV2 || null;
    this.partnerUrl = data.partnerUrl || null;
    this.addOnMessage = data.addOnMessage || null;
  }

  return Seller;
});

define('modules/pdp/models/SellerModel', [
  'modules/mvc/fn',
  'modules/pdp/data-stores/Seller',
  'modules/pdp/models/BaseModel'
], function (fn, Seller, BaseModel) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function SellerModel(config) {
    this.DataStoreClass = Seller;
    this.sNamespace = 'sellers';
    this.sParentNamespace = 'products';
    this.parent.constructor.call(this, config);
  }


  fn.inherit(SellerModel, BaseModel);


  /**
   * Gets the primary delivery option for a seller.
   * @param {String} sId The id of a seller.
   * @return {String} The id of the primary delivery option.
   */
  SellerModel.prototype.getPrimaryDeliveryOption = function (sId) {
    return this.forLoop(this._aDataStores, function (i) {
      if (this._aDataStores[i].id === sId) {
        if (this.isArray(this._aDataStores[i].deliveryOptions, true)) {
          return this._aDataStores[i].deliveryOptions[0];
        }
      }

      return undefined;
    });
  };


  /**
   * Gets whether there is a seller that is a tesco partner.
   * @param {String|Array} mId The id(s) of a seller.
   * @return {Boolean} true/false
   */
  SellerModel.prototype.isSellerPartner = function (mId) {
    return this.forLoop(this._aDataStores, function (i) {
      var isSellerPartner = undefined;

      if (this.isArray(mId, true)) {
        isSellerPartner = this.forLoop(mId, function (j) {
          if (this._aDataStores[i].id === mId[j]) {
            if (this._aDataStores[i].name !== 'Tesco') {
              return true;
            }
          }

          return undefined;
        });
      } else if (this._aDataStores[i].id === mId) {
        if (this._aDataStores[i].name !== 'Tesco') {
          isSellerPartner = true;
        }
      }

      return isSellerPartner;
    }) || false;
  };


  /**
   *
   * @param {Object} data
   * @return {string}
   */
  SellerModel.prototype.getName = function (data) {
    var sellerData = this.resolveDataArg(data);

    if (!fn.isObject(sellerData, { notEmpty: true })) return '';
    return sellerData.name || '';
  };


  SellerModel.prototype.getPrices = function (data) {
    var sellerData = this.resolveDataArg(data);

    if (!this.isObject(sellerData, true) || !this.isObject(sellerData.prices, true)) {
      return {};
    }

    return sellerData.prices;
  };


  SellerModel.prototype.getPrice = function (data) {
    var prices = this.getPrices(data);

    if (!this.isObject(prices, true)) {
      return '';
    }

    return prices.price || '';
  };


  /**
   *
   * @param {Object|string} data
   * @return {Array<string>}
   */
  SellerModel.prototype.getPromotions = function (data) {
    var sellerData = this.resolveDataArg(data);

    if (!fn.isObject(sellerData, { notEmpty: true }) || !fn.isArray(sellerData.promotions)) {
      return [];
    }

    return sellerData.promotions;
  };


  return SellerModel;
});

define('modules/pdp/views/ServicesFormView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/pdp/views/AddRemoveServiceView'
], function ($, fn, BaseView, AddRemoveServiceView) {
  'use strict';

  /**
   * Services form view constructor sets view's core data and calls parent constructor.
   * @param {Object} oConfig The configuration to populate the view's dynamic properties.
   * @return {void}
   */
  function ServicesFormView(oConfig) {
    this.sViewName = 'ServicesFormView';
    this.sNamespace = 'services';
    this.sTag = 'form';
    this.sViewClass = 'services__form';
    this.sTemplate = $('#services-form-template')[0].innerHTML;
    this.parent.constructor.call(this, oConfig);
  }

  fn.inherit(ServicesFormView, BaseView);

  ServicesFormView._name = 'ServicesFormView';
  ServicesFormView.sNamespace = 'services';
  ServicesFormView.sTag = 'form';

  ServicesFormView.prototype._setData = function () {
    if (this.isArray(this.oData.mvc.services, true)) {
      this.forLoop(this.oData.mvc.services, function (i) {
        this.oData.mvc.services[i].custom = {
          visibility: !this.oData.mvc.services[i].tooltipMessage
              ? 'visibility: hidden'
              : '',
          checkbox: this._compileSubView({
            _class: AddRemoveServiceView,
            index: this.oData.mvc.services[i]
          })
        };
      });
    }
  };

  ServicesFormView.prototype._cacheDomElms = function () {
    var $selector = $(this.sSelector);

    this.parent._cacheDomElms.call(this);
    this.oElms.$tooltipTrigger = $selector.find('.tooltip-trigger');
  };

  ServicesFormView.prototype._bindEvents = function () {
    $(this.oElms.$tooltipTrigger).on(
      'click',
      this._triggerTooltip.bind(this)
    );
  };

  ServicesFormView.prototype._triggerTooltip = function (oEvent) {
    var serviceObj = this.oModel.get({
      sSearchKey: $(oEvent.currentTarget).data('mvc-key'),
      mSearchValue: $(oEvent.currentTarget).data('mvc-value')
    });

    if (serviceObj.tooltipMessage) {
      this.createTooltip({
        sTooltopMessage: serviceObj.tooltipMessage,
        elTrigger: oEvent.currentTarget
      });
    }
  };

  return ServicesFormView;
});

define('modules/pdp/controllers/ServicesController', [
  'modules/mvc/fn',
  'modules/pdp/controllers/BaseController',
  'modules/pdp/views/ServicesFormView',
  'modules/pdp/views/ServicesBannerGroupView',
  'modules/pdp/views/ServicesBannerView'
], function (fn, BaseController, ServicesFormView, ServicesBannerGroupView, ServicesBannerView) {
  'use strict';

  /**
   *
   * @param {Array<Objects>} models
   * @return {void}
   */
  function ServicesController(models) {
    this.sNamespace = 'services';
    this.sTag = '_default';
    this.views = {
      classes: {
        ServicesFormView: ServicesFormView,
        ServicesBannerGroupView: ServicesBannerGroupView,
        ServicesBannerView: ServicesBannerView
      }
    };
    this.parent.constructor.call(this, models);
  }


  fn.inherit(ServicesController, BaseController);
  ServicesController.modelNames = ['sku', 'sellers', 'services'];


  ServicesController.prototype._bindViewEvents = function (args) {
    var view = args.oView,
      states = view.oData.state;

    if (states.hasTooltip) {
      $(view.oElms.elWrapper).on(
        'click', { view: view },
        this._onBannerClick.bind(this)
      );
    }
  };


  ServicesController.prototype._onBannerClick = function (event) {
    var view = event.data.view,
      serviceData = view.oData.mvc.services;

    this.compileAndRenderOverlay({
      sTag: 'servicesBanner',
      sClassNames: 'services-banner-overlay small-lightbox with-header',
      sContentClasses: 'text text-block',
      elTrigger: event.currentTarget,
      sTitle: serviceData.name + ' - &pound;' + serviceData.price,
      oStyles: {
        allDesktops: ['lightbox', 'fullScreen'],
        htablet: ['lightbox', 'fullScreen'],
        vtablet: ['lightbox', 'fullScreen'],
        mobile: ['slideIn-left', 'fullScreen'],
        kiosk: ['lightbox', 'fullScreen']
      },
      sProp: 'tooltipMessage'
    }, event);
  };


  ServicesController.prototype._collateDataConditional = function (params) {
    if (params.sViewName === 'ServicesFormView' || params.sViewName === 'ServicesBannerGroupView') {
      return true;
    }
    return false;
  };


  ServicesController.prototype._collateDataDependancies = function (params) {
    if (params.sViewName === 'ServicesFormView') {
      this._collateFormDependancies(params, params.deferred);
    } else if (params.sViewName === 'ServicesBannerGroupView') {
      this._collateBannerDependancies(params, params.deferred);
    }
  };


  ServicesController.prototype._collateFormDependancies = function (params, deferred) {
    var _params = params,
      mvcData = _params.mParamData.mvc;

    mvcData.sellers = this.models.sellers.get({ mSearchValue: mvcData.sellers });

    if (this.sanityCheckData(mvcData.sellers).objects) {
      mvcData.services = mvcData.sellers.services;
      _params.mParamData.mvc = mvcData;
      deferred.resolve(_params);
    } else {
      deferred.reject();
    }
  };


  ServicesController.prototype._collateBannerDependancies = function (params, deferred) {
    var mvcData = params.mParamData.mvc;

    if (!this.sanityCheckData(mvcData.sku.sellers).ids) {
      this._querySkuModel(params, deferred);
      return;
    }

    if (!this.sanityCheckData(mvcData.sellers).objects) {
      this._querySellerModel(params, deferred);
      return;
    }

    if (!this.sanityCheckData(mvcData.services).objects) {
      this._queryServicesModel(params, deferred);
      return;
    }

    deferred.resolve(params);
  };


  ServicesController.prototype._querySkuModel = function (params, deferred) {
    var _this = this,
      _params = params,
      checkAndAdd = null,
      observeAndNotify = null,
      mvcData = _params.mParamData.mvc,
      skuModel = this.models.sku;

    checkAndAdd = function checkAddSellerData(data) {
      if (!_this.sanityCheckData(data).ids) {
        observeAndNotify();
      } else {
        mvcData.sku.sellers = data;
        mvcData.sellers = skuModel.getPrimarySeller(mvcData.sku.id);
        _params.mParamData.mvc = mvcData;
        _this._querySellerModel(_params, deferred);
      }
    };

    observeAndNotify = function observeNotifySkuListings() {
      skuModel.observe({
        callback: function observeAndNotifyCallback(resp) {
          checkAndAdd(resp.data.observe.sellers);
        },
        once: true,
        propKey: 'sellers',
        searchValue: mvcData.sku.id
      });
    };

    checkAndAdd(skuModel.get({ mSearchValue: mvcData.sku.id, sPropKey: 'sellers', noFetch: true }));
  };


  ServicesController.prototype._querySellerModel = function (params, deferred) {
    var _this = this,
      _params = params,
      checkAndAdd = null,
      observeAndNotify = null,
      mvcData = _params.mParamData.mvc,
      sellerModel = this.models.sellers;

    checkAndAdd = function checkAddSellerData(data) {
      if (!_this.sanityCheckData(data).objects) {
        observeAndNotify();
      } else {
        _params.mParamData.mvc.sellers = data;
        _this._queryServicesModel(_params, deferred);
      }
    };

    observeAndNotify = function observeNotifySellerData() {
      sellerModel.observe({
        action: 'add',
        callback: function observeAndNotifyCallback(resp) {
          checkAndAdd(resp.data.observe);
        },
        once: true,
        searchValue: mvcData.sellers
      });
    };

    checkAndAdd(sellerModel.get({ mSearchValue: mvcData.sellers, noFetch: true }));
  };


  ServicesController.prototype._queryServicesModel = function (params, deferred) {
    var _this = this,
      _params = params,
      checkAndAdd = null,
      observeAndNotify = null,
      mvcData = _params.mParamData.mvc,
      serviceModel = this.models.services;

    checkAndAdd = function checkAddServiceData(data) {
      if (!_this.sanityCheckData(data).objects) {
        observeAndNotify();
      } else {
        _params.mParamData.mvc.services = data;
        deferred.resolve(_params);
      }
    };

    observeAndNotify = function observeNotifySellerData() {
      serviceModel.observe({
        action: 'add',
        callback: function observeAndNotifyCallback(resp) {
          checkAndAdd(resp.data.observe);
        },
        once: true,
        searchValue: mvcData.sellers.services
      });
    };

    checkAndAdd(serviceModel.get({ mSearchValue: mvcData.sellers.services, noFetch: true }));
  };


  return ServicesController;
});

define('modules/pdp/data-stores/Service', [], function () {
  'use strict';

  /**
   * The data object for a service.
   * @param {Object} oData The data to be added to the service data object.
   * @return {void}
   */
  function Service(oData) {
    this.id = oData.id || null;
    this.longDesc = oData.longDesc || null;
    this.name = oData.name || null;
    this.price = oData.price || null;
    this.skuId = oData.skuId || null;
    this.tooltipMessage = oData.tooltipMessage || null;
    this.formHandler = oData.formHandler || null;
  }

  return Service;
});

define('modules/pdp/models/ServicesModel', [
  'modules/mvc/fn',
  'modules/pdp/data-stores/Service',
  'modules/pdp/models/BaseModel'
], function (fn, Service, BaseModel) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function ServicesModel(config) {
    this.DataStoreClass = Service;
    this.sNamespace = 'services';
    this.sParentNamespace = 'sellers';
    this.parent.constructor.call(this, config);
  }

  fn.inherit(ServicesModel, BaseModel);

  return ServicesModel;
});

define('modules/pdp/views/ProductDetailsView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView',
  'modules/pdp/views/ProductSpecView',
  'modules/show-more/ShowMore'
], function ($, fn, BaseView, ProductSpecView, ShowMore) {
  'use strict';

  /**
   * Use for displaying product details.
   * @param {Object} oConfig The configuration for the view.
   * @return {void}
   */
  function ProductDetailsView(oConfig) {
    this.sViewName = 'ProductDetailsView';
    this.sNamespace = 'sku';
    this.sTag = '_default';
    this.sViewClass = 'product-description-block';
    this.sTemplate = oConfig.sTemplate
      ? $(oConfig.sTemplate)[0].innerHTML
      : $('#product-details-template')[0].innerHTML;
    this.parent.constructor.call(this, oConfig);
  }

  fn.inherit(ProductDetailsView, BaseView);

  ProductDetailsView._name = 'ProductDetailsView';
  ProductDetailsView.sNamespace = 'sku';

  ProductDetailsView.prototype._addSubViews = function () {
    if (this.oData.mvc.products.dynamicAttributes.supplier === 'FF') {
      this.oData.aSubViews.push(
        this._compileSubView({
          _class: ProductSpecView,
          template: '#product-spec-enclosed-template',
          ctlr: true
        })
      );
    }
  };

  ProductDetailsView.prototype._initDependancies = function () {
    var _this = this;

    setTimeout(function () {
      var oShowMore = new ShowMore({
        selector: _this.oElms.elTarget,
        height: 400,
        label: 'specs'
      });

      oShowMore.fnInit();
    }, 100);
  };

  return ProductDetailsView;
});

define('modules/pdp/controllers/SkuController', [
  'modules/mvc/fn',
  'modules/pdp/controllers/BaseController',
  'modules/pdp/views/AuthorBiographyView',
  'modules/pdp/views/KioskProductPageView',
  'modules/pdp/views/BuyboxView',
  'modules/pdp/views/RelatedSKUView',
  'modules/pdp/views/ProductDetailsView',
  'modules/pdp/views/ProductSpecView',
  'modules/pdp/views/ProductMediaViewerView',
  'modules/tesco.utils',
  'modules/tesco.analytics'
], function (
  fn,
  BaseController,
  AuthorBiographyView,
  KioskProductPageView,
  BuyboxView,
  RelatedSKUView,
  ProductDetailsView,
  ProductSpecView,
  ProductMediaViewerView,
  tescoUtils,
  analytics
) {
  'use strict';

  /**
   *
   * @param {Array<Objects>} models
   * @return {void}
   */
  function SkuController(models) {
    this.sNamespace = 'sku';
    this.sTag = '_default';
    this.views = {
      classes: {
        AuthorBiographyView: AuthorBiographyView,
        KioskProductPageView: KioskProductPageView,
        BuyboxView: BuyboxView,
        RelatedSKUView: RelatedSKUView,
        ProductDetailsView: ProductDetailsView,
        ProductSpecView: ProductSpecView,
        ProductMediaViewerView: ProductMediaViewerView
      }
    };
    this.parent.constructor.call(this, models);
  }


  fn.inherit(SkuController, BaseController);
  SkuController.modelNames = ['products', 'sku', 'sellers', 'promotions'];


  SkuController.prototype.asyncBlockCallbacks = function () {
    var _this = this,
      _skuId = '',
      skuObj = null,
      updatedSkuObj = null,
      newSkuObj = null,
      oResp = null,
      oCallbacks = {};

    oCallbacks.success = function (sResp) {
      _skuId = this.oData.skuID;
      oResp = typeof sResp === 'string'
          ? JSON.parse(sResp)
          : sResp;

      if (oResp.ServerTime !== undefined) {
        window.currentTimeAsync = oResp.ServerTime;
      }

      /**
       * Pass data to data controller, which will pass all data to their respective models so that
       * all models are up to date for when the buybox renders.
       */
      _this.setEvent({
        sName: 'dataFetched',
        mfetchedData: oResp.BuyBoxV2.data
      }, false, true);

      /**
       * Update the sku model with the seller data that has come back from the async call.
       * Use the sku id on the callback oData object to find the right object in the data store.
       */
      skuObj = _this.models.sku.get({
        mSearchValue: _skuId,
        noFetch: true
      });

      if (_this.sanityCheckData(skuObj).objects) {
        updatedSkuObj = _this.models.sku.update({
          mSearchValue: _skuId,
          sUpdateKey: 'sellers',
          mUpdateValue: oResp.BuyBoxV2.data.sellers
        });
      } else {
        newSkuObj = _this.models.sku.add({
          id: _skuId,
          sellers: oResp.BuyBoxV2.data.sellers
        });
      }

      if (!window.isKiosk()) {
        _this.renderView({
          sViewName: 'BuyboxView',
          elTarget: '.buybox-placeholder',
          mParamData: { mvc: { sku: updatedSkuObj || newSkuObj } }
        });
      }
    };

    return oCallbacks;
  };


  SkuController.prototype.createSkuViewModel = function (productData, skuData) {
    return {
      specification: this._transformSpecificationData(skuData),
      miniDescription: this._transformMiniDescriptionData(skuData),
      dynamicAttributes: productData.dynamicAttributes || null
    };
  };


  SkuController.prototype._transformSpecificationData = function (skuData) {
    var formattedSpecs = [],
      group = {},
      specifications = {};

    if (!fn.isObject(skuData, { notEmpty: true })) {
      return null;
    }

    specifications = skuData.specification;

    fn.loopObject(specifications, function loopSpecifications(name) {
      group = {};
      group.groupName = name;
      group.groupAttributes = [];

      fn.loopArray(specifications[name], function loopSpecGroup(i) {
        group.groupAttributes.push(specifications[name][i]);
      }, { check: true });

      formattedSpecs.push(group);
    }, { check: true });

    return formattedSpecs;
  };


  SkuController.prototype._transformMiniDescriptionData = function (skuData) {
    var formattedDesc = {},
      miniDescription = {};

    if (!fn.isObject(skuData, { notEmpty: true })
        || !fn.isObject(skuData.miniDescription, { notEmpty: true })) {
      return null;
    }

    miniDescription = skuData.miniDescription;

    if (miniDescription['Bullet 1'] !== undefined) {
      formattedDesc.feature_1 = miniDescription['Bullet 1'];
    }

    if (miniDescription['Bullet 2'] !== undefined) {
      formattedDesc.feature_2 = miniDescription['Bullet 2'];
    }

    if (miniDescription['Bullet 3'] !== undefined) {
      formattedDesc.feature_3 = miniDescription['Bullet 3'];
    }

    return formattedDesc;
  };


  /**
   *
   * @param {Object} args
   * @param {string} args.sViewName
   * @return {boolean}
   */
  SkuController.prototype._collateDataConditional = function (args) {
    var viewName = args.sViewName;

    if (viewName === 'BuyboxView' || viewName === 'ProductSpecView') {
      return true;
    }
    return false;
  };

  /**
   *
   * @param {Object} args
   * @param {string} args.sViewName
   * @return {void}
   */
  SkuController.prototype._collateDataDependancies = function (args) {
    var viewName = args.sViewName;

    if (viewName === 'BuyboxView') {
      this._collateBuyboxDependancies(args);
    } else if (viewName === 'ProductSpecView') {
      this._collateSpecsDependancies(args);
    }
  };


  /**
   *
   * @param {Object} args
   * @param {JQueryDeferred} args.deferred
   * @param {Object} args.mParamData
   * @return {boolean}
   */
  SkuController.prototype._collateSpecsDependancies = function (args) {
    var deferred = args.deferred,
      mvcData = args.mParamData.mvc;

    mvcData.vm.sku = this.createSkuViewModel(mvcData.products, mvcData.sku);
    deferred.resolve(args);
  };


  /**
   *
   * @param {Object} args
   * @param {JQueryDeferred} args.deferred
   * @param {Object} args.mParamData
   * @return {boolean}
   */
  SkuController.prototype._collateBuyboxDependancies = function (args) {
    var _this = this,
      masterDeferred = args.deferred,
      mvcData = args.mParamData.mvc,
      productModel = this.models.products,
      sellerIDs = [],
      sellerModel = this.models.sellers,
      skuModel = this.models.sku,
      viewName = args.sViewName,
      mvcPage = window.oAppController.oPageController;

    if (!mvcData.flags) {
      mvcData.flags = {};
    }

    mvcData.flags.isKiosk = window.isKiosk();
    mvcData.flags.isSkuSelected = !!mvcPage.getSelectedSku().id;
    mvcData.flags.hasMultipleSellers = !!skuModel.getSecondaryListings(mvcData.sku).length;
    mvcData.flags.isBuybox = viewName === 'BuyboxView';

    this._queryProductModel(args)
      .done(function handleQueryProductsSuccess(productData) {
        if (productData) {
          mvcData.products = productData;
        }

        mvcData.flags.isFF = productModel.isFF(mvcData.products);

        if (!skuModel.getListings(mvcData.sku).length) {
          mvcData.sku.sellers = [];
          mvcData.sellers = [];
          masterDeferred.resolve(args);
          return;
        }

        _this._querySellerModel(args)
          .done(function handleQuerySellersSuccess(sellerData) {
            if (sellerData) {
              mvcData.sellers = sellerData;
            }

            if (viewName === 'BuyboxView' && mvcData.flags.isVariantChange) {
              _this._submitAnalytics(args);
            }

            sellerIDs = mvcData.sellers.map(function (seller) {
              return seller.id;
            });

            mvcData.flags.isSellerPartner = sellerModel.isSellerPartner(sellerIDs);

            if (viewName === 'BuyboxView') {
              _this._queryPriceAPI(args)
                .done(function handleQueryPriceAPISuccess() {
                  masterDeferred.resolve(args);
                });
            }
          });
      });
  };


  /**
   *
   * @param {Object} args
   * @param {Object} args.mParamData
   * @return {JQueryPromise}
   */
  SkuController.prototype._queryProductModel = function (args) {
    var check = null,
      deferred = $.Deferred(),
      listingIDs = [],
      mvcData = args.mParamData.mvc,
      observe = null,
      productLink = {},
      productModel = this.models.products,
      skuModel = this.models.sku;

    if (fn.checkData(mvcData.products, ['id', 'displayName', 'links'])) {
      deferred.resolve();
      return deferred.promise();
    }

    productLink = skuModel.getParentProduct(mvcData.sku);

    check = function checkProductData(data) {
      if (!fn.checkData(data, ['id', 'displayName', 'links'])) {
        observe();
      } else {
        deferred.resolve(data);
      }
    };

    observe = function observeProductData() {
      productModel.observe({
        action: 'add',
        callback: function observeCallback(resp) {
          check(resp.data.observe);
        },
        once: true,
        searchValue: listingIDs
      });
    };

    check(productModel.getDataStores({ value: productLink.id, noFetch: true }));
    return deferred.promise();
  };


  /**
   *
   * @param {Object} args
   * @param {Object} args.mParamData
   * @return {JQueryPromise}
   */
  SkuController.prototype._querySellerModel = function (args) {
    var check = null,
      deferred = $.Deferred(),
      listingIDs = [],
      mvcData = args.mParamData.mvc,
      observe = null,
      sellerModel = this.models.sellers,
      skuModel = this.models.sku;

    if (fn.checkData(mvcData.sellers, ['id', 'name'])) {
      deferred.resolve();
      return deferred.promise();
    }

    listingIDs = skuModel.getListings(mvcData.sku).map(function (link) {
      return link.id;
    });

    check = function checkSellerData(data) {
      if (!fn.checkData(data, ['id', 'name'])) {
        observe();
      } else {
        deferred.resolve(data);
      }
    };

    observe = function observeSellerData() {
      sellerModel.observe({
        action: 'add',
        callback: function observeCallback(resp) {
          check(resp.data.observe);
        },
        once: true,
        searchValue: listingIDs
      });
    };

    check(sellerModel.getDataStores({ value: listingIDs, noFetch: true }));
    return deferred.promise();
  };


  /**
   *
   * @param {Object} args
   * @param {Object} args.mParamData
   * @return {JQueryPromise}
   */
  SkuController.prototype._queryPriceAPI = function (args) {
    var deferred = $.Deferred(),
      skuID = args.mParamData.mvc.sku.id,
      skuModel = this.models.sku,
      sellerModel = this.models.sellers;

    skuModel.fetch({
      mSearchValue: skuID,
      sModelMethod: 'price',
      createEndpointCallback: function addQueryParams(url) {
        return url + '?format=standard';
      },
      doneCallback: function mergePrices(priceData) {
        var listingPrices = [];

        if (fn.isObject(priceData) && fn.isArray(priceData.skus)
            && fn.isObject(priceData.skus[0]) && fn.isArray(priceData.skus[0].listings)) {
          listingPrices = priceData.skus[0].listings;

          fn.loopArray(listingPrices, function loopListingPrices(i) {
            sellerModel.update({
              mSearchValue: listingPrices[i].id,
              sUpdateKey: 'prices',
              mUpdateValue: listingPrices[i]
            });
          });
        }

        deferred.resolve(args);
      }
    });

    return deferred.promise();
  };


  /**
   *
   * @param {Object} params
   * @return {void}
   */
  SkuController.prototype._submitAnalytics = function (params) {
    var _this = this,
      _params = params,
      oWebAnalytics = new analytics.WebMetrics(),
      oProps = {},
      sEvents = 'prodView,event3',
      sListingIDs = '',
      sLowStockMessage = '',
      iOOCounter = 0,
      sellerData = _params.mParamData.mvc.sellers,
      skuData = _params.mParamData.mvc.sku;

    oProps.products = ';' + skuData.id + ';;;';

    if (sellerData && sellerData.length) {
      _this.forLoop(sellerData, function loopSellers(i) {
        sListingIDs += i === 0
            ? sellerData[i].id
            : ',' + sellerData[i].id;

        if (sellerData[i].stockMessaging.messageClass === 'low-stock' && sLowStockMessage === '') {
          sLowStockMessage = sellerData[i].stockMessaging.messageText
            .replace('<strong>', '')
            .replace('</strong>', '');

          oProps.eVar48 = sLowStockMessage;
        }

        if (sellerData[i].stockMessaging.messageClass === 'oo-stock') {
          iOOCounter += 1;

          if (sellerData[i].sellerId === '1000001') {
            sEvents += ',event22';
          }
        }
      });

      if (iOOCounter === sellerData.length) {
        sEvents += ',event18';
      }

      oProps.list1 = sListingIDs;
    }

    oProps.events = sEvents;
    oWebAnalytics.submit([oProps]);
  };


  return SkuController;
});

define('modules/pdp/data-stores/Sku', [], function () {
  'use strict';

  /**
   *
   * @param {Object} data
   * @return {void}
   */
  function Sku(data) {
    this.id = data.id || null;
    this.commercialReleaseDateFormatted = data.commercialReleaseDateFormatted || null;
    this.authors = data.authors || null;
    this.mediaAssets = data.mediaAssets || null;
    this.skuSynopsis = data.skuSynopsis || null;
    this.publicLink = data.publicLink || null;
    this.longDescription = data.longDescription || null;
    this.specification = data.specification || null;
    this.prices = data.prices || null;
    this.links = data.links || null;
    this.attributes = data.attributes || {};
    this.displayName = data.displayName || null;
    this.bookDetails = data.bookDetails || null;
    this.miniDescription = data.miniDescription || null;
    this.noofRatingsProduced = data.noofRatingsProduced || null;
    this.avgRating = data.avgRating || null;
    this.sellers = data.sellers || null;
    this.personalisation = data.personalisation || null;
    this.ancestorCategories = data.ancestorCategories || null;
    this.competitors = data.competitors || null;
    this.rangedInStore = data.rangedInStore || false;
    this.isDigitalSku = data.isDigitalSku || false;
  }

  return Sku;
});

define('modules/pdp/models/SkuModel', [
  'modules/mvc/fn',
  'modules/pdp/data-stores/Sku',
  'modules/pdp/models/BaseModel'
], function (fn, Sku, BaseModel) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function SkuModel(config) {
    this.DataStoreClass = Sku;
    this.sNamespace = 'sku';
    this.sParentNamespace = 'products';
    this.parent.constructor.call(this, config);
  }

  fn.inherit(SkuModel, BaseModel);

  SkuModel.prototype.sellerInformationCallback = function (oParams) {
    var target = '';

    this.update({
      sSearchKey: 'id',
      mSearchValue: oParams.skuID,
      sUpdateKey: 'sellers',
      mUpdateValue: oParams.sellers
    });

    this.setEvent({
      sName: 'dataFetched',
      mfetchedData: {
        sellers: oParams.sellers
      }
    }, false, true);

    if (oParams.targetSelector !== undefined) {
      target = oParams.targetSelector;
    } else if ($('.buybox-view').length) {
      target = '.buybox-view';
    } else {
      target = '.buybox-wrapper';
    }

    this.setEvent({
      sName: 'render',
      sKeyId: oParams.skuID,
      sNamespace: 'sku',
      sTag: 'buybox',
      sViewName: 'BuyboxView',
      elTarget: target,
      /**
       * View data needs to be passed as value of 'products' property in order for the View
       * to use its namespace to pick up the right data being passed into it. The data is
       * prefixed in the mvc property to allow backwards compatibility with the legacy way
       * of passing data between views.
       */
      mParamData: {
        mvc: {
          sku: this.get({
            sSearchKey: 'id',
            mSearchValue: oParams.skuID
          })
        }
      }
    }, false, true);
  };


  SkuModel.prototype.createEndpoint = function (args) {
    var values = args.values,
      aEndpoints = [],
      oEndpoint = null,
      sProductID = null,
      sSKUID = null,
      sURL = '',
      i = 0,
      sSchoolId = '',
      sSchoolName = '',
      sLogoRef = '';

    oEndpoint = this.oDataEndpointMap.getEndpoint(this.sNamespace);

    if (oEndpoint) {
      sURL = oEndpoint.action.fetch.href;

      if (args.modelMethod) {
        sURL = oEndpoint.action[args.modelMethod].href;

        if (args.modelMethod === 'buybox') {
          sProductID = values[0];
          sSKUID = values[1];

          if (window.oAppController.oPageController.ues.schoolId !== '') {
            sSchoolId = '&schoolId=' + window.oAppController.oPageController.ues.schoolId;
          }

          if (window.oAppController.oPageController.ues.schoolName !== '') {
            sSchoolName = '&schoolName=' + window.oAppController.oPageController.ues.schoolName;
          }

          if (window.oAppController.oPageController.ues.slogoRef !== '') {
            sLogoRef = '&slogoRef=' + window.oAppController.oPageController.ues.slogoRef;
          }

          sURL = sURL.replace(/(%SKUID%)/, sSKUID)
            .replace(/(%PRODUCTID%)/, sProductID)
            .replace(/(%SCHOOLID%)/, sSchoolId)
            .replace(/(%SCHOOLNAME%)/, sSchoolName)
            .replace(/(%SLOGOREF%)/, sLogoRef);
          aEndpoints.push(sURL);
        } else if (args.modelMethod === 'ndo' || args.modelMethod === 'price'
            || args.modelMethod === 'competitors') {
          sURL += values[0];

          if (typeof args.createEndpointCallback === 'function') {
            sURL = args.createEndpointCallback(sURL);
          }

          aEndpoints.push(sURL);
        }
      } else {
        for (i = 0; i < values.length; i += 1) {
          aEndpoints.push(sURL + values[i]);
        }
      }
    }

    return aEndpoints;
  };

  SkuModel.prototype.dataHandler = function (oResponse, oParams) {
    if (oParams.sModelMethod === 'buybox') {
      if (oResponse.length > 0) {
        this.update({
          sSearchKey: 'id',
          mSearchValue: oParams.mSearchValue[1],
          sUpdateKey: 'sellers',
          mUpdateValue: oResponse
        });
      }
      this.triggerDataFetched(oResponse);
    } else {
      this.parent.dataHandler.apply(this, arguments);
    }
  };


  /**
   * NOTE: Legacy method to be deprecated in favour of getPrimaryListing.
   *
   * @param {Object|String} data
   * @return {String}
   */
  SkuModel.prototype.getPrimarySeller = function (data) {
    var skuData = this.resolveDataArg(data);

    if (!fn.isObject(skuData, { notEmpty: true })
        || !fn.isArray(skuData.sellers, { notEmpty: true })) {
      return null;
    }

    return skuData.sellers[0];
  };


  /**
   * NOTE: Legacy method to be deprecated in favour of getSecondaryListings.
   *
   * @param {Object|String} data
   * @return {Array<Object>}
   */
  SkuModel.prototype.getSecondarySellers = function (data) {
    var skuData = this.resolveDataArg(data);

    if (!fn.isObject(skuData, { notEmpty: true })
        || !fn.isArray(skuData.sellers, { notEmpty: true })) {
      return [];
    }

    return skuData.sellers.slice(1);
  };


  /**
   *
   * @param {Object|String} data
   * @return {Object}
   */
  SkuModel.prototype.getBookDetails = function (data) {
    var skuData = this.resolveDataArg(data);

    if (!fn.isObject(skuData, { notEmpty: true })
        || !fn.isObject(skuData.bookDetails, { notEmpty: true })) {
      return {};
    }

    return skuData.bookDetails;
  };


  /**
   *
   * @param {Object|String} data
   * @return {Object}
   */
  SkuModel.prototype.getMediaAssets = function (data) {
    var skuData = this.resolveDataArg(data);

    if (!fn.isObject(skuData, { notEmpty: true })
        || !fn.isObject(skuData.mediaAssets, { notEmpty: true })) {
      return {};
    }

    return skuData.mediaAssets;
  };


  /**
   *
   * @param {Object|String} data
   * @return {Object}
   */
  SkuModel.prototype.getDefaultImage = function (data) {
    var mediaAssets = this.getMediaAssets(data);

    if (!fn.isObject(mediaAssets, { notEmpty: true })
        || !fn.isObject(mediaAssets.defaultImage, { notEmpty: true })) {
      return {};
    }

    return mediaAssets.defaultImage;
  };


  /**
   *
   * @param {Object|String} data
   * @param {String} key optional
   * @param {String} value optional
   * @return {Array<Object>}
   */
  SkuModel.prototype.getSkuMedia = function (data, key, value) {
    var mediaAssets = this.getMediaAssets(data),
      skuMedia = [],
      skuMediaAssets = [];

    if (!fn.isObject(mediaAssets, { notEmpty: true })) {
      return [];
    }

    if (!fn.isArray(mediaAssets.skuMedia)) {
      mediaAssets.skuMedia = [];
      return mediaAssets.skuMedia;
    }

    skuMedia = mediaAssets.skuMedia;

    if (typeof key !== 'string' || typeof value !== 'string') {
      return skuMedia;
    }

    fn.loopArray(skuMedia, function loopSkuMedia(i) {
      if (fn.isObject(skuMedia[i]) && skuMedia[i][key] === value) {
        skuMediaAssets.push(skuMedia[i]);
      }
    });

    return skuMediaAssets;
  };


  /**
   *
   * @param {Object|String} data
   * @param {Object} mediaAsset
   * @return {void}
   */
  SkuModel.prototype.setSkuMedia = function (data, mediaAsset) {
    var skuData = this.resolveDataArg(data),
      skuMedia = [];

    if (!fn.isObject(skuData, { notEmpty: true }) || !fn.isObject(mediaAsset, { notEmpty: true })) {
      return;
    }

    skuMedia = this.getSkuMedia(skuData);

    skuMedia.push(mediaAsset);
    this.setDataStores(skuData);
  };


  /**
   *
   * @param {Object|String} data
   * @param {String} key optional
   * @param {String} value optional
   * @return {Array<Object>}
   */
  SkuModel.prototype.unsetSkuMedia = function (data, key, value) {
    var skuData = this.resolveDataArg(data),
      skuMedia = this.getSkuMedia(skuData);

    if (!fn.isArray(skuMedia, { notEmpty: true })) {
      return;
    }

    if (!key && !value) {
      skuMedia.splice(0, skuMedia.length);
    } else {
      fn.loopArray(skuMedia, function loopSkuMedia(i) {
        if (skuMedia[i][key] === value) {
          skuMedia.splice(i, 1);
        }
      }, { backward: true });
    }

    this.setDataStores(skuData);
  };


  /**
   *
   * @param {Object|String} data
   * @param {String} key optional
   * @param {String} value optional
   * @return {Array<Object>}
   */
  SkuModel.prototype.getPings = function (data, key, value) {
    var mediaAssets = this.getMediaAssets(data),
      pings = [],
      pingAssets = [];

    if (!fn.isObject(mediaAssets, { notEmpty: true })) {
      return [];
    }

    if (!fn.isArray(mediaAssets.pings)) {
      mediaAssets.pings = [];
      return mediaAssets.pings;
    }

    pings = mediaAssets.pings;

    if (typeof key !== 'string' || typeof value !== 'string') {
      return pings;
    }

    fn.loopArray(pings, function loopSkuMedia(i) {
      if (fn.isObject(pings[i]) && pings[i][key] === value) {
        pingAssets.push(pings[i]);
      }
    });

    return pingAssets;
  };


  /**
   *
   * @param {Object|String} data
   * @param {Object} pingAsset
   * @return {void}
   */
  SkuModel.prototype.setPing = function (data, pingAsset) {
    var skuData = this.resolveDataArg(data),
      pings = [];

    if (!fn.isObject(skuData, { notEmpty: true }) || !fn.isObject(pingAsset, { notEmpty: true })) {
      return;
    }

    pings = this.getPings(skuData);

    pings.push(pingAsset);
    this.setDataStores(skuData);
  };


  /**
   *
   * @param {Object|String} data
   * @param {String} key optional
   * @param {String} value optional
   * @return {Array<Object>}
   */
  SkuModel.prototype.unsetPings = function (data, key, value) {
    var skuData = this.resolveDataArg(data),
      pings = this.getPings(skuData);

    if (!fn.isArray(pings, { notEmpty: true })) {
      return;
    }

    if (!key && !value) {
      pings.splice(0, pings.length);
    } else {
      fn.loopArray(pings, function loopSkuMedia(i) {
        if (pings[i][key] === value) {
          pings.splice(i, 1);
        }
      }, { backward: true });
    }

    this.setDataStores(skuData);
  };


  /**
   * @param {Object|String} data
   * @return {Array<Object>}
   */
  SkuModel.prototype.getAttributes = function (data) {
    var skuData = this.resolveDataArg(data);

    if (!fn.isObject(skuData, { notEmpty: true })) {
      return {};
    }

    return skuData.attributes || {};
  };


  /**
   * @param {Object|String} data
   * @return {Array<Object>}
   */
  SkuModel.prototype.getColour = function (data) {
    var skuAttributes = this.getAttributes(data);

    if (!this.isObject(skuAttributes, true) || typeof skuAttributes.colour !== 'string') {
      return '';
    }

    return skuAttributes.colour || '';
  };


  /**
   *
   * @param {Object|String} data
   * @return {Object}
   */
  SkuModel.prototype.getPrices = function (data) {
    var skuData = this.resolveDataArg(data);

    if (!fn.isObject(skuData, { notEmpty: true })
        || !fn.isObject(skuData.prices, { notEmpty: true })) {
      return {};
    }

    return skuData.prices;
  };


  /**
   *
   * @param {Object|String} data
   * @return {String}
   */
  SkuModel.prototype.getPrice = function (data) {
    var prices = this.getPrices(data);

    if (!fn.isObject(prices, { notEmpty: true })) {
      return '';
    }

    return prices.fromPrice || prices.price || '';
  };


  /**
   *
   * @param {Object|String} data
   * @return {String}
   */
  SkuModel.prototype.getPublicLink = function (data) {
    var skuData = this.resolveDataArg(data);

    if (!this.isObject(skuData, true) || typeof skuData.publicLink !== 'string') {
      return '';
    }

    return skuData.publicLink || '';
  };


  /**
   *
   * @param {Object|String} data
   * @return {Object}
   */
  SkuModel.prototype.getParentProduct = function (data) {
    var links = this.getLinks({ value: 'parent', data: data });

    if (!fn.isArray(links, { notEmpty: true }) || !fn.isObject(links[0], { notEmpty: true })) {
      return {};
    }

    return links[0];
  };


  /**
   *
   * @param {Object|String} data
   * @return {String}
   */
  SkuModel.prototype.getParentProductId = function (data) {
    var parent = this.getParentProduct(data);

    return typeof parent.id === 'string' ? parent.id : '';
  };


  /**
   *
   * @param {Object|String} data
   * @return {Array<Object>}
   */
  SkuModel.prototype.getListings = function (data) {
    var links = this.getLinks({ value: 'listed', data: data });

    if (!fn.isArray(links, { notEmpty: true })) return [];
    return links;
  };


  /**
   *
   * @param {Object|String} data
   * @return {Object}
   */
  SkuModel.prototype.getPrimaryListing = function (data) {
    var listingLinks = this.getListings(data);

    if (!listingLinks.length) return {};
    return listingLinks[0] || {};
  };


  /**
   *
   * @param {Object|String} data
   * @return {Array<Object>}
   */
  SkuModel.prototype.getSecondaryListings = function (data) {
    var listingLinks = this.getListings(data);

    if (!listingLinks.length) return [];
    return listingLinks.slice(1);
  };


  /**
   *
   * @param {Object|String} data
   * @return {Array<Object>}
   */
  SkuModel.prototype.getCompetitors = function (data) {
    var skuData = this.resolveDataArg(data);

    if (!fn.isObject(skuData) || !fn.isArray(skuData.competitors)) {
      return [];
    }

    return skuData.competitors;
  };


  /**
   *
   * @param {Object|string} data
   * @return {Array<Object>}
   */
  SkuModel.prototype.getCategories = function (data) {
    var skuData = this.resolveDataArg(data);

    if (!fn.isObject(skuData) || !fn.isArray(skuData.ancestorCategories)) {
      return [];
    }

    return skuData.ancestorCategories;
  };


  /**
   *
   * @param {Object|string} data
   * @return {Object}
   */
  SkuModel.prototype.getParentCategory = function (data) {
    var categories = this.getCategories(data);

    if (!categories.length) {
      return {};
    }

    return categories[0];
  };


  /**
   *
   * @param {Object} data
   * @return {?boolean}
   */
  SkuModel.prototype.getRangedInStore = function (data) {
    var skuData = this.resolveDataArg(data);

    if (!fn.isObject(skuData) || typeof skuData.rangedInStore !== 'boolean') {
      return null;
    }

    return skuData.rangedInStore;
  };


  return SkuModel;
});

define('modules/pdp/data-stores/Store', [], function () {
  'use strict';

  /**
   * The data object for the store, including all the properties a store has.
   * @param {Object} data The properties to map into the store data object.
   * @return {void}
   */
  function Store(data) {
    this.id = data.id || null;
    this.addressOne = data.addressOne || null;
    this.addressTwo = data.addressTwo || null;
    this.country = data.country || null;
    this.county = data.county || null;
    this.facilities = data.facilities || null;
    this.facilitiesTiming = data.facilitiesTiming || null;
    this.friClose = data.friClose || null;
    this.friOpen = data.friOpen || null;
    this.gridReference = data.gridReference || null;
    this.latitude = parseFloat(data.latitude) || null;
    this.longitude = parseFloat(data.longitude) || null;
    this.monClose = data.monClose || null;
    this.monOpen = data.monOpen || null;
    this.postalCode = data.postalCode || null;
    this.satClose = data.satClose || null;
    this.satOpen = data.satOpen || null;
    this.storeId = data.storeId || null;
    this.storeName = data.storeName || null;
    this.storeTimings = data.storeTimings || null;
    this.storeTypes = data.storeTypes || null;
    this.sunClose = data.sunClose || null;
    this.sunOpen = data.sunOpen || null;
    this.telephone = data.telephone || null;
    this.thuClose = data.thuClose || null;
    this.thuOpen = data.thuOpen || null;
    this.townCity = data.townCity || null;
    this.tueClose = data.tueClose || null;
    this.tueOpen = data.tueOpen || null;
    this.wedClose = data.wedClose || null;
    this.wedOpen = data.wedOpen || null;
  }

  return Store;
});

define('modules/pdp/models/StoreModel', [
  'modules/mvc/fn',
  'modules/pdp/data-stores/Store',
  'modules/pdp/models/BaseModel'
], function (fn, StoreDS, BaseModel) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function StoreModel(config) {
    this.DataStoreClass = StoreDS;
    this.sNamespace = 'stores';
    this.sParentNamespace = '';
    this.parent.constructor.call(this, config);
  }


  fn.inherit(StoreModel, BaseModel);


  /**
   *
   * @param {Object} start
   * @param {Object} end
   * @param {string} [unit]
   * @return {string}
   */
  StoreModel.prototype.calculateDistance = function (start, end, unit) {
    var radlat1 = null,
      radlat2 = null,
      theta = null,
      radtheta = null,
      distance = null;

    if (!fn.isObject(start, { notEmpty: true }) || !fn.isObject(end, { notEmpty: true })) {
      return null;
    }

    if (!fn.checkData(start, ['latitude', 'longitude'])
      || !fn.checkData(end, ['latitude', 'longitude'])) {
      return null;
    }

    radlat1 = Math.PI * (start.latitude / 180);
    radlat2 = Math.PI * (end.latitude / 180);
    theta = start.longitude - end.longitude;
    radtheta = Math.PI * (theta / 180);
    distance = (Math.sin(radlat1) * Math.sin(radlat2))
        + (Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta));

    distance = Math.acos(distance);
    distance *= (180 / Math.PI) * 60 * 1.1515;

    if (unit === 'K') {
      distance *= 1.609344;
    }

    if (unit === 'N') {
      distance *= 0.8684;
    }

    return distance;
  };


  /**
   *
   * @param {Object} args
   * @param {Array<string>} args.values
   * @return {Array<string>}
   */
  StoreModel.prototype.createEndpoint = function (args) {
    var values = args.values,
      aEndpoints = [],
      endpoint = null,
      sLatitute = null,
      sLongitute = null,
      sURL = '';

    endpoint = this.oDataEndpointMap.getEndpoint(this.sNamespace);

    if (endpoint) {
      sURL = endpoint.action.fetch.href;

      if (args.modelMethod) {
        sURL = endpoint.action[args.modelMethod].href;
        sURL += values[0];
      } else {
        sLatitute = values[0];
        sLongitute = values[1];
        sURL = sURL.replace(/({LON})/, sLongitute).replace(/({LAT})/, sLatitute);
      }
      aEndpoints.push(sURL);
    }

    return aEndpoints;
  };

  return StoreModel;
});


define('text!templates/views/storeStockCheckOverlay.html',[],function () { return '<div class="col-largeDesktop-7 col-desktop-7">\r\n  <div class="col-stores-wrapper">\r\n    <form class="stock-check-form" data-id="{{props.id}}">\r\n      <label for="stock-check-overlay-form-postcode" class="stock-check-label text">Check stock in your local store:</label>\r\n      <input id="stock-check-overlay-form-postcode" title="Enter town / postcode" placeholder="Enter town / postcode" value="{{props.nearestStoreLookup}}" class="postcode pull-left-all" type="text" autocomplete="off">\r\n      <div class="button-wrapper">\r\n        <input type="submit" class="button secondary" value="Check" />\r\n      </div>\r\n    </form>\r\n    {{#state.isGeolocationAvailable}}\r\n      <a class="current-location-link with-geolocation" data-id="{{props.id}}">Use my current location</a>\r\n    {{/state.isGeolocationAvailable}}\r\n    {{#props.nearestStores.length}}\r\n    <div class="block with-sm-margin-btm">\r\n      <div class="col-largeDesktop-7 col-desktop-7 col-tablet-7 col-mobile-12">\r\n        <p class="larger"><strong>Nearest availability to \'{{props.nearestStoreLookup}}\'</strong></p>\r\n      </div>\r\n      {{#props.showInStockOnlyCheckbox}}\r\n      <div class="element-wrapper in-stock-filter-checkbox-wrapper">\r\n        <label for="in-stock-filter-checkbox" class="pull-right-all pull-left-mobile">\r\n          <input type="checkbox" id="in-stock-filter-checkbox" class="in-stock-filter-checkbox" {{#state.isInStockOnly}}checked="checked"{{/state.isInStockOnly}} data-id="{{props.id}}">\r\n          <div class="check-box"></div>\r\n          <div class="label">In stock stores only</div>\r\n        </label>\r\n      </div>\r\n      {{/props.showInStockOnlyCheckbox}}\r\n    </div>\r\n    <div class="block stores-list-wrapper">\r\n      <ul>\r\n        {{#props.nearestStores}}\r\n        <li id="store-{{id}}" class="stores-list-item {{stockStatusClass}} {{#isSelected}}is-selected{{/isSelected}}" data-storeid="{{id}}">\r\n          <a id="{{index}}" class="store-detail-link" data-index="{{index}}">\r\n            <span class="store-index">{{position}}</span>\r\n            <span class="store-name col-tablet-12">{{storeName}}</span>\r\n            <span class="stock-status col-tablet-4 col-mobile-6">{{stockStatusMessage}}</span>\r\n            {{#distance}}<span class="store-distance col-tablet-4 col-mobile-6">{{distance}}</span>{{/distance}}\r\n            <span class="view-store-info-toggle col-tablet-4 col-mobile-12"><span>View store info</span></span>\r\n          </a>\r\n          <div class="store-details-wrapper">\r\n            <div class="hidden-tablet hidden-mobile">\r\n              <p>Your selected store:</p>\r\n              <h5 class="with-margin-btm">\r\n                <span class="tableIndex">{{position}}</span>\r\n                <strong>{{storeName}}</strong>\r\n                {{#distance}}<span class="store-detail-distance">{{distance}}</span>{{/distance}}\r\n              </h5>\r\n            </div>\r\n            <div class="store-address-collection-times">\r\n              <div class="col-largeDesktop-6 col-desktop-6 col-tablet-6">\r\n                <h6 class="text">Address &amp; telephone</h6>\r\n                <address itemprop="address" itemscope="itemscope" itemtype="http://schema.org/PostalAddress" class="text smaller">\r\n                  {{#addressOne}}<span itemprop="streetAddress">{{addressOne}}</span>{{/addressOne}}\r\n                  {{#addressTwo}}<span itemprop="streetAddress">{{addressTwo}}</span>{{/addressTwo}}\r\n                  {{#townCity}}<span itemprop="addressLocality">{{townCity}}</span>{{/townCity}}\r\n                  {{#county}}<span itemprop="addressRegion">{{county}}</span>{{/county}}\r\n                  {{#postalCode}}<span itemprop="postalCode">{{postalCode}}</span>{{/postalCode}}\r\n                  {{#country}}<span itemprop="addressCountry">{{country}}</span>{{/country}}\r\n                </address>\r\n                {{#telephone}}\r\n                <p class="smaller with-margin-btm">{{telephone}}</p>\r\n                {{/telephone}}\r\n                <p class="smaller with-margin-btm hidden-largeDesktop hidden-desktop">\r\n                  <a href="//tesco.com/store-locator/uk/?bID={{bid}}" target="_blank" class="tesco-store-locator-link">\r\n                    View map &amp; full store information</a>\r\n                </p>\r\n              </div>\r\n              <div class="col-largeDesktop-6 col-desktop-6 col-tablet-6">\r\n                <h6 class="text">Collection times</h6>\r\n                <table class="store-collection-times text smaller">\r\n                  <thead class="hidden-all">\r\n                    <tr>\r\n                      <th scope="col" class="day">Day</th>\r\n                      <th scope="col">Open</th>\r\n                      <th scope="col">Closed</th>\r\n                    </tr>\r\n                  </thead>\r\n                  <tbody>\r\n                    <tr>\r\n                      <td class="day">Monday</td>\r\n                      <td>{{monOpen}}</td>\r\n                      <td>{{monClose}}</td>\r\n                    </tr>\r\n                    <tr>\r\n                      <td class="day">Tuesday</td>\r\n                      <td>{{tueOpen}}</td>\r\n                      <td>{{tueClose}}</td>\r\n                    </tr>\r\n                    <tr>\r\n                      <td class="day">Wednesday</td>\r\n                      <td>{{wedOpen}}</td>\r\n                      <td>{{wedClose}}</td>\r\n                    </tr>\r\n                    <tr>\r\n                      <td class="day">Thursday</td>\r\n                      <td>{{thuOpen}}</td>\r\n                      <td>{{thuClose}}</td>\r\n                    </tr>\r\n                    <tr>\r\n                      <td class="day">Friday</td>\r\n                      <td>{{friOpen}}</td>\r\n                      <td>{{friClose}}</td>\r\n                    </tr>\r\n                    <tr>\r\n                      <td class="day">Saturday</td>\r\n                      <td>{{satOpen}}</td>\r\n                      <td>{{satClose}}</td>\r\n                    </tr>\r\n                    <tr>\r\n                      <td class="day">Sunday</td>\r\n                      <td>{{sunOpen}}</td>\r\n                      <td>{{sunClose}}</td>\r\n                    </tr>\r\n                  </tbody>\r\n                </table>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </li>\r\n        {{/props.nearestStores}}\r\n      </ul>\r\n    </div>\r\n    {{/props.nearestStores.length}}\r\n    {{#props.showMoreStoresButton}}\r\n    <a class="check-more-stores-link button secondary" data-id="{{props.id}}">Check more stores</a>\r\n    {{/props.showMoreStoresButton}}\r\n    <p class="smaller">Stock levels may change by the time you arrive at the store. Store and online prices may vary. We don\'t stock this item in our smaller stores (Express and Metro)</p>\r\n  </div>\r\n</div>\r\n<div class="col-largeDesktop-5 col-desktop-5">\r\n  <div class="map-col-wrapper">\r\n    <div id="stockMapDetails">\r\n      <div id="mapContainer"></div>\r\n    </div>\r\n    <div class="selected-store-details-wrapper"></div>\r\n  </div>\r\n</div>\r\n{{{oEvent}}}{{{addViewDataAttr}}}\r\n';});

define('modules/pdp/controllers/StoreStockCheckController',['require','exports','module','modules/mvc/fn','modules/pdp/controllers/BaseController','modules/pdp/views/StoreStockCheckView','modules/common','mustache','modules/tesco.analytics','text!templates/views/storeStockCheckOverlay.html'],function (require, exports, module) {
  'use strict';


  var fn = require('modules/mvc/fn'),
    BaseController = require('modules/pdp/controllers/BaseController'),
    StoreStockCheckView = require('modules/pdp/views/StoreStockCheckView'),
    common = require('modules/common'),
    mustache = require('mustache'),
    analytics = require('modules/tesco.analytics'),
    overlayTemplate = require('text!templates/views/storeStockCheckOverlay.html');


  /**
   *
   * @param {Array<Objects>} models
   * @param {Object} options
   * @return {void}
   */
  function StoreStockCheckController(models, options) {
    this.sNamespace = 'stores';
    this.sTag = 'storeStockCheck';
    this.views = { classes: { StoreStockCheckView: StoreStockCheckView } };
    this.parent.constructor.call(this, models, options);
    this._viewData = {
      state: {
        overlayEventsBound: false,
        isInStockOnly: true,
        isGeolocationAvailable: null,
        isSessionDataAvailable: null
      },
      props: { hasOutOfStockStores: false },
      overlay: { oElms: { elPostcodeInput: null, elCheckBtn: null } },
      stores: {},
      deviceLocation: {}
    };
  }


  fn.inherit(StoreStockCheckController, BaseController);
  StoreStockCheckController.modelNames = ['stores', 'inventoryStore', 'sku'];


  /**
   *
   * @return {void}
   */
  StoreStockCheckController.prototype.initDependancies = function () {
    this._submitAnalyticsHandler('pageLoad');
  };


  /**
   *
   * @param {Object} params
   * @param {JQueryDeferred} params.deferred
   * @param {Object} params.mParamData
   * @return {void}
   */
  StoreStockCheckController.prototype._collateDataDependancies = function (params) {
    var _this = this,
      _params = params,
      masterDeferred = params.deferred,
      viewData = null,
      mvcData = _params.mParamData.mvc;

    if (!this._isPCAEndpointAvailable()) {
      masterDeferred.reject();
      return;
    }

    if (_this._isSessionDataAvailable()) {
      _this._getStoreStockData({ listingID: mvcData.sellers.id })
        .done(function handleGetStoreStockDataSuccess(data) {
          if (fn.isArray(data)) {
            viewData = _this._sanitiseViewData(data, mvcData.sellers.id);
            mvcData.stores = viewData;
            _this._cacheViewData(viewData);
          }
          masterDeferred.resolve(_params);
        })
        .fail(function handleGetStoreStockDataFailure() {
          masterDeferred.resolve(_params);
        });
    } else {
      masterDeferred.resolve(_params);
    }
  };


  /**
   *
   * @return {Boolean}
   */
  StoreStockCheckController.prototype._isPCAEndpointAvailable = function () {
    return !!fn.getValue(window, 'Data', 'storeStockCheck', 'pcaGeoLocationEndpoint')
      && !!fn.getValue(window, 'Data', 'storeStockCheck', 'pcaGeoLocationKey');
  };


  /**
   *
   * @return {Boolean}
   */
  StoreStockCheckController.prototype._isSessionDataAvailable = function () {
    return this._hasNearestStoreLookup() && this._hasCoordinates() && this._hasNearestStoreIDs();
  };


  /**
   *
   * @return {Boolean}
   */
  StoreStockCheckController.prototype._hasNearestStoreLookup = function () {
    return !!fn.getSessionData('nearestStoreLookup');
  };


  /**
   *
   * @return {Boolean}
   */
  StoreStockCheckController.prototype._hasCoordinates = function () {
    return !!fn.getSessionData('latitude') && !!fn.getSessionData('longitude');
  };


  /**
   *
   * @return {Boolean}
   */
  StoreStockCheckController.prototype._hasNearestStoreIDs = function () {
    return !!fn.getSessionData('nearestStoreIDs');
  };


  /**
   *
   * @param {Object} params
   * @param {string} params.listingID
   * @param {string} [params.location]
   * @param {boolean} [params.useDeviceLocation]
   * @return {JQueryPromise}
   */
  StoreStockCheckController.prototype._getStoreStockData = function (params) {
    var _this = this,
      deferred = $.Deferred(),
      newLookup = false,
      nearestStoreLookup = fn.getSessionData('nearestStoreLookup'),
      storeStockData = {},
      useDeviceLocation = false;

    if (!nearestStoreLookup || (params.location && params.location !== nearestStoreLookup)) {
      newLookup = true;
    }

    if (params.useDeviceLocation) {
      useDeviceLocation = true;
    }

    this._getCoordinates(params.location,
      { newLookup: newLookup, useDeviceLocation: useDeviceLocation })
      .done(function handleGetCoordinatesSuccess(coordinates) {
        _this._getNearestStoreIDs(coordinates, { newLookup: newLookup })
          .done(function handleGetNearestStoreIDsSuccess(storeIDs) {
            _this._getStoresData(storeIDs, params.listingID)
              .done(function handleGetStoresDataSuccess() {
                storeStockData = _this._mergeStoreInfoAndAvailabilityData(coordinates);

                if (newLookup && fn.isArray(storeStockData, { notEmpty: true })) {
                  _this._setSessionData(params.location, coordinates, storeIDs, storeStockData[0]);
                }

                deferred.resolve(storeStockData);
              })
              .fail(function handleGetStoresDataFailure() {
                deferred.reject();
              });
          })
          .fail(function handleGetNearestStoreIDsFailure() {
            deferred.reject();
          });
      })
      .fail(function handleGetCoordinatesFailure(errorMessage) {
        deferred.reject(errorMessage);
      });

    return deferred.promise();
  };


  /**
   * Get coordinates from cache data.
   *
   * @param {string} location
   * @param {Object} [opts]
   * @param {boolean} [opts.newLookup]
   * @param {boolean} [opts.useDeviceLocation]
   * @return {JQueryPromise}
   */
  StoreStockCheckController.prototype._getCoordinates = function (location, opts) {
    var _opts = opts || {},
      deferred = $.Deferred(),
      coordinates = {};

    if (_opts.useDeviceLocation) {
      coordinates.latitude = this._viewData.deviceLocation.latitude;
      coordinates.longitude = this._viewData.deviceLocation.longitude;
      deferred.resolve(coordinates);
      return deferred.promise();
    }

    if (!_opts.newLookup && this._hasCoordinates()) {
      coordinates.latitude = fn.getSessionData('latitude');
      coordinates.longitude = fn.getSessionData('longitude');
      deferred.resolve(coordinates);
      return deferred.promise();
    }

    this._fetchCoordinates(location)
      .done(function handleFetchCoordinatesSuccess(latitude, longitude) {
        coordinates.latitude = latitude;
        coordinates.longitude = longitude;
        deferred.resolve(coordinates);
      })
      .fail(function handleFetchCoordinatesFailure() {
        deferred.reject();
      });

    return deferred.promise();
  };


  /**
   * Make call to Postcode Anywhere API to return coordinates based on location name.
   *
   * @param {string} location
   * @returns {JQueryPromise}
   */
  StoreStockCheckController.prototype._fetchCoordinates = function (location) {
    var deferred = $.Deferred(),
      storeStockCheckData = null,
      endpoint = null,
      key = null;

    if (typeof location !== 'string' || location === '') {
      deferred.reject();
      return false;
    }

    if (!this._isPCAEndpointAvailable()) {
      deferred.reject();
      return false;
    }

    storeStockCheckData = fn.getValue(window, 'Data', 'storeStockCheck');
    endpoint = storeStockCheckData.pcaGeoLocationEndpoint;
    key = storeStockCheckData.pcaGeoLocationKey;

    $.getJSON(endpoint, { Key: key, Location: location })
      .done(function handleFetchCoordinatesSuccess(data) {
        if (data.Items.length === 1 && typeof data.Items[0].Error !== 'undefined') {
          deferred.reject(data.Items[0].Description);
        } else if (data.Items.length === 0) {
          deferred.reject();
        } else {
          deferred.resolve(data.Items[0].Latitude, data.Items[0].Longitude);
        }
      })
      .fail(function handleFetchCoordinatesFailure() {
        deferred.reject();
      });

    return deferred.promise();
  };


  /**
   *
   * @param {Object} coordinates
   * @param {number} coordinates.latitude
   * @param {number} coordinates.longitide
   * @param {Object} [opts]
   * @param {boolean} [opts.newLookup]
   * @return {JQueryPromise}
   */
  StoreStockCheckController.prototype._getNearestStoreIDs = function (coordinates, opts) {
    var _opts = opts || {},
      deferred = $.Deferred(),
      storeIDs = '';

    if (!_opts.newLookup && this._hasNearestStoreIDs()) {
      storeIDs = fn.getSessionData('nearestStoreIDs');
      deferred.resolve(storeIDs);
      return deferred.promise();
    }

    this.models.stores
      .promise({
        mSearchValue: [coordinates.latitude, coordinates.longitude],
        doneCallback: function (data, _deferred) { _deferred.resolve(data); }
      })
      .done(function handlePromiseSuccess(data) {
        storeIDs = data.stores.map(function (store) { return store.id; }).join(',');
        deferred.resolve(storeIDs);
      })
      .fail(function handlePromiseFailure() {
        deferred.reject();
      });

    return deferred.promise();
  };


  /**
   *
   * @param {Array<String>} storeIDs
   * @param {String} listingID
   * @return {void}
   */
  StoreStockCheckController.prototype._getStoresData = function (storeIDs, listingID) {
    var deferred = $.Deferred();

    $.when(this._fetchStoreInfo(storeIDs), this._fetchAvailability(storeIDs, listingID))
      .done(function handlePromiseSuccess() {
        deferred.resolve();
      })
      .fail(function handlePromiseFailure() {
        deferred.reject();
      });

    return deferred.promise();
  };


  /**
   *
   * @param {Array<String>} storeIDs
   * @return {JQueryPromise}
   */
  StoreStockCheckController.prototype._fetchStoreInfo = function (storeIDs) {
    var _this = this;

    _this.models.stores.unsetDataStores();

    return this.models.stores.promise({
      mSearchValue: storeIDs,
      sModelMethod: 'storeDetails',
      progressCallback: function (searchValue, resp) {
        if (resp.results) {
          _this.models.stores.setDataStores(resp.results);
        }
      },
      doneCallback: function (response, deferred) {
        deferred.resolve(response);
      }
    });
  };


  /**
   *
   * @param {Array<String>} storeIDs
   * @param {String} listingID
   * @return {JQueryPromise}
   */
  StoreStockCheckController.prototype._fetchAvailability = function (storeIDs, listingID) {
    this.models.inventoryStore.unsetDataStores();

    return this.models.inventoryStore.promise({
      mSearchValue: [storeIDs, listingID],
      doneCallback: function (response, deferred) {
        deferred.resolve(response);
      }
    });
  };


  /**
   * Merge store info with availability data.
   *
   * @param {Object} coordinates
   * @return {Array<Object>}
   */
  StoreStockCheckController.prototype._mergeStoreInfoAndAvailabilityData = function (coordinates) {
    var inventoryStoreModel = this.models.inventoryStore,
      storesModel = this.models.stores,
      storeDetails = storesModel.getDataStores(),
      availabilities = inventoryStoreModel.getDataStores(),
      mergedData = [],
      unavailabilityCount = 0;

    storeDetails.map(function (store) {
      var _store = store,
        distance = null,
        storeAvailability = null;

      distance = storesModel.calculateDistance(coordinates, {
        latitude: _store.latitude, longitude: _store.longitude
      });

      _store.distance = typeof distance === 'number' ? distance.toFixed(2) + ' miles' : null;

      fn.loopArray(availabilities, function loopAvailabilities(i) {
        if (_store.id === availabilities[i].id) {
          storeAvailability = fn.mergeObjects(_store, availabilities[i]);
          mergedData.push(storeAvailability);

          if (!storeAvailability.available) {
            unavailabilityCount += 1;
          }
        }
      });

      return _store;
    });

    this._viewData.props.hasOutOfStockStores = unavailabilityCount > 0;

    return unavailabilityCount === mergedData.length ? [] : mergedData;
  };


  /**
   * Save store stock check data to session storage.
   *
   * @param {string} location
   * @param {Object} coordinates
   * @param {number} coordinates.latitude
   * @param {number} coordinates.longitude
   * @param {Array<string>} storeIDs
   * @param {Object} sessionStoreData
   * @return {void}
   */
  StoreStockCheckController.prototype._setSessionData = function (
    location, coordinates, storeIDs, sessionStoreData
  ) {
    fn.setSessionData('nearestStoreLookup', location);
    fn.setSessionData('latitude', coordinates.latitude);
    fn.setSessionData('longitude', coordinates.longitude);
    fn.setSessionData('nearestStoreIDs', storeIDs);
    fn.setSessionData('sessionStoreData', {
      postCode: location,
      name: sessionStoreData.storeName,
      distance: sessionStoreData.distance
    });

    this._viewData.state.isSessionDataAvailable = true;
  };


  /**
   *
   * @param {Array<Object>} data
   * @param {string} id
   * @return {Object}
   */
  StoreStockCheckController.prototype._sanitiseViewData = function (data, id) {
    return {
      id: id,
      nearestStores: data,
      nearestStoreLookup: fn.getSessionData('nearestStoreLookup'),
      nearestStore: this._getNearestStore(data),
      sessionStoreData: fn.getSessionData('sessionStoreData')
    };
  };


  /**
   *
   * @param {Array<Object>} stores
   * @return {Object}
   */
  StoreStockCheckController.prototype._getNearestStore = function (stores) {
    var i = 0,
      arrLength = 0,
      store = null;

    for (i, arrLength = stores.length; i < arrLength; i += 1) {
      store = stores[i];

      if (store.available) {
        return {
          name: store.storeName,
          distance: store.distance,
          postCode: fn.getSessionData('nearestStoreLookup'),
          stockStatus: store.stockStatusMessage
        };
      }
    }

    return null;
  };


  /**
   *
   * @param {Object} params
   * @param {Object} params.oView
   * @return {void}
   */
  StoreStockCheckController.prototype._bindViewEvents = function (params) {
    var view = params.oView,
      $form = $(view.oElms.elForm),
      $wrapper = $(view.oElms.elWrapper);

    this._activeView = view;

    $form
    .on('submit', this._handleCheckStockSubmit.bind(this))
    .on('focus', 'input.postcode', this._removeInvalidClass.bind(this));

    $wrapper
    .on('click', 'a.change-store-link', this._changeStoreLinkHandler.bind(this))
    .on('click', 'a.current-location-link', this._currentPositionHandler.bind(this));
  };


  /**
   *
   * @param {JQueryEvent} e
   * @return {void}
   */
  StoreStockCheckController.prototype._handleCheckStockSubmit = function (e) {
    var _this = this,
      eventData = e.data || {},
      inPanel = !!fn.isObject(this._activePanel.storeStockCheck, { notEmpty: true }),
      panelContent = inPanel ? this._activePanel.storeStockCheck.oElms.elContentWrapper : null,
      regex = /^[a-zA-Z][a-zA-Z0-9,-.'\s]+$/,
      view = this._activeView,
      MESSAGE = 'Please enter a valid town or postcode',
      id = eventData.listingID || $(e.currentTarget).data('id') || null,
      viewData = null,
      useDeviceLocation = eventData.useDeviceLocation || false,
      overlay = _this._viewData.overlay,
      location = inPanel ? overlay.oElms.elPostcodeInput.value
        : view.oElms.elPostcodeInput.value || '';

    e.preventDefault();

    if (!location.match(regex)) {
      this._renderTooltip(MESSAGE);
      return;
    }

    if (inPanel) {
      $(panelContent).addClass('with-bkg-loader');
    } else {
      $(view.oElms.elCheckBtn).addClass('submitting');
    }

    this._getStoreStockData({
      listingID: id, location: location, useDeviceLocation: useDeviceLocation
    })
      .done(function handleGetStoreStockDataSuccess(data) {
        if (!fn.isArray(data, { notEmpty: true })) {
          _this._renderTooltip();
          return;
        }

        viewData = _this._sanitiseViewData(data, id);

        _this._cacheViewData(viewData);
        _this._refreshView(view, viewData);
        _this._renderOverlay({ updateActive: !!eventData.updateActive, vm: viewData });
      })
      .fail(function handleGetStoreStockDataFailure(errorMessage) {
        _this._renderTooltip(errorMessage);
      })
      .always(function handleGetStoreStockDataAlways() {
        if (inPanel) {
          $(panelContent).removeClass('with-bkg-loader');
        } else {
          $(view.oElms.elCheckBtn).removeClass('submitting');
        }
      });
  };


  /**
   *
   * @param {JQueryEvent} e
   * @return {void}
   */
  StoreStockCheckController.prototype._removeInvalidClass = function (e) {
    var $currentTarget = $(e.currentTarget);

    if ($currentTarget.hasClass('invalid')) {
      $currentTarget.removeClass('invalid');
    }
  };


  /**
   *
   * @param {JQueryEvent} e
   * @return {void}
   */
  StoreStockCheckController.prototype._changeStoreLinkHandler = function (e) {
    var viewData = this._getViewData($(e.currentTarget).data('id'));

    this._renderOverlay({ vm: viewData });
  };


  /**
   *
   * @param {String} message
   * @return {void}
   */
  StoreStockCheckController.prototype._renderTooltip = function (message) {
    var _message = '',
      inOverlay = this._activePanel && this._activePanel.storeStockCheck,
      postcodeInput = inOverlay ? this._viewData.overlay.oElms.elPostcodeInput
        : this._activeView.oElms.elPostcodeInput;

    if (!message) {
      _message = 'Sorry, this product isn\'t stocked in stores in or near ' + postcodeInput.value;
    } else {
      _message = message;
    }

    if (inOverlay) {
      this.oTooltipStyles = { allDesktops: ['tooltip-bottom'], allDevices: ['tooltip-bottom'] };
    } else {
      this.oTooltipStyles = { allDesktops: ['tooltip-left'], allDevices: ['tooltip-bottom'] };
    }

    this.createTooltip({ sTooltopMessage: _message, elTrigger: postcodeInput, sType: 'error' });

    $(postcodeInput).addClass('invalid');
  };


  /**
   *
   * @param {Object} view
   * @param {Object} data
   * @return {void}
   */
  StoreStockCheckController.prototype._refreshView = function (view, data) {
    if (fn.isObject(view)) {
      view.refresh(data);
    }
  };


  /**
   *
   * @param {Object} params optional
   * @param {Boolean} params.updateActive
   * @return {void}
   */
  StoreStockCheckController.prototype._renderOverlay = function (params) {
    var _this = this,
      _params = params || {},
      location = fn.getSessionData('nearestStoreLookup'),
      markup = '',
      overlayParams = {},
      vmData = params.vm || {},
      listingID = vmData.id;

    markup = mustache.render(overlayTemplate, this._prepareViewData(vmData));

    overlayParams = {
      sTag: 'storeStockCheck',
      sClassNames: 'store-stock-check-overlay',
      oStyles: {
        allDesktops: ['lightbox', 'fullScreen'],
        allDevices: ['slideIn-left', 'fullScreen']
      },
      sTitle: location ? 'Stores near <strong class="store-name-header">' + location + '</strong>'
        : 'Check store stock',
      sOverlayContent: markup,
      toDestroyOnClose: true,
      callback: function (overlaySelector) {
        _this._initOverlayDependencies({ selector: overlaySelector, vm: vmData });
        if (!params.noAnalytics) {
          _this._submitAnalyticsHandler('storeStockOverlayOpen', listingID);
        }
      }
    };

    if (_params.updateActive) {
      overlayParams.updateActive = true;
      overlayParams.elTrigger = null;
      overlayParams.forceUpdateActive = true;
    } else {
      this._viewData.state.overlayEventsBound = false;
    }

    this.renderOverlay(overlayParams);
  };


  /**
   *
   * @param {Object} viewData
   * @return {Object}
   */
  StoreStockCheckController.prototype._prepareViewData = function (viewData) {
    var _viewData = fn.copyObject(viewData, { deep: true }),
      stores = _viewData.nearestStores || [];

    _viewData.props = _viewData.props || {};
    _viewData.props.id = _viewData.id;
    _viewData.state = _viewData.state || {};
    _viewData.state.isInStockOnly = this._viewData.state.isInStockOnly;

    if (this._viewData.state.isGeolocationAvailable === null) {
      this._viewData.state.isGeolocationAvailable
      = !window.isKiosk() && fn.isGeolocationAvailable();
    }

    _viewData.state.isGeolocationAvailable = this._viewData.state.isGeolocationAvailable;

    if (!stores.length) {
      return _viewData;
    }

    if (this._viewData.state.isInStockOnly) {
      stores = this._filterInStockStores(stores);
    }

    fn.loopArray(stores, function loopStores(i) {
      stores[i].index = i;
      stores[i].position = i + 1;
      stores[i].stockStatusClass = stores[i].stockStatusMessage.toLowerCase().replace(/ /gi, '-');
      stores[i].bid = stores[i].id.substring(1);
    });

    stores[0].isSelected = true;
    _viewData.props.nearestStoreLookup = _viewData.nearestStoreLookup;
    _viewData.props.showInStockOnlyCheckbox = this._viewData.props.hasOutOfStockStores;
    _viewData.props.showMoreStoresButton = stores.length > 5;
    _viewData.props.nearestStores = stores;

    return _viewData;
  };


  /**
   * Returns array of stores that have stock availability.
   *
   * @param {Array<Object>} stores
   * @return {Array<Object>}
   */
  StoreStockCheckController.prototype._filterInStockStores = function (stores) {
    return stores.filter(function isAvailable(store) {
      return store.available;
    });
  };


  /**
   *
   * @param {Object} params
   * @param {string} params.selector
   * @param {Object} params.vm
   * @return {void}
   */
  StoreStockCheckController.prototype._initOverlayDependencies = function (params) {
    var $overlay = $(params.selector),
      $mapContainer = $overlay.find('#mapContainer'),
      $mapParentContainer = $overlay.find('#stockMapDetails'),
      storesLocation = this._collateMapPinLocations(params.vm),
      map = null,
      data = {},
      markup = null;

    map = common.getMap($mapParentContainer, $mapContainer, storesLocation);
    map.setView({ zoom: 5 });

    data = { overlaySelector: params.selector, storesLocation: storesLocation, map: map };

    this._initMapStores(data);
    this._cacheOverlayDomElms(params.selector);
    this._bindOverlayEvents(data);

    if (storesLocation.length) {
      markup = $overlay.find('li.is-selected div.store-details-wrapper')[0].innerHTML;
      $overlay.find('div.selected-store-details-wrapper').html(markup);
    }
  };


  /**
   *
   * @param {Object} vmData
   * @return {Array<Object>}
   */
  StoreStockCheckController.prototype._collateMapPinLocations = function (vmData) {
    var activeViewData = vmData || {},
      locations = [],
      stores = [];

    if (!activeViewData.nearestStores) {
      return locations;
    }

    stores = this._viewData.state.isInStockOnly
      ? this._filterInStockStores(activeViewData.nearestStores) : activeViewData.nearestStores;

    fn.loopArray(stores, function loopNearestStores(i) {
      locations.push(new Microsoft.Maps.Location(stores[i].latitude, stores[i].longitude));
    });

    return locations;
  };


  /**
   *
   * @param {Object} params
   * @param {String} params.overlaySelector
   * @param {Object} params.map
   * @param {Array<Object>} params.storesLocation
   * @return {void}
   */
  StoreStockCheckController.prototype._initMapStores = function (params) {
    var MAX_STORES_PER_PAGE = 5,
      $overlay = $(params.overlaySelector),
      $storeContainer = $overlay.find('div.stores-list-wrapper li'),
      storesLocation = params.storesLocation,
      numOfPins = storesLocation.length < MAX_STORES_PER_PAGE
        ? storesLocation.length : MAX_STORES_PER_PAGE;

    if ($storeContainer.length > MAX_STORES_PER_PAGE) {
      $overlay.find('li:gt(4)').hide();
    }

    fn.loopArray.call(this, storesLocation, function loopNumOfPins(i) {
      this._createPin({
        activePinIndex: 0,
        index: i,
        map: params.map,
        storesArray: $storeContainer,
        storesLocation: storesLocation
      });
    }, { stop: numOfPins });
  };


  /**
   *
   * @param {Object} params
   * @param {Number} params.activePinIndex
   * @param {Number} params.index
   * @param {Object} params.map
   * @param {Array<Object>} params.storesArray
   * @param {Array<Object>} params.storesLocation
   * @return {void}
   */
  StoreStockCheckController.prototype._createPin = function (params) {
    var _this = this,
      activePinIndex = params.activePinIndex,
      index = params.index,
      map = params.map,
      storesArray = params.storesArray,
      storesLocation = params.storesLocation,
      pushpinOptions = {},
      pin = {},
      pinClickParams = {};

    pushpinOptions = {
      icon: activePinIndex === index
        ? window.globalStaticAssetsPath + 'map-pin-selected.png'
        : window.globalStaticAssetsPath + 'map-pin.png',
      width: 27,
      height: 42,
      typeName: activePinIndex === index ? 'map-pin-selected' : 'map-pin',
      textOffset: new Microsoft.Maps.Point(0, 6),
      text: (index + 1).toString()
    };

    pin = new Microsoft.Maps.Pushpin(storesLocation[index], pushpinOptions);
    map.entities.push(pin);

    this._createInfoBox({
      activePinIndex: activePinIndex,
      map: map,
      storesArray: storesArray,
      storesLocation: storesLocation
    });

    Microsoft.Maps.Events.addHandler(pin, 'click', function (e) {
      pinClickParams = {
        pin: pin,
        ev: e.originalEvent,
        map: map,
        storesLocation: storesLocation,
        storesArray: storesArray
      };
      activePinIndex = parseInt(pin._text, 10) - 1;
      _this._mapPinClick(pinClickParams);
    });
  };


  /**
   *
   * @param {Object} params
   * @param {Number} params.activePinIndex
   * @param {Object} params.map
   * @param {Array<Object>} params.storesArray
   * @param {Array<Object>} params.storesLocation
   * @return {void}
   */
  StoreStockCheckController.prototype._createInfoBox = function (params) {
    var infoboxOptions = null,
      infoboxContent = '',
      entity = null,
      infobox = null,
      i = 0,
      activePinIndex = params.activePinIndex,
      map = params.map,
      storesArray = params.storesArray,
      storesLocation = params.storesLocation,
      arrLength = 0;

    infoboxContent = '<strong>' + storesArray.eq(activePinIndex).find('.store-name').html()
      + '</strong><br>(' + storesArray.eq(activePinIndex).find('.store-distance').html() + ')';

    infoboxOptions = {
      visible: true,
      offset: new Microsoft.Maps.Point(-10, 30),
      showCloseButton: true,
      height: 76,
      width: 194,
      description: infoboxContent
    };

    for (i, arrLength = map.entities.getLength(); i < arrLength; i += 1) {
      entity = map.entities.get(i);
      if (entity._typeName === 'Infobox' && entity._options.visible) {
        entity.setOptions({ visible: false });
      }
    }

    infobox = new Microsoft.Maps.Infobox(storesLocation[activePinIndex], infoboxOptions);
    map.entities.push(infobox);
    map.setView({
      center: infobox.getLocation(), centerOffset: new Microsoft.Maps.Point(-15, 35), zoom: 9
    });
  };


  /**
   *
   * @param {Object} params
   * @param {Object} params.pin
   * @param {Object} params.map
   * @param {Array<Object>} params.storesArray
   * @param {Array<Object>} params.storesLocation
   * @return {void}
   */
  StoreStockCheckController.prototype._mapPinClick = function (params) {
    var clickedIndex = parseInt(params.pin._text, 10) - 1,
      storeDetails = params.storesArray.eq(clickedIndex).find('div.store-details-wrapper').html(),
      storeTimings = $('div.selected-store-details-wrapper'),
      i = 0,
      entity = null,
      pinText = null,
      clickedStoreDetails = params.storesArray.eq(clickedIndex),
      storesHolder = $('div.stores-list-wrapper'),
      arrLength = 0;

    params.storesArray.removeClass('is-selected');
    clickedStoreDetails.addClass('is-selected');
    storeTimings.html(storeDetails);

    this._createInfoBox({
      activePinIndex: clickedIndex,
      map: params.map,
      storesArray: params.storesArray,
      storesLocation: params.storesLocation
    });

    if (parseInt(params.pin._text, 10) > 5) {
      storesHolder.scrollTop($('div.stores-list-wrapper')[0].scrollHeight);
    } else {
      storesHolder.scrollTop(0);
    }

    for (i, arrLength = params.map.entities.getLength(); i < arrLength; i += 1) {
      pinText = params.map.entities.get(i)._text;
      entity = params.map.entities.get(i);

      if (entity._typeName === 'map-pin' && params.pin._text === pinText) {
        entity.setOptions({
          icon: window.globalStaticAssetsPath + 'map-pin-selected.png', typeName: 'map-pin-selected'
        });
      }

      if (entity._typeName === 'map-pin-selected' && params.pin._text !== pinText) {
        entity.setOptions({
          icon: window.globalStaticAssetsPath + 'map-pin.png', typeName: 'map-pin'
        });
      }
    }
  };


  /**
   *
   * @param {string} selector
   * @return {void}
   */
  StoreStockCheckController.prototype._cacheOverlayDomElms = function (selector) {
    var $overlay = $(selector),
      elms = this._viewData.overlay.oElms;

    elms.elForm = $overlay.find('form.stock-check-form')[0];
    elms.elCheckBtn = $overlay.find('input.button')[0];
    elms.elPostcodeInput = $overlay.find('input.postcode')[0];
    elms.elInStockCheckbox = $overlay.find('input.in-stock-filter-checkbox')[0];
  };


  /**
   *
   * @param {Object} params
   * @param {String} params.overlaySelector
   * @return {void}
   */
  StoreStockCheckController.prototype._bindOverlayEvents = function (params) {
    var $overlay = $(params.overlaySelector);

    if (!this._viewData.state.overlayEventsBound) {
      $overlay
      .on('submit', 'form.stock-check-form', { overlaySelector: params.overlaySelector },
        this._handleOverlayStockCheckSubmit.bind(this))
      .on('focus', 'input.postcode', this._removeInvalidClass.bind(this))
      .on('click', 'span.view-store-info-toggle', this._storeInfoClick.bind(this))
      .on('change', 'input.in-stock-filter-checkbox',
        this._onInStockFilterCheckboxChange.bind(this))
      .on('click', 'a.current-location-link', { overlaySelector: params.overlaySelector },
        this._currentPositionHandler.bind(this));

      this._viewData.state.overlayEventsBound = true;
    }

    $overlay
    .find('a.store-detail-link')
    .on('click', params, this._storeLinkClick.bind(this));

    $overlay
    .find('a.check-more-stores-link')
    .on('click', params, this._displayMoreStoresHandler.bind(this));
  };


  /**
   *
   * @param {JQueryEvent} e
   * @return {void}
   */
  StoreStockCheckController.prototype._handleOverlayStockCheckSubmit = function (e) {
    var _event = e;

    e.preventDefault();

    _event.data = e.data || {};
    _event.data.updateActive = true;
    _event.data.listingID = $(e.currentTarget).data('id');

    if (document.activeElement && document.activeElement.type === 'text') {
      document.activeElement.blur();
    }

    this._handleCheckStockSubmit(_event);
  };


  /**
   *
   * @param {JQueryEvent} e
   * @return {void}
   */
  StoreStockCheckController.prototype._storeInfoClick = function (e) {
    var $viewStoreInfoLink = $(e.currentTarget),
      $ViewStoreInfoLinkText = $viewStoreInfoLink.find('span'),
      $storeDetailsWrapper = $viewStoreInfoLink
        .parent('a.store-detail-link')
        .next('div.store-details-wrapper');

    if ($viewStoreInfoLink.hasClass('open')) {
      $viewStoreInfoLink.removeClass('open');
      $ViewStoreInfoLinkText.text('Hide store info');
      $storeDetailsWrapper.removeClass('is-expanded');
    } else {
      $viewStoreInfoLink.addClass('open');
      $ViewStoreInfoLinkText.text('View store info');
      $storeDetailsWrapper.addClass('is-expanded');
    }
  };


  /**
   *
   * @param {JQueryEvent} e
   * @return {void}
   */
  StoreStockCheckController.prototype._onInStockFilterCheckboxChange = function (e) {
    var viewData = this._getViewData($(e.currentTarget).data('id'));

    this._viewData.state.isInStockOnly = e.currentTarget.checked;
    this._renderOverlay({ updateActive: true, vm: viewData, noAnalytics: true });
  };


  /**
   *
   * @param {JQueryEvent} e
   * @return {void}
   */
  StoreStockCheckController.prototype._storeLinkClick = function (e) {
    var currentElemIndex = parseInt(e.currentTarget.id, 10),
      $selectedStore = $('div.stores-list-wrapper ul li:nth-child(' + (currentElemIndex + 1) + ')'),
      storeDetails = $selectedStore.find('div.store-details-wrapper').html(),
      storeTimings = $('div.selected-store-details-wrapper'),
      storesArray = $('div.stores-list-wrapper ul li:visible'),
      i = 0,
      arrLength = 0;

    $('li.stores-list-item.is-selected').removeClass('is-selected');
    $(e.currentTarget).closest('li.stores-list-item').addClass('is-selected');
    storeTimings.html(storeDetails);

    this._createInfoBox({
      activePinIndex: currentElemIndex,
      map: e.data.map,
      storesArray: $('div.stores-list-wrapper li'),
      storesLocation: e.data.storesLocation
    });

    for (i, arrLength = storesArray.length; i < arrLength; i += 1) {
      this._createPin({
        activePinIndex: currentElemIndex,
        index: i,
        map: e.data.map,
        storesArray: storesArray,
        storesLocation: e.data.storesLocation
      });
    }
  };


  /**
   *
   * @param {JQueryEvent} e
   * @return {void}
   */
  StoreStockCheckController.prototype._displayMoreStoresHandler = function (e) {
    var $overlay = $(e.data.overlaySelector),
      $button = $(e.currentTarget),
      $listWrapper = $overlay.find('div.stores-list-wrapper'),
      $extraListItems = $listWrapper.find('li:gt(4)'),
      listLength = 0,
      i = 0,
      activePinIndex = $listWrapper.find('li.is-selected').index(),
      $wrapper = $overlay.find('div.col-stores-wrapper'),
      listingID = $button.data('id');

    e.preventDefault();

    $wrapper.addClass('with-bkg-loader').delay(300).queue(function () {
      $button.remove();
      $listWrapper.addClass('all-stores');
      $extraListItems.show(400, function () { $(this).removeAttr('style'); });
      $(this).removeClass('with-bkg-loader').dequeue();
      $listWrapper.animate({ scrollTop: $extraListItems.first().position().top }, 600);
    });

    for (i = 5, listLength = e.data.storesLocation.length; i < listLength; i += 1) {
      this._createPin({
        activePinIndex: activePinIndex,
        index: i,
        map: e.data.map,
        storesArray: $listWrapper.find('li'),
        storesLocation: e.data.storesLocation
      });
    }

    this._submitAnalyticsHandler('moreStoresButtonClick', listingID);
  };


  /**
   *
   * @param {string} type
   * @param {string} id
   * @return {void}
   */
  StoreStockCheckController.prototype._submitAnalyticsHandler = function (type, id) {
    var WebAnalytics = new analytics.WebMetrics(),
      props = null;

    switch (type) {
      case 'pageLoad':
        props = this._getPageLoadAnalytics();
        break;
      case 'storeStockOverlayOpen':
        props = this._getOverlayOpenAnalytics(id);
        break;
      case 'moreStoresButtonClick':
        this._setMoreStoresButtonAnalytics(id);
        break;
      case 'checkStoreStockLinkClick':
        this._setCheckStoreStockLinkAnalytics();
        break;
      default:
        props = null;
    }

    if (props !== null) {
      if (!window.pageLoadAnalyticsSuccess) {
        $(window).one('pageLoadAnalyticsSuccess',
        function storeStockCheckControllerAsyncAnalytics() {
          setTimeout(function () {
            WebAnalytics.submit([props]);
          }, 100);
        });
      } else {
        setTimeout(function () {
          WebAnalytics.submit([props]);
        }, 1000);
      }
    }
  };


  /**
   *
   * @return {Object}
   */
  StoreStockCheckController.prototype._getPageLoadAnalytics = function () {
    return {
      eVar17: 'store stock available',
      contextData: {
        content_module_impression: 1,
        content_module_name: 'Stock Checker'
      }
    };
  };


  /**
   *
   * @param {string} id
   * @return {?Object}
   */
  StoreStockCheckController.prototype._getOverlayOpenAnalytics = function (id) {
    var props = null,
      storesData = this._viewData.stores[id],
      stores = fn.isObject(storesData, { notEmpty: true }) ? storesData.nearestStores : [];

    if (stores.length) {
      props = {
        pageName: 'Check store',
        prop49: this._getStoreStockDataAnalytics({
          data: stores,
          stop: stores.length < 5 ? stores.length : 5
        }),
        prop50: stores.length
      };
    }

    return props;
  };


  /**
   *
   * @param {string} id
   * @return {void}
   */
  StoreStockCheckController.prototype._setMoreStoresButtonAnalytics = function (id) {
    var _s = fn.copyObject(window.s),
      storesData = this._viewData.stores[id],
      stores = fn.isObject(storesData, { notEmpty: true }) ? storesData.nearestStores : [];

    if (stores.length) {
      _s.linkTrackVars = 'events,prop49,prop50,eVar59';
      _s.linkTrackEvents = 'event19';
      _s.events = 'event19';
      _s.prop49 = this._getStoreStockDataAnalytics({ data: stores, start: 5, stop: stores.length });
      _s.prop50 = stores.length;
      _s.eVar59 = 'check more stores';

      try {
        _s.tl(true, 'o', 'check more stores');
      } catch (ex) {
        window.console.log('Adobe Custom Link Tracking failed with error ' + ex.message);
      }
    }
  };


  /**
   * Link tracking for Check store stock link on PLP
   *
   * @return {void}
   */
  StoreStockCheckController.prototype._setCheckStoreStockLinkAnalytics = function () {
    var _s = fn.copyObject(window.s);

    _s.linkTrackVars = 'events,eVar45,prop4,prop19';
    _s.linkTrackEvents = 'event107';
    _s.events = 'event107';
    _s.eVar45 = 'check store stock';
    _s.prop4 = 'plp';
    _s.prop19 = _s.eVar45;

    try {
      _s.tl(true, 'o', 'check store stock');
    } catch (ex) {
      window.console.log('Adobe Custom Link Tracking failed with error ' + ex.message);
    }
  };


  /**
   *
   * @param {Object} params
   * @param {Array<Object>} params.data
   * @param {number} [params.start=0]
   * @param {number} [params.stop=5]
   * @return {string}
   */
  StoreStockCheckController.prototype._getStoreStockDataAnalytics = function (params) {
    var _this = this,
      stores = params.data,
      startPos = params.start || 0,
      stopPos = params.stop || 5,
      store = {},
      stockLevel = null,
      position = 0,
      storeStockData = '',
      distance = '';

    fn.loopArray(stores, function loopStoresData(i) {
      store = stores[i];
      stockLevel = _this._getStockLevelAnalytics(store.stock_status);
      position = i + 1;
      distance = store.distance.substring(0, store.distance.indexOf(' '));
      storeStockData += store.storeId + '-' + stockLevel + '-' + distance + '-' + position;

      if (position < stopPos) {
        storeStockData += '|';
      }
    }, { start: startPos, stop: stopPos });

    return storeStockData;
  };


  /**
   *
   * @param {string} status
   * @return {?boolean}
   */
  StoreStockCheckController.prototype._getStockLevelAnalytics = function (status) {
    var stockLevel = null;

    switch (status) {
      case 'IN_STOCK':
        stockLevel = 1;
        break;
      case 'LOW_IN_STOCK':
        stockLevel = 2;
        break;
      case 'OUT_OF_STOCK':
        stockLevel = 0;
        break;
      default:
        stockLevel = null;
    }

    return stockLevel;
  };


  /**
   *
   * @return {void}
   */
  StoreStockCheckController.prototype._bindEvents = function () {
    if ($('#listing').length && this._isPCAEndpointAvailable()) {
      $(this.pageEventDelegator).on('click', 'a.check-store-stock-link',
      this._checkStoreStockLinkHandler.bind(this));
    }
  };


  /**
   *
   * @param {JQueryEvent} e
   * @return {void}
   */
  StoreStockCheckController.prototype._checkStoreStockLinkHandler = function (e) {
    var $link = $(e.currentTarget),
      id = $link.data('id'),
      nearestStoreLookup = '',
      _this = this,
      viewData = null,
      isSessionDataAvailable = this._viewData.state.isSessionDataAvailable;

    e.preventDefault();
    e.stopPropagation();

    this._submitAnalyticsHandler('checkStoreStockLinkClick');

    if (isSessionDataAvailable === null) {
      isSessionDataAvailable
      = this._viewData.state.isSessionDataAvailable
      = this._isSessionDataAvailable();
    }

    if (isSessionDataAvailable) {
      viewData = this._getViewData(id);
      nearestStoreLookup = fn.getSessionData('nearestStoreLookup');

      if (viewData && viewData.nearestStoreLookup === nearestStoreLookup) {
        _this._renderOverlay({ vm: viewData });
        return;
      }

      this._getStoreStockData({ location: nearestStoreLookup, listingID: id })
        .done(function handleGetStoreStockDataSuccess(data) {
          if (!fn.isArray(data, { notEmpty: true })) {
            _this._renderOverlay({ empty: true, vm: { id: id } });
            return;
          }

          viewData = _this._sanitiseViewData(data, id);

          _this._cacheViewData(viewData);
          _this._renderOverlay({ vm: viewData });
        })
        .fail(function handleGetStoreStockDataFailure(errorMessage) {
          _this._renderOverlay({ empty: true, vm: { id: id }, error: errorMessage });
        });
    } else {
      this._renderOverlay({ empty: true, vm: { id: id } });
    }
  };


  /**
   * Get stores view data from cache.
   *
   * @param {string} id
   * @returns {?object}
   */
  StoreStockCheckController.prototype._getViewData = function (id) {
    return fn.isObject(this._viewData.stores[id], { notEmpty: true })
      ? this._viewData.stores[id] : null;
  };


  /**
   * Save stores view data to cache.
   *
   * @param {object} data
   * @param {string} data.id
   * @returns {!object}
   */
  StoreStockCheckController.prototype._cacheViewData = function (data) {
    var stores = this._viewData.stores;

    if (!data || !data.id) return null;

    stores[data.id] = data;

    return stores[data.id];
  };


  /**
   *
   * @param {JQueryEvent} e
   * @returns {void}
   */
  StoreStockCheckController.prototype._currentPositionHandler = function (e) {
    var _this = this,
      _event = e,
      ERROR_MESSAGE = 'Sorry we currently can\'t access your location.',
      inPanel = !!fn.isObject(this._activePanel.storeStockCheck, { notEmpty: true }),
      view = this._activeView || null;

    if (inPanel) {
      view = this._viewData.overlay;
    }

    $(e.currentTarget).addClass('loading');
    view.oElms.elPostcodeInput.readonly = true;
    view.oElms.elCheckBtn.readonly = true;

    this._getDeviceCoordinates()
      .done(function handleGetDeviceCoordinatesSuccess(coordinates) {
        _this._getDeviceLocation(coordinates)
          .done(function handleGetDeviceLocationSuccess(location) {
            _this._setDeviceLocation({
              latitude: coordinates.latitude,
              longitude: coordinates.longitude,
              locality: location
            });

            _this._updatePostcodeInput(location);

            _event.data = _event.data || {};
            _event.data.useDeviceLocation = true;

            if (inPanel) {
              _this._handleOverlayStockCheckSubmit(_event);
            } else {
              _this._handleCheckStockSubmit(_event);
            }
          })
          .fail(function handleGetDeviceLocationFailure() {
            _this._renderTooltip(ERROR_MESSAGE);
          });
      })
      .fail(function handleGetDeviceCoordinatesFailure() {
        _this._renderTooltip(ERROR_MESSAGE);
      })
      .always(function () {
        view.oElms.elPostcodeInput.readonly = false;
        view.oElms.elCheckBtn.readonly = false;
        $(_event.currentTarget).removeClass('loading');
      });
  };


  /**
   * Get user's current position from device's given location.
   *
   * @returns {JQueryPromise}
   */
  StoreStockCheckController.prototype._getDeviceCoordinates = function () {
    var onSuccess = null,
      onError = null,
      deferred = $.Deferred();

    onSuccess = function (position) {
      deferred.resolve(position.coords);
    };

    onError = function (error) {
      deferred.reject(error);
    };

    fn.getCurrentPosition(onSuccess, onError,
      { enableHighAccuracy: true, timeout: 120000, maximumAge: 120000 });

    return deferred.promise();
  };


  /**
   * Get user's current location name from given coordinates.
   *
   * @param {object} coordinates
   * @param {number} coordinates.latitude
   * @param {number} coordinates.longitude
   * @returns {JQueryPromise}
   */
  StoreStockCheckController.prototype._getDeviceLocation = function (coordinates) {
    var deferred = $.Deferred(),
      latitude = fn.getValue(this._viewData, 'deviceLocation', 'latitude'),
      longitude = fn.getValue(this._viewData, 'deviceLocation', 'longitude'),
      locality = null;

    if (latitude === coordinates.latitude && longitude === coordinates.longitude) {
      locality = fn.getValue(this._viewData, 'deviceLocation', 'locality');
      deferred.resolve(locality);
      return deferred.promise();
    }

    this._fetchLocation(coordinates)
      .done(function handleFetchLocationSuccess(location) {
        locality = location;
        deferred.resolve(locality);
        return deferred.promise();
      })
      .fail(function handleFetchLocationFailure() {
        deferred.reject();
      });

    return deferred.promise();
  };


  /**
   * Make call to Bing Maps API to return location name from given coordinates.
   *
   * @param {Object} coordinates
   * @returns {JQueryPromise}
   */
  StoreStockCheckController.prototype._fetchLocation = function (coordinates) {
    var BING_URL = '//dev.virtualearth.net/REST/v1/Locations/',
      BING_KEY = 'ArjMBd3QUx1XCF2EMs4ZS1ULKnrka2i3yXuWRfq7Dq-hpSHE1cJmvMZpirc4W3dw',
      point = coordinates.latitude + ',' + coordinates.longitude,
      deferred = $.Deferred();

    $.getJSON(BING_URL + point + '?key=' + BING_KEY + '&jsonp=?', function (data) {
      var location = null;

      if (data.statusCode !== 200) {
        deferred.reject();
        return;
      }

      location = fn.getValue(data, 'resourceSets', 0, 'resources', 0, 'address', 'locality');

      if (!location) {
        deferred.reject();
        return;
      }

      deferred.resolve(location);
    });

    return deferred.promise();
  };


  /**
   * Cache user's current location.
   *
   * @param {Object} location
   * @param {number} location.latitude
   * @param {number} location.longitude
   * @param {string} location.locality
   * @returns {void}
   */
  StoreStockCheckController.prototype._setDeviceLocation = function (location) {
    if (!fn.isObject(location, { notEmpty: true })) return;

    this._viewData.deviceLocation.latitude = location.latitude;
    this._viewData.deviceLocation.longitude = location.longitude;
    this._viewData.deviceLocation.locality = location.locality;
  };


  /**
   * Populate store stock check form input with given location name.
   *
   * @param {string} location
   * @returns {void}
   */
  StoreStockCheckController.prototype._updatePostcodeInput = function (location) {
    var inPanel = !!fn.isObject(this._activePanel.storeStockCheck, { notEmpty: true }),
      view = null;

    if (typeof location !== 'string' || location === '') return;

    view = inPanel ? this._viewData.overlay : this._activeView;
    view.oElms.elPostcodeInput.value = location;
  };


  module.exports = StoreStockCheckController;
});

define('modules/pdp/views/ProductPageTitleView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView'
], function ($, fn, BaseView) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function ProductPageTitleView(config) {
    this.sViewName = 'ProductPageTitleView';
    this.sNamespace = 'products';
    this.sViewClass = 'product-title-wrapper';
    this.sTemplate = $('#product-page-title-template')[0].innerHTML;
    this.parent.constructor.call(this, config);
  }

  fn.inherit(ProductPageTitleView, BaseView);

  ProductPageTitleView._name = 'ProductPageTitleView';
  ProductPageTitleView.sNamespace = 'products';

  ProductPageTitleView.prototype._setData = function (mViewData) {
    this.parent._setData.call(this, mViewData);

    this.oData.mvc.vm.sFFlogoClass = this.oModel.isFFBranded(mViewData.id)
        ? 'icon-FFlogo' : '';

    this.oData.mvc.vm.bOnlineExclusive = mViewData.dynamicAttributes
        && mViewData.dynamicAttributes.online_exclusive === 'Y';

    this.oData.mvc.vm.sGlobalStaticAssetsPath = window.globalStaticAssetsPath;

    this.oData.mvc.vm.title = mViewData.dynamicAttributes.supplier === 'FF'
        ? this.oData.mvc.products.displayName : this.oData.mvc.sku.displayName;
  };

  return ProductPageTitleView;
});

define('modules/pdp/controllers/VariantsController',['require','exports','module','modules/mvc/fn','modules/pdp/controllers/BaseController','modules/pdp/views/VariantsView','modules/pdp/views/DropdownVariantView','modules/pdp/views/ProductPageTitleView','modules/pdp/views/ProductDetailsView','modules/pdp/views/ProductSpecView','modules/common','modules/google-analytics/pdpTracking'],function (require, exports, module) {
  'use strict';


  var fn = require('modules/mvc/fn'),
    BaseController = require('modules/pdp/controllers/BaseController'),
    VariantsView = require('modules/pdp/views/VariantsView'),
    DropdownVariantView = require('modules/pdp/views/DropdownVariantView'),
    ProductPageTitleView = require('modules/pdp/views/ProductPageTitleView'),
    ProductDetailsView = require('modules/pdp/views/ProductDetailsView'),
    ProductSpecView = require('modules/pdp/views/ProductSpecView'),
    common = require('modules/common'),
    googleEC = require('modules/google-analytics/pdpTracking');

  /**
   *
   * @param {Array<Objects>} models
   * @return {void}
   */
  function VariantsController(models) {
    var pageController = fn.getValue(window, 'oAppController', 'oPageController');

    this.sNamespace = 'products';
    this.sTag = 'variants';
    this.postRender = false;
    this.oTooltipStyles = {
      kiosk: ['tooltip-left'],
      allDesktops: ['tooltip-left'],
      allDevices: ['tooltip-bottom']
    };
    this.views = {
      classes: {
        VariantsView: VariantsView,
        DropdownVariantView: DropdownVariantView
      }
    };
    this.historyEventBound = false;
    this.initModelReferences();
    this._dataCache = {};
    this.parent.constructor.call(this, models);

    if (common.isTouch()) {
      if (fn.isObject(pageController) && typeof pageController.setScrollAction === 'function') {
        pageController.setScrollAction({
          callback: this._onUpdateInventory,
          once: true,
          scope: this
        });
      }
    }
  }


  fn.inherit(VariantsController, BaseController);
  VariantsController.modelNames = ['inventoryProduct', 'inventorySKU', 'products', 'sku'];


  VariantsController.prototype._bindEvents = function () {
    if (window.history.pushState) {
      if (!this.historyEventBound) {
        $(window).on('popstate', this._popStateHandler.bind(this));
        this.historyEventBound = true;
      }
    }
  };


  VariantsController.prototype._popStateHandler = function (e) {
    var flags = {},
      stateData = null;

    if (e.originalEvent && e.originalEvent.state) {
      stateData = e.originalEvent.state;
      flags = stateData.flags;
      e.data = stateData;

      if (flags.isProductChange) {
        this._handleProductVariantChange(e, flags);
      } else {
        this._handleSkuVariantChange(e, flags);
      }
    }
  };


  /**
   *
   * @param {Object} args
   * @param {Object} args.oView
   * @param {JQueryDeferred} _deferred Used for unit tests
   * @return {void}
   */
  VariantsController.prototype._bindViewEvents = function (args, _deferred) {
    var _this = this,
      view = args.oView,
      viewName = view.sViewName,
      $wrapper = null;

    if (viewName !== 'SwatchVariantView' && viewName !== 'DropdownVariantView'
        && viewName !== 'VariantsView') {
      return;
    }

    $wrapper = $(view.oElms.elWrapper);

    if (viewName === 'SwatchVariantView') {
      $wrapper.on(
        'click', '.swatch-variant a', { view: view },
        this._onSwatchChange.bind(this)
      ).on(
        'change', 'select', { view: view },
        this._onDropdownChange.bind(this)
      );
    } else if (viewName === 'DropdownVariantView') {
      $wrapper.on(
        'change', 'select', { view: view },
        this._onDropdownChange.bind(this)
      );
    } else if (viewName === 'VariantsView') {
      if (!common.isTouch() || window.isKiosk()) {
        $wrapper.on(
          'mouseover.updateInventory', '.control', { view: view },
          function (e) {
            _this._onUpdateInventory(e);
            $wrapper.off('mouseover.updateInventory');
          }
        );
      } else {
        this._actionInViewport.push({
          element: view.oElms.elWrapper,
          callbackArgs: { data: { view: view } }
        });
        this._checkInViewport(view.sViewId, _deferred);
      }
    }
  };


  VariantsController.prototype._onSwatchChange = function (e) {
    var $currentTarget = $(e.currentTarget),
      flags = {},
      isPrimaryVariantChange = $currentTarget.data('variant-group-type') === 'primary',
      isProductChange = $currentTarget.data('variant-type') === 'product',
      productVariantSelected = !!$currentTarget.data('product-variant');

    e.preventDefault();

    this._activeView = e.data.view;

    if ($currentTarget.hasClass('swatch-variant-selected')
        || $currentTarget.parent().hasClass('swatch-variant-selected')) {
      return;
    }

    flags.isPrimaryVariantChange = isPrimaryVariantChange;
    flags.isProductChange = isProductChange;
    flags.productVariantSelected = productVariantSelected;
    flags.isSecondaryVariantChange = !isPrimaryVariantChange;
    flags.isSkuChange = !isProductChange;
    flags.isVariantChange = true;

    if (flags.isProductChange) {
      this._handleProductVariantChange(e, flags);
    } else {
      this._handleSkuVariantChange(e, flags);
    }
  };


  VariantsController.prototype._onDropdownChange = function (e) {
    var $target = $(e.target),
      $currentTarget = $(e.currentTarget),
      flags = {},
      isSelect = $target.is('select'),
      isPrimaryVariantChange = isSelect
          ? $target.find(':selected').data('variant-group-type') === 'primary'
          : $currentTarget.data('variant-group-type') === 'primary',
      isProductChange = isSelect
          ? $target.find(':selected').data('variant-type') === 'product'
          : $currentTarget.data('variant-type') === 'product',
      productVariantSelected = isSelect
          ? !!$target.find(':selected').data('product-variant')
          : !!$currentTarget.data('product-variant');

    this._activeView = e.data.view;

    flags.isPrimaryVariantChange = isPrimaryVariantChange;
    flags.isProductChange = isProductChange;
    flags.productVariantSelected = productVariantSelected;
    flags.isSecondaryVariantChange = !isPrimaryVariantChange;
    flags.isSelect = isSelect;
    flags.isSkuChange = !isProductChange;
    flags.isVariantChange = true;

    if (flags.isProductChange && this._handleDropdownError(e)) {
      this._handleProductVariantChange(e, flags);
    } else if (this._handleDropdownError(e)) {
      this._handleSkuVariantChange(e, flags);
    }
  };


  VariantsController.prototype._handleProductVariantChange = function (e, flags) {
    var _this = this,
      mvcPage = window.oAppController.oPageController,
      viewData = this._activeView.oData.mvc,
      inRecommender = viewData.flags.isRecommenderVariant,
      productId = '',
      skuId = '';

    if (!inRecommender) {
      this.setEvent({
        sName: 'showBuyboxMask',
        options: { mask: 'buybox', loader: true }
      }, false, true);
    }

    if (e.type === 'popstate') {
      productId = e.data.productId;
      skuId = e.data.skuId;
    } else {
      productId = $(e.currentTarget).data('variant-id') || $(e.target).val();
    }

    $(window).one('dataReady', function (nestedEvent) {
      _this.triggerVariantRender(e, nestedEvent, flags);
    });

    flags.isPopState = e.type === 'popstate';
    mvcPage.init(productId, skuId, { flags: flags });
  };


  VariantsController.prototype._handleSkuVariantChange = function (e, flags) {
    var _this = this,
      mvcPage = window.oAppController.oPageController,
      viewData = this._activeView.oData.mvc,
      inRecommender = viewData.flags.isRecommenderVariant,
      productId = '',
      skuId = '',
      $target = $(e.target),
      $currentTarget = $(e.currentTarget),
      $selectWrapper = $target.closest('.select-wrapper'),
      $control = $selectWrapper.find('.control'),
      refreshPoints = [],
      variantValue = '';

    if (flags.isSelect) {
      variantValue = $target.find(':selected').data('variant-value');
    } else {
      variantValue = $currentTarget.data('variant-value');
    }

    if (!inRecommender) {
      this.setEvent({
        sName: 'showBuyboxMask',
        options: { mask: 'buybox', loader: true }
      }, false, true);
    }

    if (e.type === 'popstate') {
      productId = e.data.productId;
      skuId = e.data.skuId;
    } else {
      productId = viewData.products.id;
      skuId = this._getSelectedSkuID(productId, variantValue)
          || $(e.currentTarget).data('variant-id')
          || $target.val();
    }

    if (!inRecommender) {
      $(window).one('dataReady', function (nestedEvent) {
        _this.triggerVariantRender(e, nestedEvent, flags);
      });

      flags.isPopState = e.type === 'popstate';
      mvcPage.init(productId, skuId, { flags: flags });
    } else {
      if (!fn.isArray(viewData.refreshPoints, { notEmpty: true })) {
        return;
      }

      refreshPoints = viewData.refreshPoints;
      this._onRecommenderVariantChange({
        productId: productId,
        skuId: skuId,
        refreshPoint: refreshPoints[refreshPoints.length - 1],
        errorCallback: function errorCallback() {
          _this.createTooltip({
            elTrigger: $selectWrapper,
            sType: 'error'
          });
          $control.addClass('invalid');
        }
      });
    }
  };


  VariantsController.prototype._handleDropdownError = function (event) {
    var ERROR_MESSAGE = 'Please select a valid option',
      $target = $(event.target),
      $selectWrapper = $target.closest('.select-wrapper'),
      $control = $selectWrapper.find('.control'),
      hasError = $control.hasClass('invalid'),
      hasSellerData = this.sanityCheckData(this._activeView.oData.mvc.sellers).objects;

    if (!$target.val()) {
      this.createTooltip({
        sTooltopMessage: ERROR_MESSAGE,
        elTrigger: $selectWrapper,
        sType: 'error'
      });

      $control.addClass('invalid');

      if (hasSellerData) {
        this.setEvent({
          sName: 'disableItemActions',
          listingId: this._activeView.oData.mvc.sellers.id
        }, false, true);
      }

      return false;
    }

    if (hasError && hasSellerData) {
      this.setEvent({
        sName: 'enableItemActions',
        listingId: this._activeView.oData.mvc.sellers.id
      }, false, true);
    }

    if (this._activePanel.tooltip) {
      this._activePanel.tooltip.destroy();
    }

    if (hasError) {
      $control.removeClass('invalid');
    }

    return true;
  };


  /**
   *
   * @param {string} productID
   * @param {string} variantValue
   * @return {string}
   */
  VariantsController.prototype._getSelectedSkuID = function (productID, variantValue) {
    var childSkus = [],
      inventorySkuModel = this.models.inventorySKU,
      productModel = this.models.products,
      skuID = '';

    childSkus = productModel.getLinks({ value: 'childSku', data: productID });

    if (!fn.isArray(childSkus, { notEmpty: true })) {
      return '';
    }

    fn.loopArray(childSkus, function loopChildSkus(i) {
      var childSku = childSkus[i];

      if (childSku.options.primary === variantValue
          && inventorySkuModel.getDataStores({ value: childSku.id }).available) {
        skuID = childSku.id;
        return true;
      }

      return undefined;
    });

    return skuID;
  };


  VariantsController.prototype._onRecommenderVariantChange = function (params) {
    var _this = this,
      _params = params;

    this.oSKUModel.promise({
      sSearchKey: 'id',
      mSearchValue: _params.skuId
    }).done(function (oSkuData) {
      if (!_this.sanityCheckData(oSkuData).objects) {
        _params.errorCallback();
        return;
      }

      _this.triggerBuyBoxCall({
        productID: _params.productId,
        SKUID: _params.skuId,
        doneCallback: function (aSellerData) {
          if (!_this.sanityCheckData(aSellerData.sellers).objects) {
            _params.errorCallback();
            return;
          }

          _this.setEvent({
            sName: 'refresh',
            sNamespace: _params.refreshPoint.namespace,
            sTag: _params.refreshPoint.tag,
            sViewName: _params.refreshPoint.viewName,
            inherit: { namespace: 'sku', model: _this.oSKUModel },
            noCollate: true,
            getView: function getView(view) {
              if (view.sViewId === _params.refreshPoint.viewId) {
                return true;
              }
              return false;
            },
            mParamData: {
              mvc: {
                products: _this.oProductModel.get({
                  mSearchValue: _params.productId,
                  noFetch: true
                }),
                sku: oSkuData,
                sellers: _this.oSellerModel.get({
                  mSearchValue: aSellerData.sellers[0].id,
                  noFetch: true
                })
              }
            }
          }, false, true);
          googleEC.setAnalytics(oSkuData, 'matchingItemsLoad');
        }
      });
    });
  };

  VariantsController.prototype.triggerProductPageRender = function (data) {
    var oViewData = { mvc: { products: data.product, sku: data.sku, vm: {} } },
      aSubViews = [],
      i = 0;

    aSubViews.push(new ProductPageTitleView({
      elTarget: '.product-title-wrapper',
      mParamData: oViewData
    }));

    aSubViews.push(new ProductDetailsView({
      elTarget: '.product-description-block',
      mParamData: oViewData
    }));

    if (!this.oProductModel.isFF(data.product)) {
      aSubViews.push(new ProductSpecView({
        elTarget: '.product-spec-block',
        mParamData: oViewData,
        ctlr: true
      }));
    }

    for (i = 0; i < aSubViews.length; i += 1) {
      aSubViews[i].render();
    }
  };

  VariantsController.prototype.triggerBuyBoxCall = function (oParams) {
    var _this = this;

    this.oSKUModel.fetch({
      sSearchKey: 'id',
      mSearchValue: [
        oParams.productID,
        oParams.SKUID
      ],
      sModelMethod: 'buybox',
      doneCallback: oParams.doneCallback || function (mSellerData) {
        _this.oSKUModel.sellerInformationCallback({
          skuID: oParams.SKUID,
          sellers: mSellerData,
          targetSelector: oParams.targetSelector
        });
      }
    });
  };

  VariantsController.prototype.triggerVariantRender = function (oEvent, nestedEvent) {
    var _this = this,
      flags = nestedEvent.oData.flags,
      product = nestedEvent.oData.product,
      sku = nestedEvent.oData.sku,
      oEventData = { mRespData: { oSKU: sku, oProduct: product } };

    this.triggerProductPageRender(nestedEvent.oData);

    this.setEvent({
      sName: 'getPanelGroup',
      tag: 'buybox',
      callback: function (panelGroup) {
        if (panelGroup) {
          panelGroup.destroy();
        }
      }
    }, false, true);

    this.setEvent({
      sName: 'getPanelGroup',
      tag: 'tabs',
      callback: function (panelGroup) {
        if (panelGroup) {
          panelGroup.destroy();
        }
      }
    }, false, true);

    this.setEvent({
      sName: 'fetchData',
      sNamespace: 'sku',
      queryParams: {
        searchValue: sku.id,
        modelMethod: 'ndo'
      }
    }, false, true);

    this.setEvent({
      sName: 'refresh',
      sNamespace: 'sku',
      sTag: 'competitors',
      sViewName: 'PriceCheckView',
      getView: function getView(view) {
        if (view.sTag === 'competitors') {
          return true;
        }
        return false;
      },
      render: {
        elTarget: '#price-check-view-placeholder',
        sOutput: 'inner'
      },
      mParamData: {
        mvc: {
          sku: sku.id
        }
      }
    }, false, true);

    this.setEvent({
      sName: 'fetchData',
      sNamespace: 'sku',
      queryParams: {
        searchValue: [product.id, sku.id],
        modelMethod: 'buybox',
        doneCallback: function (data) {
          var skuData = this.oModel.get({
            mSearchValue: sku.id,
            noFetch: true
          });

          this.queryModel({
            sNamespace: 'sku',
            sCommand: 'update',
            oQueryParams: {
              mSearchValue: sku.id,
              sUpdateKey: 'sellers',
              mUpdateValue: data.sellers
            }
          });

          if (!window.isKiosk()) {
            this.renderView({
              sViewName: 'BuyboxView',
              elTarget: '.buybox-view',
              mParamData: {
                mvc: {
                  sku: skuData,
                  hooklogic: data.HookLogicBlock.param,
                  flags: flags
                }
              }
            });

            this.setEvent({
              sName: 'refresh',
              sNamespace: 'promotions',
              sTag: 'productPage',
              sViewName: 'PromotionsView',
              getView: function getView(view) {
                if (view.sTag === 'productPage') {
                  return true;
                }
                return false;
              },
              mParamData: { mvc: { sku: skuData } }
            }, false, true);

            if (_this.oSKUModel.getBookDetails(skuData).authorBiography) {
              this.setEvent({
                sName: 'refresh',
                sNamespace: 'sku',
                sTag: 'authorBiography',
                sViewName: 'AuthorBiographyView',
                getView: function getView(view) {
                  if (view.sTag === 'authorBiography') {
                    return true;
                  }
                  return false;
                },
                mParamData: {
                  mvc: {
                    sku: skuData
                  }
                }
              }, false, true);
            }
          }
        }
      }
    }, false, true);

    if (!flags.isSkuChange) {
      this.triggerProductChangeEvent(oEventData);
    }

    this.triggerSkuChangeEvent(oEventData);
  };


  VariantsController.prototype.initModelReferences = function () {
    var _this = this;

    this.queryModel({
      sNamespace: 'products'
    }).done(function (mOutput) {
      _this.oProductModel = mOutput;
    });

    this.queryModel({
      sNamespace: 'sellers'
    }).done(function (mOutput) {
      _this.oSellerModel = mOutput;
    });

    this.queryModel({
      sNamespace: 'sku'
    }).done(function (mOutput) {
      _this.oSKUModel = mOutput;
    });
  };

  VariantsController.prototype.triggerProductChangeEvent = function (oData) {
    var eProductChange = new $.Event('variant');

    eProductChange.oData = oData;
    eProductChange.namespace = 'productChange';
    $(window).trigger(eProductChange);
  };

  VariantsController.prototype.triggerSkuChangeEvent = function (oData) {
    var eSkuChange = new $.Event('variant');

    eSkuChange.oData = oData;
    eSkuChange.namespace = 'skuChange';
    $(window).trigger(eSkuChange);
  };


  VariantsController.prototype._collateDataDependancies = function (args) {
    var _this = this,
      _args = args,
      cachedOptions = {},
      cacheKey = '',
      childSkus = [],
      hasMixedPrimaryOption = false,
      inventoryProductModel = this.models.inventoryProduct,
      inventorySkuModel = this.models.inventorySKU,
      isFF = false,
      isProductVariant = false,
      masterDeferred = _args.deferred,
      mvcData = _args.mParamData.mvc,
      flags = mvcData.flags || {},
      inRecommender = !!flags.isRecommenderVariant,
      mvcPage = fn.getValue(window.oAppController, 'oPageController'),
      primaryChildSkus = [],
      primaryOption = {},
      product = mvcData.products,
      productModel = this.models.products,
      productVariantSelected = false,
      secondaryOption = {},
      selectedSku = !inRecommender ? mvcPage.getSelectedSku() : {};

    cacheKey = this._buildCacheKey(product, selectedSku, inRecommender);

    if (this._dataCache[cacheKey] === null) {
      masterDeferred.reject();
      return;
    } else if (this._dataCache[cacheKey] !== undefined) {
      cachedOptions = this._dataCache[cacheKey];

      if (!cachedOptions.secondary.selectedValue && fn.isObject(mvcData.sellers)) {
        _this._disableItemActions(cachedOptions.secondary, mvcData.sellers.id);
      }

      _args.mParamData.mvc.vm = this._dataCache[cacheKey];
      masterDeferred.resolve(_args);
      return;
    }

    if (!fn.isArray(product.optionsInfo, { notEmpty: true }) || !product.optionsInfo[0].type) {
      this._dataCache[cacheKey] = null;
      masterDeferred.reject();
      return;
    }

    childSkus = productModel.getLinks({ value: 'childSku', data: product })
      .filter(function (childSku) {
        var options = childSku.options || {};

        return !!options.primary && !!options.secondary;
      });
    isFF = productModel.isFF(product);

    if (!isFF && childSkus.length <= 1) {
      this._dataCache[cacheKey] = null;
      masterDeferred.reject();
      return;
    }

    isProductVariant = productModel.isProductVariant(product);
    primaryChildSkus = this._compilePrimaryChildSkus(
      product, selectedSku, childSkus, inRecommender
    );
    hasMixedPrimaryOption = this._hasMixedPrimaryOption(primaryChildSkus, product);

    if (isProductVariant) {
      productVariantSelected = this._isProductVariantSelected(product, selectedSku);
    }

    primaryOption = this._compilePrimaryOption(
      primaryChildSkus, product, selectedSku, productVariantSelected, inRecommender
    );

    secondaryOption = this._compileSecondaryOption(primaryOption, childSkus, product, selectedSku);

    if (inRecommender) {
      this._setDisplayStates([primaryOption, secondaryOption], isFF, inRecommender);
      _args.mParamData.mvc.vm = { primary: primaryOption, secondary: secondaryOption };
      masterDeferred.resolve(_args);
      return;
    }

    inventoryProductModel.getDataStores({
      fetch: true,
      value: this._getProductIDs(primaryOption.links)
    })
      .done(function handleInventorySuccess(productInventory) {
        fn.loopArray(productInventory, function loopProductInventory(i) {
          if (fn.isArray(productInventory[i].skus, { notEmpty: true })) {
            inventorySkuModel.setDataStores(productInventory[i].skus);
          }
        });

        _this._compileInventory([primaryOption, secondaryOption]);

        if (!isProductVariant || hasMixedPrimaryOption) {
          _this._rollUpInventory(primaryOption, childSkus);
        }

        _this._setSelectedStates([primaryOption, secondaryOption]);
        _this._filterOptions([primaryOption, secondaryOption], isFF, flags.isBuybox);
        _this._hasSwatches([primaryOption, secondaryOption]);
        _this._sortOptions([primaryOption, secondaryOption]);
        _this._setDisplayStates([primaryOption, secondaryOption], isFF, inRecommender);

        if (!secondaryOption.selectedValue && fn.isObject(mvcData.sellers)) {
          _this._disableItemActions(secondaryOption, mvcData.sellers.id);
        }

        _this._dataCache[cacheKey] = { primary: primaryOption, secondary: secondaryOption };
        _args.mParamData.mvc.vm = _this._dataCache[cacheKey];
        masterDeferred.resolve(_args);
      })
      .fail(function handleInventoryFailure() {
        masterDeferred.reject();
      });
  };


  /**
   *
   * @param {Object} product
   * @param {Object} selectedSku
   * @param {boolean} inRecommender
   * @return {string}
   */
  VariantsController.prototype._buildCacheKey = function (product, selectedSku, inRecommender) {
    var key = product.id;

    if (selectedSku.id) {
      key += '_' + selectedSku.id;
    }

    key += '_' + (inRecommender ? 'outfit' : 'buybox');

    return key;
  };


  /**
   *
   * @param {Object} secondaryOption
   * @param {string} listingID
   * @return {void}
   */
  VariantsController.prototype._disableItemActions = function (secondaryOption, listingID) {
    var disableItemActions = {
      data: { listingId: listingID },
      name: 'disableItemActions',
      propName: 'oData'
    };

    fn.createEvent(disableItemActions).fire();
  };


  /**
   *
   * @param {Object} product
   * @param {Object} selectedSku
   * @param {Array<Object>} childSkus
   * @param {boolean} inRecommender
   * @return {Array<Object>}
   */
  VariantsController.prototype._compilePrimaryChildSkus = function (
    product, selectedSku, childSkus, inRecommender
  ) {
    var productModel = this.models.products,
      skuModel = this.models.sku,
      primaryChildSkus = [];

    if (inRecommender) {
      primaryChildSkus = [productModel.getDefaultSku(product)];
    } else if (fn.isObject(selectedSku, { notEmpty: true })) {
      primaryChildSkus = [skuModel.getSelfLink(selectedSku)];
    }

    fn.loopArray(childSkus, function loopChildSkus(i) {
      var match = false;

      fn.loopArray(primaryChildSkus, function loopPrimaryChildSkus(j) {
        if (childSkus[i].options.primary === primaryChildSkus[j].options.primary) {
          match = true;
        }
      });

      if (!match) {
        primaryChildSkus.push(childSkus[i]);
      }
    });

    return primaryChildSkus;
  };


  /**
   *
   * @param {Array<Object>} primaryChildSkus
   * @param {Object} product
   * @return {boolean}
   */
  VariantsController.prototype._hasMixedPrimaryOption = function (primaryChildSkus, product) {
    var colourAssociations = [],
      isProductVariant = false,
      productModel = this.models.products;

    colourAssociations = productModel.getLinks({ value: 'colourAssociation', data: product });
    isProductVariant = productModel.isProductVariant(product);

    return isProductVariant && colourAssociations.length && primaryChildSkus.length > 1;
  };


  /**
   *
   * @param {Object} product
   * @param {Object} selectedSku
   * @return {boolean}
   */
  VariantsController.prototype._isProductVariantSelected = function (product, selectedSku) {
    var productModel = this.models.products,
      skuModel = this.models.sku,
      productSelfLink = {},
      selectedSkuSelfLink = {};

    if (!fn.isObject(selectedSku, { notEmpty: true })) {
      return true;
    }

    productSelfLink = productModel.getSelfLink(product);
    selectedSkuSelfLink = skuModel.getSelfLink(selectedSku);

    if (productSelfLink.options.primary === selectedSkuSelfLink.options.primary) {
      return true;
    }

    return false;
  };


  /**
   *
   * @param {Array<Object>} primaryChildSkus
   * @param {Object} product
   * @param {Object} selectedSku
   * @param {boolean} productVariantSelected
   * @param {boolean} inRecommender
   * @return {Object}
   */
  VariantsController.prototype._compilePrimaryOption = function (
    primaryChildSkus, product, selectedSku, productVariantSelected, inRecommender
  ) {
    var productModel = this.models.products,
      colourAssociations = productModel.getLinks({ value: 'colourAssociation', data: product }),
      isProductVariant = productModel.isProductVariant(product),
      primaryOption = { hasSwatches: false, links: [], selectedID: '', selectedValue: '' },
      productSelfLink = productModel.getSelfLink(product),
      productSelfLinkOptions = {},
      skuModel = this.models.sku,
      skuLink = {},
      skuLinkOptions = {};

    if (inRecommender) {
      skuLink = productModel.getDefaultSku(product);
    } else if (fn.isObject(selectedSku, { notEmpty: true })) {
      skuLink = skuModel.getSelfLink(selectedSku);
    }

    skuLinkOptions = skuLink.options || {};

    fn.mergeObjects(
      primaryOption,
      productModel.getOptionsInfo(product, 'primary'),
      { extend: true }
    );

    if (!isProductVariant) {
      primaryOption.links = primaryChildSkus;
      primaryOption.selectedValue = skuLinkOptions.primary;
      primaryOption.selectedID = skuLink.id;
      primaryOption.productVariantSelected = false;
    } else {
      primaryOption.links = [productSelfLink];
      productSelfLinkOptions = productSelfLink.options || {};

      if (colourAssociations.length) {
        primaryOption.links = primaryOption.links.concat(colourAssociations);
      }

      fn.loopArray(primaryChildSkus, function loopPrimaryChildSkus(i) {
        if (primaryChildSkus[i].options.primary === productSelfLinkOptions.primary) {
          primaryChildSkus.splice(i, 1);
        }
      }, { backward: true });

      if (primaryChildSkus.length) {
        primaryOption.links = primaryOption.links.concat(primaryChildSkus);
      }

      primaryOption.selectedValue = productVariantSelected
          ? productSelfLinkOptions.primary : skuLinkOptions.primary || '';
      primaryOption.selectedID = productVariantSelected
          ? productSelfLink.id : skuLink.id || '';
      primaryOption.productVariantSelected = productVariantSelected;
    }

    fn.loopArray(primaryOption.links, function loopOptionLinks(j) {
      var link = primaryOption.links[j];

      link.isProductVariant = link.type === 'product';
    });

    return primaryOption;
  };


  /**
   *
   * @param {Object} primaryOption
   * @param {Array<Object>} childSkus
   * @param {Object} product
   * @param {Object} selectedSku
   * @return {Object}
   */
  VariantsController.prototype._compileSecondaryOption = function (
    primaryOption, childSkus, product, selectedSku
  ) {
    var productModel = this.models.products,
      secondaryOption = { hasSwatches: false, links: [], selectedID: '', selectedValue: '' },
      skuModel = this.models.sku;

    fn.mergeObjects(
      secondaryOption,
      productModel.getOptionsInfo(product, 'secondary'),
      { extend: true }
    );

    if (fn.isObject(selectedSku, { notEmpty: true })) {
      secondaryOption.selectedValue = skuModel.getSelfLink(selectedSku).options.secondary;
      secondaryOption.selectedID = selectedSku.id;
    }

    fn.loopArray(childSkus, function loopChildSkus(i) {
      if (childSkus[i].options.primary === primaryOption.selectedValue) {
        childSkus[i].isProductVariant = primaryOption.productVariantSelected;
        secondaryOption.links.push(childSkus[i]);
      }
    });

    return secondaryOption;
  };


  /**
   *
   * @param {Array<Object>} links
   * @return {Array<string>}
   */
  VariantsController.prototype._getProductIDs = function (links) {
    var ids = [];

    fn.loopArray(links, function loopPrimaryOptionLinks(i) {
      var link = links[i];

      if (link.type === 'product') {
        ids.push(link.id);
      }
    });

    return ids;
  };


  /**
   *
   * @param {Array<Object>} options
   * @return {void}
   */
  VariantsController.prototype._compileInventory = function (options) {
    var inventoryProductModel = this.models.inventoryProduct,
      inventorySkuModel = this.models.inventorySKU;

    fn.loopArray(options, function loopOptions(i) {
      var links = options[i].links;

      options[i].hasInventory = true;

      fn.loopArray(links, function loopLinks(j) {
        var inventory = {},
          inventoryModel = {},
          link = links[j];

        inventoryModel = link.type === 'product' ? inventoryProductModel : inventorySkuModel;
        inventory = inventoryModel.getDataStores({ value: link.id });
        link.inventoryMerged = fn.isObject(inventory, { notEmpty: true });

        if (link.inventoryMerged) {
          fn.mergeObjects(link, inventory, { extend: true });
        }
      });
    });
  };


  /**
   *
   * @param {Object} primaryOption
   * @param {Array<Object>} childSkus
   * @return {void}
   */
  VariantsController.prototype._rollUpInventory = function (primaryOption, childSkus) {
    var inventorySkuModel = this.models.inventorySKU,
      links = primaryOption.links;

    fn.loopArray(links, function loopLinks(i) {
      var count = { available: 0, links: 0, outOfStock: 0, subscribable: 0 },
        link = links[i];

      if (link.type === 'product') {
        return;
      }

      fn.loopArray(childSkus, function loopChildSkus(j) {
        var childSku = childSkus[j],
          inventory = {};

        if (link.options.primary !== childSku.options.primary) {
          return;
        }

        inventory = inventorySkuModel.getDataStores({ value: childSku.id });

        if (inventory.available) {
          count.available += 1;
        } else {
          count.outOfStock += 1;
        }

        if (inventory.subscribable) {
          count.subscribable += 1;
        }

        count.links += 1;
      });

      link.inventoryMerged = true;
      link.available = count.available > 0;
      link.subscribable = count.subscribable > 0;
      link.outOfStock = count.outOfStock === count.links;
      link.availability = link.outOfStock ? 'OutOfStock' : 'InStock';
    });
  };


  /**
   *
   * @param {Array<Object>} options
   * @return {void}
   */
  VariantsController.prototype._setSelectedStates = function (options) {
    fn.loopArray(options, function loopOptions(i) {
      var links = options[i].links,
        selectedID = options[i].selectedID;

      fn.loopArray(links, function loopLinks(j) {
        var link = links[j];

        if (link.id === selectedID) {
          link.selected = true;
        }
      });
    });
  };


  /**
   *
   * @param {Array<Object>} options
   * @param {boolean} isFF
   * @param {boolean} isBuybox
   * @return {void}
   */
  VariantsController.prototype._filterOptions = function (options, isFF, isBuybox) {
    var mvcPage = fn.getValue(window.oAppController, 'oPageController'),
      rootView = isBuybox ? 'buybox' : 'outfit',
      secondaryOption = {},
      secondaryOptionLink = {},
      supplier = isFF ? 'FF' : 'GMO';

    fn.loopArray(options, function loopOptions(i) {
      var links = options[i].links,
        hideOutOfStock = fn.getValue(
          window, '__MVT__', supplier, rootView, 'variants', options[i].type, 'hideOutOfStock'
        );

      fn.loopArray(links, function loopLinks(j) {
        var link = links[j];

        if (!link.selected) {
          if ((hideOutOfStock && !link.available) || (isFF && options[i].internalName === 'colour'
              && !link.available && !link.subscribable)) {
            links.splice(j, 1);
          }
        }
      }, { backward: true });

      options[i].displayCount = links.length;
    });

    secondaryOption = options[1];
    if (secondaryOption.links.length === 1 && !secondaryOption.selectedValue) {
      secondaryOptionLink = secondaryOption.links[0];
      secondaryOption.selectedID = secondaryOptionLink.id;
      secondaryOption.selectedValue = secondaryOptionLink.options.secondary;
      mvcPage.setSelectedSku(mvcPage.getActiveSku());
    }
  };

  /**
   *
   * @param {Array<Object>} options
   * @return {boolean}
   */
  VariantsController.prototype._hasSwatches = function (options) {
    /**
     *
     * @param {string} name
     * @return {Boolean}
     */
    function swatchable(name) {
      var bool = false;

      switch (name) {
        case 'colour':
          bool = true;
          break;
        // no default
      }

      return bool;
    }

    fn.loopArray(options, function loopOptions(i) {
      var count = 0,
        internalName = options[i].internalName,
        links = options[i].links;

      fn.loopArray(links, function loopLinks(j) {
        if (links[j].options.swatch) {
          count += 1;
        }
      });

      options[i].hasSwatches = swatchable(internalName) && count === links.length;
    });
  };


  /**
   *
   * @param {Array<Object>} options
   * @param {boolean} isFF
   * @param {boolean} inRecommender
   * @return {boolean}
   */
  VariantsController.prototype._setDisplayStates = function (options, isFF, inRecommender) {
    fn.loopArray(options, function loopOptions(i) {
      var option = options[i];

      option.inDropdown = inRecommender || option.displayCount > 1;
      option.toDisplayOption = inRecommender || isFF || (!isFF && option.displayCount > 1);
    });
  };


  /**
   *
   * @param {Array<Object>} options
   * @return {boolean}
   */
  VariantsController.prototype._sortOptions = function (options) {
    fn.loopArray.call(this, options, function loopOptions(i) {
      if (options[i].hasSwatches) {
        options[i].links.sort(this._sort(options[i].type));
      }
    });
  };


  /**
   *
   * @param {string} type
   * @return {Function}
   */
  VariantsController.prototype._sort = function (type) {
    return function (a, b) {
      var i = 0;

      if (a.available > b.available) {
        i = -1;
      } else if (a.available < b.available) {
        i = 1;
      } else if (a.options[type] > b.options[type]) {
        i = 1;
      } else if (a.options[type] < b.options[type]) {
        i = -1;
      } else if (a.id > b.id) {
        i = 1;
      } else if (a.id < b.id) {
        i = -1;
      } else {
        i = 0;
      }

      return i;
    };
  };


  /**
   *
   * @param {JQueryEvent} e
   * @return {void}
   */
  VariantsController.prototype._onUpdateInventory = function (e) {
    var _this = this,
      childSkus = [],
      inventoryModel = {},
      inventoryProductModel = this.models.inventoryProduct,
      inventorySkuModel = this.models.inventorySKU,
      isFF = false,
      isProductVariant = false,
      hasMixedPrimaryOption = false,
      productModel = this.models.products,
      view = e.data.view,
      mvcData = view.oData.mvc,
      flags = mvcData.flags,
      inRecommender = flags.isRecommenderVariant,
      product = mvcData.products,
      variantOpts = mvcData.vm,
      primaryOption = variantOpts.primary,
      secondaryOption = variantOpts.secondary;

    if (primaryOption.hasInventory && secondaryOption.hasInventory) {
      return;
    }

    isFF = productModel.isFF(product);
    isProductVariant = productModel.isProductVariant(product);
    inventoryModel = isProductVariant ? inventoryProductModel : inventorySkuModel;

    inventoryModel.getDataStores({
      fetch: true,
      value: isProductVariant
          ? this._getProductIDs(primaryOption.links)
          : this._getSkuIDs(primaryOption.links.concat(secondaryOption.links))
    })
      .done(function handleInventorySuccess(inventory) {
        if (isProductVariant) {
          fn.loopArray(inventory, function loopProductInventory(i) {
            if (fn.isArray(inventory[i].skus, { notEmpty: true })) {
              inventorySkuModel.setDataStores(inventory[i].skus);
            }
          });
        }

        _this._compileInventory([primaryOption, secondaryOption]);

        childSkus = productModel.getLinks({ value: 'childSku', data: product })
          .filter(function (childSku) {
            var options = childSku.options || {};

            return !!options.primary && !!options.secondary;
          });

        hasMixedPrimaryOption = _this._hasMixedPrimaryOption(
          _this._compilePrimaryChildSkus(product, {}, childSkus, inRecommender), product
        );

        if (!isProductVariant || hasMixedPrimaryOption) {
          _this._rollUpInventory(primaryOption, childSkus);
        }

        _this._setSelectedStates([primaryOption, secondaryOption]);
        _this._hasSwatches([primaryOption, secondaryOption]);
        _this._sortOptions([primaryOption, secondaryOption]);
        _this._setDisplayStates([primaryOption, secondaryOption], isFF, inRecommender);

        if (!secondaryOption.selectedValue && fn.isObject(mvcData.sellers)) {
          _this._disableItemActions(secondaryOption, mvcData.sellers.id);
        }

        _this._dataCache[_this._buildCacheKey(product, {}, inRecommender)] = variantOpts;
        flags.onUpdateInventory = true;
        view.refresh({ data: view.oData });
      });
  };


  /**
   *
   * @param {Array<Object>} links
   * @return {Array<string>}
   */
  VariantsController.prototype._getSkuIDs = function (links) {
    var ids = [];

    fn.loopArray(links, function loopLinks(i) {
      var link = links[i];

      if (ids.indexOf(link.id) === -1) {
        ids.push(link.id);
      }
    });

    return ids;
  };


  module.exports = VariantsController;
});

define('modules/pdp/views/WarrantiesView', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/views/BaseView'
], function ($, fn, BaseView) {
  'use strict';

  /**
   * Warranties view constructor sets view's core data and calls parent constructor.
   * @param {Object} oConfig The configuration to populate the view's dynamic properties.
   * @return {void}
   */
  function WarrantiesView(oConfig) {
    this.sViewName = 'WarrantiesView';
    this.sNamespace = 'sellers';
    this.sTag = 'warranties';
    this.sViewClass = 'warranties-view';
    this.sTemplate = $('#warranties-view-template')[0].innerHTML;
    this.parent.constructor.call(this, oConfig);
  }

  fn.inherit(WarrantiesView, BaseView);

  WarrantiesView._name = 'WarrantiesView';
  WarrantiesView.sNamespace = 'sellers';
  WarrantiesView.sTag = 'warranties';

  WarrantiesView.prototype._cacheDomElms = function () {
    var $Selector = $(this.sSelector);

    this.parent._cacheDomElms.call(this);
    this.oElms.elCheckboxInput = $Selector.find('input.warranty-checkbox');
  };

  return WarrantiesView;
});

define('modules/pdp/data-stores/Warranty', [], function () {
  'use strict';

  /**
   * The data object for a warranty.
   * @param {Object} oData The data to be added to the warranty data object.
   * @return {void}
   */
  function Warranty(oData) {
    this.productID = oData.productID;
    this.minItemPrice = oData.minItemPrice;
    this.maxItemPrice = oData.maxItemPrice;
    this.condition = oData.condition;
    this.category = oData.category;
    this.resaleProductID = oData.resaleProductID;
    this.deductible = oData.deductible;
    this.servicePlanType = oData.servicePlanType;
    this.term = oData.term;
    this.price = oData.price;
    this.moreInfoID = oData.moreInfoID;
    this.descriptionID = oData.descriptionID;
    this.catalogRefId = oData.catalogRefId;
    this.description = oData.description;
    this.displayPrice = oData.displayPrice;
  }

  return Warranty;
});

define('modules/pdp/controllers/WarrantiesController', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/controllers/BaseController',
  'modules/pdp/views/WarrantiesView',
  'modules/pdp/data-stores/Warranty'
], function ($, fn, BaseController, WarrantiesView, Warranty) {
  'use strict';

  /**
   *
   * @param {Object} model The sellers model..
   * @return {void}
   */
  function WarrantiesController(model) {
    this.sNamespace = 'sellers';
    this.sTag = 'warranties';
    this.views = {
      classes: {
        WarrantiesView: WarrantiesView
      }
    };
    this.cachedConfig = null;
    this.parent.constructor.call(this, model);
    this._fetchConfig();
    this._pendingViews = [];
    this.isBlockedSku = null;
    this.eligibleCategory = undefined;
  }

  fn.inherit(WarrantiesController, BaseController);

  WarrantiesController.prototype._collateDataDependancies = function (params) {
    var _params = params,
      oPromise = params.promise;

    if (_params.mParamData.mvc.sellers.buyBoxMessage !== 'buy') {
      oPromise.reject();
      return;
    }

    if (!this.cachedConfig) {
      this._pendingViews.push(_params);
      return;
    }

    this._parseConfig(_params);
  };

  WarrantiesController.prototype._bindViewEvents = function (oData) {
    $(oData.oView.oElms.elCheckboxInput).on(
      'change',
      { oView: oData.oView },
      this._onCheckboxChange.bind(this)
    );
  };

  WarrantiesController.prototype._onCheckboxChange = function (oEvent) {
    var oView = oEvent.data.oView,
      sUpdatePropValue = oEvent.currentTarget.checked
          ? $(oEvent.currentTarget).data('mvc-value') + ',' + oView.oData.mvc.sellers.id
          : oView.oData.mvc.sellers.id;

    this.forLoop(oView.oElms.elCheckboxInput, function deselectOtherCheckboxes(i) {
      if (oView.oElms.elCheckboxInput[i] !== oEvent.currentTarget
          && oView.oElms.elCheckboxInput[i].checked) {
        oView.oElms.elCheckboxInput[i].checked = false;
      }
    });

    this.queryModel({
      sNamespace: 'formHandler',
      sCommand: 'update',
      oQueryParams: {
        mSearchValue: oView.oData.mvc.sellers.formHandler,
        sUpdateKey: 'oData',
        mUpdateValue: null,
        sUpdatePropKey: $(oEvent.currentTarget).data('mvc-key'),
        mUpdatePropValue: sUpdatePropValue
      }
    });
  };

  WarrantiesController.prototype._fetchConfig = function () {
    var _this = this,
      sBasePath = '/directuiassets/SiteAssets/NonSeasonal/en_GB/js/data/warranties/',
      sFileName = 'config-preprod.js',
      sUrl = '',
      regexProductionEnv = new RegExp([
        'secure.tesco.com|www.tesco.com',
        '|kiosk.direct.ukroi.tesco.org|preview.direct.ukroi.tesco.org'
      ].join(''), 'gi');

    if (/vdi.tscl.com/gi.test(window.location.href)) {
      sBasePath = '/assets/js/data/warranties/';
    }

    if (regexProductionEnv.test(window.location.href)) {
      sFileName = 'config.js';
    }

    sUrl = sBasePath + sFileName;

    $.ajax({
      url: sUrl,
      dataType: 'json',
      beforeSend: function (jqXHR, settings) {
        var oSettings = settings;

        oSettings.url = sUrl;
      }
    })
    .done(function (data) {
      _this.cachedConfig = data;
      _this._doneHandler();
    })
    .fail(function () {
      _this._failHandler();
    });
  };

  WarrantiesController.prototype._doneHandler = function () {
    var _this = this;

    if (_this._pendingViews.length) {
      _this.forLoop(_this._pendingViews, function loopPendingViews(i) {
        _this._parseConfig(_this._pendingViews[i]);
      });
    }
  };

  WarrantiesController.prototype._failHandler = function () {
    var _this = this;

    if (_this._pendingViews.length) {
      _this.forLoop(_this._pendingViews, function loopPendingViews(i) {
        _this._pendingViews[i].promise.reject();
      });
    }
  };

  WarrantiesController.prototype._parseConfig = function (params) {
    var _params = params,
      oPromise = params.promise,
      i = 0,
      price = this.oModel.getPrice(_params.mParamData.mvc.sellers.id),
      aPricing = [],
      oWarranty = {};

    if (this.isBlockedSku === null) {
      this.isBlockedSku = this._checkBlockedSku(_params.mParamData.mvc.sku.id);
    }

    if (this.isBlockedSku) {
      oPromise.reject();
      return;
    }

    if (this.eligibleCategory === undefined) {
      this.eligibleCategory = this._getEligibleCategory(this.cachedConfig.categoryMap);
    }

    if (this.eligibleCategory === undefined) {
      oPromise.reject();
      return;
    }

    aPricing = this._getPricing(this.eligibleCategory);

    if (!aPricing.length) {
      oPromise.reject();
      return;
    }

    _params.mParamData.mvc.vm = _params.mParamData.mvc.vm || {};
    _params.mParamData.mvc.vm.warranties = [];

    for (i = 0; i < aPricing.length; i += 1) {
      if (this._checkItemPriceEligible(aPricing[i], price)) {
        oWarranty = $.extend({}, aPricing[i]);
        oWarranty.description = this.cachedConfig.descriptionMap[oWarranty.descriptionID];
        oWarranty.displayPrice = oWarranty.price.toFixed(2);
        _params.mParamData.mvc.vm.warranties.push(new Warranty(oWarranty));
      }
    }

    if (_params.mParamData.mvc.vm.warranties.length) {
      oPromise.resolve(_params);
    } else {
      oPromise.reject();
    }
  };

  WarrantiesController.prototype._checkBlockedSku = function (sSkuId) {
    var aBlockedSkus = this.cachedConfig.blockedSkus,
      i = 0;

    if (aBlockedSkus.length) {
      for (i = 0; i < aBlockedSkus.length; i += 1) {
        if (aBlockedSkus.indexOf(sSkuId) > -1) {
          return true;
        }
      }
    }

    return false;
  };

  WarrantiesController.prototype._getEligibleCategory = function (oCategoryMap) {
    var aCategoryHierarchy = [],
      i = 0,
      aCategoryKeys = Object.keys(oCategoryMap);

    if (window.Data && window.Data.Breadcrumb) {
      if (window.Data.Breadcrumb.aCategoryHierarchy
          && window.Data.Breadcrumb.aCategoryHierarchy.length) {
        aCategoryHierarchy = window.Data.Breadcrumb.aCategoryHierarchy;

        for (i = aCategoryHierarchy.length - 1; i >= 0; i += 1) {
          if (aCategoryKeys.indexOf(aCategoryHierarchy[i]) > -1) {
            return oCategoryMap[aCategoryHierarchy[i]];
          }
        }
      }
    }

    return undefined;
  };

  WarrantiesController.prototype._checkItemPriceEligible = function (oWarranty, price) {
    return price >= oWarranty.minItemPrice && price <= oWarranty.maxItemPrice;
  };

  WarrantiesController.prototype._getPricing = function (sCategory) {
    return this.cachedConfig.pricing[sCategory] && this.cachedConfig.pricing[sCategory].New
        && this.cachedConfig.pricing[sCategory].New.length
            ? this.cachedConfig.pricing[sCategory].New : [];
  };

  return WarrantiesController;
});

define('modules/pdp/controllers/WishlistsController', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/controllers/BaseController',
  'modules/pdp/views/WishlistsView',
  'modules/common'
], function ($, fn, BaseController, WishlistsView, common) {
  'use strict';

  /**
   *
   * @param {Object} model
   * @return {void}
   */
  function WishlistsController(model) {
    this.sNamespace = 'wishlists';
    this.sTag = '_default';
    this.views = {
      classes: {
        WishlistsView: WishlistsView
      }
    };
    this.sBuyBoxWrapperSelector = '.buybox-wrapper';
    this.sWishlistWrapperSelector = '.wishlists-wrapper';
    this.sWishlistOptionSelector = this.sWishlistWrapperSelector + ' ul li a.option';
    this.sDisableWishlistsClass = 'disable-wishlists';
    this.sWishlistDefaultSelector = this.sWishlistWrapperSelector
        + ' .dropdown-customised a.control';
    this.sWishlistTouchDefaultSelector = this.sWishlistWrapperSelector + ' .dropdown-customised';
    this.sWishlistCustomDropdownSelector = 'dropdown-customised';
    this.bMultipleWishlists = false;
    this.parent.constructor.call(this, model);
  }

  fn.inherit(WishlistsController, BaseController);

  WishlistsController.prototype._collateDataDependancies = function (params) {
    var oParamData = params;

    if (oParamData.mParamData.mvc.sku && oParamData.mParamData.mvc.products) {
      if (oParamData.mParamData.mvc.sku.id && oParamData.mParamData.mvc.products.id) {
        oParamData.mParamData.mvc.wishlists = this.oModel._getWishlists(
          oParamData.mParamData.mvc.products.id, oParamData.mParamData.mvc.sku.id
        );

        if (oParamData.mParamData.mvc.wishlists.length > 0) {
          oParamData.mParamData.mvc.wishlists.defaultWishlistText = this.oModel._getDefaultName();
          oParamData.mParamData.mvc.wishlists.defaultHref = this.oModel._getDefaultHref();
          this.bMultipleWishlists = this.oModel._setMultipleWishlists();
          oParamData.mParamData.mvc.wishlists.bMultipleWishlists = this.bMultipleWishlists;
          oParamData.mParamData.mvc.wishlists.bHideWishlists = false;
        } else {
          oParamData.deferred.reject(oParamData);
        }

        if (oParamData.mParamData.mvc.flags.isFF) {
          if (oParamData.mParamData.mvc.flags.isSkuSelected !== true) {
            oParamData.mParamData.mvc.wishlists.bHideWishlists = true;
          }
        }
        oParamData.deferred.resolve(oParamData);
      } else {
        oParamData.deferred.reject(oParamData);
      }
    } else {
      oParamData.deferred.reject(oParamData);
    }
  };

  WishlistsController.prototype._goToURL = function (sDestinationURL) {
    if (sDestinationURL !== undefined) {
      window.location.href = sDestinationURL;
    }
  };

  WishlistsController.prototype._handleAddItemToWishlist = function (oEvent) {
    var $selectedEl = null,
      sDestinationURL = null,
      $target = null;

    if (oEvent === undefined) {
      return;
    }

    $target = $(oEvent.target);

    if ($target.hasClass(this.sWishlistCustomDropdownSelector)) {
      $selectedEl = $target.find('.control');
    } else if ($target.hasClass('been-customised')) {
      $selectedEl = $target.find('option:selected');
    } else {
      $selectedEl = $target.closest('a');
    }

    sDestinationURL = $selectedEl.data('url');

    if (sDestinationURL !== undefined && sDestinationURL !== null) {
      this._goToURL(sDestinationURL);
    }
  };

  WishlistsController.prototype._bindViewEvents = function () {
    if (common.isTouch()) {
      this._bindTouchEvents();
    } else {
      this._bindNonTouchEvents();
    }
  };

  WishlistsController.prototype._bindTouchEvents = function () {
    if (this.bMultipleWishlists) {
      $(this.sWishlistWrapperSelector).on(
        'change',
        'select',
        this._handleAddItemToWishlist.bind(this)
      );
    } else {
      $(this.sBuyBoxWrapperSelector).on(
        'click',
        this.sWishlistTouchDefaultSelector,
        this._handleAddItemToWishlist.bind(this)
      );
    }
  };

  WishlistsController.prototype._bindNonTouchEvents = function () {
    if (this.bMultipleWishlists) {
      $(this.sBuyBoxWrapperSelector).on(
          'click',
          this.sWishlistOptionSelector,
          this._handleAddItemToWishlist.bind(this)
        );
    } else {
      $(this.sBuyBoxWrapperSelector).on(
        'click',
        this.sWishlistDefaultSelector,
        this._handleAddItemToWishlist.bind(this)
      );
    }
  };

  return WishlistsController;
});

define('modules/pdp/data-stores/Wishlists', [], function () {
  'use strict';

  /**
   * Structured data object for Wishlists data
   * @param {Object} oData Data to be added into the structured data object.
   * @return {void}
   */
  function Wishlists(oData) {
    this.id = oData.id || null;
    this.href = oData.href || null;
    this.name = oData.name || null;
    this.defaultHref = oData.defaultHref || null;
    this.defaultName = oData.defaultName || null;
  }

  return Wishlists;
});

define('modules/pdp/models/WishlistsModel', [
  'modules/mvc/fn',
  'modules/pdp/data-stores/Wishlists',
  'modules/pdp/models/BaseModel'
], function (fn, Wishlists, BaseModel) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function WishlistsModel(config) {
    this.DataStoreClass = Wishlists;
    this.sNamespace = 'wishlists';
    this.sProductPlaceholderText = '%PRODUCTPLACEHOLDER%';
    this.sSkuPlaceholderText = '%SKUPLACEHOLDER%';
    this.parent.constructor.call(this, config);
  }

  fn.inherit(WishlistsModel, BaseModel);

  WishlistsModel.prototype._populateData = function (oResp) {
    if (oResp !== undefined) {
      this.add(oResp);
    }
  };

  WishlistsModel.prototype._updateHrefString = function (sDirtyString) {
    var sCleanString = '',
      _sDirtyString = '',
      aURLSplitParams = [],
      aURLIndividualParams = [],
      aUpdatedURLParams = [],
      i = 0,
      sProductIdString = 'productId=',
      sProductIdPlaceholder = sProductIdString + this.sProductPlaceholderText,
      sSkuIdString = 'skuId=',
      sSkuIdPlaceholder = sSkuIdString + this.sSkuPlaceholderText;

    _sDirtyString = sDirtyString;
    aURLSplitParams = _sDirtyString.split('?');
    aURLIndividualParams = aURLSplitParams[1].split(/[&;]/g);

    for (i = 0; i < aURLIndividualParams.length; i += 1) {
      if (aURLIndividualParams[i].indexOf(sSkuIdString) >= 0) {
        aURLIndividualParams[i] = sSkuIdPlaceholder;
      }

      if (aURLIndividualParams[i].indexOf(sProductIdString) >= 0) {
        aURLIndividualParams[i] = sProductIdPlaceholder;
      }
    }
    aUpdatedURLParams = aURLIndividualParams.join('&');
    aURLSplitParams[1] = aUpdatedURLParams;
    _sDirtyString = aURLSplitParams[0] + '?' + aURLSplitParams[1];
    sCleanString = _sDirtyString.replace(/<a href=|"|>|<\/a>/gi, '');

    return sCleanString;
  };

  WishlistsModel.prototype._sanitiseData = function (oResp) {
    var _this = this,
      oDirtyData = oResp,
      oCleanData = {},
      sCleanHref = '',
      i = 0;

    if (oResp === undefined) {
      return null;
    }
    for (i = 0; i < oDirtyData.length; i += 1) {
      if (oDirtyData[i].href !== undefined) {
        if (oDirtyData[i].href.length > 0) {
          sCleanHref = _this._updateHrefString(oDirtyData[i].href);
          oDirtyData[i].href = sCleanHref;
        }
      }
    }
    oCleanData = oDirtyData;
    return oCleanData;
  };

  WishlistsModel.prototype._dataHandler = function (sResp) {
    var _this = this,
      oResp = null;

    if (sResp !== undefined) {
      if (sResp.length > 0) {
        oResp = $.parseJSON(sResp);
        _this._populateData(_this._sanitiseData(oResp.WishlistV2.wishlists));
      }
    }
  };

  WishlistsModel.prototype._getWishlists = function (sProductId, sSkuId) {
    var aStoredWishlistsData = this._aDataStores,
      aWishlistsData = [];

    if (!aStoredWishlistsData || sSkuId === undefined || sProductId === undefined) {
      return null;
    }
    aWishlistsData = this._setProductIdAndSkuId(aStoredWishlistsData, sProductId, sSkuId);
    this._updatePlaceholderText(sProductId, sSkuId);

    return aWishlistsData;
  };

  WishlistsModel.prototype._setProductIdAndSkuId = function (
    aStoredWishlistsData, sProductId, sSkuId
  ) {
    var aWishlistsData = [],
      sTmpWishlist = '',
      sTmpHref = '',
      i = 0;

    for (i = 0; i < aStoredWishlistsData.length; i += 1) {
      sTmpWishlist = aStoredWishlistsData[i];
      sTmpHref = sTmpWishlist.href
        .replace(this.sProductPlaceholderText, sProductId)
        .replace(this.sSkuPlaceholderText, sSkuId);
      sTmpWishlist.href = sTmpHref;
      aWishlistsData.push(sTmpWishlist);
    }

    return aWishlistsData;
  };

  WishlistsModel.prototype._updatePlaceholderText = function (sProductId, sSkuId) {
    if (sProductId !== undefined && sSkuId !== undefined) {
      this.sProductPlaceholderText = sProductId;
      this.sSkuPlaceholderText = sSkuId;
    }
  };

  WishlistsModel.prototype._setMultipleWishlists = function () {
    var bMultipleWishlists = false,
      aWishlistsData = this._aDataStores;

    if (!aWishlistsData) {
      return null;
    }

    if (aWishlistsData.length > 1) {
      bMultipleWishlists = true;
    }
    return bMultipleWishlists;
  };

  WishlistsModel.prototype._getDefaultHref = function () {
    var sDefaultHref = null,
      iDefaultData = 0,
      aWishlistsData = this._aDataStores;

    if (!aWishlistsData) {
      return null;
    }
    iDefaultData = aWishlistsData.length - 1;
    sDefaultHref = aWishlistsData[iDefaultData].href.replace('action=new', 'action=choose');
    return sDefaultHref;
  };

  WishlistsModel.prototype._getDefaultName = function () {
    var sDefaultName = null,
      iDefaultData = 0,
      aWishlistsData = this._aDataStores;

    if (!aWishlistsData) {
      return null;
    }
    iDefaultData = aWishlistsData.length - 1;
    sDefaultName = aWishlistsData[iDefaultData].defaultName;
    return sDefaultName;
  };

  return WishlistsModel;
});

define('modules/pdp/classMap',['require','exports','module','modules/pdp/controllers/AddRemoveServiceController','modules/pdp/controllers/AddToBasketController','modules/pdp/views/AddToBasketView','modules/pdp/models/AssetModel','modules/pdp/models/bucket-group/index','modules/pdp/controllers/BundleController','modules/pdp/views/BuyboxView','modules/pdp/models/CategoryModel','modules/pdp/controllers/DeliveryOptionsController','modules/pdp/models/DeliveryOptionsModel','modules/pdp/views/DeliverySnippetView','modules/pdp/models/FormHandlerModel','modules/pdp/controllers/InlineContentController','modules/pdp/models/InventoryProductModel','modules/pdp/models/InventorySKUModel','modules/pdp/models/InventoryStoreModel','modules/pdp/controllers/ItemActionsController','modules/pdp/views/KioskProductPageView','modules/pdp/controllers/kiosk-tabs/index','modules/pdp/controllers/linksave/index','modules/pdp/models/marketing/sku/index','modules/pdp/controllers/PanelController','modules/pdp/controllers/PersonaliseController','modules/pdp/controllers/PriceCheckController','modules/pdp/controllers/ProductController','modules/pdp/models/ProductModel','modules/pdp/controllers/PromotionsController','modules/pdp/models/PromotionsModel','modules/pdp/views/PromotionsView','modules/pdp/controllers/RecommendersController','modules/pdp/controllers/RelatedItemsController','modules/pdp/models/RelatedItemsModel','modules/pdp/controllers/RelatedProductController','modules/pdp/views/RelatedProductView','modules/pdp/controllers/RelatedSKUController','modules/pdp/views/RelatedSKUView','modules/pdp/controllers/RequestStockAlertController','modules/pdp/controllers/SellerController','modules/pdp/models/SellerModel','modules/pdp/views/ServicesBannerView','modules/pdp/controllers/ServicesController','modules/pdp/views/ServicesFormView','modules/pdp/models/ServicesModel','modules/pdp/controllers/SkuController','modules/pdp/models/SkuModel','modules/pdp/models/StoreModel','modules/pdp/controllers/StoreStockCheckController','modules/pdp/controllers/VariantsController','modules/pdp/views/VariantsView','modules/pdp/controllers/WarrantiesController','modules/pdp/controllers/WishlistsController','modules/pdp/models/WishlistsModel'],function (require, exports, module) {
  'use strict';

  var AddRemoveServiceController = require('modules/pdp/controllers/AddRemoveServiceController');
  var AddToBasketController = require('modules/pdp/controllers/AddToBasketController');
  var AddToBasketView = require('modules/pdp/views/AddToBasketView');
  var AssetModel = require('modules/pdp/models/AssetModel');
  var BucketGroupModel = require('modules/pdp/models/bucket-group/index');
  var BundleController = require('modules/pdp/controllers/BundleController');
  var BuyboxView = require('modules/pdp/views/BuyboxView');
  var CategoryModel = require('modules/pdp/models/CategoryModel');
  var DeliveryOptionsController = require('modules/pdp/controllers/DeliveryOptionsController');
  var DeliveryOptionsModel = require('modules/pdp/models/DeliveryOptionsModel');
  var DeliverySnippetView = require('modules/pdp/views/DeliverySnippetView');
  var FormHandlerModel = require('modules/pdp/models/FormHandlerModel');
  var InlineContentController = require('modules/pdp/controllers/InlineContentController');
  var InventoryProductModel = require('modules/pdp/models/InventoryProductModel');
  var InventorySKUModel = require('modules/pdp/models/InventorySKUModel');
  var InventoryStoreModel = require('modules/pdp/models/InventoryStoreModel');
  var ItemActionsController = require('modules/pdp/controllers/ItemActionsController');
  var KioskProductPageView = require('modules/pdp/views/KioskProductPageView');
  var KioskTabsController = require('modules/pdp/controllers/kiosk-tabs/index');
  var LinksaveController = require('modules/pdp/controllers/linksave/index');
  var MarketingSkuModel = require('modules/pdp/models/marketing/sku/index');
  var PanelController = require('modules/pdp/controllers/PanelController');
  var PersonaliseController = require('modules/pdp/controllers/PersonaliseController');
  var PriceCheckController = require('modules/pdp/controllers/PriceCheckController');
  var ProductController = require('modules/pdp/controllers/ProductController');
  var ProductModel = require('modules/pdp/models/ProductModel');
  var PromotionsController = require('modules/pdp/controllers/PromotionsController');
  var PromotionsModel = require('modules/pdp/models/PromotionsModel');
  var PromotionsView = require('modules/pdp/views/PromotionsView');
  var RecommendersController = require('modules/pdp/controllers/RecommendersController');
  var RelatedItemsController = require('modules/pdp/controllers/RelatedItemsController');
  var RelatedItemsModel = require('modules/pdp/models/RelatedItemsModel');
  var RelatedProductController = require('modules/pdp/controllers/RelatedProductController');
  var RelatedProductView = require('modules/pdp/views/RelatedProductView');
  var RelatedSKUController = require('modules/pdp/controllers/RelatedSKUController');
  var RelatedSKUView = require('modules/pdp/views/RelatedSKUView');
  var RequestStockAlertController = require('modules/pdp/controllers/RequestStockAlertController');
  var SellerController = require('modules/pdp/controllers/SellerController');
  var SellerModel = require('modules/pdp/models/SellerModel');
  var ServicesBannerView = require('modules/pdp/views/ServicesBannerView');
  var ServicesController = require('modules/pdp/controllers/ServicesController');
  var ServicesFormView = require('modules/pdp/views/ServicesFormView');
  var ServicesModel = require('modules/pdp/models/ServicesModel');
  var SkuController = require('modules/pdp/controllers/SkuController');
  var SkuModel = require('modules/pdp/models/SkuModel');
  var StoreModel = require('modules/pdp/models/StoreModel');
  var StoreStockCheckController = require('modules/pdp/controllers/StoreStockCheckController');
  var VariantsController = require('modules/pdp/controllers/VariantsController');
  var VariantsView = require('modules/pdp/views/VariantsView');
  var WarrantiesController = require('modules/pdp/controllers/WarrantiesController');
  var WishlistsController = require('modules/pdp/controllers/WishlistsController');
  var WishlistsModel = require('modules/pdp/models/WishlistsModel');

  /**
   * Used by a page controller to look up which models, views and controllers it needs to create.
   * It is also used by the data controller to determine when to fire certain events.
   *
   * @type {Object}
   */
  var classMap = {
    classes: {
      model: {
        assets: AssetModel,
        bucketGroup: BucketGroupModel,
        categories: CategoryModel,
        deliveryOptions: DeliveryOptionsModel,
        formHandler: FormHandlerModel,
        inventoryProduct: InventoryProductModel,
        inventorySKU: InventorySKUModel,
        inventoryStore: InventoryStoreModel,
        links: RelatedItemsModel,
        marketingSku: MarketingSkuModel,
        products: ProductModel,
        promotions: PromotionsModel,
        sellers: SellerModel,
        services: ServicesModel,
        sku: SkuModel,
        stores: StoreModel,
        wishlists: WishlistsModel
      },
      view: {
        deliveryOptions: {
          snippet: DeliverySnippetView
        },
        products: {
          dropdown: VariantsView,
          links: RelatedProductView,
          variants: VariantsView
        },
        promotions: {
          _default: PromotionsView
        },
        services: {
          banner: ServicesBannerView,
          form: ServicesFormView
        },
        sku: {
          buybox: BuyboxView,
          buybutton: AddToBasketView,
          kioskPage: KioskProductPageView,
          links: RelatedSKUView
        }
      },
      controller: {
        deliveryOptions: {
          _default: DeliveryOptionsController
        },
        formHandler: {
          addToBasket: AddToBasketController,
          requestStockAlert: RequestStockAlertController,
          services: AddRemoveServiceController
        },
        inherit: {
          bundle: BundleController,
          itemActions: ItemActionsController,
          recommender: RecommendersController
        },
        links: {
          _default: RelatedItemsController,
          tabs: KioskTabsController
        },
        panel: {
          _default: PanelController
        },
        products: {
          _default: ProductController,
          links: RelatedProductController,
          variants: VariantsController
        },
        promotions: {
          _default: PromotionsController,
          linksave: LinksaveController
        },
        sellers: {
          _default: SellerController,
          warranties: WarrantiesController
        },
        services: {
          _default: ServicesController
        },
        sku: {
          _default: SkuController,
          competitors: PriceCheckController,
          inlineContent: InlineContentController,
          links: RelatedSKUController,
          personalise: PersonaliseController,
          variants: VariantsController
        },
        stores: {
          storeStockCheck: StoreStockCheckController
        },
        wishlists: {
          _default: WishlistsController
        }
      }
    },
    /**
     * Finds and returns a Class from the type and namespace.
     * @param {String} sType The type of Class, i.e. 'view'
     * @param {String} sNamespace The Class's namespace, i.e. 'product'
     * @param {String} sTag The Class's tag, i.e. 'addToBasket'
     * @return {Function} A Class.
     */
    find: function (sType, sNamespace, sTag) {
      var mOutput = false;

      if (classMap.classes[sType][sNamespace]) {
        if (sType === 'model') {
          mOutput = classMap.classes[sType][sNamespace];
        } else if (sType === 'controller') {
          if (sTag && classMap.classes[sType][sNamespace].hasOwnProperty(sTag)) {
            mOutput = classMap.classes[sType][sNamespace][sTag];
          } else if (classMap.classes[sType][sNamespace].hasOwnProperty('_default')) {
            mOutput = classMap.classes[sType][sNamespace]._default;
          }
        } else {
          mOutput = classMap.classes[sType][sNamespace][sTag];
        }
      }

      return mOutput;
    },
    /**
     * Checks if a namespace exists as a property of the class's model object.
     * @param {String} sType The type of class to search in.
     * @param {String} sNamespace The namespace to search for.
     * @return {Boolean} Whether the namespace is mapped.
     */
    hasNamespace: function (sType, sNamespace) {
      if (classMap.classes[sType].hasOwnProperty(sNamespace)) {
        return true;
      }

      return false;
    }
  };

  module.exports = classMap;
});


define('text!templates/views/tooltipPanelView.html',[],function () { return '<div id="{{sViewId}}" class="PDP-Version2__component info-panel {{sViewClass}} {{sClassNames}}">\r\n  <div class="info-panel-content-wrapper">\r\n    <span class="icon tooltip-error-icon" data-icon="8"></span>\r\n    <div class="text text-block smaller info-panel-content">\r\n      {{#aSubViews}}\r\n        {{{render}}}\r\n      {{/aSubViews}}\r\n    </div>\r\n  </div>\r\n  <a class="icon info-panel-close-icon" data-icon="y"></a>\r\n  <span class="icon tooltip-pointer"></span>\r\n  {{{oEvent}}}{{{addViewDataAttr}}}\r\n</div>\r\n';});

define('modules/pdp/views/TooltipPanelView',['require','exports','module','modules/mvc/fn','modules/pdp/views/BasePanelView','modules/breakpoint','text!templates/views/tooltipPanelView.html'],function (require, exports, module) {
  'use strict';


  var fn = require('modules/mvc/fn'),
    BasePanelView = require('modules/pdp/views/BasePanelView'),
    breakpoint = require('modules/breakpoint'),
    template = require('text!templates/views/tooltipPanelView.html');


  /**
   *
   * @param {Object} oConfig
   * @return {void}
   */
  function TooltipPanelView(oConfig) {
    this.sTag = 'tooltip';
    this.sViewName = 'TooltipPanelView';
    this.sViewClass = 'info-panel-tooltip';
    this.sTooltipType = oConfig.sTooltipType || 'default';
    this.sTooltopMessage = oConfig.sTooltopMessage;
    this.parent.constructor.call(this, oConfig);

    // override default info panel template
    this.sTemplate = template;

    if ($(this.sSelector).length) {
      this.oElms.elTarget = $(this.sSelector)[0];
      this.sOutput = 'outer';
    } else {
      this.sOutput = 'append';
    }
  }

  fn.inherit(TooltipPanelView, BasePanelView);

  TooltipPanelView._name = 'TooltipPanelView';

  TooltipPanelView.prototype._cacheDomElms = function () {
    var POINTER = '.tooltip-pointer',
      CONTENT_WRAPPER = '.info-panel-content-wrapper';

    this.parent._cacheDomElms.call(this);
    this.oElms.elPointer = $(this.oElms.elWrapper).find(POINTER);
    this.oElms.elParentContentWrapper = $(this.oElms.elTrigger).closest(CONTENT_WRAPPER)[0];
  };

  /**
   * Binds the events required by the TooltipPanelView.
   * @return {void}
   */
  TooltipPanelView.prototype._bindEvents = function () {
    if (this.sTooltipType === 'default') {
      this.parent._bindEvents.call(this);
    }
  };

  /**
   * Unbinds the base events required by the TooltipPanelView.
   * @return {void}
   */
  TooltipPanelView.prototype._unbindEvents = function () {
    if (this.sTooltipType === 'default') {
      this.parent._unbindEvents.call(this);
    }
  };

  TooltipPanelView.prototype._openEndHook = function () {
    this._positionTooltip(breakpoint.currentViewport);
    this._onOpenBindEvents();
  };

  TooltipPanelView.prototype._closeEndHook = function (oEvent) {
    if (this.sTooltipType === 'error') {
      this.destroy(oEvent);
    }

    this._onCloseUnbindEvents();
  };

  TooltipPanelView.prototype._onOpenBindEvents = function () {
    $(window).on(
      'resize.positionTooltip-' + this.sKeyId,
      this._onResize.bind(this)
    );
    $('body').on(
      'click.closeTooltip-' + this.sKeyId,
      this._onBodyClick.bind(this)
    );
    if (this.oElms.elParentContentWrapper) {
      $(this.oElms.elParentContentWrapper).on(
        'scroll.closeTooltip-' + this.sKeyId,
        this._onPanelContentScroll.bind(this)
      );
    }
  };

  TooltipPanelView.prototype._onCloseUnbindEvents = function () {
    $(window).off('resize.positionTooltip-' + this.sKeyId);
    $('body').off('click.closeTooltip-' + this.sKeyId);
    $(this.oElms.elParentContentWrapper).off('scroll.closeTooltip-' + this.sKeyId);
  };

  TooltipPanelView.prototype._addAttributes = function () {
    var zIndex = undefined,
      INFO_PANEL = '.info-panel',
      $panelWrapper = $(this.oElms.elWrapper),
      $parentPanel = $(this.oElms.elTrigger).closest(INFO_PANEL);

    this.parent._addAttributes.call(this, {
      wrapper: $panelWrapper,
      parent: $parentPanel,
      zIndex: false
    });

    if ($parentPanel.length > 0) {
      if ($parentPanel.hasClass('fullScreen-' + breakpoint.currentViewport)) {
        zIndex = parseInt($parentPanel.css('z-index'), 10) + 1;
        $panelWrapper.css({ zIndex: zIndex });
      }
    }
  };

  TooltipPanelView.prototype._positionTooltip = function (sViewport) {
    var $Body = $('body'),
      $Trigger = $(this.oElms.elTrigger),
      $Wrapper = $(this.oElms.elWrapper),
      $Pointer = $(this.oElms.elPointer),
      iBodyTop = 0,
      iBodyHeight = $Body.height(),
      iBodyWidth = $Body.width(),
      isScrollDisabled = $Body.hasClass('disableScroll'),
      iTriggerOffsetTop = $Trigger.offset().top,
      iTriggerOffsetLeft = $Trigger.offset().left,
      iTriggerWidth = $Trigger.outerWidth(),
      iTriggerHeight = $Trigger.outerHeight(),
      iToolTipWidth = $Wrapper.outerWidth(),
      iTooltipOffsetLeft = 0,
      iTooltipOffsetTop = 0,
      iTooltipOffsetBottom = 0,
      iPointerOffestLeft = 0,
      iPointerOffestTop = 0,
      POINTER_WIDTH = 29,
      SPACE_FROM_TRIGGER = 20;

    if (isScrollDisabled) {
      iBodyTop = Math.abs(parseInt($Body.css('top'), 10));
    }

    if (this.oStyles[sViewport].indexOf('tooltip-top') !== -1) {
      // calculate tooltip's vertical position
      iTooltipOffsetBottom = (iBodyHeight - iTriggerOffsetTop) + SPACE_FROM_TRIGGER;

      // calculate tooltip's horizonal position
      iTooltipOffsetLeft = iTriggerOffsetLeft - Math.round((iToolTipWidth - iTriggerWidth) / 2);

      if (iTooltipOffsetLeft < 0) {
        iTooltipOffsetLeft = 10;
      } else if ((iTooltipOffsetLeft + iToolTipWidth) > iBodyWidth) {
        iTooltipOffsetLeft = iBodyWidth - iToolTipWidth - 10;
      }

      // calculate pointer's horizonal position
      iPointerOffestLeft = (iTriggerOffsetLeft - iTooltipOffsetLeft)
          + Math.round((iTriggerWidth - POINTER_WIDTH) / 2);

      $Wrapper.css({
        top: '',
        left: iTooltipOffsetLeft,
        bottom: iTooltipOffsetBottom
      });

      $Pointer.css({
        top: '',
        left: iPointerOffestLeft
      });
    } else if (this.oStyles[sViewport].indexOf('tooltip-right') !== -1) {
      // calculate tooltip's vertical position
      iTooltipOffsetTop = isScrollDisabled
          ? iTriggerOffsetTop + iBodyTop
          : iTriggerOffsetTop;

      // calculate tooltip's horizonal position
      iTooltipOffsetLeft = iTriggerOffsetLeft + iTriggerWidth + SPACE_FROM_TRIGGER;

      // calculate pointer's horizonal position
      iPointerOffestTop = (iTriggerOffsetTop - iTooltipOffsetTop) + POINTER_WIDTH
          + Math.round((iTriggerHeight - POINTER_WIDTH) / 2);

      $Wrapper.css({
        top: iTooltipOffsetTop,
        left: iTooltipOffsetLeft,
        bottom: ''
      });

      $Pointer.css({
        top: iPointerOffestTop,
        left: ''
      });
    } else if (this.oStyles[sViewport].indexOf('tooltip-bottom') !== -1) {
      // calculate tooltip's vertical position
      iTooltipOffsetTop = isScrollDisabled
          ? iTriggerOffsetTop + iTriggerHeight + SPACE_FROM_TRIGGER + iBodyTop
          : iTriggerOffsetTop + iTriggerHeight + SPACE_FROM_TRIGGER;

      // calculate tooltip's horizonal position
      iTooltipOffsetLeft = iTriggerOffsetLeft - Math.round((iToolTipWidth - iTriggerWidth) / 2);

      if (iTooltipOffsetLeft < 0) {
        iTooltipOffsetLeft = 10;
      } else if ((iTooltipOffsetLeft + iToolTipWidth) > iBodyWidth) {
        iTooltipOffsetLeft = iBodyWidth - iToolTipWidth - 10;
      }

      // calculate pointer's horizonal position
      iPointerOffestLeft = (iTriggerOffsetLeft - iTooltipOffsetLeft)
          + Math.round((iTriggerWidth - POINTER_WIDTH) / 2);

      $Wrapper.css({
        top: iTooltipOffsetTop,
        left: iTooltipOffsetLeft,
        bottom: ''
      });

      $Pointer.css({
        top: '',
        left: iPointerOffestLeft
      });
    } else if (this.oStyles[sViewport].indexOf('tooltip-left') !== -1) {
      // calculate tooltip's vertical position
      iTooltipOffsetTop = isScrollDisabled
          ? iTriggerOffsetTop + iBodyTop
          : iTriggerOffsetTop;

      // calculate tooltip's horizonal position
      iTooltipOffsetLeft = iTriggerOffsetLeft - iToolTipWidth - SPACE_FROM_TRIGGER;

      // calculate pointer's horizonal position
      iPointerOffestTop = (iTriggerOffsetTop - iTooltipOffsetTop)
          + Math.round((iTriggerHeight - POINTER_WIDTH) / 2);

      $Wrapper.css({
        top: iTooltipOffsetTop,
        left: iTooltipOffsetLeft,
        bottom: ''
      });

      $Pointer.css({
        top: iPointerOffestTop,
        left: ''
      });
    }
  };

  TooltipPanelView.prototype._onResize = function () {
    var _this = this,
      breakpointChangeTimer = null;

    window.clearTimeout(breakpointChangeTimer);
    breakpointChangeTimer = window.setTimeout(function () {
      _this._positionTooltip(breakpoint.currentViewport);
    }, 100);
  };

  TooltipPanelView.prototype._onBodyClick = function (oEvent) {
    if (oEvent.target === this.oElms.elTrigger) {
      oEvent.stopPropagation();
      return;
    }

    if ($(oEvent.target).closest(this.oElms.elWrapper).length > 0) {
      oEvent.stopPropagation();
      return;
    }

    this.close();
  };

  TooltipPanelView.prototype._onPanelContentScroll = function () {
    this.close();
  };


  module.exports = TooltipPanelView;
});

define('modules/pdp/controllers/BasePageController', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/BaseClass',
  'modules/pdp/classMap',
  /**
   * Add modules below that need to be required in order to be used later in the code and cannot
   * be required normally because of a cyclical dependancy problem.
   */
  'modules/mvc/ev',
  'modules/pdp/views/TooltipPanelView',
  'modules/pdp/views/OverlayPanelGroupView',
  'modules/pdp/views/OverlayPanelView'
], function ($, fn, BaseClass, classMap) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @param {Boolean} config.isKiosk
   * @param {String} config.baseURL
   * @param {String} config.pageType
   * @return {void}
   */
  function BasePageController(config) {
    var _config = config || {};

    this.mc = { model: {}, controller: {} };
    this._bindEvents();
    this.views = {};
    this.isKiosk = _config.isKiosk || false;
    this.baseURL = _config.baseURL || '';
    this.pageGroup = _config.pageGroup || '';
    this.pageType = _config.pageType || '';
    this.pageEventDelegator = _config.pageEventDelegator || '';
  }

  fn.inherit(BasePageController, BaseClass);

  BasePageController.prototype._bindEvents = function () {
    $(window)
      .on('rendered', this._onRendered.bind(this))
      .on('render', this._onRender.bind(this))
      .on('create', this._onCreate.bind(this))
      .on('destroyView', this._onDestroyView.bind(this))
      .on('refresh', this._onRefresh.bind(this))
      .on('addData', this._onAddData.bind(this))
      .on('fetchData', this._onFetchData.bind(this))
      .on('queryModel', this._onQueryModel.bind(this));
  };

  /**
   * Method is run when a view renders in the DOM, getting the view's controller and then running
   * the controllers post render actions.
   * @param {Object} event The event object that includes the view object.
   * @return {void}
   */
  BasePageController.prototype._onRendered = function (event) {
    var data = event.oData,
      view = event.oData.oView,
      controller = this.getModule(
        'controller',
        data.inherits ? 'inherit' : data.sNamespace,
        data.sTag
      );

    if (controller) {
      controller.postRenderHook(data);
    } else if (view) {
      view.postRenderHook();
    }
  };

  /**
   * Method is run when either a view is rendered in the DOM and requires a sub view to be rendered,
   * and that sub view requires data to be fetched, or when a model or controller wants to render
   * a view independently.
   * @param {Object} event The event object that includes the view configuration object.
   * @return {void}
   */
  BasePageController.prototype._onRender = function (event) {
    this.render(event.oData);
  };

  BasePageController.prototype.render = function (args) {
    var controller = this.getModule(
        'controller',
        args.inherits ? 'inherit' : args.sNamespace,
        args.sTag
      );

    if (controller) {
      controller.renderView(args);
    }
  };

  /**
   * Method creates a view object, gets its controller and model and passes it the relevant
   * data. It can be used for when you are rendering a component from the server, but still want to
   * create a frontend view and bind specific functionality to it.
   * @param {Object} event The jQuery event object.
   * @return {void}
   */
  BasePageController.prototype._onCreate = function (event) {
    this.create(event.oData);
  };

  BasePageController.prototype.create = function (args) {
    var controller = this.getModule(
        'controller',
        args.sNamespace,
        args.sTag
      );

    if (controller) {
      controller.createView(args);
    }
  };

  BasePageController.prototype._onDestroyView = function (event) {
    this.destroyView(event.oData);
  };

  BasePageController.prototype.destroyView = function (args) {
    var controller = this.getModule(
        'controller',
        args.sNamespace,
        args.sTag
      );

    if (controller) {
      controller.destroyView(args);
    }
  };

  /**
   * Method refreshes a view object.
   * @param {Object} $event The jQuery event object.
   * @return {void}
   */
  BasePageController.prototype._onRefresh = function ($event) {
    var controller = this.getModule(
        'controller',
        $event.oData.sNamespace,
        $event.oData.sTag
      );

    if (controller) {
      controller.refreshView($event.oData);
    }
  };

  /**
   * Method runs when the data controller fires its 'addDataToModel' event and the page controller
   * then returns the correct model and adds the data to it.
   * @param {Object} event The event object that includes the view configuration object.
   * @return {void}
   */
  BasePageController.prototype._onAddData = function (event) {
    this.addData(event.oData);
  };

  BasePageController.prototype.addData = function (args) {
    var model = this.getModule(
      'model',
      args.sNamespace
    );

    if (model) {
      model.add(args.mAddData);
    }
  };

  /**
   * Method runs when a controller triggers a 'fetchData' event, and the page controller gets the
   * appropriate controller and passes the data to the controller to action.
   * @param {Object} $event The event object that includes the view configuration object.
   * @return {void}
   */
  BasePageController.prototype._onFetchData = function ($event) {
    var oController = this.getModule(
        'controller',
        $event.oData.sNamespace,
        $event.oData.sTag
      );

    if (oController) {
      oController.fetchData($event.oData);
    }
  };

  /**
   * Method returns a model and the requested data to the view/controller.
   * @param {Object} event The event object that includes the request for the model.
   * @return {void}
   */
  BasePageController.prototype._onQueryModel = function (event) {
    this.queryModel(event.oData);
  };

  BasePageController.prototype.queryModel = function (args) {
    var queryParams = args.oQueryParams,
      deferred = null,
      returnPromise = false,
      output = {},
      model = this.getModule(
      'model',
      args.sNamespace
    );

    if (args.oDeferred) {
      deferred = args.oDeferred;
    } else {
      deferred = $.Deferred();
      returnPromise = true;
    }

    if (model) {
      if (args.sCommand) {
        if (args.sCommand === 'get') {
          queryParams.oDeferred = deferred;
        }

        output = model[args.sCommand](queryParams);
      } else {
        output = model;
      }

      if (args.sCommand !== 'get') {
        deferred.resolve(output);
      }
    } else {
      deferred.resolve(false);
    }

    return returnPromise ? deferred.promise() : undefined;
  };

  /**
   * Method tries to find a model or controller, or creates a new one.
   * @param {String} sType The type of the object, i.e. 'model'.
   * @param {String} sNamespace The namespace of the object, i.e. 'products'.
   * @param {String} sTag The tag of the object, i.e. 'addToBasket'.
   * @return {Object} The object reference to the view, model or controller.
   */
  BasePageController.prototype.getModule = function (sType, sNamespace, sTag) {
    return this._find(sType, sNamespace, sTag) || this._create(sType, sNamespace, sTag);
  };

  /**
   * Method returns a model or constroller.
   * @param {String} sType The type of the object, i.e. 'model'.
   * @param {String} sNamespace The namespace of the object, i.e. 'products'.
   * @param {String} sTag The tag of the object, i.e. 'addToBasket'.
   * @return {Object|Boolean} The object reference to the view, model or controller, or false.
   */
  BasePageController.prototype._find = function (sType, sNamespace, sTag) {
    var DEFAULT = '_default',
      sProp = '',
      hasOwnProp = false,
      mOutput = false;

    if (this.mc[sType][sNamespace]) {
      if (sType === 'model') {
        mOutput = this.mc[sType][sNamespace];
      } else if (sType === 'controller') {
        if (sTag && classMap.classes[sType][sNamespace].hasOwnProperty(sTag)) {
          hasOwnProp = true;
        }

        sProp = hasOwnProp ? sTag : DEFAULT;

        if (this.mc[sType][sNamespace][sProp]) {
          mOutput = this.mc[sType][sNamespace][sProp];
        }
      }
    }

    return mOutput;
  };


  /**
   *
   * @param {String} type
   * @param {String} namespace
   * @param {String} tag
   * @return {Object}
   */
  BasePageController.prototype._create = function (type, namespace, tag) {
    var instance = null,
      _class = classMap.find(type, namespace, tag),
      modelInstances = [];

    if (typeof _class === 'function') {
      if (type === 'model') {
        instance = new _class({ baseURL: this.baseURL });
      } else if (type === 'controller') {
        if (fn.isArray(_class.modelNames, { notEmpty: true })) {
          fn.loopArray.call(this, _class.modelNames, function loopModelNames(i) {
            modelInstances.push(this.getModule('model', _class.modelNames[i]));
          });
        } else {
          modelInstances = this.getModule('model', namespace);
        }

        instance = new _class(modelInstances, {
          pageGroup: this.pageGroup,
          pageType: this.pageType,
          pageEventDelegator: this.pageEventDelegator
        });
      }
    }

    if (fn.isObject(instance, { notEmpty: true })) {
      if (type === 'model') {
        this.mc[type][instance.sNamespace] = instance;
      } else if (type === 'controller') {
        if (typeof instance._initDependancies === 'function') {
          instance._initDependancies();
        }

        if (!fn.isObject(this.mc[type][instance.sNamespace], { notEmpty: true })) {
          this.mc[type][instance.sNamespace] = {};
        }
        this.mc[type][instance.sNamespace][instance.sTag] = instance;
      }
    }

    return instance;
  };


  return BasePageController;
});

define('modules/pdp/reviews/bazaarvoice', [
  'modules/tesco.utils',
  'modules/product-description/common'
], function (
  tescoUtils,
  pdp
) {
  'use strict';

  var asyncBVLibrary = null,
    initBV = null,
    sSkuId = '';

  asyncBVLibrary = function (sBVSrcURL) {
    var sBVSrc = sBVSrcURL || 'http://display-stg.ugc.bazaarvoice.com/static/Tesco/bvapi.js',
      oBVJS = null,
      oHead = null;

    window.PDPLazyLoadBV = true;
    if (window.PDPLazyLoadBV) {
      $(window).load(function () {
        tescoUtils.lazyLoadJS(sBVSrc).done(function () {
          try {
            initBV(sSkuId);
          } catch (e) {
            // continue regardless of error
          }
        });
      });
    } else {
      oBVJS = document.createElement('script');
      oHead = document.getElementsByTagName('head')[0];

      oBVJS.type = 'text/javascript';
      oBVJS.src = sBVSrc;
      oBVJS.async = true;
      oHead.appendChild(oBVJS);
    }
  };

  initBV = function (sSkuIdToShow) {
    sSkuId = sSkuIdToShow;
    if (window.$BV !== undefined) {
      window.$BV.configure('global', {
        productId: sSkuId,
        events: {
          bvRender: function () {
            if (!window.isKiosk()) {
              pdp.formatCustomisedBV();
            } else {
              $(window).trigger('bazaarVoiceLoaded');
            }
          }
        }
      });
      setTimeout(function initBVInt() {
        window.$BV.ui('rr', 'show_reviews');
      }, 10);
    }
  };

  return {
    asyncBVLibrary: asyncBVLibrary,
    initBV: initBV
  };
});

define('modules/pdp/controllers/ProductPageController',['require','exports','module','modules/mvc/fn','modules/pdp/controllers/BasePageController','modules/pdp/reviews/bazaarvoice','modules/pdp/media-viewer/common','modules/tesco.utils','modules/google-analytics/pdpTracking'],function (require, exports, module) {
  'use strict';


  var fn = require('modules/mvc/fn'),
    BasePageController = require('modules/pdp/controllers/BasePageController'),
    bazaarvoice = require('modules/pdp/reviews/bazaarvoice'),
    mediaViewer = require('modules/pdp/media-viewer/common'),
    tescoUtils = require('modules/tesco.utils'),
    googleEC = require('modules/google-analytics/pdpTracking');


  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function ProductPageController(config) {
    this.parent.constructor.call(this, config);
    /**
     * Initialise any models/controllers you need before page load.
     */
    this._create('model', 'products');
    this._create('model', 'sku');
    this._create('model', 'sellers');
    this._create('model', 'assets');
    this._create('model', 'wishlists');

    this._create('controller', 'products', '_default');
    this._create('controller', 'sku', '_default');
    this._create('controller', 'sellers', '_default');
    this._create('controller', 'panel', '_default');
    this._create('controller', 'inherit', 'itemActions');

    this._scrollActions = [];
    this._activeProduct = {};
    this._activeSku = {};
    this._selectedSku = {};

    // TODO: Remove properies from here to fix UES properly
    this.ues = {};
    this.ues.schoolId = '';
    this.ues.schoolName = '';
    this.ues.slogoRef = '';
  }


  fn.inherit(ProductPageController, BasePageController);


  /**
   *
   * @param {string|Object} product
   * @param {string|Object} sku
   * @param {Object} [extraData]
   * @param {JQueryDeferred} [_deferred] Used for unit tests
   * @return {void}
   */
  ProductPageController.prototype.init = function (product, sku, extraData, _deferred) {
    var _this = this,
      _extraData = extraData || {},
      dataReady = { data: {}, name: 'dataReady', propName: 'oData' },
      flags = this._setFlags(_extraData.flags);

    this._collateCatalogData(product, sku, _extraData)
      .done(function handleCatalogDataSuccess(productDataStore, skuDataStore) {
        _this._collateInventoryData(productDataStore, flags)
          .done(function handleInventoryDataSuccess() {
            _this._setActiveAndSelected(productDataStore, skuDataStore, flags);
            _this._setHistory(productDataStore, skuDataStore, flags);

            dataReady.data = { flags: flags, product: productDataStore, sku: skuDataStore };
            fn.createEvent(dataReady).fire();

            if (flags.isPageLoad) {
              _this.bindEventHandlers();
            }

            _this._initDependancies(productDataStore, skuDataStore, flags);

            if (_deferred) {
              _deferred.resolve();
            }
            googleEC.setAnalytics(skuDataStore, flags);
          });
      })
      .fail(function handleCatalogDataFailure() {
        if (_deferred) {
          _deferred.reject();
        }
      });
  };


  /**
   *
   * @param {Object|undefined} flags
   * @return {Object}
   */
  ProductPageController.prototype._setFlags = function (flags) {
    var _flags = flags || {},
      hasAkamaiCaching = _flags.hasAkamaiCaching;

    return {
      hasAkamaiCaching: typeof hasAkamaiCaching === 'boolean' ? hasAkamaiCaching : true,
      isPageLoad: !_flags.isVariantChange,
      isPopState: !!_flags.isPopState,
      isPrimaryVariantChange: !!_flags.isPrimaryVariantChange,
      isProductChange: !!_flags.isProductChange,
      productVariantSelected: !!_flags.productVariantSelected,
      isSecondaryVariantChange: !!_flags.isSecondaryVariantChange,
      isSkuChange: !!_flags.isSkuChange,
      isVariantChange: !!_flags.isVariantChange
    };
  };


  /**
   *
   * @param {string|Object} product
   * @param {string|Object} sku
   * @param {Object} extraData
   * @return {JQueryPromise}
   */
  ProductPageController.prototype._collateCatalogData = function (product, sku, extraData) {
    var deferred = $.Deferred(),
      hasExtraProductData = fn.isObject(extraData.products, { notEmpty: true }),
      hasExtraSkuData = fn.isObject(extraData.sku, { notEmpty: true }),
      hasProductData = false,
      hasSkuData = false,
      productDataStore = {},
      productID = '',
      productModel = this.getModule('model', 'products'),
      skuDataStore = {},
      skuID = '',
      skuModel = this.getModule('model', 'sku');

    if (fn.checkData(product, ['id', 'links'])) {
      if (hasExtraProductData) {
        fn.mergeObjects(product, extraData.products, { extend: true });
      }
      productModel.setDataStores(product);
      hasProductData = true;
    }

    if (fn.checkData(sku, ['id', 'links'])) {
      if (hasExtraSkuData) {
        fn.mergeObjects(sku, extraData.sku, { extend: true });
      }
      skuModel.setDataStores(sku);
      hasSkuData = true;
    }

    if (hasProductData && hasSkuData) {
      deferred.resolve(product, sku);
      return deferred.promise();
    }

    if (typeof product !== 'string' || !product.length) {
      deferred.reject();
      return deferred.promise();
    }

    productID = product;
    skuID = typeof sku === 'string' ? sku : '';

    productModel.getDataStores({ fetch: true, value: productID })
      .done(function handleGetProductResponse(productResp) {
        if (!fn.checkData(productResp, ['id', 'links'])) {
          deferred.reject();
          return;
        }

        productDataStore = productResp;

        if (hasExtraProductData) {
          fn.mergeObjects(productDataStore, extraData.products, { extend: true });
          productModel.setDataStores(productDataStore);
        }

        if (!skuID) {
          skuID = productModel.getDefaultSku(productDataStore).id;
        }

        skuModel.getDataStores({ fetch: true, value: skuID })
          .done(function handleGetSkuResponse(skuResp) {
            if (!fn.checkData(skuResp, ['id', 'links'])) {
              deferred.reject();
              return;
            }

            skuDataStore = skuResp;

            if (hasExtraSkuData) {
              fn.mergeObjects(skuDataStore, extraData.sku, { extend: true });
              skuModel.setDataStores(skuDataStore);
            }

            deferred.resolve(productDataStore, skuDataStore);
          });
      });

    return deferred.promise();
  };


  /**
   *
   * @param {Object} product
   * @param {Object} flags
   * @return {JQueryPromise}
   */
  ProductPageController.prototype._collateInventoryData = function (product, flags) {
    var _this = this,
      deferred = $.Deferred(),
      inventoryProductModel = this.getModule('model', 'inventoryProduct');

    if (flags.isPageLoad && flags.hasAkamaiCaching) {
      deferred.resolve();
      return deferred.promise();
    }

    inventoryProductModel.getDataStores({ fetch: true, value: [product.id] })
      .done(function handleGetProductInventoryResponse(inventory) {
        if (fn.checkData(inventory, ['id', 'skus'])) {
          _this._addInventory(inventory);
        }

        deferred.resolve();
      });

    return deferred.promise();
  };


  /**
   *
   * @param {Object} product
   * @param {Object} sku
   * @param {Object} flags
   * @return {void}
   */
  ProductPageController.prototype._setActiveAndSelected = function (product, sku, flags) {
    var isFF = false,
      productModel = this.getModule('model', 'products'),
      singleChildSku = false,
      skuInURL = false;

    isFF = productModel.isFF(product);
    singleChildSku = productModel.getLinks({ data: product, value: 'childSku' }).length === 1;
    skuInURL = this._isSkuInURL();

    this._activeProduct = product;
    this._activeSku = sku;

    if (!isFF || (isFF && (singleChildSku || flags.isSkuChange
        || (flags.isPageLoad && skuInURL)))) {
      this._selectedSku = sku;
    } else {
      this._selectedSku = {};
    }
  };


  /**
   *
   * @return {boolean}
   */
  ProductPageController.prototype._isSkuInURL = function () {
    return !!tescoUtils.getQueryStringParam('skuId');
  };


  /**
   *
   * @param {Object} product
   * @param {Object} sku
   * @param {Object} flags
   * @return {void}
   */
  ProductPageController.prototype._setHistory = function (product, sku, flags) {
    var stateData = {},
      url = '';

    if (flags.isPopState || typeof window.history.pushState !== 'function') {
      return;
    }

    url = flags.isPageLoad ? window.location.href : this._buildPublicURL(product, sku, flags);

    stateData.productId = product.id;
    stateData.skuId = sku.id;
    stateData.flags = flags;

    if (flags.isPageLoad) {
      window.history.replaceState(stateData, '', url);
    } else {
      window.history.pushState(stateData, '', url);
    }
  };


  /**
   *
   * @param {Object} product
   * @param {Object} sku
   * @param {Object} flags
   * @return {void}
   */
  ProductPageController.prototype._buildPublicURL = function (product, sku, flags) {
    var ues = this.ues,
      url = flags.isProductChange ? product.publicLink : sku.publicLink;

    if (ues.schoolId) {
      url += flags.isSkuChange ? '&' : '?';
      url += 'school=' + ues.schoolId;
      url += ues.slogoRef ? '&slogoRef=' + ues.slogoRef : '';
    }

    return url;
  };


  /**
   *
   * @param {Object} product
   * @param {Object} sku
   * @return {void}
   */
  ProductPageController.prototype.bindEventHandlers = function () {
    this._bindScrollEvent();

    if (this.isKiosk) {
      $(window).on('scene7.init', function handleScene7init(e) {
        this._initMediaViewer(e.oData);
      }.bind(this));
    }
  };


  /**
   *
   * @return {void}
   */
  ProductPageController.prototype._bindScrollEvent = function () {
    var scrollActions = this._scrollActions;

    $(window).on('scroll.productPageController touchmove.productPageController', function (e) {
      fn.loopArray.call(this, scrollActions, function loopScrollActions(i) {
        this._scrollHandler(scrollActions[i], null, fn.getValue(e, 'mvc', '_deferred'));
      });
    }.bind(this));

    $(window).on('checkInViewport.productPageController', function (e) {
      fn.loopArray.call(this, scrollActions, function loopScrollActions(i) {
        if (scrollActions[i].scope !== e.mvc.scope) {
          return;
        }
        this._scrollHandler(scrollActions[i], e.mvc.viewID, e.mvc._deferred);
      });
    }.bind(this));
  };


  /**
   *
   * @param {Array<string>} [names]
   * @return {this}
   */
  ProductPageController.prototype.unbindEventHandlers = function (names) {
    if (!fn.typeofArrayValues('string', names)) {
      return this;
    }

    fn.loopArray(names, function loopNames(i) {
      $(window).off(names[i] + '.productPageController');
    });

    return this;
  };


  /**
   *
   * @param {Object} config
   * @param {boolean} [config.once]
   * @param {Object} config.scope
   * @param {string} [target]
   * @param {string} [_deferred] Used for unit tests
   * @return {void}
   */
  ProductPageController.prototype._scrollHandler = function (config, target, _deferred) {
    var actions = [],
      callbackArgs = {},
      element = {},
      scope = config.scope;

    actions = scope.getActionInViewport();

    if (typeof window.inVisibleViewport !== 'function') {
      if (_deferred) {
        _deferred.reject();
      }
      return;
    }

    fn.loopArray.call(this, actions, function loopActions(i) {
      callbackArgs = actions[i].callbackArgs;
      element = actions[i].element;

      if (!(element instanceof Element)) {
        if (_deferred) {
          _deferred.reject();
        }
        return;
      }

      if (typeof target === 'string' && target !== element.getAttribute('id')) {
        if (_deferred) {
          _deferred.reject();
        }
        return;
      }

      if (!window.inVisibleViewport(element)) {
        if (_deferred) {
          _deferred.reject();
        }
        return;
      }

      if (config.once) {
        actions.splice(i, 1);
      }

      this._executeScrollHandlerCallback({
        _deferred: _deferred,
        callback: config.callback,
        callbackArgs: callbackArgs,
        scope: scope
      });
    }, { backward: true, check: true });
  };


  /**
   *
   * @param {Object} args
   * @param {JQueryDeferred} [args._deferred] Used for unit tests
   * @param {Function} args.callback
   * @param {Object} args.callbackArgs
   * @param {Object} args.scope
   * @return {void}
   */
  ProductPageController.prototype._executeScrollHandlerCallback = function (args) {
    setTimeout(function () {
      try {
        if (args._deferred) {
          args._deferred.resolve();
        }

        args.callback.call(args.scope, args.callbackArgs);
      } catch (e) {
        // continue
      }
    }, 10);
  };


  /**
   *
   * @param {Object} product
   * @param {Object} sku
   * @param {Object} flags
   * @return {void}
   */
  ProductPageController.prototype._initDependancies = function (product, sku, flags) {
    if (this.isKiosk) {
      this._renderKiosk(product, sku, flags);
    } else {
      this._initMediaViewer(sku, flags);
    }

    this._setDocumentTitle(product);
    this._initBazaarVoice(sku);
  };


  /**
   *
   * @param {Object} product
   * @param {Object} sku
   * @param {Object} flags
   * @return {void}
   */
  ProductPageController.prototype._renderKiosk = function (product, sku, flags) {
    var skuCtlr = this.getModule('controller', 'sku', '_default');

    /**
     *
     * @return {void}
     */
    function render() {
      skuCtlr.renderView({
        sViewName: 'KioskProductPageView',
        elTarget: '.content-container',
        sOutput: 'outer',
        mParamData: { mvc: { flags: { isKiosk: true }, products: product, sku: sku, vm: {} } }
      });
    }

    if (flags.isVariantChange) {
      render();
    } else {
      $(document).ready(function () {
        render();
      });
    }
  };


  /**
   *
   * @param {Object} sku
   * @param {Object} flags
   * @return {void}
   */
  ProductPageController.prototype._initMediaViewer = function (sku, flags) {
    var skuModel = this.getModule('model', 'sku');

    /**
     *
     * @return {void}
     */
    function init() {
      mediaViewer.showScene7();
      mediaViewer.init(skuModel.getMediaAssets(sku));
    }

    if (this.isKiosk || fn.getValue(flags, 'isVariantChange')) {
      init();
    } else {
      $(document).ready(function () {
        init();
      });
    }
  };


  /**
   *
   * @param {Object} product
   * @return {void}
   */
  ProductPageController.prototype._setDocumentTitle = function (product) {
    document.title = product.displayName;
  };


  /**
   *
   * @param {Object} sku
   * @return {void}
   */
  ProductPageController.prototype._initBazaarVoice = function (sku) {
    bazaarvoice.initBV(sku.id);
  };


  /**
   *
   * @return {Object}
   */
  ProductPageController.prototype.asyncBlockInventoryCallback = function () {
    var _this = this,
      callback = {};

    /**
     *
     * @param {Object} resp
     * @return {void}
     */
    callback.success = function (resp) {
      var inventory = {};

      if (typeof resp !== 'string') {
        return;
      }

      inventory = _this._parseInventory(resp);

      if (!fn.isArray(inventory.products, { notEmpty: true })) {
        return;
      }

      _this._addInventory(inventory.products);
    };

    return callback;
  };


  /**
   *
   * @param {Object} resp
   * @param {Object} resp.inventory
   * @return {Ovject}
   */
  ProductPageController.prototype._parseInventory = function (resp) {
    var inventory = fn.getValue(JSON.parse(resp), 'inventory') || '';

    return JSON.parse(inventory.replace(/&amp;#034;/g, '"')) || {};
  };


  /**
   *
   * @param {Array<Object>} productInventory
   * @return {void}
   */
  ProductPageController.prototype._addInventory = function (productInventory) {
    var inventoryProductModel = this.getModule('model', 'inventoryProduct'),
      inventorySkuModel = this.getModule('model', 'inventorySKU');

    fn.loopArray(productInventory, function loopProductInventory(i) {
      var skuInventory = [];

      inventoryProductModel.setDataStores(productInventory[i]);

      if (!fn.isArray(productInventory[i].skus, { notEmpty: true })) {
        return;
      }

      skuInventory = productInventory[i].skus;

      fn.loopArray(skuInventory, function loopSkuInventory(j) {
        inventorySkuModel.setDataStores(skuInventory[j]);
      });
    });
  };


  /**
   *
   * @return {Array<Object>}
   */
  ProductPageController.prototype.getScrollActions = function () {
    return this._scrollActions;
  };


  /**
   *
   * @param {Object} config
   * @param {Object} config.scope
   * @param {Function} config.callback
   * @return {this}
   */
  ProductPageController.prototype.setScrollAction = function (config) {
    var _config = config || {};

    if (!fn.isObject(_config.scope, { notEmpty: true }) || typeof _config.callback !== 'function') {
      return this;
    }

    this._scrollActions.push(_config);
    return this;
  };


  /**
   *
   * @return {this}
   */
  ProductPageController.prototype.unsetScrollActions = function () {
    this._scrollActions = [];
    return this;
  };


  /**
   *
   * @return {Object}
   */
  ProductPageController.prototype.getActiveProduct = function () {
    return this._activeProduct;
  };


  /**
   *
   * @param {Object} product
   * @return {this}
   */
  ProductPageController.prototype.setActiveProduct = function (product) {
    this._activeProduct = fn.checkData(product, ['id', 'links']) ? product : {};
    return this;
  };


  /**
   *
   * @return {Object}
   */
  ProductPageController.prototype.getActiveSku = function () {
    return this._activeSku;
  };


  /**
   *
   * @param {Object} sku
   * @return {this}
   */
  ProductPageController.prototype.setActiveSku = function (sku) {
    this._activeSku = fn.checkData(sku, ['id', 'links']) ? sku : {};
    return this;
  };


  /**
   *
   * @return {Object}
   */
  ProductPageController.prototype.getSelectedSku = function () {
    return this._selectedSku;
  };


  /**
   *
   * @param {Object} sku
   * @return {this}
   */
  ProductPageController.prototype.setSelectedSku = function (sku) {
    this._selectedSku = fn.checkData(sku, ['id', 'links']) ? sku : {};
    return this;
  };


  module.exports = ProductPageController;
});

define('modules/pdp/controllers/ListingPageController',['require','exports','module','modules/mvc/fn','modules/pdp/controllers/BasePageController'],function (require, exports, module) {
  'use strict';

  var fn = require('modules/mvc/fn'),
    BasePageController = require('modules/pdp/controllers/BasePageController');

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function ListingPageController(config) {
    this.parent.constructor.call(this, config);
  }

  fn.inherit(ListingPageController, BasePageController);

  /**
   *
   * @return {void}
   */
  ListingPageController.prototype.initDependancies = function () {
    this._initModules();
    this._bindEventHandlers();
  };

  /**
   *
   * @return {void}
   */
  ListingPageController.prototype._initModules = function () {
    this._create('controller', 'panel', '_default');
    this._create('controller', 'formHandler', 'addToBasket');
    this._create('controller', 'formHandler', 'requestStockAlert');

    if (this._initStoreStockCheck()) {
      this._create('controller', 'stores', 'storeStockCheck');
    }
  };

  /**
   *
   * @return {boolean}
   */
  ListingPageController.prototype._initStoreStockCheck = function () {
    return !window.isKiosk() && !window.isStoreStockCheckDisabled;
  };

  /**
   *
   * @return {void}
   */
  ListingPageController.prototype._bindEventHandlers = function () {
    $(window).on('pageLoadAnalyticsSuccess', this._resetProductImpressionAnalytics);
  };

  /**
   *
   * @return {void}
   */
  ListingPageController.prototype._resetProductImpressionAnalytics = function () {
    var events = [],
      index = null;

    delete window.s.products;

    if (window.s.events) {
      events = window.s.events.split(',');
      index = events.indexOf('event3');

      if (index !== -1) {
        events.splice(index, 1);
        window.s.events = events.join(',');
      }
    }
  };

  module.exports = ListingPageController;
});

define('modules/pdp/pageControllerMap', [
  'modules/pdp/controllers/ProductPageController',
  'modules/pdp/controllers/ListingPageController'
], function (ProductPageController, ListingPageController) {
  'use strict';

  var pageControllerMap = {
    controller: {
      productDetails: ProductPageController,
      listings: ListingPageController
    },
    get: function (pageGroup) {
      return pageControllerMap.controller[pageGroup] || null;
    }
  };

  return pageControllerMap;
});

define('modules/pdp/controllers/DataController', [
  'domlib',
  'modules/mvc/fn',
  'modules/pdp/BaseClass',
  'modules/pdp/classMap'
], function ($, fn, BaseClass, classMap) {
  'use strict';

  /**
   * Data controller takes raw data returned from a request to the server and makes sure all
   * models are updated if there is data that they need to add.
   * @return {void}
   */
  function DataController() {
    this._bindEvents();
  }

  fn.inherit(DataController, BaseClass);

  /**
   * Binds any events required when the data controller is initialised.
   * @return {void}
   */
  DataController.prototype._bindEvents = function () {
    $(window).on('dataFetched', this._onDataFetched.bind(this));
  };

  /**
   * Runs the update models method when it receives a data fetched event. These events are
   * triggered by every model's fetch method and can be triggered manually.
   * @param {Object} oEvent The event object that includes the fetched data object.
   * @return {void}
   */
  DataController.prototype._onDataFetched = function (oEvent) {
    this._updateModels(oEvent.oData.mfetchedData);
  };

  /**
   * Checks if data is an array or an object.
   * @param {Object} mData The fetched data from the server.
   * @return {void}
   */
  DataController.prototype._updateModels = function (mData) {
    if (this.isArray(mData, true)) {
      this.forLoop(mData, function (i) {
        if (this.isObject(mData[i], true)) {
          this._loopObj(mData[i]);
        }
      });
    } else if (this.isObject(mData, true)) {
      this._loopObj(mData);
    }
  };

  /**
   * Loops through each object's properties.
   * @param {Object} oData The fetched data from the server.
   * @return {void}
   */
  DataController.prototype._loopObj = function (oData) {
    var mPropData = null;

    this.forInLoop(oData, function (sProp) {
      mPropData = oData[sProp];
      /**
       * If the property name matches a namespace in the classMap's model object, then the data
       * is added to the addDataToModel event and fired off to the page controller.
       */
      if (classMap.hasNamespace('model', sProp)) {
        if (mPropData || this.isArray(mPropData, true)) {
          this.setEvent({
            sName: 'addData',
            sNamespace: sProp,
            mAddData: mPropData
          }, false, true);
        }
      }

      /**
       * Continue to loop through the data.
       */
      this._updateModels(mPropData);
    });
  };

  return DataController;
});

define('modules/pdp/controllers/AppController', [
  'modules/mvc/fn',
  'modules/tesco.utils',
  'modules/pdp/BaseClass',
  'modules/pdp/pageControllerMap',
  'modules/pdp/controllers/DataController'
], function (fn, tescoUtils, BaseClass, pageControllerMap, DataController) {
  'use strict';

  /**
   *
   * @param {Object} config
   * @return {void}
   */
  function AppController(config) {
    var PageControllerClass = null;

    if (window.oAppController instanceof AppController) {
      return window.oAppController;
    }

    // Get the class for the page controller
    PageControllerClass = pageControllerMap.get(config.pageGroup);

    if (PageControllerClass === null) {
      return false;
    }

    /**
     * temporary store for events that need to be triggered when markup is injected into the DOM.
     * @type {Object}
     */
    this.oEventStore = {};
    /**
     * Initialises core controllers
     */
    this.oDataController = new DataController();

    this.oPageController = new PageControllerClass(
      fn.mergeObjects(config, { isKiosk: window.isKiosk() })
    );

    this.baseURL = config.baseURL;
  }

  fn.inherit(AppController, BaseClass);
  return AppController;
});

/*global define: true */
define('modules/ues/common',['domlib', 'modules/breakpoint', 'modules/common'], function ($, breakpoint, common) {

    'use strict';

	var uniformEmbService = {
			activeIndex: 1,
			nextActiveIndex:1,
			prevActiveIndex:1,
			searchSchool : function($elem){
				var userInput = $.trim($elem.val());

				if(/^[a-zA-Z-0-9\'\s]*$/.test(userInput) == false || userInput.length == 0){
					$('.userMessage').hide();
					$('.schoolResultsSection').hide();
				}
				else if(userInput.length < 3 ) {
				   $('.userMessage').show();
				   $('.schoolResultsSection').hide();
				}
				else {
				   $('.userMessage').hide();
				   $('.schoolResultsSection').show();
				   uniformEmbService.getSchoolResults($elem);
				}
			},
            getSchoolResults: function($elem){
            	var _url = $('#schoolSearchUrl').val(),
        		textVal = $elem.val(),
        		limit = $('#schoolLimit').val(),
        		timeOut =$('#uesApiTimeout').val();
	        	var sUrl = _url +'?query=' + $elem.val() + '&limit='+ limit;

				$.ajax( {
					  url: sUrl,
					  contentType: "application/json; charset=utf-8",
					  type: "GET",
					  dataType: 'json',
					  timeout: timeOut,
					  beforeSend: function(){
						  $('.searchHolder .loader').show();
					  },
					  success: function(data) {
						$('.searchHolder .loader').hide();
						if($('.schoolResultsSection .schoolDetails').length >0){
							$('.schoolResultsSection .schoolDetails').remove();
						}
						if(data.count >0){
							var schoolHouseIndex = 0;
							$('.schoolResultsSection .noResults').hide();
							$.each(data.organizations, function(key, value){
								var responseName = data.organizations[key].name,
									textBox = $('.schoolIndicator').val(),
							    	schoolName= responseName.replace(new RegExp(textBox, "ig"), "<b>" + textBox +"</b>"),
							    	responsePostCode = data.organizations[key].address.postcode,
							    	postcode = responsePostCode.replace(new RegExp(textBox, "ig"), "<b>" + textBox +"</b>"),
									responseAddress1 = data.organizations[key].address.address1,
									responseAddress2 = data.organizations[key].address.address2,
									address1, address2;

								if (responseAddress1 != null && responseAddress1 != undefined && responseAddress1 != ''){
									address1 = responseAddress1.replace(new RegExp(textBox, "ig"), "<b>" + textBox +"</b>");
								}
								else {
									address1 = "";
								}
								if (responseAddress2 != null && responseAddress2 != undefined && responseAddress2 != ''){
									address2 = responseAddress2.replace(new RegExp(textBox, "ig"), "<b>" + textBox +"</b>");
								}
								else {
									address2 = "";
								}
								schoolHouseIndex = schoolHouseIndex+1;
								var content= '<div class="schoolDetails" id="schoolDetails_'+key +'">' +
								'<div class="schools schoolHouse_'+schoolHouseIndex+'"><span class="schoolId">'+data.organizations[key].school_data_id+'</span>'+
								'<span class="orgId">' + data.organizations[key].organization_id + '</span>'+
								'<img src="'+data.organizations[key].emblem.png+'" alt="schoolEmblem" title="schoolEmblem" style="background-color:rgb('+data.organizations[key].emblem.background+')"/><span class="schoolName">'+schoolName;
								/*if(data.organizations[key].subunits){
									content = content + ' <span class="icon" data-icon="r"></span>';
								}*/
								content = content + '</span>'+
								'<div class="schoolAddress"><span class="address1">'+address1 +'</span><span class="address2">'+address2 +'</span>'+
								'<span class="postcode">'+ postcode +'</span></div><br />' +
								'</div>' +
								'<div class="houseBlock">';

								var houseContent = "";
								if(data.organizations[key].subunits){
									$.each(data.organizations[key].subunits, function(key1, value){
										schoolHouseIndex = schoolHouseIndex+1;
										houseContent = houseContent +
										'<div class="houses schoolHouse_'+schoolHouseIndex +'" id="house_' + key1 + '">'+
										'<span class="schoolId">'+data.organizations[key].subunits[key1].school_data_id+'</span>'+
										'<span class="orgId">' + data.organizations[key].subunits[key1].organization_id + '</span>'+
										'<img src="' + data.organizations[key].subunits[key1].emblem.png + '" style="background-color:rgb('+data.organizations[key].subunits[key1].emblem.background+')" alt="schoolEmblem" title="schoolEmblem">'+
										'<span class="schoolName">' + data.organizations[key].subunits[key1].name + ' </span></span>'+
										'<div class="houseAddress">'+
										'	<span class="address1">' + data.organizations[key].subunits[key1].address.address1 + '</span>'+
										'	<span class="address2">' + data.organizations[key].subunits[key1].address.address2 +'</span>'+
										'	<span class="postcode">'+ data.organizations[key].subunits[key1].address.postcode +'</span>'+
										'</div>'+
										'</div><br/>';
									});
								}
								content = content + houseContent + '</div>' + '</div>';

								$('.schoolResultsContent').append(content);
								$('.schoolResultsSection .schoolDetails').show().css('height', 'auto');

								$('#schoolDetails_'+key).click(function(e){
									var target = $(e.target),
									$clickedUnit;
									if(target.parents('.schools').length){
										$clickedUnit = $(target.parents('.schools'));
									}
									else if(target.parents('.houses').length){
										$clickedUnit = $(target.parents('.houses'));
									}
									if(!(target.parents('.parentSchool').length)){
										var selectedSchoolName = $clickedUnit.find('.schoolName').text(),
											selectedSchoolId = $clickedUnit.find('.schoolId').text(),
											selectedOrgId = $clickedUnit.find('.orgId').text();
											$('#schoolName').val(selectedSchoolName);
											$('#schoolId').val(selectedSchoolId);
											$('#organisationId').val(selectedOrgId);
											$('#selectSchool').submit();
									}
								});
							});
							if(breakpoint.largeDesktop || breakpoint.kiosk){
								var _viewWidth = $(window).innerWidth()*0.375;
								$('.schoolResultsSection').css({
									width: _viewWidth,
									/*left: -($(window).width() - $('.fullWidth').width())*/
								});
							}
							else if(breakpoint.desktop){
								var _viewWidth = $(window).innerWidth()*0.475;
								$('.schoolResultsSection').css({
									width: _viewWidth,
									/*left: -($(window).innerWidth() / 8)*/
								});
							}
							else if (breakpoint.vTablet || breakpoint.hTablet) {
								var _viewWidth = $(window).innerWidth()*0.6;
								$('.schoolResultsSection').css({
									width: _viewWidth,
									/*left: -($(window).innerWidth() / 5)*/
								});
							}
							else if(breakpoint.mobile){
								$('.schoolResultsSection').css('width',$('.searchSec').width())
							}

							$('.schoolDetails').each(function(){
								if($(this).find('.houses').length != 0){
									$(this).find('.schools').addClass('parentSchool');
								}
							});

						}
						else{
							$('.schoolResultsSection .noResults').show();
							$('.schoolResultsSection .schoolDetails').remove();
						}

					  },
					  error: function() {
						  $('.searchHolder .loader').hide();
						  $('.schoolResultsContent').text('Oops! Something went wrong Please refresh your page or try again later.');
						  $('.schoolResultsSection').css({
							  'font-size' : '16px',
							  'line-height': '21px'
						  });
					  }
				});
	        },
	        currencyFormat : function (x) {
			    var parts = x.toString().split(".");
			    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
			    return parts[0];
			},
	        totalDonation : function(){
	        	var timeOut =$('#uesApiTimeout').val();
				if($('.donationCounter').length > 0 ){
					$.ajax( {
						url: $('#totalDonation').val(),
						timeout: timeOut,
						success: function(data) {
							if(data.statistics != undefined){
								$('.donationAmt').html("&pound;"+ uniformEmbService.currencyFormat(data.statistics.organization_funds_raised));
							}
						},
						error: function() {
							$('.donationAmt .loader').hide();
							$('.donationAmt').text('Sorry  we cant display the donation information now');
							$('.donationAmt').css({
							    'white-space': 'nowrap',
						    	'font-size':'16px',
						    	'font-family': 'Tesco'
							});
						 }
					});
				}
			},
			selectSchoolHouseUp: function(e){
				var _this = uniformEmbService;

				if($('div[class*="schoolHouse_"]').hasClass('selected')){
					var elem = $('.schoolHouse_'+_this.activeIndex).attr('class').split(' ')[1];
						_this.activeIndex = parseInt(elem.split('_')[1]);
						_this.prevActiveIndex = _this.activeIndex == 1 ? $('div[class*="schoolHouse_"]').length : parseInt(_this.activeIndex -1);

						$('.schoolHouse_'+_this.activeIndex).removeClass('selected');
						if(_this.prevActiveIndex ==1){
							$('.schoolHouse_'+_this.prevActiveIndex).addClass('selected').focus();
							_this.activeIndex = _this.prevActiveIndex;
						} else{
							$('.schoolHouse_'+_this.prevActiveIndex).addClass('selected').focus();
							_this.activeIndex = _this.prevActiveIndex;
						}
				}
				else{
					$('.schoolHouse_1').addClass('selected').focus();
					_this.activeIndex = 1;
				}
			},
			selectSchoolHouseDown: function(e){
				var _this = uniformEmbService;

				if($('div[class*="schoolHouse_"]').hasClass('selected')){
					var elem = $('.schoolHouse_'+_this.activeIndex).attr('class').split(' ')[1];
						_this.activeIndex = parseInt(elem.split('_')[1]);
						_this.nextActiveIndex = parseInt(_this.activeIndex) + 1;

						$('.schoolHouse_'+_this.activeIndex).removeClass('selected');
						if($('.schoolHouse_'+_this.nextActiveIndex).length){
							$('.schoolHouse_'+_this.nextActiveIndex).addClass('selected').focus();
							_this.activeIndex = _this.nextActiveIndex;
						} else{
							$('.schoolHouse_1').addClass('selected').focus();
							_this.activeIndex = 1;
						}
				}
				else{
					$('.schoolHouse_1').addClass('selected').focus();
					_this.activeIndex = 1;
				}
			},
      sendSchoolInfo: function(){
				if($('.schoolResultsSection').is(':visible')){
					$.each($('div[class*="schoolHouse_"]').not('.parentSchool'), function(){
							if($(this).hasClass('selected')){
								var selectedSchoolName = $(this).find('.schoolName').text(),
									selectedSchoolId = $(this).find('.schoolId').text(),
									selectedOrgId = $(this).find('.orgId').text();
									$('#schoolName').val(selectedSchoolName);
									$('#schoolId').val(selectedSchoolId);
									$('#organisationId').val(selectedOrgId);
									$('#selectSchool').submit();
							}

					});
				}
			},
			init: function(){
				var debouncer = null;

				$(document).on('keyup click', 'input.schoolIndicator', function(e) {
					var code = e.keyCode || e.which;
					if(debouncer) {
						clearTimeout(debouncer);
					}
					debouncer = setTimeout(function(evt){
						switch (code) {
              case 13:
							case 38:
							case 40:
								e.preventDefault();
								break;

							case 27:
								if($('.ues-content').length){
									var $dropDown = $('.ssTable .schoolResultsSection').is(':visible') ? $('.schoolResultsSection') : $('.userMessage');
									$dropDown.hide();
								}

								break;
							default:
								uniformEmbService.searchSchool($('input.schoolIndicator'));
						}
					}, 500);


					if(common.isTouch()){
						if (e.keyCode === 13) {
							e.preventDefault();
							$('input.schoolIndicator').blur();
						}
					}
				});

				$(document).keyup(function(e) {
					if (e.keyCode === 38) {
						uniformEmbService.selectSchoolHouseUp(e);
					}
					if(e.keyCode === 40){
						uniformEmbService.selectSchoolHouseDown(e);
					}
          if(e.keyCode === 13){
						uniformEmbService.sendSchoolInfo();
					}
				});

				if($('.ues-content').length){
					$('#wrapper:not(input.schoolIndicator)').on('click', function(e){
						if(!$(e.target).closest('.parentSchool').length){
							var $dropDown = $('.ssTable .schoolResultsSection').is(':visible') ? $('.schoolResultsSection') : $('.userMessage');
							$dropDown.hide();
						}
					});
				}

				if (breakpoint.mobile || breakpoint.vTablet || breakpoint.hTablet || breakpoint.kiosk) {
					$('.schoolInfo').click(function(e){
						$(this).hide();
						$('.searchSec').show();
					});
				}
				uniformEmbService.totalDonation();
			}

	};
	common.init.push(function() {
		uniformEmbService.init();
	});
	return uniformEmbService;

});

define('modules/hooklogic/common',['domlib', 'modules/breakpoint'], function ($, breakpoint) {
  'use strict';

  var sponsored = {

    getPlatform: function () {
      breakpoint.init();
      breakpoint.check();
      return (breakpoint.mobile || breakpoint.vTablet || breakpoint.hTablet) ? 'mobile' : 'web';
    },
    submitHLRequest: function submitHLRequest(hookLogicAttr) {
      var abBucket = window.HLMVT ? window.HLMVT.abBucket ? window.HLMVT.abBucket : 'C' : 'C';

      if (window.HLLibrary !== undefined) {
        window.HLLibrary.newRequest()
         .setTaxonomy(hookLogicAttr.categoryId)
         .setModule('Listing')
         .setProperty('hlPageType', 'B')
         .setProperty('platform', this.getPlatform())
         .setProperty('pCount', hookLogicAttr.count)
         .setProperty('organicSKUs', hookLogicAttr.finalSkuList)
         .setProperty('cUserId', hookLogicAttr.customerId)
         .setProperty('pgSize', '20')
         .setProperty('pgN', '1')
         .setProperty('abtest', 'launch')
         .setProperty('abbucket', abBucket)
         .submit('hl_1');
      }
    },
    submitHLNewRequest: function submitHLNewRequest(hookLogicAttr) {
      var abBucket = window.HLMVT ? window.HLMVT.abBucket ? window.HLMVT.abBucket : 'C' : 'C';

      if (window.HLLibrary !== undefined) {
        window.HLLibrary.newRequest()
          .setTaxonomy(hookLogicAttr.categoryId)
          .setModule('PDP')
          .setProperty('cUserId', hookLogicAttr.customerId)
          .setProperty('hlPageType', 'P')
          .setProperty('platform', this.getPlatform())
          .setProperty('sku', hookLogicAttr.listingId)
          .setProperty('broadmatchtype', '2')
          .setProperty('required_filters', 'productid')
          .setProperty('abtest', 'launch')
          .setProperty('abbucket', abBucket)
          .submit('hl_1');
      }
    },
    submitHLUpdateRequest: function submitHLUpdateRequest(hookLogicAttr) {
      if (window.HLLibrary !== undefined) {
        window.HLLibrary.newUpdate()
         .setProperty('cUserId', hookLogicAttr.customerId)
         .setProperty('hlPageType', 'P')
         .setProperty('platform', this.getPlatform())
         .setProperty('parentsku', hookLogicAttr.productId)
         .setProperty('pgid', hookLogicAttr.skuId)
         .setProperty('productid', hookLogicAttr.listingId)
         .setProperty('regularPrice', hookLogicAttr.regularPrice)
         .setProperty('quantity', hookLogicAttr.quantity)
         .setProperty('price', hookLogicAttr.price)
         .submit();
      }
    },
    submitHLOrderRequest: function submitHLOrderRequest(hookLogicAttr) {
      if (window.HLLibrary !== undefined) {
        window.HLLibrary.newOrder()
         .setProperty('cUserId', hookLogicAttr.customerId)
         .setProperty('hlPageType', 'C')
         .setProperty('platform', this.getPlatform())
         .setProperty('parentsku', hookLogicAttr.productList)
         .setProperty('pgid', hookLogicAttr.pgidList)
         .setProperty('sku', hookLogicAttr.skuList)
         .setProperty('price', hookLogicAttr.priceList)
         .setProperty('quantity', hookLogicAttr.quantityList)
         .setProperty('orderId', hookLogicAttr.orderId)
         .submit();
      }
    },
    asyncBlockCallbacks: function asyncBlockCallbacks(hookLogicAttr) {
      var oCallbacks = {},
        _this = this;

      oCallbacks.success = function (oResp) {
        var resp = JSON.parse(oResp),
          _hookLogicAttr = hookLogicAttr;

        if (resp.Analytics) {
          _hookLogicAttr.customerId = resp.Analytics.eVar24 ? resp.Analytics.eVar24 : '';
          _this.sCustomerId = _hookLogicAttr.customerId;
        }

        _this.submitHLRequest(_hookLogicAttr);
      };
      return oCallbacks;
    }
  };

  return sponsored;
});

define('modules/affiliate/common', ['domlib', 'modules/common', 'modules/tesco.utils'],
function ($, common, utils) {
  'use strict';

  /**
   *  There are changes between seconds and milliseconds due to the backend implementation
   *  unfortunatly, it needs to be backwards-compatible
   */

  var CONSTS = {
      source: 'source',
      sourceValues: ['awin', 'zenaps'],
      sourceAWIN: 'aw',
      sourceDirect: 'direct',
      sourceOther: 'others',
      cookieName: 'aw_ck',
      cookieExpiryName: 'AW_Expires_In',
      cookieExpiryMilliSeconds: 1000 * 60 * 60 * 24 * 30,
      cookiePath: '/direct'
    },

    affiliateTracking = {

      init: function () {
        var sourceValue = null;

        try {
          if (!this.isCookieSet()) {
            sourceValue = this.getSourceValue();
            this.setCookie(sourceValue);
          } else {
            sourceValue = this.getSourceFromURL();
            if (sourceValue !== '') {
              if (this.isRequestFromAffiliate(sourceValue)) {
                sourceValue = this.getSourceValue();
              }
              this.updateCookie(sourceValue);
            }
          }
        } catch (ex) {}
      },

      isRequestFromAffiliate: function (sourceFromURL) {
        var i = 0;

        for (; i < CONSTS.sourceValues.length; i += 1) {
          if (sourceFromURL === CONSTS.sourceValues[i]) {
            return true;
          }
        }
        return false;
      },

      getSourceFromURL: function () {
        return utils.getQueryStringParam(CONSTS.source);
      },

      getSourceValue: function () {
        var sourceFromURL = this.getSourceFromURL();

        if (sourceFromURL !== '') {
          return this.isRequestFromAffiliate(sourceFromURL)
          ? CONSTS.sourceAWIN : CONSTS.sourceOther;
        }

        return CONSTS.sourceDirect;
      },

      setCookie: function (sourceValue) {
        var currentDateEPOC = Date.now(),
          baseExpiryDate = new Date(),
          expiryDate = new Date(baseExpiryDate.setTime(baseExpiryDate.getTime() +
          CONSTS.cookieExpiryMilliSeconds)),
          expiryDateInSeconds = Math.floor((expiryDate.getTime() - currentDateEPOC) / 1000),
          domainName = $('#domainName').val();

        $.cookie(CONSTS.cookieName, sourceValue, { path: CONSTS.cookiePath, expires: expiryDate, domain: domainName });
        $.cookie(CONSTS.cookieExpiryName, expiryDateInSeconds, {
          path: CONSTS.cookiePath, expires: expiryDate, domain: domainName });
      },

      updateCookie: function (sourceValue) {
        var currentDate = new Date(),
          newExpiryDate = new Date(currentDate.setTime(currentDate.getTime() +
           CONSTS.cookieExpiryMilliSeconds)),
          expiryCookieDate = $.cookie(CONSTS.cookieExpiryName),
          domainName = $('#domainName').val();

        if (expiryCookieDate === null) {
          expiryCookieDate = newExpiryDate;
        } else {
          currentDate = new Date();
          expiryCookieDate = new Date(
            currentDate.setTime(currentDate.getTime() + (expiryCookieDate * 1000)));
        }
        $.cookie(CONSTS.cookieName, sourceValue, {
          path: CONSTS.cookiePath, expires: expiryCookieDate, domain: domainName
        });
      },

      isCookieSet: function () {
        return $.cookie(CONSTS.cookieName);
      }
    };

  common.init.push(function () {
    affiliateTracking.init();
  });

  return affiliateTracking;
});

define('modules/add-on-items/common',['domlib', 'modules/common', 'modules/overlay/common'], function ($, common, overlay) {
  'use strict';

  var addOnItem = {

    addOnToolTipPlp: function () {
      var addOnText = '#add-on-text',
        productClass = '.products',
        addOnClass = '.add-on-item',
        self = addOnItem;

      $(productClass).on('click', function (e) {
        if (e.target.matches('img[alt=add-on-icon]') === true) {
          e.preventDefault();
          e.stopPropagation();
          $(addOnClass + ' ' + addOnText).hide();
          self.showToolTip(e.target, 'li', addOnText);
        } else if ($(e.target).hasClass('close') || $(e.target).hasClass('icon')) {
          e.preventDefault();
          e.stopPropagation();
          self.hideToolTip(e.target, 'li', addOnText);
        }
      });
    },
    showToolTip: function showToolTip(targetNode, nodeElement, className) {
      $(targetNode).closest(nodeElement).find(className).show();
    },
    hideToolTip: function hideToolTip(targetNode, nodeElement, className) {
      $(targetNode).closest(nodeElement).find(className).hide();
    },
    interceptOverlay: function interceptOverlay() {
      $('#basket-checkout, #basket-checkout-mini').on('click', function (e) {
        var interceptContent = $('#interceptContent').html();

        e.preventDefault();
        if ($(e.target).hasClass('intercept-button')) {
          overlay.show({
            content: interceptContent,
            customClass: 'intercept-overlay'
          });
        }
      });
    },
    miniBasket: function miniBasket() {
      $('#basket-flyout-menu').on('click', function (e) {
        if (e.target.id === 'flyout-basket-add-on' && $(e.target).hasClass('disabled')) {
          $('#add-on-tooltip').show();
        } else if ($(e.target).hasClass('close') || $(e.target).hasClass('icon')) {
          $('#add-on-tooltip').hide();
        } else {
          $('#add-on-tooltip').hide();
        }
      });
    },
    init: function init() {
      var self = addOnItem;

      $(document).on('click', function () {
        $('.add-on-item #add-on-text').hide();
      });

      if ($('.add-on-item').length) {
        self.addOnToolTipPlp();
      }
      // self.interceptOverlay();
      self.miniBasket();
    }
  };

  common.init.push(addOnItem.init);

  return addOnItem;
});

/**
 * Carousel Module : Image carousel
 */
/*jslint plusplus: true*/
/*global define: true, window: true*/
define('modules/carousel/common',['domlib', 'modules/common'], function ($, common) {

    'use strict';

    var carousel = {

        element: null, //Carousel ID
        images: null, //Image container
        slider: null, //Slider container (touch)
        widget: null, //Slider widget (touch)
        buttons: null, //Click buttons (click)

        posX: 0, //initial position offset when using touch start on slider

        buttonWidth: 0, //Width of button container so slider can match
        sliderOffsetX: 0, //slider offset
        sliderWidth: 0, //slider width
        widgetWidth: 0, //slider widget width
        imagesWidth: 0, //Total images width
        liWidth: 0, //width of each LI containing an image

        constraint: {
            start: 0,
            end: 0
        }, //Contraints for slider widget

        numItems: 0, //Number of images/items
        activeItem: 0, //Index of active image/item

        sliderTimer: null, //Slider Timer for timeout of display

        slideshowInterval: 6000, //Slideshow pause between images
        slideshowTimer: null, //Timer for slideshow
        slideshowStopped: false, //Has the slideshow been stopped?
        slideshowTimeout: null, //slidershow timeout triggered when paused before restarting

        imagesOffset: 0, //Offset of image container
        draggingOffset: 0, //ofset to calculate touch position



        /**
         * Calculate item to be set as active when using the touch slider
         * @param  {Int} x X touch position on the slider
         */
        calculateItem: function (x) {
            var spacing = (carousel.constraint.end - carousel.constraint.start) / carousel.numItems,
                ai = Math.floor(x / spacing);

            if (ai >= carousel.numItems) {
                ai = carousel.numItems - 1;
            }

            if (ai < 0) {
                ai = 0;
            }

            if (ai !== carousel.activeItem) {
                carousel.activeItem = ai;
                carousel.setActiveItem();
            }

        },


        /**
         * Set the active item and animate into place using CSS/JS based on browser
         */
        setActiveItem: function () {
            var newPos;

            $('li', carousel.buttons).eq(carousel.activeItem).addClass('active')
                .siblings().removeClass('active');

            //do a modern browser check
            if (common.isModern()) {
                //use 3dtransform for animation

                newPos = ((100 / carousel.numItems) * carousel.activeItem);
                carousel.images.css({
                    '-webkit-transform': 'translate3d(' + -newPos + '%,0,0)',
                    '-moz-transform': 'translate3d(' + -newPos + '%,0,0)',
                    '-ms-transform': 'translate3d(' + -newPos + '%,0,0)',
                    '-o-transform': 'translate3d(' + -newPos + '%,0,0)',
                    'transform': 'translate3d(' + -newPos + '%,0,0)'
                });

            } else {

                //use js for animation
                newPos = 100 * carousel.activeItem;
                carousel.images.animate({
                    'left': -newPos + '%'
                }, 500);
            }
        },

        /**
         * Handle click event for next image button
         * @param  {event} evt Click event
         */
        next: function (evt) {

            if (evt) {
                carousel.stop();
            }

            if (!carousel.images.hasClass('.dragging')) {

                if (carousel.activeItem < (carousel.numItems - 1)) {
                    carousel.activeItem++;
                } else {
                    carousel.activeItem = 0;
                }

                carousel.setActiveItem();
            }
        },

        swipeLeft: function (evt) {
            if (window.isKiosk()) {
                carousel.pause();
            } else {
                carousel.stop();
            }
            if (carousel.activeItem !== (carousel.numItems - 1)) {
                evt.preventDefault();
                carousel.next();
            }
            carousel.setActiveItem();
        },



        swipeRight: function (evt) {
            if (window.isKiosk()) {
                carousel.pause();
            } else {
                carousel.stop();
            }
            if (carousel.activeItem !== 0) {
                evt.preventDefault();
                carousel.previous();
            }
            carousel.setActiveItem();
        },

        /**
         * Handle click event for previous image button
         * @param  {event} evt Click event
         */
        previous: function (evt) {

            if (evt) {
                carousel.stop();
            }

            if (!carousel.images.hasClass('.dragging')) {

                if (carousel.activeItem > 0) {
                    carousel.activeItem--;
                } else {
                    carousel.activeItem = (carousel.numItems - 1);
                }

            }

            carousel.setActiveItem();
        },

        /**
         * Sart slideshow after clearing any residual timers or timeouts
         * @param  {event} evt Event
         */
        start: function (evt) {
            if (evt) {
                evt.preventDefault();
            }

            window.clearInterval(carousel.sliderTimer);
            window.clearInterval(carousel.slideshowTimeout);

            carousel.slideshowTimeout = window.setInterval(function () {
                carousel.next();
            }, carousel.slideshowInterval);
        },


        /**
         * pause slideshow
         * @param  {event} evt Event
         */
        pause: function (evt) {

            if (evt) {
                evt.preventDefault();
            }

            window.clearInterval(carousel.slideshowTimer);
            window.clearTimeout(carousel.slideshowTimeout);
        },


        /**
         * Stop the slideshow and restart after 6 seconds
         * @param  {event} evt Event
         */
        stop: function (evt) {
            if (evt) {
                evt.preventDefault();
            }

            window.clearInterval(carousel.slideshowTimer);
            window.clearTimeout(carousel.slideshowTimeout);

            //pause for 10 seconds after an interaction before starting the slideshow again
            carousel.slideshowTimeout = window.setTimeout(function () {
                carousel.start(null);
            }, 6000);
        },


        generateButtons: function () {
            //generate buttons
            var i = carousel.numItems,
                buttons = '';

            while (i--) {
                buttons += '<li><div class="inner"></div></li>';
            }

            carousel.buttons.html(buttons);
        },


        init: function () {
            carousel.element = $('#carousel');
            if (carousel.element.length) {

                carousel.images = $('#carousel .images');
                carousel.slider = $('#carousel-slider');
                carousel.widget = $('#carousel-slider .widget');
                carousel.buttons = $('#carousel .buttons');

                //set number of images in the carousel
                carousel.numItems = $('li', carousel.images).length;

                //set width of .images
                carousel.images.css({
                    width: (carousel.numItems * 100) + '%'
                });

                //set image width
                carousel.liWidth = (100 / carousel.numItems) + '%';
                $('li', carousel.images).css({
                    width: carousel.liWidth
                });
                $('.wrapper', carousel.element).css({
                    height: 'auto'
                });

                carousel.generateButtons();

                carousel.setActiveItem(); //set the first item
                carousel.start(null); //kick off the slideshow

                return true;
            }
        }

    };

    return carousel;

});
/*global window, define: true */
define('modules/carousel/touch',['domlib', './common', 'modules/common', 'modules/tesco.utils'], function ($, carousel, common, utils) {
    'use strict';

    /**
     * Handle Tap Events
     * @param  {event} evt
     */
    carousel.tap = function (evt) {

        window.clearTimeout(carousel.sliderTimer);
        carousel.stop();
        evt.preventDefault();

        var target = $(evt.target).closest('li');
        carousel.activeItem = $(target).index();
        carousel.setActiveItem();
    };



    /**
     * Handle touch start event and set initial position of slider widget
     * @param  {event} evt Touch event
     */
    carousel.touchStart = function (evt) {
        carousel.stop();
        evt.preventDefault();

        carousel.sliderTimer = window.setTimeout(function () {
            var initPos;
            if (evt.touches) {
                initPos = evt.touches[0].pageX;

                carousel.posX = initPos - $('li', carousel.buttons).eq(0).offset().left - (carousel.widgetWidth / 2);
                carousel.calculateItem(carousel.posX);

                carousel.element.addClass('touch');
                carousel.widget.css({
                    left: carousel.posX
                });
            }
        }, 80);

    };


    /**
     * Handle touch end event
     * @param  {event} evt Touch event
     */
    carousel.touchEnd = function (evt) {
        window.clearTimeout(carousel.sliderTimer);
        evt.preventDefault();
        carousel.element.removeClass('touch');
    };


    /**
     * Handle touch drag event
     * @param  {event} evt Touch event
     */
    carousel.touchMove = function (evt) {
        var x = carousel.posX,
            offsetX;

        if (evt.touches) {
            offsetX = (evt.touches[0].clientX - x) - $('#carousel-slider').offset().left;
            if ((x + offsetX) < carousel.constraint.start) {
                x = 0;
            } else {
                if ((x + offsetX) > carousel.constraint.end) {
                    x = (carousel.sliderWidth - carousel.widgetWidth);
                } else {
                    x = (x + offsetX) - (carousel.widgetWidth / 2);
                }
            }
            carousel.widget.css({
                left: x
            });
            carousel.calculateItem(x);
        }
    };



    carousel.bindEvents = function () {

        carousel.buttonWidth = 0;

        $('li', carousel.buttons).each(function () {
            carousel.buttonWidth += $(this).width();

            if ($(this).index() !== 0) {
                carousel.buttonWidth += parseInt($(this).css('margin-left'), 10);
            }

            if ($(this).index() !== (carousel.numItems - 1)) {
                carousel.buttonWidth += parseInt($(this).css('margin-right'), 10);
            }
        });


        //set slider vars
        carousel.slider.css({
            width: carousel.buttonWidth,
            'margin-left': -(carousel.buttonWidth / 2)
        });
        carousel.sliderWidth = carousel.buttonWidth;
        carousel.parentPosX = $(carousel.widget).parent().offset().left;
        carousel.posX = $(carousel.widget).offset().left - carousel.parentPosX;
        carousel.sliderParentOffsetX = $(carousel.slider).parent().offset().left;
        carousel.sliderOffsetX = $(carousel.slider).offset().left - carousel.sliderParentOffsetX;
        carousel.widgetWidth = $(carousel.widget).width();
        carousel.constraint.start = carousel.widgetWidth / 2;
        carousel.constraint.end = carousel.sliderWidth - (carousel.widgetWidth / 2);



        /**
         * Bind touch events
         */

        $('#carousel .buttons li')
            .on('touchstart', carousel.touchStart)
            .on('touchend', carousel.touchEnd)
            .on('touchmove', carousel.touchMove)
            .on('tap click', carousel.tap);

        $('.wrapper', carousel.carousel)
            .on('hold', carousel.pause)
            .on('swipeLeft', carousel.swipeLeft)
            .on('swipeRight', carousel.swipeRight)
            .on('touchstart', carousel.handleTouchStart)
            .on('touchend', carousel.handleTouchEnd)
            .on('touchmove', carousel.handleTouchMove);

        $(window)
            .on('dropdownOpenComplete', carousel.pause)
            .on('dropdownCloseComplete', carousel.start);
    };

    carousel.handleTouchStart = function (e) {
        // Take 2 sets of touch points as the user may never trigger the touchmove
        carousel.x1 = e.originalEvent.touches[0].pageX;
        carousel.y1 = e.originalEvent.touches[0].pageY;
        carousel.x2 = e.originalEvent.touches[0].pageX;
        carousel.y2 = e.originalEvent.touches[0].pageY;
    };

    carousel.handleTouchEnd = function (e) {
        if ((Math.abs(carousel.x1 - carousel.x2) < 70) && (Math.abs(carousel.y1 - carousel.y2) < 10)) {
            e.preventDefault();
            if ($(e.target).closest('a').prop('href') !== undefined) {
                window.location.href = $(e.target).closest('a').prop('href');
            } else {
                utils.scrollToElem($('#' + $(e.target).parents('.scrollTo').data('scrolltoid')));
            }
        } else {
            carousel.start();
        }
    };

    carousel.handleTouchMove = function (e) {
        carousel.x2 = e.originalEvent.touches[0].pageX;
        carousel.y2 = e.originalEvent.touches[0].pageY;
    };

    common.init.push(function () {
        if (carousel.init()) {
            carousel.bindEvents();
        }
    });

});
define('modules/tile-carousel/touch',['domlib', './common', 'modules/common'], function($, carousel, common){

	carousel.extend = function(c){

		c.spring = function(direction){
			var self = c, move;
			$('.products', c.target).addClass('fast');
			move = self.calculateDistance() * self.activePanel;
			switch(direction){
				case('next'):
					move += 5;
					break;
				case('back'):
					move -= 5;
					break;
			}
			self.animate(move);
			window.setTimeout(function () {
				move = self.calculateDistance() * self.activePanel;
				self.animate(move);
				$('.products', c.target).removeClass('fast');
			}, 200);
		};

		c.peak = function (e) {};
		c.tab = function(e) {};


		c.bindEvents = function(){

			// var event = common.isAndroid() ? 'touchstart' : 'tap click';
			var event = common.isAndroid() ? 'touchstart' : 'tap click';

			//bind events
			$('.product-carousel-nav .next', c.target).on(event, c.next);

			$('.product-carousel-nav .previous', c.target).on(event, c.back);

			$('.products', c.target).on('swipeLeft', c.next);
			$('.products', c.target).on('swipeRight', c.back);

		};

		return c;

	};

	common.init.push(function() {
		// Defer call as Carousel initialisation is very DOM intensive.
		//setTimeout(function() {
			carousel.init();
		//}, 500);
	});

});

/*global define:true */
/*jslint plusplus: true, regexp: true */
define('modules/buy-from/touch',['domlib', './common', '../common'], function ($, buyFrom, common) {
    'use strict';
    common.init.push(function () {
        if (!window.AsyncBlockController.isCachedPage()) {
            buyFrom.init($(".buy-from"));
        }
    });
});
define('modules/add-to-compare/common',['domlib', 'modules/breakpoint', 'modules/tesco.data', 'modules/common', 'modules/load-more/common'], function($, breakpoint, data, common, loadMore){

	var _myInlineRequests = [];
	var _myRequests = {'selectVariant' : ['scene7', 'buyBoxes', 'specification', 'variants', 'title', 'miniDesc']};
	var _myModules = {'scene7' : ['#flyoutViewerContainer', 'Update product image', true, true, true],                
	                  'buyBoxes' : ['#buy-box-holder', '', true, false, true, true],
	                  'specification' : ['#product-specification', 'Update product specification', true, true, false],
	                  'description' : ['#product-description', '', true, true, false],
	                  'variants' : ['#variants', '', true, false, true, true],
	                  'title' : ['#product-title', 'Updating product title', true, true, true],
	                  'miniDesc' : ['#miniDesc', 'Updating mini description', true, true, true]
	                  };
			
	var _myActions = { 'selectVariant' : ['/stubs/select-variant.php'] };		          
	var _myDefaultActions = { 'selectVariant' : ['/stubs/select-variant.php']};

	data.Global.init({
		'inlineRequests': _myInlineRequests,
		'requests': _myRequests,
		'modules': _myModules,
		'actions': _myActions,
		'defaultActions': _myDefaultActions			
	});
	
	var addToCompare = {
		addToText: 'Add to compare',
		addedText: 'Product added',
		totalCompareCount: 0,
		$addToCompare: '.add-to-compare',
		$compareDialog: '#compare-dialog',
		originalDialogPosition: 0, //set on init
		kiosk: window.isKiosk(),

		toggleState: function (e) {
			e.preventDefault();	
			var self = addToCompare,
				$currentTarget = $(e.target).is('div.add-to-compare') ? $(e.target) : $(e.target).parents('.add-to-compare'),
				$customCheckbox = $currentTarget.find('div'),
				$text = $currentTarget.find('.text'),
				productLink = $('.products-wrapper').attr('data-compare-ds-url');
				
			if (!$customCheckbox.hasClass('checked')) {
				if (addToCompare.totalCompareCount < 4) {
					$customCheckbox.addClass('checked');
					$currentTarget.addClass('selected');
					self.updateText($text, self.addedText);
					self.updateCount(true);										
					productLink += '?method=add&product=' + encodeURI($customCheckbox.attr('data-compare'));					
					$.get(productLink, function(data) {	});					
				}
			} else {
				$customCheckbox.removeClass('checked');
				$currentTarget.removeClass('selected');
				self.updateText($text, self.addToText);
				self.updateCount(false);													
				productLink += '?method=remove&product=' + encodeURI($customCheckbox.attr('data-compare'));				
				$.get(productLink, function(data) { });				
			}
			self.showCompareDialog();			
		},

		updateText: function (element, text) {
			element.text(text);
		},

		updateCount: function (incrementFlag) {
			if (incrementFlag === true && addToCompare.totalCompareCount < 4) {
				addToCompare.totalCompareCount++;
			}
			if (incrementFlag === false && addToCompare.totalCompareCount !== 0) {
				addToCompare.totalCompareCount--;
			}
		},
		
		enableCompare: function () {
			this.$compareDialog.find('.compare-cta').removeClass('disabled');
		},

		disableCompare: function () {
			this.$compareDialog.find('.compare-cta').addClass('disabled');
		},

		enableClear: function () {
			$('#clear-all').removeClass('disabled');
		},

		disableClear: function () {
			$('#clear-all').addClass('disabled');				
		},
		
		showCompareDialog: function (init) { 
			var $notChecked = $('.add-to-compare').find('div').not('.checked'),
				totalCompareCount = 0,
				$text = this.$compareDialog.find('.no-of-items');
			
			if (init!==true) {
				totalCompareCount = addToCompare.totalCompareCount;				
			} else {
				totalCompareCount = parseInt($text.text());
				addToCompare.totalCompareCount = totalCompareCount;
			}
			
			$text.text(totalCompareCount);
			
			if (totalCompareCount === 4 || totalCompareCount >= 2) {
				(totalCompareCount===4)?$notChecked.addClass('disabled'):$notChecked.removeClass('disabled');
				this.$compareDialog.removeClass('hidden');
				if (!this.$compareDialog.hasClass('fixed')) {
					this.addFixedClass();
				}
				this.enableCompare();
				this.enableClear();				
			} else {
				$notChecked.removeClass('disabled');
				this.$compareDialog.addClass('hidden');
				this.disableCompare();
				this.disableClear();
			}
		},
		
		addFixedClass: function () {
			if (this.$compareDialog.offset().top < this.getYOffset()) {
				this.$compareDialog.addClass('fixed');
			} else {
				this.$compareDialog.removeClass('fixed');
			}
		},

		scroll: function (viewport) {
			var $compareDialog = addToCompare.$compareDialog;
			if ($compareDialog.length) {
				var originalDialogPosition = $('#main-content').offset().top;
				window.onscroll = function (evt) {
					if (!$compareDialog.hasClass('hidden')) {
						if (originalDialogPosition < addToCompare.getYOffset() && (viewport !== 'mobileIn' || viewport !== 'vTablet')) {
							$compareDialog.addClass('fixed');
						} else {
							$compareDialog.removeClass('fixed');
						}
					}
				};
			}
		},
		
		getYOffset: function () {
			return window.pageYOffset || document.documentElement.scrollTop;
		},

		onExitCompareMode: function (e) {
			this.exitCompareMode.call(this, e);
		},

		exitCompareMode: function (e) {
			var listingElement = $('#listing');
			listingElement.find('.compare .product').unbind();
			$('body').removeClass('listing-compare-mode');
			listingElement.find('.products').removeClass('compare');
			listingElement.off('click tap', '.compare .product');
			addToCompare.$compareDialog.addClass('hidden');
			// addToCompare.$compareDialog.find('.user-action-text').html('You can select up to 4 items to compare');
			// reset comparisons selected
		},
		
		uncheckAll: function (e) {
			if (e !== 'undefined') {
				e.preventDefault();
			}
			
			var productLink = $('.products-wrapper').attr('data-compare-ds-url'),	
				productsToClear = '';
			
			if (!this.kiosk) {
				$.each($('.add-to-compare.selected'), function (index, value) {
					productsToClear += $(this).find('div').data('compare') + ',';					
					$(this).removeClass('selected');
					$(this).find('.custom-checkbox').removeAttr('checked');
					$(this).find('div').removeClass('disabled checked');
					addToCompare.updateText($(this).find('.text'), addToCompare.addToText);
				});
				$('#compare-dialog').removeClass('fixed').addClass('hidden');
				$('.add-to-compare').find('div').removeClass('disabled'); // enable all the checkboxes
			} else {
				$('.products .selected').removeClass('selected');
				addToCompare.$compareDialog.find('.user-action-text').html('You can select up to 4 items to compare');
			}
			
			productLink += '?method=clear&product=' + productsToClear;			
			$.get(productLink, function(data) { });
			this.resetCompareCount();
		},
		
		resetCompareCount: function () {
			this.totalCompareCount = 0;
			//this.exitCompareMode();
		},		
		
		replaceKioskSpecific: function () {
			this.kiosk = true;
			this.$compareDialog.find('p')
				.text('Compare items')
				.after('<p class="user-action-text">You can select up to 4 items to compare</p>');
			this.$compareDialog.find('.compare-cta').text('Compare selected items');
		},

		selectProduct: function (e) {
			e.preventDefault();
			var $selectedProduct = $(e.currentTarget),
				html = "";
			if (!$selectedProduct.hasClass('selected')) {
				if (addToCompare.totalCompareCount === 4) {
					return;
				}
				$selectedProduct.addClass('selected');
				this.updateCount(true);
			} else {
				$selectedProduct.removeClass('selected');
				this.updateCount(false);
			}
			if (addToCompare.totalCompareCount >=2) {
				this.enableCompare();
			} else {
				this.disableCompare();
			}
			this.enableClear();
			switch (addToCompare.totalCompareCount) {
			case 0:
				html = "Select up to 4 items to compare.";
				this.disableClear();
				break;
			case 1:
				html = 'You have selected <span class="no-of-items">1</span> item to compare. Please select at least 1 more item to compare.';
				break;
			case 2:
				html = 'You have selected <span class="no-of-items">2</span> items to compare.';
				break;
			case 3:
				html = 'You have selected <span class="no-of-items">3</span> items to compare.';
				break;
			case 4:
				html = 'You have chosen the maximum (<span class="no-of-items">4</span>) items to compare.';
				break;
			}
			this.$compareDialog.find('.user-action-text').html(html);
		},

		compareProducts: function (e) {
			if ($(this).hasClass('disabled')) {
				return false;
			}
			var $product = loadMore.findFirstProductInViewport();
			$product = $product.find('a');
			$product.target = $product; 
			loadMore.productBookmarkEvent($product, true);
		},
		
		
		
		init: function () {
			/*
			 *  I understand this will cause a page refresh if the user loads the page on mobile and expands to large desktop, but
			 *  it is very poorly performing on SVP
			 */
			if(common.isPage('PLP') && !breakpoint.mobile){
				addToCompare.$addToCompare = $(addToCompare.$addToCompare);
				addToCompare.$compareDialog = $(addToCompare.$compareDialog);
				addToCompare.bindEvents();
				addToCompare.showCompareDialog(true);				
			}
		}		
	};

	return addToCompare;
});
/*global define: true */
define('modules/add-to-compare/touch',['domlib','modules/breakpoint', './common', 'modules/common'], function($, breakpoint, addToCompare, common){

	addToCompare.bindEvents = function(){

		$('#clear-all').on('tap click', function (e) {
			addToCompare.uncheckAll.call(addToCompare, e);
		});
		$('#exit-compare-mode').on('tap click', this.onExitCompareMode.bind(this));

		$('.compare-cta').on('tap click', this.compareProducts);
		if (!breakpoint.kiosk) {
			//$('#listing').off('tap click');
			$('#listing').on('tap click', '.add-to-compare', this.toggleState);
			this.scroll(breakpoint.currentViewport);
		} else {
			this.replaceKioskSpecific();
			$('#compare-mode').on('tap click',this.enterCompareMode);

			// move out into carousel js
			$('#listing').addClass('product-carousel');

		}
	};

	addToCompare.enterCompareMode = function (e) {
		e.preventDefault();
		$('#listing').find('.products').addClass('compare');
		$('body').addClass('listing-compare-mode');

		$('#listing').on('tap click', '.compare .product', function (e) {
			e.preventDefault();
			e.stopPropagation();
			addToCompare.selectProduct.call(addToCompare, e);
		});

		addToCompare.$compareDialog.removeClass('hidden');
	};

	common.init.push(addToCompare.init);

});
/*global define: true */
define('modules/delivery-options/common',['domlib', 'modules/breakpoint', 'modules/common', 'modules/overlay/common'], function ($, breakpoint, common, overlay) {

    'use strict';

    var delivery = {
        el : '',
        visible : false,
        content : '#templt-delivery-options',

        show : function (e) {

            e.preventDefault();

            var opts,
                url = $('.delivery-options-flyout').data('overlay-url');

            $.ajax({
                url : url,
                success : function (data) {
                    if (breakpoint.mobile || breakpoint.vTablet) {
                        opts = {
                            content : data,
                            closeSelector : '.back'
                        };
                        common.virtualPage.show(opts);
                    } else {
                        opts = {
                            content : data,
                            // targetElement: 'body',
                            // overlayVisible: true,
                            // overlayType: 'lightbox',
                            callback : '',
                            defaultBreakPointBehavior : true,
                            customClass : '',
                            isError : false,
                            fixedWidth : 713
                        };
                        overlay.show(opts);
                    }
                }
            });

            return false;
        },

        init : function () {
            delivery.el = $(".delivery-options-flyout");
            delivery.el = $(delivery.el);
            delivery.bindEvents();
            if (delivery.el.length) {
                delivery.content = $(delivery.content).html();
                window.location.hash = '';
                // moved into init to stop all overlays from being hidden across
                // the site on viewport change
                breakpoint.hTabletIn.push(common.virtualPage.close);
                if (!$('.page-error').length) {
                    breakpoint.vTabletIn.push(overlay.hide);
                }
            }
        }
    };

    return delivery;

});
/*global define: true */
define('modules/delivery-options/touch',['domlib', 'modules/common', './common'], function ($, common, delivery) {

    'use strict';

    delivery.bindEvents = function () {
        $(document).on('tap click', '.delivery-options-flyout', delivery.show);
    };

    common.init.push(delivery.init);

});
define('modules/save-for-later/common',['domlib', 'modules/breakpoint', 'modules/common', 'modules/sticky-sidebar/common'], function($, breakpoint, common, stickySidebar){

	var saveForLater = {

		$wrapper : '#save-for-later',
		$toggle  : '#save-for-later .show-more',
		$noItems : '#save-for-later .no-items',
		isDeferred : true,
		
		// max number of items to display when showing less
		displayLimit: 3,

		// sets a busy flag so only one item can be removed at a time
		isRemoveBusy: false,

		slideDown: function($elm, fnCallback, forceTop){
			var self = saveForLater;

			stickySidebar.lock(forceTop);

			$elm.css('display', 'block').animate({
				opacity: 1,
				height : $elm.data('original-height')
			}, 500, null, function(){
				stickySidebar.animate();

				if (typeof fnCallback === 'function') {
					fnCallback();
				}
			});
		},

		slideUp: function($elm, fnCallback, forceTop){
			var self = saveForLater;

			stickySidebar.lock(forceTop);

			$elm.css({
				overflow: 'hidden',
				height  : $elm.outerHeight()
			});

			$elm.animate({
				opacity : 0,
				height  : 0
			}, 500, null, function(){
				stickySidebar.animate();

				if (typeof fnCallback === 'function') {
					fnCallback();
				}
			});
		},

		// remove item from list
		remove: function(e){
			e.preventDefault();
			e.stopPropagation();
			
			$.get($(e.target).attr('href'), function(res) {				
				
				var self   = saveForLater;
				var $item  = $(e.target).parents('li');
				var $items = self.$wrapper.find('.products > li');
				var index  = $items.index( $item );

				// sets a busy flag so only one can be removed at a time
				// is set back to false on slide up animation completion
				if (self.isRemoveBusy) {
					return false;
				}

				self.isRemoveBusy = true;

				// animate and remove the item
				self.slideUp($item, function(){
					$item.remove();

					// if there are no more items, remove the entire list wrapper
					if (self.$wrapper.find('.products > li').length < 1) {
						self.$wrapper.find('.products').remove();
					}

					self.update();
					self.isRemoveBusy = false;
				});

				// exit if the remaining items are less than/at the display limit
				if ($items.length - 1 < self.displayLimit) {
					return;
				}

				// reveal the next item after the remove to ensure we're always showing
				// the number of items meeting the display limit
				var $next = $items.filter(':hidden').eq(0);

				if ($next.length) {
					self.slideDown( $next );
				}

			});
			
			
			return false;
		},

		// update the display state of the show more/less button and no items message
		update: function(){
			var self   = saveForLater;
			var length = self.$wrapper.find('.products > li').length;

			// no more items, hide the show more and show the no items message
			if (length < 1) {
				self.$toggle.hide();
				self.$noItems.show();
			}

			// total items not exceeding the limit, so hide both the show more and no items message
			else if (length <= self.displayLimit) {

				// rollup the show more button
				if (self.$toggle.is(':visible')) {
					stickySidebar.lock();

					self.$toggle.animate({
						'margin-bottom'  : 0,
						'padding-bottom' : 0,
						'margin-top'  : 0,
						'padding-top' : 0,
						'opacity' : 0,
						'height'  : 0
					}, 250, function(){
						self.$toggle.hide();
						stickySidebar.animate();
					});
				}

				self.$noItems.hide();
			}

			// assume we've items, so show the show more and hide the no items message
			else {
				self.$toggle.show();
				self.$noItems.hide();
			}
		},

		// show more/less toggle
		toggle: function(e) {
			var self = saveForLater;

			e.preventDefault();
			e.stopPropagation();

			// show more
			if (self.$toggle.html() === self.$toggle.data('all')) {
				self.$toggle
					.data('original-top',  self.$toggle.offset().top - (self.$toggle.offset().top - $(document).scrollTop()) )
					.html( self.$toggle.data('less') );

				self.$wrapper.find('.products > li:hidden').each(function(){
					self.slideDown( $(this), null, true );
				});

			// show less (stop at display limit)
			} else {
				self.$toggle.html( self.$toggle.data('all') );

				// scroll back up to the original click/top position
				if (common.isTouch()) {
					$(document).scrollTop(
						self.$toggle.data('original-top')
					);
				} else {
					$('html, body').animate({
						scrollTop: self.$toggle.data('original-top')
					}, 500);
				}

				self.$wrapper.find('.products > li').each(function(i){
					if (i >= self.displayLimit) {
						var $item = $(this);
						self.slideUp($item, function(){
							$item.hide();
						});
					}
				});
			}

			// blur event added to stop the button appearing as active state
			self.$toggle.blur();

			self.update();

			return false;
		},

		init: function () {
			var self = saveForLater;

			self.$wrapper = $('#save-for-later');
			self.$toggle = $('#save-for-later .show-more');
			self.$noItems = $('#save-for-later .no-items');
			
			if (!self.$wrapper.length) {
				return false;
			} else if (self.$wrapper.length && self.isDeferred===false) { 
				/* Fix for #52340
				 * Even when the block is not deferred, "saveForLater.init();" -
				 * gets called and events are attached multiple times
				 * */
				return false;
			}
			
			self.isDeferred = false;
			
			// set the min-height of the produsts wrapper to match the height of the no items message
			// this is to stop the entire wrapper disappering before the no items message is displayed
			self.$wrapper.find('.products-wrapper').css('min-height', self.$noItems.outerHeight(true) + 2 );

			self.$wrapper.find('.products > li').each(function(i){

				// store the original hide for animation
				$(this).data('original-height', $(this).outerHeight() );

				// remove item function
				$(this).find('a.remove').on(self.event, self.remove);

				// hide items exceeding the display limit
				if (i >= self.displayLimit) {
					$(this).css({
						overflow : 'hidden',
						display  : 'none',
						height   : 0
					});
				}
			});


			// show more/less link
			self.$toggle.on(self.event, self.toggle);

			// update the display state of the show more/less button and no items message
			self.update();
		}
	};

	common.init.push(function(){
		saveForLater.init();
	});
	
	common.deferredInit.push(function(){
		saveForLater.init();
	});
	
	

	return saveForLater;
});
/*global define: true */
define('modules/save-for-later/touch',['domlib', './common', 'modules/common'], function($, saveForLater, common){

	saveForLater.event = 'tap click';

	common.init.push(function(){
		saveForLater.init();
	});

});
define('modules/product-description/touch',['domlib', './common', '../common'], function($, pdp, common){
    common.init.push(function(){
        pdp.init();
    });

});
/*global define: true */
define('modules/scroll-to/common',[
        
	'domlib',
	'modules/common',
	'modules/breakpoint'
	
], function($, common, breakpoint) {

	var scrollTo = {
			init: function() {
				var self = scrollTo;
				//scrollTo.bindEvents();		
			},
			bindEvents: function() {
				$('.scrollTo').on(self.event, function(e) {					
					self.doScroll($(this));
					return false;
				});
			},
			jumpTo: function(position) {
				if (breakpoint.mobile || breakpoint.hTablet || breakpoint.vTablet) {
					$(document).scrollTop( position );
				}
			},
			doScroll: function($elem) {
				var idToScroll = $elem.data('scrollToId'); 
				if (idToScroll !== '') {
					var $scrollTo = $("#" + idToScroll);
					if ($scrollTo.length) {
						//$.scroll($scrollTo.offset().top, 1500, 'ease-in-out');
						self.jumpTo($scrollTo.offset().top);
					}
				}
			}		
	};
	
	return scrollTo;

	}
);


/*global define: true */
define('modules/scroll-to/touch',['domlib', './common', 'modules/common'], function($, scrollTo, common){

	scrollTo.event = 'tap click';

	common.init.push(function(){
		scrollTo.init();
	});

});
/*global define: true, window: true*/
define('modules/carousel/desktop',['domlib', './common', 'modules/common'], function ($, carousel, common) {

    'use strict';

    /**
     * Handle click Events
     * @param  {event} evt
     */
    carousel.click = function (evt) {
        carousel.stop();

        var target = $(evt.target).closest('li');
        carousel.activeItem = $(target).index();
        carousel.setActiveItem();
    };


    /**
     * Toggle navigation buttons when not touch
     * @param  {event} evt Click event
     */
    carousel.toggleNavButtons = function (evt) {
        switch (evt.type) {
        case ('mouseenter'):
            $('.navButton', carousel.element).addClass('show');
            break;

        case ('mouseleave'):
            $('.navButton', carousel.element).removeClass('show');
            break;
        }
    };

    carousel.bindEvents = function () {
        //No Touch (Desktop/Mouse)
        $('li', carousel.buttons).on('click', carousel.click);
        $('.wrapper, .navButton', carousel.element).on('mouseleave mouseenter', carousel.toggleNavButtons);

        $('.navButton.next').on('click', carousel.next);
        $('.navButton.prev').on('click', carousel.previous);

        if (window.isKiosk()) {

            common.kioskSwipe('left', $('.wrapper', carousel.carousel), carousel.swipeLeft);
            common.kioskSwipe('right', $('.wrapper', carousel.carousel), carousel.swipeRight);

        } else {
            carousel.images.on('mouseenter', carousel.pause);
            carousel.images.on('mouseleave', carousel.start);

            $(window)
                .on('dropdownOpenComplete', carousel.pause)
                .on('dropdownCloseComplete', carousel.start);
        }
    };


    common.init.push(function () {
        if (carousel.init()) {
            carousel.bindEvents();
        }
    });

});
define('modules/tile-carousel/kiosk',['domlib', './common', 'modules/common'], function($, carousel, common){

	carousel.extend = function(c){

		c.spring = function(direction){
			var self = c, move;
			$('.products', c.target).addClass('fast');
			move = self.calculateDistance() * self.activePanel;
			switch(direction){
				case('next'):
					move += 5;
					break;
				case('back'):
					move -= 5;
					break;
			}
			self.animate(move);
			window.setTimeout(function () {
				move = self.calculateDistance() * self.activePanel;
				self.animate(move);
				$('.products', c.target).removeClass('fast');
			}, 200);
		};

		c.peak = function (e) {};
		c.tab = function(e) {};


		c.bindEvents = function(){
			var event = 'touchstart click';

			//bind events
			$('.product-carousel-nav .next', c.target).on(event, c.next);

			$('.product-carousel-nav .previous', c.target).on(event, c.back);

			$(c.target).on('swipeLeft', c.next);
			$(c.target).on('swipeRight', c.back);

		};

		return c;

	};

	common.init.push(function() {
		carousel.init();
		carousel.initTabs();
	});

	return carousel;
});

/*jslint plusplus: true */
/*globals window,document,console,define,require, $ */
define('modules/promotions-manager/PromotionsManager', [], function () {
    'use strict';

    var PromotionsManager,
        Product,
        Seller,
        Promotion;

    PromotionsManager = function PromotionsManager() {
        this.aProducts = [];
    };

    PromotionsManager.prototype.createProducts = function createProducts(sSkuID, aSellersAndPromotionsData) {
        if (!sSkuID || !aSellersAndPromotionsData) {
            throw new Error("PromotionsManager: Missing skuID or no seller and promotions data received");
        }
        var self = this,
            oTempProduct = new Product(sSkuID, aSellersAndPromotionsData);
        self.aProducts.push(oTempProduct);
    };

    PromotionsManager.prototype.getSellerPromotionsData = function getSellerPromotionsData(sSkuID, sSellerID) {
        var i,
            j,
            oProduct,
            oSeller,
            aPromotions;

        for (i in this.aProducts) {
            if (this.aProducts.hasOwnProperty(i)) {
                oProduct = this.aProducts[i];
                if (oProduct.sSkuID && oProduct.sSkuID === sSkuID) {
                    for (j in oProduct.aSellers) {
                        if (oProduct.aSellers.hasOwnProperty(j)) {
                            oSeller = oProduct.aSellers[j];
                            if (oSeller.sSellerID && oSeller.sSellerID === sSellerID) {
                                aPromotions = oSeller.aPromotions;
                                return aPromotions;
                            }
                        }
                    }
                }
            }
        }
    };

    PromotionsManager.prototype.skuIdInArray = function skuIdInArray(sSkuID) {
        var i,
            oProduct;

        for (i in this.aProducts) {
            if (this.aProducts.hasOwnProperty(i)) {
                oProduct = this.aProducts[i];
                if (oProduct.sSkuID && oProduct.sSkuID === sSkuID) {
                    return true;
                }
            }
        }
    };

/************************************************************************************************************************/

    Product = function Product(sSkuID, aSellersAndPromotionsData) {
        this.sSkuID = sSkuID;
        this.aSellers = [];
        this.createSellers(aSellersAndPromotionsData);
    };

    Product.prototype.createSellers = function createSellers(aRawSellersAndPromotionsData) {
        var oTempSeller,
            sSellerID,
            aPromotions,
            i;

        if (Array.isArray(aRawSellersAndPromotionsData)) {
            for (i = 0; i < aRawSellersAndPromotionsData.length; i++) {
                sSellerID = aRawSellersAndPromotionsData[i].sellerId;
                aPromotions = aRawSellersAndPromotionsData[i].promotions;
                oTempSeller = new Seller(sSellerID, aPromotions);
                this.aSellers.push(oTempSeller);
            }
        } else {
            throw new Error("PromotionsManager: aRawSellersAndPromotionsData is not Array");
        }
    };

/************************************************************************************************************************/

    Seller = function Seller(sSellerID, aPromotionsData) {
        this.sSellerID = sSellerID;
        this.aPromotions = [];
        this.createPromotions(aPromotionsData);
    };

    Seller.prototype.createPromotions = function createPromotions(aRawPromotionsData) {
        var i,
            oTempPromotion;

        for (i = 0; i < aRawPromotionsData.length; i++) {
            oTempPromotion = new Promotion(aRawPromotionsData[i]);
            this.aPromotions.push(oTempPromotion);
        }
    };

/************************************************************************************************************************/

    Promotion = function Promotion(oRawPromotionData) {
        var oPromotionData = oRawPromotionData || {};
        this.displayName = oPromotionData.displayName !== null ? oPromotionData.displayName : "";
        this.description = oPromotionData.description !== null ? oPromotionData.description : "";
        this.linkSaveURL = oPromotionData.linkSaveURL !== null ? oPromotionData.linkSaveURL : "";
        this.customerInstructions = oPromotionData.customerInstructions !== null ? oPromotionData.customerInstructions : "";
        this.type = oPromotionData.type || {};
        this.voucherCode = oPromotionData.voucherCode || {};
        this.enableToggle = (this.description !== "" || this.linkSaveURL !== "" || this.customerInstructions !== "") ? true : false;
    };

    return PromotionsManager;
});
/*jslint plusplus: true */
/*globals window,document,console,define,require, $ */
define('modules/buy-from/kiosk',[
    'domlib',
    'modules/common',
    './common',
    'modules/overlay/common',
    'modules/inline-scrollbar/common',
    'modules/toggle-expand-collapse/common',
    'modules/promotions-manager/PromotionsManager',
    'mustache'
], function ($, common, buyFrom, overlay, inlineScrollbar, ToggleExpandCollapse, PromotionsManager, mustache) {
    'use strict';

    buyFrom.copy = {
        "sellerTrigger": "View all buying &amp; delivery options",
        "overlayHeader": "All buying &amp; delivery options",
        "priceCheckOverlayHeader": "Price check details",
        "sellerHeaderLinks": "Available from "
    };

    buyFrom.setup = function ($module) {
        if ($module.find(".delivery ul").length > 0) {
            this.initAccordians($module.find(".delivery ul"));
        }
        if ($module.find(".quantity input").length > 0) {
            this.setButtonStates($module.find(".quantity input"));
        }
        this.bindEvents($module);
        this.addSellerTriggers($module);
        this.bindSellerOverlayEvents($module);
        this.truncateTitle($module.find(".other-sellers .header h2"));
        buyFrom.initPromotionsManager();
        $('div.offers ul:not(.productPromotionsContent) li a').each(function () {
            $(this).replaceWith($(this).text());
        });
    };

    buyFrom.addSellerTriggers = function ($module) {
        var sellerHeadings = $module.find(".header h2");
        sellerHeadings.each(function () {
            $(this)[0].firstChild.textContent = buyFrom.copy.sellerHeaderLinks;
        });

        sellerHeadings.wrapInner("<a href='#' />");
        if ((!$module.find('.choice-of-seller').length) && $('.buy-from .options').length) {
            if ($module.find('a.primary-button').length) {
                $module.find('a.primary-button').remove();
                $module.append("<a href='#' class='primary-button'>" + buyFrom.copy.sellerTrigger + "</a>");
            } else {
                $module.append("<a href='#' class='primary-button'>" + buyFrom.copy.sellerTrigger + "</a>");
            }
        }
    };

    buyFrom.afterLoadingSellerOverlayActions = function () {
        var lightboxContent = $("#lightbox-content"),
            sSpecialOffersElements = '.offers li .special-offer-container .offer-title',
            $checkbox = lightboxContent.find('.custom-checkbox'),
            eventBoundCheckbox = $checkbox.siblings(".checkbox");

        buyFrom.removeHeaderLinks(lightboxContent);
        lightboxContent.find(".seller").unbind("click");
        lightboxContent.find("#page-container .promoContainer").unbind("click");
        lightboxContent.find(".price-check").bind("click", function (e) {
            buyFrom.animateToEndOfOverlay(lightboxContent);
            e.preventDefault();
            e.stopPropagation();
            return false;
        });
        buyFrom.removeTriggers(lightboxContent);
        buyFrom.moveToSeller(lightboxContent);
        buyFrom.bindEvents(lightboxContent);
        eventBoundCheckbox.removeClass('eventBound');
        common.customCheckBox.init(lightboxContent);
        lightboxContent.find(".services .fnToolTip").on("click", function (e) {
            var clickedElement = $(e.target),
                $elem = $(this),
                serviceLink = $elem.parent().children('.tooltipPopup');

            if (clickedElement.is($('span.price')) || clickedElement.is($('div.dotdotdot'))) { return false; }
				if (!serviceLink.parent('li').hasClass('open')) {
					serviceLink.show();
					serviceLink.parent('li').addClass('open');
                if (serviceLink.parent('li').hasClass('open')) {
						$('#pagination-nav').removeClass('hidden');
                    $('#lightbox-content').css('height', '600');
					}
				} else {
					serviceLink.hide();
					serviceLink.parent('li').removeClass('open');
				}
				$elem.parent().children('.tooltipPopup').find("a.close").hide();
        });
        if ($(sSpecialOffersElements).length > 0) {
            buyFrom.initToggleExpandCollapse = new ToggleExpandCollapse({
                sToggleContainer: '#lightbox .buy-from',
                sToggleElementParent: '.fnToggleDescription',
                sToggleTriggerElement: '.special-offer-container .special-offer-container-top',
                bEnableCustomEvent: true,
                sToggleCustomEventName: 'ToggleSpecialOffersFired',
                bAccordionEnabled: true
            });
            buyFrom.initToggleExpandCollapse.init();
        }
    };

    buyFrom.animateToEndOfOverlay = function (lightboxContent) {
        var y = -(lightboxContent.find(".overlay-wrapper").outerHeight() - lightboxContent.outerHeight());
        inlineScrollbar.animate(y);
    };

    buyFrom.removeTriggers = function (lightboxContent) {
        lightboxContent.find(".options li").attr("style", "");
        lightboxContent.find(".buy-from").children(".primary-button").remove();
        lightboxContent.find(".options .show-more").remove();
    };

    buyFrom.moveToSeller = function (lightboxContent) {
        var selectedItem = lightboxContent.find(".selected"),
            y;
        if (selectedItem.length > 0) {
            y = -(parseInt((selectedItem.offset().top - lightboxContent.offset().top), 10));
            inlineScrollbar.animate(y);
            buyFrom.deselectSeller();
        }
    };

    buyFrom.removeHeaderLinks = function (lightboxContent) {
        lightboxContent.find(".header h2 a").each(function () {
            var title = $(this).attr('data-original-title');
            $(this).parents('h2').html(title || $(this).html());
        });
    };

    buyFrom.isElementThatTriggersSellerOverlay = function isElementThatTriggersSellerOverlay(clickedElement) {
        if (clickedElement.is($('.add-to-basket, .quantity *, #personalise-button, .added-to-basket'))) {
            return false;
        }
        return true;
    };
    buyFrom.bindSellerOverlayEvents = function ($module) {
        $module.find(".primary-button").bind("click", function (e) {
            var clickedElement = $(e.target);
            if (!buyFrom.isElementThatTriggersSellerOverlay(clickedElement)) { return; }
                buyFrom.triggerOverlay($module);
                e.preventDefault();
                e.stopPropagation();
                return false;
        });
        $module.find(".seller").bind("click", function (e) {
            var clickedElement = $(e.target),
                isPriceCheck = clickedElement.hasClass("price-check") || clickedElement.parent("a").hasClass("price-check");

            if (!buyFrom.isElementThatTriggersSellerOverlay(clickedElement)) { return; }
            if (clickedElement.is($('span.price'))) { return false; }
                if (isPriceCheck) {
                    buyFrom.triggerPriceCheckOverlay($module);
            } else {
                    buyFrom.selectSeller(clickedElement);
                if ($('.buy-from .options .delivery, .buy-from .options .offers').length) {
                        buyFrom.triggerOverlay($module);
                    }
                }
                e.preventDefault();
                e.stopPropagation();
                return false;
        });

        $('#special-offers-container').on('click', function (e) {
            buyFrom.triggerOverlay($module);
            e.preventDefault();
            e.stopPropagation();
            return false;
        });
    };

    buyFrom.selectSeller = function (clickedElement) {
        clickedElement.parents(".buy-from").find(".seller.selected").removeClass("selected");
        clickedElement.parents(".seller").addClass("selected");
    };

    buyFrom.deselectSeller = function deselectSeller() {
        $(buyFrom.module).find('.seller.selected').removeClass('selected');
    };

    buyFrom.triggerPriceCheckOverlay = function () {
        var overlayContent = "<div class='product-description'><section class='price-check-details'>" + $(".price-check-details").clone().not(">h3").html() + "</section></div>",
            options = {
                content: overlayContent,
                fixedWidth: 1586,
                enablePagination: true,
                paginationHeader: "<h1>" + buyFrom.copy.priceCheckOverlayHeader + "</h1>"
            };
        overlay.show(options);
    };

    buyFrom.triggerOverlay = function ($module) {
        var overlayContent = "<div class='buy-from'>" + $module.clone().html() + "</div><div class='product-description'><section class='price-check-details' id='price-check'>" + $(".price-check-details").clone().html() + "</section></div>",
            options = {
                content: overlayContent,
                fixedWidth: 1650,
                customClass: 'allBuying-delOptions',
                callback: buyFrom.afterLoadingSellerOverlayActions,
                enablePagination: true,
                paginationHeader: "<h1>" + buyFrom.copy.overlayHeader + "</h1>"
            };
        overlay.show(options);
        if ($('.buy-from-kiosk-cp').length) {
            $('#lightbox').find('#lightbox-content').addClass('buy-from-kiosk-cp');
        }
        $("#lightbox-content .buy-from .seller").each(function () {
            var seller_image = $(this).find('.header-wrapper img');
            $(this).find('.price-info').before($(seller_image));
            $(this).find('.header-wrapper .available-from').text('Buy from');
            $(this).find('.content.kiosk-cp-enabled').addClass('page');
            if ($(this).parent().hasClass('other-sellers')) {
                $(this).find('.options h3, .details, .options .offers h3').remove();
            }
        });

        if (!$('#lightbox .price-check-details table').length) {
            $('.price-check-details').css("display", "none");
        }
        $("#lightbox .buy-from").find(".options .delivery.newDeliveryOptions ul").each(function () {
            $(this).find("li:last-child p.deliveryTimeAndCost").show();
            $(this).find("li:last-child p.ndo-returns").show();
            $(this).find("li:last-child p.terms.description").show();
        });
    };
    buyFrom.serviceTooltip = function serviceTooltip() {
    	$('#lightbox.streamline-basket').find(".more-options .fnToolTip").on("click", function (e) {
    		
    		var clickedElement = $(e.target),
                $elem = $(this),
                tooltipPopup = $elem.parent().children('.tooltipPopup'),
                tooltipLeft = $(this).width() + 45 + "px",
                tooltipPos = "-" + ($(this).offset().top - (tooltipPopup.height() / 2) + 20 + "px");
    		
            if (clickedElement.is($('span.price')) || clickedElement.is($('div.dotdotdot'))) { return false; }
            if ($('.tooltipPopup:visible')) {
                $('.tooltipPopup').hide();
				}
				
				$(this).next('.tooltipPopup').toggle();
				tooltipPopup.css({
					"top": tooltipPos,
                "left": tooltipLeft
				});
            $('.tooltipPopup .close').on('click', function (e) {
					$(e.target).closest('.tooltipPopup').hide();
				});
        });
    };
    buyFrom.truncateTitle = function (selector) {
        selector.find('a').dotdotdot({
            ellipsis: '',
            after: '<span class="ellipsis"></span>',
            wrap: 'letter',
            watch: true,
            tolerance: 0,
            callback: function () {
                $(this).attr('data-original-title', $(this).triggerHandler('originalContent').text());
                $(this).find('.ellipsis').html('<span class="icon" data-icon="&hellip;"></span></span>');
            }
        });
    };

    buyFrom.renderPromotionsTemplateForKioskOverlay = function renderPromotionsTemplate(aPromotionsData, sSellerID) {
        var template = $('#promotionsTemplateForKioskOverlay').html(),
            html = mustache.render(template, aPromotionsData),
            $sellerContainer = $(buyFrom.module).find('[data-sellerid="' + sSellerID + '"]'),
            $optionsContainer = $sellerContainer.find('.options'),
            $offersContainer = $optionsContainer.find('.offers');

        if ($offersContainer.length > 0) {
            $offersContainer.replaceWith(html);
        } else {
            $optionsContainer.append(html);
        }
    };

    buyFrom.splitPromotionsBySellerID = function splitPromotionsBySellerID() {
        var aSellerIDs = buyFrom.getSellerIDsFromBuyBox(),
            i,
            aPromotionsData,
            sSellerID;

        for (i = 0; i < aSellerIDs.length; i++) {
            sSellerID = aSellerIDs[i];
            aPromotionsData = buyFrom.oPromotionsManager.getSellerPromotionsData(buyFrom.sSkuID, sSellerID);
            if (aPromotionsData && aPromotionsData.length !== 0) {
                buyFrom.renderPromotionsTemplateForKioskOverlay(aPromotionsData, sSellerID);
            }
        }
    };

    buyFrom.getPromotionsTemplateForKioskOverlay = function getPromotionsTemplateForKioskOverlay() {
        var sTemplatesPath = window.globalStaticTemplatesPath || "/../assets/js/templates/";

        $.ajax({
            url: sTemplatesPath + "kiosk/promotionsTemplateForKioskOverlay.html"
        }).done(function (data) {
            var template = data;
            $('body').append(template);
            $(buyFrom.module).find('#bbSeller1 .options').append('<div class="offers"><h3>Special offers</h3></div>');
            buyFrom.getSellersAndPromotionsData(buyFrom.sSkuID);
        }).fail(function (jqXHR) {
            throw new Error("PromotionsManager: " + jqXHR.status + " " + jqXHR.statusText);
        });
    };

    buyFrom.getSellersAndPromotionsData = function getSellersAndPromotionsData(sSkuID) {
        var sDataURL = "/direct/blocks/catalog/productdetail/productPromo.jsp?format=json",
            aSellersAndPromotionsData;
        $.ajax({
            url: sDataURL,
            data: {
                "skuId": sSkuID
            }
        }).done(function (data) {
            if (typeof data === 'string') {
                data = JSON.parse(data);
            }
            aSellersAndPromotionsData = data;
            buyFrom.oPromotionsManager.createProducts(sSkuID, aSellersAndPromotionsData);
            buyFrom.splitPromotionsBySellerID();
        }).fail(function (jqXHR) {
            throw new Error("PromotionsManager: " + jqXHR.status + " " + jqXHR.statusText);
        });
    };

    buyFrom.initPromotionsManager = function initPromotionsManager(sSkuID) {
        buyFrom.sSkuID = sSkuID || "";
        if (buyFrom.sSkuID === "" && window.TescoData !== undefined && window.TescoData.skuID !== undefined) {
            buyFrom.sSkuID = window.TescoData.skuID;
        }
        if (buyFrom.sSkuID && buyFrom.sSkuID !== "") {
            if (buyFrom.oPromotionsManager !== undefined) {
                if (buyFrom.oPromotionsManager.skuIdInArray(buyFrom.sSkuID)) {
                    buyFrom.splitPromotionsBySellerID();
                } else {
                    buyFrom.getSellersAndPromotionsData(buyFrom.sSkuID);
                }
            } else {
                buyFrom.oPromotionsManager = new PromotionsManager();
                if (!$('#promotionsTemplateForKioskOverlay').length) {
                    buyFrom.getPromotionsTemplateForKioskOverlay();
                }
            }
        }
    };

    buyFrom.getSellerIDsFromBuyBox = function getSellerIDsFromBuyBox() {
        var $sellerContainer = $('.buy-from .seller'),
            aSellerIDs = [],
            sSellerID;

        $sellerContainer.each(function () {
            sSellerID = $(this).data('sellerid');
            if (sSellerID !== undefined) {
                if (typeof sSellerID === 'number') {
                    sSellerID = sSellerID.toString();
                }
                aSellerIDs.push(sSellerID);
            }
        });
        return aSellerIDs;
    };

    common.init.push(function () {
        if (!window.AsyncBlockController.isCachedPage()) {
            buyFrom.init($(".buy-from"));
        }
    });
});
/*global define:true */
define('modules/basket/kiosk',['domlib', 'modules/common', './common', 'modules/inline-scrollbar/common', 'modules/chip-and-pin/kmf-io'], function ($, common, basket, inlineScrollbar, kmfIO) {
	
	var self, kioskInit, kioskVerticalScroll, updateDomReferences, manipulateDom, updateRemoveButtonContent, updateContinueToCheckoutButtonText, updateItemHeading, updateTotalSavingsHeader, updateAvailableOptionsAddToBasketText, makeQuantityUpdatesReadOnly, showManipulatedDomElements, initScroller, scroller, $basketItem, $basketPrimary, $basketSummary, $basketSummaryInner, $continueToCheckoutButton, $subtotal, $availableOptions, $availableOptionsAddToBasket;
	
	/*
	kioskVerticalScroll = function kioskVerticalScroll() {
		var init, self, updateDom, $kioskScrollerInnner, $kioskVerticalPageWrapper;
		
		bindEvents = function bindEvents() {
			$kioskVerticalPageWrapper = $('.kiosk-vertical-scrollbar-wrapper', self.module);
			if ($kioskVerticalPageWrapper.length) {
				
			}
		};
		
		updateDom = function updateDom() {
			$basketPrimary.wrapInner('<div class="kiosk-vertical-scroller-wrapper"><div class="kiosk-vertical-scroller-inner"></div></div>');
			$kioskScrollerInner = $('.kiosk-vertical-scroller-inner', $basketPrimary);
			$kioskScrollerInner.after('<div class="kiosk-vertical-scrollbar-wrapper"><a href="#" class="button-up">[ UP ]</a><a href="#" class="button-down">[ DOWN ]</a></div>');
			bindEvents();
		};
		
		init = function init() {
			self = this;
			updateDom();
		}();
	};
	*/
	initScroller = function initScroller() {
		//scroller = new kioskVerticalScroll();
		inlineScrollbar.init($('.basket-item-container'), null);
	};
	
	kioskInit = function kioskInit() {
		self = this;
		updateDomReferences();
		manipulateDom();
		updateRemoveButtonContent();
		updateContinueToCheckoutButtonText();
		updateItemHeading();
		updateTotalSavingsHeader();
		updateAvailableOptionsAddToBasketText();
		makeQuantityUpdatesReadOnly();
		showManipulatedDomElements();
		initScroller();
		kmfIO.enableBasketButton();
	};
	
	updateDomReferences = function updateDomReferences() {
        $basketItem = $('.basket-item', self.module);
		$basketPrimary = $('#basket-primary', self.module);
		$basketSummary = $('#basket-summary-mini', self.module);
		$basketSummaryInner = $('.basket-summary-inner', self.module);
		$subtotal = $('.subtotal', self.module);
		$removeButton = $('.remove.tertiary-button', self.module);
		$basketItemHeading = $('.basket-item .description h3.section-heading', self.module);
		$totalWrapper = $('.basket-summary-inner .total-wrapper', self.module);
		//$continueToCheckoutButton = $('#basket-checkout', self.module);
		$continueToCheckoutButton = $('.basket-summary-inner #continueCheckout', self.module);
		$availableOptions = $('.available-product-options', self.module);
		$availableOptionsAddToBasket = $('.available-product-options input[type="submit"]', self.module);
    };
    
    updateContinueToCheckoutButtonText = function updateContinueToCheckoutButtonText() {
    	$continueToCheckoutButton.val('Checkout Now');
    };
    
    updateRemoveButtonContent = function updateRemoveButtonContent() {
    	$removeButton.text('X');
    };
    
    updateAvailableOptionsAddToBasketText = function updateAvailableOptionsAddToBasketText() {
    	$availableOptionsAddToBasket.val('Add').attr('class', 'primary-button');
	};
    
    updateItemHeading = function updateItemHeader() {
    	var $firstHeading, currentHeading, newHeading;
    	if (!$basketItemHeading.length) {
    		return;
    	}
    	$firstHeading = $basketItemHeading.first();
		currentHeading = $firstHeading.text();
		newHeading = currentHeading.slice(0, -1);
		$firstHeading.text(newHeading);
    };
    
    updateTotalSavingsHeader = function updateTotalSavingsHeader() {
    	var $elm, html, newHtml;
    	$elm = $('.savings-wrapper li.total');
    	if($elm.length > 0){
	    	html = $elm.html().toString();
	    	newHtml = html.replace('Total savings', 'Savings');
	    	$elm.html(newHtml);
    	}
    };
    
    makeQuantityUpdatesReadOnly = function makeQuantityUpdatesReadOnly() {
    	$basketItem.find('.quantity input[type="text"]').attr('readonly', 'readonly');
    };
    
    showManipulatedDomElements = function showManipulatedDomElements() {
		$availableOptions.show();		
    };
    
	manipulateDom = function manipulateDom() {
		$basketSummary.insertBefore($basketSummaryInner);
		$continueToCheckoutButton.insertAfter($totalWrapper);
		$('.remove-product').each(function (){ 
			$(this).show().parent().find('.quantity .remove.tertiary-button').first().show().appendTo($(this));
		});
		$('.basket-item .description h2 a').each( function(){
		    var itemTitle=$(this);
		    var itemTitle_height=$('.basket-item .description h2').height();
		    while ($(itemTitle).outerHeight() > itemTitle_height) {
		        $(itemTitle).text(function (index, text) {
		            return text.replace(/\W*\s(\S)*$/, '...');
		        });
		    }
		});
		
		$('.basket-item .available-product-options').each( function(){
		    var checkboxLabel=$(this).find('form > label');
		    checkboxLabel.find('.checkbox').insertBefore(checkboxLabel.find('.value'));
		});
		
		$('.basket-summary-inner ul.clubcard-points').insertAfter('.basket-summary-inner .total-wrapper');
	};

	common.init.push(function() {
		kioskInit();
	});
});
/*!
 * jScrollPane - v2.0.20 - 2014-10-23
 * http://jscrollpane.kelvinluck.com/
 *
 * Copyright (c) 2014 Kelvin Luck
 * Dual licensed under the MIT or GPL licenses.
 */
// Script: jScrollPane - cross browser customisable scrollbars
//
// *Version: 2.0.20, Last updated: 2014-10-23*
//
// Project Home - http://jscrollpane.kelvinluck.com/
// GitHub       - http://github.com/vitch/jScrollPane
// Source       - http://github.com/vitch/jScrollPane/raw/master/script/jquery.jscrollpane.js
// (Minified)   - http://github.com/vitch/jScrollPane/raw/master/script/jquery.jscrollpane.min.js
//
// About: License
//
// Copyright (c) 2014 Kelvin Luck
// Dual licensed under the MIT or GPL Version 2 licenses.
// http://jscrollpane.kelvinluck.com/MIT-LICENSE.txt
// http://jscrollpane.kelvinluck.com/GPL-LICENSE.txt
//
// About: Examples
//
// All examples and demos are available through the jScrollPane example site at:
// http://jscrollpane.kelvinluck.com/
//
// About: Support and Testing
//
// This plugin is tested on the browsers below and has been found to work reliably on them. If you run
// into a problem on one of the supported browsers then please visit the support section on the jScrollPane
// website (http://jscrollpane.kelvinluck.com/) for more information on getting support. You are also
// welcome to fork the project on GitHub if you can contribute a fix for a given issue. 
//
// jQuery Versions - tested in 1.4.2+ - reported to work in 1.3.x
// Browsers Tested - Firefox 3.6.8, Safari 5, Opera 10.6, Chrome 5.0, IE 6, 7, 8
//
// About: Release History
//
// 2.0.20 - (2014-10-23) Adds AMD support (thanks @carlosrberto) and support for overflow-x/overflow-y (thanks @darimpulso)
// 2.0.19 - (2013-11-16) Changes for more reliable scroll amount with latest mousewheel plugin (thanks @brandonaaron)
// 2.0.18 - (2013-10-23) Fix for issue with gutters and scrollToElement (thanks @Dubiy)
// 2.0.17 - (2013-08-17) Working correctly when box-sizing is set to border-box (thanks @pieht)
// 2.0.16 - (2013-07-30) Resetting left position when scroll is removed. Fixes #189
// 2.0.15 - (2013-07-29) Fixed issue with scrollToElement where the destX and destY are undefined.
// 2.0.14 - (2013-05-01) Updated to most recent mouse wheel plugin (see #106) and related changes for sensible scroll speed
// 2.0.13 - (2013-05-01) Switched to semver compatible version name
// 2.0.0beta12 - (2012-09-27) fix for jQuery 1.8+
// 2.0.0beta11 - (2012-05-14)
// 2.0.0beta10 - (2011-04-17) cleaner required size calculation, improved keyboard support, stickToBottom/Left, other small fixes
// 2.0.0beta9 - (2011-01-31) new API methods, bug fixes and correct keyboard support for FF/OSX
// 2.0.0beta8 - (2011-01-29) touchscreen support, improved keyboard support
// 2.0.0beta7 - (2011-01-23) scroll speed consistent (thanks Aivo Paas)
// 2.0.0beta6 - (2010-12-07) scrollToElement horizontal support
// 2.0.0beta5 - (2010-10-18) jQuery 1.4.3 support, various bug fixes
// 2.0.0beta4 - (2010-09-17) clickOnTrack support, bug fixes
// 2.0.0beta3 - (2010-08-27) Horizontal mousewheel, mwheelIntent, keyboard support, bug fixes
// 2.0.0beta2 - (2010-08-21) Bug fixes
// 2.0.0beta1 - (2010-08-17) Rewrite to follow modern best practices and enable horizontal scrolling, initially hidden
//							 elements and dynamically sized elements.
// 1.x - (2006-12-31 - 2010-07-31) Initial version, hosted at googlecode, deprecated
/*jslint plusplus: true */
/*globals window,document,console,define,require, $ */
define('modules/jscrollpane/common', ['domlib'], function () {
    $.fn.jScrollPane = function (settings) {
        // JScrollPane "class" - public methods are available through $('selector').data('jsp')
        function JScrollPane(elem, s) {
            var settings, jsp = this,
                pane, paneWidth, paneHeight, container, contentWidth, contentHeight,
                percentInViewH, percentInViewV, isScrollableV, isScrollableH, verticalDrag, dragMaxY,
                verticalDragPosition, horizontalDrag, dragMaxX, horizontalDragPosition,
                verticalBar, verticalTrack, scrollbarWidth, verticalTrackHeight, verticalDragHeight, arrowUp, arrowDown,
                horizontalBar, horizontalTrack, horizontalTrackWidth, horizontalDragWidth, arrowLeft, arrowRight,
                reinitialiseInterval, originalPadding, originalPaddingTotalWidth, previousContentWidth,
                wasAtTop = true,
                wasAtLeft = true,
                wasAtBottom = false,
                wasAtRight = false,
                originalElement = elem.clone(false, false).empty(),
                mwEvent = $.fn.mwheelIntent ? 'mwheelIntent.jsp' : 'mousewheel.jsp';

            if (elem.css('box-sizing') === 'border-box') {
                originalPadding = 0;
                originalPaddingTotalWidth = 0;
            } else {
                originalPadding = elem.css('paddingTop') + ' ' +
                    elem.css('paddingRight') + ' ' +
                    elem.css('paddingBottom') + ' ' +
                    elem.css('paddingLeft');
                originalPaddingTotalWidth = (parseInt(elem.css('paddingLeft'), 10) || 0) +
                    (parseInt(elem.css('paddingRight'), 10) || 0);
            }

            function initialise(s) {

                var /*firstChild, lastChild, */ isMaintainingPositon, lastContentX, lastContentY,
                    hasContainingSpaceChanged, originalScrollTop, originalScrollLeft,
                    maintainAtBottom = false,
                    maintainAtRight = false;

                settings = s;

                if (pane === undefined) {
                    originalScrollTop = elem.scrollTop();
                    originalScrollLeft = elem.scrollLeft();

                    elem.css({
                        overflow: 'hidden',
                        padding: 0
                    });
                    // _TODO: Deal with where width/ height is 0 as it probably means the element is hidden and we should
                    // come back to it later and check once it is unhidden...
                    paneWidth = elem.innerWidth() + originalPaddingTotalWidth;
                    paneHeight = elem.innerHeight();

                    elem.width(paneWidth);

                    pane = $('<div class="jspPane" />').css('padding', originalPadding).append(elem.children());
                    container = $('<div class="jspContainer" />')
                        .css({
                            'width': paneWidth + 'px',
                            'height': paneHeight + 'px'
                        }).append(pane).appendTo(elem);

                /*
                // Move any margins from the first and last children up to the container so they can still
                // collapse with neighbouring elements as they would before jScrollPane 
                firstChild = pane.find(':first-child');
                lastChild = pane.find(':last-child');
                elem.css(
	                {
		                'margin-top': firstChild.css('margin-top'),
		                'margin-bottom': lastChild.css('margin-bottom')
	                }
                );
                firstChild.css('margin-top', 0);
                lastChild.css('margin-bottom', 0);
                */
                } else {
                    elem.css('width', '');

                    maintainAtBottom = settings.stickToBottom && isCloseToBottom();
                    maintainAtRight = settings.stickToRight && isCloseToRight();

                    hasContainingSpaceChanged = elem.innerWidth() + originalPaddingTotalWidth != paneWidth || elem.outerHeight() != paneHeight;

                    if (hasContainingSpaceChanged) {
                        paneWidth = elem.innerWidth() + originalPaddingTotalWidth;
                        paneHeight = elem.innerHeight();
                        container.css({
                            width: paneWidth + 'px',
                            height: paneHeight + 'px'
                        });
                    }

                    // If nothing changed since last check...
                    if (!hasContainingSpaceChanged && previousContentWidth == contentWidth && pane.outerHeight() == contentHeight) {
                        elem.width(paneWidth);
                        return;
                    }
                    previousContentWidth = contentWidth;

                    pane.css('width', '');
                    elem.width(paneWidth);

                    container.find('>.jspVerticalBar,>.jspHorizontalBar').remove().end();
                }

                pane.css('overflow', 'auto');
                if (s.contentWidth) {
                    contentWidth = s.contentWidth;
                } else {
                    contentWidth = pane[0].scrollWidth;
                }
                contentHeight = pane[0].scrollHeight;
                pane.css('overflow', '');

                percentInViewH = contentWidth / paneWidth;
                percentInViewV = contentHeight / paneHeight;
                isScrollableV = percentInViewV > 1;

                isScrollableH = percentInViewH > 1;

                //console.log(paneWidth, paneHeight, contentWidth, contentHeight, percentInViewH, percentInViewV, isScrollableH, isScrollableV);
                if (!(isScrollableH || isScrollableV)) {
                    elem.addClass('jspScrollable-disabled');
                } else {
                    elem.removeClass('jspScrollable-disabled');
                }
                if (!(isScrollableH || isScrollableV)) {
                    elem.removeClass('jspScrollable');
                    pane.css({
                        top: 0,
                        left: 0,
                        width: container.width() - originalPaddingTotalWidth
                    });
                    removeMousewheel();
                    removeFocusHandler();
                    removeKeyboardNav();
                    removeClickOnTrack();
                } else {
                    elem.addClass('jspScrollable');

                    isMaintainingPositon = settings.maintainPosition && (verticalDragPosition || horizontalDragPosition);
                    if (isMaintainingPositon) {
                        lastContentX = contentPositionX();
                        lastContentY = contentPositionY();
                    }

                    initialiseVerticalScroll();
                    initialiseHorizontalScroll();
                    resizeScrollbars();

                    if (isMaintainingPositon) {
                        scrollToX(maintainAtRight ? (contentWidth - paneWidth) : lastContentX, false);
                        scrollToY(maintainAtBottom ? (contentHeight - paneHeight) : lastContentY, false);
                    }

                    initFocusHandler();
                    initMousewheel();
                    initTouch();

                    if (settings.enableKeyboardNavigation) {
                        initKeyboardNav();
                    }
                    if (settings.clickOnTrack) {
                        initClickOnTrack();
                    }

                    observeHash();
                    if (settings.hijackInternalLinks) {
                        hijackInternalLinks();
                    }
                }

                if (settings.autoReinitialise && !reinitialiseInterval) {
                    reinitialiseInterval = setInterval(
                        function () {
                            initialise(settings);
                        },
                        settings.autoReinitialiseDelay
                    );
                } else if (!settings.autoReinitialise && reinitialiseInterval) {
                    clearInterval(reinitialiseInterval);
                }

                originalScrollTop && elem.scrollTop(0) && scrollToY(originalScrollTop, false);
                originalScrollLeft && elem.scrollLeft(0) && scrollToX(originalScrollLeft, false);

                elem.trigger('jsp-initialised', [isScrollableH || isScrollableV]);
            }

            function initialiseVerticalScroll() {
                //           if (isScrollableV) {

                container.append(
                    $('<div class="jspVerticalBar" />').append(
                        $('<div class="jspCap jspCapTop" />'),
                        $('<div class="jspTrack" />').append(
                            $('<div class="jspDrag" />').append(
                                $('<div class="jspDragTop" />'),
                                $('<div class="jspDragBottom" />')
                            )
                        ),
                        $('<div class="jspCap jspCapBottom" />')
                    )
                );

                verticalBar = container.find('>.jspVerticalBar');
                verticalTrack = verticalBar.find('>.jspTrack');
                verticalDrag = verticalTrack.find('>.jspDrag');

                if (settings.showArrows) {
                    
                    if (settings.isKmf) {
                        arrowUp = $('<a class="jspArrow jspArrowUp" data-icon="1" />').bind(
                            'click', getArrowScroll(0, -1)
                        ).bind('click.jsp', nil);
                        arrowDown = $('<a class="jspArrow jspArrowDown" data-icon="2" />').bind(
                            'click', getArrowScroll(0, 1)
                        ).bind('click.jsp', nil);
                    } else {
                        arrowUp = $('<a class="jspArrow jspArrowUp" data-icon="1" />').bind(
                            'mousedown.jsp', getArrowScroll(0, -1)
                        ).bind('click.jsp', nil);
                            arrowDown = $('<a class="jspArrow jspArrowDown" data-icon="2" />').bind(
                            'mousedown.jsp', getArrowScroll(0, 1)
                        ).bind('click.jsp', nil);
                    }
                    
                    if (settings.arrowScrollOnHover) {
                        arrowUp.bind('mouseover.jsp', getArrowScroll(0, -1, arrowUp));
                        arrowDown.bind('mouseover.jsp', getArrowScroll(0, 1, arrowDown));
                    }

                    appendArrows(verticalTrack, settings.verticalArrowPositions, arrowUp, arrowDown);
                }

                verticalTrackHeight = paneHeight;
                container.find('>.jspVerticalBar>.jspCap:visible,>.jspVerticalBar>.jspArrow').each(
                    function () {
                        verticalTrackHeight -= $(this).outerHeight();
                    }
                );


                verticalDrag.hover(
                    function () {
                        verticalDrag.addClass('jspHover');
                    },
                    function () {
                        verticalDrag.removeClass('jspHover');
                    }
                ).bind(
                    'mousedown.jsp',
                    function (e) {
                        // Stop IE from allowing text selection
                        $('html').bind('dragstart.jsp selectstart.jsp', nil);

                        verticalDrag.addClass('jspActive');

                        var startY = e.pageY - verticalDrag.position().top;

                        $('html').bind(
                            'mousemove.jsp',
                            function (e) {
                                positionDragY(e.pageY - startY, false);
                            }
                        ).bind('mouseup.jsp mouseleave.jsp', cancelDrag);
                        return false;
                    }
                );
                sizeVerticalScrollbar();
                //            }
            }

            function sizeVerticalScrollbar() {
                verticalTrack.height(verticalTrackHeight + 'px');
                verticalDragPosition = 0;
                scrollbarWidth = settings.verticalGutter + verticalTrack.outerWidth();

                // Make the pane thinner to allow for the vertical scrollbar
                pane.width(paneWidth - scrollbarWidth - originalPaddingTotalWidth);

                // Add margin to the left of the pane if scrollbars are on that side (to position
                // the scrollbar on the left or right set it's left or right property in CSS)
                try {
                    if (verticalBar.position().left === 0) {
                        pane.css('margin-left', scrollbarWidth + 'px');
                    }
                } catch (err) { }
            }

            function initialiseHorizontalScroll() {
                if (isScrollableH) {

                    container.append(
                        $('<div class="jspHorizontalBar" />').append(
                            $('<div class="jspCap jspCapLeft" />'),
                            $('<div class="jspTrack" />').append(
                                $('<div class="jspDrag" />').append(
                                    $('<div class="jspDragLeft" />'),
                                    $('<div class="jspDragRight" />')
                                )
                            ),
                            $('<div class="jspCap jspCapRight" />')
                        )
                    );

                    horizontalBar = container.find('>.jspHorizontalBar');
                    horizontalTrack = horizontalBar.find('>.jspTrack');
                    horizontalDrag = horizontalTrack.find('>.jspDrag');

                    if (settings.showArrows) {
                        arrowLeft = $('<a class="jspArrow jspArrowLeft" />').bind(
                            'mousedown.jsp', getArrowScroll(-1, 0)
                        ).bind('click.jsp', nil);
                        arrowRight = $('<a class="jspArrow jspArrowRight" />').bind(
                            'mousedown.jsp', getArrowScroll(1, 0)
                        ).bind('click.jsp', nil);
                        if (settings.arrowScrollOnHover) {
                            arrowLeft.bind('mouseover.jsp', getArrowScroll(-1, 0, arrowLeft));
                            arrowRight.bind('mouseover.jsp', getArrowScroll(1, 0, arrowRight));
                        }
                        appendArrows(horizontalTrack, settings.horizontalArrowPositions, arrowLeft, arrowRight);
                    }

                    horizontalDrag.hover(
                        function () {
                            horizontalDrag.addClass('jspHover');
                        },
                        function () {
                            horizontalDrag.removeClass('jspHover');
                        }
                    ).bind(
                        'mousedown.jsp',
                        function (e) {
                            // Stop IE from allowing text selection
                            $('html').bind('dragstart.jsp selectstart.jsp', nil);

                            horizontalDrag.addClass('jspActive');

                            var startX = e.pageX - horizontalDrag.position().left;

                            $('html').bind(
                                'mousemove.jsp',
                                function (e) {
                                    positionDragX(e.pageX - startX, false);
                                }
                            ).bind('mouseup.jsp mouseleave.jsp', cancelDrag);
                            return false;
                        }
                    );
                    horizontalTrackWidth = container.innerWidth();
                    sizeHorizontalScrollbar();
                }
            }

            function sizeHorizontalScrollbar() {
                container.find('>.jspHorizontalBar>.jspCap:visible,>.jspHorizontalBar>.jspArrow').each(
                    function () {
                        horizontalTrackWidth -= $(this).outerWidth();
                    }
                );

                horizontalTrack.width(horizontalTrackWidth + 'px');
                horizontalDragPosition = 0;
            }

            function resizeScrollbars() {
                if (isScrollableH && isScrollableV) {
                    var horizontalTrackHeight = horizontalTrack.outerHeight(),
                        verticalTrackWidth = verticalTrack.outerWidth();
                    verticalTrackHeight -= horizontalTrackHeight;
                    $(horizontalBar).find('>.jspCap:visible,>.jspArrow').each(
                        function () {
                            horizontalTrackWidth += $(this).outerWidth();
                        }
                    );
                    horizontalTrackWidth -= verticalTrackWidth;
                    paneHeight -= verticalTrackWidth;
                    paneWidth -= horizontalTrackHeight;
                    horizontalTrack.parent().append(
                        $('<div class="jspCorner" />').css('width', horizontalTrackHeight + 'px')
                    );
                    sizeVerticalScrollbar();
                    sizeHorizontalScrollbar();
                }
                // reflow content
                if (isScrollableH) {
                    pane.width((container.outerWidth() - originalPaddingTotalWidth) + 'px');
                }
                contentHeight = pane.outerHeight();
                percentInViewV = contentHeight / paneHeight;

                if (isScrollableH) {
                    horizontalDragWidth = Math.ceil(1 / percentInViewH * horizontalTrackWidth);
                    if (horizontalDragWidth > settings.horizontalDragMaxWidth) {
                        horizontalDragWidth = settings.horizontalDragMaxWidth;
                    } else if (horizontalDragWidth < settings.horizontalDragMinWidth) {
                        horizontalDragWidth = settings.horizontalDragMinWidth;
                    }
                    horizontalDrag.width(horizontalDragWidth + 'px');
                    dragMaxX = horizontalTrackWidth - horizontalDragWidth;
                    _positionDragX(horizontalDragPosition); // To update the state for the arrow buttons
                }
                if (isScrollableV) {
                    verticalDragHeight = Math.ceil(1 / percentInViewV * verticalTrackHeight);
                    if (verticalDragHeight > settings.verticalDragMaxHeight) {
                        verticalDragHeight = settings.verticalDragMaxHeight;
                    } else if (verticalDragHeight < settings.verticalDragMinHeight) {
                        verticalDragHeight = settings.verticalDragMinHeight;
                    }
                    verticalDrag.height(verticalDragHeight + 'px');
                    dragMaxY = verticalTrackHeight - verticalDragHeight;
                    _positionDragY(verticalDragPosition); // To update the state for the arrow buttons
                }
            }

            function appendArrows(ele, p, a1, a2) {
                var p1 = "before",
                    p2 = "after",
                    aTemp;

                // Sniff for mac... Is there a better way to determine whether the arrows would naturally appear
                // at the top or the bottom of the bar?
                if (p == "os") {
                    p = /Mac/.test(navigator.platform) ? "after" : "split";
                }
                if (p == p1) {
                    p2 = p;
                } else if (p == p2) {
                    p1 = p;
                    aTemp = a1;
                    a1 = a2;
                    a2 = aTemp;
                }

                ele[p1](a1)[p2](a2);
            }

            function getArrowScroll(dirX, dirY, ele) {
                return function () {
                    arrowScroll(dirX, dirY, this, ele);
                    this.blur();
                    return false;
                };
            }

            function arrowScroll(dirX, dirY, arrow, ele) {
                arrow = $(arrow).addClass('jspActive');

                var eve,
                    scrollTimeout,
                    isFirst = true,
                    doScroll = function () {
                        if (dirX !== 0) {
                            jsp.scrollByX(dirX * settings.arrowButtonSpeed);
                        }
                        if (dirY !== 0) {
                            jsp.scrollByY(dirY * settings.arrowButtonSpeed);
                        }
                        scrollTimeout = setTimeout(doScroll, isFirst ? settings.initialDelay : settings.arrowRepeatFreq);
                        isFirst = false;
                    };

                doScroll();

                eve = ele ? 'mouseout.jsp' : 'mouseup.jsp';
                ele = ele || $('html');
                ele.bind(
                    eve,
                    function () {
                        arrow.removeClass('jspActive');
                        scrollTimeout && clearTimeout(scrollTimeout);
                        scrollTimeout = null;
                        ele.unbind(eve);
                    }
                );
            }

            function initClickOnTrack() {
                removeClickOnTrack();
                if (isScrollableV) {
                    verticalTrack.bind(
                        'mousedown.jsp',
                        function (e) {
                            if (e.originalTarget === undefined || e.originalTarget == e.currentTarget) {
                                var clickedTrack = $(this),
                                    offset = clickedTrack.offset(),
                                    direction = e.pageY - offset.top - verticalDragPosition,
                                    scrollTimeout,
                                    isFirst = true,
                                    doScroll = function () {
                                        var offset = clickedTrack.offset(),
                                            pos = e.pageY - offset.top - verticalDragHeight / 2,
                                            contentDragY = paneHeight * settings.scrollPagePercent,
                                            dragY = dragMaxY * contentDragY / (contentHeight - paneHeight);
                                        if (direction < 0) {
                                            if (verticalDragPosition - dragY > pos) {
                                                jsp.scrollByY(-contentDragY);
                                            } else {
                                                positionDragY(pos);
                                            }
                                        } else if (direction > 0) {
                                            if (verticalDragPosition + dragY < pos) {
                                                jsp.scrollByY(contentDragY);
                                            } else {
                                                positionDragY(pos);
                                            }
                                        } else {
                                            cancelClick();
                                            return;
                                        }
                                        scrollTimeout = setTimeout(doScroll, isFirst ? settings.initialDelay : settings.trackClickRepeatFreq);
                                        isFirst = false;
                                    },
                                    cancelClick = function () {
                                        scrollTimeout && clearTimeout(scrollTimeout);
                                        scrollTimeout = null;
                                        $(document).unbind('mouseup.jsp', cancelClick);
                                    };
                                doScroll();
                                $(document).bind('mouseup.jsp', cancelClick);
                                return false;
                            }
                        }
                    );
                }

                if (isScrollableH) {
                    horizontalTrack.bind(
                        'mousedown.jsp',
                        function (e) {
                            if (e.originalTarget === undefined || e.originalTarget == e.currentTarget) {
                                var clickedTrack = $(this),
                                    offset = clickedTrack.offset(),
                                    direction = e.pageX - offset.left - horizontalDragPosition,
                                    scrollTimeout,
                                    isFirst = true,
                                    doScroll = function () {
                                        var offset = clickedTrack.offset(),
                                            pos = e.pageX - offset.left - horizontalDragWidth / 2,
                                            contentDragX = paneWidth * settings.scrollPagePercent,
                                            dragX = dragMaxX * contentDragX / (contentWidth - paneWidth);
                                        if (direction < 0) {
                                            if (horizontalDragPosition - dragX > pos) {
                                                jsp.scrollByX(-contentDragX);
                                            } else {
                                                positionDragX(pos);
                                            }
                                        } else if (direction > 0) {
                                            if (horizontalDragPosition + dragX < pos) {
                                                jsp.scrollByX(contentDragX);
                                            } else {
                                                positionDragX(pos);
                                            }
                                        } else {
                                            cancelClick();
                                            return;
                                        }
                                        scrollTimeout = setTimeout(doScroll, isFirst ? settings.initialDelay : settings.trackClickRepeatFreq);
                                        isFirst = false;
                                    },
                                    cancelClick = function () {
                                        scrollTimeout && clearTimeout(scrollTimeout);
                                        scrollTimeout = null;
                                        $(document).unbind('mouseup.jsp', cancelClick);
                                    };
                                doScroll();
                                $(document).bind('mouseup.jsp', cancelClick);
                                return false;
                            }
                        }
                    );
                }
            }

            function removeClickOnTrack() {
                if (horizontalTrack) {
                    horizontalTrack.unbind('mousedown.jsp');
                }
                if (verticalTrack) {
                    verticalTrack.unbind('mousedown.jsp');
                }
            }

            function cancelDrag() {
                $('html').unbind('dragstart.jsp selectstart.jsp mousemove.jsp mouseup.jsp mouseleave.jsp');

                if (verticalDrag) {
                    verticalDrag.removeClass('jspActive');
                }
                if (horizontalDrag) {
                    horizontalDrag.removeClass('jspActive');
                }
            }

            function positionDragY(destY, animate) {
                if (!isScrollableV) {
                    return;
                }
                if (destY < 0) {
                    destY = 0;
                } else if (destY > dragMaxY) {
                    destY = dragMaxY;
                }

                // can't just check if(animate) because false is a valid value that could be passed in...
                if (animate === undefined) {
                    animate = settings.animateScroll;
                }
                if (animate) {
                    jsp.animate(verticalDrag, 'top', destY, _positionDragY);
                } else {
                    verticalDrag.css('top', destY);
                    _positionDragY(destY);
                }

            }

            function _positionDragY(destY) {
                if (destY === undefined) {
                    destY = verticalDrag.position().top;
                }

                container.scrollTop(0);
                verticalDragPosition = destY || 0;

                var isAtTop = verticalDragPosition === 0,
                    isAtBottom = verticalDragPosition == dragMaxY,
                    percentScrolled = destY / dragMaxY,
                    destTop = -percentScrolled * (contentHeight - paneHeight);

                if (wasAtTop != isAtTop || wasAtBottom != isAtBottom) {
                    wasAtTop = isAtTop;
                    wasAtBottom = isAtBottom;
                    elem.trigger('jsp-arrow-change', [wasAtTop, wasAtBottom, wasAtLeft, wasAtRight]);
                }

                updateVerticalArrows(isAtTop, isAtBottom);
                pane.css('top', destTop);
                elem.trigger('jsp-scroll-y', [-destTop, isAtTop, isAtBottom]).trigger('scroll');
            }

            function positionDragX(destX, animate) {
                if (!isScrollableH) {
                    return;
                }
                if (destX < 0) {
                    destX = 0;
                } else if (destX > dragMaxX) {
                    destX = dragMaxX;
                }

                if (animate === undefined) {
                    animate = settings.animateScroll;
                }
                if (animate) {
                    jsp.animate(horizontalDrag, 'left', destX, _positionDragX);
                } else {
                    horizontalDrag.css('left', destX);
                    _positionDragX(destX);
                }
            }

            function _positionDragX(destX) {
                if (destX === undefined) {
                    destX = horizontalDrag.position().left;
                }

                container.scrollTop(0);
                horizontalDragPosition = destX || 0;

                var isAtLeft = horizontalDragPosition === 0,
                    isAtRight = horizontalDragPosition == dragMaxX,
                    percentScrolled = destX / dragMaxX,
                    destLeft = -percentScrolled * (contentWidth - paneWidth);

                if (wasAtLeft != isAtLeft || wasAtRight != isAtRight) {
                    wasAtLeft = isAtLeft;
                    wasAtRight = isAtRight;
                    elem.trigger('jsp-arrow-change', [wasAtTop, wasAtBottom, wasAtLeft, wasAtRight]);
                }

                updateHorizontalArrows(isAtLeft, isAtRight);
                pane.css('left', destLeft);
                elem.trigger('jsp-scroll-x', [-destLeft, isAtLeft, isAtRight]).trigger('scroll');
            }

            function updateVerticalArrows(isAtTop, isAtBottom) {
                if (settings.showArrows) {
                    arrowUp[isAtTop ? 'addClass' : 'removeClass']('jspDisabled');
                    arrowDown[isAtBottom ? 'addClass' : 'removeClass']('jspDisabled');
                }
            }

            function updateHorizontalArrows(isAtLeft, isAtRight) {
                if (settings.showArrows) {
                    arrowLeft[isAtLeft ? 'addClass' : 'removeClass']('jspDisabled');
                    arrowRight[isAtRight ? 'addClass' : 'removeClass']('jspDisabled');
                }
            }

            function scrollToY(destY, animate) {
                var percentScrolled = destY / (contentHeight - paneHeight);
                positionDragY(percentScrolled * dragMaxY, animate);
            }

            function scrollToX(destX, animate) {
                var percentScrolled = destX / (contentWidth - paneWidth);
                positionDragX(percentScrolled * dragMaxX, animate);
            }

            function scrollToElement(ele, stickToTop, animate) {
                var e, eleHeight, eleWidth, eleTop = 0,
                    eleLeft = 0,
                    viewportTop, viewportLeft, maxVisibleEleTop, maxVisibleEleLeft, destY, destX;

                // Legal hash values aren't necessarily legal jQuery selectors so we need to catch any
                // errors from the lookup...
                try {
                    e = $(ele);
                } catch (err) {
                    return;
                }
                eleHeight = e.outerHeight();
                eleWidth = e.outerWidth();

                container.scrollTop(0);
                container.scrollLeft(0);

                // loop through parents adding the offset top of any elements that are relatively positioned between
                // the focused element and the jspPane so we can get the true distance from the top
                // of the focused element to the top of the scrollpane...
                while (!e.is('.jspPane')) {
                    eleTop += e.position().top;
                    eleLeft += e.position().left;
                    e = e.offsetParent();
                    if (/^body|html$/i.test(e[0].nodeName)) {
                        // we ended up too high in the document structure. Quit!
                        return;
                    }
                }

                viewportTop = contentPositionY();
                maxVisibleEleTop = viewportTop + paneHeight;
                if (eleTop < viewportTop || stickToTop) { // element is above viewport
                    destY = eleTop - settings.horizontalGutter;
                } else if (eleTop + eleHeight > maxVisibleEleTop) { // element is below viewport
                    destY = eleTop - paneHeight + eleHeight + settings.horizontalGutter;
                }
                if (!isNaN(destY)) {
                    scrollToY(destY, animate);
                }

                viewportLeft = contentPositionX();
                maxVisibleEleLeft = viewportLeft + paneWidth;
                if (eleLeft < viewportLeft || stickToTop) { // element is to the left of viewport
                    destX = eleLeft - settings.horizontalGutter;
                } else if (eleLeft + eleWidth > maxVisibleEleLeft) { // element is to the right viewport
                    destX = eleLeft - paneWidth + eleWidth + settings.horizontalGutter;
                }
                if (!isNaN(destX)) {
                    scrollToX(destX, animate);
                }

            }

            function contentPositionX() {
                return -pane.position().left;
            }

            function contentPositionY() {
                return -pane.position().top;
            }

            function isCloseToBottom() {
                var scrollableHeight = contentHeight - paneHeight;
                return (scrollableHeight > 20) && (scrollableHeight - contentPositionY() < 10);
            }

            function isCloseToRight() {
                var scrollableWidth = contentWidth - paneWidth;
                return (scrollableWidth > 20) && (scrollableWidth - contentPositionX() < 10);
            }

            function initMousewheel() {
                container.unbind(mwEvent).bind(
                    mwEvent,
                    function (event, delta, deltaX, deltaY) {

                        if (!horizontalDragPosition) horizontalDragPosition = 0;
                        if (!verticalDragPosition) verticalDragPosition = 0;

                        var dX = horizontalDragPosition,
                            dY = verticalDragPosition,
                            factor = event.deltaFactor || settings.mouseWheelSpeed;
                        jsp.scrollBy(deltaX * factor, -deltaY * factor, false);
                        // return true if there was no movement so rest of screen can scroll
                        return dX == horizontalDragPosition && dY == verticalDragPosition;
                    }
                );
            }

            function removeMousewheel() {
                container.unbind(mwEvent);
            }

            function nil() {
                return false;
            }

            function initFocusHandler() {
                pane.find(':input,a').unbind('focus.jsp').bind(
                    'focus.jsp',
                    function (e) {
                        scrollToElement(e.target, false);
                    }
                );
            }

            function removeFocusHandler() {
                pane.find(':input,a').unbind('focus.jsp');
            }

            function initKeyboardNav() {
                var keyDown, elementHasScrolled, validParents = [];
                isScrollableH && validParents.push(horizontalBar[0]);
                isScrollableV && validParents.push(verticalBar[0]);

                // IE also focuses elements that don't have tabindex set.
                pane.focus(
                    function () {
                        elem.focus();
                    }
                );

                elem.attr('tabindex', 0)
                    .unbind('keydown.jsp keypress.jsp')
                    .bind(
                        'keydown.jsp',
                        function (e) {
                            if (e.target !== this && !(validParents.length && $(e.target).closest(validParents).length)) {
                                return;
                            }
                            var dX = horizontalDragPosition,
                                dY = verticalDragPosition;
                            switch (e.keyCode) {
                                case 40: // down
                                case 38: // up
                                case 34: // page down
                                case 32: // space
                                case 33: // page up
                                case 39: // right
                                case 37: // left
                                    keyDown = e.keyCode;
                                    keyDownHandler();
                                    break;
                                case 35: // end
                                    scrollToY(contentHeight - paneHeight);
                                    keyDown = null;
                                    break;
                                case 36: // home
                                    scrollToY(0);
                                    keyDown = null;
                                    break;
                            }

                            elementHasScrolled = e.keyCode == keyDown && dX != horizontalDragPosition || dY != verticalDragPosition;
                            return !elementHasScrolled;
                        }
                    ).bind(
                        'keypress.jsp', // For FF/ OSX so that we can cancel the repeat key presses if the JSP scrolls...
                        function (e) {
                            if (e.keyCode == keyDown) {
                                keyDownHandler();
                            }
                            return !elementHasScrolled;
                        }
                    );

                if (settings.hideFocus) {
                    elem.css('outline', 'none');
                    if ('hideFocus' in container[0]) {
                        elem.attr('hideFocus', true);
                    }
                } else {
                    elem.css('outline', '');
                    if ('hideFocus' in container[0]) {
                        elem.attr('hideFocus', false);
                    }
                }

                function keyDownHandler() {
                    var dX = horizontalDragPosition,
                        dY = verticalDragPosition;
                    switch (keyDown) {
                        case 40: // down
                            jsp.scrollByY(settings.keyboardSpeed, false);
                            break;
                        case 38: // up
                            jsp.scrollByY(-settings.keyboardSpeed, false);
                            break;
                        case 34: // page down
                        case 32: // space
                            jsp.scrollByY(paneHeight * settings.scrollPagePercent, false);
                            break;
                        case 33: // page up
                            jsp.scrollByY(-paneHeight * settings.scrollPagePercent, false);
                            break;
                        case 39: // right
                            jsp.scrollByX(settings.keyboardSpeed, false);
                            break;
                        case 37: // left
                            jsp.scrollByX(-settings.keyboardSpeed, false);
                            break;
                    }

                    elementHasScrolled = dX != horizontalDragPosition || dY != verticalDragPosition;
                    return elementHasScrolled;
                }
            }

            function removeKeyboardNav() {
                elem.attr('tabindex', '-1')
                    .removeAttr('tabindex')
                    .unbind('keydown.jsp keypress.jsp');
            }

            function observeHash() {
                if (location.hash && location.hash.length > 1) {
                    var e,
                        retryInt,
                        hash = escape(location.hash.substr(1)) // hash must be escaped to prevent XSS
                    ;
                    try {
                        e = $('#' + hash + ', a[name="' + hash + '"]');
                    } catch (err) {
                        return;
                    }

                    if (e.length && pane.find(hash)) {
                        // nasty workaround but it appears to take a little while before the hash has done its thing
                        // to the rendered page so we just wait until the container's scrollTop has been messed up.
                        if (container.scrollTop() === 0) {
                            retryInt = setInterval(
                                function () {
                                    if (container.scrollTop() > 0) {
                                        scrollToElement(e, true);
                                        $(document).scrollTop(container.position().top);
                                        clearInterval(retryInt);
                                    }
                                },
                                50
                            );
                        } else {
                            scrollToElement(e, true);
                            $(document).scrollTop(container.position().top);
                        }
                    }
                }
            }

            function hijackInternalLinks() {
                // only register the link handler once
                if ($(document.body).data('jspHijack')) {
                    return;
                }

                // remember that the handler was bound
                $(document.body).data('jspHijack', true);

                // use live handler to also capture newly created links
                $(document.body).delegate('a[href*=#]', 'click', function (event) {
                    // does the link point to the same page?
                    // this also takes care of cases with a <base>-Tag or Links not starting with the hash #
                    // e.g. <a href="index.html#test"> when the current url already is index.html
                    var href = this.href.substr(0, this.href.indexOf('#')),
                        locationHref = location.href,
                        hash,
                        element,
                        container,
                        jsp,
                        scrollTop,
                        elementTop;
                    if (location.href.indexOf('#') !== -1) {
                        locationHref = location.href.substr(0, location.href.indexOf('#'));
                    }
                    if (href !== locationHref) {
                        // the link points to another page
                        return;
                    }

                    // check if jScrollPane should handle this click event
                    hash = escape(this.href.substr(this.href.indexOf('#') + 1));

                    // find the element on the page
                    element;
                    try {
                        element = $('#' + hash + ', a[name="' + hash + '"]');
                    } catch (e) {
                        // hash is not a valid jQuery identifier
                        return;
                    }

                    if (!element.length) {
                        // this link does not point to an element on this page
                        return;
                    }

                    container = element.closest('.jspScrollable');
                    jsp = container.data('jsp');

                    // jsp might be another jsp instance than the one, that bound this event
                    // remember: this event is only bound once for all instances.
                    jsp.scrollToElement(element, true);

                    if (container[0].scrollIntoView) {
                        // also scroll to the top of the container (if it is not visible)
                        scrollTop = $(window).scrollTop();
                        elementTop = element.offset().top;
                        if (elementTop < scrollTop || elementTop > scrollTop + $(window).height()) {
                            container[0].scrollIntoView();
                        }
                    }

                    // jsp handled this event, prevent the browser default (scrolling :P)
                    event.preventDefault();
                });
            }

            // Init touch on iPad, iPhone, iPod, Android
            function initTouch() {
                var startX,
                    startY,
                    touchStartX,
                    touchStartY,
                    moved,
                    moving = false;

                container.unbind('touchstart.jsp touchmove.jsp touchend.jsp click.jsp-touchclick').bind(
                    'touchstart.jsp',
                    function (e) {
                        var touch = e.originalEvent.touches[0];
                        startX = contentPositionX();
                        startY = contentPositionY();
                        touchStartX = touch.pageX;
                        touchStartY = touch.pageY;
                        moved = false;
                        moving = true;
                    }
                ).bind(
                    'touchmove.jsp',
                    function (ev) {
                        if (!moving) {
                            return;
                        }

                        var touchPos = ev.originalEvent.touches[0],
                            dX = horizontalDragPosition,
                            dY = verticalDragPosition;

                        jsp.scrollTo(startX + touchStartX - touchPos.pageX, startY + touchStartY - touchPos.pageY);

                        moved = moved || Math.abs(touchStartX - touchPos.pageX) > 5 || Math.abs(touchStartY - touchPos.pageY) > 5;

                        // return true if there was no movement so rest of screen can scroll
                        return dX == horizontalDragPosition && dY == verticalDragPosition;
                    }
                ).bind(
                    'touchend.jsp',
                    function (e) {
                        moving = false;
                        /*if(moved) {
							return false;
						}*/
                    }
                ).bind(
                    'click.jsp-touchclick',
                    function (e) {
                        if (moved) {
                            moved = false;
                            return false;
                        }
                    }
                );
            }

            function destroy() {
                var currentY = contentPositionY(),
                    currentX = contentPositionX();
                elem.removeClass('jspScrollable').unbind('.jsp');
                elem.replaceWith(originalElement.append(pane.children()));
                originalElement.scrollTop(currentY);
                originalElement.scrollLeft(currentX);

                // clear reinitialize timer if active
                if (reinitialiseInterval) {
                    clearInterval(reinitialiseInterval);
                }
            }

            // Public API
            $.extend(
                jsp, {
                    // Reinitialises the scroll pane (if it's internal dimensions have changed since the last time it
                    // was initialised). The settings object which is passed in will override any settings from the
                    // previous time it was initialised - if you don't pass any settings then the ones from the previous
                    // initialisation will be used.
                    reinitialise: function (s) {
                        s = $.extend({}, settings, s);
                        initialise(s);
                    },
                    // Scrolls the specified element (a jQuery object, DOM node or jQuery selector string) into view so
                    // that it can be seen within the viewport. If stickToTop is true then the element will appear at
                    // the top of the viewport, if it is false then the viewport will scroll as little as possible to
                    // show the element. You can also specify if you want animation to occur. If you don't provide this
                    // argument then the animateScroll value from the settings object is used instead.
                    scrollToElement: function (ele, stickToTop, animate) {
                        scrollToElement(ele, stickToTop, animate);
                    },
                    // Scrolls the pane so that the specified co-ordinates within the content are at the top left
                    // of the viewport. animate is optional and if not passed then the value of animateScroll from
                    // the settings object this jScrollPane was initialised with is used.
                    scrollTo: function (destX, destY, animate) {
                        scrollToX(destX, animate);
                        scrollToY(destY, animate);
                    },
                    // Scrolls the pane so that the specified co-ordinate within the content is at the left of the
                    // viewport. animate is optional and if not passed then the value of animateScroll from the settings
                    // object this jScrollPane was initialised with is used.
                    scrollToX: function (destX, animate) {
                        scrollToX(destX, animate);
                    },
                    // Scrolls the pane so that the specified co-ordinate within the content is at the top of the
                    // viewport. animate is optional and if not passed then the value of animateScroll from the settings
                    // object this jScrollPane was initialised with is used.
                    scrollToY: function (destY, animate) {
                        scrollToY(destY, animate);
                    },
                    // Scrolls the pane to the specified percentage of its maximum horizontal scroll position. animate
                    // is optional and if not passed then the value of animateScroll from the settings object this
                    // jScrollPane was initialised with is used.
                    scrollToPercentX: function (destPercentX, animate) {
                        scrollToX(destPercentX * (contentWidth - paneWidth), animate);
                    },
                    // Scrolls the pane to the specified percentage of its maximum vertical scroll position. animate
                    // is optional and if not passed then the value of animateScroll from the settings object this
                    // jScrollPane was initialised with is used.
                    scrollToPercentY: function (destPercentY, animate) {
                        scrollToY(destPercentY * (contentHeight - paneHeight), animate);
                    },
                    // Scrolls the pane by the specified amount of pixels. animate is optional and if not passed then
                    // the value of animateScroll from the settings object this jScrollPane was initialised with is used.
                    scrollBy: function (deltaX, deltaY, animate) {
                        jsp.scrollByX(deltaX, animate);
                        jsp.scrollByY(deltaY, animate);
                    },
                    // Scrolls the pane by the specified amount of pixels. animate is optional and if not passed then
                    // the value of animateScroll from the settings object this jScrollPane was initialised with is used.
                    scrollByX: function (deltaX, animate) {
                        var destX = contentPositionX() + Math[deltaX < 0 ? 'floor' : 'ceil'](deltaX),
                            percentScrolled = destX / (contentWidth - paneWidth);
                        positionDragX(percentScrolled * dragMaxX, animate);
                    },
                    // Scrolls the pane by the specified amount of pixels. animate is optional and if not passed then
                    // the value of animateScroll from the settings object this jScrollPane was initialised with is used.
                    scrollByY: function (deltaY, animate) {
                        var destY = contentPositionY() + Math[deltaY < 0 ? 'floor' : 'ceil'](deltaY),
                            percentScrolled = destY / (contentHeight - paneHeight);
                        positionDragY(percentScrolled * dragMaxY, animate);
                    },
                    // Positions the horizontal drag at the specified x position (and updates the viewport to reflect
                    // this). animate is optional and if not passed then the value of animateScroll from the settings
                    // object this jScrollPane was initialised with is used.
                    positionDragX: function (x, animate) {
                        positionDragX(x, animate);
                    },
                    // Positions the vertical drag at the specified y position (and updates the viewport to reflect
                    // this). animate is optional and if not passed then the value of animateScroll from the settings
                    // object this jScrollPane was initialised with is used.
                    positionDragY: function (y, animate) {
                        positionDragY(y, animate);
                    },
                    // This method is called when jScrollPane is trying to animate to a new position. You can override
                    // it if you want to provide advanced animation functionality. It is passed the following arguments:
                    //  * ele          - the element whose position is being animated
                    //  * prop         - the property that is being animated
                    //  * value        - the value it's being animated to
                    //  * stepCallback - a function that you must execute each time you update the value of the property
                    // You can use the default implementation (below) as a starting point for your own implementation.
                    animate: function (ele, prop, value, stepCallback) {
                        var params = {};
                        params[prop] = value;
                        ele.animate(
                            params, {
                                'duration': settings.animateDuration,
                                'easing': settings.animateEase,
                                'queue': false,
                                'step': stepCallback
                            }
                        );
                    },
                    // Returns the current x position of the viewport with regards to the content pane.
                    getContentPositionX: function () {
                        return contentPositionX();
                    },
                    // Returns the current y position of the viewport with regards to the content pane.
                    getContentPositionY: function () {
                        return contentPositionY();
                    },
                    // Returns the width of the content within the scroll pane.
                    getContentWidth: function () {
                        return contentWidth;
                    },
                    // Returns the height of the content within the scroll pane.
                    getContentHeight: function () {
                        return contentHeight;
                    },
                    // Returns the horizontal position of the viewport within the pane content.
                    getPercentScrolledX: function () {
                        return contentPositionX() / (contentWidth - paneWidth);
                    },
                    // Returns the vertical position of the viewport within the pane content.
                    getPercentScrolledY: function () {
                        return contentPositionY() / (contentHeight - paneHeight);
                    },
                    // Returns whether or not this scrollpane has a horizontal scrollbar.
                    getIsScrollableH: function () {
                        return isScrollableH;
                    },
                    // Returns whether or not this scrollpane has a vertical scrollbar.
                    getIsScrollableV: function () {
                        return isScrollableV;
                    },
                    // Gets a reference to the content pane. It is important that you use this method if you want to
                    // edit the content of your jScrollPane as if you access the element directly then you may have some
                    // problems (as your original element has had additional elements for the scrollbars etc added into
                    // it).
                    getContentPane: function () {
                        return pane;
                    },
                    // Scrolls this jScrollPane down as far as it can currently scroll. If animate isn't passed then the
                    // animateScroll value from settings is used instead.
                    scrollToBottom: function (animate) {
                        positionDragY(dragMaxY, animate);
                    },
                    // Hijacks the links on the page which link to content inside the scrollpane. If you have changed
                    // the content of your page (e.g. via AJAX) and want to make sure any new anchor links to the
                    // contents of your scroll pane will work then call this function.
                    hijackInternalLinks: $.noop,
                    // Removes the jScrollPane and returns the page to the state it was in before jScrollPane was
                    // initialised.
                    destroy: function () {
                        destroy();
                    }
                }
            );

            initialise(s);
        }

        // Pluginifying code...
        settings = $.extend({}, $.fn.jScrollPane.defaults, settings);

        // Apply default speed
        $.each(['arrowButtonSpeed', 'trackClickSpeed', 'keyboardSpeed'], function () {
            settings[this] = settings[this] || settings.speed;
        });

        return this.each(
            function () {
                var elem = $(this),
                    jspApi = elem.data('jsp');
                if (jspApi) {
                    jspApi.reinitialise(settings);
                } else {
                    $("script", elem).filter('[type="text/javascript"],:not([type])').remove();
                    jspApi = new JScrollPane(elem, settings);
                    elem.data('jsp', jspApi);
                }
            }
        );
    };

    $.fn.jScrollPane.defaults = {
        showArrows: false,
        maintainPosition: true,
        stickToBottom: false,
        stickToRight: false,
        clickOnTrack: true,
        autoReinitialise: false,
        autoReinitialiseDelay: 500,
        verticalDragMinHeight: 0,
        verticalDragMaxHeight: 99999,
        horizontalDragMinWidth: 0,
        horizontalDragMaxWidth: 99999,
        contentWidth: undefined,
        animateScroll: false,
        animateDuration: 300,
        animateEase: 'linear',
        hijackInternalLinks: false,
        verticalGutter: 4,
        horizontalGutter: 4,
        mouseWheelSpeed: 3,
        arrowButtonSpeed: 0,
        arrowRepeatFreq: 50,
        arrowScrollOnHover: false,
        trackClickSpeed: 0,
        trackClickRepeatFreq: 70,
        verticalArrowPositions: 'split',
        horizontalArrowPositions: 'split',
        enableKeyboardNavigation: true,
        hideFocus: false,
        keyboardSpeed: 0,
        initialDelay: 300, // Delay before starting repeating
        speed: 30, // Default speed when others falsey
        scrollPagePercent: .8 // Percent of visible area scrolled when pageUp/Down or track area pressed
    };

}, this);
/*jslint plusplus: true */
/*globals window,document,console,define,require, $ */
define('modules/tabview/common', ['modules/jscrollpane/common'], function () {
    'use strict';

    /**
     * cfg properties:
     * tabButtonsContainer: selector for the tab buttons container element
     * tabContent: selector for the tabview content pane
     * buttonsSelector - optional: selector for the tab buttons from the context of their container
     * callbacks - optional: associative array of button callback functions where the key is the button id, e.g { 'buttonIdOne': function () {...}, 'buttonIdFour': function () {...},...}
     * closeButtonCallback - optional: custom behaviour for close button in the content pane of the tabview
     */
    function TabView(cfg) {
        var self = this,
            callbacks,
            cb,
            scrollbarConfig = cfg.scrollbar !== undefined ? cfg.scrollbar : {},
            closeBtnClass = cfg.closeButton !== undefined ? cfg.closeButton : 'tab-content-close-btn, .tab-content-close-label';

        this.$tabButtonsContainer = $(cfg.tabButtonsContainer);
        this.$tabContent = $(cfg.tabContent);
        this.$currentContent = null;
        this.$currentContentContainer = null;
        this.buttonsSelector = cfg.buttonsSelector !== undefined ? cfg.buttonsSelector : 'button';
        callbacks = this.callbacks = cfg.callbacks;

        for (cb in callbacks) {
            if (callbacks[cb] !== undefined) {
                this.$tabButtonsContainer.find('#' + cb).on('click', {
                    ctx: this
                }, callbacks[cb]);
            }
        }

        this.$tabButtonsContainer.on('click', this.buttonsSelector, {
            ctx: this
        }, this.tabButtonClicked);
        if (cfg.closeButtonCallback !== undefined) {
            this.$tabContent.find('.' + closeBtnClass).on('click', {
                ctx: this
            }, cfg.closeButtonCallback);
        } else {
            this.$tabContent.find('.' + closeBtnClass).on('click', {
                ctx: this
            }, function (e) {
                e.data.ctx.hideContent();
            });
        }
        this.$tabContent.find('.tab-content').on('transitionend', function () {
            if (!self.$tabContent.find('.tab-content').hasClass('tab-content-visible')) {
                self.$tabContent.addClass('tab-content-hidden');
            }
        });

        this.$tabContent.removeClass('tab-content-hidden');
        $('.scroll-pane').jScrollPane(scrollbarConfig);
        this.scrollbarApi = $('.scroll-pane').data('jsp');
        this.$tabContent.addClass('tab-content-hidden');
    }

    TabView.prototype = {
        constructor: TabView,

        showContent: function () {
            var self = this;
            this.$tabContent.removeClass('tab-content-hidden');
            setTimeout(function () {
                self.$tabContent.find('.tab-content').addClass('tab-content-visible');
                self.scrollbarApi.reinitialise({
                    maintainPosition: true,
                    speed: self.$tabContent.find('.tab-content-body').height()
                });
            }, 10);
        },

        hideContent: function () {
            this.$tabContent.find('.tab-content').removeClass('tab-content-visible');
        },

        buttonSwitch: function ($btn) {
            this.$tabButtonsContainer.find(this.buttonsSelector).removeClass('tab-btn-active');
            $btn.addClass('tab-btn-active');
        },

        returnContent: function () {
            if (this.$currentContent !== null) {
                this.$currentContent.detach();
                this.$currentContentContainer.append(this.$currentContent);
            } else {
                this.$tabContent.find('.tab-content-body').html('');
            }
            this.$currentContent = null;
        },

        updateHeading: function ($btn) {
            var heading = $btn.text().trim();
            heading = heading.substring(0, heading.length - 1);
            this.$tabContent.find('.tab-content-head h2').text(heading);
        },

        tabButtonClicked: function (e) {
            var $button = $(this),
                url = $button.data('url'),
                buttonId = $button.attr('id'),
                tabName,
                self = e.data.ctx;

            self.$tabButtonsContainer.trigger({
                type: 'tabButtonClicked',
                $buttonClicked: $button
            });

            if ($button.hasClass('tab-btn-active')) {
                return;
            }

            self.buttonSwitch($button);
            if (buttonId !== 'tab-close-btn') {
                self.updateHeading($button);
            }

            if (self.callbacks[buttonId] !== undefined) {
                return;
            }

            if (url) {
                //Ajax call to get data
                self.returnContent();
                self.$tabContent.find('.tab-content-body').html('<h2>' + $button.text() + '</h2>');
                self.showContent();
            } else {
                //If no data url present use id naming convention to fetch hidden html content in the document and insert into tabView

                self.returnContent();

                tabName = buttonId.replace('tab-', '');
                self.$currentContent = $('.' + tabName);
                self.$currentContentContainer = self.$currentContent.parent();
                self.$currentContent.detach();
                self.$tabContent.find('.tab-content-body').append(self.$currentContent);

                self.showContent();
            }
        }
    };

    return TabView;
});
define('modules/ellipsis/Ellipsis', ['domlib'], function ($) {
    'use strict';

    var Ellipsis = function (config) {
        this.$content = $(config.contentContainer);
        if (this.$content.length) {
            this.$contentInnerWrapper = this.fnWrapContent();
        }
        this.sButtonValueEllipsed = config.buttonValueEllipsed || 'READ MORE';
        this.sButtonValueNotEllipsed = config.buttonValueNotEllipsed || 'READ LESS';
        this.sButtonClasses = config.buttonClasses || '';
        this.sButtonMarkup = '<a herf="#" class="ellipsis-button ' + this.sButtonClasses + '">' + this.sButtonValueEllipsed + '</a>';
        this.$button = null;
        this.iEllipsisHeight = config.ellpsisHeight;
        this.bIsEllipsed = false;

        if (typeof config !== 'object') {
            throw new Error("The parameter passed to the Ellipsis class not an object.");
        }
        if (this.$content.length === 0) {
            throw new Error("The given selector is not present in the DOM.");
        }
        if (typeof this.iEllipsisHeight !== 'number') {
            throw new Error("The value given for the height at which the content should ellpsis is not a number.");
        }
    };

    Ellipsis.prototype.fnWrapContent = function () {
        if (!this.$content.find('.content-inner-wrapper').length) {
            this.$content.wrapInner('<div class="content-inner-wrapper"></div>');
        }
        return this.$content.find('.content-inner-wrapper');
    };

    Ellipsis.prototype.fnUnwrapContent = function () {
        this.$contentInnerWrapper.contents().unwrap();
    };

    Ellipsis.prototype.fnCompareContentHeightToEllipseHeight = function () {
        var iContentHeight = this.$contentInnerWrapper.height();
        if (iContentHeight > this.iEllipsisHeight) {
            return true;
        }
    };

    Ellipsis.prototype.fnInsertReadMoreButton = function () {
        this.$content.after(this.sButtonMarkup);
        this.$button = this.$content.next('.ellipsis-button');
    };

    Ellipsis.prototype.fnRemoveReadMoreButton = function () {
        this.$button.remove();
        this.$button = null;
    };

    Ellipsis.prototype.fnChangeReadMoreButtonText = function () {
        if (this.bIsEllipsed) {
            this.$button.text(this.sButtonValueNotEllipsed);
        } else {
            this.$button.text(this.sButtonValueEllipsed);
        }
    };

    Ellipsis.prototype.fnAddDotdotdot = function () {
        var self = this;
        this.$contentInnerWrapper.dotdotdot({
            height: self.iEllipsisHeight
        });
    };

    Ellipsis.prototype.fnRemoveDotdotdot = function () {
        this.$contentInnerWrapper.trigger('destroy');
    };

    Ellipsis.prototype.fnAddEllipsis = function () {
        this.fnAddDotdotdot();
        this.fnChangeReadMoreButtonText();
        this.bIsEllipsed = true;
    };

    Ellipsis.prototype.fnRemoveEllipsis = function () {
        this.fnRemoveDotdotdot();
        this.fnChangeReadMoreButtonText();
        this.bIsEllipsed = false;
    };

    Ellipsis.prototype.fnToggleAddRemoveEllipsis = function (e) {
        if (this.bIsEllipsed) {
            this.fnRemoveEllipsis();
        } else {
            this.fnAddEllipsis();
        }
        e.preventDefault();
    };

    Ellipsis.prototype.fnInitialiseEllipsis = function () {
        if (this.$contentInnerWrapper === null) {
            this.$contentInnerWrapper = this.fnWrapContent();
        }
        this.fnAddDotdotdot();
        this.fnInsertReadMoreButton();
        this.fnBindEvents();
        this.bIsEllipsed = true;
        this.fnSetObjDataAttribute();
    };

    Ellipsis.prototype.fnDestroyEllipsis = function () {
        this.fnRemoveDotdotdot();
        this.fnUnwrapContent();
        this.fnRemoveReadMoreButton();
        this.fnUnbindEvents();
        this.bIsEllipsed = false;
        this.fnUnsetObjDataAttribute();
    };

    Ellipsis.prototype.fnBindEvents = function () {
        var self = this;
        this.$content.on('click.fnToggleAddRemoveEllipsis', '.ellipsis-button', self.fnToggleAddRemoveEllipsis);
    };

    Ellipsis.prototype.fnUnbindEvents = function () {
        this.$content.off('click.fnToggleAddRemoveEllipsis');
    };

    Ellipsis.prototype.fnSetObjDataAttribute = function () {
        this.$content.data('Ellipsis', this);
    };

    Ellipsis.prototype.fnUnsetObjDataAttribute = function () {
        this.$content.data('Ellipsis', null);
    };

    Ellipsis.prototype.fnInit = function () {
        if (this.fnCompareContentHeightToEllipseHeight()) {
            this.fnInitialiseEllipsis();
        }
    };

    Ellipsis.prototype.fnRemovePreviousEllipsisObj = function () {
        if (this.$content.data('Ellipsis')) {
            this.fnUnsetObjDataAttribute();
        }
        if (this.$contentInnerWrapper.triggerHandler("isTruncated")) {
            this.fnRemoveDotdotdot();
        }
        if (this.$content.next('.ellipsis-button').length) {
            this.$button = this.$content.next('.ellipsis-button');
            this.fnRemoveReadMoreButton();
        }
        this.fnUnbindEvents();
        this.bIsEllipsed = false;
    };

    Ellipsis.prototype.fnReInit = function () {
        this.fnRemovePreviousEllipsisObj();
        if (this.fnCompareContentHeightToEllipseHeight()) {
            this.fnInitialiseEllipsis();
        }
    };

    return Ellipsis;
});
/*jslint plusplus: true */
/*globals window,document,console,define,require, $ */
define('modules/product-description/kiosk',['domlib', './common', 'modules/common', 'modules/overlay/common', 'modules/tabview/common', 'modules/tesco.analytics', 'modules/jargon-buster/common', 'modules/ellipsis/Ellipsis'], function ($, pdp, common, overlay, tabView, analytics, jargonBuster, Ellipsis) {

    pdp.oTabViewData = {};
    pdp.oTabViewData.iKioskAsyncTabs = 0;
    pdp.oTabViewData.bKioskAsyncTabsActive = false;
    pdp.oTabViewData.buttonStates = [];

    pdp.swatchesAndSizes.bindTooltipEvents = function () {
            var listItems = $("li.unavailable, li.not-in-stock");
            this.bindClickAndTouchEvents(listItems);
        },
        pdp.swatchesAndSizes.bindClickAndTouchEvents = function (listItems) {
            listItems.find("a").on("touchstart", function (e) {
                e.preventDefault();
                if (listItems.parents().find('.dropdown-enabled').length <= 0)
                    pdp.swatchesAndSizes.showTooltip($(this));
                return false;
            });
        },
        pdp.swatchesAndSizes.showTooltip = function (trigger) {
            if (pdp.isValidBreakpoint()) {
                var className = trigger.parent("li").attr("class");
                var finalClass;
                if (className.indexOf('unavailable') != -1) {
                    finalClass = 'unavailable';
                }
                if (className.indexOf('not-in-stock') != -1) {
                    finalClass = 'not-in-stock';
                }
                var html = "<p>" + pdp.tooltipMessages[finalClass] + "</p>";
                var settings = {
                    trigger: trigger,
                    html: html,
                    isInline: true,
                    fixedSize: false,
                    positionAboveTrigger: true
                };
                common.tooltip.show(settings);
            }
        },
        pdp.swatchesAndSizesRules.maximumAmount = 8;
    pdp.swatchesAndSizesRules.dropdownLimit = 13;

    pdp.showVirtualPage = function (e) {
        e.preventDefault();
        overlay.show({
            content: $('#product-spec-container .section-content').html(),
            customClass: 'product-description product-spec-section-content',
            fixedWidth: 1280,
            enablePagination: true,
            paginationHeader: '<h1>Product specifications</h1>'
        });
    };
    pdp.showDescriptionVirtualPage = function (e) {
            e.preventDefault();
            overlay.show({
                content: $('#product-details-container .section-content').html(),
                customClass: 'product-description product-details-section-content',
                fixedWidth: 1280,
                enablePagination: true,
                paginationHeader: '<h1>Product Details</h1>'
            });
        },

        pdp.preOrderPriceOverlay = function (e) {
            overlay.show({
                content: $('.pre-order-price-promise').html(),
                customClass: "scrolling-overlay price-promise-overlay",
                fixedWidth: 1280,
                enablePagination: true,
                paginationHeader: '<h1>Price promise</h1>'
            });
        };

    /* C2013 bazaar voice implementation for kiosk [EPIC #2033]*/
    pdp.bazaarVoiceOverlay = function (e) {
        var reviewsLoaded = $('.bv-cleanslate');
        var reviewsReady = false;

        //show customer reviews in overlay
        function showReviewsOverlay(e) {
            if (reviewsReady) {
                e.stopPropagation();
                e.preventDefault();
                var bvContent = $('#BVRRContainer').detach();

                //trigger overlay with review vars configured
                overlay.show({
                    content: bvContent,
                    customClass: "scrolling-overlay customer-review-overlay",
                    fixedWidth: 1586,
                    enablePagination: true,
                    preserveContent: true,
                    paginationHeader: '<h1>Customer reviews</h1>'
                });

                bvContent // tidy element
                    .removeClass('kiosk')
                    .removeAttr('style')
                    .addClass('kiosk');
            }
        }

        //validate if the bazaar voice external content has loaded
        function setReviewsReady() {
            var initBvTimer = setInterval(function () {
                bvCheck()
            }, 600);

            //reset timer
            function stopbvCheck() {
                clearInterval(initBvTimer);
            }

            //check logic
            function bvCheck() {
                var reviewsLoaded = $('.bv-rating-ratio');
                var customerReviewsBtn = '<section class="customer-review-link" style="display: block;"><a href="#" class="slide-in-trigger" data-show="customer-reviews"><h3>Customer reviews</h3></a></section>';

                if (reviewsLoaded.length) {
                    var starRating = $('#BVRRSummaryContainer .bv-rating-ratio-count');
                    reviewsReady = true;
                    stopbvCheck();

                    //remove star rating if there are no reviews
                    if (!starRating.length > 0) {
                        $('#BVRRSummaryContainer .bv-rating-ratio').remove();
                    } else {
                        $('.product-spec-container').append(customerReviewsBtn);
                        $('.customer-review-link, #BVRRSummaryContainer').on(pdp.clickEvent, showReviewsOverlay);
                    }
                }
            }
        }

        //check if the bazaar voice reviews have loaded
        setReviewsReady();
    };

    /* legacy bazaar voice implementation for kiosk */
    pdp.customerReviewOverlay = function (e) {
        var bvContent = $('.customer-review').clone();
        var paginationContent = bvContent.find('.BVPaginationContainer');

        if (paginationContent.find('span.BVRRPageLink').length) {
            paginationContent.find('span.BVRRPageLink a').each(function () {
                $(this).click(function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    $('#BVIFrame').attr("src", $(this).attr("href"));
                });
            });
        }

        $('#BVReviewsContainer').on('DOMNodeInserted', function () {
            $('#pagination-nav').remove();
            overlay.bindScrollEvents($('#lightbox'), true);
            $('.pagination-up').trigger('click');
        });

        overlay.show({
            content: bvContent,
            customClass: "scrolling-overlay customer-review-overlay",
            fixedWidth: 1586,
            enablePagination: true,
            paginationHeader: '<h1>Customer reviews</h1>'
        });
    };

    pdp.checkCustomerReviewsStatus = function () {
        var checkTimer,
            customerReviewsReady = false,
            resetTimer,
            checkStatus;

        resetTimer = function resetTimer() {
            clearInterval(checkTimer);
        };

        checkStatus = function checkStatus() {
            if ($('.bv-rating-ratio').length) {
                resetTimer();
                pdp.resetCustomerReviewsUI();
                pdp.hideEmptyCustomerReviews();
                pdp.customerReviewsSummaryEventBinds();
                customerReviewsReady = true;
                return customerReviewsReady;
            }
        };

        checkTimer = setInterval(function () {
            checkStatus();
        }, 450);
    };

    pdp.resetCustomerReviewsUI = function () {
        $('#BVRRSummaryContainer .bv-rating-ratio').removeAttr('style');
    };

    pdp.customerReviewsSummaryEventBinds = function () {
        $('#BVRRSummaryContainer, #BVRRSummaryContainer a.bv-rating-stars-container').unbind('click').on('click', function (e) {
            e.preventDefault();
            e.stopImmediatePropagation();
            if (pdp.isTabViewEnabled()) {
                $('#tab-product-reviews').trigger('click');
            } else {
                var bvContent = $('#BVRRContainer').detach();

                overlay.show({
                    content: bvContent,
                    customClass: "scrolling-overlay customer-review-overlay",
                    fixedWidth: 1586,
                    enablePagination: true,
                    preserveContent: true,
                    paginationHeader: '<h1>Customer reviews</h1>'
                });
                bvContent.removeClass('kiosk hideBVReviews').removeAttr('style').addClass('kiosk');
            }
        });
    };

    pdp.removeCustomerReviewsMarkupInTabs = function () {
        $('.tab-content-body #BVRRContainer, .tab-content-head #BVRRSummaryContainer').remove();
    };

    pdp.hideEmptyCustomerReviews = function () {
        if (pdp.isTabViewEnabled()) {
            pdp.oTabViewData.iKioskAsyncTabs--;
        }
        if ($('#BVRRSummaryContainer .bv-rating-ratio-count').length === 0) {
            $('.rating-container').hide();
            pdp.removeTabFromArray('#tab-product-reviews');
            pdp.updateTabViewDOMElements();
        }
        pdp.updateTabViewDOMElements();
    };

    pdp.addQuantityButtons = function () {
        var sQuantityIncreaseButton = '<a href="#" class="increase tertiary-button">+</a>',
            sQuantityDecreaseButton = '<a href="#" class="decrease tertiary-button">-</a>',
            sQuantityContainers = '#range .collectionQuantity';

        if ($(sQuantityContainers + ' a.increase').length === 0 && $(sQuantityContainers + ' a.decrease').length === 0) {
            $(sQuantityContainers).each(function () {
                $(this).prepend(sQuantityDecreaseButton).append(sQuantityIncreaseButton);
            });
        }
    };

    pdp.showTabViewDOMElements = function () {
        var $tabContainer = $('.tab-view .tab-buttons');
        $tabContainer.removeAttr('style');
    };

    pdp.setAsyncTabViewState = function (iNumberOfAsyncLoadedBlocks) {
        pdp.oTabViewData.bKioskAsyncTabsActive = iNumberOfAsyncLoadedBlocks !== undefined && iNumberOfAsyncLoadedBlocks > 0 ? true : false;
    };

    pdp.removeTabFromArray = function (sSelector) {
        for (var i = 0; i < pdp.oTabViewData.buttonStates.length; i++) {
            if (pdp.oTabViewData.buttonStates[i].selector === sSelector) {
                pdp.oTabViewData.buttonStates.splice(i, 1);
                break;
            }
        }
        $(sSelector).removeAttr('style');
    };

    pdp.updateTabViewDOMElements = function () {
        if (pdp.isTabViewEnabled()) {
            if (!pdp.oTabViewData.bKioskAsyncTabsActive) {
                pdp.setTabViewParentClass(pdp.calculateTabViewButtonCount());
                pdp.showTabViewDOMElements();
            } else {
                if (pdp.oTabViewData.iKioskAsyncTabs === 0) {
                    pdp.setTabViewParentClass(pdp.calculateTabViewButtonCount());
                    pdp.showTabViewDOMElements();
                }
            }
        }
    };

    pdp.setTabViewParentClass = function (iNumberOfTabs) {
        var $tabContainer = $('.tab-view .tab-buttons'),
            sNewTabCount;

        if (iNumberOfTabs === 2) {
            sNewTabCount = 'two';
        } else if (iNumberOfTabs === 3) {
            sNewTabCount = 'three';
        } else if (iNumberOfTabs === 4) {
            sNewTabCount = 'four';
        } else if (iNumberOfTabs === 5) {
            sNewTabCount = 'five';
        } else if (iNumberOfTabs === 6) {
            sNewTabCount = 'six';
        } else if (iNumberOfTabs > 6) {
            sNewTabCount = 'six-plus';
        }
        $tabContainer.removeClass().addClass(sNewTabCount + '-tabs tab-buttons');
    };

    pdp.setAvailableTabViewButtons = function () {
        var $overviewTab = $('#tab-close-btn'),
            $productDetailsTab = $('#tab-product-details'),
            $productSpecificationTab = $('#tab-product-specifications'),
            $productSynopsisTab = $('#tab-product-synopsis'),
            $customerReviewsTab = $('#tab-product-reviews'),
            $authorBiographyTab = $('#tab-product-biography'),
            $shopTheRangeTab = $('#tab-shop-the-range'),
            $bundleAndSaveTab = $('#tab-linksave');

        if ($('#wrapper.product').length) {
            pdp.oTabViewData.buttonStates.push($overviewTab);
            $overviewTab.css('display', 'inline-block');
        }

        if ($('#wrapper #product-details-section-content').length) {
            pdp.oTabViewData.buttonStates.push($productDetailsTab);
            $productDetailsTab.css('display', 'inline-block');
        }
        if ($('#wrapper #product-spec-container').length) {
            pdp.oTabViewData.buttonStates.push($productSpecificationTab)
            $productSpecificationTab.css('display', 'inline-block');
        }
        if ($('#wrapper.product #product-details.synopsis').length) {
            pdp.oTabViewData.buttonStates.push($productSynopsisTab);
            $productSynopsisTab.css('display', 'inline-block');
        }
        if ($('#wrapper.product #reviews.customer-review #BVRRContainer').length) {
            pdp.oTabViewData.buttonStates.push($customerReviewsTab);
            $customerReviewsTab.css('display', 'inline-block');
            pdp.oTabViewData.iKioskAsyncTabs++;
        }
        if ($('#wrapper.product #product-details.biography').length) {
            pdp.oTabViewData.buttonStates.push($authorBiographyTab);
            $authorBiographyTab.css('display', 'inline-block');
        }
        if ($('#wrapper.product .collectionContainer.range').length) {
            pdp.oTabViewData.buttonStates.push($shopTheRangeTab);
            $shopTheRangeTab.css('display', 'inline-block');
        }
        if ($('#wrapper.product .collectionContainer.linksave').length) {
            pdp.oTabViewData.buttonStates.push($bundleAndSaveTab);
            $bundleAndSaveTab.css('display', 'inline-block');
        }
    };

    pdp.calculateTabViewButtonCount = function () {
        var iActiveTabCount = 0;
        for (var i = 0; i < pdp.oTabViewData.buttonStates.length; i++) {
            if (pdp.oTabViewData.buttonStates[i]) {
                iActiveTabCount++;
            }
        }
        return iActiveTabCount;
    };

    pdp.resetTabViewButtons = function () {
        $('.tab-view .tab-buttons button').removeAttr('style');
    };

    pdp.initTabViewDOMElements = function () {
        pdp.resetTabViewButtons();
        pdp.setAvailableTabViewButtons();
        pdp.setAsyncTabViewState(pdp.oTabViewData.iKioskAsyncTabs);
    };

    pdp.showCustomerReviewsTab = function (pdpTabView) {
        var $starsContainer;

        $starsContainer = $('#BVRRSummaryContainer').clone(false, false);
        pdpTabView.returnContent();
        pdpTabView.$currentContent = $('#BVRRContainer');
        pdpTabView.$currentContentContainer = pdpTabView.$currentContent.parent();
        pdpTabView.$currentContent.detach();

        $starsContainer.insertAfter($('.tab-content-head h2'));
        $('.tab-content-head #BVRRSummaryContainer a').click(function (e) {
            e.preventDefault();
            e.stopImmediatePropagation();
        });
        pdpTabView.$tabContent.find('.tab-content-body').html(pdpTabView.$currentContent);
        pdpTabView.showContent();
    };

    pdp.blinkboxOverlay = function (e) {
        overlay.show({
            content: $('.blinkbox-banner .expanded').html(),
            customClass: "scrolling-overlay blinkbox-overlay",
            enablePagination: true,
            paginationHeader: '<h1>What is Blinkbox?</h1>'
        });
    };

    pdp.shiftInfoIfNoFeatures = function () {
        if (common.isPage('PDP')) {
                if (!$('.product-description ul.features li').length) {
                $('.product-description .format-release').css("margin-left", "42.5%");
            }
            if (($('.book ul.features li').length) && ($('.age-restriction').length)) {
                $('.product-description .format-release').css("margin-left", "42.5%").css("margin-top", "80px");
            }

            if ((!$('.product-description .format-release .format, .product-description .format-release .release, .product-description .format-release .age-restriction').length) && (!$('.product-description ul.features li').length)) {
                $('#main-content').addClass('kiosk-pdp-no-features');
            }
        }
    };

    pdp.kioskMetaData = function () {
        window.setTimeout(function () {
            var catNo = $("#main-content .cat-no");
            var sellerName = $(".header-wrapper h2 span");
            var productDesc = $(".product-description h1.page-title");
            var currentPrice = $(".current-price");
            var deliveryOptionsOld = $(".delivery ul li");
            var deliveryOptionsNew = $(".newDeliveryOptions ul li a");
            var allowPrint = "true";
            var currentPriceRaw,
                deliveryOptions,
                productDescRaw,
                productDescTmp,
                textRaw,
                textClean;

            if (catNo.length) {
                var catNo = catNo.first().clone().children().remove().end().text();
            }

            if (sellerName.length) {
                var sellerName = sellerName.text(); // test this on multiple sellers
            }

            if (productDesc.length) {
                var productDescRaw = productDesc.text();
                var productDescTmp = $.trim(productDescRaw);
                var productDesc = productDescTmp.replace(/"/g, "&quot;");
            }

            if (currentPrice.length) {
                var currentPriceRaw = currentPrice.first().text().replace(/\u00A3/g, '');
                var currentPrice = $.trim(currentPriceRaw);
            }

            if (deliveryOptionsNew.length) {
                var deliveryOptions = '';
                deliveryOptionsNew.each(function () {
                    var textRaw = $(this).text();
                    var textClean = $.trim(textRaw);
                    deliveryOptions += textClean + '|';
                });
            } else {
                var deliveryOptions = '';
                deliveryOptionsOld.each(function () {
                    var textRaw = $(this).text();
                    var textClean = $.trim(textRaw);
                    deliveryOptions += textClean + '|';
                });
            }

            function removeLastPipe(deliveryOptions) {
                if (deliveryOptions.substring(deliveryOptions.length - 1) === "|") {
                    deliveryOptions = deliveryOptions.substring(0, deliveryOptions.length - 1);
                }
                return deliveryOptions;
            }
            deliveryOptions = removeLastPipe(deliveryOptions);

            if (sellerName === 'Tesco') {
                $('head').append('<meta name="sellerName" content="' + sellerName + '" />')
                    .append('<meta name="productDesc" content="' + productDesc + '" />')
                    .append('<meta name="catNo" content="' + catNo + '" />')
                    .append('<meta name="price" content="' + currentPrice + '" />')
                    .append('<meta name="deliveryOptions" content="' + deliveryOptions + '" />')
                    .append('<meta name="allowPrint" content="' + allowPrint + '" />');
            } else {
                $('head').append('<meta name="sellerName" content="" />')
                    .append('<meta name="productDesc" content="" />')
                    .append('<meta name="catNo" content="" />')
                    .append('<meta name="price" content="" />')
                    .append('<meta name="deliveryOptions" content="" />')
                    .append('<meta name="allowPrint" content="false" />');
            }
        }, 1300);
    };



    // -------------------------------

    pdp.isTabViewEnabled = function () {
        var $tabViewMarkup = 'div.tab-view',
            bEnabled;

        if ($($tabViewMarkup).length > 0) {
            bEnabled = true;
        } else {
            if ($('#product-spec-container').length) {
                $('#product-spec-container').css('display', 'block');
            }
            if ($('.customer-review-link').length) {
                $('.customer-review-link').css('display', 'block');
            }
            bEnabled = false;
        }
        return bEnabled;
    };

    pdp.EllipsisOnKiosk = function () {
        var oEllipsisOnKiosk = new Ellipsis({
            contentContainer: '.description-container .description-section-content',
            buttonValueEllipsed: 'READ MORE',
            buttonValueNotEllipsed: 'READ LESS',
            buttonClasses: 'read-more-link btn-v2-link right-align',
            ellpsisHeight: 130
        });

        oEllipsisOnKiosk.fnAddEllipsis = function () {
            this.fnAddDotdotdot();
            this.fnInsertReadMoreButton();
            this.bIsEllipsed = true;
        };

        oEllipsisOnKiosk.fnRemoveEllipsis = function () {
            this.fnRemoveDotdotdot();
            this.fnRemoveReadMoreButton();
            this.bIsEllipsed = false;
        };

        oEllipsisOnKiosk.fnDisplayContentInTabOnClick = function (e) {
            var $DetailsOrSynopsis = $('#tab-product-details').length > 0 ? '#tab-product-details' : '#tab-product-synopsis';
            $($DetailsOrSynopsis).trigger('click');
            e.preventDefault();
        };

        oEllipsisOnKiosk.fnAddEllipsisOnClick = function (e) {
            if (!oEllipsisOnKiosk.bIsEllipsed) {
                oEllipsisOnKiosk.fnAddEllipsis();
            }
            e.preventDefault();
        };

        oEllipsisOnKiosk.fnBindEvents = function () {
            var self = this;
            $('#wrapper').on('click.fnDisplayContentInTabOnClick', '.ellipsis-button', self.fnDisplayContentInTabOnClick);
            $('#wrapper').on('click.fnAddEllipsisOnClick', '#tab-close-btn', self.fnAddEllipsisOnClick);
        };

        oEllipsisOnKiosk.fnUnbindEvents = function () {
            var self = this;
            $('#wrapper').off('click.fnDisplayContentInTabOnClick');
            $('#wrapper').off('click.fnAddEllipsisOnClick');
        };

        return oEllipsisOnKiosk;
    };

    common.init.push(function () {
        var bPDPV2 = $('body').hasClass('PDP-Version2') ? true : false;

        if (!bPDPV2) {
            pdp.clickEvent = 'touchstart click';
            //pdp.addAdditionalClass($('.product-carousel .thumbnails li'), 8, $('.main-details .product-carousel'), 'more-thumbnails');
            pdp.shiftInfoIfNoFeatures();
            pdp.kioskMetaData();
            pdp.init();

            try {
                var oEllipsisOnKiosk = pdp.EllipsisOnKiosk();
                oEllipsisOnKiosk.fnInit();
            } catch (e) {
                console.info('EllipsisOnKiosk:', e.message);
            }


            if (pdp.isTabViewEnabled()) {
                pdp.v = [{
                    'eVar59': '',
                    'events': 'event32'
                }];
                pdp.tabView = new tabView({
                    tabButtonsContainer: '.tab-buttons',
                    tabContent: '.tab-content-mask',
                    callbacks: {
                        'tab-close-btn': function (e) {
                            e.data.ctx.hideContent();
                            //Omniture
                            pdp.v[0].eVar59 = pdp.v[0].eVar59 == '' ? '' : pdp.v[0].eVar59 + ',';
                            var omniVal = pdp.v[0].eVar59 + 'PDP_Kiosk_overview_tab';
                            var _oWebAnalytics = new analytics.WebMetrics();
                            pdp.v = [{
                                'eVar59': omniVal,
                                'events': 'event32'
                            }];
                            _oWebAnalytics.submit(pdp.v);
                        },
                        'tab-product-details': function (e) {
                            var self = e.data.ctx;
                            self.returnContent();
                            // required to remove ellipsis so that entire content is cloned and not just ellipsed content
                            var $contentSelector = $('#product-details-container .section-content');
                            if ($contentSelector.data('Ellipsis')) {
                                var oEllipsis = $contentSelector.data('Ellipsis');
                                if (oEllipsis.bIsEllipsed) {
                                    oEllipsis.fnRemoveEllipsis();
                                }
                            }
                            self.$tabContent.find('.tab-content-body').html($('#product-details-container .section-content').clone());
                            self.showContent();
                            //Omniture
                            pdp.v[0].eVar59 = pdp.v[0].eVar59 == '' ? '' : pdp.v[0].eVar59 + ',';
                            var omniVal = pdp.v[0].eVar59 + 'PDP_Kiosk_productdetails_tab';
                            var _oWebAnalytics = new analytics.WebMetrics();
                            pdp.v = [{
                                'eVar59': omniVal,
                                'events': 'event32'
                            }];
                            _oWebAnalytics.submit(pdp.v);
                        },
                        'tab-product-synopsis': function (e) {
                            var self = e.data.ctx;
                            self.returnContent();
                            // required to remove ellipsis so that entire content is cloned and not just ellipsed content
                            var $contentSelector = $('#synopsis-container .section-content');
                            if ($contentSelector.data('Ellipsis')) {
                                var oEllipsis = $contentSelector.data('Ellipsis');
                                if (oEllipsis.bIsEllipsed) {
                                    oEllipsis.fnRemoveEllipsis();
                                }
                            }
                            self.$tabContent.find('.tab-content-body').html($('#synopsis-container .section-content').clone());
                            self.showContent();
                            //Omniture
                            pdp.v[0].eVar59 = pdp.v[0].eVar59 == '' ? '' : pdp.v[0].eVar59 + ',';
                            var omniVal = pdp.v[0].eVar59 + 'PDP_Kiosk_synopsis_tab';
                            var _oWebAnalytics = new analytics.WebMetrics();
                            pdp.v = [{
                                'eVar59': omniVal,
                                'events': 'event32'
                            }];
                            _oWebAnalytics.submit(pdp.v);
                        },
                        'tab-product-biography': function (e) {
                            var self = e.data.ctx;
                            self.returnContent();
                            self.$tabContent.find('.tab-content-body').html($('#biography-container .section-content').clone());
                            self.showContent();
                            //Omniture
                            pdp.v[0].eVar59 = pdp.v[0].eVar59 == '' ? '' : pdp.v[0].eVar59 + ',';
                            var omniVal = pdp.v[0].eVar59 + 'PDP_Kiosk_authorbiography_tab';
                            var _oWebAnalytics = new analytics.WebMetrics();
                            pdp.v = [{
                                'eVar59': omniVal,
                                'events': 'event32'
                            }];
                            _oWebAnalytics.submit(pdp.v);
                        },
                        'tab-product-specifications': function (e) {
                            var self = e.data.ctx;
                            self.returnContent();
                            self.$tabContent.find('.tab-content-body').html($('#product-spec-container .section-content').clone());
                            jargonBuster.init();
                            self.showContent();
                            pdp.removeCustomerReviewsMarkupInTabs();
                            //Omniture
                            pdp.v[0].eVar59 = pdp.v[0].eVar59 == '' ? '' : pdp.v[0].eVar59 + ',';
                            var omniVal = pdp.v[0].eVar59 + 'PDP_Kiosk_productspec_tab';
                            var _oWebAnalytics = new analytics.WebMetrics();
                            pdp.v = [{
                                'eVar59': omniVal,
                                'events': 'event32'
                            }];
                            _oWebAnalytics.submit(pdp.v);
                        },
                        'tab-product-reviews': function (e) {
                            var self = e.data.ctx;
                            if (!$('.tab-content-body #BVRRContainer').length) {
                                pdp.showCustomerReviewsTab(self);
                            }
                            self.$tabContent.on('mouseup', '.bv-content-btn-pages-load-more', function () {
                                self.scrollbarApi.reinitialise({
                                    maintainPosition: true
                                });
                            });
                            //Omniture
                            pdp.v[0].eVar59 = pdp.v[0].eVar59 == '' ? '' : pdp.v[0].eVar59 + ',';
                            var omniVal = pdp.v[0].eVar59 + 'PDP_Kiosk_customerreviews_tab';
                            var _oWebAnalytics = new analytics.WebMetrics();
                            pdp.v = [{
                                'eVar59': omniVal,
                                'events': 'event32'
                            }];
                            _oWebAnalytics.submit(pdp.v);
                        },
                        'tab-shop-the-range': function (e) {
                            var decreaseBtn = $('.collectionQuantity .decrease'),
                                inpElm = $('a.decrease').siblings('.quantity-display'),
                                currentVal = inpElm.val(),
                                maxVal = 99,
                                minVal = 1,
                                minLessThanMax = 98,
                                self = e.data.ctx,
                                checkLoop,
                                kioskProductQuantity = function kioskProductQuantity() {
                                    $(decreaseBtn).each(function () {
                                        checkLoop = $(this).siblings('.quantity-display').val();
                                        if (checkLoop === minVal) {
                                            $(this).addClass('disabled');
                                        }
                                        if (checkLoop > minVal) {
                                            $(this).removeClass('disabled');
                                        }
                                    });

                                    $('.collectionContainer.range').off('click', '.collectionQuantity a.tertiary-button');
                                    $('.collectionContainer.range').on('click', '.collectionQuantity a.tertiary-button', function (e) {
                                        e.preventDefault();

                                        if ($(this).hasClass('increase')) {
                                            inpElm = $(this).siblings('.quantity-display');
                                            currentVal = inpElm.val();
                                            currentVal = parseInt(currentVal, 10);
                                            currentVal = currentVal + minVal;
                                            inpElm.val(currentVal);

                                            if (currentVal > minVal) {
                                                $(this).parent('.collectionQuantity').find('.decrease').removeClass('disabled');
                                            }
                                            if (currentVal > minLessThanMax) {
                                                $(this).parent('.collectionQuantity').find('.increase').addClass('disabled');
                                                $(inpElm).val(maxVal);
                                            }
                                        }

                                        if ($(this).hasClass('decrease')) {
                                            inpElm = $(this).siblings('.quantity-display');
                                            currentVal = inpElm.val();
                                            currentVal = parseInt(currentVal, 10);
                                            currentVal = currentVal - minVal;
                                            inpElm.val(currentVal);
                                            if (currentVal <= minVal) {
                                                $(this).parent('.collectionQuantity').find('.decrease').addClass('disabled');
                                                $(inpElm).val(minVal);
                                            }
                                            if (currentVal < maxVal) {
                                                $(this).parent('.collectionQuantity').find('.increase').removeClass('disabled');
                                            }
                                        }
                                    });
                                };

                            self.returnContent();
                            self.$currentContent = $('.collectionContainer.range');
                            self.$currentContentContainer = self.$currentContent.parent();
                            self.$tabContent.find('.tab-content-body').append(self.$currentContent);
                            self.$tabContent.find('.tab-content-body .collectionItemNext a').trigger('click');
                            self.showContent();
                            kioskProductQuantity();
                            //Omniture
                            pdp.v[0].eVar59 = pdp.v[0].eVar59 == '' ? '' : pdp.v[0].eVar59 + ',';
                            var omniVal = pdp.v[0].eVar59 + 'PDP_Kiosk_shoptherange_tab';
                            var _oWebAnalytics = new analytics.WebMetrics();
                            pdp.v = [{
                                'eVar59': omniVal,
                                'events': 'event32'
                            }];
                            _oWebAnalytics.submit(pdp.v);
                        },
                        'tab-linksave': function (e) {
                            var self = e.data.ctx;
                            self.returnContent();
                            self.$currentContent = $('.collectionContainer.linksave');
                            self.$currentContentContainer = self.$currentContent.parent();
                            self.$tabContent.find('.tab-content-body').append(self.$currentContent);
                            self.showContent();

                            $('.jspPane').addClass('full-width-jsPane').addClass('bundle-container');
                            //Text is different in kiosk only
                            $('.bundleLink').text('Build your own bundle');
                            $('.collectionTermsLink').text('Terms and conditions');
                            $('.tab-view').addClass('link-save-tab');

                            //Omniture
                            pdp.v[0].eVar59 = pdp.v[0].eVar59 == '' ? '' : pdp.v[0].eVar59 + ',';
                            var omniVal = pdp.v[0].eVar59 + 'PDP_Kiosk_bundleandsave_tab';
                            var _oWebAnalytics = new analytics.WebMetrics();
                            pdp.v = [{
                                'eVar59': omniVal,
                                'events': 'event32'
                            }];
                            _oWebAnalytics.submit(pdp.v);
                        }
                    },
                    closeButtonCallback: function (e) {
                        e.data.ctx.$tabButtonsContainer.find('#tab-close-btn').click();
                    },
                    scrollbar: {
                        showArrows: true,
                        maintainPosition: false,
                        isKmf: false,
                        animateScroll: true,
                        speed: 500,
                        autoReinitialise: true
                    }
                });

                pdp.tabView.$tabButtonsContainer.on('tabButtonClicked', function (e) {
                    var buttonId = e.$buttonClicked.attr('id');

                    if (buttonId !== 'tab-product-reviews') {
                        pdp.removeCustomerReviewsMarkupInTabs();
                    }

                    if (buttonId !== 'tab-linksave') {
                        $('.jspPane').removeClass('full-width-jsPane').removeClass('bundle-container');
                        $('.tab-view').removeClass('link-save-tab');
                    }
                });

            } else {
                /*
                 * This is here as a temporary switch incase tabview is switched off.
                 * Ideally it should be removed once tabview is in production.
                 */
                $('#wrapper.product #footer').show();
            }
        }
    });

});

/*global define: true */
define('modules/delivery-options/desktop',['domlib', 'modules/common', './common'], function ($, common, delivery) {

    'use strict';

    delivery.bindEvents = function () {
        $(document).on('click', '.delivery-options-flyout', delivery.show);
    };

    common.init.push(delivery.init);

});
/*global define: true */
define('modules/scroll-to/desktop',['domlib', './common', 'modules/common'], function($, scrollTo, common){

	scrollTo.event = 'click';

	common.init.push(function(){
		scrollTo.init();
	});

});
define('modules/tile-carousel/desktop',['domlib', './common', 'modules/breakpoint', 'modules/common'],function($, carousel, breakpoint, common){

	carousel.extend = function(c){

		c.peak = function (e) {
			var self = c, move, panels;

			switch (e.type) {
			case('mouseenter'):
				panels = Math.ceil(self.numItems / self.numPanels);
				if ($(e.target).closest('.next').length > 0 && self.activePanel < (panels - 1)) {
					$('.products', self.target).addClass('fast');
					move = (self.calculateDistance() * self.activePanel) + 2.5;
					self.animate(move);
				}
				if ($(e.target).closest('.previous').length > 0 && self.activePanel > 0) {
					$('.products', self.target).addClass('fast');
					move = (self.calculateDistance() * self.activePanel) - 2.5;
					self.animate(move);
				}
				break;

			case('mouseleave'):
				panels = Math.ceil(self.numItems / self.numPanels);
				if ($(e.target).closest('.next').length > 0 && self.activePanel < (panels - 1)) {
					move = self.calculateDistance() * self.activePanel;
					self.animate(move);
				}
				if ($(e.target).closest('.previous').length > 0 && self.activePanel > 0) {
					move = self.calculateDistance() * self.activePanel;
					self.animate(move);
				}
				break;
			}

		};

		c.tab = function (e) {
			var self = c;

			e.preventDefault();
			e.stopPropagation();

			var item = $(e.target),
				product = $(e.target).closest('.products > li'),
				index = product.index(),
				panel = Math.floor(index / self.numPanels),
				move;

			if (self.activePanel !== panel) {
				self.activePanel = panel;
				move = self.calculateDistance() * self.activePanel;
				self.animate(move);
				self.checkNav();
				$(e.target).blur();
				window.setTimeout(function () {
					$(e.target).focus();
				}, 600);
			}

		};

		c.bindEvents = function(){
			var target = c.target;
			//bind events
			$('.product-carousel-nav .next', target).on('click',function (event) {
				c.next(event, $(this));
			});
			$('.product-carousel-nav .previous', target).on('click', function (event) {
				c.back(event, $(this));
			});

			if(!window.isKiosk() && !$(c.target).parent('.main-details').length) {
				$('.product-carousel-nav .next, .product-carousel-nav .previous', target).on('mouseenter mouseleave', c.peak);
			}
			else {
				var isShopBy = $(target).hasClass('shop-by');

				// ensure that the swipes aren't added for the shop by if there's not ensough items
				if (!isShopBy || (isShopBy && $('.product', target).length > 5)) {

					// if its the kiosk shop by carousel, bind swipe events to the product wrapper only as shop by has different carousel design
					var swipeElement = (isShopBy) ? $('.products-wrapper', target) : target;

					common.kioskSwipe('left', swipeElement, function(event){
						event.preventDefault();
						event.type = 'swipeLeft';
						c.next(event, $('.product-carousel-nav .next'));
					});

					common.kioskSwipe('right', swipeElement, function(event){
						event.preventDefault();
						event.type = 'swipeRight';
						c.back(event, $('.product-carousel-nav .previous'));
					});
				}
			}

			$('.product a', target).on('focus', c.tab);
		};

		return c;
	};

	common.init.push(function(){
		carousel.init();
		if (breakpoint.kiosk) {
			carousel.initTabs();
		}
	});

});

/*global define:true */
/*jslint plusplus: true, regexp: true */
define('modules/buy-from/desktop',['domlib', './common', '../common'], function ($, buyFrom, common) {
    'use strict';
    common.init.push(function () {
        if (!window.AsyncBlockController.isCachedPage()) {
            buyFrom.init($(".buy-from"));
        }
    });

});
define('modules/add-to-compare/desktop',['domlib', 'modules/breakpoint', './common', 'modules/common'], function ($, breakpoint, addToCompare, common) {

    addToCompare.bindEvents = function () {
        $('#clear-all').on('click', function (e) {
            addToCompare.uncheckAll.call(addToCompare, e);
            return false;
        });

        $('#exit-compare-mode').on('click', this.onExitCompareMode.bind(this));

        $('.compare-cta').on('click', this.compareProducts);

        if (!breakpoint.kiosk) {
            $('#listing').on('click', 'div.add-to-compare', this.toggleState);
            this.scroll(breakpoint.currentViewport);
        } else {
            this.replaceKioskSpecific();
            $('#compare-mode').on('click', this.enterCompareMode);
        }
    };


    addToCompare.enterCompareMode = function (e) {
        e.preventDefault();
        $('#listing').find('.products').addClass('compare');
        $('body').addClass('listing-compare-mode');

        $('#listing').on('click', '.compare .product', function (e) {
            e.preventDefault();
            e.stopPropagation();
            addToCompare.selectProduct.call(addToCompare, e);
        });

        addToCompare.$compareDialog.removeClass('hidden');
    };

    common.init.push(addToCompare.init);

});
define('modules/product-description/desktop',['domlib', './common', 'modules/common'], function($, pdp, common) {
	pdp.swatchesAndSizesRules.maximumAmount = 20;
	common.init.push(function() {
		pdp.init();
	});
});
/*global define: true */
define('modules/save-for-later/desktop',['domlib', './common', 'modules/common'], function($, saveForLater, common){

	saveForLater.event = 'click';

	common.init.push(function(){
		saveForLater.init();
	});

});
require([
  'modules/tile-carousel/common',
  'modules/footer/common',
  'modules/breadcrumb/common',
  'modules/navigation/common',
  'modules/catalog-navigation/init',
  'modules/fixed-header/init',
  'modules/product-offers/common',
  'modules/product-sort-by/common',
  'modules/recently-viewed/common',
  'modules/product-filters/common',
  'modules/home-page-stamps/common',
  'modules/basket/common',
  'modules/compare-page/common',
  'modules/visual-nav/common',
  'modules/seller-directory/common',
  'modules/buying-guides/common',
  'modules/buying-guides-directory/common',
  'modules/deferred-block/common',
  'modules/pdp-configurator/common',
  'modules/pdp/controllers/AppController',
  'modules/ues/common',
  'modules/hooklogic/common',
  'modules/affiliate/common',
  'modules/add-on-items/common'
], function () {});


if (window.isTouch() && !window.isKiosk()) {
  require([
    'modules/carousel/touch',
    'modules/tile-carousel/touch',
    'modules/buy-from/touch',
    'modules/add-to-compare/touch',
    'modules/delivery-options/touch',
    'modules/save-for-later/touch',
    'modules/product-description/touch',
    'modules/scroll-to/touch'
  ], function () {});
} else if (window.isKiosk()) {
  require([
    'modules/carousel/desktop',
    'modules/tile-carousel/kiosk',
    'modules/buy-from/kiosk',
    'modules/basket/kiosk',
    'modules/product-description/kiosk',
    'modules/delivery-options/desktop',
    'modules/scroll-to/desktop'
  ], function () {});
} else {
  require([
    'modules/carousel/desktop',
    'modules/tile-carousel/desktop',
    'modules/buy-from/desktop',
    'modules/add-to-compare/desktop',
    'modules/product-description/desktop',
    'modules/delivery-options/desktop',
    'modules/save-for-later/desktop',
    'modules/scroll-to/desktop'
  ], function () {});
}


require(['modules/common', 'modules/breakpoint'], function (common, breakpoint) {
  $(function () {
    if (window.isTouch()) {
      common.androidDetect();
    } else {
      common.windowsPhoneDetect();
    }

    breakpoint.init();
    breakpoint.check();
    common.app();
    common.helpRatings();
    setTimeout(function () {
      breakpoint.update(breakpoint.check(true));
    }, 4);
  });
});

define("bundles/search-and-browse", function(){});

